/**
 * 
 *   Version: 10.4.0
 * 
 *   Git Hash: 18a110e8a09523bcccd386391747f378b0b20912
 * 
 *   Created At: 2024/8/21 19:57:27
 * 
 *   Target: nim.js
 *   
 */

var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(t){var o={exports:{}};return t(o,o.exports),o.exports}var o=createCommonjsModule((function(t){var o=Object.prototype.hasOwnProperty,a="~";function Events(){}function EE(t,o,a){this.fn=t,this.context=o,this.once=a||!1}function addListener(t,o,c,m,h){if("function"!=typeof c)throw new TypeError("The listener must be a function");var g=new EE(c,m||t,h),_=a?a+o:o;return t._events[_]?t._events[_].fn?t._events[_]=[t._events[_],g]:t._events[_].push(g):(t._events[_]=g,t._eventsCount++),t}function clearEvent(t,o){0==--t._eventsCount?t._events=new Events:delete t._events[o]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(a=!1)),EventEmitter.prototype.eventNames=function eventNames(){var t,c,m=[];if(0===this._eventsCount)return m;for(c in t=this._events)o.call(t,c)&&m.push(a?c.slice(1):c);return Object.getOwnPropertySymbols?m.concat(Object.getOwnPropertySymbols(t)):m},EventEmitter.prototype.listeners=function listeners(t){var o=a?a+t:t,c=this._events[o];if(!c)return[];if(c.fn)return[c.fn];for(var m=0,h=c.length,g=new Array(h);m<h;m++)g[m]=c[m].fn;return g},EventEmitter.prototype.listenerCount=function listenerCount(t){var o=a?a+t:t,c=this._events[o];return c?c.fn?1:c.length:0},EventEmitter.prototype.emit=function emit(t,o,c,m,h,g){var _=a?a+t:t;if(!this._events[_])return!1;var I,E,T=this._events[_],M=arguments.length;if(T.fn){switch(T.once&&this.removeListener(t,T.fn,void 0,!0),M){case 1:return T.fn.call(T.context),!0;case 2:return T.fn.call(T.context,o),!0;case 3:return T.fn.call(T.context,o,c),!0;case 4:return T.fn.call(T.context,o,c,m),!0;case 5:return T.fn.call(T.context,o,c,m,h),!0;case 6:return T.fn.call(T.context,o,c,m,h,g),!0}for(E=1,I=new Array(M-1);E<M;E++)I[E-1]=arguments[E];T.fn.apply(T.context,I)}else{var S,N=T.length;for(E=0;E<N;E++)switch(T[E].once&&this.removeListener(t,T[E].fn,void 0,!0),M){case 1:T[E].fn.call(T[E].context);break;case 2:T[E].fn.call(T[E].context,o);break;case 3:T[E].fn.call(T[E].context,o,c);break;case 4:T[E].fn.call(T[E].context,o,c,m);break;default:if(!I)for(S=1,I=new Array(M-1);S<M;S++)I[S-1]=arguments[S];T[E].fn.apply(T[E].context,I)}}return!0},EventEmitter.prototype.on=function on(t,o,a){return addListener(this,t,o,a,!1)},EventEmitter.prototype.once=function once(t,o,a){return addListener(this,t,o,a,!0)},EventEmitter.prototype.removeListener=function removeListener(t,o,c,m){var h=a?a+t:t;if(!this._events[h])return this;if(!o)return clearEvent(this,h),this;var g=this._events[h];if(g.fn)g.fn!==o||m&&!g.once||c&&g.context!==c||clearEvent(this,h);else{for(var _=0,I=[],E=g.length;_<E;_++)(g[_].fn!==o||m&&!g[_].once||c&&g[_].context!==c)&&I.push(g[_]);I.length?this._events[h]=1===I.length?I[0]:I:clearEvent(this,h)}return this},EventEmitter.prototype.removeAllListeners=function removeAllListeners(t){var o;return t?(o=a?a+t:t,this._events[o]&&clearEvent(this,o)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=a,EventEmitter.EventEmitter=EventEmitter,t.exports=EventEmitter})),a=createCommonjsModule((function(t,o){t.exports=function(){function _classCallCheck(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,o){for(var a=0;a<o.length;a++){var c=o[a];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(t,c.key,c)}}function _createClass(t,o,a){return o&&_defineProperties(t.prototype,o),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}var t={isDataReportEnable:!0,maxSize:100,msgListMaxSize:1e3,cacheMaxSize:1e3,maxDelay:3e5,maxInterval:3e4,minInterval:1e4,timeout:5e3,autoStart:!0,loginFailIgnoreInterval:6e5},o=function emptyFn(){},a=/*#__PURE__*/function(){function Reporter(o){_classCallCheck(this,Reporter),this.isUploadEnable=!1,this.initConfigLoaded=!1,this.loading=!1,this.isDestroyed=!1,this.reportConfig=t,this.traceMsgCache={},this.highPriorityMsgList=[],this.msgList=[],this.lowPriorityMsgList=[],this.cacheMsgList=[],this.lastReportTime=Date.now(),this.timer=null,this.endedAsyncMsgByModule={},this.lastFailLogin={},this.setConfig(o),this.reportConfig.isDataReportEnable&&this.reportConfig.autoStart&&this.initUploadConfig()}return _createClass(Reporter,[{key:"setConfig",value:function setConfig(t){var o=Object.assign({},this.reportConfig.common,t.common);this.reportConfig=Object.assign({},this.reportConfig,t),this.reportConfig.common=o,this.reportConfig.common.sdk_type||(this.reportConfig.common.sdk_type="im")}},{key:"reportImmediately",value:function reportImmediately(t,o){var a=this;this.reportConfig.isDataReportEnable&&this.reportConfig.request(t,Object.assign({dataType:"json",method:"POST",timeout:this.reportConfig.timeout},o)).catch((function(t){var o,c;null===(c=null===(o=a.reportConfig)||void 0===o?void 0:o.logger)||void 0===c||c.warn("Reporter immediately upload failed",t)}))}},{key:"report",value:function report(o,a){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(c.priority||(c.priority=this.getEventPriority(o,a)),this.reportConfig.isDataReportEnable&&o){if("login"===o&&!1===a.succeed&&a.process_id){var m=this.lastFailLogin[a.process_id]||0;if(a.start_time-m<t.loginFailIgnoreInterval)return;this.lastFailLogin[a.process_id]=a.start_time}var h=Date.now();"HIGH"===c.priority?this.highPriorityMsgList.push({module:o,msg:a,createTime:h}):"NORMAL"===c.priority?this.msgList.push({module:o,msg:a,createTime:h}):"LOW"===c.priority&&this.lowPriorityMsgList.push({module:o,msg:a,createTime:h}),this.highPriorityMsgList.length>this.reportConfig.msgListMaxSize&&this.highPriorityMsgList.shift(),this.msgList.length>this.reportConfig.msgListMaxSize&&this.msgList.shift(),this.lowPriorityMsgList.length>this.reportConfig.msgListMaxSize&&this.lowPriorityMsgList.shift(),this.doReport()}}},{key:"reportTraceStart",value:function reportTraceStart(t,o){if(this.reportConfig.isDataReportEnable&&t&&!this.traceMsgCache[t]){var a=Object.assign(Object.assign({start_time:Date.now()},o),{extension:[]});this.traceMsgCache[t]=a}}},{key:"reportTraceUpdate",value:function reportTraceUpdate(t){}},{key:"reportTraceUpdateV2",value:function reportTraceUpdateV2(t,o,a){var c,m=this;if(this.reportConfig.isDataReportEnable&&this.traceMsgCache[t]){var h=this.traceMsgCache[t].extension,g=h.length,_=(new Date).getTime();0===g?o.duration=_-this.traceMsgCache[t].start_time:h[g-1].end_time?o.duration=_-h[g-1].end_time:o.duration=_-this.traceMsgCache[t].start_time,h.push(Object.assign({end_time:_},o));var I=h.length-1;(null==a?void 0:a.asyncParams)&&((c=this.traceMsgCache[t]).asyncPromiseArray||(c.asyncPromiseArray=[]),this.traceMsgCache[t].asyncPromiseArray.push(a.asyncParams.then((function(o){m.traceMsgCache[t]&&m.traceMsgCache[t].extension[I]&&Object.assign(m.traceMsgCache[t].extension[I],o)}))))}}},{key:"reportTraceEnd",value:function reportTraceEnd(t){var o,a=this,c=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reportConfig.isDataReportEnable&&this.traceMsgCache[t])if("nos"!==t||!1===c){"boolean"==typeof c?this.traceMsgCache[t].succeed=!!c:this.traceMsgCache[t].state=c,this.traceMsgCache[t].duration=Date.now()-this.traceMsgCache[t].start_time,this.traceMsgCache[t].extension.forEach((function(t){delete t.end_time}));var m=this.traceMsgCache[t];if(this.traceMsgCache[t]=null,m.asyncPromiseArray){(o=this.endedAsyncMsgByModule)[t]||(o[t]=[]),this.endedAsyncMsgByModule[t].push(m);var h=function asyncCallback(){a.endedAsyncMsgByModule[t]&&a.endedAsyncMsgByModule[t].includes(m)&&(delete m.asyncPromiseArray,a.report(t,m,{priority:a.getEventPriority(t,m)}))};Promise.all(m.asyncPromiseArray).then(h).catch(h)}else this.report(t,m,{priority:this.getEventPriority(t,m)})}else this.traceMsgCache[t]=null}},{key:"getEventPriority",value:function getEventPriority(t,o){if("exceptions"===t){if(0===o.action)return"HIGH";if(2===o.action)return"HIGH";if(1===o.action&&0!==o.exception_service)return"HIGH"}else{if("msgReceive"===t)return"LOW";if("nim_api_trace"===t)return"LOW"}return"NORMAL"}},{key:"reportTraceCancel",value:function reportTraceCancel(t){this.reportConfig.isDataReportEnable&&(this.endedAsyncMsgByModule[t]=[],this.traceMsgCache[t]=null)}},{key:"pause",value:function pause(){this.reportConfig.isDataReportEnable&&(this.isUploadEnable=!1)}},{key:"restore",value:function restore(){this.reportConfig.isDataReportEnable&&(this.isUploadEnable=!0,this.initConfigLoaded||this.initUploadConfig())}},{key:"destroy",value:function destroy(){var t=this;this.reportConfig.isDataReportEnable&&(Object.keys(this.traceMsgCache).forEach((function(o){t.reportTraceEnd(o,1)})),null!==this.timer&&clearTimeout(this.timer),this.setConfig=o,this.report=o,this.reportTraceStart=o,this.reportTraceUpdate=o,this.reportTraceEnd=o,this.pause=o,this.restore=o,this.destroy=o,this.cacheMsgList=[],this.traceMsgCache={},this.lowPriorityMsgList=[],this.msgList=[],this.highPriorityMsgList=[],this.reportConfig={},this.isDestroyed=!0)}},{key:"initUploadConfig",value:function initUploadConfig(){var t,o,a=this;if(!this.loading){this.loading=!0;var c=this.reportConfig.common||{};try{this.reportConfig.request(this.reportConfig.reportConfigUrl,{method:"GET",dataType:"json",params:{deviceId:c.dev_id,sdkVer:c.sdk_ver,platform:c.platform,appkey:c.app_key},timeout:this.reportConfig.timeout}).then((function(t){var o,c;if(!a.isDestroyed){if(200===t.status&&t.data&&200===t.data.code){var m=t.data.data||{};a.reportConfig.maxSize=m.maxSize>1e3?1e3:m.maxSize,a.reportConfig.maxInterval=m.maxInterval>1e4?1e4:m.maxInterval,a.reportConfig.maxInterval=m.maxInterval<10?10:m.maxInterval,a.reportConfig.minInterval=m.minInterval<2?2:m.minInterval,a.reportConfig.maxDelay=m.maxDelay||300,a.reportConfig.maxInterval=1e3*a.reportConfig.maxInterval,a.reportConfig.minInterval=1e3*a.reportConfig.minInterval,a.reportConfig.maxDelay=1e3*a.reportConfig.maxDelay,a.isUploadEnable=!0,a.initConfigLoaded=!0,a.loading=!1,a.reportHeartBeat()}null===(c=null===(o=a.reportConfig)||void 0===o?void 0:o.logger)||void 0===c||c.log("Get reporter upload config success")}})).catch((function(t){var o,c;a.loading=!1,null===(c=null===(o=a.reportConfig)||void 0===o?void 0:o.logger)||void 0===c||c.error("Get reporter upload config failed",t)}))}catch(a){this.loading=!1,null===(o=null===(t=this.reportConfig)||void 0===t?void 0:t.logger)||void 0===o||o.error("Exec reporter request failed",a)}}}},{key:"reportHeartBeat",value:function reportHeartBeat(){var t=this;this.isDestroyed||(this.timer=setTimeout((function(){t.reportHeartBeat()}),this.reportConfig.minInterval),this.doReport())}},{key:"doReport",value:function doReport(){if(!this.isDestroyed){var t=this.highPriorityMsgList.length+this.msgList.length+this.lowPriorityMsgList.length+this.cacheMsgList.length>2*this.reportConfig.maxSize?this.reportConfig.minInterval:this.reportConfig.maxInterval;Date.now()-this.lastReportTime>=t&&this.upload()}}},{key:"getUploadMsg",value:function getUploadMsg(){var t=this,o={},a=Date.now();this.highPriorityMsgList=this.highPriorityMsgList.filter((function(o){return a-o.createTime<t.reportConfig.maxDelay})),this.msgList=this.msgList.filter((function(o){return a-o.createTime<t.reportConfig.maxDelay})),this.lowPriorityMsgList=this.lowPriorityMsgList.filter((function(o){return a-o.createTime<t.reportConfig.maxDelay})),this.cacheMsgList=this.cacheMsgList.filter((function(o){return a-o.createTime<t.reportConfig.maxDelay}));var c=this.highPriorityMsgList.slice(0,this.reportConfig.maxSize);if(this.highPriorityMsgList=this.highPriorityMsgList.slice(c.length),c.length<this.reportConfig.maxSize){var m=this.reportConfig.maxSize-c.length;c=c.concat(this.msgList.slice(0,m)),this.msgList=this.msgList.slice(m)}if(c.length<this.reportConfig.maxSize){var h=this.reportConfig.maxSize-c.length;c=c.concat(this.lowPriorityMsgList.slice(0,h)),this.lowPriorityMsgList=this.lowPriorityMsgList.slice(h)}if(c.length<this.reportConfig.maxSize){var g=this.reportConfig.maxSize-c.length;c=c.concat(this.cacheMsgList.slice(0,g)),this.cacheMsgList=this.cacheMsgList.slice(g)}return c.forEach((function(t){o[t.module]?o[t.module].push(t.msg):o[t.module]=[t.msg]})),{uploadMsgArr:c,uploadMsg:o}}},{key:"upload",value:function upload(){var t,o,a=this;if(this.isUploadEnable&&!(this.lastReportTime&&Date.now()-this.lastReportTime<this.reportConfig.minInterval)){var c=this.getUploadMsg(),m=c.uploadMsgArr,h=c.uploadMsg;if(m.length){this.lastReportTime=Date.now();try{this.reportConfig.request(this.reportConfig.reportUrl,{dataType:"json",method:"POST",data:{common:this.reportConfig.common,event:h},headers:{sdktype:"im"},timeout:this.reportConfig.timeout}).catch((function(t){var o,c;a.cacheMsgList=a.cacheMsgList.concat(m).slice(0,a.reportConfig.cacheMaxSize),null===(c=null===(o=a.reportConfig)||void 0===o?void 0:o.logger)||void 0===c||c.warn("Reporter upload failed",t)}))}catch(a){null===(o=null===(t=this.reportConfig)||void 0===t?void 0:t.logger)||void 0===o||o.warn("Exec reporter request failed",a)}clearTimeout(this.timer),this.reportHeartBeat()}}}}]),Reporter}();return a}()})),c=Array.isArray,m="object"==typeof t&&t&&t.Object===Object&&t,h="object"==typeof self&&self&&self.Object===Object&&self,g=m||h||Function("return this")(),_=g.Symbol,I=Object.prototype,E=I.hasOwnProperty,T=I.toString,M=_?_.toStringTag:void 0;var S=function getRawTag(t){var o=E.call(t,M),a=t[M];try{t[M]=void 0;var c=!0}catch(t){}var m=T.call(t);return c&&(o?t[M]=a:delete t[M]),m},N=Object.prototype.toString;var C=function objectToString(t){return N.call(t)},A=_?_.toStringTag:void 0;var O=function baseGetTag(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":A&&A in Object(t)?S(t):C(t)};var R=function isObjectLike(t){return null!=t&&"object"==typeof t};var b=function isSymbol(t){return"symbol"==typeof t||R(t)&&"[object Symbol]"==O(t)},V=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,P=/^\w*$/;var k=function isKey(t,o){if(c(t))return!1;var a=typeof t;return!("number"!=a&&"symbol"!=a&&"boolean"!=a&&null!=t&&!b(t))||(P.test(t)||!V.test(t)||null!=o&&t in Object(o))};var L=function isObject(t){var o=typeof t;return null!=t&&("object"==o||"function"==o)};var D,w=function isFunction(t){if(!L(t))return!1;var o=O(t);return"[object Function]"==o||"[object GeneratorFunction]"==o||"[object AsyncFunction]"==o||"[object Proxy]"==o},U=g["__core-js_shared__"],x=(D=/[^.]+$/.exec(U&&U.keys&&U.keys.IE_PROTO||""))?"Symbol(src)_1."+D:"";var G=function isMasked(t){return!!x&&x in t},B=Function.prototype.toString;var j=function toSource(t){if(null!=t){try{return B.call(t)}catch(t){}try{return t+""}catch(t){}}return""},Y=/^\[object .+?Constructor\]$/,H=Function.prototype,$=Object.prototype,q=H.toString,z=$.hasOwnProperty,K=RegExp("^"+q.call(z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var W=function baseIsNative(t){return!(!L(t)||G(t))&&(w(t)?K:Y).test(j(t))};var J=function getValue(t,o){return null==t?void 0:t[o]};var X=function getNative(t,o){var a=J(t,o);return W(a)?a:void 0},Q=X(Object,"create");var Z=function hashClear(){this.__data__=Q?Q(null):{},this.size=0};var ee=function hashDelete(t){var o=this.has(t)&&delete this.__data__[t];return this.size-=o?1:0,o},te=Object.prototype.hasOwnProperty;var re=function hashGet(t){var o=this.__data__;if(Q){var a=o[t];return"__lodash_hash_undefined__"===a?void 0:a}return te.call(o,t)?o[t]:void 0},ie=Object.prototype.hasOwnProperty;var ne=function hashHas(t){var o=this.__data__;return Q?void 0!==o[t]:ie.call(o,t)};var oe=function hashSet(t,o){var a=this.__data__;return this.size+=this.has(t)?0:1,a[t]=Q&&void 0===o?"__lodash_hash_undefined__":o,this};function Hash(t){var o=-1,a=null==t?0:t.length;for(this.clear();++o<a;){var c=t[o];this.set(c[0],c[1])}}Hash.prototype.clear=Z,Hash.prototype.delete=ee,Hash.prototype.get=re,Hash.prototype.has=ne,Hash.prototype.set=oe;var se=Hash;var ae=function listCacheClear(){this.__data__=[],this.size=0};var ce=function eq(t,o){return t===o||t!=t&&o!=o};var de=function assocIndexOf(t,o){for(var a=t.length;a--;)if(ce(t[a][0],o))return a;return-1},le=Array.prototype.splice;var pe=function listCacheDelete(t){var o=this.__data__,a=de(o,t);return!(a<0)&&(a==o.length-1?o.pop():le.call(o,a,1),--this.size,!0)};var ue=function listCacheGet(t){var o=this.__data__,a=de(o,t);return a<0?void 0:o[a][1]};var me=function listCacheHas(t){return de(this.__data__,t)>-1};var he=function listCacheSet(t,o){var a=this.__data__,c=de(a,t);return c<0?(++this.size,a.push([t,o])):a[c][1]=o,this};function ListCache(t){var o=-1,a=null==t?0:t.length;for(this.clear();++o<a;){var c=t[o];this.set(c[0],c[1])}}ListCache.prototype.clear=ae,ListCache.prototype.delete=pe,ListCache.prototype.get=ue,ListCache.prototype.has=me,ListCache.prototype.set=he;var ge=ListCache,_e=X(g,"Map");var ve=function mapCacheClear(){this.size=0,this.__data__={hash:new se,map:new(_e||ge),string:new se}};var Ie=function isKeyable(t){var o=typeof t;return"string"==o||"number"==o||"symbol"==o||"boolean"==o?"__proto__"!==t:null===t};var Ee=function getMapData(t,o){var a=t.__data__;return Ie(o)?a["string"==typeof o?"string":"hash"]:a.map};var fe=function mapCacheDelete(t){var o=Ee(this,t).delete(t);return this.size-=o?1:0,o};var Te=function mapCacheGet(t){return Ee(this,t).get(t)};var Me=function mapCacheHas(t){return Ee(this,t).has(t)};var ye=function mapCacheSet(t,o){var a=Ee(this,t),c=a.size;return a.set(t,o),this.size+=a.size==c?0:1,this};function MapCache(t){var o=-1,a=null==t?0:t.length;for(this.clear();++o<a;){var c=t[o];this.set(c[0],c[1])}}MapCache.prototype.clear=ve,MapCache.prototype.delete=fe,MapCache.prototype.get=Te,MapCache.prototype.has=Me,MapCache.prototype.set=ye;var Se=MapCache;function memoize(t,o){if("function"!=typeof t||null!=o&&"function"!=typeof o)throw new TypeError("Expected a function");var memoized=function(){var a=arguments,c=o?o.apply(this,a):a[0],m=memoized.cache;if(m.has(c))return m.get(c);var h=t.apply(this,a);return memoized.cache=m.set(c,h)||m,h};return memoized.cache=new(memoize.Cache||Se),memoized}memoize.Cache=Se;var Ne=memoize;var Ce=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Ae=/\\(\\)?/g,Oe=function memoizeCapped(t){var o=Ne(t,(function(t){return 500===a.size&&a.clear(),t})),a=o.cache;return o}((function(t){var o=[];return 46===t.charCodeAt(0)&&o.push(""),t.replace(Ce,(function(t,a,c,m){o.push(c?m.replace(Ae,"$1"):a||t)})),o}));var Re=function arrayMap(t,o){for(var a=-1,c=null==t?0:t.length,m=Array(c);++a<c;)m[a]=o(t[a],a,t);return m},be=_?_.prototype:void 0,Ve=be?be.toString:void 0;var Pe=function baseToString(t){if("string"==typeof t)return t;if(c(t))return Re(t,baseToString)+"";if(b(t))return Ve?Ve.call(t):"";var o=t+"";return"0"==o&&1/t==-Infinity?"-0":o};var ke=function toString(t){return null==t?"":Pe(t)};var Le=function castPath(t,o){return c(t)?t:k(t,o)?[t]:Oe(ke(t))};var De=function toKey(t){if("string"==typeof t||b(t))return t;var o=t+"";return"0"==o&&1/t==-Infinity?"-0":o};var we=function baseGet(t,o){for(var a=0,c=(o=Le(o,t)).length;null!=t&&a<c;)t=t[De(o[a++])];return a&&a==c?t:void 0};var Ue=function get(t,o,a){var c=null==t?void 0:we(t,o);return void 0===c?a:c};function __rest(t,o){var a={};for(var c in t)Object.prototype.hasOwnProperty.call(t,c)&&o.indexOf(c)<0&&(a[c]=t[c]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var m=0;for(c=Object.getOwnPropertySymbols(t);m<c.length;m++)o.indexOf(c[m])<0&&Object.prototype.propertyIsEnumerable.call(t,c[m])&&(a[c[m]]=t[c[m]])}return a}function __awaiter(t,o,a,c){return new(a||(a=Promise))((function(m,h){function fulfilled(t){try{step(c.next(t))}catch(t){h(t)}}function rejected(t){try{step(c.throw(t))}catch(t){h(t)}}function step(t){t.done?m(t.value):function adopt(t){return t instanceof a?t:new a((function(o){o(t)}))}(t.value).then(fulfilled,rejected)}step((c=c.apply(t,o||[])).next())}))}var xe,Fe,Ge,Be,je,Ye,He,$e,qe,ze,Ke,We,Je,Xe,Qe,Ze,et,rt,it,nt,ot,st,at,ct,dt,lt,pt,ut,mt,ht,gt,_t,vt,It,Et,ft,Tt,Mt,yt,St,Nt,Ct,At,Ot,Rt,bt,Vt,Pt,kt=function isUndefined(t){return void 0===t};!function(t){t[t.V2NIM_DATA_SYNC_TYPE_LEVEL_FULL=0]="V2NIM_DATA_SYNC_TYPE_LEVEL_FULL",t[t.V2NIM_DATA_SYNC_TYPE_LEVEL_BASIC=1]="V2NIM_DATA_SYNC_TYPE_LEVEL_BASIC"}(xe||(xe={})),function(t){t[t.V2NIM_DATA_SYNC_TYPE_MAIN=1]="V2NIM_DATA_SYNC_TYPE_MAIN",t[t.V2NIM_DATA_SYNC_TYPE_TEAM_MEMBER=2]="V2NIM_DATA_SYNC_TYPE_TEAM_MEMBER",t[t.V2NIM_DATA_SYNC_TYPE_SUPER_TEAM_MEMBER=3]="V2NIM_DATA_SYNC_TYPE_SUPER_TEAM_MEMBER"}(Fe||(Fe={})),function(t){t[t.V2NIM_DATA_SYNC_STATE_WAITING=1]="V2NIM_DATA_SYNC_STATE_WAITING",t[t.V2NIM_DATA_SYNC_STATE_SYNCING=2]="V2NIM_DATA_SYNC_STATE_SYNCING",t[t.V2NIM_DATA_SYNC_STATE_COMPLETED=3]="V2NIM_DATA_SYNC_STATE_COMPLETED"}(Ge||(Ge={})),function(t){t[t.V2NIM_CONVERSATION_TYPE_UNKNOWN=0]="V2NIM_CONVERSATION_TYPE_UNKNOWN",t[t.V2NIM_CONVERSATION_TYPE_P2P=1]="V2NIM_CONVERSATION_TYPE_P2P",t[t.V2NIM_CONVERSATION_TYPE_TEAM=2]="V2NIM_CONVERSATION_TYPE_TEAM",t[t.V2NIM_CONVERSATION_TYPE_SUPER_TEAM=3]="V2NIM_CONVERSATION_TYPE_SUPER_TEAM"}(Be||(Be={})),function(t){t[t.V2NIM_MESSAGE_STATUS_DEFAULT=0]="V2NIM_MESSAGE_STATUS_DEFAULT",t[t.V2NIM_MESSAGE_STATUS_REVOKE=1]="V2NIM_MESSAGE_STATUS_REVOKE",t[t.V2NIM_MESSAGE_STATUS_BACKFILL=2]="V2NIM_MESSAGE_STATUS_BACKFILL"}(je||(je={})),function(t){t[t.V2NIM_FRIEND_MODE_TYPE_ADD=1]="V2NIM_FRIEND_MODE_TYPE_ADD",t[t.V2NIM_FRIEND_MODE_TYPE_APPLY=2]="V2NIM_FRIEND_MODE_TYPE_APPLY"}(Ye||(Ye={})),function(t){t[t.V2NIM_FRIEND_ADD_APPLICATION_TYPE_RECEIVED=1]="V2NIM_FRIEND_ADD_APPLICATION_TYPE_RECEIVED",t[t.V2NIM_FRIEND_ADD_APPLICATION_TYPE_REJECTED=2]="V2NIM_FRIEND_ADD_APPLICATION_TYPE_REJECTED"}(He||(He={})),function(t){t[t.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT=0]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT",t[t.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED=1]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED",t[t.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED=2]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED",t[t.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED=3]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED",t[t.V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD=4]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD"}($e||($e={})),function(t){t[t.V2NIM_FRIEND_DELETION_TYPE_BY_SELF=1]="V2NIM_FRIEND_DELETION_TYPE_BY_SELF",t[t.V2NIM_FRIEND_DELETION_TYPE_BY_PEER=2]="V2NIM_FRIEND_DELETION_TYPE_BY_PEER"}(qe||(qe={})),function(t){t[t.V2NIM_FRIEND_VERIFY_TYPE_ADD=1]="V2NIM_FRIEND_VERIFY_TYPE_ADD",t[t.V2NIM_FRIEND_VERIFY_TYPE_APPLY=2]="V2NIM_FRIEND_VERIFY_TYPE_APPLY",t[t.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT=3]="V2NIM_FRIEND_VERIFY_TYPE_ACCEPT",t[t.V2NIM_FRIEND_VERIFY_TYPE_REJECT=4]="V2NIM_FRIEND_VERIFY_TYPE_REJECT"}(ze||(ze={})),function(t){t[t.V2NIM_LOGIN_AUTH_TYPE_DEFAULT=0]="V2NIM_LOGIN_AUTH_TYPE_DEFAULT",t[t.V2NIM_LOGIN_AUTH_TYPE_DYNAMIC_TOKEN=1]="V2NIM_LOGIN_AUTH_TYPE_DYNAMIC_TOKEN",t[t.V2NIM_LOGIN_AUTH_TYPE_THIRD_PARTY=2]="V2NIM_LOGIN_AUTH_TYPE_THIRD_PARTY"}(Ke||(Ke={})),function(t){t[t.V2NIM_LOGIN_STATUS_LOGOUT=0]="V2NIM_LOGIN_STATUS_LOGOUT",t[t.V2NIM_LOGIN_STATUS_LOGINED=1]="V2NIM_LOGIN_STATUS_LOGINED",t[t.V2NIM_LOGIN_STATUS_LOGINING=2]="V2NIM_LOGIN_STATUS_LOGINING",t[t.V2NIM_LOGIN_STATUS_UNLOGIN=3]="V2NIM_LOGIN_STATUS_UNLOGIN"}(We||(We={})),function(t){t[t.V2NIM_LOGIN_CLIENT_TYPE_UNKNOWN=0]="V2NIM_LOGIN_CLIENT_TYPE_UNKNOWN",t[t.V2NIM_LOGIN_CLIENT_TYPE_ANDROID=1]="V2NIM_LOGIN_CLIENT_TYPE_ANDROID",t[t.V2NIM_LOGIN_CLIENT_TYPE_IOS=2]="V2NIM_LOGIN_CLIENT_TYPE_IOS",t[t.V2NIM_LOGIN_CLIENT_TYPE_PC=4]="V2NIM_LOGIN_CLIENT_TYPE_PC",t[t.V2NIM_LOGIN_CLIENT_TYPE_WP=8]="V2NIM_LOGIN_CLIENT_TYPE_WP",t[t.V2NIM_LOGIN_CLIENT_TYPE_WEB=16]="V2NIM_LOGIN_CLIENT_TYPE_WEB",t[t.V2NIM_LOGIN_CLIENT_TYPE_RESTFUL=32]="V2NIM_LOGIN_CLIENT_TYPE_RESTFUL",t[t.V2NIM_LOGIN_CLIENT_TYPE_MAC_OS=64]="V2NIM_LOGIN_CLIENT_TYPE_MAC_OS",t[t.V2NIM_LOGIN_CLIENT_TYPE_HARMONY_OS=65]="V2NIM_LOGIN_CLIENT_TYPE_HARMONY_OS"}(Je||(Je={})),function(t){t[t.V2NIM_KICKED_OFFLINE_REASON_CLIENT_EXCLUSIVE=1]="V2NIM_KICKED_OFFLINE_REASON_CLIENT_EXCLUSIVE",t[t.V2NIM_KICKED_OFFLINE_REASON_SERVER=2]="V2NIM_KICKED_OFFLINE_REASON_SERVER",t[t.V2NIM_KICKED_OFFLINE_REASON_CLIENT=3]="V2NIM_KICKED_OFFLINE_REASON_CLIENT",t[t.V2NIM_KICKED_OFFLINE_REASON_CLIENT_QUIETLY=4]="V2NIM_KICKED_OFFLINE_REASON_CLIENT_QUIETLY"}(Xe||(Xe={})),function(t){t[t.V2NIM_LOGIN_CLIENT_CHANGE_LIST=1]="V2NIM_LOGIN_CLIENT_CHANGE_LIST",t[t.V2NIM_LOGIN_CLIENT_CHANGE_LOGIN=2]="V2NIM_LOGIN_CLIENT_CHANGE_LOGIN",t[t.V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT=3]="V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT"}(Qe||(Qe={})),function(t){t[t.V2NIM_CONNECT_STATUS_DISCONNECTED=0]="V2NIM_CONNECT_STATUS_DISCONNECTED",t[t.V2NIM_CONNECT_STATUS_CONNECTED=1]="V2NIM_CONNECT_STATUS_CONNECTED",t[t.V2NIM_CONNECT_STATUS_CONNECTING=2]="V2NIM_CONNECT_STATUS_CONNECTING",t[t.V2NIM_CONNECT_STATUS_WAITING=3]="V2NIM_CONNECT_STATUS_WAITING"}(Ze||(Ze={})),function(t){t[t.V2NIM_MESSAGE_AI_STATUS_UNKNOW=0]="V2NIM_MESSAGE_AI_STATUS_UNKNOW",t[t.V2NIM_MESSAGE_AI_STATUS_AT=1]="V2NIM_MESSAGE_AI_STATUS_AT",t[t.V2NIM_MESSAGE_AI_STATUS_RESPONSE=2]="V2NIM_MESSAGE_AI_STATUS_RESPONSE"}(et||(et={})),function(t){t[t.V2NIM_MESSAGE_TYPE_INVALID=-1]="V2NIM_MESSAGE_TYPE_INVALID",t[t.V2NIM_MESSAGE_TYPE_TEXT=0]="V2NIM_MESSAGE_TYPE_TEXT",t[t.V2NIM_MESSAGE_TYPE_IMAGE=1]="V2NIM_MESSAGE_TYPE_IMAGE",t[t.V2NIM_MESSAGE_TYPE_AUDIO=2]="V2NIM_MESSAGE_TYPE_AUDIO",t[t.V2NIM_MESSAGE_TYPE_VIDEO=3]="V2NIM_MESSAGE_TYPE_VIDEO",t[t.V2NIM_MESSAGE_TYPE_LOCATION=4]="V2NIM_MESSAGE_TYPE_LOCATION",t[t.V2NIM_MESSAGE_TYPE_NOTIFICATION=5]="V2NIM_MESSAGE_TYPE_NOTIFICATION",t[t.V2NIM_MESSAGE_TYPE_FILE=6]="V2NIM_MESSAGE_TYPE_FILE",t[t.V2NIM_MESSAGE_TYPE_AVCHAT=7]="V2NIM_MESSAGE_TYPE_AVCHAT",t[t.V2NIM_MESSAGE_TYPE_TIPS=10]="V2NIM_MESSAGE_TYPE_TIPS",t[t.V2NIM_MESSAGE_TYPE_ROBOT=11]="V2NIM_MESSAGE_TYPE_ROBOT",t[t.V2NIM_MESSAGE_TYPE_CALL=12]="V2NIM_MESSAGE_TYPE_CALL",t[t.V2NIM_MESSAGE_TYPE_CUSTOM=100]="V2NIM_MESSAGE_TYPE_CUSTOM"}(rt||(rt={})),function(t){t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_UNDEFINED=-1]="V2NIM_MESSAGE_NOTIFICATION_TYPE_UNDEFINED",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE=0]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_KICK=1]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_KICK",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_LEAVE=2]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_LEAVE",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_UPDATE_TINFO=3]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_UPDATE_TINFO",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_DISMISS=4]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_DISMISS",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_APPLY_PASS=5]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_APPLY_PASS",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_OWNER_TRANSFER=6]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_OWNER_TRANSFER",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_ADD_MANAGER=7]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_ADD_MANAGER",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_REMOVE_MANAGER=8]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_REMOVE_MANAGER",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE_ACCEPT=9]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE_ACCEPT",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_BANNED_TEAM_MEMBER=10]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_BANNED_TEAM_MEMBER",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE=401]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_KICK=402]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_KICK",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_LEAVE=403]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_LEAVE",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_UPDATE_TINFO=404]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_UPDATE_TINFO",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_DISMISS=405]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_DISMISS",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_APPLY_PASS=410]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_APPLY_PASS",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_OWNER_TRANSFER=406]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_OWNER_TRANSFER",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_ADD_MANAGER=407]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_ADD_MANAGER",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_REMOVE_MANAGER=408]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_REMOVE_MANAGER",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE_ACCEPT=411]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE_ACCEPT",t[t.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_BANNED_TEAM_MEMBER=409]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_BANNED_TEAM_MEMBER"}(it||(it={})),function(t){t[t.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN=0]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN",t[t.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS=1]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS",t[t.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED=2]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED",t[t.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING=3]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING"}(nt||(nt={})),function(t){t[t.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN=0]="V2NIM_MESSAGE_SENDING_STATE_UNKNOWN",t[t.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED=1]="V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED",t[t.V2NIM_MESSAGE_SENDING_STATE_FAILED=2]="V2NIM_MESSAGE_SENDING_STATE_FAILED",t[t.V2NIM_MESSAGE_SENDING_STATE_SENDING=3]="V2NIM_MESSAGE_SENDING_STATE_SENDING"}(ot||(ot={})),function(t){t[t.V2NIM_QUERY_DIRECTION_DESC=0]="V2NIM_QUERY_DIRECTION_DESC",t[t.V2NIM_QUERY_DIRECTION_ASC=1]="V2NIM_QUERY_DIRECTION_ASC"}(st||(st={})),function(t){t[t.V2NIM_MESSAGE_REVOKE_TYPE_UNDEFINED=0]="V2NIM_MESSAGE_REVOKE_TYPE_UNDEFINED",t[t.V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY=1]="V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY",t[t.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY=2]="V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY",t[t.V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY=3]="V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY",t[t.V2NIM_MESSAGE_REVOKE_TYPE_P2P_ONEWAY=4]="V2NIM_MESSAGE_REVOKE_TYPE_P2P_ONEWAY",t[t.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_ONEWAY=5]="V2NIM_MESSAGE_REVOKE_TYPE_TEAM_ONEWAY"}(at||(at={})),function(t){t[t.V2NIM_MESSAGE_PIN_STATE_NOT_PINNED=0]="V2NIM_MESSAGE_PIN_STATE_NOT_PINNED",t[t.V2NIM_MESSAGE_PIN_STATE_PINNED=1]="V2NIM_MESSAGE_PIN_STATE_PINNED",t[t.V2NIM_MESSAGE_PIN_STATE_UPDATED=2]="V2NIM_MESSAGE_PIN_STATE_UPDATED"}(ct||(ct={})),function(t){t[t.V2NIM_QUICK_COMMENT_STATE_ADD=1]="V2NIM_QUICK_COMMENT_STATE_ADD",t[t.V2NIM_QUICK_COMMENT_STATE_REMOVE=2]="V2NIM_QUICK_COMMENT_STATE_REMOVE"}(dt||(dt={})),function(t){t[t.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE=0]="V2NIM_CLIENT_ANTISPAM_OPERATE_NONE",t[t.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE=1]="V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE",t[t.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD=2]="V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD",t[t.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD=3]="V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD"}(lt||(lt={})),function(t){t[t.V2NIM_SORT_ORDER_DESC=0]="V2NIM_SORT_ORDER_DESC",t[t.V2NIM_SORT_ORDER_ASC=1]="V2NIM_SORT_ORDER_ASC"}(pt||(pt={})),function(t){t[t.P2P_DELETE_MSG=7]="P2P_DELETE_MSG",t[t.TEAM_DELETE_MSG=8]="TEAM_DELETE_MSG",t[t.SUPERTEAM_DELETE_MSG=12]="SUPERTEAM_DELETE_MSG",t[t.P2P_ONE_WAY_DELETE_MSG=13]="P2P_ONE_WAY_DELETE_MSG",t[t.TEAM_ONE_WAY_DELETE_MSG=14]="TEAM_ONE_WAY_DELETE_MSG",t[t.CUSTOM_P2P_MSG=100]="CUSTOM_P2P_MSG",t[t.CUSTOM_TEAM_MSG=101]="CUSTOM_TEAM_MSG",t[t.CUSTOM_SUPERTEAM_MSG=103]="CUSTOM_SUPERTEAM_MSG"}(ut||(ut={})),function(t){t[t.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF=0]="V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF",t[t.V2NIM_TEAM_MESSAGE_MUTE_MODE_ON=1]="V2NIM_TEAM_MESSAGE_MUTE_MODE_ON",t[t.V2NIM_TEAM_MESSAGE_MUTE_MODE_NORMAL_ON=2]="V2NIM_TEAM_MESSAGE_MUTE_MODE_NORMAL_ON"}(mt||(mt={})),function(t){t[t.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF=0]="V2NIM_P2P_MESSAGE_MUTE_MODE_OFF",t[t.V2NIM_P2P_MESSAGE_MUTE_MODE_ON=1]="V2NIM_P2P_MESSAGE_MUTE_MODE_ON"}(ht||(ht={})),function(t){t[t.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_ALL=0]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_ALL",t[t.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_NORMAL=1]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_NORMAL",t[t.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_MANAGER=2]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_MANAGER"}(gt||(gt={})),function(t){t[t.V2NIM_TEAM_TYPE_INVALID=0]="V2NIM_TEAM_TYPE_INVALID",t[t.V2NIM_TEAM_TYPE_ADVANCED=1]="V2NIM_TEAM_TYPE_ADVANCED",t[t.V2NIM_TEAM_TYPE_SUPER=2]="V2NIM_TEAM_TYPE_SUPER"}(_t||(_t={})),function(t){t[t.V2NIM_TEAM_JOIN_MODE_FREE=0]="V2NIM_TEAM_JOIN_MODE_FREE",t[t.V2NIM_TEAM_JOIN_MODE_APPLY=1]="V2NIM_TEAM_JOIN_MODE_APPLY",t[t.V2NIM_TEAM_JOIN_MODE_INVITE=2]="V2NIM_TEAM_JOIN_MODE_INVITE"}(vt||(vt={})),function(t){t[t.V2NIM_TEAM_AGREE_MODE_AUTH=0]="V2NIM_TEAM_AGREE_MODE_AUTH",t[t.V2NIM_TEAM_AGREE_MODE_NO_AUTH=1]="V2NIM_TEAM_AGREE_MODE_NO_AUTH"}(It||(It={})),function(t){t[t.V2NIM_TEAM_INVITE_MODE_MANAGER=0]="V2NIM_TEAM_INVITE_MODE_MANAGER",t[t.V2NIM_TEAM_INVITE_MODE_ALL=1]="V2NIM_TEAM_INVITE_MODE_ALL"}(Et||(Et={})),function(t){t[t.V2NIM_TEAM_UPDATE_INFO_MODE_MANAGER=0]="V2NIM_TEAM_UPDATE_INFO_MODE_MANAGER",t[t.V2NIM_TEAM_UPDATE_INFO_MODE_ALL=1]="V2NIM_TEAM_UPDATE_INFO_MODE_ALL"}(ft||(ft={})),function(t){t[t.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN=0]="V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN",t[t.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL=1]="V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL",t[t.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_ALL=2]="V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_ALL"}(Tt||(Tt={})),function(t){t[t.V2NIM_TEAM_UPDATE_EXTENSION_MODE_MANAGER=0]="V2NIM_TEAM_UPDATE_EXTENSION_MODE_MANAGER",t[t.V2NIM_TEAM_UPDATE_EXTENSION_MODE_ALL=1]="V2NIM_TEAM_UPDATE_EXTENSION_MODE_ALL"}(Mt||(Mt={})),function(t){t[t.V2NIM_TEAM_MESSAGE_NOTIFY_MODE_ALL=0]="V2NIM_TEAM_MESSAGE_NOTIFY_MODE_ALL",t[t.V2NIM_TEAM_MESSAGE_NOTIFY_MODE_MANAGER=1]="V2NIM_TEAM_MESSAGE_NOTIFY_MODE_MANAGER",t[t.V2NIM_TEAM_MESSAGE_NOTIFY_MODE_CLOSE=2]="V2NIM_TEAM_MESSAGE_NOTIFY_MODE_CLOSE"}(yt||(yt={})),function(t){t[t.V2NIM_TEAM_MEMBER_ROLE_NORMAL=0]="V2NIM_TEAM_MEMBER_ROLE_NORMAL",t[t.V2NIM_TEAM_MEMBER_ROLE_OWNER=1]="V2NIM_TEAM_MEMBER_ROLE_OWNER",t[t.V2NIM_TEAM_MEMBER_ROLE_MANAGER=2]="V2NIM_TEAM_MEMBER_ROLE_MANAGER"}(St||(St={})),function(t){t[t.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION=0]="V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION",t[t.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION=1]="V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION",t[t.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION=2]="V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION",t[t.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION=3]="V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION"}(Nt||(Nt={})),function(t){t[t.V2NIM_TEAM_JOIN_ACTION_STATUS_INIT=0]="V2NIM_TEAM_JOIN_ACTION_STATUS_INIT",t[t.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED=1]="V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED",t[t.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED=2]="V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED",t[t.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED=3]="V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED"}(Ct||(Ct={})),function(t){t[t.teamApply=0]="teamApply",t[t.teamApplyReject=1]="teamApplyReject",t[t.teamInvite=2]="teamInvite",t[t.teamInviteReject=3]="teamInviteReject",t[t.tlistUpdate=4]="tlistUpdate",t[t.superTeamApply=15]="superTeamApply",t[t.superTeamApplyReject=16]="superTeamApplyReject",t[t.superTeamInvite=17]="superTeamInvite",t[t.superTeamInviteReject=18]="superTeamInviteReject"}(At||(At={})),function(t){t[t.V2NIM_AI_MODEL_TYPE_UNKNOW=0]="V2NIM_AI_MODEL_TYPE_UNKNOW",t[t.V2NIM_AI_MODEL_TYPE_QWEN=1]="V2NIM_AI_MODEL_TYPE_QWEN",t[t.V2NIM_AI_MODEL_TYPE_AZURE=2]="V2NIM_AI_MODEL_TYPE_AZURE",t[t.V2NIM_AI_MODEL_TYPE_PRIVATE=3]="V2NIM_AI_MODEL_TYPE_PRIVATE"}(Ot||(Ot={})),function(t){t.V2NIM_AI_MODEL_ROLE_TYPE_SYSTEM="system",t.V2NIM_AI_MODEL_ROLE_TYPE_USER="user",t.V2NIM_AI_MODEL_ROLE_TYPE_ASSISTANT="assistant"}(Rt||(Rt={})),function(t){t[t.V2NIM_SIGNALLING_EVENT_TYPE_UNKNOWN=0]="V2NIM_SIGNALLING_EVENT_TYPE_UNKNOWN",t[t.V2NIM_SIGNALLING_EVENT_TYPE_CLOSE=1]="V2NIM_SIGNALLING_EVENT_TYPE_CLOSE",t[t.V2NIM_SIGNALLING_EVENT_TYPE_JOIN=2]="V2NIM_SIGNALLING_EVENT_TYPE_JOIN",t[t.V2NIM_SIGNALLING_EVENT_TYPE_INVITE=3]="V2NIM_SIGNALLING_EVENT_TYPE_INVITE",t[t.V2NIM_SIGNALLING_EVENT_TYPE_CANCEL_INVITE=4]="V2NIM_SIGNALLING_EVENT_TYPE_CANCEL_INVITE",t[t.V2NIM_SIGNALLING_EVENT_TYPE_REJECT=5]="V2NIM_SIGNALLING_EVENT_TYPE_REJECT",t[t.V2NIM_SIGNALLING_EVENT_TYPE_ACCEPT=6]="V2NIM_SIGNALLING_EVENT_TYPE_ACCEPT",t[t.V2NIM_SIGNALLING_EVENT_TYPE_LEAVE=7]="V2NIM_SIGNALLING_EVENT_TYPE_LEAVE",t[t.V2NIM_SIGNALLING_EVENT_TYPE_CONTROL=8]="V2NIM_SIGNALLING_EVENT_TYPE_CONTROL"}(bt||(bt={})),function(t){t[t.V2NIM_SIGNALLING_CHANNEL_TYPE_AUDIO=1]="V2NIM_SIGNALLING_CHANNEL_TYPE_AUDIO",t[t.V2NIM_SIGNALLING_CHANNEL_TYPE_VIDEO=2]="V2NIM_SIGNALLING_CHANNEL_TYPE_VIDEO",t[t.V2NIM_SIGNALLING_CHANNEL_TYPE_CUSTOM=3]="V2NIM_SIGNALLING_CHANNEL_TYPE_CUSTOM"}(Vt||(Vt={})),function(t){t[t.V2NIM_USER_STATUS_TYPE_UNKNOWN=0]="V2NIM_USER_STATUS_TYPE_UNKNOWN",t[t.V2NIM_USER_STATUS_TYPE_LOGIN=1]="V2NIM_USER_STATUS_TYPE_LOGIN",t[t.V2NIM_USER_STATUS_TYPE_LOGOUT=2]="V2NIM_USER_STATUS_TYPE_LOGOUT",t[t.V2NIM_USER_STATUS_TYPE_DISCONNECT=3]="V2NIM_USER_STATUS_TYPE_DISCONNECT"}(Pt||(Pt={}));var Lt={V2NIM_ERROR_CODE_UNKNOWN:{code:0,message:"unknown error"},V2NIM_ERROR_CODE_SUCCESS:{code:200,message:"success"},V2NIM_ERROR_CODE_HANDSHAKE:{code:201,message:"handshake error"},V2NIM_ERROR_CODE_REQUEST_TEMPERARY_FORBIDDEN:{code:398,message:"request temprary forbidden"},V2NIM_ERROR_CODE_SERVER_UNIT_ERROR:{code:399,message:"server unit error"},V2NIM_ERROR_CODE_FORBIDDEN:{code:403,message:"forbidden"},V2NIM_ERROR_CODE_NOT_FOUND:{code:404,message:"not found"},V2NIM_ERROR_CODE_PARAMETER_ERROR:{code:414,message:"parameter error"},V2NIM_ERROR_CODE_RATE_LIMIT_REACHED:{code:416,message:"rate limit reached"},V2NIM_ERROR_CODE_MULTI_LOGIN_FORBIDDEN:{code:417,message:"multi login forbidden"},V2NIM_ERROR_CODE_SERVER_INTERNAL_ERROR:{code:500,message:"server internal error"},V2NIM_ERROR_CODE_SERVER_BUSY:{code:503,message:"server busy"},V2NIM_ERROR_CODE_APP_UNREACHABLE:{code:511,message:"app server unreachable"},V2NIM_ERROR_CODE_SERVICE_UNAVAILABLE:{code:514,message:"service unavailable"},V2NIM_ERROR_CODE_PROTOCOL_BLACKHOLE_FILTERED:{code:599,message:"protocol filtered by blackhole rule"},V2NIM_ERROR_CODE_NO_PERMISSION:{code:997,message:"appid has no permission to call the protocol"},V2NIM_ERROR_CODE_UNPACK_ERROR:{code:998,message:"unpack error"},V2NIM_ERROR_CODE_PACK_ERROR:{code:999,message:"pack error"},V2NIM_ERROR_CODE_IM_DISABLED:{code:101301,message:"IM disabled"},V2NIM_ERROR_CODE_SERVICE_ADDRESS_INVALID:{code:101302,message:"service address invalid"},V2NIM_ERROR_CODE_APPKEY_NOT_EXIST:{code:101303,message:"appkey not exist"},V2NIM_ERROR_CODE_BUNDLEID_CHECK_FAILED:{code:101304,message:"bundleid check failed"},V2NIM_ERROR_CODE_APPKEY_BLOCKED:{code:101403,message:"appkey blocked"},V2NIM_ERROR_CODE_INVALID_TOKEN:{code:102302,message:"invalid token"},V2NIM_ERROR_CODE_ROBOT_NOT_ALLOWED:{code:102303,message:"robot not allowed"},V2NIM_ERROR_CODE_ACCOUNT_NOT_EXIST:{code:102404,message:"account not exist"},V2NIM_ERROR_CODE_ACCOUNT_CHAT_BANNED:{code:102421,message:"account chat banned"},V2NIM_ERROR_CODE_ACCOUNT_BANNED:{code:102422,message:"account banned"},V2NIM_ERROR_CODE_ACCOUNT_IN_BLOCK_LIST:{code:102426,message:"account in block list"},V2NIM_ERROR_CODE_USER_PROFILE_NOT_EXIST:{code:103404,message:"user profile not exist"},V2NIM_ERROR_CODE_USER_PROFILE_HIT_ANTISPAM:{code:103451,message:"user profile hit antispam"},V2NIM_ERROR_CODE_PEER_FRIEND_LIMIT:{code:104301,message:"peer friend limit"},V2NIM_ERROR_CODE_FRIEND_APPLICATION_NOT_EXIST:{code:104302,message:"friend application not exist"},V2NIM_ERROR_CODE_FRIEND_NOT_EXIST:{code:104404,message:"friend not exist"},V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST:{code:104405,message:"friend already exist"},V2NIM_ERROR_CODE_SELF_FRIEND_OPERATION_NOT_ALLOWED:{code:104429,message:"self friend operation not allowed"},V2NIM_ERROR_CODE_FRIEND_LIMIT:{code:104435,message:"friend limit"},V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT:{code:104449,message:"friend operation rate limit"},V2NIM_ERROR_CODE_FRIEND_HIT_ANTISPAM:{code:104451,message:"friend hit antispam"},V2NIM_ERROR_CODE_SELF_MUTE_OPERATION_NOT_ALLOWED:{code:105429,message:"self mute operation not allowed"},V2NIM_ERROR_CODE_MUTE_LIST_LIMIT:{code:105435,message:"mute list limit"},V2NIM_ERROR_CODE_SELF_BLOCK_LIST_OPERATION_NOT_ALLOWED:{code:106429,message:"self block list operation not allowed"},V2NIM_ERROR_CODE_BLOCK_LIST_LIMIT:{code:106435,message:"block list limit"},V2NIM_ERROR_CODE_REVOKE_THIRD_PARTY_MESSAGE_NOT_ALLOWED:{code:107301,message:"revoke third party message not allowed"},V2NIM_ERROR_CODE_SHORT_TO_LONG_URL_FAILED:{code:107307,message:"short to long URL failed"},V2NIM_ERROR_CODE_URL_INVALID:{code:107308,message:"URL invalid"},V2NIM_ERROR_CODE_DURATION_OUT_OF_RANGE:{code:107309,message:"duration out of range"},V2NIM_ERROR_CODE_GET_FILE_META_INFO_FAILED:{code:107310,message:"get file meta info failed"},V2NIM_ERROR_CODE_AUDIO_FILE_SIZE_LIMIT:{code:107311,message:"audio file size limit"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_TIMEOUT:{code:107312,message:"voice to text timeout"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_FAILED:{code:107313,message:"voice to text failed"},V2NIM_ERROR_CODE_REVOKE_EXCEED_TIME_LIMIT:{code:107314,message:"revoke message exceed time limit"},V2NIM_ERROR_CODE_REVOKE_MESSAGE_NOT_ALLOWED:{code:107315,message:"revoke specific message not allowed"},V2NIM_ERROR_CODE_FORCE_PUSH_LIST_LIMIT:{code:107316,message:"force push list limit"},V2NIM_ERROR_CODE_TEAM_MESSAGE_RECEIPT_RATE_LIMIT:{code:107317,message:"team message receipt rate limit"},V2NIM_ERROR_CODE_SNAPSHOT_NOT_EXIST:{code:107318,message:"snapshot not exist"},V2NIM_ERROR_CODE_PIN_LIMIT:{code:107319,message:"pin limit"},V2NIM_ERROR_CODE_PIN_NOT_EXIST:{code:107320,message:"pin not exist"},V2NIM_ERROR_CODE_QUICK_COMMENT_LIMIT:{code:107321,message:"quick comment limit"},V2NIM_ERROR_CODE_PIN_ALREADY_EXIST:{code:107322,message:"pin already exist"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_FUNCTION_DISABLED:{code:107333,message:"voice to text function disabled"},V2NIM_ERROR_CODE_CLOUD_SEARCH_FUNCTION_DISABLED:{code:107334,message:"cloud search function disabled"},V2NIM_ERROR_CODE_ONE_WAY_DELETE_FUNCTION_DISABLED:{code:107335,message:"one-way delete function disabled"},V2NIM_ERRPR_CODE_ONEWAY_DELETION_NOT_ALLOW_FOR_TARGET_MESSAGES:{code:107338,message:"one-way deletion is not allowed for target messages"},V2NIM_ERRPR_CODE_SENDER_CANNOT_INCLUDED_IN_TARGET_LIST:{code:107339,message:"The message sender cannot be included in the target list"},V2NIM_ERROR_CODE_ROBOT_CANNOT_SEND_TARGET_MESSAGE:{code:107340,message:"Robot can not send target message"},V2NIM_ERROR_CODE_PIN_TARGET_MESSAGE_NOT_ALLOWED:{code:107345,message:"Pin target message is not allowed"},V2NIM_ERROR_CODE_TARGET_MESSAGE_NOT_ALLOWED_REPLY:{code:107346,message:"Target message not allowed reply"},V2NIM_ERROR_CODE_TARGET_MESSAGE_NOT_ALLOWED_QUICK_COMMENT:{code:107347,message:"Target message not allowed quick comment"},V2NIM_ERROR_CODE_REVOKE_MESSAGE_TO_SELF_NOT_ALLOWED:{code:107429,message:"revoke message to self not allowed"},V2NIM_ERROR_CODE_APP_CHAT_BANNED:{code:107410,message:"app chat banned"},V2NIM_ERROR_CODE_QUICK_COMMENT_FUNCTION_DISABLED:{code:107326,message:"quick comment function disabled"},V2NIM_ERROR_CODE_PIN_FUNCTION_DISABLED:{code:107327,message:"PIN function disabled"},V2NIM_ERROR_CODE_TEAM_READ_RECEIPT_FUNCTION_DISABLED:{code:107324,message:"read receipt for team messages function disabled"},V2NIM_ERROR_CODE_P2P_READ_RECEIPT_FUNCTION_DISABLED:{code:107325,message:"read receipt for p2p messages function disabled"},V2NIM_ERROR_CODE_RATE_LIMIT_FOR_MESSAGING_REACHED:{code:107323,message:"rate limit for messaging reached"},V2NIM_ERROR_CODE_MESSAGE_HIT_ANTISPAM:{code:107451,message:"message hit antispam"},V2NIM_ERROR_CODE_MESSAGE_NOT_EXIST:{code:107404,message:"message not exist"},V2NIM_ERROR_CODE_UNSENDING_MESSAGE_EXPIRED:{code:107406,message:"unsending message expired"},V2NIM_ERROR_CODE_TEAM_MARK_READ_FAILED:{code:107302,message:"sending message failed for marking message read failed for too many team members"},V2NIM_ERROR_CODE_SENDER_OR_MANAGER_PERMISSION_ONLY_REVOKE:{code:107303,message:"only sender or manager can revoke message"},V2NIM_ERROR_CODE_DELETE_SELF_MESSAGE_NOT_ALLOWED:{code:107328,message:"delete self message not allowed"},V2NIM_ERROR_CODE_NOT_CHATBOT_ACCOUNT:{code:107329,message:"is not chatbot account"},V2NIM_ERROR_CODE_MESSAGE_SENSE_REQUIRED:{code:107330,message:"sender or receiver must sense message"},V2NIM_ERROR_CODE_HIGH_PRIORITY_MESSAGE_RATE_LIMIT:{code:107304,message:"rate limit of high-priority messages exceeded"},ACK_MESSAGE_BE_HIGH_PRIORITY:{code:107305,message:"ack message should be high-priority"},V2NIM_ERROR_CODE_DUPLICATE_CLIENT_MESSAGE_ID:{code:107306,message:"duplicate client message ID"},V2NIM_ERROR_CODE_INVALID_TIME_RANGE:{code:107439,message:"invalid time range"},V2NIM_ERROR_CODE_NOT_ADVANCED_TEAM:{code:108302,message:"not advanced team"},V2NIM_ERROR_CODE_TEAM_MANAGER_LIMIT:{code:108303,message:"team manager limit"},V2NIM_ERROR_CODE_JOINED_TEAM_LIMIT:{code:108305,message:"joined team limit"},V2NIM_ERROR_CODE_TEAM_NORMAL_MEMBER_CHAT_BANNED:{code:108306,message:"team normal member chat banned"},V2NIM_ERROR_CODE_INVITED_ACCOUNT_NOT_FRIEND:{code:108307,message:"invited account not friend"},V2NIM_ERROR_CODE_REJECT_ALL_TEAM_APPLICATIONS:{code:108308,message:"reject all team applications"},V2NIM_ERROR_CODE_TARGETING_MESSAGE_FOR_TEAM_DISABLED:{code:108318,message:"Targeting messages for group chat is disabled"},V2NIM_ERROR_CODE_INCLUSIVE_AS_FALSE_NOT_ALLOWED_FOR_SUPER_TEAM:{code:108319,message:'Setting "inclusive" to false for super teams is not allowed'},V2NIM_ERROR_CODE_CANNOT_MAKE_SUPER_TEAM_MESSAGE_VISIBLE_TO_NEW_MEMBERS:{code:108320,message:"Cannot make super team targeted messages visible to new members"},V2NIM_ERROR_CODE_CANNOT_ALLOW_TARGETED_MESSAGES_INCLUSIVE_TO_NEW_MEMBERS:{code:108321,message:"Cannot allow targeted messages inclusive to new members"},V2NIM_ERROR_CODE_TEAM_NOT_EXIST:{code:108404,message:"team not exist"},V2NIM_ERROR_CODE_TEAM_ALREADY_CHAT_BANNED:{code:108420,message:"team already chat banned"},V2NIM_ERROR_CODE_ALL_TEAM_MEMBER_CHAT_BANNED:{code:108423,message:"all team member chat banned"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_LIMIT:{code:108434,message:"extended super team limit"},V2NIM_ERROR_CODE_CREATED_TEAM_LIMIT:{code:108435,message:"created team limit"},V2NIM_ERROR_CODE_TEAM_INVITATION_LIMIT:{code:108437,message:"team invitation limit"},V2NIM_ERROR_CODE_TEAM_HIT_ANTISPAM:{code:108451,message:"team hit antispam"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_LIMIT_NOT_CONFIGURED:{code:108304,message:"extended super team limit not configured"},V2NIM_ERROR_CODE_SUPER_TEAM_SERVICE_DISABLED:{code:108311,message:"super team service disabled"},V2NIM_ERROR_CODE_TEAM_READ_RECEIPT_RECORD_NOT_FOUND:{code:108301,message:"read receipt record for the team message not found"},V2NIM_ERROR_CODE_NOT_MANAGER:{code:108430,message:"unable to assign owner manager"},V2NIM_ERROR_CODE_ONLINE_MEMBER_COUNT_DISABLED:{code:108406,message:"number of online users service disabled"},V2NIM_ERROR_CODE_TRANSFER_DISABLED:{code:108310,message:"unable to transfer the ownership to owner"},V2NIM_ERROR_CODE_CREATE_TEAM_DISABLED:{code:108309,message:"unable to create team with more than %s people"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_CREATE_FAILED:{code:108313,message:"/ extended super team creation failedï¼Œuse open api to create the team"},V2NIM_ERROR_CODE_TEAM_MESSAGE_READ_RECEIPT_DISABLED:{code:108312,message:"read receipt for team messages function disabled"},V2NIM_ERROR_CODE_RETRY:{code:108449,message:"an error occurred, try again"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_NOT_TEAM_MEMBER:{code:109301,message:"list of chat banned users contains non team members"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_OPERATOR:{code:109303,message:"list of chat banned users contains the operator"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_TEAM_OWNER:{code:109304,message:"list of chat banned users contains the team owner"},V2NIM_ERROR_CODE_OPERATION_ON_TEAM_MANAGER_NOT_ALLOWED:{code:109305,message:"operation on team manager not allowed"},V2NIM_ERROR_CODE_NO_TEAM_INVITE_PERMISSION:{code:109306,message:"no team invite permission"},V2NIM_ERROR_CODE_TEAM_OWNER_QUIT_NOT_ALLOWED:{code:109307,message:"team owner quit not allowed"},V2NIM_ERROR_CODE_TEAM_OWNER_IN_KICK_LIST:{code:109308,message:"list of kicked user contains the team owner"},V2NIM_ERROR_CODE_INVITE_ROBOT_ACCOUNT_NOT_ALLOWED:{code:109309,message:"invite robot account not allowed"},V2NIM_ERROR_CODE_KICK_OPERATOR_NOT_ALLOWED:{code:109310,message:"kick operator not allowed"},V2NIM_ERROR_CODE_TEAM_MEMBER_ALREADY_EXIST:{code:109311,message:"team member already exist"},V2NIM_ERROR_CODE_TEAM_INVITATION_OR_APPLICATION_NOT_EXIST:{code:109313,message:"team invitation or application not exist"},V2NIM_ERROR_CODE_OPERATION_ON_TEAM_OWNER_NOT_ALLOWED:{code:109314,message:"operation on team owner not allowed"},V2NIM_ERROR_CODE_FORCED_PUSH_LIST_INCLUDES_NON_TARGETED_ACCOUNTS:{code:109318,message:"The forced push list includes non-targeted accounts"},V2NIM_ERROR_CODE_TEAM_MEMBER_NOT_EXIST:{code:109404,message:"team member not exist"},V2NIM_ERROR_CODE_TEAM_MEMBER_CHAT_BANNED:{code:109424,message:"team member chat banned"},V2NIM_ERROR_CODE_TEAM_OWNER_OPERATION_PERMISSION_REQUIRED:{code:109427,message:"team owner operation permission required"},V2NIM_ERROR_CODE_TEAM_OWNER_OR_MANAGER_OPERATION_PERMISSION_REQUIRED:{code:109432,message:"team owner or manager operation permission required"},V2NIM_ERROR_CODE_TEAM_MEMBER_CONCURRENT_OPERATION_FAILED:{code:109449,message:"team member concurrent operation failed"},V2NIM_ERROR_CODE_TEAM_MEMBER_HIT_ANTISPAM:{code:109451,message:"team member hit antispam"},V2NIM_ERROR_CODE_CONVERSATION_AND_ACCOUNT_MISMATCH:{code:110302,message:"conversation and account mismatch"},V2NIM_ERROR_CODE_CONVERSATION_STICK_TOP_LIMIT:{code:110303,message:"conversation stick top limit"},V2NIM_ERROR_CODE_CONVERSATION_BELONGED_GROUP_LIMIT:{code:110304,message:"conversation belonged group limit"},V2NIM_ERROR_CODE_CONVERSATION_NOT_EXIST:{code:110404,message:"conversation not exist"},V2NIM_ERROR_CODE_CHATROOM_LINK_UNAVAILABLE:{code:113304,message:"chatroom link unavailable"},V2NIM_ERROR_CODE_IM_CONNECTION_ABNORMAL:{code:113305,message:"IM connection abnormal"},V2NIM_ERROR_CODE_CHATROOM_NOT_EXIST:{code:113404,message:"chatroom not exist"},V2NIM_ERROR_CODE_CHATROOM_CLOSED:{code:113406,message:"chatroom closed"},V2NIM_ERROR_CODE_CHATROOM_REPEATED_OPERATION:{code:113409,message:"chatroom repeated operation"},V2NIM_ERROR_CODE_CHATROOM_DISABLED:{code:113410,message:"chatroom disabled"},V2NIM_ERROR_CODE_ALL_CHATROOM_MEMBER_CHAT_BANNED:{code:113423,message:"all chatroom member chat banned"},V2NIM_ERROR_CODE_CHATROOM_HIT_ANTISPAM:{code:113451,message:"chatroom hit antispam"},V2NIM_ERROR_CODE_ANONYMOUS_MEMBER_FORBIDDEN:{code:114303,message:"anonymous member forbidden"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_NOT_EXIST:{code:114404,message:"chatroom member not exist"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_REPEATED_OPERATION:{code:114405,message:"chatroom member repeated operation"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_CHAT_BANNED:{code:114421,message:"chatroom member chat banned"},V2NIM_ERROR_CODE_ACCOUNT_IN_CHATROOM_BLOCK_LIST:{code:114426,message:"account in chatroom block list"},V2NIM_ERROR_CODE_CHATROOM_OWNER_OPERATION_PERMISSION_REQUIRED:{code:114427,message:"chatroom owner operation permission required"},V2NIM_ERROR_CODE_SELF_IN_CHATROOM_MEMBER_OPERATION_LIST:{code:114429,message:"self in chatroom member operation list"},V2NIM_ERROR_CODE_CHATROOM_OWNER_OR_MANAGER_OPERATION_PERMISSION_REQUIRED:{code:114432,message:"chatroom owner or manager operation permission required"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_LIMIT:{code:114437,message:"chatroom member limit"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_CONCURRENT_OPERATION_FAILED:{code:114449,message:"chatroom member concurrent operation failed"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_HIT_ANTISPAM:{code:114451,message:"chatroom member hit antispam"},V2NIM_ERROR_CODE_CONVERSATION_GROUP_NOT_EXIST:{code:116404,message:"conversation group not exist"},V2NIM_ERROR_CODE_CONVERSATION_GROUP_LIMIT:{code:116435,message:"conversation group limit"},V2NIM_ERROR_CODE_CONVERSATIONS_IN_GROUP_LIMIT:{code:116437,message:"conversations in group limit"},V2NIM_ERROR_CODE_COLLECTION_LIMIT:{code:189301,message:"collection limit"},V2NIM_ERROR_CODE_COLLECTION_NOT_EXIST:{code:189302,message:"collection not exist"},V2NIM_ERROR_CODE_COLLECTION_CONCURRENT_OPERATION_FAILED:{code:189449,message:"collection concurrent operation failed"},V2NIM_ERROR_CODE_INTERNAL:{code:190001,message:"internal error"},V2NIM_ERROR_CODE_ILLEGAL_STATE:{code:190002,message:"illegal state"},V2NIM_ERROR_CODE_MISUSE:{code:191001,message:"misuse"},V2NIM_ERROR_CODE_CANCELLED:{code:191002,message:"operation cancelled"},V2NIM_ERROR_CODE_CALLBACK_FAILED:{code:191003,message:"callback failed"},V2NIM_ERROR_CODE_INVALID_PARAMETER:{code:191004,message:"invalid parameter"},V2NIM_ERROR_CODE_TIMEOUT:{code:191005,message:"timeout"},V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST:{code:191006,message:"resource not exist"},V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST:{code:191007,message:"resource already exist"},V2NIM_ERROR_CODE_CONNECT_FAILED:{code:192001,message:"connect failed"},V2NIM_ERROR_CODE_CONNECT_TIMEOUT:{code:192002,message:"connect timeout"},V2NIM_ERROR_CODE_DISCONNECT:{code:192003,message:"disconnect"},V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT:{code:192004,message:"protocol timeout"},V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED:{code:192005,message:"protocol send failed"},V2NIM_ERROR_CODE_REQUEST_FAILED:{code:192006,message:"request failed"},V2NIM_ERROR_CODE_FILE_NOT_FOUND:{code:194001,message:"file not found"},V2NIM_ERROR_CODE_FILE_CREATE_FAILED:{code:194002,message:"file create failed"},V2NIM_ERROR_CODE_FILE_OPEN_FAILED:{code:194003,message:"file open failed"},V2NIM_ERROR_CODE_FILE_WRITE_FAILED:{code:194004,message:"file write failed"},V2NIM_ERROR_CODE_FILE_READ_FAILED:{code:194005,message:"file read failed"},V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:{code:194006,message:"file upload failed"},V2NIM_ERROR_CODE_FILE_DOWNLOAD_FAILED:{code:194007,message:"file download failed"},V2NIM_ERROR_CODE_CLIENT_ANTISPAM:{code:195001,message:"client anti-spam"},V2NIM_ERROR_CODE_SERVER_ANTISPAM:{code:195002,message:"server anti-spam"}},Dt=Object.keys(Lt),wt=Dt.reduce((function(t,o){var a=Lt[o];return t[o]=a.code,t}),{}),Ut=Dt.reduce((function(t,o){var a=Lt[o];return t[a.code]=a.message,t}),{}),xt=/*#__PURE__*/Object.freeze({__proto__:null,V2NIMErrorCode:wt,V2NIMErrorDesc:Ut,get V2NIMDataSyncLevel(){return xe},get V2NIMDataSyncType(){return Fe},get V2NIMDataSyncState(){return Ge},get V2NIMConversationType(){return Be},get V2NIMLastMessageState(){return je},get V2NIMFriendAddMode(){return Ye},get V2NIMFriendAddApplicationType(){return He},get V2NIMFriendAddApplicationStatus(){return $e},get V2NIMFriendDeletionType(){return qe},get V2NIMFriendVerifyType(){return ze},get V2NIMLoginAuthType(){return Ke},get V2NIMLoginStatus(){return We},get V2NIMLoginClientType(){return Je},get V2NIMKickedOfflineReason(){return Xe},get V2NIMLoginClientChange(){return Qe},get V2NIMConnectStatus(){return Ze},get V2NIMMessageType(){return rt},get V2NIMMessageNotificationType(){return it},get V2NIMMessageAttachmentUploadState(){return nt},get V2NIMMessageSendingState(){return ot},get V2NIMQueryDirection(){return st},get V2NIMMessageRevokeType(){return at},get V2NIMMessagePinState(){return ct},get V2NIMMessageQuickCommentType(){return dt},get V2NIMClientAntispamOperateType(){return lt},get V2NIMSortOrder(){return pt},get V2NIMSystemMessageType(){return ut},get V2NIMTeamMessageMuteMode(){return mt},get V2NIMP2PMessageMuteMode(){return ht},get V2NIMTeamMemberRoleQueryType(){return gt},get V2NIMTeamType(){return _t},get V2NIMTeamJoinMode(){return vt},get V2NIMTeamAgreeMode(){return It},get V2NIMTeamInviteMode(){return Et},get V2NIMTeamUpdateInfoMode(){return ft},get V2NIMTeamChatBannedMode(){return Tt},get V2NIMTeamUpdateExtensionMode(){return Mt},get V2NIMTeamMessageNotifyMode(){return yt},get V2NIMTeamJoinActionType(){return Nt},get V2NIMTeamJoinActionStatus(){return Ct},get V2NIMTeamNotificationType(){return At},get V2NIMTeamMemberRole(){return St},get V2NIMAIModelRoleType(){return Rt},get V2NIMAIModelType(){return Ot},get V2NIMSignallingChannelType(){return Vt},get V2NIMSignallingEventType(){return bt},get V2NIMUserStatusType(){return Pt}});class V2NIMErrorImpl extends Error{constructor(t){super(t.desc),this.name="V2NIMError",this.code=t.code||0,this.desc=t.desc||Ut[this.code]||Ft[this.code]||"",this.message=this.desc,this.detail=t.detail||{}}toString(){var t,o=`${this.name}\n code: ${this.code}\n message: "${this.message}"\n detail: ${this.detail?JSON.stringify(this.detail):""}`;return(null===(t=null==this?void 0:this.detail)||void 0===t?void 0:t.rawError)&&(o+=`\n rawError: ${this.detail.rawError.message}`),o}}class ValidateError extends V2NIMErrorImpl{constructor(t,o={},a){super({code:wt.V2NIM_ERROR_CODE_PARAMETER_ERROR,detail:{reason:t,rules:a,data:o}}),this.name="validateError",this.message=this.message+"\n"+JSON.stringify(this.detail,null,2),this.data=o,this.rules=a}}class ValidateErrorV2 extends V2NIMErrorImpl{constructor(t){var o,a,c;super({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:null===(o=t.detail)||void 0===o?void 0:o.reason,rules:null===(a=t.detail)||void 0===a?void 0:a.rules,data:null===(c=t.detail)||void 0===c?void 0:c.data}}),this.name="ValidateErrorV2"}}class FormatError extends V2NIMErrorImpl{constructor(t,o,a){super({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:t,key:o,rules:a}}),this.name="formatError"}}class UploadError extends V2NIMErrorImpl{constructor(t){super(Object.assign({code:400},t)),this.desc=this.desc||"upload file error",this.message=this.desc,this.name="uploadError"}}var Ft={200:null,406:null,808:null,810:null,302:"The user name or password is incorrect.",405:"Parameter length too long",408:"Client request timed out",415:"Client network unavailable",422:"Account disabled",508:"Expiration date",509:"Invalid",7101:"Be pulled black",700:"Partial failure of batch operation",801:"The number of people in the team has reached the upper limit",802:"No permission",803:"The team does not exist or has not changed",804:"The user is not in the team",805:"Team type mismatch",806:"The number of teams created has reached the limit",807:"Team member not valid",809:"Already in the team",811:"The number of accounts in the forced push list exceeds the limit",812:"The team is muted",813:"Due to the limited number of team, some pull people successfully",814:"Disable team message read service",815:"Maximum number of team administrators",816:"Batch operation partial failure",9102:"Channel failure",9103:"This call has been answered / rejected at another end",10201:"Signaling: target NIM client is offline",10202:"Signaling: push is unreachable",10404:"Signaling: channel not exists",10405:"Signaling: channel already exists",10406:"Signaling: member of channel not exists",10407:"Signaling: member of channel already exists",10408:"Signaling: the invitation request does not exist or has expired",10409:"Signaling: the invitation request has been rejected",10410:"Signaling: the invitation request has been accepted",10414:"Signaling: request parameter error",10417:"Signaling: uid conflict",10419:"Signaling: the number of members of channel exceed the limit",10420:"Signaling: member is already in the channel on other client",10700:"Signaling: phased success",13002:"Abnormal chatroom status",13003:"In the blacklist",13004:"In the mute list",13006:"All members are muted, and only the administrator can speak"};var Gt=function stackClear(){this.__data__=new ge,this.size=0};var Bt=function stackDelete(t){var o=this.__data__,a=o.delete(t);return this.size=o.size,a};var jt=function stackGet(t){return this.__data__.get(t)};var Yt=function stackHas(t){return this.__data__.has(t)};var Ht=function stackSet(t,o){var a=this.__data__;if(a instanceof ge){var c=a.__data__;if(!_e||c.length<199)return c.push([t,o]),this.size=++a.size,this;a=this.__data__=new Se(c)}return a.set(t,o),this.size=a.size,this};function Stack(t){var o=this.__data__=new ge(t);this.size=o.size}Stack.prototype.clear=Gt,Stack.prototype.delete=Bt,Stack.prototype.get=jt,Stack.prototype.has=Yt,Stack.prototype.set=Ht;var $t=Stack,qt=function(){try{var t=X(Object,"defineProperty");return t({},"",{}),t}catch(t){}}();var zt=function baseAssignValue(t,o,a){"__proto__"==o&&qt?qt(t,o,{configurable:!0,enumerable:!0,value:a,writable:!0}):t[o]=a};var Kt=function assignMergeValue(t,o,a){(void 0!==a&&!ce(t[o],a)||void 0===a&&!(o in t))&&zt(t,o,a)};var Wt=function createBaseFor(t){return function(o,a,c){for(var m=-1,h=Object(o),g=c(o),_=g.length;_--;){var I=g[t?_:++m];if(!1===a(h[I],I,h))break}return o}}(),Jt=createCommonjsModule((function(t,o){var a=o&&!o.nodeType&&o,c=a&&t&&!t.nodeType&&t,m=c&&c.exports===a?g.Buffer:void 0,h=m?m.allocUnsafe:void 0;t.exports=function cloneBuffer(t,o){if(o)return t.slice();var a=t.length,c=h?h(a):new t.constructor(a);return t.copy(c),c}})),Xt=g.Uint8Array;var Qt=function cloneArrayBuffer(t){var o=new t.constructor(t.byteLength);return new Xt(o).set(new Xt(t)),o};var Zt=function cloneTypedArray(t,o){var a=o?Qt(t.buffer):t.buffer;return new t.constructor(a,t.byteOffset,t.length)};var er=function copyArray(t,o){var a=-1,c=t.length;for(o||(o=Array(c));++a<c;)o[a]=t[a];return o},tr=Object.create,rr=function(){function object(){}return function(t){if(!L(t))return{};if(tr)return tr(t);object.prototype=t;var o=new object;return object.prototype=void 0,o}}();var ir=function overArg(t,o){return function(a){return t(o(a))}},nr=ir(Object.getPrototypeOf,Object),or=Object.prototype;var sr=function isPrototype(t){var o=t&&t.constructor;return t===("function"==typeof o&&o.prototype||or)};var ar=function initCloneObject(t){return"function"!=typeof t.constructor||sr(t)?{}:rr(nr(t))};var cr=function baseIsArguments(t){return R(t)&&"[object Arguments]"==O(t)},dr=Object.prototype,lr=dr.hasOwnProperty,pr=dr.propertyIsEnumerable,ur=cr(function(){return arguments}())?cr:function(t){return R(t)&&lr.call(t,"callee")&&!pr.call(t,"callee")};var mr=function isLength(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991};var hr=function isArrayLike(t){return null!=t&&mr(t.length)&&!w(t)};var gr=function isArrayLikeObject(t){return R(t)&&hr(t)};var _r=function stubFalse(){return!1},vr=createCommonjsModule((function(t,o){var a=o&&!o.nodeType&&o,c=a&&t&&!t.nodeType&&t,m=c&&c.exports===a?g.Buffer:void 0,h=(m?m.isBuffer:void 0)||_r;t.exports=h})),Ir=Function.prototype,Er=Object.prototype,fr=Ir.toString,Tr=Er.hasOwnProperty,Mr=fr.call(Object);var yr=function isPlainObject(t){if(!R(t)||"[object Object]"!=O(t))return!1;var o=nr(t);if(null===o)return!0;var a=Tr.call(o,"constructor")&&o.constructor;return"function"==typeof a&&a instanceof a&&fr.call(a)==Mr},Sr={};Sr["[object Float32Array]"]=Sr["[object Float64Array]"]=Sr["[object Int8Array]"]=Sr["[object Int16Array]"]=Sr["[object Int32Array]"]=Sr["[object Uint8Array]"]=Sr["[object Uint8ClampedArray]"]=Sr["[object Uint16Array]"]=Sr["[object Uint32Array]"]=!0,Sr["[object Arguments]"]=Sr["[object Array]"]=Sr["[object ArrayBuffer]"]=Sr["[object Boolean]"]=Sr["[object DataView]"]=Sr["[object Date]"]=Sr["[object Error]"]=Sr["[object Function]"]=Sr["[object Map]"]=Sr["[object Number]"]=Sr["[object Object]"]=Sr["[object RegExp]"]=Sr["[object Set]"]=Sr["[object String]"]=Sr["[object WeakMap]"]=!1;var Nr=function baseIsTypedArray(t){return R(t)&&mr(t.length)&&!!Sr[O(t)]};var Cr=function baseUnary(t){return function(o){return t(o)}},Ar=createCommonjsModule((function(t,o){var a=o&&!o.nodeType&&o,c=a&&t&&!t.nodeType&&t,h=c&&c.exports===a&&m.process,g=function(){try{var t=c&&c.require&&c.require("util").types;return t||h&&h.binding&&h.binding("util")}catch(t){}}();t.exports=g})),Or=Ar&&Ar.isTypedArray,Rr=Or?Cr(Or):Nr;var br=function safeGet(t,o){if(("constructor"!==o||"function"!=typeof t[o])&&"__proto__"!=o)return t[o]},Vr=Object.prototype.hasOwnProperty;var Pr=function assignValue(t,o,a){var c=t[o];Vr.call(t,o)&&ce(c,a)&&(void 0!==a||o in t)||zt(t,o,a)};var kr=function copyObject(t,o,a,c){var m=!a;a||(a={});for(var h=-1,g=o.length;++h<g;){var _=o[h],I=c?c(a[_],t[_],_,a,t):void 0;void 0===I&&(I=t[_]),m?zt(a,_,I):Pr(a,_,I)}return a};var Lr=function baseTimes(t,o){for(var a=-1,c=Array(t);++a<t;)c[a]=o(a);return c},Dr=/^(?:0|[1-9]\d*)$/;var wr=function isIndex(t,o){var a=typeof t;return!!(o=null==o?9007199254740991:o)&&("number"==a||"symbol"!=a&&Dr.test(t))&&t>-1&&t%1==0&&t<o},Ur=Object.prototype.hasOwnProperty;var xr=function arrayLikeKeys(t,o){var a=c(t),m=!a&&ur(t),h=!a&&!m&&vr(t),g=!a&&!m&&!h&&Rr(t),_=a||m||h||g,I=_?Lr(t.length,String):[],E=I.length;for(var T in t)!o&&!Ur.call(t,T)||_&&("length"==T||h&&("offset"==T||"parent"==T)||g&&("buffer"==T||"byteLength"==T||"byteOffset"==T)||wr(T,E))||I.push(T);return I};var Fr=function nativeKeysIn(t){var o=[];if(null!=t)for(var a in Object(t))o.push(a);return o},Gr=Object.prototype.hasOwnProperty;var Br=function baseKeysIn(t){if(!L(t))return Fr(t);var o=sr(t),a=[];for(var c in t)("constructor"!=c||!o&&Gr.call(t,c))&&a.push(c);return a};var jr=function keysIn(t){return hr(t)?xr(t,!0):Br(t)};var Yr=function toPlainObject(t){return kr(t,jr(t))};var Hr=function baseMergeDeep(t,o,a,m,h,g,_){var I=br(t,a),E=br(o,a),T=_.get(E);if(T)Kt(t,a,T);else{var M=g?g(I,E,a+"",t,o,_):void 0,S=void 0===M;if(S){var N=c(E),C=!N&&vr(E),A=!N&&!C&&Rr(E);M=E,N||C||A?c(I)?M=I:gr(I)?M=er(I):C?(S=!1,M=Jt(E,!0)):A?(S=!1,M=Zt(E,!0)):M=[]:yr(E)||ur(E)?(M=I,ur(I)?M=Yr(I):L(I)&&!w(I)||(M=ar(E))):S=!1}S&&(_.set(E,M),h(M,E,m,g,_),_.delete(E)),Kt(t,a,M)}};var $r=function baseMerge(t,o,a,c,m){t!==o&&Wt(o,(function(h,g){if(m||(m=new $t),L(h))Hr(t,o,g,a,baseMerge,c,m);else{var _=c?c(br(t,g),h,g+"",t,o,m):void 0;void 0===_&&(_=h),Kt(t,g,_)}}),jr)};var qr=function identity(t){return t};var zr=function apply(t,o,a){switch(a.length){case 0:return t.call(o);case 1:return t.call(o,a[0]);case 2:return t.call(o,a[0],a[1]);case 3:return t.call(o,a[0],a[1],a[2])}return t.apply(o,a)},Kr=Math.max;var Wr=function overRest(t,o,a){return o=Kr(void 0===o?t.length-1:o,0),function(){for(var c=arguments,m=-1,h=Kr(c.length-o,0),g=Array(h);++m<h;)g[m]=c[o+m];m=-1;for(var _=Array(o+1);++m<o;)_[m]=c[m];return _[o]=a(g),zr(t,this,_)}};var Jr=function constant(t){return function(){return t}},Xr=qt?function(t,o){return qt(t,"toString",{configurable:!0,enumerable:!1,value:Jr(o),writable:!0})}:qr,Qr=Date.now;var Zr=function shortOut(t){var o=0,a=0;return function(){var c=Qr(),m=16-(c-a);if(a=c,m>0){if(++o>=800)return arguments[0]}else o=0;return t.apply(void 0,arguments)}}(Xr);var ei=function baseRest(t,o){return Zr(Wr(t,o,qr),t+"")};var ti=function isIterateeCall(t,o,a){if(!L(a))return!1;var c=typeof o;return!!("number"==c?hr(a)&&wr(o,a.length):"string"==c&&o in a)&&ce(a[o],t)};var ri,ii,ni=function createAssigner(t){return ei((function(o,a){var c=-1,m=a.length,h=m>1?a[m-1]:void 0,g=m>2?a[2]:void 0;for(h=t.length>3&&"function"==typeof h?(m--,h):void 0,g&&ti(a[0],a[1],g)&&(h=m<3?void 0:h,m=1),o=Object(o);++c<m;){var _=a[c];_&&t(o,_,c,h)}return o}))},oi=ni((function(t,o,a){$r(t,o,a)}));!function(t){t[t.Unset=0]="Unset",t[t.RN=2]="RN",t[t.UNIAPP=3]="UNIAPP",t[t.Electron=5]="Electron",t[t.WeiXin=6]="WeiXin",t[t.BROWSER=100]="BROWSER",t[t.H5=101]="H5",t[t.Ali=102]="Ali",t[t.Baidu=103]="Baidu",t[t.Tiktok=104]="Tiktok"}(ri||(ri={})),function(t){t[t.kStatNetTypeUnkonw=0]="kStatNetTypeUnkonw",t[t.kStatNetTypeEthernet=1]="kStatNetTypeEthernet",t[t.kStatNetTypeWifi=2]="kStatNetTypeWifi",t[t.kStatNetType2G=3]="kStatNetType2G",t[t.kStatNetType3G=4]="kStatNetType3G",t[t.kStatNetType4G=5]="kStatNetType4G",t[t.kStatNetType5G=6]="kStatNetType5G"}(ii||(ii={}));var si={wifi:ii.kStatNetTypeWifi,"2g":ii.kStatNetType2G,"3g":ii.kStatNetType3G,"4g":ii.kStatNetType4G,"5g":ii.kStatNetType5G,ethernet:ii.kStatNetTypeEthernet,unknown:ii.kStatNetTypeUnkonw,none:ii.kStatNetTypeUnkonw,notreachable:ii.kStatNetTypeUnkonw,wwan:ii.kStatNetTypeUnkonw};function base64ToArrayBuffer(t){for(var o=function base64Decode(t){var o=String(t).replace(/[=]+$/,"");if(o.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var a,c=0,m=0,h=0,g="";a=o.charAt(h++);~a&&(m=c%4?64*m+a:a,c++%4)?g+=String.fromCharCode(255&m>>(-2*c&6)):0)a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a);return g}(t),a=o.length,c=new Uint8Array(a),m=0;m<a;m++)c[m]=o.charCodeAt(m);return c.buffer}function isMobile(){if(!navigator||!navigator.userAgent)return!1;return[/Android/i,/webOS/i,/iPhone/i,/iPad/i,/iPod/i,/BlackBerry/i,/Windows Phone/i].some((t=>navigator.userAgent.match(t)))}function isElectron(){return!(!navigator||!navigator.userAgent)&&("object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron")>=0)}function isBrowser(){return navigator&&navigator.userAgent}function getBrowserHostEnv(){return isElectron()?"Electron":isMobile()?"H5":isBrowser()?"BROWSER":"Unset"}function getBrowserHostEnvEnum(){return isElectron()?ri.Electron:isMobile()?ri.H5:isBrowser()?ri.BROWSER:ri.Unset}var ai={setLogger:function(t){throw new Error("Function not implemented.")},platform:"",WebSocket:class AdapterSocket{constructor(t,o){throw this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",new Error("Method not implemented.")}close(t,o){throw new Error("Method not implemented.")}send(t){throw new Error("Method not implemented.")}onclose(t){throw new Error("Method not implemented.")}onerror(t){throw new Error("Method not implemented.")}onmessage(t){throw new Error("Method not implemented.")}onopen(t){throw new Error("Method not implemented.")}},localStorage:{},request:function(t,o){throw new Error("Function not implemented.")},uploadFile:function(t){throw new Error("Function not implemented.")},getSystemInfo:function(){throw new Error("Function not implemented.")},getFileUploadInformation(t){throw new Error("Function not implemented.")},net:{__getEnv:()=>null,__onNetworkStatusChangeFn:null,getNetworkStatus(){var t=this.__getEnv();return new Promise(((o,a)=>{t.getNetworkType({success:function(t){var a=!1;a="boolean"==typeof t.networkAvailable?t.networkAvailable:"none"!==t.networkType.toLowerCase(),o({net_type:si[t.networkType.toLowerCase()],net_connect:a})},fail:function(){a(new Error("getNetworkType failed"))}})}))},onNetworkStatusChange(t){var o=this.__getEnv();this.offNetworkStatusChange(),o.onNetworkStatusChange&&(this.__onNetworkStatusChangeFn=function(o){var a=o.networkType.toLowerCase();t({isConnected:o.isConnected||"none"!==a,networkType:si[a]})},o.onNetworkStatusChange(this.__onNetworkStatusChangeFn))},offNetworkStatusChange(){var t=this.__getEnv();t.offNetworkStatusChange&&(this.__onNetworkStatusChangeFn&&t.offNetworkStatusChange(this.__onNetworkStatusChangeFn),this.__onNetworkStatusChangeFn=null)}}};function setAdapters(t){oi(ai,t())}class PromiseManager{constructor(){this.abortFns=[]}add(t){var o=function getPromiseWithAbort(t){var o={},a=new Promise((function(t,a){o.abort=a}));return o.promise=Promise.race([t,a]),o}(t);return this.abortFns.push(o.abort),o.promise}clear(t){this.abortFns.forEach((o=>o(t||new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"Aborted"}})))),this.abortFns=[]}destroy(){this.clear()}}var ci={tolerantRTT:3e3,bestRTT:100,maxChances:5,enable:!0},di={timestamp:0,rtt:0,baseClock:0,baseTime:0};class TimeOrigin{constructor(t,o,a="getServerTime"){this.serverOrigin=di,this.config=ci,this.isSettingNTP=!1,this.currentChance=0,this.failedDelay=2e3,this.successDelay=3e5,this.timer=0,this.cmdName="getServerTime",this.core=t,this.logger=t.logger,this.promiseManager=new PromiseManager,this.cmdName=a,o&&this.setOptions(o)}setOptions(t){this.config=Object.assign({},ci,this.config,t)}reset(){this.timer&&clearTimeout(this.timer),this.promiseManager.clear(),this.serverOrigin=di,this.currentChance=0}setOriginTimetick(){return __awaiter(this,void 0,void 0,(function*(){if(this.config.enable&&!(this.isSettingNTP||this.currentChance>=this.config.maxChances)){var t=Ue(this.core,"auth.status"),o=Ue(this.core,"status"),a=Ue(this.core,"V2NIMLoginService.lifeCycle.loginStatus");if("logined"===t||"logined"===o||a===We.V2NIM_LOGIN_STATUS_LOGINED){this.isSettingNTP=!0,this.currentChance++,this.timer&&clearTimeout(this.timer),this.timer=0;var c,m="TimeOrigin::setOriginTimetick:",h=Date.now();this.core.logger.log(`${m} getServerTime start, times ${this.currentChance}`);try{var g=yield this.promiseManager.add(this.core.sendCmd(this.cmdName));c=Ue(g,"content.time"),this.isSettingNTP=!1}catch(t){var _=t;return this.isSettingNTP=!1,this.logger.warn(`${m} Calculate Delay time, getServerTime error`,_),void(_.code!==wt.V2NIM_ERROR_CODE_CANCELLED&&(this.timer=setTimeout(this.setOriginTimetick.bind(this),this.failedDelay)))}if(!c)return this.core.logger.warn(`${m} Calculate Delay time incorrect format`),void(this.config.enable=!1);var I=Date.now()-h;this.doSet(c,I)}}}))}doSet(t,o){var a="TimeOrigin::setOriginTimetick:";o>this.config.tolerantRTT?(this.logger.warn(`${a} Denied, cause of exceeding the maximum tolerance range of RTT: ${o}`),this.timer=setTimeout(this.setOriginTimetick.bind(this),this.failedDelay)):o>this.config.bestRTT?(this.serverOrigin.rtt&&o>=this.serverOrigin.rtt?this.logger.log(`${a} Denied, cause of current.RTT >= serverOrigin.RTT: ${o}`):(this.setServerOrigin(o,t),this.logger.log(`${a} Accept within maximum tolerance range of RTT: ${o}, ntpTimestamp: ${this.serverOrigin.timestamp}, localClock: ${this.serverOrigin.baseClock}, localTime: ${this.serverOrigin.baseTime}`)),this.timer=setTimeout(this.setOriginTimetick.bind(this),this.failedDelay)):(this.setServerOrigin(o,t),this.logger.log(`${a} Accept within best RTT: ${o}, ntpTimestamp: ${this.serverOrigin.timestamp}, localClock: ${this.serverOrigin.baseClock}, localTime: ${this.serverOrigin.baseTime}`),this.currentChance=0,this.timer=setTimeout(this.setOriginTimetick.bind(this),this.successDelay))}getNTPTime(t){if(void 0===t&&(t=this.getTimeNode()),this.checkNodeReliable(t)){var o=Math.floor(t.time-this.serverOrigin.baseTime);return this.serverOrigin.timestamp+o}return Date.now()}checkNodeReliable(t){if(void 0===t&&(t=this.getTimeNode()),this.serverOrigin.timestamp){if(0===this.serverOrigin.baseClock)return!0;var o=t.clock-this.serverOrigin.baseClock,a=t.time-this.serverOrigin.baseTime;return Math.abs(a-o)<500}return!1}checkPerformance(){return"BROWSER"===ai.platform&&!("undefined"==typeof performance||!performance.now)}static checkPerformance(){return"BROWSER"===ai.platform&&!("undefined"==typeof performance||!performance.now)}getTimeNode(){return{clock:this.checkPerformance()?performance.now():0,time:Date.now()}}static getTimeNode(){return{clock:TimeOrigin.checkPerformance()?performance.now():0,time:Date.now()}}setServerOrigin(t,o){this.serverOrigin={timestamp:o+Math.floor(t/2),rtt:t,baseClock:this.checkPerformance()?performance.now():0,baseTime:Date.now()}}}var li={},pi={};function createCmd(t,o,a,c){var m=li[t];if(!m)return a.error("createCmd:: can not find cmd config: ",t),null;var h={SER:o,SID:m.sid,CID:m.cid,Q:[]};return m.params&&c&&m.params.forEach((function(t){var o=c[t.name];if(null!=o){var a=t.type,{reflectMapper:m,select:g}=t;switch(t.type){case"PropertyArray":a="ArrayMable",o=o.map((t=>({t:"Property",v:m?serialize(t,m,g):t})));break;case"Property":o=m?serialize(o,m,g):o;break;case"Bool":o=o?"true":"false"}h.Q.push({t:a,v:o})}})),{packet:h,hasPacketResponse:"boolean"!=typeof m.hasPacketResponse||m.hasPacketResponse,hasPacketTimer:"boolean"!=typeof m.hasPacketTimer||m.hasPacketTimer}}function parseCmd(t,o){var a;try{a=JSON.parse(t)}catch(a){return void o.error(`Parse command error:"${t}"`)}var c=a.sid+"_"+a.cid,m=a.r;if(["4_1","4_2","4_10","4_11"].includes(c)){var h=a.r[1].headerPacket;c=`${h.sid}_${h.cid}`,a.sid=h.sid,a.cid=h.cid,m=a.r[1].body}var g=pi[c],_=[];if(g){for(var I of g)_.push(parseEachCmd(a,I.config,I.cmd,m,o));return _}o.error("parseCmd:: mapper not exist",c,a.code)}function parseEachCmd(t,o,a,c,m){var h,g={cmd:a,raw:t,error:null,service:null==o?void 0:o.service,content:{},__receiveTimeNode:TimeOrigin.getTimeNode()};if(!a||!o)return g.notFound=!0,g;(18===o.sid||o.sid>=26&&o.sid<100)&&(t.code=function toReadableCode(t){if("number"!=typeof t||t!=t)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"Read code failed",rawData:`${t}`}});if(t<0||t>=0&&t<1e3||t>=2e4&&t<=20099)return t;var o=(65535&t)>>9;o-=o<=38?1:2;return 1e5+1e3*o+(511&t)}(t.code));var _=function genCmdError(t,o){var a=Ut[t],c=Ft[t];return null===c?null:new V2NIMErrorImpl({code:t,desc:a||c||t,detail:{cmd:o,timetag:Date.now()}})}(t.code,a);if(g.error=_,g.error){if(g.error.detail.cmd=a,!(null===(h=null==o?void 0:o.ignoreErrCodes)||void 0===h?void 0:h.includes(t.code)))return g;m.warn("parseCmd:: ignore error ",g.error),g.error.detail.ignore=!0}return o.response&&o.response.forEach(((t,o)=>{var a=c[o],m=t.type,h=t.name,_=t.reflectMapper;if(!kt(a))switch(m){case"Property":g.content[h]=_?deserialize(a,_):a;break;case"PropertyArray":g.content[h]=a.map((t=>_?deserialize(t,_):t));break;case"Int":case"Long":case"Byte":g.content[h]=+a;break;case"Bool":g.content[h]="true"===a||!0===a||1===a;break;default:g.content[h]=a}})),g}function serialize(t,o,a){var c={};for(var m in t=function flattenObjByMapper(t,o){var a={};for(var c in o){var m=o[c],h="number"==typeof m?c:m.access?m.access:c,g=h.split("."),_=t;for(var I of g){if(void 0===_[I]||null===_[I]){_=void 0;break}_=_[I]}void 0!==_&&(a[h]=_)}return a}(t,o),o){var h=o[m],g="number"==typeof h?m:h.access?h.access:m;if(!a||a.includes(m))if(g in t){if("number"==typeof h)c[h]=t[g];else if("object"==typeof h)if(h.converter){var _=h.converter(t[g],t);void 0!==_&&(c[h.id]=_)}else c[h.id]=t[g]}else"object"==typeof h&&h.def&&("function"==typeof h.def?c[h.id]=h.def(t):c[h.id]=h.def)}return c}function deserialize(t,o){var a={};for(var c in t){var m=o[c];if("string"==typeof m)a[m]=t[c];else if("object"==typeof m&&"prop"in m){var h=m.access?m.access:m.prop;if(m.converter){var g=m.converter(t[c],t);void 0!==g&&(a[h]=g)}else m.type&&"number"===m.type?a[h]=+t[c]:m.type&&"boolean"===m.type?a[h]=!("0"===t[c]||!t[c]):a[h]=t[c]}}for(var _ in o){var I=o[_];if(I&&void 0!==I.def){var E=I.access?I.access:I.prop;E in a||("function"==typeof I.def?a[E]=I.def(t):a[E]=I.def)}}return a=function unflattenObj(t){var o={},_loop=function(a){var c=a.split(".");c.reduce((function(o,m,h){return o[m]||(o[m]=isNaN(Number(c[h+1]))?c.length-1==h?t[a]:{}:[])}),o)};for(var a in t)_loop(a);return o}(a),a}function registerParser(t){for(var o in Object.assign(li,t.cmdConfig),t.cmdMap){var a=t.cmdMap[o],c=t.cmdConfig[a];if(c)if(Array.isArray(pi[o])){var m=!1;for(var h of pi[o])if(h.cmd===a&&h.config.service===c.service){m=!0;break}m||pi[o].push({config:c,cmd:a})}else pi[o]=[{config:c,cmd:a}]}}function invertSerializeMap(t){var o={};return Object.keys(t).forEach((a=>{o[a]=invertSerializeItem(t[a])})),o}function invertSerializeItem(t){var o={};for(var a in t){var c=t[a];"number"==typeof c?o[c]=a:"object"==typeof c&&(o[c.id]={prop:a,type:c.retType,access:c.retAccess?c.retAccess:c.access?c.access:a,def:c.retDef,converter:c.retConverter})}return o}function boolToInt(t){return t?1:0}function objectToJSONString(t){if(t&&"object"==typeof t)try{return JSON.stringify(t)}catch(t){return}}function stringToJSONObject(t){if(t&&"string"==typeof t)try{return JSON.parse(t)}catch(t){return}}var ui,mi,hi,gi,_i,vi={"1_2":"heartbeat","2_3":"login","2_5":"kicked","2_6":"logout","2_7":"nimLoginClientChange","2_8":"kick"},Ii={login:{clientType:3,os:4,sdkVersion:6,appLogin:8,protocolVersion:9,pushTokenName:10,pushToken:11,deviceId:13,appkey:18,account:19,browser:24,clientSession:26,deviceInfo:32,isReactNative:112,token:1e3,customTag:38,customClientType:39,sdkHumanVersion:40,hostEnv:41,userAgent:42,libEnv:44,authType:115,loginExt:116},loginRes:{lastLoginDeviceId:17,customTag:38,connectionId:102,ip:103,port:104,country:106,hasXMPush:111},loginPort:{type:3,os:4,mac:5,deviceId:13,account:19,deviceInfo:32,customTag:38,customClientType:39,connectionId:102,ip:103,port:104,time:109,pushType:110,hasTokenPreviously:111},aosPushInfo:{pushType:110,hasTokenPreviously:111}},Ei=invertSerializeMap(Ii),fi={login:{sid:2,cid:3,service:"auth",params:[{type:"Property",name:"login",reflectMapper:Ii.login}],response:[{type:"Property",name:"loginRes",reflectMapper:Ei.loginRes},{type:"PropertyArray",name:"loginPorts",reflectMapper:Ei.loginPort},{type:"Property",name:"aosPushInfo",reflectMapper:Ei.aosPushInfo}]},logout:{sid:2,cid:6,service:"auth"},heartbeat:{sid:1,cid:2,service:"auth"},kicked:{sid:2,cid:5,service:"auth",response:[{type:"Int",name:"clientType"},{type:"Int",name:"reason"},{type:"String",name:"ext"},{type:"Int",name:"customClientType"}]},nimLoginClientChange:{sid:2,cid:7,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:Ei.loginPort}]},kick:{sid:2,cid:8,service:"auth",params:[{type:"StrArray",name:"deviceIds"}],response:[{type:"StrArray",name:"deviceIds"}]}};!function(t){t[t.text=0]="text",t[t.image=1]="image",t[t.audio=2]="audio",t[t.video=3]="video",t[t.geo=4]="geo",t[t.notification=5]="notification",t[t.file=6]="file",t[t.tip=10]="tip",t[t.robot=11]="robot",t[t.g2=12]="g2",t[t.custom=100]="custom"}(ui||(ui={})),function(t){t[t.p2p=0]="p2p",t[t.team=1]="team",t[t.superTeam=5]="superTeam"}(mi||(mi={})),function(t){t[t.Android=1]="Android",t[t.iOS=2]="iOS",t[t.PC=4]="PC",t[t.WindowsPhone=8]="WindowsPhone",t[t.Web=16]="Web",t[t.Server=32]="Server",t[t.Mac=64]="Mac",t[t.HarmonyOS=65]="HarmonyOS"}(hi||(hi={})),function(t){t[t.unread=1]="unread",t[t.read=2]="read",t[t.deleted=3]="deleted",t[t.sending=4]="sending",t[t.sendFailed=5]="sendFailed",t[t.sent=6]="sent",t[t.receipt=7]="receipt",t[t.refused=10]="refused"}(gi||(gi={})),function(t){t[t.default=0]="default",t[t.leave=1]="leave",t[t.roam=2]="roam"}(_i||(_i={}));var Ti=ir(Object.keys,Object),Mi=Object.prototype.hasOwnProperty;var yi=function baseKeys(t){if(!sr(t))return Ti(t);var o=[];for(var a in Object(t))Mi.call(t,a)&&"constructor"!=a&&o.push(a);return o};var Si,Ni=function keys(t){return hr(t)?xr(t):yi(t)},Ci=ni((function(t,o,a,c){kr(o,Ni(o),t,c)})),Ai=(Si=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},function(){return Si()+Si()+Si()+Si()+Si()+Si()+Si()+Si()});function getEnumValues(t){return Object.keys(t).filter((t=>+t>=0)).map((t=>parseInt(t)))}function getEnumKeyByEnumValue(t,o){var a=Object.keys(t).filter((a=>t[a]==o));return a.length>0?a[0]:void 0}function getMiniappEnv(){return"undefined"!=typeof tt&&tt.getSystemInfo?"TT":"undefined"!=typeof swan&&swan.getSystemInfo?"BAIDU":"undefined"!=typeof my&&my.getSystemInfo?"ALI":"undefined"!=typeof wx&&wx.getSystemInfo?"WX":"unknow environment"}function assignOptions(t,o){return Ci({},t,o,(function(t,o){return kt(o)?t:o}))}function emptyFuncWithPromise(){return Promise.resolve()}function emptyFunc$1(){}function getFileExtension(t){var o=t.lastIndexOf(".");return o>-1?t.slice(o):""}function findIndexWithinTargetValue(t,o,a){return 0===t.length||t[0][o]<=a?0:t[t.length-1][o]>a?t.length:t.findIndex(((c,m)=>{if(t[m-1]&&t[m-1][o]>a&&a>=c[o])return!0}))}function format(t,o){if(!yr(o))return{};var a=JSON.parse(JSON.stringify(o)),c=doFormat(t,a);return JSON.parse(JSON.stringify(Object.assign(Object.assign({},a),c)))}function doFormat(t,o){if(!yr(o))return{};var a={};return Object.keys(t).forEach((c=>{var m=t[c].type;if("string"!=typeof m){var h=doFormat(t[c],o);Object.keys(h).length>0&&(a[c]=h)}else{var g=t[c],_=g.rawKey||c,I=Oi[m](o,_,g);void 0!==I&&(o[_]=void 0,a[c]=I)}})),a}var Oi={number:function(t,o){if(void 0!==t[o])return+t[o]},string:function(t,o){if(void 0!==t[o])return t[o]},boolean:function(t,o){return+t[o]>0||0!=+t[o]&&void 0},enum:function(t,o,a){return a.values[t[o]]},object:function(t,o){if(void 0!==t[o])try{return JSON.parse(t[o])}catch(t){return{}}}};function formatReverse(t,o){if(!yr(o))return{};var a=JSON.parse(JSON.stringify(o)),c=doFormatReverse(t,a);return JSON.parse(JSON.stringify(Object.assign(Object.assign({},a),c)))}function doFormatReverse(t,o){if(!yr(o))return Object.keys(t).reduce(((o,a)=>(o[t[a].rawKey||a]=void 0,o)),{});var a={};return Object.keys(t).forEach((c=>{var m=t[c].type;if("string"!=typeof m){var h=doFormatReverse(t[c],o[c]);return Object.assign(a,h),void(o[c]=void 0)}var g=t[c],_=g.rawKey||c,I=Ri[m](o,c,g);o[_]=void 0,a[_]=I})),a}var Ri={number:function(t,o){return t[o]},string:function(t,o){return t[o]},boolean:function(t,o){return!0===t[o]?1:!1===t[o]?0:void 0},enum:function(t,o,a){return a.values[t[o]]},object:function(t,o){if(void 0!==t[o])try{return JSON.stringify(t[o])}catch(t){return""}}};function formatMultiPortLoginInfo(t,o){return t&&t.length>0?t.map((t=>Object.assign(Object.assign({},t),{account:t.account,connectionId:t.connectionId,deviceId:t.deviceId,ip:t.ip,mac:t.mac,os:t.os,type:getEnumKeyByEnumValue(hi,t.type)||t.type,time:parseInt(t.time),online:3!==o}))):[]}var bi={1:{reason:"samePlatformKick",message:"The same account is not allowed to multiple login at the same time"},2:{reason:"serverKick",message:"Kicked out by IM server"},3:{reason:"otherPlatformKick",message:"Kicked out by other client of your account"},4:{reason:"silentlyKick",message:"Quietly kicked"}};var Vi=Backoff;function Backoff(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}Backoff.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var o=Math.random(),a=Math.floor(o*this.jitter*t);t=0==(1&Math.floor(10*o))?t-a:t+a}return 0|Math.min(t,this.max)},Backoff.prototype.reset=function(){this.attempts=0},Backoff.prototype.setMin=function(t){this.ms=t},Backoff.prototype.setMax=function(t){this.max=t},Backoff.prototype.setJitter=function(t){this.jitter=t};var Pi=function setCacheAdd(t){return this.__data__.set(t,"__lodash_hash_undefined__"),this};var ki=function setCacheHas(t){return this.__data__.has(t)};function SetCache(t){var o=-1,a=null==t?0:t.length;for(this.__data__=new Se;++o<a;)this.add(t[o])}SetCache.prototype.add=SetCache.prototype.push=Pi,SetCache.prototype.has=ki;var Li=SetCache;var Di=function baseFindIndex(t,o,a,c){for(var m=t.length,h=a+(c?1:-1);c?h--:++h<m;)if(o(t[h],h,t))return h;return-1};var wi=function baseIsNaN(t){return t!=t};var Ui=function strictIndexOf(t,o,a){for(var c=a-1,m=t.length;++c<m;)if(t[c]===o)return c;return-1};var xi=function baseIndexOf(t,o,a){return o==o?Ui(t,o,a):Di(t,wi,a)};var Fi=function arrayIncludes(t,o){return!!(null==t?0:t.length)&&xi(t,o,0)>-1};var Gi=function arrayIncludesWith(t,o,a){for(var c=-1,m=null==t?0:t.length;++c<m;)if(a(o,t[c]))return!0;return!1};var Bi=function cacheHas(t,o){return t.has(o)},ji=X(g,"Set");var Yi=function noop(){};var Hi=function setToArray(t){var o=-1,a=Array(t.size);return t.forEach((function(t){a[++o]=t})),a},$i=ji&&1/Hi(new ji([,-0]))[1]==1/0?function(t){return new ji(t)}:Yi;var qi=function baseUniq(t,o,a){var c=-1,m=Fi,h=t.length,g=!0,_=[],I=_;if(a)g=!1,m=Gi;else if(h>=200){var E=o?null:$i(t);if(E)return Hi(E);g=!1,m=Bi,I=new Li}else I=o?[]:_;e:for(;++c<h;){var T=t[c],M=o?o(T):T;if(T=a||0!==T?T:0,g&&M==M){for(var S=I.length;S--;)if(I[S]===M)continue e;o&&I.push(M),_.push(T)}else m(I,M,a)||(I!==_&&I.push(M),_.push(T))}return _};var zi=function uniq(t){return t&&t.length?qi(t):[]},Ki=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],Wi=["transport not supported","client not handshaken","unauthorized"],Ji=["reconnect"];class BaseWebsocket$1 extends o{constructor(t,o){super(),this.url=o,this.websocket=null,this.socketConnectTimer=0,this.core=t,this.url=o,this.status="disconnected",this.logger=t.logger,this.connect()}connect(){"connecting"!==this.status&&"connected"!==this.status?(this.status="connecting",this.core.adapters.request("https://"+this.url+"/socket.io/1/?t="+Date.now(),{method:"GET",dataType:"text",timeout:this.core.options.xhrConnectTimeout||8e3},{exception_service:6}).then((t=>{if("connecting"===this.status){var[o,a]=t.data.split(":");return this.sessionId=o,this.logger.log(`imsocket::XHR success. status ${this.status}, ${"connecting"===this.status?"continue websocket connection":"stop websocket connection"}`),this._createWebsocket("wss://"+this.url+"/socket.io/1/websocket/"+o)}})).catch((t=>{if("connecting"===this.status){var o=`imsocket::XHR fail. raw message: "${(t=t||{}).message}", code: "${t.code}"`,a=t.code;a="v2"===Ue(this.core,"options.apiVersion")?t.code===wt.V2NIM_ERROR_CODE_CONNECT_TIMEOUT?wt.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:wt.V2NIM_ERROR_CODE_CONNECT_FAILED:408===t.code?408:415;var c=new V2NIMErrorImpl({code:a,detail:{reason:o,rawError:t}});this.logger.error(o),this.status="disconnected",this.emit("handshakeFailed",c)}}))):this.logger.warn("imsocket::socket is connecting or connected",this.status)}close(){if(this.status="disconnected",this.websocket){this.logger.log("imsocket:: close websocket");try{this.websocket.send(this.encodePacket({type:"disconnect"}))}catch(t){this.logger.warn("imsocket::attempt to send encodePacket error",t)}try{this.websocket.close()}catch(t){this.logger.warn("imsocket::attempt to close websocket error",t)}this.clean(),this.emit("disconnect",{code:0,reason:"Active close websocket"})}}clean(){this.status="disconnected",this.websocket&&(this.socketUrl=void 0,this.websocket.onmessage=null,this.websocket.onopen=null,this.websocket.onerror=null,this.websocket.onclose=null,this.websocket=null)}onConnect(){this.status="connected",this.emit("connect"),clearTimeout(this.socketConnectTimer)}_createWebsocket(t){this.socketConnectTimer=setTimeout((()=>{this.logger.error("imsocket::Websocket connect timeout. url: ",this.socketUrl),this.emit("handshakeFailed",new V2NIMErrorImpl({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:415,detail:{reason:`imsocket::Websocket connect timeout. url: ${this.socketUrl}`}}))}),this.core.options.socketConnectTimeout||8e3),this.socketUrl=t,this.websocket=new ai.WebSocket(t),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onclose=t=>{var o=(null==t?void 0:t.reason)||(null==t?void 0:t.message)||(null==t?void 0:t.errMsg)||"websocket.onclose";this.logger.log(`imsocket::Websocket onclose done. code is ${null==t?void 0:t.code} and reason is ${o}`),this.clean(),this.emit("disconnect",{code:(null==t?void 0:t.code)||0,reason:o})},this.websocket.onerror=t=>{this.logger.error("imsocket::Websocket onerror",t),"logined"===this.core.status&&this.core.clientSocket.ping()}}onMessage(t){var o,a=this.decodePacket(t.data);if(a)switch(a.type){case"connect":this.onConnect();break;case"disconnect":this.close(),this.emit("disconnect",{code:0,reason:"MessageEvent type disconnect"});break;case"message":case"json":this.emit("message",a.data);break;case"event":a.name&&this.emit(a.name,a.args);break;case"error":"unauthorized"===a.reason?this.emit("connect_failed",a.reason):this.emit("error",a.reason),this.logger.error("imsocket::Websocket connect failed, onmessage type error. url: ",this.socketUrl),clearTimeout(this.socketConnectTimer),this.emit("handshakeFailed",new V2NIMErrorImpl({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_CONNECT_FAILED:408,detail:{reason:`imsocket::Websocket connect failed, onMessage socket error. url: ${this.socketUrl}`}}));break;case"heartbeat":null===(o=this.websocket)||void 0===o||o.send(this.encodePacket({type:"heartbeat"}));break;default:this.logger.warn("imsocket::Websocket no handler type",a.type)}}encodePacket(t){var o,a,{type:c,id:m="",endpoint:h="",ack:g}=t,_=null;if(!c)return"";switch(c){case"error":o=t.reason?Wi.indexOf(t.reason):"",a=t.advice?Ji.indexOf(t.advice):"",""===o&&""===a||(_=o+(""!==a?"+"+a:""));break;case"message":""!==t.data&&(_=t.data);break;case"event":o={name:t.name},o=t.args&&t.args.length?{name:t.name,args:t.args}:{name:t.name},_=JSON.stringify(o);break;case"json":_=JSON.stringify(t.data);break;case"connect":t.qs&&(_=t.qs);break;case"ack":_=t.ackId+(t.args&&t.args.length?"+"+JSON.stringify(t.args):"")}var I=[Ki.indexOf(c),m+("data"===g?"+":""),h];return null!=_&&I.push(_),I.join(":")}decodePacket(t){if(t)if("ï¿½"!=t.charAt(0)){var o=t.match(/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/);if(o){var a,[,c,m,h,g,_]=o,I={type:Ki[+c],endpoint:g};switch(m&&(I.id=m,I.ack=!h||"data"),I.type){case"error":a=_.split("+"),I.reason=Wi[+a[0]]||"";break;case"message":I.data=_||"";break;case"connect":I.qs=_||"";break;case"event":try{var E=JSON.parse(_);I.name=E.name,I.args=E.args}catch(t){this.logger.error("imsocket::parseData::type::event error",t)}I.args=I.args||[];break;case"json":try{I.data=JSON.parse(_)}catch(t){this.logger.error("imsocket::parseData::type::json error",t)}break;case"ack":if((a=_.match(/^([0-9]+)(\+)?(.*)/))&&(I.ackId=a[1],I.args=[],a[3]))try{I.args=a[3]?JSON.parse(a[3]):[]}catch(t){this.logger.error("imsocket::parseData::type::ack error",t)}}return I}}else this.logger.error("imsocket::unrecognize dataStr",t.slice(0,20))}send(t){var o,a={data:t,type:"message",endpoint:""};null===(o=this.websocket)||void 0===o||o.send(this.encodePacket(a))}}var Xi=function baseIsRegExp(t){return R(t)&&"[object RegExp]"==O(t)},Qi=Ar&&Ar.isRegExp,Zi=Qi?Cr(Qi):Xi;var en=function baseDifference(t,o,a,c){var m=-1,h=Fi,g=!0,_=t.length,I=[],E=o.length;if(!_)return I;a&&(o=Re(o,Cr(a))),c?(h=Gi,g=!1):o.length>=200&&(h=Bi,g=!1,o=new Li(o));e:for(;++m<_;){var T=t[m],M=null==a?T:a(T);if(T=c||0!==T?T:0,g&&M==M){for(var S=E;S--;)if(o[S]===M)continue e;I.push(T)}else h(o,M,c)||I.push(T)}return I},tn=ei((function(t,o){return gr(t)?en(t,o):[]}));function replacer(t,o){return o instanceof RegExp?"__REGEXP "+o.toString():o}function validate(t,o={},a,c=!1){var m={};return Object.keys(t).forEach((h=>{var g=t[h].type,_=a?`In ${a}, `:"";if(null==o){var I=`${_}param is null or undefined`;throw c?new ValidateErrorV2({detail:{reason:I,data:{key:h},rules:"required"}}):new ValidateError(I,{key:h},"required")}if(void 0===o[h]){if(!1===t[h].required)return void(m[h]=o[h]);var E=`${_}param '${h}' is required`;throw c?new ValidateErrorV2({detail:{reason:E,data:{key:h},rules:"required"}}):new ValidateError(E,{key:h},"required")}var T=rn[g];if(T&&!T(o,h,t[h],c)){var M=`${_}param '${h}' unexpected`,S={key:h,value:o[h]};throw c?new ValidateErrorV2({detail:{reason:M,data:S,rules:JSON.stringify(t[h],replacer)}}):new ValidateError(M,S,JSON.stringify(t[h],replacer))}m[h]=o[h]})),m}var rn={string:function(t,o,a){var{allowEmpty:c,max:m,min:h,regExp:g}=a,_=t[o];return"string"==typeof _&&((!1!==c||""!==_)&&(!("number"==typeof m&&_.length>m)&&(!("number"==typeof h&&_.length<h)&&!(Zi(g)&&!g.test(_)))))},number:function(t,o,a){var{min:c,max:m}=a,h=t[o];return"number"==typeof h&&(!("number"==typeof c&&h<c)&&!("number"==typeof m&&h>m))},boolean:function(t,o){return"boolean"==typeof t[o]},file:function(t,o){return!0},enum:function(t,o,a){var{values:c}=a,m=t[o];return!c||c.indexOf(m)>-1},jsonstr:function(t,o){try{var a=JSON.parse(t[o]);return"object"==typeof a&&null!==a}catch(t){return!1}},func:function(t,o){return"function"==typeof t[o]},array:function(t,o,a,c=!1){var{itemType:m,rules:h,min:g,max:_,values:I}=a,E=t[o];return!!Array.isArray(E)&&(!("number"==typeof _&&E.length>_)&&(!("number"==typeof g&&E.length<g)&&(!(m&&"enum"!==m&&!E.every((t=>typeof t===m)))&&(("enum"!==m||!I||!tn(E,...I).length)&&(h&&E.forEach(((t,a)=>validate(h,t,`${o}[${a}]`,c))),!0)))))},object:function(t,o,a,c=!1){var{rules:m,allowEmpty:h}=a,g=t[o];if("object"!=typeof g||null===g)return!1;if(m){var _=Object.keys(m),I=Object.keys(g).filter((t=>_.indexOf(t)>-1));if(!1===h&&0===I.length)return!1;validate(m,g,o,c)}return!0}};function validateConversationId(t,o){if(!t)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE});validate({conversationId:{type:"string",allowEmpty:!1,regExp:new RegExp(`^${t}\\|[1-3]\\|`)}},{conversationId:o},"",!0)}var nn,sn=["https://lbs.netease.im/lbs/webconf.jsp"],an="https://abt-online.netease.im/v1/api/abt/client/getExperimentInfo";!function(t){t[t.ACTIVE=1]="ACTIVE",t[t.KICKED=2]="KICKED",t[t.OFFLINE=3]="OFFLINE"}(nn||(nn={}));class V1ClientSocket{constructor(t,o){this.linkUrls=[],this.isAutoReconnect=!1,this.packetTimeout=3e4,this.packetSer=1,this.retryCount=0,this.reconnectTimer=0,this.backoff=new Vi({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new Map,this.pingTimer=0,this.hasNetworkListener=!1,this.core=t,o&&(this.auth=o),this.logger=t.logger,this.reporter=t.reporter,this.timerManager=t.timerManager}setSessionId(t){}connect(t={},o){return __awaiter(this,void 0,void 0,(function*(){if(validate({linkUrls:{type:"array",itemType:"string",required:!1}},t),!/^(unconnected|waitReconnect)$/.test(this.core.status)){var a=`Core socket status is ${this.core.status}, and would not connect`;return this.logger.warn(a),Promise.reject(a)}this.core.status="connecting",t.linkUrls&&t.linkUrls.length>0&&(this.linkUrls=t.linkUrls.concat(this.linkUrls),this.linkUrls=zi(this.linkUrls)),0===this.linkUrls.length&&this.linkUrls.push("weblink.netease.im:443");for(var c=0;c<this.linkUrls.length;c++){var m=this.linkUrls[c],h=(new Date).getTime();try{return yield this.doConnect(m),this.core.status="connected",this.logger.log(`clientsocketV1::connect success with url: ${m}`),m}catch(t){var g=t;o&&o(g,m),this.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,start_time:h,action:0,exception_service:6}),this.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof g.code?g.code:0,description:g.message||`${g.code}`,operation_type:0,target:m},{asyncParams:ai.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1),this.logger.warn(`clientsocketV1::connect failed with url: ${m}`,t)}}throw 0===this.retryCount?this.doDisconnect(nn.ACTIVE,"SocketHandshakeFailed"):this.doDisconnect(nn.OFFLINE,"ReconnectHadRetryAllLinks"),new Error("clientSocketV1::socket xhr or socket connect failed")}))}doConnect(t){var o=!1;return new Promise(((a,c)=>{this.socket=new BaseWebsocket$1(this.core,t),this.socket.on("connect",(()=>{this.logger.log("clientSocketV1::on connect",t),this.core.reporterHookLinkKeep&&(this.core.reporterHookLinkKeep.start(),this.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:t})),o=!0,a()})),this.socket.on("message",this.onMessage.bind(this)),this.socket.on("disconnect",(a=>__awaiter(this,void 0,void 0,(function*(){this.logger.log("clientSocketV1::socket on disconnect",a),this.core.reporterHookLinkKeep&&(yield this.core.reporterHookLinkKeep.update({code:(null==a?void 0:a.code)||0,description:(null==a?void 0:a.reason)||"socket on disconnect",operation_type:1,target:t}),this.core.reporterHookLinkKeep.end(!1)),o=!0,this.doDisconnect(nn.OFFLINE,"SocketOnDisconnect")})))),this.socket.on("handshakeFailed",(t=>{o?this.ping():(this.logger.error(`clientsocketV1::handshake failed: "${t&&t.message}"`),this.cleanSocket()),o=!0,c(t)}))}))}cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)}beforeConnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer)}resetConnectStatus(){clearTimeout(this.reconnectTimer),this.backoff.reset(),this.retryCount=0,this.initOnlineListener()}doDisconnect(t,o,a){var c,m,h,g,_;if(this.logger.log(`doDisconnect: type ${t}, description ${o}`),"unconnected"!==this.core.status){var I={1:"close",2:"kicked",3:"broken"}[t]||"";this.markAllCmdInvaild(new V2NIMErrorImpl({code:415,desc:"Packet timeout due to instance disconnect",detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:I}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket();var E=!this.core.options.needReconnect||this.retryCount>=this.core.options.reconnectionAttempts;if(t===nn.ACTIVE||E)this.logger.log("doDisconnect: emit disconnect, type "+t,E),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(c=this.auth)||void 0===c||c.emit("disconnect"),this.destroyOnlineListener();else if(t===nn.KICKED){this.logger.log("doDisconnect: kicked"),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer);var T="string"==typeof o?{reason:"unknow",message:o}:o;this.core.eventBus.emit("kicked",T),this.core.emit("kicked",T),null===(m=this.auth)||void 0===m||m.emit("kicked",T),this.destroyOnlineListener()}else t===nn.OFFLINE&&this.core.V1NIMLoginService.isManualLoginAttempt?(this.logger.log("doDisconnect: offline in manual login phase. no reconnect"),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.destroyOnlineListener()):t===nn.OFFLINE&&(null===(g=null===(h=this.auth)||void 0===h?void 0:h.authenticator)||void 0===g?void 0:g.checkLoginTerminalCode(null==a?void 0:a.code))?(this.logger.log(`doDisconnect: login terminal code ${null==a?void 0:a.code}, no reconnect`),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.destroyOnlineListener(),this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(_=this.auth)||void 0===_||_.emit("disconnect")):t===nn.OFFLINE?(this.logger.log("doDisconnect: start to reconnect"),this.attempToReconnect()):this.logger.log("doDisconnect: nothing to do")}else this.logger.warn("doDisconnect: already unconnected")}attempToReconnect(){var t,o;if("waitReconnect"!==this.core.status){0===this.retryCount&&(this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(t=this.auth)||void 0===t||t.emit("disconnect"));var a=this.backoff.duration();this.retryCount++,this.logger.log(`willReconnect ${this.retryCount} ${a}`),this.core.eventBus.emit("willReconnect",{retryCount:this.retryCount,duration:a}),this.core.emit("willReconnect",{retryCount:this.retryCount,duration:a}),null===(o=this.auth)||void 0===o||o.emit("willReconnect",{retryCount:this.retryCount,duration:a}),this.core.status="waitReconnect",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){"waitReconnect"===this.core.status?!1===(yield ai.net.getNetworkStatus()).net_connect?(this.logger.log("doDisconnect: skip this reconnection attempt because network is offline"),this.core.status="connecting",this.retryCount>=this.core.options.reconnectionAttempts?this.doDisconnect(nn.OFFLINE,"MaxReconnectionAttemptExceed"):this.attempToReconnect()):this.core.V1NIMLoginService.login({isAutoReconnect:!0}).catch((()=>{this.logger.error(`clientsocketV1::attempToReconnect failed ${this.retryCount}`)})):this.logger.warn(`doDisconnect: reconnectTimer status is ${this.core.status}, would not go on reconnecting`)}))),a)}else this.logger.warn("doDisconnect: already is waiting reconnect")}sendCmd(t,o,a){if("logined"!==this.core.status&&"login"!==t&&"chatroomLogin"!==t&&"qchatLogin"!==t)return this.logger.warn(`instance status is ${this.core.status}, so can not sendCmd ${t}`),Promise.reject({cmd:t,error:{code:"No_connected",message:"Connection not established",timetag:(new Date).getTime()}});if(!this.socket||!this.socket.send)return Promise.reject("No_socket");var c="heartbeat"!==t,m=c?this.packetSer++:0,h=createCmd(t,m,this.logger,o);if(!h){var g=`SendCmd ${m} ${t} error`;return this.logger.error(g),Promise.reject(new Error(g))}var{packet:_,hasPacketResponse:I,hasPacketTimer:E}=h,T=JSON.stringify(_);c&&("debug"===this.core.options.debugLevel?this.logger.debug("clientsocketV1::sendCmd",t,`ser:${m}`,T):this.logger.log("clientsocketV1::sendCmd",t,`ser:${m}`));var M=(new Date).getTime();return new Promise(((c,h)=>{I&&this.sendingCmdMap.set(m,{cmd:t,params:o,callback:[c,h],timer:E?setTimeout((()=>{var o=new V2NIMErrorImpl({code:408,desc:"Packet Timeout",detail:{reason:"Packet Timeout",cmd:t,ser:m,timetag:Date.now()}});this.markCmdInvalid(m,o,t)}),a&&a.timeout?a.timeout:this.core.config.timeout):null});try{this.socket.send(T),I||c(_)}catch(o){var g=new V2NIMErrorImpl({code:415,detail:{reason:o&&o.message||"Unable to send packet",cmd:t,ser:m,timetag:Date.now(),rawError:o}});this.markCmdInvalid(m,g,t),h(o)}})).catch((t=>{var o;if(![408,415].includes(t.code))return Promise.reject(t);this.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,trace_id:null===(o=this.socket)||void 0===o?void 0:o.sessionId,start_time:M,action:2,exception_service:6});var a=Ue(t,"data.disconnect_reason")||"",c=408===t.code?"Send failed due to timeout":"Send failed. Reason unknown";return c=415===t.code?JSON.stringify({disconnect_reason:a}):c,this.reporter.reportTraceUpdateV2("exceptions",{code:t.code||415,description:c,operation_type:1,target:`${_.SID}-${_.CID}`,context:`${_.SER}`},{asyncParams:ai.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1),Promise.reject(t)}))}onMessage(t){var o=parseCmd(t,this.logger);if(o)for(var a of o){var c=a.raw.ser;if(a.error&&this.logger.error("core:onMessage packet error",`${a.raw.sid}_${a.raw.cid}, ser:${c},`,a.error),a.notFound)return void this.logger.warn("clientsocketV1::onMessage packet not found",`${a.raw.sid}_${a.raw.cid}, ser:${c}`);"heartbeat"!==a.cmd&&("debug"===this.core.options.debugLevel?this.logger.debug(`imsocket::recvCmd ser:${c}`,a.cmd,a.content):this.logger.log(`imsocket::recvCmd ser:${c}`,a.cmd)),this.packetHandler(a)}}packetHandler(t){var o,a;if(t){var c=t.raw.ser,m=this.sendingCmdMap.get(c);if(m&&m.cmd===t.cmd){var{callback:h,timer:g,params:_}=m;if(clearTimeout(g),t.params=_,this.sendingCmdMap.delete(c),"heartbeat"===t.cmd)return void h[0]();var I=null===(o=this.core[t.service])||void 0===o?void 0:o.process(t);I&&"function"==typeof I.then?I.then((t=>{h[0](t)})).catch((t=>{h[1](t)})):(this.logger.log("imsocket:: handlerFn without promise",t.service,t.cmd),h[0]())}else null===(a=this.core[t.service])||void 0===a||a.process(t)}}markCmdInvalid(t,o,a){var c=this.sendingCmdMap.get(t);if(c){var{callback:m,timer:h}=c;h&&clearTimeout(h),this.sendingCmdMap.delete(t),this.logger.warn(`packet ${t}, ${a} is invalid:`,o),m[1](o)}}markAllCmdInvaild(t){this.logger.log("markAllCmdInvaild",t),this.sendingCmdMap.forEach((o=>{var{callback:a,timer:c,cmd:m}=o;this.logger.debug(`markAllCmdInvaild:: cmd "${m}"`),c&&clearTimeout(c),a[1](t)})),this.sendingCmdMap.clear()}ping(){var t;return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);try{yield this.sendCmd("heartbeat")}catch(o){if(yield this.testHeartBeat5Timeout())return this.core.reporterHookLinkKeep&&(yield this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(t=this.socket)||void 0===t?void 0:t.url}),this.core.reporterHookLinkKeep.end(!0)),void this.doDisconnect(nn.OFFLINE,"PingError")}this.pingTimer=setTimeout((()=>{this.ping()}),3e4)}))}testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);for(var t=0;t<5;t++)try{return yield this.sendCmd("heartbeat",{},{timeout:3e3}),!1}catch(o){this.logger.debug(`clientsocketV1:: test heartbeat ${t} Timeout`)}return!0}))}initOnlineListener(){this.hasNetworkListener||(this.logger.log("clientsocketV1::onlineListener:init"),this.hasNetworkListener=!0,ai.net.onNetworkStatusChange((t=>{this.logger.log("clientsocketV1::onlineListener:network change",t),t.isConnected&&"logined"===this.core.status?this.ping():t.isConnected&&"waitReconnect"===this.core.status?(this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.core.V1NIMLoginService.login({isAutoReconnect:!0}).catch((()=>{this.logger.error(`clientsocketV1::attempToReconnect failed ${this.retryCount}`)}))):t.isConnected||this.doDisconnect(nn.OFFLINE,"OfflineListener")})))}destroyOnlineListener(){this.logger.log("clientsocketV1::onlineListener:destroy"),ai.net.offNetworkStatusChange(),this.hasNetworkListener=!1}disconnect(){switch(this.core.status){case"connected":case"logined":case"connecting":case"waitReconnect":return this.doDisconnect(nn.ACTIVE,"UserActiveDisconnect"),Promise.resolve();default:return Promise.resolve()}}}class V1NIMLoginLbs{constructor(t){this.socketLinkUrls=[],this.timer=0,this.failedCount=0,this.core=t,this.auth=t.V1NIMLoginService,this.logger=this.core.logger}getLbsInfos(){return __awaiter(this,void 0,void 0,(function*(){if(this.socketLinkUrls.length>0){var t=this.socketLinkUrls;return this.socketLinkUrls=[],this.core.logger.log("V1NIMLoginService::getLbsInfos:use cache link",t),Promise.resolve(t)}this.core.reporterHookLBS.start(this.core.account);var o=zi(this.auth.config.lbsUrls);try{var a=yield this.ladderLoad(o);if(200!==a.status||!a.data)throw this.core.logger.error("V1NIMLoginService::getLbsInfos:error status",a.status,a),new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:`V1NIMLoginService::getLbsInfos failed, status ${a.status}`}});this.success(a)}catch(t){var c=t;if(this.core.logger.error(`V1NIMLoginService::lbs getLbsInfos error, use default link: ${this.auth.config.linkUrl}. error:`,t),this.reportForFail(o[0],c.code,c.message),this.checkTerminator(c.code))throw t;this.socketLinkUrls=[this.auth.config.linkUrl]}return this.socketLinkUrls}))}checkTerminator(t){return t===wt.V2NIM_ERROR_CODE_CANCELLED||t===wt.V2NIM_ERROR_CODE_TIMEOUT}generateUrl(t){var o=t.indexOf("?")>-1?"&":"?";return t+o+"k="+this.core.options.appkey+"&id="+this.core.auth.getLoginUser()+"&sv=180&pv=1&networkType=0&lv=1"}requstLbs(t){return this.auth.doLoginStepsManager.add(this.core.adapters.request(this.generateUrl(t),{method:"GET",dataType:"json",timeout:8e3}))}setLadderTimer(t,o,a,c){this.timer&&clearTimeout(this.timer);var m=t[o];this.timer=setTimeout((()=>{m&&(this.setLadderTimer(t,o+1,a,c),this.core.logger.log(`V1NIMLoginService::getLbsInfos ${o}:`,m),this.reportForLbsStart(m,o),this.requstLbs(m).then((t=>{this.reset(),a(Object.assign(Object.assign({},t),{url:m}))})).catch((a=>{var h;if(this.core.logger.warn(`V1NIMLoginService::getLbsInfos ${o} failed:`,a),this.failedCount+=1,this.reportForFailOnce(m,a.code,(null===(h=a.detail)||void 0===h?void 0:h.reason)||a.message),this.failedCount>=t.length||this.checkTerminator(a.code))return this.reset(),void c(a)})))}),2e3)}ladderLoad(t){return new Promise(((o,a)=>{t.length>1&&this.setLadderTimer(t,1,o,a);var c=t[0];this.core.logger.log("V1NIMLoginService::getLbsInfos 0:",c),this.reportForLbsStart(c,0),this.requstLbs(c).then((t=>{this.reset(),o(Object.assign(Object.assign({},t),{url:c}))})).catch((o=>{var m;this.failedCount+=1,this.core.logger.warn("V1NIMLoginService::getLbsInfos 0 failed:",o),this.reportForFailOnce(c,o.code,(null===(m=o.detail)||void 0===m?void 0:m.reason)||o.message),(this.failedCount>=t.length||this.checkTerminator(o.code))&&(this.reset(),a(o))}))}))}success(t){var o,a,c=t.data,m=[this.auth.config.linkUrl];Ue(c,"common.link")&&(m=Ue(c,"common.link").concat(m)),Ue(c,'common["link.default"]')&&(m=m.concat(Ue(c,'common["link.default"]'))),this.socketLinkUrls=zi(m),c["nos-chunk"]&&(this.logger.log("getLbsInfos success. lbs.nos-chunk",c["nos-chunk"]),null===(o=this.core.cloudStorage)||void 0===o||o.setOptions({chunkUploadHost:c["nos-chunk"]})),Array.isArray(c.nosup)&&c.nosup.length>0&&(this.logger.log("getLbsInfos success. lbs.nosup",c.nosup),null===(a=this.core.cloudStorage)||void 0===a||a.setOptions({commonUploadHostBackupList:c.nosup,commonUploadHost:c.nosup[0]})),this.core.logger.log("V1NIMLoginService::getLbsInfos success, socket link:",this.socketLinkUrls.slice(0),"chunkUploadHost: ",t.data["nos-chunk"]),this.reportForLbsSuccess(t.url,t.data)}reportForLbsStart(t,o){this.core.reporterHookLBS.updateBegin({target:t,index:o})}reportForLbsSuccess(t,o){this.core.reporterHookLBS.updateComplete({target:t,code:200,body:JSON.stringify(o)}),this.core.reporterHookLBS.end(!0),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:t,code:200,succeed:!0},{asyncParams:ai.net.getNetworkStatus()})}reportForFailOnce(t,o,a){this.core.reporterHookLBS.updateComplete({target:t,code:o,body:a})}reportForFail(t,o,a){this.core.reporterHookLBS.end(!1),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:t,description:a,code:o,succeed:!1},{asyncParams:ai.net.getNetworkStatus()})}reset(){this.socketLinkUrls=[],this.failedCount=0,clearTimeout(this.timer)}}class V1NIMLoginAuthenticator{constructor(t){this.core=t}verifyAuthentication(t=!1){var o,a,c;return __awaiter(this,void 0,void 0,(function*(){var m=this.core.options,h=ai.getSystemInfo(),g=Object.assign(Object.assign({},m),{appLogin:t?0:1,appkey:m.appkey,account:m.account,token:m.token,deviceId:this.core.auth.deviceId,clientSession:this.core.auth.clientSession,clientType:16,protocolVersion:1,sdkVersion:100400,sdkHumanVersion:"10.4.0",os:h.os,browser:h.browser,userAgent:this.core.options.loginSDKTypeParamCompat?"Native/10.4.0":h.userAgent.slice(0,299),libEnv:this.core.options.loginSDKTypeParamCompat?void 0:h.libEnv,hostEnv:this.core.options.loginSDKTypeParamCompat?0:h.hostEnvEnum}),_=h.os.toLowerCase();if("UNIAPP"===ai.platform&&("ios"===_||"android"===_)){g.isReactNative=1,g.clientType="ios"===_?2:1;var I=!!(null===(o=this.core.offlinePush.authConfig)||void 0===o?void 0:o.honorCertificateName);h.pushDeviceInfo&&h.pushDeviceInfo.MANUFACTURER&&(g.deviceInfo=JSON.stringify(Object.assign({IS_SUPPORT_HONOR:I},h.pushDeviceInfo)))}this.core.logger.log("clientSocketV1::do login ",m.account,null===(c=null===(a=this.core.clientSocket)||void 0===a?void 0:a.socket)||void 0===c?void 0:c.sessionId);var E=yield this.core.clientSocket.sendCmd("login",{login:g});if(E.error)throw E.error;var{loginRes:T,loginPorts:M,aosPushInfo:S}=E.content,N=formatMultiPortLoginInfo(M,2);return(N=N.filter((t=>t.connectionId!==T.connectionId))).length>0&&this.core.emit("multiPortLogin",N),Object.assign(Object.assign({},T),{aosPushInfo:S})}))}checkLoginTerminalCode(t){if(void 0===t)return!1;return[201,302,317,403,404,417,422].includes(t)}}class V2Service extends o{constructor(t,o){super(),this.name=t,this.logger=o.logger,this.core=o}checkV2(){var t=this.core.options.apiVersion;if("v2"===t)return!0;throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:`The version "${t}" of client is not supported.`}})}checkLogin(){if(this.core.V2NIMLoginService.getLoginStatus()!==We.V2NIM_LOGIN_STATUS_LOGINED)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:"The client is not logged in."}})}emit(t,...o){try{return this.logger.debug(`${this.name}::emit event: "${t.toString()}",`,void 0!==o[0]?o[0]:"",void 0!==o[1]?o[1]:"",void 0!==o[2]?o[2]:""),super.emit(t,...o)}catch(o){return setTimeout((()=>{throw this.logger.error(`${this.name}::emit throw error in setTimeout. event: ${t.toString()}. Error`,o),o}),0),!1}}process(t){var o=this[t.cmd+"Handler"];if("function"==typeof o){if(t.error)return this.logger.error(`${t.cmd}::recvError`,t.error),Promise.reject(t.error);try{var a=o.call(this,t);return Promise.resolve(a)}catch(t){return Promise.reject(t)}}var c=Ue(t,"error.detail.ignore");return t.error&&!c?Promise.reject(t.error):Promise.resolve(t)}}var cn={needReconnect:!0,reconnectionAttempts:Number.MAX_SAFE_INTEGER,lbsUrls:sn,linkUrl:"weblink.netease.im:443",xhrConnectTimeout:8e3,socketConnectTimeout:8e3};class V1NIMLoginServiceImpl extends V2Service{constructor(t,o){super("V1NIMLoginService",t),this.account="",this.token="",this.deviceId="",this.processId="",this.clientSession="",this.status="unconnected",this.config=cn,this.isManualLoginAttempt=!1,registerParser({cmdMap:vi,cmdConfig:fi}),t.V1NIMLoginService=this,o&&this.setOptions(o);var a=new V1ClientSocket(this.core,this);this.clientSocket=a,"v1"===this.core.options.apiVersion&&(this.core.clientSocket=a,this.core.auth=this),this.lbs=new V1NIMLoginLbs(t),this.authenticator=new V1NIMLoginAuthenticator(t),this.doLoginStepsManager=new PromiseManager}reset(){this.lbs.reset()}setOptions(t){t&&Object.keys(t).length>0?(this.config=assignOptions(this.config,t),this.account=t.account||this.core.options.account,this.token=t.token||this.core.options.token,this.core.options=Object.assign(Object.assign({},this.core.options),this.config)):(this.config=assignOptions(this.core.options,this.config),this.account=this.core.options.account,this.token=this.core.options.token);var o="",a="";this.config.isFixedDeviceId?(o=ai.localStorage.getItem("__NIM_DEVC_ID__")||Ai(),a=ai.localStorage.getItem("__NIM_CLIENT_SESSION_ID__")||Ai(),ai.localStorage.setItem("__NIM_DEVC_ID__",o),ai.localStorage.setItem("__NIM_CLIENT_SESSION_ID__",a)):(o=Ai(),a=Ai()),this.deviceId=o,this.clientSession=a,this.core.reporter.setConfig({common:{dev_id:o}})}connect(t={}){return this.login(t)}login(t={}){return __awaiter(this,void 0,void 0,(function*(){this._checkApiVersion(),t.isAutoReconnect||(this.isManualLoginAttempt=!0,this.processId=Ai()),yield this._connect(t),this.core.abtest.abtRequest();try{yield this.doLogin(t.isAutoReconnect),this.processId=Ai(),this.isManualLoginAttempt=!1}catch(t){throw this.isManualLoginAttempt=!1,t}}))}_connect(t={}){return __awaiter(this,void 0,void 0,(function*(){if(!/^(unconnected|waitReconnect)$/.test(this.core.status)){var o=`NIM status is ${this.core.status}, and would not connect`;return this.logger.warn(o),Promise.reject(o)}this.clientSocket.beforeConnect(),this.core.reporter.reportTraceCancel("login"),this.core.reporter.reportTraceStart("login",{user_id:this.core.options.account,action:t.isAutoReconnect?"auto_login":"manual_login",binary_websocket:!1,process_id:this.processId}),this.core.reporter.reportTraceUpdateV2("login",{code:0,description:JSON.stringify(Object.assign(Object.assign({},this.core.options),{account:"***",token:"***"})),operation_type:"conf_init",succeed:!0,duration:0,target:""},{asyncParams:ai.net.getNetworkStatus()});var a=yield this.lbs.getLbsInfos();try{var c=yield this.clientSocket.connect({linkUrls:a,isAutoReconnect:t.isAutoReconnect},((t,o)=>{this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:o,code:t.code||408,description:`ws_handshake_failed:${t.message}`,succeed:!1},{asyncParams:ai.net.getNetworkStatus()})}));c&&this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:c,code:200,succeed:!0},{asyncParams:ai.net.getNetworkStatus()})}catch(t){throw this.core.reporter.reportTraceEnd("login",!1),t}}))}doLogin(t=!1){return __awaiter(this,void 0,void 0,(function*(){var o;try{o=yield this.authenticator.verifyAuthentication(t),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"2-3",code:200,succeed:!0},{asyncParams:ai.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("login",!0),this.core.status="logined"}catch(t){var a=t,c=Ue(a,"data.disconnect_reason")||"",m=415===a.code?JSON.stringify({disconnect_reason:c}):a.message;if(this.core.logger.warn("nim login:: login failed",t),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"2-3",code:a.code||0,succeed:!1,description:m},{asyncParams:ai.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("login",!1),this.clientSocket.doDisconnect(nn.OFFLINE,this.isManualLoginAttempt?"FailedToInitializeLogin":"ReconnectLoginFailed",t),this.isManualLoginAttempt)throw t;return}try{yield this.core.cloudStorage.init()}catch(t){this.core.logger.error("NIM:login cloudStorage init failed ",t)}this.core.eventBus.emit("logined",o),this.core.emit("logined",o),this.emit("logined",o),this.core.logger.log("login done"),this.clientSocket.resetConnectStatus(),this.clientSocket.ping()}))}disconnect(){return this.logout()}logout(){return __awaiter(this,void 0,void 0,(function*(){switch(this._checkApiVersion(),this.doLoginStepsManager.clear(),this.status){case"logined":try{yield this.clientSocket.sendCmd("logout",void 0,{timeout:1e3}),this.clientSocket.doDisconnect(nn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData()}catch(t){this.logger.error("Instance::disconnect sendCmd:logout error",t),this.clientSocket.doDisconnect(nn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData()}break;case"connected":case"connecting":case"waitReconnect":return this.clientSocket.doDisconnect(nn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),Promise.resolve();case"unconnected":case"destroyed":return Promise.resolve()}}))}kick(t){var o;return __awaiter(this,void 0,void 0,(function*(){this._checkApiVersion();var a=yield this.clientSocket.sendCmd("kick",t);return null===(o=a.content)||void 0===o?void 0:o.deviceIds}))}_checkApiVersion(){if("v1"!==this.core.options.apiVersion)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:'apiVersion is not "v1"'}})}nimLoginClientChangeHandler(t){if(t.error)this.logger.error("nimLoginClientChangeHandler:: error, ",t.error);else{var{datas:o,state:a}=t.content,c=formatMultiPortLoginInfo(o,a);c.length>0&&(this.core.emit("multiPortLogin",c),this.emit("multiPortLogin",c))}}kickedHandler(t){if(t.error)this.logger.error("kickedHandler:: error, ",t.error);else{var o=function formatBeKickedTag$1(t){var o=format({clientType:{type:"enum",values:hi},customClientType:{type:"number"}},t),a=bi[o.reason];return a=a||{reason:"unknow",message:"Unknown reason"},Object.assign(o,a)}(t.content);this.logger.warn("kicked::",o),this.clientSocket.doDisconnect(nn.KICKED,o),this.core._clearModuleData()}}getConnectStatus(){switch(this.core.status){case"unconnected":case"destroyed":default:return 0;case"connecting":return 2;case"connected":case"logined":return 1;case"waitReconnect":return 3}}getLoginStatus(){switch(this.core.status){case"unconnected":case"destroyed":case"waitReconnect":default:return 0;case"connecting":case"connected":return 2;case"logined":return 1}}getLoginUser(){return this.core.options.account}}function formatLoginInfo(t){return format({type:{type:"number"},port:{type:"number"},customClientType:{type:"number"},timetag:{type:"number"},loginType:{type:"number"}},t)}class TimerManager{constructor(){this.timerList=[],this.id=1,this.timer=null,this.timeout=0}addTimer(t,o=0,a=1){var c=(new Date).getTime(),m=this.id;return this.timerList.push({id:m,loop:a,count:0,timeout:c+o,interval:o,callback:t}),this.id++,this.checkTimer(c),m}checkTimer(t=(new Date).getTime()){if(this.removeFinished(),0!==this.timerList.length||null==this.timer){var o=0;for(var a of this.timerList)(0===o||o>a.timeout)&&(o=a.timeout);0!==this.timerList.length&&(null===this.timer||o<this.timeout||this.timeout<t)&&(this.timer=setTimeout(this.nowTime.bind(this),o-t),this.timeout=o)}}nowTime(){var t=(new Date).getTime();for(var o of this.timerList)t>=o.timeout&&(o.callback(),o.count++,o.timeout=t+o.interval);this.clerTime(),this.checkTimer(t)}clerTime(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)}deleteTimer(t){for(var o=this.timerList.length-1;o>=0;o--){this.timerList[o].id===t&&this.timerList.splice(o,1)}}removeFinished(){for(var t=this.timerList.length-1;t>=0;t--){var o=this.timerList[t];o.loop>=0&&o.count>=o.loop&&this.timerList.splice(t,1)}}destroy(){this.clerTime(),this.timerList=[],this.id=1,this.timer=null}}var dn=function baseForOwn(t,o){return t&&Wt(t,o,Ni)};var ln=function baseInverter(t,o,a,c){return dn(t,(function(t,m,h){o(c,a(t),m,h)})),c};var pn=function createInverter(t,o){return function(a,c){return ln(a,t,o(c),{})}},un=Object.prototype.toString,mn=pn((function(t,o,a){null!=o&&"function"!=typeof o.toString&&(o=un.call(o)),t[o]=a}),Jr(qr)),hn={"26_3":"v2Login","26_5":"v2Logout","26_8":"v2KickOffline","26_9":"v2BeKicked","26_10":"v2LoginClientChange","36_1":"v2GetChatroomLinkAddress"},gn={"1_2":"heartbeat","2_7":"nimLoginClientChange","24_8":"qchatLoginClientChange"},_n={webLoginReqTag:{clientType:3,os:4,sdkVersion:6,appLogin:8,protocolVersion:9,pushTokenName:10,pushToken:11,clientId:13,appkey:18,account:19,browser:24,clientSession:26,deviceInfo:32,isReactNative:112,customTag:38,customClientType:39,sdkHumanVersion:40,hostEnv:41,userAgent:42,libEnv:44,authType:115,thirdPartyExtension:116,token:1e3},mixAuthRepTag:{clientId:1,consid:2,ip:3,port:4,type:5,customClientType:6,timetag:7,customTag:8,os:9,pushType:10,hasTokenPreviously:11,loginType:12},nimAuthRepTag:{type:3,os:4,mac:5,clientId:13,account:19,deviceInfo:32,customTag:38,customClientType:39,consid:102,ip:103,port:104,timetag:109,pushType:110,hasTokenPreviously:111},qchatAuthRepTag:{clientId:8,consid:102,ip:103,port:104,type:6,customClientType:13,timetag:105,os:30,pushType:100,hasTokenPreviously:101}},vn={v2Login:{sid:26,cid:3,service:"auth",params:[{type:"Property",name:"tag",reflectMapper:_n.webLoginReqTag}],response:[{type:"Property",name:"data",reflectMapper:mn(_n.mixAuthRepTag)},{type:"PropertyArray",name:"loginClients",reflectMapper:mn(_n.mixAuthRepTag)}]},v2Logout:{sid:26,cid:5,service:"auth"},v2KickOffline:{sid:26,cid:8,service:"auth",params:[{type:"StrArray",name:"clientIds"}],response:[{type:"StrArray",name:"clientIds"}]},v2BeKicked:{sid:26,cid:9,service:"auth",response:[{type:"Int",name:"clientType"},{type:"Int",name:"reason"},{type:"String",name:"reasonDesc"},{type:"Int",name:"customClientType"}]},v2LoginClientChange:{sid:26,cid:10,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:mn(_n.mixAuthRepTag)}]},v2GetChatroomLinkAddress:{sid:36,cid:1,service:"auth",params:[{type:"Long",name:"roomId"},{type:"Bool",name:"miniProgram"}],response:[{type:"StrArray",name:"linkAddress"}]}},In={heartbeat:{sid:1,cid:2,service:"auth"},nimLoginClientChange:{sid:2,cid:7,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:mn(_n.nimAuthRepTag)}]},qchatLoginClientChange:{sid:24,cid:8,service:"auth",response:[{type:"Byte",name:"state"},{type:"Property",name:"data",reflectMapper:mn(_n.qchatAuthRepTag)}]}},abs=function(t){var o;if(void 0!==t)return(o=BigNumber(t)).sign=1,o},isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},isValidType=function(t){return["number"==typeof t,"string"==typeof t&&t.length>0,isArray(t)&&t.length>0,t instanceof BigNumber].some((function(t){return!0===t}))},En="Invalid Number",fn="Invalid Number - Division By Zero";function BigNumber(t){var o;if(!(this instanceof BigNumber))return new BigNumber(t);if(this.number=[],this.sign=1,this.rest=0,isValidType(t)){if(isArray(t)){for((t.length&&"-"===t[0]||"+"===t[0])&&(this.sign="+"===t[0]?1:-1,t.shift(0)),o=t.length-1;o>=0;o--)if(!this.addDigit(t[o]))return}else for("-"!==(t=t.toString()).charAt(0)&&"+"!==t.charAt(0)||(this.sign="+"===t.charAt(0)?1:-1,t=t.substring(1)),o=t.length-1;o>=0;o--)if(!this.addDigit(parseInt(t.charAt(o),10)))return}else this.number=En}BigNumber.prototype.addDigit=function(t){return function(t){return/^\d$/.test(t)}(t)?(this.number.push(t),this):(this.number=En,!1)},BigNumber.prototype._compare=function(t){var o,a;if(!isValidType(t))return null;if(o=BigNumber(t),this.sign!==o.sign)return this.sign;if(this.number.length>o.number.length)return this.sign;if(this.number.length<o.number.length)return-1*this.sign;for(a=this.number.length-1;a>=0;a--){if(this.number[a]>o.number[a])return this.sign;if(this.number[a]<o.number[a])return-1*this.sign}return 0},BigNumber.prototype.gt=function(t){return this._compare(t)>0},BigNumber.prototype.gte=function(t){return this._compare(t)>=0},BigNumber.prototype.equals=function(t){return 0===this._compare(t)},BigNumber.prototype.lte=function(t){return this._compare(t)<=0},BigNumber.prototype.lt=function(t){return this._compare(t)<0},BigNumber.prototype.subtract=function(t){var o;return void 0===t?this:(o=BigNumber(t),this.sign!==o.sign?(this.number=BigNumber._add(this,o),this):(this.sign=this.lt(o)?-1:1,this.number=abs(this).lt(abs(o))?BigNumber._subtract(o,this):BigNumber._subtract(this,o),this))},BigNumber._add=function(t,o){var a,c=0,m=Math.max(t.number.length,o.number.length);for(a=0;a<m||c>0;a++)t.number[a]=(c+=(t.number[a]||0)+(o.number[a]||0))%10,c=Math.floor(c/10);return t.number},BigNumber._subtract=function(t,o){var a,c=0,m=t.number.length;for(a=0;a<m;a++)t.number[a]-=(o.number[a]||0)+c,t.number[a]+=10*(c=t.number[a]<0?1:0);for(a=0,m=t.number.length-1;0===t.number[m-a]&&m-a>0;)a++;return a>0&&t.number.splice(-a),t.number},BigNumber.prototype.multiply=function(t){if(void 0===t)return this;var o,a,c=BigNumber(t),m=0,h=[];if(this.isZero()||c.isZero())return BigNumber(0);for(this.sign*=c.sign,o=0;o<this.number.length;o++)for(m=0,a=0;a<c.number.length||m>0;a++)h[o+a]=(m+=(h[o+a]||0)+this.number[o]*(c.number[a]||0))%10,m=Math.floor(m/10);return this.number=h,this},BigNumber.prototype.divide=function(t){if(void 0===t)return this;var o,a,c=BigNumber(t),m=[],h=BigNumber(0);if(c.isZero())return this.number=fn,this;if(this.isZero())return this.rest=BigNumber(0),this;if(this.sign*=c.sign,c.sign=1,1===c.number.length&&1===c.number[0])return this.rest=BigNumber(0),this;for(o=this.number.length-1;o>=0;o--)for(h.multiply(10),h.number[0]=this.number[o],m[o]=0;c.lte(h);)m[o]++,h.subtract(c);for(o=0,a=m.length-1;0===m[a-o]&&a-o>0;)o++;return o>0&&m.splice(-o),this.rest=h,this.number=m,this},BigNumber.prototype.mod=function(t){return this.divide(t).rest},BigNumber.prototype.isZero=function(){var t;for(t=0;t<this.number.length;t++)if(0!==this.number[t])return!1;return!0},BigNumber.prototype.toString=function(){var t,o="";if("string"==typeof this.number)return this.number;for(t=this.number.length-1;t>=0;t--)o+=this.number[t];return this.sign>0?o:"-"+o};var Tn,Mn,yn=Math.pow(2,32);function varintToBytes(t){var o=new Uint8Array(4),a=new DataView(o.buffer),c=0;do{var m=127&t;(t>>>=7)>0&&(m|=128),a.setUint8(c++,m)}while(t>0);return o.slice(0,c)}function decodeText(t){return"function"==typeof TextDecoder?new TextDecoder("utf-8").decode(t):function textDecoder(t){for(var o="",a=0;a<t.length;){var c=t[a],m=0,h=0;if(c<=127?(m=0,h=255&c):c<=223?(m=1,h=31&c):c<=239?(m=2,h=15&c):c<=244&&(m=3,h=7&c),t.length-a-m>0)for(var g=0;g<m;)h=h<<6|63&(c=t[a+g+1]),g+=1;else h=65533,m=t.length-a;o+=String.fromCodePoint(h),a+=m+1}return o}(t)}class Unpack{constructor(t){this.offset=0,this.buffer=new Uint8Array(t),this.view=new DataView(t)}checkBufferBoundaryAccess(){return this.offset>=this.buffer.byteLength}length(){var t;return(null===(t=this.view)||void 0===t?void 0:t.byteLength)||0}getBuffer(){return this.view.buffer}popRaw(t){try{var o=this.buffer.slice(this.offset,this.offset+t);return this.offset+=t,o}catch(t){throw new Error("UnpackException raw")}}popByte(){try{var t=this.view.getUint8(this.offset);return this.offset+=1,t}catch(t){throw new Error("UnpackException byte")}}popVarbin(){return this.popRaw(this.popVarInt())}popString(){try{return decodeText(this.popVarbin())}catch(t){throw new Error("UnpackException string")}}popInt(){try{var t=this.view.getUint32(this.offset,!0);return this.offset+=4,t}catch(t){throw new Error("UnpackException int")}}popVarInt(){var t=1,o=0,a=0;do{o+=(127&(a=this.popByte()))*t,t*=128}while(0!=(128&a));return o}popLong(){try{var t=function getBigUint64(t,o=!1){var a=new DataView(t.buffer),[c,m]=o?[4,0]:[0,4],h=a.getUint32(c,o),g=a.getUint32(m,o);return h>0?h*yn+g:g}(this.buffer.slice(this.offset,this.offset+8),!0);return this.offset+=8,Number(t)}catch(t){throw new Error("UnpackException long")}}popShort(){try{var t=this.view.getUint16(this.offset,!0);return this.offset+=2,t}catch(t){throw new Error("UnpackException short")}}popBoolean(){return this.popByte()>0}toString(){return Array.from(new Uint8Array(this.buffer)).toString()}reset(){this.offset=0,this.buffer=null,this.view=null}}class PacketDecoder{constructor(t){this.packetLength=0,this.serviceId=0,this.commandId=0,this.serialId=0,this.tag=0,this.resCode=200,this.innerHeader=null,this.msgId=0,this.unpack=new Unpack(t)}reset(){this.innerHeader=null,this.unpack.reset()}unmarshalHeader(){var t=this._unmarshalHeader();this.packetLength=t.packetLength,this.serviceId=t.serviceId,this.commandId=t.commandId,this.serialId=t.serialId,this.tag=t.tag,this.resCode=t.resCode,4===t.serviceId&&[1,2,10,11].includes(t.commandId)&&(this.msgId=this.unmarshalLong(),this.innerHeader=this._unmarshalHeader())}_unmarshalHeader(){var t=this.unpack.popVarInt(),o=this.unpack.popByte(),a=this.unpack.popByte(),c=this.unpack.popShort(),m=this.unpack.popByte(),h=200;return this.hasRescode(m)&&(h=this.unpack.popShort()),{packetLength:t,serviceId:o,commandId:a,serialId:c,tag:m,resCode:h}}hasRescode(t){return 0!=((t=t||this.tag)&PacketDecoder.RES_CODE)}getHeader(){return{packetLength:this.packetLength,sid:this.serviceId,cid:this.commandId,ser:this.serialId,code:this.resCode}}getInnerHeader(){return this.innerHeader?{sid:this.innerHeader.serviceId,cid:this.innerHeader.commandId}:null}unmarshalProperty(){for(var t=this.unpack.popVarInt(),o={},a=0;a<t;a++){var c=this.unpack.popVarInt(),m=this.unpack.popString();o[c]=m}return o}unmarshalPropertyArray(){for(var t=this.unpack.popVarInt(),o=[],a=0;a<t;a++)o.push(this.unmarshalProperty());return o}unmarshalLong(){return this.unpack.popLong()}unmarshalLongArray(){for(var t=this.unpack.popVarInt(),o=[],a=0;a<t;a++)o.push(this.unpack.popLong());return o}unmarshalStrArray(){for(var t=this.unpack.popVarInt(),o=[],a=0;a<t;a++)o.push(this.unpack.popString());return o}unmarshalStrLongMap(){for(var t=this.unpack.popVarInt(),o={},a=0;a<t;a++){var c=this.unpack.popString(),m=this.unpack.popLong();o[c]=m}return o}unmarshalStrStrMap(){for(var t=this.unpack.popVarInt(),o={},a=0;a<t;a++){var c=this.unpack.popString(),m=this.unpack.popString();o[c]=m}return o}unmarshalLongLongMap(){for(var t=this.unpack.popVarInt(),o={},a=0;a<t;a++){var c=this.unpack.popLong(),m=this.unpack.popLong();o[c]=m}return{m_map:o}}unmarshalKVArray(){for(var t=this.unpack.popVarInt(),o=[],a=0;a<t;a++)o.push(this.unmarshalStrStrMap());return o}unmarshal(t){var o=Object.assign(Object.assign({},this.getHeader()),{r:[]});if(this.innerHeader&&(o.r[0]=this.msgId,o.r[1]={body:[],headerPacket:this.getInnerHeader()}),![200,406,808,810,7101].includes(o.code))return JSON.stringify(o);var a=[];return t&&t.forEach((t=>{if(!this.unpack.checkBufferBoundaryAccess())switch(t.type){case"PropertyArray":a.push(this.unmarshalPropertyArray());break;case"Property":a.push(this.unmarshalProperty());break;case"Byte":a.push(this.unpack.popByte());break;case"Int":a.push(this.unpack.popInt());break;case"Bool":a.push(this.unpack.popBoolean());break;case"Long":a.push(this.unmarshalLong());break;case"LongArray":a.push(this.unmarshalLongArray());break;case"String":a.push(this.unpack.popString());break;case"StrArray":a.push(this.unmarshalStrArray());break;case"StrStrMap":a.push(this.unmarshalStrStrMap());break;case"StrLongMap":a.push(this.unmarshalStrLongMap());break;case"LongLongMap":a.push(this.unmarshalLongLongMap());break;case"KVArray":a.push(this.unmarshalKVArray())}})),this.innerHeader?o.r[1].body=a:o.r=a,JSON.stringify(o)}}PacketDecoder.RES_CODE=2;class Pack{constructor(){this.offset=0,this.pageSize=1024,this.capacity=1048576,this.buffer=new Uint8Array(this.pageSize),this.view=new DataView(this.buffer.buffer)}reset(){this.offset=0,this.buffer=null,this.view=null}size(){return this.offset}getBuffer(){return this.buffer.slice(0,this.offset).buffer}ensureCapacity(t){var o=this.offset+t;if(o>this.capacity)throw new Error("PackException over limit");if(o>this.buffer.byteLength){var a=Math.ceil(o/this.pageSize)*this.pageSize,c=new Uint8Array(a);c.set(this.buffer),this.buffer=c,this.view=new DataView(this.buffer.buffer)}}putRaw(t){this.ensureCapacity(t.length);try{this.buffer.set(t,this.offset),this.offset+=t.length}catch(t){throw new Error("PackException raw")}}putByte(t){this.ensureCapacity(1);try{this.view.setUint8(this.offset++,t)}catch(t){throw new Error("PackException byte")}}putString(t){try{var o=function encodeText(t){if("function"==typeof TextEncoder)return(new TextEncoder).encode(t);var o=function textEncoder(t){for(var o=[],a=t.length,c=0;c<a;){var m=t.codePointAt(c),h=0,g=0;for(m<=127?(h=0,g=0):m<=2047?(h=6,g=192):m<=65535?(h=12,g=224):m<=2097151&&(h=18,g=240),o.push(g|m>>h),h-=6;h>=0;)o.push(128|m>>h&63),h-=6;c+=m>=65536?2:1}return o}(t);return new Uint8Array(o)}(t);this.putVarbin(o)}catch(t){throw new Error("PackException string")}}putInt(t){this.ensureCapacity(4);try{this.view.setInt32(this.offset,t,!0),this.offset+=4}catch(t){throw new Error("PackException int")}}putVarInt(t){var o=varintToBytes(t);this.putRaw(o)}putBoolean(t){this.ensureCapacity(1);try{this.view.setUint8(this.offset++,t?1:0)}catch(t){throw new Error("PackException boolean")}}putLong(t){this.ensureCapacity(8);try{var o=function setBigUint64(t,o=!1){var a=new Uint8Array(8),c=new DataView(a.buffer),m=Number(t>yn-1?t/yn:0),h=Number(4294967295&t),[g,_]=o?[4,0]:[0,4];return c.setUint32(g,m,o),c.setUint32(_,h,o),a}(t,!0);this.buffer.set(o,this.offset),this.offset+=8}catch(t){throw new Error("PackException long")}}putStringAsLong(t){this.ensureCapacity(8);try{var o=function setBigUint64ForNumberOverflow(t,o=!1){var a=new Uint8Array(8),c=new DataView(a.buffer),m=BigNumber(t).divide(yn).number.reverse().join(""),h=BigNumber(t).mod(yn).number.reverse().join(""),g=Number(m),_=Number(h),[I,E]=o?[4,0]:[0,4];return c.setUint32(I,g,o),c.setUint32(E,_,o),a}(t,!0);this.buffer.set(o,this.offset),this.offset+=8}catch(t){throw new Error("PackException stringAsLong")}}putShort(t){this.ensureCapacity(2);try{this.view.setInt16(this.offset,t,!0),this.offset+=2}catch(t){throw new Error("PackException short")}}putVarbin(t){if(!t)return this.ensureCapacity(1),this.putVarInt(0);if(t.byteLength>Math.pow(2,31)-2)throw new Error("PackException varbin. too long");var o=varintToBytes(t.length);this.ensureCapacity(o.length+t.length);try{this.buffer.set(o,this.offset),this.offset+=o.length,this.buffer.set(t,this.offset),this.offset+=t.length}catch(t){throw new Error("PackException varbin")}}}function isConvertibleToNumber(t){if("number"!=typeof t){if(null==t)return!1;t=Number(t)}if(isNaN(t))throw new Error("Number type conversion error");return!0}function isUndefinedOrNull(t){return null==t}class PacketEncoder{constructor(t,o,a){this.pack=new Pack,this.packetLength=0,this.serviceId=0,this.commandId=0,this.serialId=0,this.tag=0,this.serviceId=t,this.commandId=o,this.serialId=a}marshalHeader(){this.pack.putVarInt(this.packetLength),this.pack.putByte(this.serviceId),this.pack.putByte(this.commandId),this.pack.putShort(this.serialId),this.pack.putByte(this.tag)}marshalProperty(t){var o=Object.keys(t).filter((t=>!isUndefinedOrNull(t)));this.pack.putVarInt(o.length),o.forEach((o=>{this.pack.putVarInt(Number(o)),Array.isArray(t[o])||"[object Object]"===Object.prototype.toString.call(t[o])?this.pack.putString(JSON.stringify(t[o])):this.pack.putString(String(t[o]))}))}marshalPropertyArray(t){var o=t.length;this.pack.putVarInt(o),t.forEach((t=>{this.marshalProperty(null==t?void 0:t.v)}))}marshalStrArray(t){var o=t.filter((t=>!isUndefinedOrNull(t))),a=o.length;this.pack.putVarInt(a),o.forEach((t=>{this.pack.putString(String(t))}))}marshalLongArray(t){var o=t.filter((t=>isConvertibleToNumber(t))),a=o.length;this.pack.putVarInt(a),o.forEach((t=>{this.putLong(t)}))}marshalStrStrMap(t){var o=Object.keys(t).filter((o=>!isUndefinedOrNull(t[o])&&!isUndefinedOrNull(o)));this.pack.putVarInt(o.length),o.forEach((o=>{this.pack.putString(String(o)),this.pack.putString(String(t[o]))}))}marshalStrLongMap(t){var o=Object.keys(t).filter((o=>isConvertibleToNumber(t[o])&&!isUndefinedOrNull(o)));this.pack.putVarInt(o.length),o.forEach((o=>{this.pack.putString(String(o)),this.putLong(t[o])}))}marshalLongLongMap(t){var o=Object.keys(t).filter((o=>{var a=Number(o);return isConvertibleToNumber(a)&&isConvertibleToNumber(t[a])}));this.pack.putVarInt(o.length),o.forEach((o=>{var a=Number(o);this.putLong(a),this.putLong(t[a])}))}marshalKVArray(t){var o=t.length;this.pack.putVarInt(o),t.forEach((t=>{this.marshalStrStrMap(t)}))}putLong(t){"string"==typeof t&&t.length>15?this.pack.putStringAsLong(t):this.pack.putLong(Number(t))}marshal(t,o){return this.marshalHeader(),o&&o.forEach(((o,a)=>{var c,m=o.type,h=null===(c=t[a])||void 0===c?void 0:c.v;if(!isUndefinedOrNull(h))switch(m){case"PropertyArray":this.marshalPropertyArray(h);break;case"Property":this.marshalProperty(h);break;case"Byte":if(!isConvertibleToNumber(h))return;this.pack.putByte(Number(h));break;case"Int":if(!isConvertibleToNumber(h))return;this.pack.putInt(Number(h));break;case"Bool":"false"===h?h=!1:"true"===h&&(h=!0),this.pack.putBoolean(h);break;case"Long":if(!isConvertibleToNumber(h))return;this.putLong(h);break;case"LongArray":this.marshalLongArray(h);break;case"String":this.pack.putString(String(h));break;case"StrArray":this.marshalStrArray(h);break;case"StrStrMap":this.marshalStrStrMap(h);break;case"StrLongMap":this.marshalStrLongMap(h);break;case"LongLongMap":this.marshalLongLongMap(h);break;case"KVArray":this.marshalKVArray(h)}})),this.pack.getBuffer()}reset(){this.pack.reset()}}class BaseWebsocket extends o{constructor(t,o){super(),this.url=o,this.websocket=null,this.socketConnectTimer=0,this.core=t,this.url=o,this.status="disconnected",this.logger=t.logger,this.connect()}connect(){"connecting"!==this.status&&"connected"!==this.status?(this.status="connecting",this._createWebsocket("wss://"+this.url+"/websocket")):this.logger.warn("imsocket::socket is connecting or connected",this.status)}close(){if(this.status="disconnected",this.websocket){this.logger.log("imsocket:: close websocket");try{this.websocket.close()}catch(t){this.logger.warn("imsocket::attempt to close websocket error",t)}this.clean(),this.emit("disconnect")}}clean(){this.status="disconnected",this.websocket&&(this.socketUrl=void 0,this.websocket.onmessage=null,this.websocket.onopen=null,this.websocket.onerror=null,this.websocket.onclose=null,this.websocket=null)}onConnect(){this.status="connected",this.emit("connect"),clearTimeout(this.socketConnectTimer)}_createWebsocket(t){this.socketConnectTimer=setTimeout((()=>{this.logger.error("imsocket::Websocket connect timeout. url: ",this.socketUrl),this.emit("connectFailed",new V2NIMErrorImpl({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:415,detail:{reason:`imsocket::Websocket connect timeout. url: ${this.socketUrl}`}}))}),this.core.options.socketConnectTimeout||8e3),this.socketUrl=t,this.websocket=new ai.WebSocket(t),this.websocket.binaryType="arraybuffer",this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onclose=()=>{this.logger.log("imsocket::Websocket onclose done"),"connected"===this.status?(this.clean(),this.emit("disconnect")):(this.clean(),this.emit("connectFailed",new V2NIMErrorImpl({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_CONNECT_FAILED:414,detail:{reason:"imsocket::Websocket onclose done"}})))},this.websocket.onerror=t=>{this.logger.error("imsocket::Websocket onerror",t),"connected"===this.status?(this.clean(),this.emit("disconnect")):(this.clean(),this.emit("connectFailed",new V2NIMErrorImpl({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_CONNECT_FAILED:414,detail:{reason:"imsocket::Websocket onerror."}})))},this.websocket.onopen=()=>{this.onConnect()}}onMessage(t){if(t.data){var o=new PacketDecoder(t.data),a={sid:-1,cid:-1,ser:-1,packetLength:-1},c=null;try{o.unmarshalHeader(),a=o.getHeader(),c=o.getInnerHeader()}catch(o){this.reportBinaryError({err:o,sid:c?c.sid:null==a?void 0:a.sid,cid:c?c.cid:null==a?void 0:a.cid,rawBuf:t.data,type:"decode"})}var m=c?c.sid:a.sid,h=c?c.cid:a.cid,g=`${m}_${h}`,_=pi[g];if(_&&_.length>0){var I,E=_[0].config;try{I=o.unmarshal(E.response)}catch(c){this.reportBinaryError({err:c,rawBuf:t.data,sid:m,cid:h,type:"decode"}),o.reset();var T=Object.assign(Object.assign({},a),{sid:m,cid:h,code:wt.V2NIM_ERROR_CODE_UNPACK_ERROR});return this.logger.error(`imsocket::onMessage "${T.sid}_${T.cid}", ser ${T.ser}, packetLength ${T.packetLength} unmarshal error`,c),void this.emit("message",JSON.stringify(T))}this.emit("message",I)}else this.core.logger.warn("imsocket::onMessage cmd not found",g);o.reset()}}send(t,o,a,c,m){var h,g,_=new PacketEncoder(t,o,a),I=li[c],E="";try{E=JSON.stringify(m),g=_.marshal(JSON.parse(E),I.params)}catch(c){throw this.reportBinaryError({err:c,sid:t,cid:o,rawStr:E,type:"encode"}),_.reset(),new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_PACK_ERROR,detail:{reason:`${t}-${o}, ser ${a} marshal error`,rawError:c}})}null===(h=this.websocket)||void 0===h||h.send(g),_.reset()}reportBinaryError(t){var o,a,c,{err:m,rawStr:h,sid:g,cid:_,type:I}=t,E=t.rawBuf;if(E){try{c=function arrayBufferToBase64(t){if("function"!=typeof btoa)return"";for(var o="",a=new Uint8Array(t),c=a.byteLength,m=0;m<c;m++)o+=String.fromCharCode(a[m]);return a=null,btoa(o)}(E)}catch(t){c=`reportBinaryError::arrayBufferToBase64 parsing failed, error: ${null==t?void 0:t.message}, sid: ${g}, cid: ${_}`,this.core.logger.error(c)}E=null}this.core.reporter.reportTraceStart("exceptions",{user_id:null===(o=this.core.auth)||void 0===o?void 0:o.account,trace_id:null===(a=this.core.clientSocket.socket)||void 0===a?void 0:a.sessionId,start_time:Date.now(),action:2,exception_service:9}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"encode"===I?wt.V2NIM_ERROR_CODE_PACK_ERROR:wt.V2NIM_ERROR_CODE_UNPACK_ERROR,description:m&&(m.message||`${m.code}`)+(h?` rawStr: ${h}`:"")+(c?` rawBuf: ${c}`:""),operation_type:"encode"===I?3:4,target:`${g}-${_}`},{asyncParams:ai.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1)}}!function(t){t[t.ACTIVE=1]="ACTIVE",t[t.KICKED=2]="KICKED",t[t.OFFLINE=3]="OFFLINE"}(Tn||(Tn={}));class V2BinaryClientSocket{constructor(t){this.isReconnect=!1,this.packetTimeout=8e3,this.packetSer=1,this.backoff=new Vi({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new Map,this.pingTimer=0,this.hasNetworkListener=!1,this.core=t,this.auth=t.auth,this.logger=t.logger,this.reporter=t.reporter,this.timerManager=t.timerManager,this.eventBus=t.eventBus,this.setListener()}setListener(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.isReconnect=!0}))}setSessionId(t){this.socket&&(this.socket.sessionId=t)}connect(t,o=!1){var a,c;return __awaiter(this,void 0,void 0,(function*(){this.isReconnect=o;var m=this.core.auth.getConnectStatus();if(m===Ze.V2NIM_CONNECT_STATUS_CONNECTED){var h=`clientSocket::connect status is ${m}, and would not repeat connect`,g=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:h}});return this.logger.warn(h),Promise.reject(g)}this.auth.lifeCycle.processEvent("connect");try{yield this.auth.doLoginStepsManager.add(this.doConnect(t)),this.logger.log(`clientSocketV2:: connect success with link url: ${t}, isReconnect: ${o}`),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:t,code:200,mixlink:!0,succeed:!0},{asyncParams:ai.net.getNetworkStatus()}),this.auth.lifeCycle.processEvent("connectSucc")}catch(o){var _=o;if(this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:t,code:_.code||0,description:`connectFailed:${_.message}`,mixlink:!0,succeed:!1},{asyncParams:ai.net.getNetworkStatus()}),_.code===wt.V2NIM_ERROR_CODE_CANCELLED||_.code===wt.V2NIM_ERROR_CODE_TIMEOUT)throw null===(a=this.socket)||void 0===a||a.close(),null===(c=this.socket)||void 0===c||c.removeAllListeners(),this.socket=void 0,o;throw this.logger.warn(`clientSocketV2::connect failed with link url: ${t}`,_),this.auth.lifeCycle.processEvent("connectFail",_),o}}))}doConnect(t){var o=!1;return new Promise(((a,c)=>{this.socket=new BaseWebsocket(this.core,t),this.socket.on("connect",(()=>{this.logger.log("clientSocketV2::socket on connect",t),this.core.reporterHookLinkKeep.start(),this.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:t}),o=!0,a()})),this.socket.on("message",this.onMessage.bind(this)),this.socket.on("disconnect",(a=>__awaiter(this,void 0,void 0,(function*(){o=!0,this.logger.log("clientSocketV2::socket on disconnect",a),yield this.core.reporterHookLinkKeep.update({code:(null==a?void 0:a.code)||0,description:(null==a?void 0:a.reason)||"socket on disconnect",operation_type:1,target:t}),this.core.reporterHookLinkKeep.end(!1),this.doDisconnect(Tn.OFFLINE,"SocketOnDisconnect")})))),this.socket.on("connectFailed",(t=>{o?this.ping():(this.logger.error(`clientSocketV2::connectFailed: "${t&&t.message}"`),this.cleanSocket()),o=!0,c(t)}))}))}cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)}resetSocketConfig(){this.backoff.reset(),this.initOnlineListener()}doDisconnect(t,o){if(this.logger.log(`clientSocketV2::doDisconnect: type ${t}, reason `,o),this.core.auth.getConnectStatus()!==Ze.V2NIM_CONNECT_STATUS_DISCONNECTED){var a={1:"close",2:"kicked",3:"broken"}[t]||"";this.markAllCmdInvaild(new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:a}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket(),t===Tn.ACTIVE||t===Tn.KICKED?this.destroyOnlineListener():t===Tn.OFFLINE&&(this.auth.lifeCycle.processEvent("connectionBroken",new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"connection broken due to internal reasons"}})),this.logger.log(`clientSocketV2::doDisconnect: pending reconnect ${this.isReconnect}`),this.isReconnect&&this.auth.lifeCycle.processEvent("waiting"))}else this.logger.warn("clientSocketV2::doDisconnect: already disconnected")}sendCmd(t,o,a){var c=this.core.auth.getLoginStatus(),m={cmd:t};if(c!==We.V2NIM_LOGIN_STATUS_LOGINED&&!["v2Login","login","chatroomLogin","v2ChatroomLogin"].includes(t))return this.logger.warn(`clientSocketV2::NIM login status is ${c}, so can not sendCmd ${t}`),Promise.reject(new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:Object.assign({reason:"Can not sendCmd due to no logined"},m)}));var h="heartbeat"!==t,g=h?this.packetSer++:0,_=createCmd(t,g,this.logger,o);if(!_){var I=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:Object.assign(Object.assign({},m),{reason:`SendCmd::createCmd error: ${g} ${t}`})});return this.logger.error(I),Promise.reject(I)}var{packet:E,hasPacketResponse:T,hasPacketTimer:M}=_,S=JSON.stringify(E);h&&("debug"===this.core.options.debugLevel?this.logger.debug("clientSocketV2::sendCmd",t,`ser:${g}`,S):this.logger.log("clientSocketV2::sendCmd",t,`ser:${g}`));var N=(new Date).getTime();return new Promise(((c,h)=>{T&&this.sendingCmdMap.set(g,{cmd:t,params:o,callback:[c,h],timer:M?setTimeout((()=>{var o=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,detail:Object.assign({ser:g,reason:`Packet Timeout: ser ${g} cmd ${t}`,timetag:(new Date).getTime()},m)});this.markCmdInvalid(g,o,t)}),a&&a.timeout?a.timeout:this.packetTimeout):null});try{this.socket.send(E.SID,E.CID,g,t,E.Q),T||c(E)}catch(o){var _=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED,detail:Object.assign({ser:g,reason:"Unable to send packet"+(o&&o.message?": "+o.message:""),timetag:(new Date).getTime(),rawError:o},m)});this.markCmdInvalid(g,_,t),h(_)}})).catch((t=>__awaiter(this,void 0,void 0,(function*(){var o=t;return[wt.V2NIM_ERROR_CODE_DISCONNECT,wt.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,wt.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED].includes(o.code)?(this.reportSendCmdFailed(o,{sid:E.SID,cid:E.CID,ser:g},N),Promise.reject(o)):Promise.reject(o)}))))}reportSendCmdFailed(t,o,a){var c;this.reporter.reportTraceStart("exceptions",{user_id:this.core.auth.getLoginUser(),trace_id:null===(c=this.socket)||void 0===c?void 0:c.sessionId,start_time:a,action:2,exception_service:6});var m=Ue(t,"detail.disconnect_reason")||"",h=t.code===wt.V2NIM_ERROR_CODE_DISCONNECT?JSON.stringify({disconnect_reason:m}):t.detail.reason;this.reporter.reportTraceUpdateV2("exceptions",{code:t.code,description:h,operation_type:1,target:`${o.sid}-${o.cid}`,context:`${o.ser}`},{asyncParams:ai.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1)}onMessage(t){var o=parseCmd(t,this.logger);if(o){var a=o[0],c=a.raw.ser;for(var m of("heartbeat"!==a.cmd&&("debug"===this.core.options.debugLevel?this.logger.debug(`clientSocketV2::recvCmd ser:${c} ${a.raw.sid}_${a.raw.cid}. ${t}`):this.logger.log(`clientSocketV2::recvCmd ser:${c} ${a.raw.sid}_${a.raw.cid}`)),o)){if(m.error&&this.logger.error("clientSocketV2::onMessage packet error",`${m.raw.sid}_${m.raw.cid}, ser:${c},`,m.error),m.notFound)return void this.logger.warn("clientSocketV2::onMessage packet not found",`${m.raw.sid}_${m.raw.cid}, ser:${c}`);this.packetHandler(m)}}}packetHandler(t){var o,a;if(t){var c=t.raw.ser,m=this.sendingCmdMap.get(c);if(m&&m.cmd===t.cmd){var{callback:h,timer:g,params:_}=m;if(clearTimeout(g),t.params=_,this.sendingCmdMap.delete(c),"heartbeat"===t.cmd)return void h[0]();var I=null===(o=this.core[t.service])||void 0===o?void 0:o.process(t);I&&"function"==typeof I.then?I.then((t=>{h[0](t)})).catch((t=>{h[1](t)})):(this.logger.log("clientSocketV2::handlerFn without promise",t.service,t.cmd),h[0](t))}else null===(a=this.core[t.service])||void 0===a||a.process(t)}}markCmdInvalid(t,o,a){var c=this.sendingCmdMap.get(t);if(c){var{callback:m,timer:h}=c;h&&clearTimeout(h),this.sendingCmdMap.delete(t),this.logger.warn(`clientSocketV2::packet ${t}, ${a} is invalid:`,o),m[1](o)}}markAllCmdInvaild(t){this.logger.log("markAllCmdInvaild",t),this.sendingCmdMap.forEach((o=>{var{callback:a,timer:c,cmd:m}=o;this.logger.debug(`clientSocketV2::markAllCmdInvaild:cmd ${m}`),c&&clearTimeout(c),a[1](t)})),this.sendingCmdMap.clear()}ping(){var t;return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);try{yield this.sendCmd("heartbeat")}catch(o){if(o.code===wt.V2NIM_ERROR_CODE_DISCONNECT)return;if(yield this.testHeartBeat5Timeout())return yield this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(t=this.socket)||void 0===t?void 0:t.url}),this.core.reporterHookLinkKeep.end(!0),void this.doDisconnect(Tn.OFFLINE,"PingError")}this.pingTimer=setTimeout((()=>{this.ping()}),3e4)}))}testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);for(var t=0;t<5;t++)try{return yield this.sendCmd("heartbeat",{},{timeout:3e3}),!1}catch(o){this.logger.debug(`clientSocketV2::test heartbeat ${t} Timeout`)}return!0}))}initOnlineListener(){this.hasNetworkListener||(this.logger.log("clientSocketV2::onlineListener:init"),this.hasNetworkListener=!0,ai.net.onNetworkStatusChange((t=>{this.logger.log("clientSocketV2::onlineListener:network change",t);var o=this.auth.getConnectStatus(),a=this.auth.getLoginStatus();t.isConnected&&a===We.V2NIM_LOGIN_STATUS_LOGINED?this.ping():t.isConnected&&o===Ze.V2NIM_CONNECT_STATUS_WAITING?(this.logger.log("clientSocketV2::onlineListener:online and connectStatus is waiting, do reLogin"),this.auth.reconnect.clearReconnectTimer(),this.auth.reconnect.doReLogin()):t.isConnected||this.doDisconnect(Tn.OFFLINE,"OfflineListener")})))}destroyOnlineListener(){this.logger.log("clientSocketV2::onlineListener:destroy"),ai.net.offNetworkStatusChange(),this.hasNetworkListener=!1}}!function(t){t[t.ACTIVE=1]="ACTIVE",t[t.KICKED=2]="KICKED",t[t.OFFLINE=3]="OFFLINE"}(Mn||(Mn={}));class V2ClientSocket{constructor(t){this.isReconnect=!1,this.packetTimeout=8e3,this.packetSer=1,this.backoff=new Vi({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new Map,this.pingTimer=0,this.hasNetworkListener=!1,this.core=t,this.auth=t.auth,this.logger=t.logger,this.reporter=t.reporter,this.timerManager=t.timerManager,this.eventBus=t.eventBus,this.setListener()}setListener(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.isReconnect=!0}))}setSessionId(t){this.socket&&(this.socket.sessionId=t)}connect(t,o=!1){var a,c;return __awaiter(this,void 0,void 0,(function*(){this.isReconnect=o;var m=this.core.auth.getConnectStatus();if(m===Ze.V2NIM_CONNECT_STATUS_CONNECTED){var h=`clientSocket::connect status is ${m}, and would not repeat connect`,g=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:h}});return this.logger.warn(h),Promise.reject(g)}this.auth.lifeCycle.processEvent("connect");try{yield this.auth.doLoginStepsManager.add(this.doConnect(t)),this.logger.log(`clientSocketV2:: connect success with link url: ${t}, isReconnect: ${o}`),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:t,code:200,mixlink:!0,succeed:!0},{asyncParams:ai.net.getNetworkStatus()}),this.auth.lifeCycle.processEvent("connectSucc")}catch(o){var _=o;if(this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:t,code:_.code||0,description:`connectFailed:${_.message}`,mixlink:!0,succeed:!1},{asyncParams:ai.net.getNetworkStatus()}),_.code===wt.V2NIM_ERROR_CODE_CANCELLED||_.code===wt.V2NIM_ERROR_CODE_TIMEOUT)throw null===(a=this.socket)||void 0===a||a.close(),null===(c=this.socket)||void 0===c||c.removeAllListeners(),this.socket=void 0,o;throw this.logger.warn(`clientSocketV2::connect failed with link url: ${t}`,_),this.auth.lifeCycle.processEvent("connectFail",_),o}}))}doConnect(t){var o=!1;return new Promise(((a,c)=>{this.socket=new BaseWebsocket$1(this.core,t),this.socket.on("connect",(()=>{this.logger.log("clientSocketV2::socket on connect",t),this.core.reporterHookLinkKeep.start(),this.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:t}),o=!0,a()})),this.socket.on("message",this.onMessage.bind(this)),this.socket.on("disconnect",(a=>__awaiter(this,void 0,void 0,(function*(){o=!0,this.logger.log("clientSocketV2::socket on disconnect",a),yield this.core.reporterHookLinkKeep.update({code:(null==a?void 0:a.code)||0,description:(null==a?void 0:a.reason)||"socket on disconnect",operation_type:1,target:t}),this.core.reporterHookLinkKeep.end(!1),this.doDisconnect(Mn.OFFLINE,"SocketOnDisconnect")})))),this.socket.on("handshakeFailed",(t=>{o?this.ping():(this.logger.error(`clientSocketV2::handshake failed: "${t&&t.message}"`),this.cleanSocket()),o=!0,c(t)}))}))}cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)}resetSocketConfig(){this.backoff.reset(),this.initOnlineListener()}doDisconnect(t,o){if(this.logger.log(`clientSocketV2::doDisconnect: type ${t}, reason `,o),this.core.auth.getConnectStatus()!==Ze.V2NIM_CONNECT_STATUS_DISCONNECTED){var a={1:"close",2:"kicked",3:"broken"}[t]||"";this.markAllCmdInvaild(new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:a}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket(),t===Mn.ACTIVE||t===Mn.KICKED?this.destroyOnlineListener():t===Mn.OFFLINE&&(this.auth.lifeCycle.processEvent("connectionBroken",new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"connection broken due to internal reasons"}})),this.logger.log(`clientSocketV2::doDisconnect: pending reconnect ${this.isReconnect}`),this.isReconnect&&this.auth.lifeCycle.processEvent("waiting"))}else this.logger.warn("clientSocketV2::doDisconnect: already disconnected")}sendCmd(t,o,a){var c=this.core.auth.getLoginStatus(),m={cmd:t};if(c!==We.V2NIM_LOGIN_STATUS_LOGINED&&!["v2Login","login","chatroomLogin","v2ChatroomLogin"].includes(t))return this.logger.warn(`clientSocketV2::NIM login status is ${c}, so can not sendCmd ${t}`),Promise.reject(new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:Object.assign({reason:"Can not sendCmd due to no logined"},m)}));var h="heartbeat"!==t,g=h?this.packetSer++:0,_=createCmd(t,g,this.logger,o);if(!_){var I=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:Object.assign(Object.assign({},m),{reason:`SendCmd::createCmd error: ${g} ${t}`})});return this.logger.error(I),Promise.reject(I)}var{packet:E,hasPacketResponse:T,hasPacketTimer:M}=_,S=JSON.stringify(E);h&&("debug"===this.core.options.debugLevel?this.logger.debug("clientSocketV2::sendCmd",t,`ser:${g}`,S):this.logger.log("clientSocketV2::sendCmd",t,`ser:${g}`));var N=(new Date).getTime();return new Promise(((c,h)=>{T&&this.sendingCmdMap.set(g,{cmd:t,params:o,callback:[c,h],timer:M?setTimeout((()=>{var o=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,detail:Object.assign({ser:g,reason:`Packet Timeout: ser ${g} cmd ${t}`,timetag:(new Date).getTime()},m)});this.markCmdInvalid(g,o,t)}),a&&a.timeout?a.timeout:this.packetTimeout):null});try{this.socket.send(S),T||c(E)}catch(o){var _=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED,detail:Object.assign({ser:g,reason:"Unable to send packet"+(o&&o.message?": "+o.message:""),timetag:(new Date).getTime(),rawError:o},m)});this.markCmdInvalid(g,_,t),h(_)}})).catch((t=>__awaiter(this,void 0,void 0,(function*(){var o,a=t;if(![wt.V2NIM_ERROR_CODE_DISCONNECT,wt.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,wt.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED].includes(a.code))return Promise.reject(a);this.reporter.reportTraceStart("exceptions",{user_id:this.core.auth.getLoginUser(),trace_id:null===(o=this.socket)||void 0===o?void 0:o.sessionId,start_time:N,action:2,exception_service:6});var c=Ue(a,"detail.disconnect_reason")||"",m=a.code===wt.V2NIM_ERROR_CODE_DISCONNECT?JSON.stringify({disconnect_reason:c}):a.detail.reason;return this.reporter.reportTraceUpdateV2("exceptions",{code:a.code,description:m,operation_type:1,target:`${E.SID}-${E.CID}`,context:`${E.SER}`},{asyncParams:ai.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1),Promise.reject(a)}))))}onMessage(t){var o=parseCmd(t,this.logger);if(o)for(var a of o){var c=a.raw.ser;if(a.error&&this.logger.error("clientSocketV2::onMessage packet error",`${a.raw.sid}_${a.raw.cid}, ser:${c},`,a.error),a.notFound)return void this.logger.warn("clientSocketV2::onMessage packet not found",`${a.raw.sid}_${a.raw.cid}, ser:${c}`);"heartbeat"!==a.cmd&&("debug"===this.core.options.debugLevel?this.logger.debug(`clientSocketV2::recvCmd ser:${c}`,a.cmd,a.content):this.logger.log(`clientSocketV2::recvCmd ser:${c}`,a.cmd)),this.packetHandler(a)}}packetHandler(t){var o,a;if(t){var c=t.raw.ser,m=this.sendingCmdMap.get(c);if(m&&m.cmd===t.cmd){var{callback:h,timer:g,params:_}=m;if(clearTimeout(g),t.params=_,this.sendingCmdMap.delete(c),"heartbeat"===t.cmd)return void h[0]();var I=null===(o=this.core[t.service])||void 0===o?void 0:o.process(t);I&&"function"==typeof I.then?I.then((t=>{h[0](t)})).catch((t=>{h[1](t)})):(this.logger.log("clientSocketV2::handlerFn without promise",t.service,t.cmd),h[0](t))}else null===(a=this.core[t.service])||void 0===a||a.process(t)}}markCmdInvalid(t,o,a){var c=this.sendingCmdMap.get(t);if(c){var{callback:m,timer:h}=c;h&&clearTimeout(h),this.sendingCmdMap.delete(t),this.logger.warn(`clientSocketV2::packet ${t}, ${a} is invalid:`,o),m[1](o)}}markAllCmdInvaild(t){this.logger.log("markAllCmdInvaild",t),this.sendingCmdMap.forEach((o=>{var{callback:a,timer:c,cmd:m}=o;this.logger.debug(`clientSocketV2::markAllCmdInvaild:cmd ${m}`),c&&clearTimeout(c),a[1](t)})),this.sendingCmdMap.clear()}ping(){var t;return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);try{yield this.sendCmd("heartbeat")}catch(o){if(o.code===wt.V2NIM_ERROR_CODE_DISCONNECT)return;if(yield this.testHeartBeat5Timeout())return yield this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(t=this.socket)||void 0===t?void 0:t.url}),this.core.reporterHookLinkKeep.end(!0),void this.doDisconnect(Mn.OFFLINE,"PingError")}this.pingTimer=setTimeout((()=>{this.ping()}),3e4)}))}testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);for(var t=0;t<5;t++)try{return yield this.sendCmd("heartbeat",{},{timeout:3e3}),!1}catch(o){this.logger.debug(`clientSocketV2::test heartbeat ${t} Timeout`)}return!0}))}initOnlineListener(){this.hasNetworkListener||(this.logger.log("clientSocketV2::onlineListener:init"),this.hasNetworkListener=!0,ai.net.onNetworkStatusChange((t=>{this.logger.log("clientSocketV2::onlineListener:network change",t);var o=this.auth.getConnectStatus(),a=this.auth.getLoginStatus();t.isConnected&&a===We.V2NIM_LOGIN_STATUS_LOGINED?this.ping():t.isConnected&&o===Ze.V2NIM_CONNECT_STATUS_WAITING?(this.logger.log("clientSocketV2::onlineListener:online and connectStatus is waiting, do reLogin"),this.auth.reconnect.clearReconnectTimer(),this.auth.reconnect.doReLogin()):t.isConnected||this.doDisconnect(Mn.OFFLINE,"OfflineListener")})))}destroyOnlineListener(){this.logger.log("clientSocketV2::onlineListener:destroy"),ai.net.offNetworkStatusChange(),this.hasNetworkListener=!1}}class V2NIMLoginReconnect{constructor(t){this.currenRetryCount=0,this.backoff=new Vi({max:8e3,min:1600,jitter:.01}),this.reconnectTimer=0,this.core=t,this.auth=t.V2NIMLoginService}reset(){this.currenRetryCount=0,this.backoff.reset(),this.reconnectTimer&&clearTimeout(this.reconnectTimer)}clearReconnectTimer(){this.reconnectTimer&&clearTimeout(this.reconnectTimer)}attempToReLogin(){var t=this.backoff.duration();if("function"==typeof this.reconnectDelayProvider)try{var o=this.reconnectDelayProvider(t);"number"==typeof o&&o>=0&&(t=o>=1e3?o:o+200+Math.ceil(300*Math.random()))}catch(t){this.core.logger.error("reconnect::connectDelayProvider excute failed,",t)}return this.currenRetryCount++,this.core.logger.log(`reconnect::reconnect timer is about to be set, delay ${t} ms, current retry count is ${this.currenRetryCount}`),this.core.reporter.reportTraceStart("login",{user_id:this.auth.getLoginUser(),action:"auto_login",binary_websocket:this.auth.binaryWebsocket}),this.clearReconnectTimer(),this.reconnectTimer=setTimeout((()=>{this.core.logger.log("reconnect::reconnect timer is now triggered");var t=this.auth.getConnectStatus();t===Ze.V2NIM_CONNECT_STATUS_WAITING?this.doReLogin():this.core.logger.warn(`reconnect::reconnect timer is over because connect status now is ${t}`)}),t),!0}doReLogin(){this.auth.loginOption.forceMode=!1,this.auth.originLoginPromise=this.auth.doLogin(!0);var t=this.auth.previousLoginManager.add(this.auth.originLoginPromise);return t.then((()=>{this.core.reporter.reportTraceEnd("login",!0)})).catch((t=>{var o=t;if(this.core.logger.warn("reconnect::try login but failed due to",o),this.core.reporter.reportTraceEnd("login",!1),this.auth.checkLoginTerminalCode(o&&o.code))return this.auth.clientSocket.doDisconnect(Tn.ACTIVE,"ReloginTerminated"),void this.auth.lifeCycle.processEvent("exited",o);o&&399===o.code&&this.auth.lbs.reset(),this.auth.lifeCycle.processEvent("waiting")})),t}_setReconnectDelayProvider(t){this.reconnectDelayProvider=t}}class V2NIMLoginLbs{constructor(t){this.socketLinkUrls=[],this.timer=0,this.failedCount=0,this.core=t,this.auth=t.V2NIMLoginService}getLbsInfos(){return __awaiter(this,void 0,void 0,(function*(){if(this.socketLinkUrls.length>0){var t=this.socketLinkUrls.shift();return this.socketLinkUrls=[],this.core.logger.log("V2NIMLoginService::getLbsInfos:use cache link",t),Promise.resolve(t)}this.auth.lifeCycle.processEvent("addressing"),this.core.reporterHookLBS.start(this.core.account);var o=zi(this.auth.config.lbsUrls);try{var a=yield this.ladderLoad(o);if(200!==a.status||!a.data)throw this.core.logger.error("V1NIMLoginService::getLbsInfos:error status",a.status,a),new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:`V2NIMLoginService::getLbsInfos failed, status ${a.status}`}});this.success(a)}catch(t){var c=t;if(this.core.logger.error(`V2NIMLoginService::lbs getLbsInfos error, use default link: ${this.auth.config.linkUrl}. error:`,t),this.reportForFail(o[0],c.code,c.message),this.checkTerminator(c.code))throw t;this.socketLinkUrls=[this.auth.config.linkUrl]}return this.socketLinkUrls.shift()}))}checkTerminator(t){return t===wt.V2NIM_ERROR_CODE_CANCELLED||t===wt.V2NIM_ERROR_CODE_TIMEOUT}generateUrl(t){var o=t.indexOf("?")>-1?"&":"?";return t+o+"k="+this.core.options.appkey+"&id="+this.core.auth.getLoginUser()+"&sv=180&pv=1&networkType=0&lv=1"}requstLbs(t){return this.auth.doLoginStepsManager.add(this.core.adapters.request(this.generateUrl(t),{method:"GET",dataType:"json",timeout:8e3}))}setLadderTimer(t,o,a,c){this.timer&&clearTimeout(this.timer);var m=t[o];this.timer=setTimeout((()=>{m&&(this.setLadderTimer(t,o+1,a,c),this.core.logger.log(`V2NIMLoginService::getLbsInfos ${o}:`,m),this.reportForLbsStart(m,o),this.requstLbs(m).then((t=>{this.reset(),a(Object.assign(Object.assign({},t),{url:m}))})).catch((a=>{var h;if(this.core.logger.warn(`V2NIMLoginService::getLbsInfos ${o} failed:`,a),this.failedCount+=1,this.reportForFailOnce(m,a.code,(null===(h=a.detail)||void 0===h?void 0:h.reason)||a.message),this.failedCount>=t.length||this.checkTerminator(a.code))return this.reset(),void c(a)})))}),2e3)}ladderLoad(t){return new Promise(((o,a)=>{t.length>1&&this.setLadderTimer(t,1,o,a);var c=t[0];this.core.logger.log("V2NIMLoginService::getLbsInfos 0:",c),this.reportForLbsStart(c,0),this.requstLbs(c).then((t=>{this.reset(),o(Object.assign(Object.assign({},t),{url:c}))})).catch((o=>{var m;this.failedCount+=1,this.core.logger.warn("V2NIMLoginService::getLbsInfos 0 failed:",o),this.reportForFailOnce(c,o.code,(null===(m=o.detail)||void 0===m?void 0:m.reason)||o.message),(this.failedCount>=t.length||this.checkTerminator(o.code))&&(this.reset(),a(o))}))}))}success(t){var o,a,c=t.data.common;this.socketLinkUrls=zi(c["mix.link"].concat(c["link.default"]).concat([this.auth.config.linkUrl])),t.data["nos-chunk"]&&(null===(o=this.core.cloudStorage)||void 0===o?void 0:o.setOptions)&&(this.core.logger.log("getLbsInfos success. lbs.nos-chunk",t.data["nos-chunk"]),this.core.cloudStorage.setOptions({chunkUploadHost:t.data["nos-chunk"]})),Array.isArray(t.data.nosup)&&t.data.nosup.length>0&&(this.core.logger.log("getLbsInfos success. lbs.nosup",t.data.nosup),null===(a=this.core.cloudStorage)||void 0===a||a.setOptions({commonUploadHostBackupList:t.data.nosup,commonUploadHost:t.data.nosup[0]})),this.core.logger.log("V2NIMLoginService::getLbsInfos success, socket link:",this.socketLinkUrls.slice(0),"chunkUploadHost: ",t.data["nos-chunk"]),this.reportForLbsSuccess(t.url,t.data)}reportForLbsStart(t,o){this.core.reporterHookLBS.updateBegin({target:t,index:o})}reportForLbsSuccess(t,o){this.core.reporterHookLBS.updateComplete({target:t,code:200,body:JSON.stringify(o)}),this.core.reporterHookLBS.end(!0),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:t,code:200,succeed:!0},{asyncParams:ai.net.getNetworkStatus()})}reportForFailOnce(t,o,a){this.core.reporterHookLBS.updateComplete({target:t,code:o,body:a})}reportForFail(t,o,a){this.core.reporterHookLBS.end(!1),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:t,description:a,code:o,succeed:!1},{asyncParams:ai.net.getNetworkStatus()})}reset(){this.socketLinkUrls=[],this.failedCount=0,clearTimeout(this.timer)}}var Sn=function arraySome(t,o){for(var a=-1,c=null==t?0:t.length;++a<c;)if(o(t[a],a,t))return!0;return!1};var Nn=function equalArrays(t,o,a,c,m,h){var g=1&a,_=t.length,I=o.length;if(_!=I&&!(g&&I>_))return!1;var E=h.get(t),T=h.get(o);if(E&&T)return E==o&&T==t;var M=-1,S=!0,N=2&a?new Li:void 0;for(h.set(t,o),h.set(o,t);++M<_;){var C=t[M],A=o[M];if(c)var O=g?c(A,C,M,o,t,h):c(C,A,M,t,o,h);if(void 0!==O){if(O)continue;S=!1;break}if(N){if(!Sn(o,(function(t,o){if(!Bi(N,o)&&(C===t||m(C,t,a,c,h)))return N.push(o)}))){S=!1;break}}else if(C!==A&&!m(C,A,a,c,h)){S=!1;break}}return h.delete(t),h.delete(o),S};var Cn=function mapToArray(t){var o=-1,a=Array(t.size);return t.forEach((function(t,c){a[++o]=[c,t]})),a},An=_?_.prototype:void 0,On=An?An.valueOf:void 0;var Rn=function equalByTag(t,o,a,c,m,h,g){switch(a){case"[object DataView]":if(t.byteLength!=o.byteLength||t.byteOffset!=o.byteOffset)return!1;t=t.buffer,o=o.buffer;case"[object ArrayBuffer]":return!(t.byteLength!=o.byteLength||!h(new Xt(t),new Xt(o)));case"[object Boolean]":case"[object Date]":case"[object Number]":return ce(+t,+o);case"[object Error]":return t.name==o.name&&t.message==o.message;case"[object RegExp]":case"[object String]":return t==o+"";case"[object Map]":var _=Cn;case"[object Set]":var I=1&c;if(_||(_=Hi),t.size!=o.size&&!I)return!1;var E=g.get(t);if(E)return E==o;c|=2,g.set(t,o);var T=Nn(_(t),_(o),c,m,h,g);return g.delete(t),T;case"[object Symbol]":if(On)return On.call(t)==On.call(o)}return!1};var bn=function arrayPush(t,o){for(var a=-1,c=o.length,m=t.length;++a<c;)t[m+a]=o[a];return t};var Vn=function baseGetAllKeys(t,o,a){var m=o(t);return c(t)?m:bn(m,a(t))};var Pn=function arrayFilter(t,o){for(var a=-1,c=null==t?0:t.length,m=0,h=[];++a<c;){var g=t[a];o(g,a,t)&&(h[m++]=g)}return h};var kn=function stubArray(){return[]},Ln=Object.prototype.propertyIsEnumerable,Dn=Object.getOwnPropertySymbols,wn=Dn?function(t){return null==t?[]:(t=Object(t),Pn(Dn(t),(function(o){return Ln.call(t,o)})))}:kn;var Un=function getAllKeys(t){return Vn(t,Ni,wn)},xn=Object.prototype.hasOwnProperty;var Fn=function equalObjects(t,o,a,c,m,h){var g=1&a,_=Un(t),I=_.length;if(I!=Un(o).length&&!g)return!1;for(var E=I;E--;){var T=_[E];if(!(g?T in o:xn.call(o,T)))return!1}var M=h.get(t),S=h.get(o);if(M&&S)return M==o&&S==t;var N=!0;h.set(t,o),h.set(o,t);for(var C=g;++E<I;){var A=t[T=_[E]],O=o[T];if(c)var R=g?c(O,A,T,o,t,h):c(A,O,T,t,o,h);if(!(void 0===R?A===O||m(A,O,a,c,h):R)){N=!1;break}C||(C="constructor"==T)}if(N&&!C){var b=t.constructor,V=o.constructor;b==V||!("constructor"in t)||!("constructor"in o)||"function"==typeof b&&b instanceof b&&"function"==typeof V&&V instanceof V||(N=!1)}return h.delete(t),h.delete(o),N},Gn=X(g,"DataView"),Bn=X(g,"Promise"),jn=X(g,"WeakMap"),Yn=j(Gn),Hn=j(_e),$n=j(Bn),qn=j(ji),zn=j(jn),Kn=O;(Gn&&"[object DataView]"!=Kn(new Gn(new ArrayBuffer(1)))||_e&&"[object Map]"!=Kn(new _e)||Bn&&"[object Promise]"!=Kn(Bn.resolve())||ji&&"[object Set]"!=Kn(new ji)||jn&&"[object WeakMap]"!=Kn(new jn))&&(Kn=function(t){var o=O(t),a="[object Object]"==o?t.constructor:void 0,c=a?j(a):"";if(c)switch(c){case Yn:return"[object DataView]";case Hn:return"[object Map]";case $n:return"[object Promise]";case qn:return"[object Set]";case zn:return"[object WeakMap]"}return o});var Wn=Kn,Jn=Object.prototype.hasOwnProperty;var Xn=function baseIsEqualDeep(t,o,a,m,h,g){var _=c(t),I=c(o),E=_?"[object Array]":Wn(t),T=I?"[object Array]":Wn(o),M="[object Object]"==(E="[object Arguments]"==E?"[object Object]":E),S="[object Object]"==(T="[object Arguments]"==T?"[object Object]":T),N=E==T;if(N&&vr(t)){if(!vr(o))return!1;_=!0,M=!1}if(N&&!M)return g||(g=new $t),_||Rr(t)?Nn(t,o,a,m,h,g):Rn(t,o,E,a,m,h,g);if(!(1&a)){var C=M&&Jn.call(t,"__wrapped__"),A=S&&Jn.call(o,"__wrapped__");if(C||A){var O=C?t.value():t,R=A?o.value():o;return g||(g=new $t),h(O,R,a,m,g)}}return!!N&&(g||(g=new $t),Fn(t,o,a,m,h,g))};var Qn=function baseIsEqual(t,o,a,c,m){return t===o||(null==t||null==o||!R(t)&&!R(o)?t!=t&&o!=o:Xn(t,o,a,c,baseIsEqual,m))};var Zn=function baseIsMatch(t,o,a,c){var m=a.length,h=m,g=!c;if(null==t)return!h;for(t=Object(t);m--;){var _=a[m];if(g&&_[2]?_[1]!==t[_[0]]:!(_[0]in t))return!1}for(;++m<h;){var I=(_=a[m])[0],E=t[I],T=_[1];if(g&&_[2]){if(void 0===E&&!(I in t))return!1}else{var M=new $t;if(c)var S=c(E,T,I,t,o,M);if(!(void 0===S?Qn(T,E,3,c,M):S))return!1}}return!0};var eo=function isStrictComparable(t){return t==t&&!L(t)};var to=function getMatchData(t){for(var o=Ni(t),a=o.length;a--;){var c=o[a],m=t[c];o[a]=[c,m,eo(m)]}return o};var ro=function matchesStrictComparable(t,o){return function(a){return null!=a&&(a[t]===o&&(void 0!==o||t in Object(a)))}};var io=function baseMatches(t){var o=to(t);return 1==o.length&&o[0][2]?ro(o[0][0],o[0][1]):function(a){return a===t||Zn(a,t,o)}};var no=function baseHasIn(t,o){return null!=t&&o in Object(t)};var oo=function hasPath(t,o,a){for(var m=-1,h=(o=Le(o,t)).length,g=!1;++m<h;){var _=De(o[m]);if(!(g=null!=t&&a(t,_)))break;t=t[_]}return g||++m!=h?g:!!(h=null==t?0:t.length)&&mr(h)&&wr(_,h)&&(c(t)||ur(t))};var so=function hasIn(t,o){return null!=t&&oo(t,o,no)};var ao=function baseMatchesProperty(t,o){return k(t)&&eo(o)?ro(De(t),o):function(a){var c=Ue(a,t);return void 0===c&&c===o?so(a,t):Qn(o,c,3)}};var co=function baseProperty(t){return function(o){return null==o?void 0:o[t]}};var lo=function basePropertyDeep(t){return function(o){return we(o,t)}};var po=function property(t){return k(t)?co(De(t)):lo(t)};var uo=function baseIteratee(t){return"function"==typeof t?t:null==t?qr:"object"==typeof t?c(t)?ao(t[0],t[1]):io(t):po(t)};var mo=function last(t){var o=null==t?0:t.length;return o?t[o-1]:void 0};var ho=function baseSlice(t,o,a){var c=-1,m=t.length;o<0&&(o=-o>m?0:m+o),(a=a>m?m:a)<0&&(a+=m),m=o>a?0:a-o>>>0,o>>>=0;for(var h=Array(m);++c<m;)h[c]=t[c+o];return h};var go=function parent(t,o){return o.length<2?t:we(t,ho(o,0,-1))};var _o=function baseUnset(t,o){return o=Le(o,t),null==(t=go(t,o))||delete t[De(mo(o))]},vo=Array.prototype.splice;var Io=function basePullAt(t,o){for(var a=t?o.length:0,c=a-1;a--;){var m=o[a];if(a==c||m!==h){var h=m;wr(m)?vo.call(t,m,1):_o(t,m)}}return t};var Eo=function remove(t,o){var a=[];if(!t||!t.length)return a;var c=-1,m=[],h=t.length;for(o=uo(o);++c<h;){var g=t[c];o(g,c,t)&&(a.push(g),m.push(c))}return Io(t,m),a};class V2NIMLoginAuthenticator{constructor(t){this.lastLoginClientKey="__NIM_LAST_LOGIN_CLIENT__",this.loginClients=[],this.loginClientOfThisConnection={},this.core=t,this.auth=t.V2NIMLoginService}verifyAuthentication(t){return __awaiter(this,void 0,void 0,(function*(){var o=yield this.auth.doLoginStepsManager.add(this.refreshLoginToken(this.auth.account)),a=yield this.auth.doLoginStepsManager.add(this.refreshThirdPartyExt(this.auth.account));this.auth.token=o;var c,m=ai.getSystemInfo(),h={appkey:this.core.options.appkey,account:this.auth.account,token:o,authType:this.auth.loginOption.authType,appLogin:t?0:1,clientType:Je.V2NIM_LOGIN_CLIENT_TYPE_WEB,clientSession:this.auth.clientSession,clientId:this.auth.deviceId,sdkVersion:100400,userAgent:this.core.options.loginSDKTypeParamCompat?"Native/10.4.0":m.userAgent.slice(0,299),libEnv:this.core.options.loginSDKTypeParamCompat?void 0:m.libEnv,hostEnv:this.core.options.loginSDKTypeParamCompat?0:m.hostEnvEnum,sdkHumanVersion:"10.4.0",os:m.os,browser:m.browser,protocolVersion:1,customClientType:this.auth.config.customClientType,customTag:this.auth.config.customTag,thirdPartyExtension:a},g=m.os.toLowerCase();"UNIAPP"!==ai.platform||"ios"!==g&&"android"!==g||(h.isReactNative=1,h.clientType="ios"===g?Je.V2NIM_LOGIN_CLIENT_TYPE_IOS:Je.V2NIM_LOGIN_CLIENT_TYPE_ANDROID,m.pushDeviceInfo&&m.pushDeviceInfo.MANUFACTURER&&(h.deviceInfo=JSON.stringify(Object.assign({IS_SUPPORT_HONOR:!0},m.pushDeviceInfo)))),this.core.logger.log("V2NIMLoginService::do login ",h.account,h.clientSession,h.appLogin);try{c=yield this.auth.doLoginStepsManager.add(this.auth.clientSocket.sendCmd("v2Login",{tag:h}))}catch(t){var _=t;if(this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"26-3",code:_.code||0,succeed:!1,description:_.message},{asyncParams:ai.net.getNetworkStatus()}),_.code===wt.V2NIM_ERROR_CODE_CANCELLED||_.code===wt.V2NIM_ERROR_CODE_TIMEOUT)throw _;throw this.processLoginFailed(_),_}var{data:I,loginClients:E}=c.content;return this.changeLoginClient(Qe.V2NIM_LOGIN_CLIENT_CHANGE_LIST,E),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"26-3",code:200,succeed:!0},{asyncParams:ai.net.getNetworkStatus()}),this.loginClientOfThisConnection=formatLoginInfo(I),this.core.clientSocket.setSessionId(I.consid),ai.localStorage.setItem(this.lastLoginClientKey,JSON.stringify(Object.assign({account:this.auth.account},this.loginClientOfThisConnection))),this.loginClientOfThisConnection}))}refreshLoginToken(t){return __awaiter(this,void 0,void 0,(function*(){if(this.auth.loginOption.authType===Ke.V2NIM_LOGIN_AUTH_TYPE_DEFAULT)return this.auth.token;if("function"!=typeof this.auth.loginOption.tokenProvider)return this.auth.token;try{var o=yield this.auth.loginOption.tokenProvider(t);if("string"==typeof o)return o;throw this.core.logger.error("V2NIMLoginService::excute tokenProvider complete but got Unexpected value:",o),new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute tokenProvider complete but got Unexpected value",rawData:o}})}catch(t){var a=t,c=a;throw a.code!==wt.V2NIM_ERROR_CODE_CALLBACK_FAILED&&(this.core.logger.error("V2NIMLoginService::excute tokenProvider error:",a),c=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CALLBACK_FAILED,desc:"Excute tokenProvider error",detail:{rawError:t}})),this.processLoginFailed(a),c}}))}refreshThirdPartyExt(t){return __awaiter(this,void 0,void 0,(function*(){if("function"!=typeof this.auth.loginOption.loginExtensionProvider)return"";try{var o=yield this.auth.loginOption.loginExtensionProvider(t);if("string"==typeof o)return o;throw this.core.logger.error("V2NIMLoginService::excute loginExtensionProvider complete but got Unexpected value:",o),new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute loginExtensionProvider complete but got Unexpected value",rawData:o}})}catch(t){var a=t,c=a;if(a.code!==wt.V2NIM_ERROR_CODE_CALLBACK_FAILED&&(this.core.logger.error("V2NIMLoginService::excute loginExtensionProvider error:",a),c=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute loginExtensionProvider error",rawError:t}})),this.auth.loginOption.authType===Ke.V2NIM_LOGIN_AUTH_TYPE_THIRD_PARTY)throw this.processLoginFailed(a),c;return""}}))}processLoginFailed(t){this.auth.clientSocket.doDisconnect(Tn.ACTIVE,t),this.checkLoginTerminalCode(t.code)&&(this.auth.authenticator.reset(),this.auth.authenticator.clearLastLoginClient()),this.auth.lifeCycle.processEvent("loginFail",t)}changeLoginClient(t,o){var a=o.map((t=>formatLoginInfo(t)));if(t===Qe.V2NIM_LOGIN_CLIENT_CHANGE_LIST)this.loginClients=a,this.auth.emit("onLoginClientChanged",t,this.loginClients);else if(t===Qe.V2NIM_LOGIN_CLIENT_CHANGE_LOGIN){var c=a.filter((t=>{var o=this.loginClients.filter((o=>o.clientId===t.clientId));return this.loginClients.push(t),0===o.length}));c.length>0&&this.auth.emit("onLoginClientChanged",t,c)}else if(t===Qe.V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT){var m=a.filter((t=>(Eo(this.loginClients,(o=>o.clientId===t.clientId&&o.consid===t.consid)),0===this.loginClients.filter((o=>o.clientId===t.clientId)).length)));m.length>0&&this.auth.emit("onLoginClientChanged",t,m)}}checkAutoLogin(t){if(t)return!1;var o=ai.localStorage.getItem(this.lastLoginClientKey);if(!o)return!1;var a="",c="";try{var m=JSON.parse(o);a=Ue(m,"clientId"),c=Ue(m,"account")}catch(t){return!1}return a===this.auth.deviceId&&c===this.auth.account}checkLoginTerminalCode(t){return[wt.V2NIM_ERROR_CODE_CANCELLED,wt.V2NIM_ERROR_CODE_TIMEOUT,wt.V2NIM_ERROR_CODE_HANDSHAKE,302,317,wt.V2NIM_ERROR_CODE_FORBIDDEN,wt.V2NIM_ERROR_CODE_NOT_FOUND,wt.V2NIM_ERROR_CODE_PARAMETER_ERROR,wt.V2NIM_ERROR_CODE_MULTI_LOGIN_FORBIDDEN,422,wt.V2NIM_ERROR_CODE_IM_DISABLED,wt.V2NIM_ERROR_CODE_APPKEY_NOT_EXIST,wt.V2NIM_ERROR_CODE_BUNDLEID_CHECK_FAILED,wt.V2NIM_ERROR_CODE_APPKEY_BLOCKED,wt.V2NIM_ERROR_CODE_INVALID_TOKEN,wt.V2NIM_ERROR_CODE_ROBOT_NOT_ALLOWED,wt.V2NIM_ERROR_CODE_ACCOUNT_NOT_EXIST,wt.V2NIM_ERROR_CODE_ACCOUNT_BANNED,wt.V2NIM_ERROR_CODE_USER_PROFILE_NOT_EXIST].includes(t)}reset(){this.loginClients=[],this.loginClientOfThisConnection={}}clearLastLoginClient(){ai.localStorage.removeItem(this.lastLoginClientKey)}}class V2NIMLoginLifeCycle{constructor(t){this.name="V2NIMLoginLifeCycle",this.loginStatus=We.V2NIM_LOGIN_STATUS_LOGOUT,this.connectStatus=Ze.V2NIM_CONNECT_STATUS_DISCONNECTED,this.core=t,this.auth=t.V2NIMLoginService,this.logger=t.logger}processEvent(t,o,a){var c=this.getConnectStatus();switch(t){case"addressing":this.logger.log(`${this.name}::addressing`),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_LOGINING),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_CONNECTING);break;case"connect":this.logger.log(`${this.name}::connecting`),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_LOGINING),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_CONNECTING);break;case"connectSucc":this.logger.log(`${this.name}::connect success`),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_LOGINING),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_CONNECTED);break;case"connectFail":this.logger.log(`${this.name}::connect fail`,o),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_UNLOGIN),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_DISCONNECTED,o);break;case"connectionBroken":this.logger.log(`${this.name}::connectionBroken:`,o),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_UNLOGIN),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_DISCONNECTED,o),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleDisconnected",o);break;case"loginSucc":this.logger.log(`${this.name}::login success, verify authentication success`),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_LOGINED),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleLoginSucc",a);break;case"loginFail":if(this.logger.log(`${this.name}::login fail due to verify authentication failed:`,o),!o)return;this.setLoginStatus(this.auth.authenticator.checkLoginTerminalCode(o.code)?We.V2NIM_LOGIN_STATUS_LOGOUT:We.V2NIM_LOGIN_STATUS_UNLOGIN),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_DISCONNECTED,o),this.auth.emit("onLoginFailed",o);break;case"logout":this.logger.log(`${this.name}::logout`),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_LOGOUT),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_DISCONNECTED),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleLogout");break;case"kicked":this.logger.log(`${this.name}::kicked`,a),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_LOGOUT),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_DISCONNECTED,o),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleKicked");break;case"exited":this.logger.log(`${this.name}::exited`,o),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_LOGOUT),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_DISCONNECTED,o);break;case"waiting":this.logger.log(`${this.name}::waiting to reconnect`),this.setLoginStatus(We.V2NIM_LOGIN_STATUS_UNLOGIN),this.setConnectStatus(Ze.V2NIM_CONNECT_STATUS_WAITING),c!==Ze.V2NIM_CONNECT_STATUS_CONNECTING&&this.auth.reconnect.attempToReLogin()}}getConnectStatus(){return this.connectStatus}getLoginStatus(){return this.loginStatus}setLoginStatus(t){t!==this.loginStatus&&(this.loginStatus=t,this.logger.log(`V2NIMLoginService::emit event "onLoginStatus", means ${We[t]}`),this.auth.emit("onLoginStatus",t))}setConnectStatus(t,o){if(t!==this.connectStatus){var a=this.connectStatus;this.connectStatus=t,this.logger.log(`V2NIMLoginService::emit event "onConnectStatus", means ${Ze[t]}`),this.auth.emit("onConnectStatus",t),this.delegateConnectEvent(a,t,o)}}delegateConnectEvent(t,o,a){t===Ze.V2NIM_CONNECT_STATUS_CONNECTED&&o===Ze.V2NIM_CONNECT_STATUS_DISCONNECTED&&a&&this.auth.emit("onDisconnected",a),t===Ze.V2NIM_CONNECT_STATUS_CONNECTING&&o===Ze.V2NIM_CONNECT_STATUS_DISCONNECTED&&a&&this.auth.emit("onConnectFailed",a)}}class V2NIMLoginDataSync{constructor(t){this.core=t,this.auth=t.V2NIMLoginService,this.datas=[],this.mainSyncFlag=!1,this.conversationSyncFlag=!1}switchDataSync(t){return __awaiter(this,void 0,void 0,(function*(){var{type:o,state:a,error:c,subType:m}=t;o===Fe.V2NIM_DATA_SYNC_TYPE_MAIN&&a===Ge.V2NIM_DATA_SYNC_STATE_COMPLETED&&("mainSync"===m?this.mainSyncFlag=!0:"conversationSync"===m&&(this.conversationSyncFlag=!0));var h=this.datas.filter((t=>t.type===o)),g=h.length>0?h[0]:null;g?(g.state=a,g.error=c):this.datas.push({type:o,state:a,error:c}),this.core.logger.log(`V2NIMLoginService::emit event "onDataSync", means ${Fe[o]} and ${Ge[a]}`,c),o===Fe.V2NIM_DATA_SYNC_TYPE_MAIN&&(a===Ge.V2NIM_DATA_SYNC_STATE_SYNCING?this.auth.emit("onDataSync",o,a,c):a===Ge.V2NIM_DATA_SYNC_STATE_COMPLETED&&this.mainSyncFlag&&this.conversationSyncFlag&&(this.auth.emit("onDataSync",o,a,c),this.mainSyncFlag=!1,this.conversationSyncFlag=!1))}))}reset(){this.datas=[],this.mainSyncFlag=!1,this.conversationSyncFlag=!1}}var fo=function uniqBy(t,o){return t&&t.length?qi(t,uo(o)):[]},To=["https://lbs.netease.im/lbs/webconf.jsp"],Mo={retryCount:3,timeout:6e4,forceMode:!1,authType:Ke.V2NIM_LOGIN_AUTH_TYPE_DEFAULT,syncLevel:0};class V2NIMLoginServiceImpl extends V2Service{constructor(t,o={}){super("V2NIMLoginService",t),this.account="",this.previousLoginAccount="",this.token="",this.deviceId="",this.clientSession="",this.processId="",this.kickedDetail=null,this.binaryWebsocket=!0,registerParser({cmdMap:hn,cmdConfig:vn}),"v2"===t.options.apiVersion&&(registerParser({cmdMap:gn,cmdConfig:In}),this.core.auth=this),this.previousLoginManager=new PromiseManager,this.doLoginStepsManager=new PromiseManager,this.loginTimerManager=new TimerManager,this.loginOption=Object.assign({},Mo),this.config={lbsUrls:To,linkUrl:"weblink05.netease.im:443"},this.setOptions(o),t.V2NIMLoginService=this;var a,c=this.core.options.binaryWebsocket,m="BROWSER"===ai.platform&&"function"==typeof TextDecoder&&"function"==typeof TextEncoder&&"function"==typeof Uint8Array;"boolean"==typeof c&&(m=m&&c),m?(this.binaryWebsocket=!0,a=new V2BinaryClientSocket(this.core)):(this.binaryWebsocket=!1,a=new V2ClientSocket(this.core)),this.clientSocket=a,"v2"===this.core.options.apiVersion&&(this.core.clientSocket=a),this.lifeCycle=new V2NIMLoginLifeCycle(t),this.reconnect=new V2NIMLoginReconnect(t),this.lbs=new V2NIMLoginLbs(t),this.authenticator=new V2NIMLoginAuthenticator(t),this.dataSync=new V2NIMLoginDataSync(t)}setOptions(t){validate({lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},t,"",!0),this.config=assignOptions(this.config,t);var o="",a="";this.config.isFixedDeviceId?(o=ai.localStorage.getItem("__NIM_DEVC_ID__")||Ai(),a=ai.localStorage.getItem("__NIM_CLIENT_SESSION_ID__")||Ai(),ai.localStorage.setItem("__NIM_DEVC_ID__",o),ai.localStorage.setItem("__NIM_CLIENT_SESSION_ID__",a)):(o=Ai(),a=Ai()),this.deviceId=o,this.clientSession=a,this.core.reporter.setConfig({common:{dev_id:o}})}reset(){this.account="",this.token="",this.processId="",this.lbs.reset(),this.reconnect.reset(),this.authenticator.reset(),this.authenticator.clearLastLoginClient(),this.dataSync.reset()}login(t,o,a={}){return __awaiter(this,void 0,void 0,(function*(){if(this._checkApiVersion(),!t)throw new ValidateErrorV2({detail:{reason:"Empty account"}});if(validate({retryCount:{type:"number",min:0,required:!1},forceMode:{type:"boolean",required:!1},authType:{type:"enum",values:getEnumValues(Ke),required:!1},syncLevel:{type:"enum",values:getEnumValues(xe),required:!1}},a,"",!0),0===a.authType&&!o)throw new ValidateErrorV2({detail:{reason:"When authType is 0, token cannot be empty"}});if(""!==this.previousLoginAccount&&this.previousLoginAccount!==t&&this.core._clearModuleData(),this.getLoginStatus()===We.V2NIM_LOGIN_STATUS_LOGOUT)this.logger.log(`V2NIMLoginService::login:allowLogin:${t}`,a);else{if(this.getLoginStatus()===We.V2NIM_LOGIN_STATUS_LOGINED)return this.smoothForLogined(t,o,a);if(this.getLoginStatus()===We.V2NIM_LOGIN_STATUS_LOGINING)return this.smoothForLogining(t,o,a)}this.account=t,this.previousLoginAccount=t,this.token=o,this.processId=Ai(),this.loginOption=assignOptions(Mo,a),this.kickedDetail=null,this.loginTimerManager.destroy(),this.loginTimerManager.addTimer((()=>{var t=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_TIMEOUT,detail:{reason:"Login API timeout"}});this.doLoginStepsManager.clear(t),this.previousLoginManager.clear(t),this.originLoginPromise=void 0,this.lifeCycle.processEvent("exited",t)}),this.loginOption.timeout>0?this.loginOption.timeout:6e4,1);try{yield this.multiTryDoLogin(),this.loginTimerManager.destroy()}catch(t){throw this.loginTimerManager.destroy(),t}}))}getChatroomLinkAddress(t,o){return __awaiter(this,void 0,void 0,(function*(){validate({roomId:{type:"string",regExp:/^\d+$/,required:!0,allowEmpty:!1},miniProgram:{type:"boolean",required:!1}},{roomId:t,miniProgram:o},"",!0);var a="unknow environment"!==getMiniappEnv();return o=void 0===o?a:o,(yield this.clientSocket.sendCmd("v2GetChatroomLinkAddress",{roomId:t,miniProgram:o})).content.linkAddress}))}multiTryDoLogin(t){return __awaiter(this,void 0,void 0,(function*(){for(var o=new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"loginFailed"}}),a=0;a<=this.loginOption.retryCount;a++){var c=`V2NIMLoginService::times of login try: ${a}`;a>0?this.logger.warn(c):this.logger.log(c);try{this.originLoginPromise=t||this.doLogin(!1),t=void 0;var m=yield this.previousLoginManager.add(this.originLoginPromise);return this.core.reporter.reportTraceEnd("login",!0),this.doLoginStepsManager.clear(),this.previousLoginManager.clear(),this.originLoginPromise=void 0,m}catch(t){if(o=t||o,this.logger.error(`V2NIMLoginService::login failed, times of login try: ${a}, err.code: ${null==o?void 0:o.code}, err.message: "${null==o?void 0:o.message}"`),o.code!==wt.V2NIM_ERROR_CODE_CANCELLED&&this.core.reporter.reportTraceEnd("login",!1),this.reconnect.clearReconnectTimer(),this.checkLoginTerminalCode(o&&o.code))throw this.lifeCycle.processEvent("exited",o),o;o&&399===o.code&&this.lbs.reset()}}throw this.lifeCycle.processEvent("exited",o),o}))}doLogin(t){return __awaiter(this,void 0,void 0,(function*(){var o=!!t||this.authenticator.checkAutoLogin(this.loginOption.forceMode);this.core.reporter.reportTraceCancel("login"),this.core.reporter.reportTraceStart("login",o?{user_id:this.account,action:"auto_login",process_id:this.processId,binary_websocket:this.binaryWebsocket}:{user_id:this.account,action:"manual_login",process_id:this.processId,binary_websocket:this.binaryWebsocket}),this.core.reporter.reportTraceUpdateV2("login",{code:0,description:JSON.stringify(this.loginOption),operation_type:"conf_init",succeed:!0,duration:0,target:""},{asyncParams:ai.net.getNetworkStatus()});var a=yield this.doLoginStepsManager.add(this.lbs.getLbsInfos());yield this.doLoginStepsManager.add(this.clientSocket.connect(a,t));var c=yield this.doLoginStepsManager.add(this.authenticator.verifyAuthentication(o));this.lifeCycle.processEvent("loginSucc",void 0,Object.assign(Object.assign({},c),{isReconnect:t})),this.processId=Ai(),this.clientSocket.resetSocketConfig(),this.reconnect.reset(),this.clientSocket.ping(),this.core.abtest.abtRequest(),this.core.V2NIMClientAntispamUtil.downloadLocalAntiSpamVocabs();try{yield this.core.cloudStorage.init()}catch(t){this.logger.warn("doLogin::cloudStorage init error",t)}return c}))}smoothForLogined(t,o,a){return __awaiter(this,void 0,void 0,(function*(){var c=this.checkIsSameLogin(t,o,a);return this.logger.warn(`V2NIMLoginService::smoothForLogined:Logined, isSameLogin ${c}`),c?void 0:(yield this.logout(),this.login(t,o,a))}))}smoothForLogining(t,o,a){return __awaiter(this,void 0,void 0,(function*(){var c=this.checkIsSameLogin(t,o,a);if(this.logger.warn(`V2NIMLoginService::smoothForLogining:Logining progress exists, abort the previous login attempt and start next attempt, isSameLogin ${c}`),this.previousLoginManager.clear(),this.reconnect.reset(),this.account=t,this.previousLoginAccount=t,this.token=o,this.loginOption=assignOptions(this.loginOption,a),!c)return this.doLoginStepsManager.clear(),this.clientSocket.doDisconnect(Tn.ACTIVE,"Aborted"),this.reset(),this.lifeCycle.processEvent("logout"),yield Promise.resolve(),this.login(t,o,a);if(!this.originLoginPromise)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"NoPreviousLoginExists"}});this.reconnect.reset(),yield Promise.resolve(),yield this.multiTryDoLogin(this.originLoginPromise)}))}checkIsSameLogin(t,o,a){return this.account===t&&this.loginOption.authType===a.authType&&(a.authType!==Ke.V2NIM_LOGIN_AUTH_TYPE_DEFAULT||this.token===o)}logout(){return __awaiter(this,void 0,void 0,(function*(){this._checkApiVersion(),this.doLoginStepsManager.clear(),this.previousLoginManager.clear(),this.loginTimerManager.destroy(),this.originLoginPromise=void 0;var t=this.getConnectStatus(),o=this.getLoginStatus();switch(o){case We.V2NIM_LOGIN_STATUS_LOGINED:try{yield this.clientSocket.sendCmd("v2Logout",void 0,{timeout:1e3}),this.clientSocket.doDisconnect(Tn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout")}catch(t){this.logger.error("Instance::disconnect sendCmd:logout error",t),this.clientSocket.doDisconnect(Tn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout")}break;case We.V2NIM_LOGIN_STATUS_LOGINING:case We.V2NIM_LOGIN_STATUS_UNLOGIN:this.clientSocket.doDisconnect(Tn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout");break;case We.V2NIM_LOGIN_STATUS_LOGOUT:throw this.core._clearModuleData(),new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:`Illegal logout. loginStatus ${o}. connectStatus ${t}`}});default:throw this.core._clearModuleData(),new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:`Illegal logout. illegal status: loginStatus ${o}. connectStatus ${t}`}})}}))}getConnectStatus(){return this.lifeCycle.getConnectStatus()}getLoginStatus(){return this.lifeCycle.getLoginStatus()}getLoginUser(){return this.account}getLoginClients(){return fo(this.authenticator.loginClients,"clientId")}getDataSync(){var t=this.dataSync.datas;return t&&t.length>0?t.map((t=>({type:t.type,state:t.state}))):null}setReconnectDelayProvider(t){this.reconnect._setReconnectDelayProvider(t)}kickOffline(t){return __awaiter(this,void 0,void 0,(function*(){this._checkApiVersion(),validate({clientId:{type:"string",allowEmpty:!1}},t,"",!0);var o=yield this.clientSocket.sendCmd("v2KickOffline",{clientIds:[t.clientId]});if(0===Ue(o,"content.clientIds.length"))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_REQUEST_FAILED})}))}getKickedOfflineDetail(){return this.kickedDetail}checkLoginTerminalCode(t){return this.authenticator.checkLoginTerminalCode(t)}checkIllegalState(){if(!this.getLoginUser())throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_ILLEGAL_STATE})}_checkApiVersion(){if("v2"!==this.core.options.apiVersion)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:'apiVersion is not "v2"'}})}v2LoginHandler(t){if(t.error)throw this.clientSocket.doDisconnect(Tn.ACTIVE,t.error),t.error;return t}v2LoginClientChangeHandler(t){this.authenticator.changeLoginClient(parseInt(t.content.state),t.content.datas)}nimLoginClientChangeHandler(t){this.authenticator.changeLoginClient(parseInt(t.content.state),t.content.datas)}qchatLoginClientChangeHandler(t){var o=parseInt(t.content.state);o=1===o?Qe.V2NIM_LOGIN_CLIENT_CHANGE_LOGIN:Qe.V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT,this.authenticator.changeLoginClient(o,[t.content.data])}v2BeKickedHandler(t){if(t.error)this.core.logger.error("v2BeKickedHandler error, ",t.error);else{var o=function formatBeKickedTag(t){return format({reason:{type:"number"},clientType:{type:"number"},customClientType:{type:"number"}},t)}(t.content);this.core.logger.warn("v2Bekicked::",o),this.kickedDetail=o,this.clientSocket.doDisconnect(Tn.KICKED,o),this.core._clearModuleData(),this.lifeCycle.processEvent("kicked",new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"disconnect due to kicked"}}),o),this.emit("onKickedOffline",o)}}}var yo={"5_1":"sync"},So={sync:{sid:5,cid:1,service:"sync",hasPacketTimer:!1,params:[{type:"Property",name:"sync",reflectMapper:{myInfo:1,offlineMsgs:2,teams:3,roamingMsgs:7,relations:9,friends:11,friendUsers:13,msgReceipts:14,myTeamMembers:15,donnop:16,recallMsg:17,sessionAck:18,broadcastMsgs:20,avSignal:21,superTeams:22,mySuperTeamMembers:23,superTeamRoamingMsgs:24,deleteSuperTeamMsg:25,superTeamSessionAck:26,deleteSelfMsgs:27,stickTopSessions:28,sessionHistoryMsgsDelete:29}}],response:[{type:"Long",name:"timetag"}]}};class SyncService extends class Service{constructor(t,o){this.name=t,this.core=o,this.name=t,this.logger=o.logger,this.core=o}process(t){var o=this[t.cmd+"Handler"];if("function"==typeof o)return o.call(this,t);var a=Ue(t,"error.detail.ignore");return t.error&&!a?Promise.reject(t.error):Promise.resolve(t)}}{constructor(t,o={}){super("sync",t),this.syncDoneFlag=!1,this.config={myInfo:!!t.user.name,offlineMsgs:!!t.msg.name,teams:!!t.team.name,myTeamMembers:!!t.team.name,roamingMsgs:!!t.msg.name,relations:!!t.user.name,friends:!!t.friend.name,friendUsers:!!t.user.name,msgReceipts:!!t.msg.name,broadcastMsgs:!!t.msg.name,recallMsg:!!t.msg.name,sessionAck:!!t.session.name,superTeamSessionAck:!!t.session.name,superTeams:!!t.superTeam.name,mySuperTeamMembers:!!t.superTeam.name,superTeamRoamingMsgs:!!t.superTeam.name,deleteSuperTeamMsg:!!t.superTeam.name,deleteSelfMsgs:!!t.msg.name,sessionHistoryMsgsDelete:!!t.msgLog.name,avSignal:!!t.signaling.name},this.setOptions(o),this.timetags={},this.initEventListeners(),registerParser({cmdMap:yo,cmdConfig:So})}setOptions(t){Object.assign(this.config,t)}reset(){this.timetags={},this.syncDoneFlag=!1}getSyncDoneFlag(){return this.syncDoneFlag}doSync(){var t;return __awaiter(this,void 0,void 0,(function*(){var o=this.genSyncParams();this.logger.log("sync::doSyncV1: ",o);try{var a=yield this.core.clientSocket.sendCmd("sync",{sync:o});this.core.logger.log("sync::doSyncV1 done in",null===(t=a.content)||void 0===t?void 0:t.timetag),this.syncDoneFlag=!0,this.core.emit("syncdone")}catch(t){return this.core.logger.error("sync::doSyncV1 error",t),this.syncDoneFlag=!0,void this.core.emit("syncdone")}}))}initEventListeners(){this.core.eventBus.on("logined",(()=>{this.syncDoneFlag=!1,this.doSync()})),this.core.eventBus.on("sync/updateTimetag",(t=>{Object.keys(t).forEach((o=>{t[o]>(this.timetags[o]||0)&&(this.timetags[o]=t[o])}))}))}genSyncParams(){return Object.keys(this.config).filter((t=>{var o=t;return this.config[o]})).reduce(((t,o)=>{var a=o;return t[a]=this.timetags[a]||0,t}),{})}handleImmediate(t){return this.core.session&&this.core.session.onSyncDone&&this.core.session.onSyncDone(),Promise.resolve(t)}delaySyncDone(t){return"ALI"===getMiniappEnv()?(this.core.logger.log("sync: emit ALIAPP sycnHandler, handle later"),new Promise((o=>{setTimeout((()=>{this.handleImmediate(t).then((()=>{o(t)}))}),100)}))):this.handleImmediate(t)}syncHandler(t){return this.delaySyncDone(t)}}var No,Co,Ao=["error","warn","log","debug"],emptyFunc=function(){},Oo=["off","error","warn","log","debug"];class Logger{constructor(t){this.strategies={debug:{name:"debug",func:console.log},log:{name:"  log",func:console.log},warn:{name:" warn",func:console.warn},error:{name:"error",func:console.error}},this.debug=emptyFunc,this.log=emptyFunc,this.warn=emptyFunc,this.error=emptyFunc,Oo.includes(t)||(t="off"),this.setLogFunc(t)}setLogFunc(t){var o=Ao.findIndex((o=>o===t));Ao.forEach(((t,a)=>{a<=o&&(this[t]=function(){var o=Array.prototype.slice.call(arguments),a=this.strategies[t],c=this.formatArgs(o,a.name);a.func(c)})}))}formatArgs(t,o){var a=new Date;return`[NIM ${o} ${`${a.getMonth()+1}-${a.getDate()} ${a.getHours()}:${a.getMinutes()}:${a.getSeconds()}:${a.getMilliseconds()}`}] `+t.map((t=>t instanceof V2NIMErrorImpl?t.toString():t instanceof Error?t&&t.message?t.message:t:"object"==typeof t?JSON.stringify(t):t)).join(" ")}destroy(){this.debug=emptyFunc,this.log=emptyFunc,this.warn=emptyFunc,this.error=emptyFunc}}class CoreAdapters{constructor(t){this.lastCommonHost="",this.core=t}getFileUploadInformation(t){return ai.getFileUploadInformation(t)}request(t,o,a){var c=(new Date).getTime(),m=(null==a?void 0:a.exception_service)||0;return ai.request(t,o).catch((a=>{var h,g,_,I,E=a;throw this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account||(null===(g=null===(h=this.core)||void 0===h?void 0:h.auth)||void 0===g?void 0:g.account),trace_id:null===(I=null===(_=this.core.clientSocket)||void 0===_?void 0:_.socket)||void 0===I?void 0:I.sessionId,start_time:c,action:1,exception_service:m}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof E.code?E.code:0,description:E.message||`${E.code}`,operation_type:0,target:t,context:o?JSON.stringify(o):""},{asyncParams:ai.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1),a}))}uploadFile(t){var o,a,c,m;return __awaiter(this,void 0,void 0,(function*(){for(var h=t.commonUploadHostBackupList.indexOf(t.commonUploadHost),g=-1===h?[t.commonUploadHost,...t.commonUploadHostBackupList]:[t.commonUploadHost,...t.commonUploadHostBackupList.slice(0,h),...t.commonUploadHostBackupList.slice(h+1)],_=Math.max(g.indexOf(this.lastCommonHost),0),I="BROWSER"===ai.platform?1:g.length,E=null,T=0;T<I;T++){var M=(new Date).getTime();this.lastCommonHost=g[(T+_)%g.length];try{return yield ai.uploadFile(Object.assign(Object.assign({},t),{commonUploadHost:this.lastCommonHost}))}catch(h){E=h;var S=h;this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account||(null===(a=null===(o=this.core)||void 0===o?void 0:o.auth)||void 0===a?void 0:a.account),trace_id:null===(m=null===(c=this.core.clientSocket)||void 0===c?void 0:c.socket)||void 0===m?void 0:m.sessionId,start_time:M,action:1,exception_service:3});var N="BROWSER"===ai.platform?t.chunkUploadHost:`${this.lastCommonHost}/${t.nosToken&&t.nosToken.bucket}`;this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof S.code?S.code:0,description:S.message||`${S.code}`,operation_type:1,target:N},{asyncParams:ai.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1)}}throw E}))}}class ABTest{constructor(t,o){this.abtInfo={},this.core=t,this.config=assignOptions({isAbtestEnable:!0,abtestUrl:an,abtestProjectKey:"imElite_sdk_abtest_web"},o)}setOptions(t){this.config=assignOptions(this.config,t)}abtRequest(){var t,o;return __awaiter(this,void 0,void 0,(function*(){if(this.config.isAbtestEnable&&!this.abtInfo.experiments&&this.config.abtestUrl){var a;try{a=yield this.core.adapters.request(this.config.abtestUrl,{method:"POST",dataType:"json",headers:{sdktype:"ABTest"},data:{clientInfo:{projectKey:this.config.abtestProjectKey,appKey:this.core.options.appkey,osType:"Web",sdkVersion:"10.4.0",deviceId:this.core.config.deviceId},useLocalCache:!0}},{exception_service:7})}catch(t){this.core.logger.warn("ABTest request failed")}this.abtInfo=(null===(o=null===(t=null==a?void 0:a.data)||void 0===t?void 0:t.data)||void 0===o?void 0:o.abtInfo)||{}}}))}}!function(t){t[t.Android=1]="Android",t[t.iOS=2]="iOS",t[t.PC=4]="PC",t[t.WindowsPhone=8]="WindowsPhone",t[t.Web=16]="Web",t[t.Server=32]="Server",t[t.Mac=64]="Mac",t[t.HarmonyOS=65]="HarmonyOS"}(No||(No={})),function(t){t.Destroy="destroy",t.Logout="logout"}(Co||(Co={}));var Ro={user_id:"",trace_id:"",action:7,exception_service:6,duration:0,start_time:0,state:1,extension:[]};class ReporterHookLinkKeep{constructor(t,o){this.traceData=Ro,this.core=t,this.traceData=Object.assign({},Ro,o),this.traceData.extension=[]}reset(){this.traceData=Object.assign({},Ro),this.traceData.extension=[]}start(){var t,o;this.reset(),this.traceData.user_id=this.core.account,this.traceData.trace_id=(null===(o=null===(t=this.core.clientSocket)||void 0===t?void 0:t.socket)||void 0===o?void 0:o.sessionId)||"",this.traceData.start_time=(new Date).getTime()}update(t){return __awaiter(this,void 0,void 0,(function*(){var{net_type:o,net_connect:a}=yield ai.net.getNetworkStatus();this.traceData.extension.push(Object.assign({code:0,foreground:!0,foreg_backg_switch:!1,net_type:o,net_connect:a},t))}))}end(t){var o=this.traceData.extension[0],a=this.traceData.extension[1];if(o&&0===o.operation_type&&a&&1===a.operation_type){var c=o.net_type!==a.net_type||o.net_connect!==a.net_connect;if(t||!c)return this.traceData.duration=(new Date).getTime()-this.traceData.start_time,this.core.reporter.report("exceptions",this.traceData),void this.reset();this.reset()}else this.reset()}}var bo={user_id:"",trace_id:"",net_connect:!0,net_type:0,duration:0,start_time:0,history:[],succeed:!1};class ReporterHookLBS{constructor(t){this.traceData=bo,this.core=t,this.reset()}reset(){this.traceData=Object.assign({},bo),this.traceData.history=[]}start(t){this.reset(),this.traceData.user_id=t,this.traceData.start_time=Date.now()}updateBegin(t){this.traceData.history.push(Object.assign({head:"",body:"",start_time:Date.now(),httpdns:!1,index:0},t))}updateComplete(t){this.traceData.history.forEach((o=>{o.target===t.target&&(Object.assign(o,t),o.duration=Date.now()-o.start_time)}))}end(t){return __awaiter(this,void 0,void 0,(function*(){if(this.traceData.succeed=t,this.traceData.history=this.traceData.history.filter((t=>void 0!==t.code)),0!==this.traceData.history.length){this.traceData.duration=Date.now()-this.traceData.start_time;var{net_type:o,net_connect:a}=yield ai.net.getNetworkStatus();this.traceData.net_type=o,this.traceData.net_connect=a,this.core.reporter.report("nim_sdk_lbs_records",this.traceData),this.reset()}else this.reset()}))}}var Vo={user_id:"",trace_id:"",action:0,state:0,duration:0,start_time:0,offset:0,full_size:0,transferred_size:0,operation_type:0,remote_addr:""},Po="ReporterHook::setMonitorForResources:";class ReporterHookCloudStorage{constructor(t,o){this.traceData=Vo,this.core=t,this.traceData=Object.assign({},Vo,o)}reset(){this.traceData=Object.assign({},Vo)}start(){var t,o;this.reset(),this.traceData.user_id=this.core.account,this.traceData.trace_id=(null===(o=null===(t=this.core.clientSocket)||void 0===t?void 0:t.socket)||void 0===o?void 0:o.sessionId)||"",this.traceData.start_time="timeOrigin"in this.core?this.core.timeOrigin.getNTPTime():Date.now()}update(t){return __awaiter(this,void 0,void 0,(function*(){this.traceData.user_id&&(this.core.logger.log(`${Po} upload update`,t),Object.assign(this.traceData,t))}))}end(t){this.traceData.user_id&&(this.core.logger.log(`${Po} upload end cause of ${t}`),this.traceData.state=t,this.traceData.duration=("timeOrigin"in this.core?this.core.timeOrigin.getNTPTime():Date.now())-this.traceData.start_time,this.core.reporter.report("nim_sdk_resources",this.traceData),this.traceData=Vo)}}function getIsDataReportEnable(t){var o,a,c=!0;return"boolean"==typeof(null===(o=null==t?void 0:t.reporterConfig)||void 0===o?void 0:o.enableCompass)?c=t.reporterConfig.enableCompass:"boolean"==typeof(null===(a=null==t?void 0:t.reporterConfig)||void 0===a?void 0:a.isDataReportEnable)&&(c=t.reporterConfig.isDataReportEnable),c}function getReportConfigUrl(t){var o,a,c="https://statistic.live.126.net/dispatcher/req";return"string"==typeof(null===(o=null==t?void 0:t.reporterConfig)||void 0===o?void 0:o.compassDataEndpoint)?((c=t.reporterConfig.compassDataEndpoint).endsWith("/")&&(c=c.slice(0,-1)),c+="/dispatcher/req"):"string"==typeof(null===(a=null==t?void 0:t.reporterConfig)||void 0===a?void 0:a.reportConfigUrl)&&(c=t.reporterConfig.reportConfigUrl),c}function getReportUrl(t){var o,a,c="https://statistic.live.126.net/statics/report/common/form";return"string"==typeof(null===(o=null==t?void 0:t.reporterConfig)||void 0===o?void 0:o.compassDataEndpoint)?((c=t.reporterConfig.compassDataEndpoint).endsWith("/")&&(c=c.slice(0,-1)),c+="/statics/report/common/form"):"string"==typeof(null===(a=null==t?void 0:t.reporterConfig)||void 0===a?void 0:a.reportUrl)&&(c=t.reporterConfig.reportUrl),c}var ko={},Lo={},Do={},wo={apiVersion:"v1",debugLevel:"off",needReconnect:!0,reconnectionAttempts:Number.MAX_SAFE_INTEGER,lbsUrls:sn,linkUrl:"weblink.netease.im:443",abtestUrl:an,isAbtestEnable:!0};class NIM$1 extends o{constructor(t,c={}){super(),this.instanceName="NIM",this.pluginMap={},this.eventBus=new o,this.options={},this.V2NIMConversationIdUtil={},this.V2NIMMessageCreator={},this.V2NIMMessageAttachmentCreator={},this.V2NIMClientAntispamUtil={},this.DataStructureConverter={},this.V2NIMMessageConverter={},this.V2NIMMessageLogUtil={},this.V2NIMMessageExtendUtil={},this.V2NIMStorageUtil={},this.V2NIMNotificationService={},this.V2NIMStorageService={},this.V1NIMLoginService={},this.V2NIMLoginService={},this.clientSocket={},this.V2NIMSyncService={},this.V2NIMConversationService={},this.V2NIMConversationGroupService={},this.V2NIMMessageService={},this.V2NIMTeamService={},this.V2NIMUserService={},this.V2NIMFriendService={},this.V2NIMSettingService={},this.V2NIMAIService={},this.V2NIMSignallingService={},this.V2NIMSubscriptionService={},this.offlinePush={},this.sync={},this.msg={},this.msgLog={},this.session={},this.cloudSession={},this.misc={},this.user={},this.friend={},this.systemMessage={},this.team={},this.event={},this.msgExtend={},this.cloudStorage={},this.passThrough={},this.superTeam={},this.plugin={},this.signaling={},this.qchatChannel={},this.qchatMedia={},this.qchatMsg={},this.qchatRole={},this.qchatServer={},this.pluginMap=Do,this.logger=new Logger(t.debugLevel),this.setInitOptions(t),this.otherOptions=Object.assign(Object.assign({},c),{cloudStorageConfig:Object.assign({storageKeyPrefix:"NIM"},c.cloudStorageConfig)}),this.timerManager=new TimerManager,this.timeOrigin=new TimeOrigin(this),this.adapters=new CoreAdapters(this),this.abtest=new ABTest(this,{isAbtestEnable:this.options.isAbtestEnable,abtestUrl:this.options.abtestUrl,abtestProjectKey:"imElite_sdk_abtest_web"});var m=ai.getSystemInfo();this.reporter=new a({reportConfigUrl:getReportConfigUrl(c),reportUrl:getReportUrl(c),isDataReportEnable:getIsDataReportEnable(c),common:{app_key:t.appkey,dev_id:"",platform:"Web",sdk_ver:"10.4.0",env:"online",os_name:m.os,os_ver:m.osVer,lib_env:m.libEnv,host_env:m.hostEnv,host_env_ver:m.hostEnvVer,manufactor:m.manufactor,model:m.model,v2:"v1"!==this.options.apiVersion},request:ai.request,logger:this.logger,autoStart:!0}),this.reporterHookLinkKeep=new ReporterHookLinkKeep(this),this.reporterHookCloudStorage=new ReporterHookCloudStorage(this),this.reporterHookLBS=new ReporterHookLBS(this),ai.setLogger(this.logger),"v1"===this.options.apiVersion?this.auth=new V1NIMLoginServiceImpl(this,this.options):this.auth=new V2NIMLoginServiceImpl(this,this.otherOptions.V2NIMLoginServiceConfig),Object.keys(ko).filter((t=>"V1NIMLoginService"!==t&&"V2NIMLoginService"!==t&&"sync"!==t)).forEach((t=>{var o=ko[t];this[t]=new o(this)})),ko.sync&&(this.sync=new SyncService(this,this.otherOptions.syncOptions)),Object.keys(ko).forEach((t=>{var o=`${t}Config`,a=this.otherOptions[o]||{},c=Ue(this,`${t}.setOptions`);"function"==typeof c&&("cloudStorage"===t&&(a=this.otherOptions[o]||this.otherOptions.serverConfig||{}),c.call(this[t],a))})),Object.keys(Lo).forEach((t=>{var o=Lo[t];void 0!==o&&(this[t]=new o(this))})),NIM$1.instance=this,this.logger.log("NIM init, version ","10.4.0"," sdk version ",100400," appkey ",t.appkey)}static getInstance(t,o){if(!NIM$1.instance){if(t)return new NIM$1(t,o);throw new Error("Instance not exist, please input options")}if(t){if(NIM$1.instance.options.account===t.account&&NIM$1.instance.options.appkey===t.appkey)return NIM$1.instance.setOptions(t),NIM$1.instance;throw new Error("Unexpected login")}return NIM$1.instance}setInitOptions(t){validate({appkey:{type:"string"},apiVersion:{type:"enum",values:["v1","v2"],required:!1},binaryWebsocket:{type:"boolean",required:!1},needReconnect:{type:"boolean",required:!1},reconnectionAttempts:{type:"number",required:!1},customClientType:{type:"number",min:1,required:!1},authType:{type:"number",min:0,max:2,required:!1},lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},t),this.logger.log("NIM::setInitOptions options is",t),this.options=Object.assign(Object.assign({},wo),t)}connect(t={}){return this.V1NIMLoginService.login(t)}setOptions(t){if("object"==typeof t&&null!==t){if(Object.prototype.hasOwnProperty.call(t,"account")&&t.account!==this.options.account||Object.prototype.hasOwnProperty.call(t,"appkey")&&t.appkey!==this.options.appkey)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions account and appkey is not allowed to reset"}});if(Object.prototype.hasOwnProperty.call(t,"apiVersion")&&t.apiVersion!==this.options.apiVersion)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions apiVersion is not allowed to reset"}});if(Object.prototype.hasOwnProperty.call(t,"binaryWebsocket")&&t.binaryWebsocket!==this.options.binaryWebsocket)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions binaryWebsocket is not allowed to reset"}});validate({token:{type:"string",required:!1},needReconnect:{type:"boolean",required:!1},reconnectionAttempts:{type:"number",required:!1},customClientType:{type:"number",min:1,required:!1},authType:{type:"number",min:0,max:2,required:!1},lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},t),this.logger.log("NIM::setOptions options is",t),this.options=Object.assign(Object.assign({},this.options),t),this.V1NIMLoginService.setOptions&&this.V1NIMLoginService.setOptions(this.options)}}disconnect(){return this.V1NIMLoginService.logout()}_disconnect(){return"v1"===this.options.apiVersion?this.V1NIMLoginService.logout():"v2"===this.options.apiVersion?Ue(this.V2NIMLoginService,"lifeCycle.connectStatus")===Ze.V2NIM_CONNECT_STATUS_DISCONNECTED&&Ue(this.V2NIMLoginService,"lifeCycle.loginStatus")===We.V2NIM_LOGIN_STATUS_LOGOUT?Promise.resolve():this.V2NIMLoginService.logout():Promise.resolve()}destroy(){return NIM$1.instance=void 0,this._disconnect().then((()=>{this.status="destroyed",this.removeAllListeners(),this.eventBus.removeAllListeners(),this.logger.destroy(),this.reporter.destroy(),this.timerManager.destroy(),this._clearModuleData(Co.Destroy),this._removeAllModuleListeners(),this.connect=emptyFuncWithPromise,this.disconnect=emptyFuncWithPromise,this._disconnect=emptyFuncWithPromise,this.destroy=emptyFuncWithPromise}))}_clearModuleData(t=Co.Logout){Object.values(this).forEach((o=>{o&&"function"==typeof o.reset&&o.reset(t)}))}_removeAllModuleListeners(){Object.values(this).forEach((t=>{t&&"function"==typeof t.removeAllListeners&&t.removeAllListeners()}))}kick(t){return this.V1NIMLoginService.kick(t)}sendCmd(t,o,a){return this.clientSocket.sendCmd(t,o,a)}emit(t,...o){try{var a=Date.now(),c=super.emit(t,...o),m=Date.now()-a;return m>=10&&this.logger.warn(`Core::emit event: ${t} process takes: ${m}ms`),c}catch(o){return this.logger.error(`Core::emit event: ${t}. Error: ${o}`),setTimeout((()=>{throw this.logger.error(`Core::emit throw error in setTimeout. event: ${t}. Error: ${o}`),o}),0),!1}}get account(){return this.auth.account}get status(){return this.V1NIMLoginService.status}set status(t){this.V1NIMLoginService.status=t}get config(){return{timeout:8e3,deviceId:this.auth.deviceId}}static registerService(t,o){ko[o]=t}static registerPrivateService(t,o){Lo[o]=t}static registerPlugin(t,o){Do[o]=t}}var Uo={"27_1":"v2NIMSync","27_10":"v2QChatSync"},xo={v2NIMSync:{sid:27,cid:1,service:"V2NIMSyncService",hasPacketTimer:!1,params:[{type:"Property",name:"tag",reflectMapper:{myInfo:1,offlineMsgs:2,teams:3,roamingMsgs:7,relations:9,friends:11,friendUsers:13,msgReceipts:14,myTeamMembers:15,donnop:16,recallMsg:17,sessionAck:18,broadcastMsgs:20,avSignal:21,superTeams:22,mySuperTeamMembers:23,superTeamRoamingMsgs:24,deleteSuperTeamMsg:25,superTeamSessionAck:26,deleteSelfMsgs:27,stickTopSessions:28,sessionHistoryMsgsDelete:29,p2pTeamModifyMessage:30,superTeamModifyMessage:31}}],response:[{type:"Long",name:"timetag"}]},v2QChatSync:{sid:27,cid:10,service:"V2NIMSyncService",hasPacketTimer:!1,params:[{type:"Property",name:"tag",reflectMapper:{systemNotification:1,pushConfig:2}}],response:[{type:"Long",name:"timetag"}]}};class V2NIMConversationModelImpl{constructor(){this.map=new Map,this.readTimeMap=new Map}set(t){t.forEach((t=>{t=this.processConversation(t),this.map.set(t.conversationId,t)}))}reset(){this.map.clear()}count(){return this.map.size}sort(){var t=Array.from(this.map.values());t.sort(((t,o)=>o.sortOrder-t.sortOrder)),this.map.clear(),t.forEach((t=>{this.map.set(t.conversationId,t)}))}processConversation(t){return"string"==typeof t.lastMessage&&delete t.lastMessage,void 0===t.localExtension&&(t.localExtension=""),t}getById(t){return this.map.get(t)}getAll(){return Array.from(this.map.values()).sort(((t,o)=>o.sortOrder-t.sortOrder))}getByOption(t,o,a){var{conversationTypes:c,onlyUnread:m,conversationGroupIds:h}=a,g=[];this.map.forEach((t=>{if((!(c&&c.length>0)||c.includes(t.type))&&(!m||t.unreadCount)&&(!a.ignoreMuted||!t.mute)){if(h){var o=t.groupIds,_=(null==o?void 0:o.length)||0;if(0===h.length&&_>0)return;if(h.length>0&&0===_)return;if(h.length>0&&_>0&&!h.some((t=>o&&o.includes(t))))return}g.push(t)}})),g=g.sort(((t,o)=>o.sortOrder-t.sortOrder));var _=0;t>0&&(_=findIndexWithinTargetValue(g,"sortOrder",t),g[_]&&g[_].sortOrder===t&&(_+=1));var I=g.slice(_).length;return(g=g.slice(_,_+o)).length>0?{offset:I>o?g[g.length-1].sortOrder:0,finished:!(I>o),conversationList:g}:{offset:0,finished:!0,conversationList:g}}upsert(t){var o=t.conversationId,a=this.map.get(o);if(!a)return t=this.processConversation(Object.assign({},t)),this.map.set(o,t),t.unreadCount>0;var c=t.unreadCount!==a.unreadCount,m=Object.assign({},a,t);return m=this.processConversation(m),this.map.set(o,m),c}bulkUpsert(t){var o=!1;return t.forEach((t=>{this.upsert(t)&&(o=!0)})),o}deleteById(t){var o=this.getById(t);if(o)return this.map.delete(t),o}updateReadTime(t,o){this.readTimeMap.set(t,o)}getReadTime(t){return this.readTimeMap.get(t)||0}}class V2NIMConversationIdUtilImpl{constructor(t){this.core=t}p2pConversationId(t){return`${this.core.account}|${Be.V2NIM_CONVERSATION_TYPE_P2P}|${t}`}teamConversationId(t){return`${this.core.account}|${Be.V2NIM_CONVERSATION_TYPE_TEAM}|${t}`}superTeamConversationId(t){return`${this.core.account}|${Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM}|${t}`}messageConversationId(t){return t.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P?t.senderId===this.core.account?this.p2pConversationId(t.receiverId):this.p2pConversationId(t.senderId):t.conversationType===Be.V2NIM_CONVERSATION_TYPE_TEAM?this.teamConversationId(t.receiverId):this.superTeamConversationId(t.receiverId)}parseConversationType(t){try{if(t&&t.startsWith(`${this.core.account}|`)){var o=t.replace(`${this.core.account}|`,"");return Number(o[0])}return this.core.logger.warn(`conversationId is not start with ${this.core.account}`),Be.V2NIM_CONVERSATION_TYPE_UNKNOWN}catch(t){return Be.V2NIM_CONVERSATION_TYPE_UNKNOWN}}parseConversationTargetId(t){try{return t&&t.startsWith(`${this.core.account}|`)?t.replace(`${this.core.account}|`,"").slice(2):(this.core.logger.warn(`conversationId is not start with ${this.core.account}`),"")}catch(t){return""}}convertToV1ConversationId(t){var o=this.parseConversationType(t),a=this.parseConversationTargetId(t);return`${o===Be.V2NIM_CONVERSATION_TYPE_P2P?"p2p":o===Be.V2NIM_CONVERSATION_TYPE_TEAM?"team":"superTeam"}|${a}`}}var Fo=function isEqual(t,o){return Qn(t,o)},Go={"31_1":"v2TeamCreate","32_1":"v2SuperTeamCreate","31_5":"v2TeamInviteMembers","32_5":"v2SuperTeamInviteMembers","31_6":"v2TeamKickMembers","32_6":"v2SuperTeamKickMembers","31_8":"v2TeamLeave","32_7":"v2SuperTeamLeave","31_7":"v2TeamUpdateInfo","32_8":"v2SuperTeamUpdateInfo","31_9":"v2TeamGetInfo","32_9":"v2SuperTeamGetInfo","31_12":"v2TeamDismiss","32_4":"v2SuperTeamDismiss","31_13":"v2TeamApplyToJoin","32_20":"v2SuperTeamApplyToJoin","31_14":"v2TeamAcceptJoinApplication","32_21":"v2SuperTeamAcceptJoinApplication","31_15":"v2TeamRejectJoinApplication","32_22":"v2SuperTeamRejectJoinApplication","31_16":"v2TeamAddManagers","32_26":"v2SuperTeamAddManagers","31_17":"v2TeamRemoveManagers","32_27":"v2SuperTeamRemoveManagers","31_18":"v2TeamTransferOwner","32_31":"v2SuperTeamTransferOwner","31_19":"v2TeamUpdateSelfMemberInfo","32_10":"v2SuperTeamUpdateSelfMemberInfo","31_20":"v2TeamUpdateMember","32_30":"v2SuperTeamUpdateMember","31_21":"v2TeamAcceptInvitation","32_23":"v2SuperTeamAcceptInvitation","31_22":"v2TeamRejectInvite","32_24":"v2SuperTeamRejectInvite","31_33":"v2TeamGetMemberInvitor","32_35":"v2SuperTeamGetMemberInvitor","31_25":"v2TeamMemberSetChatBannedStatus","32_29":"v2SuperTeamMemberSetChatBannedStatus","31_32":"v2TeamSetChatBannedMode","32_28":"v2SuperTeamSetChatBannedMode","31_34":"v2TeamGetByIds","32_36":"v2SuperTeamGetByIds","31_35":"v2TeamMemberGetListByIds","32_37":"v2SuperTeamMemberGetListByIds","31_36":"v2TeamMemberGetList","8_101":"v2TeamCreateMultiSync","8_109":"v2TeamSync","8_119":"v2TeamMemberUpdateMultiSync","8_126":"v2TeamMembersOfSelfInSync","21_101":"v2SuperTeamCreateMultiSync","21_109":"v2SuperTeamSync","21_110":"v2SuperTeamMemberUpdateMultiSync","21_111":"v2SuperTeamMembersOfSelfInSync"},Bo={antispamBusinessId:1},jo="V2NIMTeamService",Yo={teamId:1,name:3,teamType:{id:4,retConverter:t=>0==+t?1:+t},ownerAccountId:5,memberLimit:{id:6,retType:"number"},isValidTeam:{id:8,retConverter:(t,o)=>1==+t&&(void 0===o[13]||1==+o[13])},memberCount:{id:9,retType:"number"},memberUpdateTime:{id:10,retType:"number"},createTime:{id:11,retType:"number"},updateTime:{id:12,retType:"number"},intro:14,announcement:15,joinMode:{id:16,retType:"number"},serverExtension:18,customerExtension:19,avatar:20,agreeMode:{id:21,retType:"number"},inviteMode:{id:22,retType:"number"},updateInfoMode:{id:23,retType:"number"},updateExtensionMode:{id:24,retType:"number"},chatBannedMode:{id:101,retType:"number"}},Ho={teamId:1,accountId:3,memberRole:{id:4,retType:"number"},teamNick:5,bits:{id:7,retType:"number"},inTeam:{id:9,retType:"boolean"},joinTime:{id:10,retType:"number"},updateTime:{id:11,retType:"number"},serverExtension:12,chatBanned:{id:13,retType:"boolean"},invitorAccountId:14},$o={teamId:1,accountId:3,memberRole:{id:4,retType:"number"},teamNick:5,bits:{id:7,retType:"number"},inTeam:{id:9,retType:"boolean"},updateTime:{id:11,retType:"number"},serverExtension:12,chatBanned:{id:13,retType:"boolean"},invitorAccountId:14,joinTime:{id:15,retType:"number"}},qo={teamId:1,teamType:2,roleQueryType:3,onlyChatBanned:{id:4,converter:t=>+t},nextToken:5,limit:6,direction:7},zo={v2TeamCreate:{sid:31,cid:1,service:jo,params:[{type:"Property",name:"team",reflectMapper:Yo},{type:"StrArray",name:"inviteeAccountIds"},{type:"String",name:"postscript"},{type:"Property",name:"antispamConfig",reflectMapper:Bo}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Yo)},{type:"StrArray",name:"failedList"}]},v2SuperTeamCreate:{sid:32,cid:1,service:jo,params:[{type:"Property",name:"team",reflectMapper:Yo},{type:"StrArray",name:"inviteeAccountIds"},{type:"String",name:"postscript"},{type:"Property",name:"antispamConfig",reflectMapper:Bo}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Yo)},{type:"StrArray",name:"failedList"}]},v2TeamInviteMembers:{sid:31,cid:5,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"Long",name:"time"},{type:"StrArray",name:"abortedAccidList"}]},v2SuperTeamInviteMembers:{sid:32,cid:5,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"StrArray",name:"abortedAccidList"},{type:"Long",name:"time"}]},v2TeamUpdateInfo:{sid:31,cid:7,service:jo,params:[{type:"Property",name:"team",reflectMapper:Yo},{type:"Property",name:"antispamConfig",reflectMapper:Bo}],response:[{type:"Long",name:"teamId"},{type:"Long",name:"timestamp"}]},v2SuperTeamUpdateInfo:{sid:32,cid:8,service:jo,params:[{type:"Property",name:"team",reflectMapper:Yo},{type:"Property",name:"antispamConfig",reflectMapper:Bo}],response:[{type:"Long",name:"timestamp"}]},v2TeamLeave:{sid:31,cid:8,service:jo,params:[{type:"Long",name:"teamId"}]},v2SuperTeamLeave:{sid:32,cid:7,service:jo,params:[{type:"Long",name:"teamId"}]},v2TeamGetInfo:{sid:31,cid:9,service:jo,params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Yo)}]},v2SuperTeamGetInfo:{sid:32,cid:9,service:jo,params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Yo)}]},v2TeamGetByIds:{sid:31,cid:34,service:jo,params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:invertSerializeItem(Yo)},{type:"LongArray",name:"tids"}]},v2SuperTeamGetByIds:{sid:32,cid:36,service:jo,params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:invertSerializeItem(Yo)},{type:"LongArray",name:"tids"}]},v2TeamDismiss:{sid:31,cid:12,service:jo,params:[{type:"Long",name:"teamId"}]},v2SuperTeamDismiss:{sid:32,cid:4,service:jo,params:[{type:"Long",name:"teamId"}]},v2TeamAcceptInvitation:{sid:31,cid:21,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Yo)}]},v2SuperTeamAcceptInvitation:{sid:32,cid:23,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Yo)}]},v2TeamRejectInvite:{sid:31,cid:22,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2SuperTeamRejectInvite:{sid:32,cid:24,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2TeamKickMembers:{sid:31,cid:6,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamKickMembers:{sid:32,cid:6,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamApplyToJoin:{sid:31,cid:13,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Yo)}]},v2SuperTeamApplyToJoin:{sid:32,cid:20,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Yo)}]},v2TeamAcceptJoinApplication:{sid:31,cid:14,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},v2SuperTeamAcceptJoinApplication:{sid:32,cid:21,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},v2TeamRejectJoinApplication:{sid:31,cid:15,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2SuperTeamRejectJoinApplication:{sid:32,cid:22,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2TeamAddManagers:{sid:31,cid:16,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamAddManagers:{sid:32,cid:26,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamRemoveManagers:{sid:31,cid:17,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamRemoveManagers:{sid:32,cid:27,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamTransferOwner:{sid:31,cid:18,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},v2SuperTeamTransferOwner:{sid:32,cid:31,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},v2TeamUpdateSelfMemberInfo:{sid:31,cid:19,service:jo,params:[{type:"Property",name:"teamMember",reflectMapper:Ho}]},v2SuperTeamUpdateSelfMemberInfo:{sid:32,cid:10,service:jo,params:[{type:"Property",name:"teamMember",reflectMapper:$o}]},v2TeamUpdateMember:{sid:31,cid:20,service:jo,params:[{type:"Property",name:"teamMember",reflectMapper:Ho}]},v2SuperTeamUpdateMember:{sid:32,cid:30,service:jo,params:[{type:"Property",name:"teamMember",reflectMapper:$o}]},v2TeamGetMemberInvitor:{sid:31,cid:33,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"StrStrMap",name:"accountsMap"}]},v2SuperTeamGetMemberInvitor:{sid:32,cid:35,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"StrStrMap",name:"accountsMap"}]},v2TeamMemberSetChatBannedStatus:{sid:31,cid:25,service:jo,params:[{type:"Long",name:"teamId"},{type:"String",name:"accountId"},{type:"Int",name:"chatBanned"}]},v2SuperTeamMemberSetChatBannedStatus:{sid:32,cid:29,service:jo,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accountId"},{type:"Int",name:"chatBanned"}]},v2TeamSetChatBannedMode:{sid:31,cid:32,service:jo,params:[{type:"Long",name:"teamId"},{type:"Int",name:"chatBannedMode"}]},v2SuperTeamSetChatBannedMode:{sid:32,cid:28,service:jo,params:[{type:"Long",name:"teamId"},{type:"Int",name:"chatBannedMode"}]},v2TeamMemberGetListByIds:{sid:31,cid:35,service:jo,params:[{type:"StrArray",name:"tag"}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ho)}]},v2SuperTeamMemberGetListByIds:{sid:32,cid:37,service:jo,params:[{type:"StrArray",name:"tag"}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem($o)}]},v2TeamMemberGetList:{sid:31,cid:36,service:jo,params:[{type:"Property",name:"tag",reflectMapper:qo}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ho)},{type:"Property",name:"pageInfo",reflectMapper:{1:"hasMore",2:"nextToken"}}]},v2TeamSync:{sid:8,cid:109,service:jo,response:[{type:"Long",name:"timetag"},{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Yo)}]},v2TeamCreateMultiSync:{sid:8,cid:101,service:jo,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Yo)}]},v2TeamMemberUpdateMultiSync:{sid:8,cid:119,service:jo,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ho)}]},v2TeamMembersOfSelfInSync:{sid:8,cid:126,service:jo,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ho)},{type:"Long",name:"timetag"}]},v2SuperTeamSync:{sid:21,cid:109,service:jo,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Yo)},{type:"Bool",name:"isAll"},{type:"Long",name:"timetag"}]},v2SuperTeamCreateMultiSync:{sid:21,cid:101,service:jo,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Yo)}]},v2SuperTeamMemberUpdateMultiSync:{sid:21,cid:110,service:jo,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem($o)}]},v2SuperTeamMembersOfSelfInSync:{sid:21,cid:111,service:jo,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem($o)},{type:"Long",name:"timetag"}]}};function formatTeamNotificationAttachData(t,o){if(!t)return{};var a=t;return a.tinfo&&(a.tinfo=function formatTeamFromTinfo(t){return deserialize(t,invertSerializeItem(Yo))}(a.tinfo),a.tinfo.teamType=o),a.uinfos,void 0!==a.mute&&(a.mute=parseInt(a.mute)),a}function generateTeamByTeamId(t,o,a={}){return Object.assign({teamId:t,teamType:o,name:"",ownerAccountId:"",memberLimit:0,memberCount:0,createTime:0,updateTime:0,intro:"",announcement:"",avatar:"",joinMode:vt.V2NIM_TEAM_JOIN_MODE_FREE,agreeMode:It.V2NIM_TEAM_AGREE_MODE_AUTH,inviteMode:Et.V2NIM_TEAM_INVITE_MODE_MANAGER,updateInfoMode:ft.V2NIM_TEAM_UPDATE_INFO_MODE_MANAGER,updateExtensionMode:Mt.V2NIM_TEAM_UPDATE_EXTENSION_MODE_MANAGER,chatBannedMode:Tt.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN,isValidTeam:!0,messageNotifyMode:yt.V2NIM_TEAM_MESSAGE_NOTIFY_MODE_ALL},a)}function generateMemberByTeamId(t,o,a,c={}){return Object.assign({teamId:t,teamType:o,accountId:a,joinTime:0,inTeam:!0,memberRole:St.V2NIM_TEAM_MEMBER_ROLE_NORMAL,chatBanned:!1},c)}function processTeamMembers(t,o=_t.V2NIM_TEAM_TYPE_ADVANCED){return t.map((t=>function processTeamMember(t,o=_t.V2NIM_TEAM_TYPE_ADVANCED){return t.teamType=o,t.chatBanned=void 0!==t.chatBanned&&t.chatBanned,t}(t,o)))}function completeMessage(t,o){var a,c=Object.assign(Object.assign({},o),{conversationId:t.V2NIMConversationIdUtil.messageConversationId(o),isSelf:o.senderId===t.account,sendingState:ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED,messageStatus:{errorCode:(null===(a=null==o?void 0:o.messageStatus)||void 0===a?void 0:a.errorCode)||200}});return c.threadReply&&(c.threadReply=Object.assign(Object.assign({},c.threadReply),{conversationType:c.conversationType,conversationId:c.conversationId})),c.threadRoot&&(c.threadRoot=Object.assign(Object.assign({},c.threadRoot),{conversationType:c.conversationType,conversationId:c.conversationId})),c}function completeMessageRefer(t,o){return Object.assign(Object.assign({},o),{conversationId:t.V2NIMConversationIdUtil.messageConversationId(o)})}function formatMessageRefer(t,o){var{createTime:a,senderId:c,receiverId:m,conversationType:h}=o;return{conversationType:h,conversationId:t.V2NIMConversationIdUtil.messageConversationId({conversationType:h,senderId:c,receiverId:m}),senderId:o.senderId,receiverId:o.receiverId,messageServerId:o.messageServerId,createTime:a,messageClientId:o.messageClientId}}function formatRevokeMessage(t,o){var a={7:at.V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY,8:at.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY,12:at.V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY,13:at.V2NIM_MESSAGE_REVOKE_TYPE_P2P_ONEWAY,14:at.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_ONEWAY},c={7:Be.V2NIM_CONVERSATION_TYPE_P2P,8:Be.V2NIM_CONVERSATION_TYPE_TEAM,12:Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM,13:Be.V2NIM_CONVERSATION_TYPE_P2P,14:Be.V2NIM_CONVERSATION_TYPE_TEAM}[o.sysMsgType];return{postscript:o.postscript,revokeType:a[o.sysMsgType]||at.V2NIM_MESSAGE_REVOKE_TYPE_UNDEFINED,revokeAccountId:o.opeAccount||o.senderId,callbackExtension:o.callbackExtension,serverExtension:o.attach||"",messageRefer:{conversationType:c,conversationId:t.V2NIMConversationIdUtil.messageConversationId(Object.assign(Object.assign({},o),{conversationType:c,senderId:o.senderId,receiverId:o.receiverId})),senderId:o.senderId,receiverId:o.receiverId,messageServerId:o.messageServerId,createTime:o.deleteMsgCreatetime,messageClientId:o.messageClientId}}}function formatClearHistoryNotification(t,o){return{conversationId:o.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P?t.V2NIMConversationIdUtil.p2pConversationId(o.receiverId):o.conversationType===Be.V2NIM_CONVERSATION_TYPE_TEAM?t.V2NIMConversationIdUtil.teamConversationId(o.teamId):t.V2NIMConversationIdUtil.superTeamConversationId(o.teamId),deleteTime:o.deleteTime,serverExtension:o.serverExtension}}function convertNotificationType(t,o){var a={0:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE,401:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE,1:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_KICK,402:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_KICK,2:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_LEAVE,403:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_LEAVE,3:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_UPDATE_TINFO,404:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_UPDATE_TINFO,4:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_DISMISS,405:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_DISMISS,5:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_APPLY_PASS,410:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_APPLY_PASS,6:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_OWNER_TRANSFER,406:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_OWNER_TRANSFER,7:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_ADD_MANAGER,407:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_ADD_MANAGER,8:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_REMOVE_MANAGER,408:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_REMOVE_MANAGER,9:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE_ACCEPT,411:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE_ACCEPT,10:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_BANNED_TEAM_MEMBER,409:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_BANNED_TEAM_MEMBER};return void 0===a[o]&&t.logger.warn(`[V2NIMMessageService] undefined notification type: ${o}`),"number"==typeof a[o]?a[o]:it.V2NIM_MESSAGE_NOTIFICATION_TYPE_UNDEFINED}function formatMessageAttachment(t,o){return t.messageType===rt.V2NIM_MESSAGE_TYPE_NOTIFICATION?function formatNotificationMessage(t,o){var a,c,m,h,g,_=o.attachment||{};if(o.attachment&&"type"in o.attachment)return o;var I=void 0;if(null===(a=_.data)||void 0===a?void 0:a.tinfo){var{id:E,data:T}=_,M=E>400?_t.V2NIM_TEAM_TYPE_SUPER:_t.V2NIM_TEAM_TYPE_ADVANCED,{tinfo:S}=formatTeamNotificationAttachData(Object.assign({},T),M);I={},I=__rest(S,["teamId"])}var N=Object.assign(Object.assign(Object.assign(Object.assign({raw:_.raw,type:convertNotificationType(t,_.id)},I?{updatedTeamInfo:I}:{}),{targetIds:(null===(c=_.data)||void 0===c?void 0:c.ids)||((null===(m=_.data)||void 0===m?void 0:m.id)?[_.data.id]:[])}),"string"==typeof(null===(h=_.data)||void 0===h?void 0:h.attach)?{serverExtension:_.data.attach}:{}),"number"==typeof(null===(g=_.data)||void 0===g?void 0:g.mute)?{chatBanned:_.data.mute!==mt.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF}:{});return Object.assign(Object.assign({},o),{attachment:N})}(o,t):t}function attachmentToRaw(t,o){if(!o)return"";switch(t){case rt.V2NIM_MESSAGE_TYPE_CUSTOM:return o.raw||"";case rt.V2NIM_MESSAGE_TYPE_IMAGE:case rt.V2NIM_MESSAGE_TYPE_VIDEO:case rt.V2NIM_MESSAGE_TYPE_AUDIO:case rt.V2NIM_MESSAGE_TYPE_FILE:return function mediaAttachmentToRaw(t){var o=t,{width:a,height:c,duration:m,path:h,file:g,raw:_,ctx:I,payload:E,bucketName:T,objectName:M,token:S,ext:N}=o,C=__rest(o,["width","height","duration","path","file","raw","ctx","payload","bucketName","objectName","token","ext"]),A="string"==typeof N&&"."===N[0]?N.slice(1):N;return JSON.stringify(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},C),void 0===N?{}:{ext:A}),void 0===a?{}:{w:a}),void 0===c?{}:{h:c}),void 0===m?{}:{dur:m}))}(o);case rt.V2NIM_MESSAGE_TYPE_LOCATION:return function locationAttachmentToRaw(t){return JSON.stringify({lat:t.latitude,lng:t.longitude,title:t.address})}(o);case rt.V2NIM_MESSAGE_TYPE_CALL:return function callAttachmentToRaw(t){var o=__rest(t,["raw"]);try{return JSON.stringify(Object.assign(Object.assign({},o),{durations:t.durations.map((t=>({accid:t.accountId,duration:t.duration})))}))}catch(o){return JSON.stringify(t)}}(o);default:return o.raw||JSON.stringify(o)}}function rawToAttachment(t,o){var a;try{switch(a=JSON.parse(t),o){case rt.V2NIM_MESSAGE_TYPE_CUSTOM:return{raw:t};case rt.V2NIM_MESSAGE_TYPE_LOCATION:return function locationRawToAttachment(t,o){return{latitude:o.lat,longitude:o.lng,address:o.title,raw:t}}(t,a);case rt.V2NIM_MESSAGE_TYPE_AUDIO:case rt.V2NIM_MESSAGE_TYPE_VIDEO:case rt.V2NIM_MESSAGE_TYPE_IMAGE:case rt.V2NIM_MESSAGE_TYPE_FILE:return function mediaRawToAttachment(t,o){var{w:a,h:c,dur:m,ext:h}=o,g=__rest(o,["w","h","dur","ext"]),_="string"==typeof h&&"."!==h[0]?`.${h}`:h;return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},g),void 0===h?{}:{ext:_}),void 0===a?{}:{width:a}),void 0===c?{}:{height:c}),void 0===m?{}:{duration:m}),{raw:t})}(t,a);case rt.V2NIM_MESSAGE_TYPE_CALL:return function callRawToAttachment(t,o){return Object.assign(Object.assign({},o),{durations:o.durations.map((t=>({accountId:t.accid,duration:t.duration}))),raw:t})}(t,a);default:return"object"==typeof a&&a?Object.assign(Object.assign({},a),{raw:t}):{raw:t}}}catch(o){return"object"==typeof a&&a?Object.assign(Object.assign({},a),{raw:t}):{raw:t}}}var Ko="V2NIMMessageService",Wo={"30_1":"v2SendP2pMessage","31_2":"v2SendTeamMessage","30_31":"v2MessageP2pModify","31_37":"v2MessageTeamModify","32_38":"v2MessageSuperTeamModify","7_33":"v2MessageOnModified","4_27":"v2MessageSyncModified","4_28":"v2MessageSuperTeamSyncModified","4_5":"v2BatchMarkRead","4_12":"syncP2PMessagReceipts","30_11":"v2SendP2PMessageReceipt","31_28":"v2SendTeamMessageReceipts","32_2":"v2SendSuperTeamMessage","7_12":"onP2PMessageReceipts","8_31":"onTeamMessageReceipts","31_29":"v2GetTeamMessageReceipts","31_30":"v2GetTeamMessageReceiptDetail","7_2":"onMsg","8_3":"onMsg","7_101":"onMsg","8_102":"onMsg","21_3":"onMsg","21_102":"onMsg","4_4":"syncOfflineMsgs","4_9":"syncRoamingMsgs","4_17":"syncRoamingMsgs","30_13":"v2RevokeMessage","32_17":"v2RevokeSuperTeamMessage","7_14":"onRevokeMessage","7_15":"syncRevokeMessage","21_18":"onRevokeMessage","21_117":"onRevokeMessage","30_23":"v2DeleteMessage","30_24":"v2DeleteMessages","4_21":"syncOnDeleteMessages","7_123":"onDeleteMessage","7_124":"onDeleteMessages","29_17":"v2DownloadLocalAntiSpamVocabs"},Jo={conversationType:{id:0,converter:conversationTypeV2ToV1,retConverter:conversationTypeV1ToV2},receiverId:1,senderId:2,fromClientType:4,fromDeviceId:5,fromNick:6,createTime:{id:7,retType:"number"},messageType:{id:8,retType:"number"},text:9,attachment:{id:10,converter:(t,o)=>attachmentToRaw(o.messageType,t),retConverter:(t,o)=>rawToAttachment(t,Number(o[8]))},messageClientId:11,messageServerId:12,resend:{id:13,converter:boolToInt,retType:"boolean"},userUpdateTime:{id:14,retType:"number"},serverExtension:15,pushPayload:{id:16,access:"pushConfig.pushPayload"},pushContent:{id:17,access:"pushConfig.pushContent"},forcePushAccountIds:{id:18,access:"pushConfig.forcePushAccountIds",def:t=>{if(t["pushConfig.forcePush"])return"#%@all@%#"},converter:(t,o)=>{if(o["pushConfig.forcePush"]){if(0===t.length)return"#%@all@%#";try{return JSON.stringify(t)}catch(t){return"#%@all@%#"}}},retConverter(t){if("#%@all@%#"===t)return t;if(t)try{return JSON.parse(t)}catch(t){return[]}}},forcePushContent:{id:19,access:"pushConfig.forcePushContent"},forcePush:{id:20,access:"pushConfig.forcePush",converter:boolToInt,retType:"boolean"},antispamCustomMessageEnabled:{id:21,def:t=>Ue(t,"antispamConfig.antispamCustomMessage")?1:void 0,retConverter:()=>{}},antispamCustomMessage:{id:22,access:"antispamConfig.antispamCustomMessage"},antispamBusinessId:{id:23,access:"antispamConfig.antispamBusinessId"},clientAntispamHit:{id:24,access:"clientAntispamHit",converter:boolToInt,retType:"boolean"},antispamEnabled:{id:25,access:"antispamConfig.antispamEnabled",converter:boolToInt,retType:"boolean"},needAck:{id:26,access:"messageConfig.readReceiptEnabled",converter:boolToInt,retType:"boolean"},lastMessageUpdateEnabled:{id:28,access:"messageConfig.lastMessageUpdateEnabled",converter:boolToInt,retType:"boolean"},threadReplySenderId:{id:29,access:"threadReply.senderId"},threadReplyReceiverId:{id:30,access:"threadReply.receiverId"},threadReplyTime:{id:31,access:"threadReply.createTime",retType:"number"},threadReplyServerId:{id:32,access:"threadReply.messageServerId"},threadReplyClientId:{id:33,access:"threadReply.messageClientId"},threadRootSenderId:{id:34,access:"threadRoot.senderId"},threadRootReceiverId:{id:35,access:"threadRoot.receiverId"},threadRootTime:{id:36,access:"threadRoot.createTime",retType:"number"},threadRootServerId:{id:37,access:"threadRoot.messageServerId"},threadRootClientId:{id:38,access:"threadRoot.messageClientId"},callbackExtension:40,subType:{id:41,retType:"number"},antispamCheating:{id:42,access:"antispamConfig.antispamCheating"},routeEnvironment:{id:43,access:"routeConfig.routeEnvironment"},antispamExtension:{id:44,access:"antispamConfig.antispamExtension"},antispamResult:45,__clientExt:{id:46,converter:objectToJSONString,retConverter:stringToJSONObject},robotFunction:{id:47,access:"robotConfig.function"},robotTopic:{id:48,access:"robotConfig.topic"},robotCustomContent:{id:49,access:"robotConfig.customContent"},robotAccount:{id:50,access:"robotConfig.accountId"},_conversationOnlineSyncNotify:{id:51},_conversationOnlineSyncData:{id:52},aiAgentMsgDirection:{id:55,access:"aiConfig.aiStatus",retAccess:"aiConfig.aiStatus",retType:"number"},aiAgentAccount:{id:56,access:"aiConfig.accountId",retAccess:"aiConfig.accountId"},aiAgentContent:{id:57,access:"aiConfig.content",converter:objectToJSONString,retConverter:emptyFunc$1},aiAgentMessages:{id:58,access:"aiConfig.messages",converter:objectToJSONString,retConverter:emptyFunc$1},aiAgentPromptVariables:{id:59,access:"aiConfig.promptVariables",retConverter:emptyFunc$1},aiAgentModelConfigParams:{id:60,access:"aiConfig.modelConfigParams",converter:objectToJSONString,retConverter:emptyFunc$1},errorCode:{id:61,access:"messageStatus.errorCode",retType:"number"},modifyTime:{id:62,retType:"number"},modifyAccountId:63,historyEnabled:{id:100,access:"messageConfig.historyEnabled",converter:boolToInt,retType:"boolean"},roamingEnabled:{id:101,access:"messageConfig.roamingEnabled",converter:boolToInt,retType:"boolean"},onlineSyncEnabled:{id:102,access:"messageConfig.onlineSyncEnabled",converter:boolToInt,retType:"boolean"},routeEnabled:{id:105,access:"routeConfig.routeEnabled",converter:boolToInt,retType:"boolean"},pushEnable:{id:107,access:"pushConfig.pushEnabled",converter:boolToInt,retType:"boolean"},offlineEnabled:{id:108,access:"messageConfig.offlineEnabled",converter:boolToInt,retType:"boolean"},unreadEnabled:{id:109,access:"messageConfig.unreadEnabled",converter:boolToInt,retType:"boolean"},pushNickEnabled:{id:110,access:"pushConfig.pushNickEnabled",converter:boolToInt,retType:"boolean"},msgAckSnapshot:{id:112,retType:"number"},receiverIds:{id:154,access:"targetConfig.receiverIds",converter:objectToJSONString,retConverter:()=>{}},inclusive:{id:155,access:"targetConfig.inclusive",converter:t=>t?1:2,retConverter:()=>{}},newMemberVisible:{id:156,access:"targetConfig.newMemberVisible",converter:boolToInt,retConverter:()=>{}}},Xo=invertSerializeItem(Jo),Qo={conversationType:{id:1,access:"messageRefer.conversationType",retType:"number"},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},messageServerId:{id:4,access:"messageRefer.messageServerId"},messageClientId:{id:5,access:"messageRefer.messageClientId"},createTime:{id:6,access:"messageRefer.createTime",retType:"number"},deleteTime:{id:7,retType:"number"},serverExtension:8};invertSerializeItem(Qo);var Zo={version:1,md5:2,nosurl:3,thesaurus:4},es={createTime:{id:0,retType:"number"},sysMsgType:1,receiverId:2,senderId:3,postscript:4,attach:5,pushContent:8,pushPayload:9,messageClientId:10,messageServerId:11,deleteMsgCreatetime:{id:14,retType:"number"},opeAccount:16,env:21,callbackExtension:22},ts={receiverId:0,messageServerId:1,readCount:{id:100,retType:"number"},unreadCount:{id:101,retType:"number"},messageClientId:102,latestReadAccount:103},rs={v2BatchMarkRead:{sid:4,cid:5,service:Ko,hasPacketResponse:!1,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]},v2SendP2pMessage:{sid:30,cid:1,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Jo}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},onMsg:{sid:7,cid:2,service:Ko,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(Jo)}]},syncOfflineMsgs:{sid:4,cid:4,service:Ko,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Jo)}]},syncRoamingMsgs:{sid:4,cid:9,service:Ko,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2SendP2PMessageReceipt:{sid:30,cid:11,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Jo}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2RevokeMessage:{sid:30,cid:13,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:es}]},v2DeleteMessage:{sid:30,cid:23,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Qo}],response:[{type:"Long",name:"timetag"}]},v2DeleteMessages:{sid:30,cid:24,service:Ko,params:[{type:"PropertyArray",name:"tag",reflectMapper:Qo}],response:[{type:"Long",name:"timetag"}]},v2SendTeamMessage:{sid:31,cid:2,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Jo}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2SendTeamMessageReceipts:{sid:31,cid:28,service:Ko,params:[{type:"PropertyArray",name:"tag",reflectMapper:ts}],response:[{type:"PropertyArray",name:"tag",reflectMapper:invertSerializeItem(ts)}]},v2SendSuperTeamMessage:{sid:32,cid:2,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Jo}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2RevokeSuperTeamMessage:{sid:32,cid:17,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:es}]},syncP2PMessagReceipts:{sid:4,cid:12,service:Ko,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Jo)}]},onP2PMessageReceipts:{sid:7,cid:12,service:Ko,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2GetTeamMessageReceipts:{sid:31,cid:29,service:Ko,params:[{type:"PropertyArray",name:"tag",reflectMapper:ts}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(ts)}]},v2GetTeamMessageReceiptDetail:{sid:31,cid:30,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:ts,select:["receiverId","messageServerId"]}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(ts)},{type:"StrArray",name:"readAccountList"},{type:"StrArray",name:"unreadAccountList"}]},onTeamMessageReceipts:{sid:8,cid:31,service:Ko,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(ts)}]},onRevokeMessage:{sid:7,cid:14,service:Ko,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(es)}]},syncRevokeMessage:{sid:7,cid:15,service:Ko,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(es)}]},syncOnDeleteMessages:{sid:4,cid:21,service:Ko,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Qo)}]},onDeleteMessage:{sid:7,cid:123,service:Ko,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Qo)}]},onDeleteMessages:{sid:7,cid:124,service:Ko,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Qo)}]},v2DownloadLocalAntiSpamVocabs:{sid:29,cid:17,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Zo}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Zo)}]},v2MessageP2pModify:{sid:30,cid:31,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Jo}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2MessageTeamModify:{sid:31,cid:37,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Jo}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2MessageSuperTeamModify:{sid:32,cid:38,service:Ko,params:[{type:"Property",name:"tag",reflectMapper:Jo}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2MessageOnModified:{sid:7,cid:33,service:Ko,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2MessageSyncModified:{sid:4,cid:27,service:Ko,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Jo)},{type:"Long",name:"time"}]},v2MessageSuperTeamSyncModified:{sid:4,cid:28,service:Ko,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Jo)},{type:"Long",name:"time"}]}};function conversationTypeV2ToV1(t){return t===Be.V2NIM_CONVERSATION_TYPE_P2P?0:t===Be.V2NIM_CONVERSATION_TYPE_TEAM?1:t===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?5:void 0}function conversationTypeV1ToV2(t){var o=parseInt(t);return 0===o?Be.V2NIM_CONVERSATION_TYPE_P2P:1===o?Be.V2NIM_CONVERSATION_TYPE_TEAM:5===o?Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM:Be.V2NIM_CONVERSATION_TYPE_UNKNOWN}var is={type:{type:"number"},lastMessageState:{type:"number"},unreadCount:{type:"number"},stickTop:{type:"boolean"},sortOrder:{type:"number"},version:{type:"number"},deleteFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}};function formatConversationFields(t,o){return o&&o.length>0?o.map((o=>formatConversationField(t,o))):[]}function formatLastMessageFromMessage(t,o,a=je.V2NIM_MESSAGE_STATUS_DEFAULT,c){var m,h;o=formatMessageAttachment(o,t);var{messageType:g,subType:_,text:I,attachment:E,serverExtension:T}=o,M="";if(o.senderId!==t.account){M=Ue(o,"fromNick");var S=null===(h=null===(m=t.V2NIMFriendService)||void 0===m?void 0:m.model)||void 0===h?void 0:h.getFriend(o.senderId);S&&S.alias&&(M=S.alias)}return JSON.parse(JSON.stringify({lastMessageState:a,messageRefer:formatMessageRefer(t,o),messageType:g,subType:_,text:I,attachment:E,serverExtension:T,callbackExtension:o.callbackExtension,sendingState:c,senderName:M}))}function formatLastMessageFromNotification(t,o){var{messageRefer:a,revokeAccountId:c,revokeType:m,callbackExtension:h,serverExtension:g,postscript:_}=o,I=function calcSenderNameFromNotification(t,o,a,c){var m,h,g,_,I,E;if(o!==t.account){var T=null===(h=null===(m=t.V2NIMFriendService)||void 0===m?void 0:m.model)||void 0===h?void 0:h.getFriend(o);if(T&&T.alias)return T.alias;if(a===Be.V2NIM_CONVERSATION_TYPE_TEAM){var M=null===(_=null===(g=t.V2NIMTeamService)||void 0===g?void 0:g.memberModel)||void 0===_?void 0:_.getById(c,_t.V2NIM_TEAM_TYPE_ADVANCED,o);if(M&&M.teamNick)return M.teamNick}else if(a===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM){var S=null===(E=null===(I=t.V2NIMTeamService)||void 0===I?void 0:I.memberModel)||void 0===E?void 0:E.getById(c,_t.V2NIM_TEAM_TYPE_ADVANCED,o);if(S&&S.teamNick)return S.teamNick}var N=t.V2NIMUserService.model.getUser(o);return N&&N.name?N.name:void 0}}(t,o.revokeAccountId,o.messageRefer.conversationType,o.messageRefer.receiverId)||"";return JSON.parse(JSON.stringify({lastMessageState:je.V2NIM_MESSAGE_STATUS_REVOKE,messageRefer:a,revokeAccountId:c,revokeType:m,callbackExtension:h,serverExtension:g,text:_||"",senderName:I}))}function formatConversationField(t,o){var a=format(is,o);if(a.groupIds?a.groupIds=JSON.parse(a.groupIds):delete a.groupIds,"string"==typeof a.lastMessage)if(""===a.lastMessage);else if(a.lastMessageState===je.V2NIM_MESSAGE_STATUS_REVOKE){var c=formatRevokeMessage(t,deserialize(JSON.parse(a.lastMessage),invertSerializeItem(es)));a.lastMessage=formatLastMessageFromNotification(t,c)}else if(a.lastMessageState===je.V2NIM_MESSAGE_STATUS_DEFAULT){var m=deserialize(JSON.parse(a.lastMessage),invertSerializeItem(Jo));a.lastMessage=formatLastMessageFromMessage(t,m,a.lastMessageState,m.senderId===t.account?ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED:void 0)}else a.lastMessageState===je.V2NIM_MESSAGE_STATUS_BACKFILL&&delete a.lastMessage;return a}function formatConversationByField(t){var{version:o,deleteFlag:a}=t;return{conversation:__rest(t,["version","deleteFlag"]),version:o,deleteFlag:a}}var ns={type:{type:"number"},oneClickClearUnreadType:{type:"number"},oneClickClearUnreadConversationType:{type:"object"},oneClickClearUnreadVersion:{type:"number"},deleteConversationClearMessage:{type:"boolean"}};function formatConversationNotify(t){return format(ns,t)}class V2NIMConversationVersionCacheImpl{constructor(t,o){this.fieldVersion={},this.conversationIdsForBackFill={},this.tempPacket=[],this.isSyncing=!1,this.nextCursor=0,this.core=t,this.service=o}reset(){this.tempPacket=[],this.fieldVersion={},this.conversationIdsForBackFill={},this.isSyncing=!1,this.nextCursor=0}doSync(){return __awaiter(this,void 0,void 0,(function*(){var t;this.isSyncing=!0,this.service.emit("onSyncStarted");try{t=yield this.core.sendCmd("v2ConversationSync",{tag:{cursor:this.nextCursor}})}catch(t){var o=t;if(o.code===wt.V2NIM_ERROR_CODE_CANCELLED)return;return this.isSyncing=!1,this.service.emit("onSyncFailed",o),this.core.V2NIMLoginService.dataSync.switchDataSync({type:Fe.V2NIM_DATA_SYNC_TYPE_MAIN,state:Ge.V2NIM_DATA_SYNC_STATE_COMPLETED,error:o,subType:"conversationSync"}),void this.processTempPacket()}var a=0===parseInt(Ue(t,"content.info.syncType")),c=Ue(t,"content.info.nextCursor");this.doSyncAndSuccess(a,c)}))}doSyncAndSuccess(t,o){t&&this.service.model.sort(),this.isSyncing=!1,this.nextCursor=parseInt(o)||0,this.service.unread.resetTotalAfterSyncDone(),this.service.unread.digestUnreadCountChange(),this.service.emit("onSyncFinished"),this.core.V2NIMLoginService.dataSync.switchDataSync({type:Fe.V2NIM_DATA_SYNC_TYPE_MAIN,state:Ge.V2NIM_DATA_SYNC_STATE_COMPLETED,subType:"conversationSync"}),this.processTempPacket()}setBackFillIds(t){return t.forEach((t=>{var o;if(t.lastMessageState===je.V2NIM_MESSAGE_STATUS_BACKFILL&&(null===(o=this.core.V2NIMMessageService)||void 0===o?void 0:o.model)){this.conversationIdsForBackFill[t.conversationId]=!0;var a=this.core.V2NIMMessageService.model.getLastMessageOfConversation(t.conversationId);t.lastMessage=a?formatLastMessageFromMessage(this.core,a,t.lastMessageState,a.sendingState):""}else this.conversationIdsForBackFill[t.conversationId]=!1;delete t.lastMessageState})),t}recvConversationFromSyncAction(t){var{syncType:o}=Ue(t,"content.info"),a=formatConversationFields(this.core,Ue(t,"content.datas"));0===(o=parseInt(o))?(a.forEach((t=>{this.initFieldVersion(t.conversationId,t.version)})),a=this.setBackFillIds(a),this.setModel(a)):(a=this.setBackFillIds(a),this.recvConversationForCreated(a)<a.length&&this.recvConversationForChanged(a))}recvConversation(t){if(this.isSyncing)this.tempPacket.push(t);else{var o=formatConversationFields(this.core,Ue(t,"content.datas")).filter((t=>!!t.conversationId)),a=formatConversationNotify(Ue(t,"content.info"));if(this.core.logger.log(`V2NIMConversation::recvConversation:${a.type}`,a,o),2===a.type){var c=o.map((t=>(delete this.fieldVersion[t.conversationId],this.service.model.deleteById(t.conversationId),t.conversationId)));return this.service.emit("onConversationDeleted",c),void this.service.unread.digestUnreadCountChange()}if(12!==a.type)a.type,o=this.setBackFillIds(o),this.recvConversationForCreated(o)<o.length&&this.recvConversationForChanged(o);else this.compareAndClearUnreadInModel(a.oneClickClearUnreadVersion,a.oneClickClearUnreadType,{conversationGroupIds:a.oneClickClearUnreadGroupId?[a.oneClickClearUnreadGroupId]:void 0,conversationTypes:a.oneClickClearUnreadConversationType})}}recvConversationForCreated(t){var o=t.filter((t=>!this.fieldVersion[t.conversationId]));return o.reduce(((t,o)=>{if(!this.fieldVersion[o.conversationId]){this.initFieldVersion(o.conversationId,o.version),t=!!this.updateModel(o)||t;var a=this.service.model.getById(o.conversationId);return a&&this.service.triggerConversationCreated(a),t}return t}),!1)&&this.service.unread.digestUnreadCountChange(),o.length}recvConversationForChanged(t){var o=this.bulkCompare(t);if(0!==o.length){this.bulkUpdateModel(o);var a=o.map((t=>this.service.model.getById(t.conversationId))).filter((t=>!!t));this.service.triggerConversationChanged(a)}}processTempPacket(){this.tempPacket.forEach((t=>{this.recvConversation(t)})),this.tempPacket=[]}bulkCompare(t){return t.map((t=>this.compare(t))).filter((t=>!!t))}compare(t){var{version:o,conversationId:a,deleteFlag:c,type:m}=t,h={},g=0;return["stickTop","groupIds","serverExtension","localExtension","lastMessage","lastMessageState","unreadCount","sortOrder","createTime","updateTime"].forEach((c=>{var m=c;if(void 0!==t[m]){var _=this.fieldVersion[a];_&&"number"==typeof _[m]&&_[m]>=o||(this.fieldVersion[a]=this.fieldVersion[a]||{},this.fieldVersion[a][m]=o,h[m]=t[m],g+=1)}})),g?Object.assign(Object.assign({},h),{conversationId:a,deleteFlag:c,version:o,type:m}):void 0}bulkUpdateModel(t){var o=!1;t.forEach((t=>{this.updateModel(t)&&(o=!0)})),o&&this.service.unread.digestUnreadCountChange()}initFieldVersion(t,o){this.fieldVersion[t]={stickTop:o,groupIds:o,serverExtension:o,lastMessage:o,lastMessageState:o,unreadCount:o,sortOrder:o,createTime:o,updateTime:o}}initConversation(t,o){var a=Date.now();return Object.assign({conversationId:t,type:this.core.V2NIMConversationIdUtil.parseConversationType(t),stickTop:!1,localExtension:"",serverExtension:"",unreadCount:0,createTime:a,updateTime:a,sortOrder:a},o)}updateModel(t){var{deleteFlag:o,conversation:a}=formatConversationByField(t);if(o){var c=this.service.model.deleteById(a.conversationId);return!!(c&&c.unreadCount>0)}return this.service.model.upsert(a)}setModel(t){var o=t.filter((t=>!t.deleteFlag)).map((t=>formatConversationByField(t).conversation));this.service.model.set(o)}updateModelWithLastMessage(t,o,a,c){var m=this.service.model.getById(t),h=o?formatLastMessageFromMessage(this.core,o,a,c):void 0;if(!Fo(null==m?void 0:m.lastMessage,h))if(m){var g=Object.assign(Object.assign({},m),{sortOrder:h?m.stickTop?h.messageRefer.createTime+1e15:h.messageRefer.createTime:m.sortOrder,lastMessage:h});this.service.model.upsert(g),this.service.triggerConversationChanged([g])}else{this.initFieldVersion(t,-1);var _=this.initConversation(t,{lastMessage:h});this.service.model.upsert(_),this.service.triggerConversationCreated(_)}}updateModelByRevoke(t){var o=[];t.forEach((t=>{var{postscript:a,messageRefer:c}=t,m=__rest(t,["postscript","messageRefer"]),h=c.conversationId,g=this.service.model.getById(h);g&&g.lastMessage&&g.lastMessage.messageRefer.messageClientId===c.messageClientId&&g.lastMessage.lastMessageState!==je.V2NIM_MESSAGE_STATUS_REVOKE&&(g.lastMessage.lastMessageState=je.V2NIM_MESSAGE_STATUS_REVOKE,a&&(g.lastMessage.text=a),Object.assign(g.lastMessage,m),this.service.model.upsert(g),o.push(g))})),o.length>0&&this.service.triggerConversationChanged(o)}compareAndUpdateModel(t){this.core.logger.log("V2NIMConversation::compareAndUpdateModel",t.map((t=>t.conversationId)));var o=!1,a=[];t.forEach((t=>{var c=this.compare(t);if(c){var m=this.service.model.getById(t.conversationId);this.updateModel(c)&&(o=!0);var h=this.service.model.getById(t.conversationId);h&&(m?a.push(h):this.service.triggerConversationCreated(h))}})),a.length>0&&this.service.triggerConversationChanged(a),o&&this.service.unread.digestUnreadCountChange()}compareAndDeleteModel(t){this.core.logger.log("V2NIMConversation::compareAndDeleteModel",t);var o=t.reduce(((t,o)=>{delete this.fieldVersion[o];var a=this.service.model.deleteById(o);return!!!!(a&&a.unreadCount>0)||t}),!1);this.service.emit("onConversationDeleted",t),o&&this.service.unread.digestUnreadCountChange()}compareAndDeleteGroupInModel(t,o){this.core.logger.log("V2NIMConversation::compareAndDeleteGroupInModel",t,o);var a=[];Object.keys(this.fieldVersion).forEach((c=>{var m=this.fieldVersion[c];if(void 0===m.groupIds||t>m.groupIds){m.groupIds=t;var h=this.service.model.getById(c);if(h&&h.groupIds&&h.groupIds.length>0){var g=h.groupIds.filter((t=>t!==o));if(g.length!==h.groupIds.length){var _=Object.assign(Object.assign({},h),{groupIds:g});this.service.model.upsert(_),_&&a.push(_)}}}})),a.length>0&&this.service.triggerConversationChanged(a)}compareAndClearUnreadInModel(t,o,a){this.core.logger.log("V2NIMConversation::compareAndClearUnreadInModel",t,o,a);var c=[],m=[];if(1===o)m=this.service.model.getAll();else if(a){var h=this.service.model.count();m=this.service.model.getByOption(0,h,a).conversationList}m.forEach((o=>{var a=o.conversationId,m=this.fieldVersion[a];if(void 0===m.unreadCount||t>m.unreadCount){m.unreadCount=t;var h=o.unreadCount,g=Object.assign(Object.assign({},o),{unreadCount:0});this.service.model.upsert(g),h>0&&c.push(g)}})),c.length>0&&this.service.triggerConversationChanged(c),this.service.unread.digestUnreadCountChange()}backfillLastMsg(t,o){var a=t=zi(t);(o||0!==(a=t.filter((t=>this.conversationIdsForBackFill[t]))).length)&&a.forEach((t=>{var o=this.service.model.getById(t),a=Ue(o,"lastMessage.messageRefer.messageClientId"),c=this.core.V2NIMMessageService.model.getLastMessageOfConversation(t);(c&&c.messageClientId)!==a&&(this.conversationIdsForBackFill[t]=!1,c?this.updateModelWithLastMessage(t,c,je.V2NIM_MESSAGE_STATUS_BACKFILL,c.sendingState):this.updateModelWithLastMessage(t,void 0,je.V2NIM_MESSAGE_STATUS_BACKFILL,ot.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN))}))}}var os={"28_1":"v2ConversationCreate","28_2":"v2ConversationDelete","28_3":"v2ConversationUpdate","28_4":"v2ConversationSetTop","28_5":"v2ConversationUnreadClear","28_6":"v2ConversationGet","28_7":"v2ConversationGetByIds","28_8":"v2ConversationGetList","28_17":"v2ConversationsDelete","28_18":"v2ConversationsUnreadClear","28_19":"v2ConversationSync","28_20":"v2ConversationNotifySync","28_21":"v2ConversationNotifySyncOnline","28_23":"v2ConversationClearTotalUnread","28_24":"v2ConversationClearTypeUnread","28_25":"v2ConversationClearGroupUnread","4_14":"syncConversationReadTime","4_20":"syncSuperTeamReadTime","30_16":"v2MarkConversationReadTime","32_25":"v2MarkSuperTeamReadTime","7_116":"v2MultiDeviceConversationReadTime","21_125":"v2MultiDeviceSuperTeamReadTime"},ss="V2NIMConversationService",as={conversationId:1,type:2,serverExtension:3,groupIds:4,lastMessage:5,lastMessageState:6,unreadCount:7,stickTop:8,sortOrder:9,version:10,deleteFlag:11,createTime:12,updateTime:13},cs={type:1,oneClickClearUnreadType:2,oneClickClearUnreadConversationType:3,oneClickClearUnreadGroupId:4,oneClickClearUnreadVersion:5,deleteConversationClearMessage:6},ds={v2ConversationCreate:{sid:28,cid:1,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:mn(as)}]},v2ConversationDelete:{sid:28,cid:2,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,clearMessage:2}}],response:[{type:"Property",name:"data",reflectMapper:mn(as)}]},v2ConversationUpdate:{sid:28,cid:3,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,serverExtension:2}}],response:[{type:"Property",name:"data",reflectMapper:mn(as)}]},v2ConversationSetTop:{sid:28,cid:4,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,stickTop:2}}],response:[{type:"Property",name:"data",reflectMapper:mn(as)}]},v2ConversationUnreadClear:{sid:28,cid:5,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:mn(as)}]},v2ConversationGet:{sid:28,cid:6,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:mn(as)}]},v2ConversationGetByIds:{sid:28,cid:7,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:mn(as)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGetList:{sid:28,cid:8,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{cursor:1,limit:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:mn(as)},{type:"Property",name:"info",reflectMapper:{1:"hasMore",2:"offset"}}]},v2ConversationsDelete:{sid:28,cid:17,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1,clearMessage:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:mn(as)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationsUnreadClear:{sid:28,cid:18,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:mn(as)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationSync:{sid:28,cid:19,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{cursor:1}}],response:[{type:"Property",name:"info",reflectMapper:{1:"nextCursor",2:"syncType"}}]},v2ConversationNotifySync:{sid:28,cid:20,service:ss,response:[{type:"Property",name:"info",reflectMapper:{1:"nextCursor",2:"syncType"}},{type:"PropertyArray",name:"datas",reflectMapper:mn(as)}]},v2ConversationNotifySyncOnline:{sid:28,cid:21,service:ss,response:[{type:"Property",name:"info",reflectMapper:mn(cs)},{type:"PropertyArray",name:"datas",reflectMapper:mn(as)}]},v2ConversationClearTotalUnread:{sid:28,cid:23,service:ss,response:[{type:"Property",name:"info",reflectMapper:mn(cs)}]},v2ConversationClearTypeUnread:{sid:28,cid:24,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{conversationType:1}}],response:[{type:"Property",name:"info",reflectMapper:mn(cs)}]},v2ConversationClearGroupUnread:{sid:28,cid:25,service:ss,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"info",reflectMapper:mn(cs)}]},syncConversationReadTime:{sid:4,cid:14,service:ss,response:[{type:"StrLongMap",name:"p2p"},{type:"LongLongMap",name:"team"},{type:"Long",name:"timetag"}]},syncSuperTeamReadTime:{sid:4,cid:20,service:ss,response:[{type:"LongLongMap",name:"superTeam"}]},v2MarkConversationReadTime:{sid:30,cid:16,service:ss,params:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},v2MarkSuperTeamReadTime:{sid:32,cid:25,service:ss,params:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]},v2MultiDeviceConversationReadTime:{sid:30,cid:116,service:ss,response:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},v2MultiDeviceSuperTeamReadTime:{sid:21,cid:125,service:ss,response:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]}};class V2NIMConversationUnreadImpl{constructor(t,o){this.totalUnreadCount=void 0,this.unreadCountByFilter={},this.core=t,this.service=o}reset(){this.totalUnreadCount=void 0,this.unreadCountByFilter={}}getTotalUnreadCount(){return this.totalUnreadCount}resetTotalAfterSyncDone(){var t=this.service.model.getAll().reduce(((t,o)=>t+(o.unreadCount||0)),0),o=this.totalUnreadCount;return void 0!==o&&o===t||(this.totalUnreadCount=t,this.service.emit("onTotalUnreadCountChanged",t)),t}digestUnreadCountChange(){this._digest()}_digest(){var t=this.totalUnreadCount,o=this.service.model.getAll().reduce(((t,o)=>t+(o.unreadCount||0)),0);this.core.logger.log(`V2NIMConversation::digestUnreadCountChange:oldUnreadCount ${t}, newUnreadCount ${o}`),t!==o&&(this.totalUnreadCount=o,this.service.emit("onTotalUnreadCountChanged",o)),Object.keys(this.unreadCountByFilter).forEach((t=>{var o=JSON.parse(t),a=this.getUnreadCountByFilter(o),c=this.unreadCountByFilter[t];this.unreadCountByFilter[t]=a,o.equals=equals.bind(o),c!==a&&this.service.emit("onUnreadCountChangedByFilter",o,a)}))}getUnreadCountByIds(t){return t.reduce(((t,o)=>{var a=this.service.model.getById(o);return t+(a&&a.unreadCount||0)}),0)}getUnreadCountByFilter(t){var o=this.service.model.count();return this.service.model.getByOption(0,o,{conversationTypes:t.conversationTypes,conversationGroupIds:t.conversationGroupId?[t.conversationGroupId]:void 0,ignoreMuted:t.ignoreMuted}).conversationList.reduce(((t,o)=>t+(o.unreadCount||0)),0)}addFilter(t){var o=generateFilterKey(t);if(void 0!==this.unreadCountByFilter[o])throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST});var a=JSON.parse(o),c=this.getUnreadCountByFilter(a);this.unreadCountByFilter[o]=c,this.service.emit("onUnreadCountChangedByFilter",a,c)}deleteFilter(t){var o=generateFilterKey(t);if(void 0===this.unreadCountByFilter[o])throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST});delete this.unreadCountByFilter[o]}}function generateFilterKey(t){var{conversationTypes:o}=t;return o&&(o=o.sort()),JSON.stringify({conversationGroupId:t.conversationGroupId,conversationTypes:o,ignoreMuted:t.ignoreMuted})}function equals(t){return JSON.stringify(this)===generateFilterKey(t)}var ls={createTime:{type:"number"},updateTime:{type:"number"}};function formatConversationGroups(t){return t&&t.length>0?t.map((t=>formatConversationGroup(t))):[]}function formatConversationGroup(t){return format(ls,t)}function formatFailedMap(t){var o=JSON.parse(t);return Object.keys(o).map((t=>({conversationId:t,error:new V2NIMErrorImpl({code:o[t]})})))}var ps,us={type:{type:"number"},deleteVersion:{type:"number"},conversationIds:{type:"object"}};function formatConversationGroupNotify(t){return format(us,t)}!function(t){t[t.createConversationGroup=1]="createConversationGroup",t[t.deleteConversationGroup=2]="deleteConversationGroup",t[t.updateConversationGroup=3]="updateConversationGroup",t[t.addConversationToGroup=4]="addConversationToGroup",t[t.removeConversationFromGroup=5]="removeConversationFromGroup"}(ps||(ps={}));class V2NIMMessageModel{constructor(){this.messages=new Map,this.maxSize=2e3}reset(){this.messages.clear()}getMessageById(t){if(t)return this.messages.get(t)}getMessagesByConversationId(t){var o=[];return this.messages.forEach((a=>{a.conversationId===t&&o.push(a)})),o}getLastMessageOfConversation(t){var o=this.getMessagesByConversationId(t);if(0!==o.length)return o.reduce(((t,o)=>o.createTime>t.createTime?o:t),o[0])}upsertMessages(t){t.forEach((t=>{this.messages.set(t.messageClientId,t)}));var o=this.messages.size;if(!(o<=this.maxSize))for(var a=Array.from(this.messages.values()).filter((t=>t.sendingState!==ot.V2NIM_MESSAGE_SENDING_STATE_SENDING)).sort(((t,o)=>t.createTime-o.createTime)),c=o-this.maxSize>100?o-this.maxSize:100,m=0;m<c;m++){var h=a[m];h&&this.messages.delete(h.messageClientId)}}deleteMessage(t){this.messages.delete(t)}deleteMessages(t,o){this.messages.forEach((a=>{t===a.conversationId&&(!o||o&&a.createTime<o)&&this.messages.delete(a.messageClientId)}))}}var ms={accountId:{type:"string",allowEmpty:!1},content:{type:"object",required:!1,rules:{msg:{type:"string",allowEmpty:!1},type:{type:"number",allowEmpty:!1}}},messages:{type:"array",required:!1,rules:{msg:{type:"string",allowEmpty:!1},type:{type:"number"},role:{type:"enum",values:[Rt.V2NIM_AI_MODEL_ROLE_TYPE_ASSISTANT,Rt.V2NIM_AI_MODEL_ROLE_TYPE_USER,Rt.V2NIM_AI_MODEL_ROLE_TYPE_SYSTEM]}}},promptVariables:{type:"jsonstr",required:!1},modelConfigParams:{type:"object",required:!1,rules:{prompt:{type:"string",required:!1},maxTokens:{type:"number",required:!1},topP:{type:"number",required:!1},temperature:{type:"number",required:!1}}}},hs=Object.assign({requestId:{type:"string",allowEmpty:!1}},ms),gs={messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:getEnumValues(Be)},createTime:{type:"number"}},_s={routeEnabled:{type:"boolean",required:!1},routeEnvironment:{type:"string",required:!1}},vs={pushEnabled:{type:"boolean",required:!1},pushNickEnabled:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},forcePush:{type:"boolean",required:!1},forceContent:{type:"string",required:!1},forcePushAccountIds:{type:"array",required:!1,itemType:"string"}},Is={antispamEnabled:{type:"boolean",required:!1},antispamBusinessId:{type:"string",required:!1},antispamCustomMessage:{type:"string",required:!1},antispamCheating:{type:"string",required:!1},antispamExtension:{type:"string",required:!1}},Es={messageConfig:{type:"object",required:!1,rules:{readReceiptEnabled:{type:"boolean",required:!1},lastMessageUpdateEnabled:{type:"boolean",required:!1},historyEnabled:{type:"boolean",required:!1},roamingEnabled:{type:"boolean",required:!1},onlineSyncEnabled:{type:"boolean",required:!1},offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1}}},routeConfig:{type:"object",required:!1,rules:_s},pushConfig:{type:"object",required:!1,rules:vs},antiSpamConfig:{type:"object",required:!1,rules:Is},robotConfig:{type:"object",required:!1,rules:{accountId:{type:"string",required:!1},topic:{type:"string",required:!1},function:{type:"string",required:!1},customContent:{type:"string",required:!1}}},aiConfig:{type:"object",required:!1,rules:ms},targetConfig:{type:"object",required:!1,rules:{receiverIds:{type:"array",itemType:"string"},inclusive:{type:"boolean"},newMemberVisible:{type:"boolean",required:!1}}},clientAntispamEnabled:{type:"boolean",required:!1},clientAntispamReplace:{type:"string",required:!1}},fs={message:{type:"object",rules:{text:{type:"string",required:!1},messageType:{type:"enum",values:getEnumValues(rt)},messageClientId:{type:"string",allowEmpty:!1}}},params:{type:"object",rules:Es,required:!1},replyMessage:{type:"object",rules:{conversationType:{type:"enum",values:getEnumValues(Be)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},Ts={conversationId:{type:"string",allowEmpty:!1},message:{type:"object",rules:{text:{type:"string",required:!1},messageType:{type:"enum",values:getEnumValues(rt)},messageClientId:{type:"string",allowEmpty:!1},attachment:{type:"object",required:!1,rules:{file:{type:"file",required:!1}}}}},params:{type:"object",required:!1,rules:Es}},Ms={message:{type:"object",rules:gs},params:{type:"object",rules:{postscript:{type:"string",required:!1},serverExtension:{type:"string",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},env:{type:"string",required:!1}},required:!1}},ys={conversationId:{type:"string",allowEmpty:!1},messageTypes:{type:"array",required:!1,itemType:"enum",values:getEnumValues(rt)},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",values:getEnumValues(st),required:!1},anchorMessage:{type:"object",required:!1,rules:{messageServerId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},Ss={conversationType:{type:"enum",values:getEnumValues(Be)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1}},Ns={messageRefers:{type:"array",required:!0,rules:Ss}},Cs={conversationId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:getEnumValues(Be)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},As={messages:{type:"array",rules:Cs}},Os={conversationId:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1},onlineSync:{type:"boolean",required:!1},deleteRoam:{type:"boolean",required:!1}},Rs={serverExtension:{type:"string",required:!1}},bs={messageClientId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[Be.V2NIM_CONVERSATION_TYPE_P2P]},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},Vs={messages:{type:"array",rules:{messageClientId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[Be.V2NIM_CONVERSATION_TYPE_TEAM]},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},min:1}},Ps={voiceUrl:{type:"string",required:!1,allowEmpty:!1},file:{type:"file",required:!1},voicePath:{type:"string",required:!1,allowEmpty:!1},mimeType:{type:"string",required:!1,allowEmpty:!1},sampleRate:{type:"string",required:!1,allowEmpty:!1},duration:{type:"number",required:!0,min:0},sceneName:{type:"string",required:!1}},ks={message:{type:"object",rules:{conversationType:{type:"enum",values:getEnumValues(Be)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}},index:{type:"number",min:1},serverExtension:{type:"string",required:!1},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},needBadge:{type:"boolean",required:!1},title:{type:"string",required:!1,allowEmpty:!1},content:{type:"string",required:!1,allowEmpty:!1},pushPayload:{type:"string",required:!1,allowEmpty:!1}}}},Ls={messages:{type:"array",rules:{conversationType:{type:"enum",values:getEnumValues(Be)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},Ds={params:{type:"object",rules:{collectionType:{type:"number",min:1},collectionData:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1},uniqueId:{type:"string",required:!1}}}},ws={collections:{type:"array",min:1,rules:{collectionId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},Us={serverExtension:{type:"string",required:!1},collection:{type:"object",rules:{collectionId:{type:"string",allowEmpty:!1},collectionType:{type:"number"},createTime:{type:"number"}}}},xs={beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",required:!1,values:getEnumValues(st)},collectionType:{type:"number",required:!1},anchorCollection:{type:"object",required:!1,rules:{collectionId:{type:"string",allowEmpty:!1,required:!1},createTime:{type:"number",required:!1}}}},Fs={keyword:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},sortOrder:{type:"enum",values:getEnumValues(pt),required:!1},conversationLimit:{type:"number",min:0,required:!1},messageLimit:{type:"number",min:1,required:!1},p2pAccountIds:{type:"array",required:!1,itemType:"string"},teamIds:{type:"array",required:!1,itemType:"string"},senderAccountIds:{type:"array",required:!1,itemType:"string"},messageTypes:{type:"array",required:!1,itemType:"enum",values:getEnumValues(rt)},messageSubtypes:{type:"array",required:!1,itemType:"number"}},Gs={message:{type:"object",rules:{receiverId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[Be.V2NIM_CONVERSATION_TYPE_TEAM]}}}},Bs={messages:{type:"array",rules:{receiverId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[Be.V2NIM_CONVERSATION_TYPE_TEAM]}},min:1}},js={sceneName:{type:"string",required:!1},name:{type:"string",required:!1}},Ys=Object.assign(Object.assign({},js),{duration:{type:"number",required:!1}}),Hs=Object.assign(Object.assign({},Ys),{width:{type:"number",required:!1},height:{type:"number",required:!1}}),$s=Object.assign(Object.assign({},js),{width:{type:"number",required:!1},height:{type:"number",required:!1}}),qs={messageRefer:{type:"object",required:!0,rules:Ss},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",values:getEnumValues(st),required:!1},excludeMessageServerId:{type:"string",required:!1,allowEmpty:!1}},zs={senderId:{type:"string",allowEmpty:!1},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"},messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1}},Ks={subType:{type:"number",min:0,required:!1},text:{type:"string",required:!1},attachment:{type:"object",required:!1},serverExtension:{type:"string",required:!1},routeConfig:{type:"object",required:!1,rules:_s},pushConfig:{type:"object",required:!1,rules:vs},antiSpamConfig:{type:"object",required:!1,rules:Is},clientAntispamEnabled:{type:"boolean",required:!1},clientAntispamReplace:{type:"string",required:!1}};class ReceiptUtil{constructor(t,o){this.p2pMessageReceipts={},this.core=t,this.service=o}sendP2PMessageReceipt(t){return __awaiter(this,void 0,void 0,(function*(){if(validate(bs,t,"",!0),t.senderId===this.core.account)throw new ValidateErrorV2({detail:{reason:`sendP2PMessageReceipt. sender: ${t.senderId} is not allowed to send msg receipt`}});this.p2pMessageReceipts[t.conversationId]>t.createTime||(yield this.core.sendCmd("v2SendP2PMessageReceipt",{tag:{receiverId:t.senderId,messageClientId:t.messageClientId,createTime:t.createTime}}),this.p2pMessageReceipts[t.conversationId]=t.createTime)}))}isPeerRead(t){if(t.conversationType!==Be.V2NIM_CONVERSATION_TYPE_P2P)return!1;if(t.senderId!==this.core.account)return!1;if(t.senderId===this.core.account&&t.receiverId===this.core.account)return!0;var o=this.core.V2NIMConversationIdUtil.messageConversationId(t),a=this.p2pMessageReceipts[o]||0;return t.createTime<=a}getP2PMessageReceipt(t){return __awaiter(this,void 0,void 0,(function*(){if(validateConversationId(this.core.account,t),this.core.V2NIMConversationIdUtil.parseConversationType(t)!==Be.V2NIM_CONVERSATION_TYPE_P2P)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getP2PMessageReceipt: conversationId is not p2p conversationId"}});return{conversationId:t,timestamp:this.p2pMessageReceipts[t]||0}}))}getTeamMessageReceipts(t){return __awaiter(this,void 0,void 0,(function*(){if(validate(Bs,{messages:t},"",!0),t.some((t=>t.senderId!==this.core.account)))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceipts: exist messages senderId is not current user"}});if(t.some((o=>o.receiverId!==t[0].receiverId)))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getTeamMessageReceipts: exist messages receiverId is not same"}});return(yield this.core.sendCmd("v2GetTeamMessageReceipts",{tag:t})).content.data.map((t=>Object.assign(Object.assign({},t),{conversationId:this.core.V2NIMConversationIdUtil.teamConversationId(t.receiverId)})))}))}getTeamMessageReceiptDetail(t){return __awaiter(this,void 0,void 0,(function*(){if(validate(Gs,{message:t},"",!0),t.senderId!==this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:`getTeamMessageReceiptDetail::senderId ${t.senderId} incorrect`}});var o=yield this.core.sendCmd("v2GetTeamMessageReceiptDetail",{tag:t});return{readReceipt:{conversationId:this.core.V2NIMConversationIdUtil.teamConversationId(t.receiverId),messageClientId:t.messageClientId,messageServerId:t.messageServerId,readCount:o.content.readAccountList.length,unreadCount:o.content.unreadAccountList.length},readAccountList:o.content.readAccountList,unreadAccountList:o.content.unreadAccountList}}))}sendTeamMessageReceipts(t){return __awaiter(this,void 0,void 0,(function*(){if(validate(Vs,{messages:t},"",!0),t.some((t=>t.senderId===this.core.account)))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceipts: exist messages senderId is not current user"}});if(t.some((o=>o.receiverId!==t[0].receiverId)))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceipts: exist messages receiverId is not same"}});yield this.core.sendCmd("v2SendTeamMessageReceipts",{tag:t})}))}syncP2PMessagReceiptsHandler(t){var o=t.content.data.map((t=>{var o=this.core.V2NIMConversationIdUtil.p2pConversationId(t.senderId),a=t.createTime;return this.p2pMessageReceipts[o]=a,{conversationId:o,timestamp:a}}));this.service.emit("onReceiveP2PMessageReadReceipts",o)}onP2PMessageReceiptsHandler(t){var o=this.core.V2NIMConversationIdUtil.p2pConversationId(t.content.data.senderId),a=t.content.data.createTime;this.p2pMessageReceipts[o]=a,this.service.emit("onReceiveP2PMessageReadReceipts",[{conversationId:o,timestamp:a}])}onTeamMessageReceiptsHandler(t){var o=t.content.data.map((t=>({conversationId:this.core.V2NIMConversationIdUtil.teamConversationId(t.receiverId),messageServerId:t.messageServerId,messageClientId:t.messageClientId,readCount:t.readCount,unreadCount:t.unreadCount,latestReadAccount:t.latestReadAccount})));this.service.emit("onReceiveTeamMessageReadReceipts",o)}}class FileUtil{constructor(t,o){this.core=t,this.service=o}doSendFile(t,o){return __awaiter(this,void 0,void 0,(function*(){var a=t.attachment;try{var[c,m]=yield this.core.V2NIMStorageService._uploadFile({taskId:t.messageClientId,uploadParams:{fileObj:(null==a?void 0:a.file)||(null==a?void 0:a.path),sceneName:null==a?void 0:a.sceneName}},o,{fileType:t.messageType}),h=Object.assign(Object.assign({},a),{uploadState:nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS});void 0!==m.w&&(h.width=h.width||m.w),void 0!==m.h&&(h.height=h.height||m.h),void 0!==m.dur&&(h.duration=h.duration||m.dur),h.ext=h.ext&&-1===h.ext.indexOf(".")?`.${h.ext}`:h.ext;var g=["w","h","dur","ext","name"];for(var _ in m)g.includes(_)||(h[_]=m[_]);var{raw:I,file:E,path:T}=h,M=__rest(h,["raw","file","path"]);t.attachment=JSON.parse(JSON.stringify(M)),t.attachment&&(t.attachment.raw=attachmentToRaw(t.messageType,t.attachment))}catch(o){throw t.attachment&&(t.attachment.uploadState=nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED),o}}))}cancelMessageAttachmentUpload(t){return __awaiter(this,void 0,void 0,(function*(){if(validate({messageClientId:{type:"string",allowEmpty:!1}},t,"",!0),![rt.V2NIM_MESSAGE_TYPE_AUDIO,rt.V2NIM_MESSAGE_TYPE_FILE,rt.V2NIM_MESSAGE_TYPE_IMAGE,rt.V2NIM_MESSAGE_TYPE_VIDEO].includes(t.messageType))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:`cancelMessageAttachmentUpload: messageType ${t.messageType} incorrect`}});if(t.sendingState===ot.V2NIM_MESSAGE_SENDING_STATE_FAILED||t.sendingState===ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST,detail:{reason:"cancelMessageAttachmentUpload: message is already failed or succeeded"}});yield this.core.V2NIMStorageService._cancelUploadFile(t.messageClientId)}))}}class SendUtil{constructor(t,o){this.uploadingMessageInfo={},this.core=t,this.service=o}prepareMessage(t,o,a,c){var m=this.checkIfResend(t),h=this.generateSendMessage({message:t,params:a,resend:m,conversationId:o,replyMessage:c}),g=Object.assign({},a.targetConfig?{targetConfig:a.targetConfig}:{}),{clientAntispamResult:_,text:I}=this.checkIfAntispam(a,h);return h.text=I,h.clientAntispamHit=!!_&&_.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD,{messageBeforeSend:h,clientAntispamResult:_,hiddenParams:g}}checkIfAntispam(t,o){var a,c=o.text;if(t.clientAntispamEnabled&&(o.messageType===rt.V2NIM_MESSAGE_TYPE_TEXT||o.messageType===rt.V2NIM_MESSAGE_TYPE_TIPS))if((a=this.core.V2NIMClientAntispamUtil.checkTextAntispam(o.text||"",t.clientAntispamReplace)).operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE)c=a.replacedText;else if(a.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD)throw this.service.emit("onSendMessage",Object.assign(Object.assign({},o),{sendingState:ot.V2NIM_MESSAGE_SENDING_STATE_FAILED,messageStatus:{errorCode:wt.V2NIM_ERROR_CODE_CLIENT_ANTISPAM}})),new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,detail:{reason:"sendMessage: text intercepted by client antispam"}});return{clientAntispamResult:a,text:c}}doMsgReceiveReport(t,o){if(t.senderId!==this.core.account){var a=Ue(t,"__clientExt.statistics.apiCallingTime")||0,c=Ue(t,"__clientExt.statistics.sendTime")||0,m=Ue(t,"__clientExt.statistics.attachUploadDuration")||0,h=this.core.timeOrigin.getNTPTime(),g=t.createTime,_=this.core.timeOrigin.checkNodeReliable(o.__receiveTimeNode)?this.core.timeOrigin.getNTPTime(o.__receiveTimeNode):h;this.core.reporter.report("msgReceive",{msgId:t.messageServerId,clientId:t.messageClientId,serverTime:t.createTime,receiveTime:_,fromAccid:t.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P?t.senderId:"",toAccid:t.receiverId,type:conversationTypeV2ToV1(t.conversationType),tid:t.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P?"":t.receiverId,apiCallingTime:a,sendTime:c,attachUploadDuration:m,callbackTime:h,preHandleTime:h,result:200,failReason:"",rt:h-g})}}checkIfResend(t){var o=this.service.model.getMessageById(t.messageClientId),a=!1;if(t.messageServerId||t.sendingState===ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message has already been sent"}});if((null==o?void 0:o.sendingState)===ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message has already been sent"}});return o&&(a=!0),a}doSendMessage(t){return __awaiter(this,void 0,void 0,(function*(){var o,a,{apiCallingTimeNode:c,messageBeforeSend:m,clientAntispamResult:h,hiddenParams:g,progress:_}=t,I={};if(m.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P)o="v2SendP2pMessage";else if(m.conversationType===Be.V2NIM_CONVERSATION_TYPE_TEAM)o="v2SendTeamMessage";else{if(m.conversationType!==Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM)throw new ValidateErrorV2({detail:{reason:`conversationType: ${m.conversationType} is not supported`}});o="v2SendSuperTeamMessage"}if(this.service.sendMessageHandler(m),this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",m),!m.attachment||!("uploadState"in m.attachment)||m.attachment.url||m.attachment.uploadState!==nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN&&m.attachment.uploadState!==nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED)this.service.emit("onSendMessage",m);else{var E=Date.now();try{m.attachmentUploadState=nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING,m.attachment.uploadState=nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING,this.service.emit("onSendMessage",m),yield this.service.fileUtil.doSendFile(m,_),m.attachmentUploadState=nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS,m.attachment.uploadState=nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS,this.service.emit("onSendMessage",m)}catch(t){throw m.attachmentUploadState=nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED,m.attachment.uploadState=nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED,m.sendingState=ot.V2NIM_MESSAGE_SENDING_STATE_FAILED,m.messageStatus={errorCode:t.code||wt.V2NIM_ERROR_CODE_UNKNOWN},this.service.emit("onSendMessage",m),I.attachUploadDuration=Date.now()-E,this.doSendMessageFailed(c,I,m,t),t}I.attachUploadDuration=Date.now()-E}this.core.timeOrigin.checkNodeReliable(c)&&(I.apiCallingTime=this.core.timeOrigin.getNTPTime(c),I.sendTime=this.core.timeOrigin.getNTPTime(),m.__clientExt={statistics:I});try{a=yield this.core.sendCmd(o,{tag:Object.assign({},m,g)})}catch(t){throw this.doSendMessageFailed(c,I,m,t),m.sendingState=ot.V2NIM_MESSAGE_SENDING_STATE_FAILED,m.messageStatus={errorCode:t.code||wt.V2NIM_ERROR_CODE_UNKNOWN},this.service.emit("onSendMessage",m),t}var T=Ue(a,"content.data.errorCode"),M=Object.assign(Object.assign(Object.assign({},m),a.content.data),{sendingState:ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED,messageStatus:{errorCode:T&&200!==T?T:200}});this.service.sendMessageHandler(M),this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",M),this.doMsgSendReport(c,I,m);var S=M.antispamResult;return S&&(M.messageStatus.errorCode=wt.V2NIM_ERROR_CODE_SERVER_ANTISPAM),delete M.antispamResult,this.service.emit("onSendMessage",M),Object.assign(Object.assign({message:M},S?{antispamResult:S}:{}),h?{clientAntispamResult:h}:{})}))}doSendMessageFailed(t,o,a,c){var m=Object.assign(Object.assign({},a),{sendingState:ot.V2NIM_MESSAGE_SENDING_STATE_FAILED});this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",m),this.service.sendMessageHandler(m),this.doMsgSendReport(t,o,a,c)}doMsgSendReport(t,o,a,c){o.apiCallingTime=this.core.timeOrigin.getNTPTime(t),o.sendTime=this.core.timeOrigin.getNTPTime();var m=this.core.timeOrigin.getNTPTime(),h=Ue(c,"detail.reason");this.core.reporter.report("msgSend",{msgId:a.messageServerId,clientId:a.messageClientId,msgTime:a.createTime,fromAccid:a.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P?a.senderId:"",toAccid:a.receiverId,type:conversationTypeV2ToV1(a.conversationType),tid:a.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P?"":a.receiverId,result:c?c.code:200,failReason:h||(null==c?void 0:c.message)||"",rt:m-o.apiCallingTime,apiCallingTime:o.apiCallingTime,sendTime:o.sendTime,attachUploadDuration:o.attachUploadDuration,apiCallbackTime:m})}generateSendMessage(t){var{conversationId:o,replyMessage:a,resend:c,message:m,params:h}=t,g={};if(a){var _=a.threadRoot;g={threadReply:{senderId:a.senderId,receiverId:a.receiverId,messageServerId:a.messageServerId,createTime:a.createTime,messageClientId:a.messageClientId,conversationType:a.conversationType,conversationId:a.conversationId},threadRoot:{senderId:_?_.senderId:a.senderId,receiverId:_?_.receiverId:a.receiverId,messageServerId:_?_.messageServerId:a.messageServerId,createTime:_?_.createTime:a.createTime,messageClientId:_?_.messageClientId:a.messageClientId,conversationType:_?_.conversationType:a.conversationType,conversationId:_?_.conversationId:a.conversationId}}}var I=this.core.V2NIMConversationIdUtil.parseConversationType(o),E=this.core.V2NIMConversationIdUtil.parseConversationTargetId(o);h.pushConfig&&!0!==h.pushConfig.forcePush&&(delete h.pushConfig.forcePushContent,delete h.pushConfig.forcePushAccountIds);var T={},M={};if(h.aiConfig){var S=Ue(h,"aiConfig.content.msg"),N=Ue(h,"aiConfig.content.type")||0;S?M={msg:S,type:N}:void 0===S&&m.messageType===rt.V2NIM_MESSAGE_TYPE_TEXT&&(M={msg:m.text||"",type:N}),(T=Object.assign({},h.aiConfig)).aiStatus=et.V2NIM_MESSAGE_AI_STATUS_AT,void 0!==M.msg&&(T.content=M)}var C=this.core.V2NIMUserService.model.getUser(this.core.account),A=(null==C?void 0:C.updateTime)||0;return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},m),g),{messageConfig:Object.assign(Object.assign({},m.messageConfig),h.messageConfig),routeConfig:Object.assign(Object.assign({},m.routeConfig),h.routeConfig),pushConfig:Object.assign(Object.assign({},m.pushConfig),h.pushConfig),antispamConfig:Object.assign(Object.assign({},m.antispamConfig),h.antispamConfig),robotConfig:Object.assign(Object.assign({},m.robotConfig),h.robotConfig)}),T&&T.accountId?{aiConfig:T}:{}),m.attachment?{attachment:Object.assign({},m.attachment)}:{}),{resend:c,senderId:this.core.account,conversationType:I,receiverId:E,conversationId:this.core.V2NIMConversationIdUtil.messageConversationId({conversationType:I,senderId:this.core.account,receiverId:E})}),A?{userUpdateTime:A}:{}),{sendingState:ot.V2NIM_MESSAGE_SENDING_STATE_SENDING})}}class ModifyUtil{constructor(t,o){this.core=t,this.service=o}checkIfModify(t,o){if("0"===t.messageServerId)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: messageServerId cannot be empty"}});if(t.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P&&t.senderId!==this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: senderId should be self"}});if(![rt.V2NIM_MESSAGE_TYPE_TEXT,rt.V2NIM_MESSAGE_TYPE_IMAGE,rt.V2NIM_MESSAGE_TYPE_AUDIO,rt.V2NIM_MESSAGE_TYPE_VIDEO,rt.V2NIM_MESSAGE_TYPE_LOCATION,rt.V2NIM_MESSAGE_TYPE_FILE,rt.V2NIM_MESSAGE_TYPE_TIPS,rt.V2NIM_MESSAGE_TYPE_CALL,rt.V2NIM_MESSAGE_TYPE_CUSTOM].includes(t.messageType))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:`modifyMessage: messageType ${t.messageType} not correct`}});if([rt.V2NIM_MESSAGE_TYPE_TEXT,rt.V2NIM_MESSAGE_TYPE_IMAGE,rt.V2NIM_MESSAGE_TYPE_AUDIO,rt.V2NIM_MESSAGE_TYPE_VIDEO,rt.V2NIM_MESSAGE_TYPE_FILE,rt.V2NIM_MESSAGE_TYPE_TIPS,rt.V2NIM_MESSAGE_TYPE_CALL].includes(t.messageType)&&o.attachment)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:`modifyMessage: messageType ${t.messageType} can not modify attachment`}});var a=["subType","text","serverExtension","attachment"];if(!a.some((t=>void 0!==Ue(o,t))))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: missing modified params"}});if(a.every((a=>"attachment"===a?t.attachment&&o.attachment?attachmentToRaw(t.messageType,t.attachment)===attachmentToRaw(t.messageType,o.attachment):!o.attachment:Ue(t,a)===Ue(o,a))))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: no change"}})}prepareMessage(t,o){var a=this.generateSendMessage(t,o),{clientAntispamResult:c,text:m}=this.checkIfAntispam(o,a);return a.text=m,a.clientAntispamHit=!!c&&c.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD,{messageBeforeSend:a,clientAntispamResult:c}}modifyMessage(t,o){return __awaiter(this,void 0,void 0,(function*(){var a;if(t.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P)a="v2MessageP2pModify";else if(t.conversationType===Be.V2NIM_CONVERSATION_TYPE_TEAM)a="v2MessageTeamModify";else{if(t.conversationType!==Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM)throw new ValidateErrorV2({detail:{reason:`conversationType: ${t.conversationType} is not supported`}});a="v2MessageSuperTeamModify"}var c=yield this.core.sendCmd(a,{tag:t});if(o&&o.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD)return{errorCode:wt.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,clientAntispamResult:o};var m=Object.assign(Object.assign({},t),c.content.data),h=m.antispamResult;if(h)return Object.assign({errorCode:wt.V2NIM_ERROR_CODE_SERVER_ANTISPAM,antispamResult:h},o?{clientAntispamResult:o}:{});delete m.antispamResult;var g=completeMessage(this.core,m);return this.service.model.upsertMessages([g]),this.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",g),Object.assign(Object.assign({errorCode:200,message:g},h?{antispamResult:h}:{}),o?{clientAntispamResult:o}:{})}))}checkIfAntispam(t,o){var a,c=o.text;if(t.clientAntispamEnabled&&(o.messageType===rt.V2NIM_MESSAGE_TYPE_TEXT||o.messageType===rt.V2NIM_MESSAGE_TYPE_TIPS))if((a=this.core.V2NIMClientAntispamUtil.checkTextAntispam(o.text||"",t.clientAntispamReplace)).operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE)c=a.replacedText;else if(a.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,detail:{reason:"sendMessage: text intercepted by client antispam"}});return{clientAntispamResult:a,text:c}}generateSendMessage(t,o){var a;return Object.assign(Object.assign({messageConfig:{lastMessageUpdateEnabled:null===(a=t.messageConfig)||void 0===a?void 0:a.lastMessageUpdateEnabled},routeConfig:Object.assign({routeEnabled:!0},o.routeConfig),pushConfig:Object.assign({pushEnabled:!0,pushNickEnabled:!0,forcePush:!1},o.pushConfig),antispamConfig:Object.assign({antispamEnabled:!0},o.antispamConfig)},o.attachment?{attachment:o.attachment}:{}),{conversationType:t.conversationType,senderId:t.senderId,receiverId:t.receiverId,createTime:t.createTime,messageClientId:t.messageClientId,messageServerId:t.messageServerId,messageType:t.messageType,subType:o.subType,text:o.text,serverExtension:o.serverExtension})}}class V2NIMClientAntispamUtilImpl{constructor(t){this.core=t}reset(t){t===Co.Destroy&&(this.vocabInfo=void 0)}downloadLocalAntiSpamVocabs(){return __awaiter(this,void 0,void 0,(function*(){if(!this.vocabInfo)try{var t=yield this.core.sendCmd("v2DownloadLocalAntiSpamVocabs",{tag:{version:0,md5:""}});this.vocabInfo=Object.assign(Object.assign({},t.content.data),{thesaurus:JSON.parse(t.content.data.thesaurus).thesaurus})}catch(t){this.core.logger.warn("V2NIMLocalAntispamUtil::downloadLocalAntiSpamVocabs error",t)}}))}checkTextAntispam(t,o="**"){if(validate({text:{type:"string",required:!0,allowEmpty:!1},replace:{type:"string"}},{text:t,replace:o},"",!0),!this.vocabInfo)return{operateType:lt.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE,replacedText:t};for(var a=t,c=0;c<this.vocabInfo.thesaurus.length;c++){var m=this.filterContent(a,this.vocabInfo.thesaurus[c],o);if(a=m.replacedText,m.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD||m.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD)return m}return{operateType:a===t?lt.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE:lt.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE,replacedText:a}}filterContent(t,o,a){for(var c=0;c<o.keys.length;c++){var m=o.keys[c],h=m.match||o.match,g=m.operate||o.operate,_=void 0;try{_=this.matchContent(t,m.key,h,g,a)}catch(t){}if(_&&(t=_.replacedText,_.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD||_.operateType===lt.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD))return _}return{operateType:lt.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE,replacedText:t}}matchContent(t,o,a,c,m){var h=!1,g="";if(1===a)t.indexOf(o)>=0&&(h=!0,g=o);else if(2===a){new RegExp(o,"g").test(t)&&(h=!0)}if(h&&""!==g)switch(c){case 1:return{operateType:lt.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE,replacedText:t.replace(g,m)};case 2:return{operateType:lt.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD,replacedText:t};case 3:return{operateType:lt.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD,replacedText:t}}return{operateType:lt.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE,replacedText:t}}}function getFileOrPath(t){var o="object"==typeof t?t:void 0,a="string"==typeof t?t:void 0;if(!o&&!a)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getFileOrPath::incorrect file and path"}});if("string"==typeof a)if(0===a.indexOf("nim-external")){var c=document.getElementById(a);if(!(c&&c.files&&c.files[0]))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_FILE_NOT_FOUND,detail:{reason:`getFileOrPath::file not exist: ${a}`}});o=c.files[0]}else if("BROWSER"===ai.platform)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:`getFileOrPath::incorrect path: ${a}`}});if("object"==typeof o&&void 0===o.size)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getFileOrPath::file no size"}});return{file:o,path:a}}class V2NIMMessageCreatorImpl extends V2Service{constructor(t){super("V2NIMMessageCreator",t),this.name="V2NIMMessageCreator",this.defaultNosSceneName="nim_default_im",this.core=t}createMessage(t,o){return Object.assign(Object.assign(Object.assign({messageClientId:Ai(),messageType:t,createTime:Date.now(),sendingState:ot.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN,messageStatus:{errorCode:200},isSelf:!0},o),o.attachment?{attachment:Object.assign(Object.assign({},o.attachment),{raw:attachmentToRaw(t,o.attachment)})}:{}),{senderId:"",receiverId:"",conversationType:0,conversationId:"",messageServerId:"",messageConfig:Object.assign({unreadEnabled:!0,roamingEnabled:!0,readReceiptEnabled:!1,lastMessageUpdateEnabled:!0,historyEnabled:!0,onlineSyncEnabled:!0,offlineEnabled:!0},o.messageConfig),pushConfig:Object.assign({pushEnabled:!0,pushNickEnabled:!0,forcePush:!1},o.pushConfig),routeConfig:Object.assign({routeEnabled:!0},o.routeConfig),antispamConfig:Object.assign({antispamEnabled:!0},o.antispamConfig)})}createTextMessage(t){return this.checkV2(),validate({text:{type:"string",allowEmpty:!1}},{text:t},"",!0),this.createMessage(rt.V2NIM_MESSAGE_TYPE_TEXT,{text:t})}createImageMessage(t,o,a,c,m){this.checkV2(),validate($s,{name:o,sceneName:a,width:c,height:m},"",!0);var h=this.createGenericFileMessageAttachment(t,o,a,void 0,c,m);return this.createMessage(rt.V2NIM_MESSAGE_TYPE_IMAGE,{attachment:h,attachmentUploadState:nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN})}createAudioMessage(t,o,a,c){this.checkV2(),validate(Ys,{name:o,sceneName:a,duration:c},"",!0);var m=this.createGenericFileMessageAttachment(t,o,a,c);return this.createMessage(rt.V2NIM_MESSAGE_TYPE_AUDIO,{attachment:m,attachmentUploadState:nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN})}createVideoMessage(t,o,a,c,m,h){this.checkV2(),validate(Hs,{name:o,sceneName:a,duration:c,width:m,height:h},"",!0);var g=this.createGenericFileMessageAttachment(t,o,a,c,m,h);return this.createMessage(rt.V2NIM_MESSAGE_TYPE_VIDEO,{attachment:g,attachmentUploadState:nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN})}createFileMessage(t,o,a){this.checkV2(),validate(js,{name:o,sceneName:a},"",!0);var c=this.createGenericFileMessageAttachment(t,o,a);return this.createMessage(rt.V2NIM_MESSAGE_TYPE_FILE,{attachment:c,attachmentUploadState:nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN})}createGenericFileMessageAttachment(t,o,a,c,m,h){if(a=a||this.defaultNosSceneName,!this.core.V2NIMStorageService.hasStorageScene(a))throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sceneName: "+a+" has not been added"}});var{file:g,path:_}=getFileOrPath(t),I=Object.assign(Object.assign(Object.assign({name:o,uploadState:nt.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN,sceneName:a||this.defaultNosSceneName},c?{duration:c}:{}),m?{width:m}:{}),h?{height:h}:{});if(g){var E=g.name.lastIndexOf("."),T=-1===E?g.name:g.name.substring(0,E);I.name=I.name||T,I.size=g.size,I.ext=getFileExtension(g.name)}else if(_){var M=_.lastIndexOf("/"),S=_.lastIndexOf("."),N=-1===S?_.substring(M+1):_.substring(M+1,S);I.name=I.name||N,I.ext=getFileExtension(_)}return I=JSON.parse(JSON.stringify(I)),_?I.path=_:g&&(I.file=g),I}createLocationMessage(t,o,a){return this.checkV2(),validate({latitude:{type:"number",allowEmpty:!1},longitude:{type:"number",allowEmpty:!1},address:{type:"string",allowEmpty:!1}},{latitude:t,longitude:o,address:a},"",!0),this.createMessage(rt.V2NIM_MESSAGE_TYPE_LOCATION,{attachment:{latitude:t,longitude:o,address:a}})}createCustomMessage(t,o){return this.checkV2(),validate({text:{type:"string",allowEmpty:!1}},{text:t},"",!0),validate({rawAttachment:{type:"string"}},{rawAttachment:o},"",!0),this.createMessage(rt.V2NIM_MESSAGE_TYPE_CUSTOM,{text:t,attachment:{raw:o}})}createCallMessage(t,o,a,c,m){return this.checkV2(),validate({type:{type:"number",allowEmpty:!1}},{type:t},"",!0),validate({channelId:{type:"string",allowEmpty:!1}},{channelId:o},"",!0),validate({status:{type:"number",allowEmpty:!1}},{status:a},"",!0),validate({durations:{type:"array",allowEmpty:!1}},{durations:c},"",!0),this.createMessage(rt.V2NIM_MESSAGE_TYPE_CALL,{text:m||"",attachment:{type:t,channelId:o,durations:c,status:a}})}createForwardMessage(t){this.checkV2();var o=[rt.V2NIM_MESSAGE_TYPE_ROBOT,rt.V2NIM_MESSAGE_TYPE_NOTIFICATION,rt.V2NIM_MESSAGE_TYPE_AVCHAT,rt.V2NIM_MESSAGE_TYPE_TIPS];if(!t||o.includes(t.messageType))return null;var a={messageClientId:Ai(),messageType:t.messageType};return t.text&&(a.text=t.text),t.attachment&&(a.attachment=t.attachment),t.attachment&&"uploadState"in t.attachment&&(a.attachmentUploadState=t.attachment.uploadState),this.createMessage(t.messageType,a)}createTipsMessage(t){return this.checkV2(),validate({text:{type:"string",allowEmpty:!1}},{text:t},"",!0),this.createMessage(rt.V2NIM_MESSAGE_TYPE_TIPS,{text:t})}}var Ws,Js,Xs={file:{md5:"$(Etag)",size:"$(ObjectSize)"},image:{md5:"$(Etag)",size:"$(ObjectSize)",w:"$(ImageInfo.Width)",h:"$(ImageInfo.Height)",orientation:"$(ImageInfo.Orientation)"},audio:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Audio.Duration)"},video:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Video.Duration)",w:"$(AVinfo.Video.Width)",h:"$(AVinfo.Video.Height)"}},Qs={accessKeyId:"",secretAccessKey:"",sessionToken:"",region:"",maxRetries:0,bucket:"",objectName:"",token:"",shortUrl:""};function getUploadResponseFormat(t="file"){var o=Xs[t]||{};return JSON.stringify(o).replace(/"/gi,'\\"')}!function(t){t[t.nos=1]="nos",t[t.s3=2]="s3"}(Ws||(Ws={})),function(t){t[t.dontNeed=-1]="dontNeed",t[t.time=2]="time",t[t.urls=3]="urls"}(Js||(Js={}));var Zs={chunkUploadHost:"https://wannos-web.127.net",commonUploadHost:"https://fileup.chatnos.com",commonUploadHostBackupList:["https://oss.chatnos.com"],chunkMaxSize:4194304e4,commonMaxSize:104857600,uploadReplaceFormat:"https://{host}/{object}",cdn:{defaultCdnDomain:"nim-nosdn.netease.im",cdnDomain:"",bucket:"",objectNamePrefix:""},downloadUrl:"https://{bucket}-nosdn.netease.im/{object}",downloadHostList:["nos.netease.com"],nosCdnEnable:!0,isNeedToGetUploadPolicyFromServer:!0};var ea=function baseSet(t,o,a,c){if(!L(t))return t;for(var m=-1,h=(o=Le(o,t)).length,g=h-1,_=t;null!=_&&++m<h;){var I=De(o[m]),E=a;if("__proto__"===I||"constructor"===I||"prototype"===I)return t;if(m!=g){var T=_[I];void 0===(E=c?c(T,I,_):void 0)&&(E=L(T)?T:wr(o[m+1])?[]:{})}Pr(_,I,E),_=_[I]}return t};var ta=function basePickBy(t,o,a){for(var c=-1,m=o.length,h={};++c<m;){var g=o[c],_=we(t,g);a(_,g)&&ea(h,Le(g,t),_)}return h},ra=Object.getOwnPropertySymbols?function(t){for(var o=[];t;)bn(o,wn(t)),t=nr(t);return o}:kn;var ia=function getAllKeysIn(t){return Vn(t,jr,ra)};var na=function pickBy(t,o){if(null==t)return{};var a=Re(ia(t),(function(t){return[t]}));return o=uo(o),ta(t,a,(function(t,a){return o(t,a[0])}))};class NOS{constructor(t,o){this.nosCdnHostTimer=0,this.nosErrorCount=0,this.core=t,this.cloudStorage=o}get config(){return this.cloudStorage.config}reset(){this.nosErrorCount=0}getNosAccessToken(t){return __awaiter(this,void 0,void 0,(function*(){var o=yield this.core.sendCmd("getNosAccessToken",{tag:t}),a=Ue(o,"content.nosAccessTokenTag.token"),c=t.url;return{token:a,url:-1!==c.indexOf("?")?c+"&token="+a:c+"?token="+a}}))}deleteNosAccessToken(t){return __awaiter(this,void 0,void 0,(function*(){yield this.core.sendCmd("deleteNosAccessToken",{tag:t})}))}nosUpload(t,o){var a,c,m,h,g,_,I,E;return __awaiter(this,void 0,void 0,(function*(){var T=Ue(this.core,"config.cdn.bucket"),M={tag:t.nosScenes||T||"nim"};t.nosSurvivalTime&&(M.expireSec=t.nosSurvivalTime);var S,N=this.core.adapters.getFileUploadInformation(t);if(!o&&!N)try{S=yield this.core.sendCmd("getNosToken",{responseBody:getUploadResponseFormat(t.type),nosToken:M})}catch(t){if(this.core.logger.error("uploadFile:: getNosToken error",t),t instanceof V2NIMErrorImpl)throw t;throw new UploadError({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"getNosToken error",rawError:t,curProvider:1}})}var C=this.config.uploadReplaceFormat.replace("{host}",this.config.cdn.cdnDomain||this.config.cdn.defaultCdnDomain).replace("{object}",N?null===(a=N.uploadInfo)||void 0===a?void 0:a.objectName:o?null==o?void 0:o.objectName:S.content.nosToken.objectName),A="";o&&o.shortUrl&&(A=o.shortUrl),(null===(h=null===(m=null===(c=null==N?void 0:N.uploadInfo)||void 0===c?void 0:c.payload)||void 0===m?void 0:m.mixStoreToken)||void 0===h?void 0:h.shortUrl)&&(A=N.uploadInfo.payload.mixStoreToken.shortUrl);var O,R=A||C;try{var b=N?{token:null===(g=null==N?void 0:N.uploadInfo)||void 0===g?void 0:g.token,bucket:null===(_=null==N?void 0:N.uploadInfo)||void 0===_?void 0:_.bucketName,objectName:null===(I=null==N?void 0:N.uploadInfo)||void 0===I?void 0:I.objectName}:o||S.content.nosToken;this.core.logger.debug("uploadFile:: uploadFile params",{nosToken:b,chunkUploadHost:this.config.chunkUploadHost,commonUploadHost:this.config.commonUploadHost,commonUploadHostBackupList:this.config.commonUploadHostBackupList,platform:ai.platform});var V="BROWSER"===ai.platform?this.config.chunkUploadHost:`${this.config.commonUploadHost}/${b&&b.bucket}`;this.core.reporterHookCloudStorage.update({remote_addr:V,operation_type:o?2:0}),O=yield this.core.adapters.uploadFile(Object.assign(Object.assign(Object.assign({},t),{nosToken:b,chunkUploadHost:this.config.chunkUploadHost,commonUploadHost:this.config.commonUploadHost,commonUploadHostBackupList:this.config.commonUploadHostBackupList,maxSize:t.maxSize||this.config.chunkMaxSize}),o?{payload:{mixStoreToken:o}}:{}))}catch(a){this.core.logger.error("uploadFile::nos uploadFile error:",a);var P="v2"===Ue(this.core,"options.apiVersion");if(a.code===wt.V2NIM_ERROR_CODE_CANCELLED||10499===a.errCode)throw new UploadError({code:P?wt.V2NIM_ERROR_CODE_CANCELLED:400,detail:{reason:Ue(a,"message")||"Request abort",rawError:a,curProvider:1}});if(P&&a.errCode===wt.V2NIM_ERROR_CODE_FILE_OPEN_FAILED)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_FILE_OPEN_FAILED,detail:{reason:Ue(a,"message")||"Read file failed",rawError:a,curProvider:1}});var{net_connect:k}=yield ai.net.getNetworkStatus();if(!1===k)throw new UploadError({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"No network",rawError:a,curProvider:1}});if(o){if(0===this.nosErrorCount){try{this.cloudStorage.mixStorage._addCircuitTimer()}catch(o){throw new UploadError({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"All upload attempts failed",rawError:o,curProvider:this.cloudStorage.mixStorage.curProvider,mixStorePolicy:this.cloudStorage.mixStorage.mixStorePolicy,file:t.file||t.filePath}})}return this.nosErrorCount=Ue(this.cloudStorage,"mixStorePolicy.nosPolicy.uploadConfig.retryPolicy.retry"),this.cloudStorage._uploadFile(t)}return this.nosErrorCount--,this.nosUpload(t,o)}throw new UploadError({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"NOS attempts failed",rawError:a,curProvider:1}})}var L=null==O?void 0:O.type,D=L&&L.indexOf("/")>-1?L.slice(0,L.indexOf("/")):"";D||(D=t.type||"");var w,U={image:"imageInfo",video:"vinfo",audio:"vinfo"};if(!U[D])return Object.assign({url:R},O);try{w=yield this.core.adapters.request(`${C}?${U[D]}`,{method:"GET",dataType:"json",timeout:5e3},{exception_service:3})}catch(t){return this.core.logger.error("uploadFile:: fetch file info error",t),Object.assign({url:R},O)}if(w){var{data:x}=w,G="imageInfo"===U[D]?x:null===(E=null==x?void 0:x.GetVideoInfo)||void 0===E?void 0:E.VideoInfo,B={url:R,name:O.name,size:O.size,ext:O.ext,w:null==G?void 0:G.Width,h:null==G?void 0:G.Height,orientation:null==G?void 0:G.Orientation,dur:null==G?void 0:G.Duration,audioCodec:null==G?void 0:G.AudioCodec,videoCodec:null==G?void 0:G.VideoCodec,container:null==G?void 0:G.Container};return na(B,(function(t,o){return void 0!==o}))}return Object.assign({url:R},O)}))}_getNosCdnHost(){var t;return __awaiter(this,void 0,void 0,(function*(){var o;try{o=yield this.core.sendCmd("getNosCdnHost")}catch(t){return void this.core.logger.error("getNosCdnHost::error",t)}if(o){var a=null===(t=null==o?void 0:o.content)||void 0===t?void 0:t.nosConfigTag,c=parseInt(null==a?void 0:a.expire);0!==c&&a.cdnDomain?-1===c?(this.config.cdn.bucket=a.bucket,this.config.cdn.cdnDomain=a.cdnDomain,this.config.cdn.objectNamePrefix=a.objectNamePrefix):(this.config.cdn.bucket=a.bucket,this.config.cdn.cdnDomain=a.cdnDomain,this.config.cdn.objectNamePrefix=a.objectNamePrefix,this.nosCdnHostTimer=this.core.timerManager.addTimer((()=>{this._getNosCdnHost()}),1e3*c)):(this.config.cdn.bucket="",this.config.cdn.cdnDomain="",this.config.cdn.objectNamePrefix="")}}))}}var oa={"6_2":"getNosToken","6_22":"getOriginUrl","6_24":"getNosAccessToken","6_25":"deleteNosAccessToken","6_26":"getNosCdnHost","6_27":"getGrayscaleConfig","6_28":"getMixStorePolicy","6_29":"getMixStoreToken","6_30":"getFileAuthToken"},sa={nosToken:{objectName:1,token:2,bucket:3,expireTime:4,expireSec:7,tag:8,shortUrl:9},mixStoreTokenReqTag:{provider:0,tokenCount:1,nosSurvivalTime:2,tag:3,returnBody:4},nosConfigTag:{bucket:1,cdnDomain:2,expire:3,objectNamePrefix:4},grayConfigTag:{config:0,ttl:1},mixStorePolicyTag:{providers:0,ttl:1,mixEnable:2,nosPolicy:3,s3Policy:4},mixStoreTokenResTag:{provider:0,accessKeyId:1,secretAccessKey:2,sessionToken:3,token:4,expireTime:5,bucket:6,objectName:7,fileExpireSec:8,tag:9,shortUrl:10,region:11},nosSafeUrlTag:{safeUrl:0,originUrl:1},mixStoreAuthTokenReqTag:{type:1,urls:2},mixStoreAuthTokenResTag:{type:1,tokens:2,token:3,ttl:4},nosAccessTokenTag:{token:0,url:1,userAgent:2,ext:3}},aa={getNosToken:{sid:6,cid:2,service:"cloudStorage",params:[{type:"String",name:"responseBody"},{type:"Property",name:"nosToken",entity:"nosToken",reflectMapper:sa.nosToken}],response:[{type:"Property",name:"nosToken",reflectMapper:mn(sa.nosToken)}]},getOriginUrl:{sid:6,cid:22,service:"cloudStorage",params:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:sa.nosSafeUrlTag}],response:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:mn(sa.nosSafeUrlTag)}]},getNosCdnHost:{sid:6,cid:26,service:"cloudStorage",response:[{type:"Property",name:"nosConfigTag",reflectMapper:mn(sa.nosConfigTag)}]},getGrayscaleConfig:{sid:6,cid:27,service:"cloudStorage",params:[{type:"Property",name:"config"}],response:[{type:"Property",name:"grayConfigTag",reflectMapper:mn(sa.grayConfigTag)}]},getMixStorePolicy:{sid:6,cid:28,service:"cloudStorage",params:[{type:"LongArray",name:"supportType"}],response:[{type:"Property",name:"mixStorePolicyTag",reflectMapper:mn(sa.mixStorePolicyTag)}]},getMixStoreToken:{sid:6,cid:29,service:"cloudStorage",params:[{type:"Property",name:"mixStoreTokenReqTag",reflectMapper:sa.mixStoreTokenReqTag}],response:[{type:"Property",name:"mixStoreTokenResTag",reflectMapper:mn(sa.mixStoreTokenResTag)}]},getFileAuthToken:{sid:6,cid:30,service:"cloudStorage",params:[{type:"Property",name:"mixStoreAuthTokenReqTag",reflectMapper:sa.mixStoreAuthTokenReqTag}],response:[{type:"Property",name:"mixStoreAuthTokenResTag",reflectMapper:mn(sa.mixStoreAuthTokenResTag)}]},getNosAccessToken:{sid:6,cid:24,service:"cloudStorage",params:[{type:"Property",name:"tag",reflectMapper:sa.nosAccessTokenTag}],response:[{type:"Property",name:"tag",reflectMapper:mn(sa.nosAccessTokenTag)}]},deleteNosAccessToken:{sid:6,cid:25,service:"cloudStorage",params:[{type:"Property",name:"tag",reflectMapper:sa.nosAccessTokenTag}]}};class MixStorage{constructor(t,o){this.GRAYKEY="AllGrayscaleConfig",this.MIXSTOREKEY="AllMixStorePolicy",this.grayConfig={mixStoreEnable:!1,timeStamp:0,ttl:0},this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.curProvider=Ws.nos,this.mixStoreErrorCount=10,this.circuitTimer=0,this.core=t,this.cloudStorage=o,this.logger=t.logger}reset(){this.grayConfig=null,this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.curProvider=Ws.nos,this.mixStoreErrorCount=10}getGrayscaleConfig(t){var o;return __awaiter(this,void 0,void 0,(function*(){if(ai.localStorage)try{ai.localStorage.getItem&&ai.localStorage.getItem(this.GRAYKEY)&&(this.grayConfig=JSON.parse(ai.localStorage.getItem(this.GRAYKEY))[t])}catch(t){ai.localStorage.getItem(this.GRAYKEY)&&this.core.logger.error("uploadFile:: JSON.parse grayscaleConfig error ",t)}if(!this.grayConfig||this.grayConfig.timeStamp+1e3*this.grayConfig.ttl<(new Date).getTime()){var a=yield this.core.sendCmd("getGrayscaleConfig",{config:{}});if(a.content&&a.content.grayConfigTag){this.logger.log("uploadFile::getAppGrayConfigRequest success ");try{this.grayConfig=JSON.parse(a.content.grayConfigTag.config),this.grayConfig.ttl=JSON.parse(a.content.grayConfigTag.ttl)}catch(t){this.logger.error("getGrayscaleConfig error",t)}if(!this.grayConfig)return;var c=ai.localStorage.getItem(this.GRAYKEY)?JSON.parse(ai.localStorage.getItem(this.GRAYKEY)):{};this.grayConfig.timeStamp=(new Date).getTime(),c[t]=this.grayConfig,ai.localStorage.setItem(this.GRAYKEY,JSON.stringify(c))}else this.logger.debug("uploadFile:: result grayConfig:",a.content)}(null===(o=this.grayConfig)||void 0===o?void 0:o.mixStoreEnable)&&(yield this._getMixStorePolicy(t))}))}_getMixStorePolicy(t){return __awaiter(this,void 0,void 0,(function*(){var o=(new Date).getTime();if(ai.localStorage)try{if(this.mixStorePolicy=JSON.parse(ai.localStorage.getItem(this.MIXSTOREKEY))[t],this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.mixStorePolicy.timeStamp&&this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl>o){var a=this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl-o;this.core.timerManager.addTimer(this._getMixStorePolicy.bind(this,t),a)}}catch(o){ai.localStorage.getItem(this.MIXSTOREKEY)&&JSON.parse(ai.localStorage.getItem(this.MIXSTOREKEY))[t]&&this.core.logger.error("uploadFile:: JSON.parse mixStorePolicy error ",o)}if(!this.mixStorePolicy||this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl<=o)try{var c=(yield this.core.sendCmd("getMixStorePolicy",{supportType:this.cloudStorage.aws.s3?[1,2]:[1]})).content.mixStorePolicyTag;this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.mixStorePolicy.ttl=Number(c.ttl),this.mixStorePolicy.providers=c.providers.split(","),this.circuitTimer&&this.core.timerManager.deleteTimer(this.circuitTimer),this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.mixStorePolicy.nosPolicy=c.nosPolicy?JSON.parse(c.nosPolicy):null,this.mixStorePolicy.s3Policy=c.s3Policy?JSON.parse(c.s3Policy):null,null===this.mixStorePolicy.s3Policy?this.mixStorePolicy.providers=["1"]:null===this.mixStorePolicy.nosPolicy?this.mixStorePolicy.providers=["2"]:this.mixStorePolicy.providers=this.mixStorePolicy.s3Policy.priority<this.mixStorePolicy.nosPolicy.priority?["2","1"]:["1","2"],this.core.timerManager.addTimer(this._getMixStorePolicy.bind(this,t),1e3*this.mixStorePolicy.ttl);var m=ai.localStorage.getItem(this.MIXSTOREKEY)?JSON.parse(ai.localStorage.getItem(this.MIXSTOREKEY)):{};this.mixStorePolicy.timeStamp=(new Date).getTime(),m[t]=this.mixStorePolicy,ai.localStorage.setItem(this.MIXSTOREKEY,JSON.stringify(m))}catch(o){if(this.logger.error("getMixStorePolicy error",o),0===this.mixStoreErrorCount)throw new Error("getMixStorePolicy all count error");this._getMixStorePolicy(t),this.mixStoreErrorCount--}this.mixStorePolicy.nosPolicy&&(this.cloudStorage.nos.nosErrorCount=this.mixStorePolicy.nosPolicy.uploadConfig.retryPolicy.retry)}))}_addCircuitTimer(){var t=this.mixStorePolicy.providers,o=t[(t.indexOf(String(this.curProvider))+1)%t.length];if(!o)throw new Error("uploadFile nextProvider error");if(o===t[0])throw new Error("uploadFile all policy fail");if(this.logger.log(`uploadFile:: upload policy will change,now policy:${this.curProvider} nextProvider:${o}`),this.curProvider=parseInt(o),this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.s3Policy){var a=this.mixStorePolicy[this.curProvider===Ws.nos?"nosPolicy":"s3Policy"].uploadConfig.retryPolicy.circuit;if(!a||0===a)throw new Error("uploadFile circuit error");this.circuitTimer=this.core.timerManager.addTimer((()=>{this.logger.log(`uploadFile:: upload policy will change,now policy:${this.curProvider} nextProvider:${parseInt(this.mixStorePolicy.providers[0])}`),this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.core.timerManager.deleteTimer(this.circuitTimer)}),1e3*a)}throw new Error("uploadFile will not retry again")}getFileAuthToken(t){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("getFileAuthToken",{mixStoreAuthTokenReqTag:t})).content.mixStoreAuthTokenResTag}))}}class AWS{constructor(t,o){this.s3=null,this.core=t,this.cloudStorage=o,this.logger=t.logger}get mixStorePolicy(){return this.cloudStorage.mixStorage.mixStorePolicy}s3Upload(t,o){return __awaiter(this,void 0,void 0,(function*(){var a;if(t.file)a=t.file;else if("string"==typeof t.fileInput){this.logger.warn("fileInput will abandon,Please use file or filepath");var c=document.getElementById(t.fileInput);if(!(c&&c.files&&c.files[0]))throw new Error("Can not get file from fileInput");a=c.files[0]}else{if(!(t.fileInput&&t.fileInput.files&&t.fileInput.files[0]))throw new Error(`Can not get file from fileInput ${t.fileInput}`);a=t.fileInput.files[0]}if(!this.mixStorePolicy.s3Policy)throw new Error("dont get s3 policy");var m={accessKeyId:o.accessKeyId,secretAccessKey:o.secretAccessKey,sessionToken:o.sessionToken,region:o.region,maxRetries:this.mixStorePolicy.s3Policy.uploadConfig.retryPolicy.retry},h=new(0,this.s3);h.config.update(m);var g=decodeURIComponent(o.bucket),_=decodeURIComponent(o.objectName),I=a,E={Bucket:g,Key:_,Body:I,Metadata:{token:o.token},ContentType:I.type||"application/octet-stream"};this.core.logger.debug("uploadFile:: s3 upload params:",E);var T=h.upload(E);return T.on("httpUploadProgress",(o=>{var a=parseFloat((o.loaded/o.total).toFixed(2));t.onUploadProgress&&t.onUploadProgress({total:o.total,loaded:o.loaded,percentage:a,percentageText:Math.round(100*a)+"%"})})),new Promise(((a,c)=>{var m=(new Date).getTime();T.send(((h,E)=>__awaiter(this,void 0,void 0,(function*(){var T,M,S;if(h&&"RequestAbortedError"===h.code)this.logger.error("uploadFile:","api::s3:upload file abort.",h),c(new UploadError({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_CANCELLED:400,detail:{reason:"S3RequestAbortedError",rawError:h,curProvider:2}}));else{if(!h){var N=this.mixStorePolicy.s3Policy.cdnSchema;N=N.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn),this.core.reporterHookCloudStorage.update({remote_addr:N,operation_type:1}),N=N.replace("{objectName}",E.Key);var C={size:I.size,name:I.name,url:o.shortUrl?o.shortUrl:N,ext:I.name.split(".")[1]||"unknown"},A=t.type||"",O={image:"imageInfo"};return a(O[A]?yield this.getS3FileInfo({url:N,infoSuffix:O[A],s3Result:C}):C)}this.logger.error("uploadFile:","api::s3:upload file failed.",h),this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account||(null===(M=null===(T=this.core)||void 0===T?void 0:T.auth)||void 0===M?void 0:M.account),trace_id:null===(S=this.core.clientSocket.socket)||void 0===S?void 0:S.sessionId,start_time:m,action:1,exception_service:4}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof h.status?h.status:"number"==typeof h.code?h.code:0,description:h.message||`${h.code}`,operation_type:1,target:JSON.stringify({bucket:g,object:_})},{asyncParams:ai.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1);var{net_connect:R}=yield ai.net.getNetworkStatus();if(!1===R)return c(new UploadError({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"No network",rawError:h,curProvider:this.cloudStorage.mixStorage.curProvider}}));try{this.cloudStorage.mixStorage._addCircuitTimer()}catch(o){return c(new UploadError({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"All upload attempts failed",rawError:o,curProvider:this.cloudStorage.mixStorage.curProvider,mixStorePolicy:this.mixStorePolicy,file:t.file||t.filePath}}))}a(this.cloudStorage._uploadFile(t))}})))),t.onUploadStart&&t.onUploadStart(T)}))}))}getS3FileInfo(t){var o;return __awaiter(this,void 0,void 0,(function*(){var a,{url:c,infoSuffix:m,s3Result:h}=t;try{a=yield this.core.adapters.request(`${c}?${m}`,{method:"GET",dataType:"text",timeout:5e3},{exception_service:3})}catch(t){return this.core.logger.error("uploadFile:: fetch file info error",t),h}if(a){var{data:g}=a,_="imageInfo"===m?g:null===(o=null==g?void 0:g.GetVideoInfo)||void 0===o?void 0:o.VideoInfo,I=Object.assign(Object.assign({},h),{w:null==_?void 0:_.Width,h:null==_?void 0:_.Height,orientation:null==_?void 0:_.Orientation,dur:null==_?void 0:_.Duration,audioCodec:null==_?void 0:_.AudioCodec,videoCodec:null==_?void 0:_.VideoCodec,container:null==_?void 0:_.Container});return na(I,(function(t,o){return void 0!==o}))}return this.core.logger.error("uploadFile:: fetch s3 file info no result",`${c}?${m}`),h}))}}var ca="V2NIMNotificationService",da={"30_7":"v2SendCustomNotification","32_16":"v2SendCustomNotificationWithSuperTeam","7_3":"onSysNotification","21_19":"onSysNotification","101_3":"onSysNotification","4_6":"v2SyncOfflineSysNotifications","4_18":"v2SyncOfflineSysNotifications","4_101":"v2SyncOfflineSysNotifications","7_14":"v2NotificationRevoke","21_18":"v2NotificationRevoke","21_117":"v2NotificationRevoke","4_19":"v2NotificationSyncRevoke","7_15":"v2NotificationSyncRevoke","4_16":"syncBroadcastMsg","7_17":"onBroadcastMsg"},la={timestamp:{id:0,retType:"number"},type:{id:1,retType:"number"},receiverId:2,senderId:3,postscript:4,content:5,idServer:6,offlineEnabled:{id:7,converter:boolToInt,retConverter:function(t,o){return"0"!==o[6]&&!!parseInt(t)},access:"notificationConfig.offlineEnabled"},pushContent:{id:8,access:"pushConfig.pushContent"},pushPayload:{id:9,access:"pushConfig.pushPayload"},deletedIdClient:10,deletedIdServer:11,antispamEnabled:{id:12,converter:boolToInt,retType:"boolean",access:"antispamConfig.antispamEnabled"},antispamCustomNotification:{id:13,access:"antispamConfig.antispamCustomNotification"},deletedMsgCreateTime:14,deletedMsgFromNick:15,opeAccount:16,forcePushAccountIds:{id:18,access:"pushConfig.forcePushAccountIds",def:t=>{if(101===t.type&&t["pushConfig.forcePush"])return"#%@all@%#"},converter:(t,o)=>{if(o["pushConfig.forcePush"])return t?JSON.stringify(t):"#%@all@%#"}},forcePushContent:{id:19,access:"pushConfig.forcePushContent"},forcePush:{id:20,converter:boolToInt,retType:"boolean",access:"pushConfig.forcePush"},routeEnvironment:{id:21,access:"routeConfig.routeEnvironment"},callbackExt:22,conversationOnlineSyncNotify:24,conversationOnlineSyncData:25,routeEnabled:{id:105,converter:boolToInt,retType:"boolean",access:"routeConfig.routeEnabled"},pushEnabled:{id:107,converter:boolToInt,retType:"boolean",access:"pushConfig.pushEnabled"},unreadEnabled:{id:109,converter:boolToInt,retType:"boolean",access:"notificationConfig.unreadEnabled"},pushNickEnabled:{id:110,converter:boolToInt,retType:"boolean",access:"pushConfig.pushNickEnabled"}},pa={id:1,senderId:2,timestamp:{id:4,retType:"number"},content:5},ua={v2SendCustomNotification:{sid:30,cid:7,service:ca,params:[{type:"Property",name:"tag",reflectMapper:la}]},v2SendCustomNotificationWithSuperTeam:{sid:32,cid:16,service:ca,params:[{type:"Property",name:"tag",reflectMapper:la}]},onSysNotification:{sid:7,cid:3,service:ca,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(la)}]},syncBroadcastMsg:{sid:4,cid:16,service:ca,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(pa)}]},onBroadcastMsg:{sid:7,cid:17,service:ca,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(pa)}]},v2SyncOfflineSysNotifications:{sid:4,cid:9,service:ca,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(la)}]},v2NotificationRevoke:{sid:7,cid:14,service:ca,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(la)}]},v2NotificationSyncRevoke:{sid:7,cid:15,service:ca,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(la)},{type:"Long",name:"timetag"},{type:"Byte",name:"type"}]}},ma={content:{type:"string",allowEmpty:!1},params:{type:"object",required:!1,rules:{notificationConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushNickEnabled:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},forcePush:{type:"boolean",required:!1},forcePushContent:{type:"string",required:!1},forcePushAccounts:{type:"array",required:!1,itemType:"string"}}},antispamConfig:{type:"object",required:!1,rules:{antispamEnabled:{type:"boolean",required:!1},antispamCustomNotification:{type:"string",required:!1}}},routeConfig:{type:"object",required:!1,rules:{routeEnabled:{type:"boolean",required:!1},routeEnvironment:{type:"string",required:!1}}}}}};var ha={joinMode:{type:"enum",values:getEnumValues(vt),required:!1},agreeMode:{type:"enum",values:getEnumValues(It),required:!1},inviteMode:{type:"enum",values:getEnumValues(Et),required:!1},updateInfoMode:{type:"enum",values:getEnumValues(ft),required:!1},updateExtensionMode:{type:"enum",values:getEnumValues(Mt),required:!1},chatBannedMode:{type:"enum",values:[Tt.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN,Tt.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL],required:!1}},ga={type:"object",required:!0,rules:Object.assign({name:{type:"string",allowEmpty:!1},teamType:{type:"enum",values:[_t.V2NIM_TEAM_TYPE_ADVANCED,_t.V2NIM_TEAM_TYPE_SUPER]},memberLimit:{type:"number",min:1,required:!1}},ha)},_a={type:"array",min:1,itemType:"string"},va={type:"boolean"},Ia={type:"string"},Ea={type:"string",allowEmpty:!1},fa={type:"object",rules:{antispamBusinessId:{type:"string",required:!1}},required:!1},Ta={teamId:{type:"string",regExp:/^[1-9]\d*$/,allowEmpty:!1}},Ma={teamIds:{type:"array",itemType:"string",regExp:/^[1-9]\d*$/,min:1,allowEmpty:!1}},ya={teamType:{type:"enum",values:[_t.V2NIM_TEAM_TYPE_ADVANCED,_t.V2NIM_TEAM_TYPE_SUPER]}},Sa={teamTypes:{type:"array",itemType:"enum",values:[_t.V2NIM_TEAM_TYPE_ADVANCED,_t.V2NIM_TEAM_TYPE_SUPER],required:!1}},Na={updateTeamInfoParams:{type:"object",required:!0,rules:Object.assign({name:{type:"string",allowEmpty:!1,required:!1},memberLimit:{type:"number",min:1,required:!1}},ha)}},Ca={type:"enum",values:[St.V2NIM_TEAM_MEMBER_ROLE_NORMAL,St.V2NIM_TEAM_MEMBER_ROLE_MANAGER]},Aa={memberInfoParams:{type:"object",rules:{teamNick:{type:"string",required:!1},serverExtension:{type:"string",required:!1}}}};getEnumValues(yt);var Oa,Ra={chatBannedMode:{type:"enum",values:[Tt.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN,Tt.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL]}},ba={queryOption:{type:"object",rules:{roleQueryType:{type:"enum",values:getEnumValues(gt)},onlyChatBanned:{type:"boolean",required:!1},direction:{type:"enum",values:getEnumValues(st),required:!1},limit:{type:"number",min:1,required:!1},nextToken:{type:"string",required:!1}}}},Va={teamId:Ta.teamId,teamType:{type:"enum",values:[_t.V2NIM_TEAM_TYPE_ADVANCED,_t.V2NIM_TEAM_TYPE_SUPER]},operatorAccountId:{type:"string",allowEmpty:!1}},Pa={actionType:{type:"enum",values:[Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION]}},ka={actionType:{type:"enum",values:[Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION]}},La={types:{type:"array",itemType:"enum",values:getEnumValues(Nt),required:!1},status:{type:"array",itemType:"enum",values:getEnumValues(Ct),required:!1},offset:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}};class V2NIMTeamModelImpl{constructor(){this.teamMap=new Map,this.superTeamMap=new Map}set(t){t.forEach((t=>{this.chooseMap(t.teamType).set(t.teamId,t)}))}reset(){this.teamMap.clear(),this.superTeamMap.clear()}count(t,o=!0){var a=this.chooseMap(t),c=0;return a.forEach((t=>{o&&t.isValidTeam&&c++,o||c++})),c}chooseMap(t){return t===_t.V2NIM_TEAM_TYPE_SUPER?this.superTeamMap:t===_t.V2NIM_TEAM_TYPE_ADVANCED?this.teamMap:new Map}getById(t,o,a=!0){var c=this.chooseMap(o).get(t);if(c){if(a&&c.isValidTeam)return c;if(!a)return c}}getAll(t,o=!0){var a=this.chooseMap(t);return Array.from(a.values()).filter((t=>!(!o||!t.isValidTeam)||(!o||void 0))).sort(((t,o)=>o.updateTime-t.updateTime))}upsert(t){var o=t.teamId,a=t.teamType,c=this.chooseMap(a),m=c.get(o)||{},h=Object.assign({},m,t);return c.set(o,h),h}deleteById(t,o){var a=this.getById(t,o);if(a)return a.isValidTeam=!1,a}searchTeamByKeyword(t){var o=[];return this.teamMap.forEach((a=>{a.name.includes(t)&&o.push(a)})),this.superTeamMap.forEach((a=>{a.name.includes(t)&&o.push(a)})),o}}class V2NIMTeamMemberModelImpl{constructor(){this.teamMembers=[],this.superTeamMembers=[],this.maxSize=2e3}reset(){this.teamMembers=[],this.superTeamMembers=[]}setData(t){t.forEach((t=>{this.chooseList(t.teamType).push(t)}))}chooseList(t){return t===_t.V2NIM_TEAM_TYPE_SUPER?this.superTeamMembers:t===_t.V2NIM_TEAM_TYPE_ADVANCED?this.teamMembers:[]}getById(t,o,a){return this.chooseList(o).find((o=>o.teamId===t&&o.accountId===a))}upsert(t){var o=t.teamType,a=t.teamId,c=this.chooseList(o),m=c.findIndex((o=>o.teamId===a&&o.accountId===t.accountId));-1===m?c.push(t):c[m]=Object.assign(Object.assign({},c[m]),t),c.length>this.maxSize&&c.shift()}deleteByAccount(t,o,a){var c=this.chooseList(o),m=c.findIndex((o=>o.teamId===t&&o.accountId===a));if(-1!==m){var h=c[m];return h.inTeam=!1,c.splice(m,1),h}}deleteByTeamId(t,o){var a=this.chooseList(o).filter((o=>o.teamId!==t));o===_t.V2NIM_TEAM_TYPE_SUPER?this.superTeamMembers=a:this.teamMembers=a}}class V2NIMTeamNotificationImpl{constructor(t,o){this.core=t,this.service=o}processNotification(t){var{attachment:o,senderId:a,receiverId:c}=t,{id:m,data:h}=o,g=m>400?_t.V2NIM_TEAM_TYPE_SUPER:_t.V2NIM_TEAM_TYPE_ADVANCED,{id:_,ids:I,tinfo:E,mute:T}=formatTeamNotificationAttachData(h,g),M=this.service.model.getById(c,g);switch(this.core.logger.log("v2Team::processNotification, notificationType:",m,h),m){case Oa.SUPER_TEAM_INVITATION:case Oa.TEAM_INVITATION:I.includes(this.core.account)&&this.onTeamJoined(E),this.onTeamMembersJoined(E,I.filter((t=>t!==this.core.account)));break;case Oa.SUPER_TEAM_INVITE_ACCEPT:case Oa.TEAM_INVITE_ACCEPT:a===this.core.account?this.onTeamJoined(E):this.onTeamMemberJoined(E,a);break;case Oa.SUPER_TEAM_APPLY_ACCEPT:case Oa.TEAM_APPLY_ACCEPT:_===this.core.account?this.onTeamJoined(E):this.onTeamMemberJoined(E,_);break;case Oa.SUPER_TEAM_ADD_MANAGER:case Oa.TEAM_ADD_MANAGER:this.updateTeamMemberRole(c,g,I,{memberRole:St.V2NIM_TEAM_MEMBER_ROLE_MANAGER});break;case Oa.SUPER_TEAM_REMOVE_MANAGER:case Oa.TEAM_REMOVE_MANAGER:this.updateTeamMemberRole(c,g,I,{memberRole:St.V2NIM_TEAM_MEMBER_ROLE_NORMAL});break;case Oa.SUPER_TEAM_KICK:case Oa.TEAM_KICK:this.onTeamInfoUpdated(E),I.forEach((t=>{t===this.core.account?this.onTeamLeft(c,g,!0):this.onTeamMemberKicked(a,E.teamId,E.teamType,t)}));break;case Oa.SUPER_TEAM_LEAVE:case Oa.TEAM_LEAVE:E?this.onTeamInfoUpdated(E):M&&a===this.core.account&&(M.isValidTeam=!1,this.onTeamInfoUpdated(M)),a===this.core.account?this.onTeamLeft(c,g,!1):this.onTeamMemberLeft(c,g,a);break;case Oa.SUPER_TEAM_DISMISS:case Oa.TEAM_DISMISS:this.onTeamDismissed(c,g);break;case Oa.SUPER_TEAM_UPDATE:case Oa.TEAM_UPDATED:this.onTeamInfoUpdated(E);break;case Oa.SUPER_TEAM_TRANSFER_OWNER:case Oa.TEAM_TRANSFER_OWNER:this.onTeamInfoUpdated(E),this.updateTeamMemberRole(c,g,[a,E.ownerAccountId],[{memberRole:St.V2NIM_TEAM_MEMBER_ROLE_NORMAL},{memberRole:St.V2NIM_TEAM_MEMBER_ROLE_OWNER}]);break;case Oa.SUPER_TEAM_MEMBER_MUTE:case Oa.TEAM_MEMBER_MUTE:this.service.model.upsert(E),this.updateTeamMemberRole(c,g,_?[_]:I,{chatBanned:T!==mt.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF})}}onTeamJoined(t){if(this.service.model.upsert(t),this.service.emit("onTeamJoined",t),!this.service.memberModel.getById(t.teamId,t.teamType,this.core.account)){var o=t.updateTime||t.createTime,a=generateMemberByTeamId(t.teamId,t.teamType,this.core.account,{joinTime:o,updateTime:o});this.service.memberModel.upsert(a)}}onTeamLeft(t,o,a){var c=this.service.model.deleteById(t,o)||generateTeamByTeamId(t,o,{isValidTeam:!1});this.service.memberModel.deleteByAccount(t,o,this.core.account),this.service.emit("onTeamLeft",c,a)}onTeamDismissed(t,o){var a=this.service.model.deleteById(t,o);a||(a=generateTeamByTeamId(t,o,{isValidTeam:!1})),this.service.memberModel.deleteByTeamId(t,o),this.service.emit("onTeamDismissed",a)}onTeamInfoUpdated(t){var o=this.service.model.upsert(t);this.service.emit("onTeamInfoUpdated",o)}onTeamMemberJoined(t,o){this.service.model.upsert(t),this.service.emit("onTeamInfoUpdated",t);var a=t.updateTime||t.createTime,c=generateMemberByTeamId(t.teamId,t.teamType,o,{joinTime:a,updateTime:a});this.service.memberModel.upsert(c),this.service.emit("onTeamMemberJoined",[c])}onTeamMembersJoined(t,o){var a=t.updateTime||t.createTime,c=o.map((o=>generateMemberByTeamId(t.teamId,t.teamType,o,{joinTime:a,updateTime:a})));0!==c.length&&(this.service.model.upsert(t),this.service.emit("onTeamInfoUpdated",t),c.forEach((t=>this.service.memberModel.upsert(t))),this.service.emit("onTeamMemberJoined",c))}onTeamMemberLeft(t,o,a){var c=this.service.memberModel.deleteByAccount(t,o,a);c||(c=generateMemberByTeamId(t,o,a,{inTeam:!1})),this.service.emit("onTeamMemberLeft",[c])}onTeamMemberKicked(t,o,a,c){var m=this.service.memberModel.deleteByAccount(o,a,c);m||(m=generateMemberByTeamId(o,a,c,{inTeam:!1})),this.service.emit("onTeamMemberKicked",t,[m])}onTeamMemberInfoUpdated(t){t.forEach((t=>{var o;if(t.accountId===this.core.account&&(null===(o=this.core.V2NIMSettingService)||void 0===o?void 0:o.name)){var a=t.teamType===_t.V2NIM_TEAM_TYPE_ADVANCED?this.core.V2NIMConversationIdUtil.teamConversationId(t.teamId):this.core.V2NIMConversationIdUtil.superTeamConversationId(t.teamId),c=this.core.V2NIMSettingService.getConversationMuteStatus(a);this.core.eventBus.emit("V2NIMConversationService/setMute",a,c)}})),this.service.emit("onTeamMemberInfoUpdated",t)}updateTeamMemberRole(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){var m=a.filter(((a,m)=>{var h=this.service.memberModel.getById(t,o,a);return h&&this.service.memberModel.upsert(Object.assign(Object.assign({},h),Array.isArray(c)?c[m]:c)),!h}));if(m.length>0)try{(yield this.service.getTeamMemberListByIds(t,o,m)).forEach((t=>this.service.memberModel.upsert(t)))}catch(t){this.core.logger.warn("v2Team::processNotification, getTeamMemberListByIds failed",t)}var h=a.map((a=>this.service.memberModel.getById(t,o,a))).filter((t=>!!t));h.length>0&&this.onTeamMemberInfoUpdated(h)}))}processSysNotification(t){var{receiverId:o,postscript:a,senderId:c,timestamp:m,idServer:h}=t,g={actionType:{0:Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION,1:Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION,2:Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION,3:Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION,15:Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION,16:Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION,17:Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION,18:Nt.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION}[t.type],teamId:o,teamType:t.type>=15?_t.V2NIM_TEAM_TYPE_SUPER:_t.V2NIM_TEAM_TYPE_ADVANCED,operatorAccountId:c,postscript:a,timestamp:m,actionStatus:Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_INIT};this.core.logger.log("v2Team::processSysNotification, type:",t.type,g),this.service.notificationModel.create(g),this.service.emit("onReceiveTeamJoinActionInfo",g)}updateTeamActionStatus(t,o){this.service.notificationModel.update({teamId:t.teamId,teamType:t.teamType,operatorAccountId:t.operatorAccountId,actionType:t.actionType,actionStatus:o})}checkIfExpired(t){return!!t&&(509===t||!(t>=500&&t<=599)&&!(t>=19e4))}}!function(t){t[t.TEAM_INVITATION=0]="TEAM_INVITATION",t[t.TEAM_KICK=1]="TEAM_KICK",t[t.TEAM_LEAVE=2]="TEAM_LEAVE",t[t.TEAM_UPDATED=3]="TEAM_UPDATED",t[t.TEAM_DISMISS=4]="TEAM_DISMISS",t[t.TEAM_APPLY_ACCEPT=5]="TEAM_APPLY_ACCEPT",t[t.TEAM_TRANSFER_OWNER=6]="TEAM_TRANSFER_OWNER",t[t.TEAM_ADD_MANAGER=7]="TEAM_ADD_MANAGER",t[t.TEAM_REMOVE_MANAGER=8]="TEAM_REMOVE_MANAGER",t[t.TEAM_INVITE_ACCEPT=9]="TEAM_INVITE_ACCEPT",t[t.TEAM_MEMBER_MUTE=10]="TEAM_MEMBER_MUTE",t[t.SUPER_TEAM_INVITATION=401]="SUPER_TEAM_INVITATION",t[t.SUPER_TEAM_KICK=402]="SUPER_TEAM_KICK",t[t.SUPER_TEAM_LEAVE=403]="SUPER_TEAM_LEAVE",t[t.SUPER_TEAM_UPDATE=404]="SUPER_TEAM_UPDATE",t[t.SUPER_TEAM_DISMISS=405]="SUPER_TEAM_DISMISS",t[t.SUPER_TEAM_TRANSFER_OWNER=406]="SUPER_TEAM_TRANSFER_OWNER",t[t.SUPER_TEAM_ADD_MANAGER=407]="SUPER_TEAM_ADD_MANAGER",t[t.SUPER_TEAM_REMOVE_MANAGER=408]="SUPER_TEAM_REMOVE_MANAGER",t[t.SUPER_TEAM_MEMBER_MUTE=409]="SUPER_TEAM_MEMBER_MUTE",t[t.SUPER_TEAM_APPLY_ACCEPT=410]="SUPER_TEAM_APPLY_ACCEPT",t[t.SUPER_TEAM_INVITE_ACCEPT=411]="SUPER_TEAM_INVITE_ACCEPT"}(Oa||(Oa={}));class V2NIMTeamNotificationModelImpl{constructor(){this.list=[],this.maxCount=1e3}reset(){this.list=[]}create(t){this.list.push(t),this.list.length>this.maxCount&&this.list.shift()}update(t){this.list.forEach((o=>{o.teamId===t.teamId&&o.teamType===t.teamType&&o.actionType===t.actionType&&o.operatorAccountId===t.operatorAccountId&&o.actionStatus===Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_INIT&&Object.assign(o,t)}))}getByOption(t){var{types:o,status:a,offset:c=0,limit:m=50}=t,h=[];this.list.forEach((t=>{o&&o.length>0&&!o.includes(t.actionType)||a&&a.length>0&&!a.includes(t.actionStatus)||h.push(t)})),h=h.sort(((t,o)=>o.timestamp-t.timestamp));var g=0;c>0&&(g=findIndexWithinTargetValue(h,"timestamp",c),h[g]&&h[g].timestamp===c&&(g+=1));var _=h.slice(g).length;return(h=h.slice(g,g+m)).length>0?{offset:_>m?h[h.length-1].timestamp:0,finished:!(_>m),infos:h}:{offset:0,finished:!0,infos:h}}}var Da="V2NIMUserService",wa={"34_3":"v2UpdateBlockList","34_7":"v2GetUserList","34_10":"v2UpdateSelfUserProfile","3_109":"v2SyncSelfUserInfo","3_110":"onUpdateUserProfile","3_103":"onUpdateBlockList","3_8":"syncBlockAndMuteList","34_5":"v2SetP2PMessageMuteMode","3_105":"v2OnUpdateMuteList"},Ua={accountId:1,name:3,avatar:4,sign:5,gender:{id:6,retType:"number"},email:7,birthday:8,mobile:9,serverExtension:10,createTime:{id:12,retType:"number"},updateTime:{id:13,retType:"number"}},xa={v2UpdateBlockList:{sid:34,cid:3,service:Da,params:[{type:"String",name:"accountId"},{type:"Bool",name:"addToBlockList"}]},v2GetUserList:{sid:34,cid:7,service:Da,params:[{type:"StrArray",name:"accountIds"}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Ua)}]},v2UpdateSelfUserProfile:{sid:34,cid:10,service:Da,params:[{type:"Property",name:"tag",reflectMapper:Ua}],response:[{type:"Long",name:"updateTime"}]},onUpdateUserProfile:{sid:3,cid:110,service:Da,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ua)}]},onUpdateBlockList:{sid:3,cid:103,service:Da,response:[{type:"String",name:"accountId"},{type:"Bool",name:"addToBlockList"}]},syncBlockAndMuteList:{sid:3,cid:8,service:Da,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem({accountId:0,isMute:{id:1,retType:"boolean"},isBlock:{id:2,retType:"boolean"}})},{type:"Long",name:"timetag"}]},v2SyncSelfUserInfo:{sid:3,cid:109,service:Da,response:[{type:"Property",name:"user",reflectMapper:invertSerializeItem(Ua)}]},v2SetP2PMessageMuteMode:{sid:34,cid:5,service:Da,params:[{type:"String",name:"accountId"},{type:"Bool",name:"muteMode"}]},v2OnUpdateMuteList:{sid:3,cid:105,service:Da,response:[{type:"String",name:"accountId"},{type:"Bool",name:"mute"}]}};class V2NIMUserModelImpl{constructor(){this.muteList=new Set,this.userMap=new Map,this.blockList=[]}reset(){this.muteList.clear(),this.userMap.clear(),this.blockList=[]}setAccountMuteMode(t,o){o===ht.V2NIM_P2P_MESSAGE_MUTE_MODE_ON?this.muteList.add(t):this.muteList.delete(t)}setUser(t){this.userMap.set(t.accountId,t)}getUser(t){return this.userMap.get(t)}getUserListBySearchOption(t){return Array.from(this.userMap.values()).filter((o=>!(void 0!==t.searchName&&!t.searchName||!o.name.includes(t.keyword))||(!(!t.searchAccountId||!o.accountId.includes(t.keyword))||!!(o.mobile&&t.searchMobile&&o.mobile.includes(t.keyword)))))}addToBlockList(t){t.forEach((t=>{this.blockList.includes(t)||this.blockList.push(t)}))}removeFromBlockList(t){t.forEach((t=>{var o=this.blockList.indexOf(t);-1!==o&&this.blockList.splice(o,1)}))}}var Fa={type:"string",required:!0,allowEmpty:!1},Ga={type:"string",required:!1,allowEmpty:!0},Ba={name:{type:"string",required:!1,allowEmpty:!0},avatar:Ga,sign:Ga,email:Ga,birthday:Ga,mobile:Ga,gender:{type:"number",required:!1},serverExtension:Ga};var ja="V2NIMFriendService",Ya={"35_1":"v2AddFriend","35_2":"v2DeleteFriend","35_3":"v2SetFriendInfo","35_4":"v2IncFriendInfo","12_101":"v2OnAddFriend","12_102":"v2OnDeleteFriend","12_103":"v2OnUpdateFriendInfo","12_5":"v2SyncFriendList","12_6":"v2SyncFriendUserList"},Ha={accountId:4,source:{id:7,retType:"number"},alias:8,serverExtension:10,createTime:{id:11,retType:"number"},updateTime:{id:12,retType:"number"},customerExtension:13},$a={v2AddFriend:{sid:35,cid:1,service:ja,params:[{type:"String",name:"accountId"},{type:"Byte",name:"verifyType"},{type:"String",name:"postscript"}],response:[]},v2DeleteFriend:{sid:35,cid:2,service:ja,params:[{type:"String",name:"accountId"},{type:"Property",name:"params",reflectMapper:{deleteAlias:{id:1,converter:boolToInt}}}]},v2SetFriendInfo:{sid:35,cid:3,service:ja,params:[{type:"Property",name:"tag",reflectMapper:Ha}]},v2OnAddFriend:{sid:12,cid:101,service:ja,response:[{type:"String",name:"accountId"},{type:"Byte",name:"verifyType"},{type:"String",name:"postscript"},{type:"Property",name:"ext",reflectMapper:invertSerializeItem({serverExt:1})}]},v2OnDeleteFriend:{sid:12,cid:102,service:ja,response:[{type:"String",name:"accountId"}]},v2OnUpdateFriendInfo:{sid:12,cid:103,service:ja,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ha)}]},v2SyncFriendList:{sid:12,cid:5,service:ja,response:[{type:"PropertyArray",name:"friends",reflectMapper:invertSerializeItem(Ha)},{type:"Long",name:"timetag"}]},v2SyncFriendUserList:{sid:12,cid:6,service:ja,response:[{type:"PropertyArray",name:"users",reflectMapper:invertSerializeItem(Ua)}]},v2IncFriendInfo:{sid:35,cid:4,service:ja,params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"friends",reflectMapper:invertSerializeItem(Ha)},{type:"Long",name:"timetag"}]}},qa={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!0,rules:{addMode:{type:"enum",required:!0,values:getEnumValues(Ye)},postscript:{type:"string",required:!1,allowEmpty:!0}}}},za={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!1,rules:{deleteAlias:{type:"boolean",required:!1}}}},Ka={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!1,rules:{alias:{type:"string",required:!1,allowEmpty:!0},serverExtension:{type:"string",required:!1,allowEmpty:!0}}}},Wa={applicantAccountId:{type:"string",required:!0,allowEmpty:!1},recipientAccountId:{type:"string",required:!0,allowEmpty:!1},operatorAccountId:{type:"string",required:!0,allowEmpty:!1},postscript:{type:"string",required:!1,allowEmpty:!0},status:{type:"enum",required:!0,values:getEnumValues($e)},timestamp:{type:"number",required:!1}},Ja={offset:{type:"number",required:!1},limit:{type:"number",required:!1},status:{type:"array",itemType:"enum",required:!1,values:getEnumValues($e)}};class V2NIMFriendNotificationImpl{constructor(t,o){this.core=t,this.service=o}processSysNotification(t){if(6===t.type){var o=t.senderId;this.core.V2NIMFriendService.handleDeleteFriend(o,qe.V2NIM_FRIEND_DELETION_TYPE_BY_PEER)}else if(5===t.type)try{var a=JSON.parse(t.content);if((null==a?void 0:a.vt)===ze.V2NIM_FRIEND_VERIFY_TYPE_ADD){this.core.V2NIMFriendService.handleAddFriend(t.senderId,t.timestamp);var c={applicantAccountId:t.senderId,recipientAccountId:t.receiverId,operatorAccountId:t.senderId,postscript:t.postscript,timestamp:t.timestamp,status:$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD,read:!0};this.service.model.appendFriendAddApplication(c),this.service.model.updateFriendAddApplicationStatus(c.applicantAccountId,$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD,c.applicantAccountId)}else if((null==a?void 0:a.vt)===ze.V2NIM_FRIEND_VERIFY_TYPE_APPLY){var m={applicantAccountId:t.senderId,recipientAccountId:t.receiverId,operatorAccountId:t.senderId,postscript:t.postscript,timestamp:t.timestamp,status:$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT,read:!1};this.service.handleApplyFriend(m),this.core.V2NIMFriendService.model.appendFriendAddApplication(m)}else if((null==a?void 0:a.vt)===ze.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT){this.core.V2NIMFriendService.handleAddFriend(t.senderId,t.timestamp);var h={applicantAccountId:t.receiverId,recipientAccountId:t.senderId,operatorAccountId:t.senderId,timestamp:t.timestamp,postscript:t.postscript,status:$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED,read:!0};this.core.V2NIMFriendService.model.appendFriendAddApplication(h)}else if((null==a?void 0:a.vt)===ze.V2NIM_FRIEND_VERIFY_TYPE_REJECT){var g={applicantAccountId:t.receiverId,recipientAccountId:t.senderId,operatorAccountId:t.senderId,timestamp:t.timestamp,postscript:t.postscript,status:$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED,read:!0};this.core.V2NIMFriendService.model.appendFriendAddApplication(g),this.service.emit("onFriendAddRejected",g)}}catch(t){this.core.logger.warn("V2NIMFriendNotificationImpl::processSysNotification, parse content error:",t)}}}class V2NIMFriendModelImpl{constructor(){this.validFriendIds=new Set,this.friendMap=new Map,this.applicationInfoList=[],this.friendTimetag=0}getAddApplicationList(t){var o=void 0===t.offset||0===t.offset?Number.MAX_SAFE_INTEGER:t.offset,a=this.applicationInfoList.filter((a=>{if(a.timestamp>=o)return!1;var c=t.status||[];return 0===c.length||!!c.includes(a.status)})),c=t.limit||50,m=Math.min(c,a.length),h=a.reverse().slice(0,m),g=o;return h.length>0&&(g=h[h.length-1].timestamp),{infos:h,finished:m>=a.length,offset:m>=a.length?0:g}}reset(){this.friendMap.clear(),this.validFriendIds.clear(),this.applicationInfoList=[]}setAddApplicationRead(){for(var t of this.applicationInfoList)t.read=!0}getAddApplicationUnreadCount(){var t=new Set;for(var o of this.applicationInfoList)o.read||o.status!==$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT||t.add(o.applicantAccountId);return t.size}appendFriendAddApplication(t){this.applicationInfoList.push(t)}updateFriendAddApplicationStatus(t,o,a){if(o!==$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT)for(var c of this.applicationInfoList)c.applicantAccountId===t&&c.status===$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT&&(c.status=o,c.operatorAccountId=a,c.read=!0)}upsertFriend(t,o){var a=this.friendMap.get(t)||{},c=Object.assign({accountId:t},a,o);return this.friendMap.set(t,c),this.validFriendIds.add(t),c}addFriend(t){this.validFriendIds.add(t)}deleteFriend(t){this.validFriendIds.delete(t)}getFriend(t){return this.validFriendIds.has(t)?this.friendMap.get(t):void 0}getFriendList(){return Array.from(this.validFriendIds.values()).map((t=>this.getFriend(t))).filter((t=>!!t))}getFriendListBySearchOption(t){return Array.from(this.validFriendIds.values()).map((t=>this.getFriend(t))).filter((o=>{var a=void 0===t.searchAlias||t.searchAlias;return void 0!==o&&(!!(a&&o.alias&&o.alias.includes(t.keyword))||!(!t.searchAccountId||!o.accountId.includes(t.keyword)))}))}getFriendByIds(t){return t.map((t=>this.getFriend(t))).filter((t=>!!t))}setFriendTimetag(t){this.friendTimetag=t}getFriendTimetag(){return this.friendTimetag}}var Xa=console,Qa={clear(){try{uni.clearStorageSync()}catch(t){Xa.error("uni-app::ws: clearStorage ",t)}},getItem:t=>uni.getStorageSync(t),setItem:(t,o)=>uni.setStorageSync(t,o),removeItem:t=>uni.removeStorageSync(t)};class WebSocket$4{constructor(t,o=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(t){Xa.log("Adapter uniapp: sockets on close ",t)},this.onerror=function(t){Xa.error("Adapter uniapp: sockets error ",t)},this.onmessage=function(t){},this.onopen=function(){},!t)throw new Error("Failed to construct 'socket': url required");this.url=t.replace(/:443(\/|$)/,"$1"),this.protocol=o,this.readyState=this.CONNECTING;var a=this.protocol?{protocols:this.protocol}:{};this.socketTask=uni.connectSocket(Object.assign(Object.assign({url:this.url},a),{multiple:!0,fail:t=>{this.errorHandler(t)}})),this.socketTask.onOpen((t=>{Xa.log("Adapter uniapp:: onOpen. event: ",t),this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:t})})),this.socketTask.onError((t=>{Xa.log("Adapter uniapp:: onError. event: ",t),this.errorHandler(t)})),this.socketTask.onClose((t=>{this.readyState=this.CLOSED,"function"==typeof this.onclose&&(this.onclose&&this.onclose(t),Xa.log("Adapter uniapp:: onClose. event: ",t)),this.socketTask=null})),this.socketTask.onMessage((t=>{var o;o="string"==typeof t.data||t.data instanceof ArrayBuffer?t.data:t.data.isBuffer&&"string"==typeof t.data.data?base64ToArrayBuffer(t.data.data):t.data.data,this.onmessage&&this.onmessage({data:o})}))}close(){Xa.log("Adapter uniapp:: close uni socket actively"),this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(t){if(this.readyState!==this.OPEN)throw new Error(`Adapter uniapp:: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof t||t instanceof ArrayBuffer))throw new TypeError("Adapter uniapp:: socket sendMsg only String/ArrayBuffer supported");this.socketTask.send({data:t})}errorHandler(t){Xa.error("Adapter uniapp:: errorHandler. event: ",t),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:t&&t.errMsg}),t.errMsg&&"[object Array]"===Object.prototype.toString.call(t.errMsg)&&(t.errMsg.indexOf("æ–­è£‚ç®¡é“")>0||t.errMsg.indexOf("broken pipe")>0)&&this.onclose&&this.onclose(t)}}function request$4(t,o){return o&&(o.data=o.data||(null==o?void 0:o.params)||{}),new Promise(((a,c)=>{uni.request(Object.assign(Object.assign({method:"GET",url:t},o),{success:function(t){t={data:t.data,status:t.statusCode,errMsg:t.errMsg,header:t.header},a(t)},fail:function(t){t.message=t.errMsg,c(t)}}))}))}function uploadFile$5(t){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((o,a)=>{var c=uni.uploadFile(Object.assign(Object.assign({url:`${t.commonUploadHost}/${t.nosToken.bucket}`},t.md5?{header:{"Content-MD5":t.md5}}:{}),{formData:{Object:decodeURIComponent(t.nosToken.objectName),"x-nos-token":t.nosToken.token,"x-nos-entity-type":"json"},name:"file",fileType:t.type,filePath:t.filePath,success(c){if(200==c.statusCode)try{var m;try{m=JSON.parse(c.data)}catch(t){m={}}m.name=t.filePath,m.ext=m.name.lastIndexOf(".")>-1?m.name.slice(m.name.lastIndexOf(".")+1).toLowerCase():"",o(m)}catch(t){a(new Error(`Upload Error parse result error: ${c.data}`))}else a(new Error(`Upload error ${c.statusCode}: ${c.errMsg}`))},fail(t){"uploadFile:fail abort"===t.errMsg&&(t.code=wt.V2NIM_ERROR_CODE_CANCELLED),t.message=t.errMsg,a(t)}}));try{t.onUploadStart&&t.onUploadStart(c)}catch(t){Xa.error("Adapter uploadFile: options.onUploadStart error",t&&t.message),c.abort(),a(t)}t.onUploadProgress&&c.onProgressUpdate((function(o){t.onUploadProgress&&t.onUploadProgress({total:o.totalBytesExpectedToSend,loaded:o.totalBytesSent,percentage:o.progress,percentageText:o.progress+"%"})}))}))}))}function getSystemInfo$5(){var t=uni.getSystemInfoSync()||{},o=function(){var t=uni.getSystemInfoSync()||{};return"mp-weixin"===t.uniPlatform?[ri.WeiXin,"WeiXin"]:"app"===t.uniPlatform?[ri.H5,"H5"]:"undefined"!=typeof tt&&tt.getSystemInfoSync?[ri.Tiktok,"Tiktok"]:"undefined"!=typeof swan&&swan.getSystemInfoSync?[ri.Baidu,"Baidu"]:"undefined"!=typeof my&&my.getSystemInfoSync?[ri.Ali,"Ali"]:[getBrowserHostEnvEnum(),getBrowserHostEnv()]}();return{os:t.osName||"UNIAPP_UNKNOW",osVer:t.osVersion,browser:t.browserName||"",browserVer:t.browserVersion||"",libEnv:"UNIAPP",hostEnv:o[1],hostEnvEnum:o[0],hostEnvVer:function(){var t=uni.getSystemInfoSync()||{};if("mp-weixin"===t.uniPlatform&&"undefined"!=typeof wx&&wx.getSystemInfoSync){var o=wx.getSystemInfoSync();return`${t.uniRuntimeVersion}/${o.version}`}if("undefined"!=typeof tt&&tt.getSystemInfoSync){var a=tt.getSystemInfoSync();return`${t.uniRuntimeVersion}/${a.version}`}if("undefined"!=typeof swan&&swan.getSystemInfoSync){var c=swan.getSystemInfoSync();return`${t.uniRuntimeVersion}/${c.version}`}if("undefined"!=typeof my&&my.getSystemInfoSync){var m=my.getSystemInfoSync();return`${t.uniRuntimeVersion}/${m.version}`}return`${t.uniRuntimeVersion}`}(),userAgent:function(){if("mp-weixin"===t.uniPlatform&&"undefined"!=typeof wx&&wx.getSystemInfoSync){var o=wx.getSystemInfoSync();return`WeChat MiniApp: model/${o.model} system/${o.system}`}if("undefined"!=typeof tt&&tt.getSystemInfoSync){var a=tt.getSystemInfoSync();return`Tiktok MiniApp: model/${a.model} system/${a.system}`}if("undefined"!=typeof swan&&swan.getSystemInfoSync){var c=swan.getSystemInfoSync();return`Baidu MiniApp: model/${c.model} system/${c.system}`}if("undefined"!=typeof my&&my.getSystemInfoSync){var m=my.getSystemInfoSync();return`Ali MiniApp: model/${m.model} system/${m.system}`}if(navigator&&navigator.userAgent)return navigator.userAgent;var h=uni.getSystemInfoSync();return h.ua||`UniApp: uniPlatform/${h.uniPlatform} uniRuntimeVersion/${h.uniRuntimeVersion} model/${h.model}`}(),model:function(){var t=uni.getSystemInfoSync()||{};if("mp-weixin"===t.uniPlatform&&"undefined"!=typeof wx&&wx.getSystemInfoSync){var o=wx.getSystemInfoSync();return`${t.uniRuntimeVersion}/${o.SDKVersion}`}if("undefined"!=typeof tt&&tt.getSystemInfoSync){var a=tt.getSystemInfoSync();return`${t.uniRuntimeVersion}/${a.SDKVersion}`}if("undefined"!=typeof swan&&swan.getSystemInfoSync){var c=swan.getSystemInfoSync();return`${t.uniRuntimeVersion}/${c.SDKVersion}`}return"undefined"!=typeof my&&my.getSystemInfoSync?(my.getSystemInfoSync(),`${t.uniRuntimeVersion}/${my.SDKVersion}`):`${t.uniRuntimeVersion}`}(),manufactor:o[1],pushDeviceInfo:{PRODUCT:t.model,DEVICE:t.model,MANUFACTURER:t.brand}}}function getFileUploadInformation$5(t){return null}var getAdapter$5=()=>({setLogger(t){Xa=t},platform:"UNIAPP",localStorage:Qa,request:request$4,WebSocket:WebSocket$4,uploadFile:uploadFile$5,getFileUploadInformation:getFileUploadInformation$5,getSystemInfo:getSystemInfo$5,net:{__getEnv:()=>uni}}),Za=createCommonjsModule((function(o,a){(function(){var c={function:!0,object:!0}[typeof window]&&window||this,m=a,h=o&&!o.nodeType&&o,g=m&&h&&"object"==typeof t&&t;!g||g.global!==g&&g.window!==g&&g.self!==g||(c=g);var _=Math.pow(2,53)-1,I=/\bOpera/,E=Object.prototype,T=E.hasOwnProperty,M=E.toString;function capitalize(t){return(t=String(t)).charAt(0).toUpperCase()+t.slice(1)}function format(t){return t=trim(t),/^(?:webOS|i(?:OS|P))/.test(t)?t:capitalize(t)}function forOwn(t,o){for(var a in t)T.call(t,a)&&o(t[a],a,t)}function getClassOf(t){return null==t?capitalize(t):M.call(t).slice(8,-1)}function qualify(t){return String(t).replace(/([ -])(?!$)/g,"$1?")}function reduce(t,o){var a=null;return function each(t,o){var a=-1,c=t?t.length:0;if("number"==typeof c&&c>-1&&c<=_)for(;++a<c;)o(t[a],a,t);else forOwn(t,o)}(t,(function(c,m){a=o(a,c,m,t)})),a}function trim(t){return String(t).replace(/^ +| +$/g,"")}var S=function parse(t){var o=c,a=t&&"object"==typeof t&&"String"!=getClassOf(t);a&&(o=t,t=null);var m=o.navigator||{},h=m.userAgent||"";t||(t=h);var g,_,E=a?!!m.likeChrome:/\bChrome\b/.test(t)&&!/internal|\n/i.test(M.toString()),T="Object",S=a?T:"ScriptBridgingProxyObject",N=a?T:"Environment",C=a&&o.java?"JavaPackage":getClassOf(o.java),A=a?T:"RuntimeObject",O=/\bJava/.test(C)&&o.java,R=O&&getClassOf(o.environment)==N,b=O?"a":"Î±",V=O?"b":"Î²",P=o.document||{},k=o.operamini||o.opera,L=I.test(L=a&&k?k["[[Class]]"]:getClassOf(k))?L:k=null,D=t,w=[],U=null,x=t==h,G=x&&k&&"function"==typeof k.version&&k.version(),B=function getLayout(o){return reduce(o,(function(o,a){return o||RegExp("\\b"+(a.pattern||qualify(a))+"\\b","i").exec(t)&&(a.label||a)}))}([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"]),j=function getName(o){return reduce(o,(function(o,a){return o||RegExp("\\b"+(a.pattern||qualify(a))+"\\b","i").exec(t)&&(a.label||a)}))}(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"(?:Edge|Edg|EdgA|EdgiOS)"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Vivaldi","Waterfox","WebPositive",{label:"Yandex Browser",pattern:"YaBrowser"},{label:"UC Browser",pattern:"UCBrowser"},"Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chromium","Chrome",{label:"Chrome",pattern:"(?:HeadlessChrome)"},{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]),Y=getProduct([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),H=function getManufacturer(o){return reduce(o,(function(o,a,c){return o||(a[Y]||a[/^[a-z]+(?: +[a-z]+\b)*/i.exec(Y)]||RegExp("\\b"+qualify(c)+"(?:\\b|\\w*\\d)","i").exec(t))&&c}))}({Apple:{iPad:1,iPhone:1,iPod:1},Alcatel:{},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},Huawei:{},Lenovo:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Oppo:{},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1},Xiaomi:{Mi:1,Redmi:1}}),$=function getOS(o){return reduce(o,(function(o,a){var c=a.pattern||qualify(a);return!o&&(o=RegExp("\\b"+c+"(?:/[\\d.]+|[ \\w.]*)","i").exec(t))&&(o=function cleanupOS(t,o,a){var c={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};return o&&a&&/^Win/i.test(t)&&!/^Windows Phone /i.test(t)&&(c=c[/[\d.]+$/.exec(t)])&&(t="Windows "+c),t=String(t),o&&a&&(t=t.replace(RegExp(o,"i"),a)),format(t.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])}(o,c,a.label||a)),o}))}(["Windows Phone","KaiOS","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian",{label:"DragonFly BSD",pattern:"DragonFly"},"Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);function getProduct(o){return reduce(o,(function(o,a){var c=a.pattern||qualify(a);return!o&&(o=RegExp("\\b"+c+" *\\d+[.\\w_]*","i").exec(t)||RegExp("\\b"+c+" *\\w+-[\\w]*","i").exec(t)||RegExp("\\b"+c+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(t))&&((o=String(a.label&&!RegExp(c,"i").test(a.label)?a.label:o).split("/"))[1]&&!/[\d.]+/.test(o[0])&&(o[0]+=" "+o[1]),a=a.label||a,o=format(o[0].replace(RegExp(c,"i"),a).replace(RegExp("; *(?:"+a+"[_-])?","i")," ").replace(RegExp("("+a+")[-_.]?(\\w)","i"),"$1 $2"))),o}))}function getVersion(o){return reduce(o,(function(o,a){return o||(RegExp(a+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(t)||0)[1]||null}))}if(B&&(B=[B]),/\bAndroid\b/.test($)&&!Y&&(g=/\bAndroid[^;]*;(.*?)(?:Build|\) AppleWebKit)\b/i.exec(t))&&(Y=trim(g[1]).replace(/^[a-z]{2}-[a-z]{2};\s*/i,"")||null),H&&!Y?Y=getProduct([H]):H&&Y&&(Y=Y.replace(RegExp("^("+qualify(H)+")[-_.\\s]","i"),H+" ").replace(RegExp("^("+qualify(H)+")[-_.]?(\\w)","i"),H+" $2")),(g=/\bGoogle TV\b/.exec(Y))&&(Y=g[0]),/\bSimulator\b/i.test(t)&&(Y=(Y?Y+" ":"")+"Simulator"),"Opera Mini"==j&&/\bOPiOS\b/.test(t)&&w.push("running in Turbo/Uncompressed mode"),"IE"==j&&/\blike iPhone OS\b/.test(t)?(H=(g=parse(t.replace(/like iPhone OS/,""))).manufacturer,Y=g.product):/^iP/.test(Y)?(j||(j="Safari"),$="iOS"+((g=/ OS ([\d_]+)/i.exec(t))?" "+g[1].replace(/_/g,"."):"")):"Konqueror"==j&&/^Linux\b/i.test($)?$="Kubuntu":H&&"Google"!=H&&(/Chrome/.test(j)&&!/\bMobile Safari\b/i.test(t)||/\bVita\b/.test(Y))||/\bAndroid\b/.test($)&&/^Chrome/.test(j)&&/\bVersion\//i.test(t)?(j="Android Browser",$=/\bAndroid\b/.test($)?$:"Android"):"Silk"==j?(/\bMobi/i.test(t)||($="Android",w.unshift("desktop mode")),/Accelerated *= *true/i.test(t)&&w.unshift("accelerated")):"UC Browser"==j&&/\bUCWEB\b/.test(t)?w.push("speed mode"):"PaleMoon"==j&&(g=/\bFirefox\/([\d.]+)\b/.exec(t))?w.push("identifying as Firefox "+g[1]):"Firefox"==j&&(g=/\b(Mobile|Tablet|TV)\b/i.exec(t))?($||($="Firefox OS"),Y||(Y=g[1])):!j||(g=!/\bMinefield\b/i.test(t)&&/\b(?:Firefox|Safari)\b/.exec(j))?(j&&!Y&&/[\/,]|^[^(]+?\)/.test(t.slice(t.indexOf(g+"/")+8))&&(j=null),(g=Y||H||$)&&(Y||H||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test($))&&(j=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test($)?$:g)+" Browser")):"Electron"==j&&(g=(/\bChrome\/([\d.]+)\b/.exec(t)||0)[1])&&w.push("Chromium "+g),G||(G=getVersion(["(?:Cloud9|CriOS|CrMo|Edge|Edg|EdgA|EdgiOS|FxiOS|HeadlessChrome|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$)|UCBrowser|YaBrowser)","Version",qualify(j),"(?:Firefox|Minefield|NetFront)"])),(g=("iCab"==B&&parseFloat(G)>3?"WebKit":/\bOpera\b/.test(j)&&(/\bOPR\b/.test(t)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(t)&&!/^(?:Trident|EdgeHTML)$/.test(B)&&"WebKit"||!B&&/\bMSIE\b/i.test(t)&&("Mac OS"==$?"Tasman":"Trident")||"WebKit"==B&&/\bPlayStation\b(?! Vita\b)/i.test(j)&&"NetFront")&&(B=[g]),"IE"==j&&(g=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(t)||0)[1])?(j+=" Mobile",$="Windows Phone "+(/\+$/.test(g)?g:g+".x"),w.unshift("desktop mode")):/\bWPDesktop\b/i.test(t)?(j="IE Mobile",$="Windows Phone 8.x",w.unshift("desktop mode"),G||(G=(/\brv:([\d.]+)/.exec(t)||0)[1])):"IE"!=j&&"Trident"==B&&(g=/\brv:([\d.]+)/.exec(t))&&(j&&w.push("identifying as "+j+(G?" "+G:"")),j="IE",G=g[1]),x){if(function isHostType(t,o){var a=null!=t?typeof t[o]:"number";return!(/^(?:boolean|number|string|undefined)$/.test(a)||"object"==a&&!t[o])}(o,"global"))if(O&&(D=(g=O.lang.System).getProperty("os.arch"),$=$||g.getProperty("os.name")+" "+g.getProperty("os.version")),R){try{G=o.require("ringo/engine").version.join("."),j="RingoJS"}catch(t){(g=o.system)&&g.global.system==o.system&&(j="Narwhal",$||($=g[0].os||null))}j||(j="Rhino")}else"object"==typeof o.process&&!o.process.browser&&(g=o.process)&&("object"==typeof g.versions&&("string"==typeof g.versions.electron?(w.push("Node "+g.versions.node),j="Electron",G=g.versions.electron):"string"==typeof g.versions.nw&&(w.push("Chromium "+G,"Node "+g.versions.node),j="NW.js",G=g.versions.nw)),j||(j="Node.js",D=g.arch,$=g.platform,G=(G=/[\d.]+/.exec(g.version))?G[0]:null));else getClassOf(g=o.runtime)==S?(j="Adobe AIR",$=g.flash.system.Capabilities.os):getClassOf(g=o.phantom)==A?(j="PhantomJS",G=(g=g.version||null)&&g.major+"."+g.minor+"."+g.patch):"number"==typeof P.documentMode&&(g=/\bTrident\/(\d+)/i.exec(t))?(G=[G,P.documentMode],(g=+g[1]+4)!=G[1]&&(w.push("IE "+G[1]+" mode"),B&&(B[1]=""),G[1]=g),G="IE"==j?String(G[1].toFixed(1)):G[0]):"number"==typeof P.documentMode&&/^(?:Chrome|Firefox)\b/.test(j)&&(w.push("masking as "+j+" "+G),j="IE",G="11.0",B=["Trident"],$="Windows");$=$&&format($)}if(G&&(g=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(G)||/(?:alpha|beta)(?: ?\d)?/i.exec(t+";"+(x&&m.appMinorVersion))||/\bMinefield\b/i.test(t)&&"a")&&(U=/b/i.test(g)?"beta":"alpha",G=G.replace(RegExp(g+"\\+?$"),"")+("beta"==U?V:b)+(/\d+\+?/.exec(g)||"")),"Fennec"==j||"Firefox"==j&&/\b(?:Android|Firefox OS|KaiOS)\b/.test($))j="Firefox Mobile";else if("Maxthon"==j&&G)G=G.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(Y))"Xbox 360"==Y&&($=null),"Xbox 360"==Y&&/\bIEMobile\b/.test(t)&&w.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(j)&&(!j||Y||/Browser|Mobi/.test(j))||"Windows CE"!=$&&!/Mobi/i.test(t))if("IE"==j&&x)try{null===o.external&&w.unshift("platform preview")}catch(t){w.unshift("embedded")}else(/\bBlackBerry\b/.test(Y)||/\bBB10\b/.test(t))&&(g=(RegExp(Y.replace(/ +/g," *")+"/([.\\d]+)","i").exec(t)||0)[1]||G)?($=((g=[g,/BB10/.test(t)])[1]?(Y=null,H="BlackBerry"):"Device Software")+" "+g[0],G=null):this!=forOwn&&"Wii"!=Y&&(x&&k||/Opera/.test(j)&&/\b(?:MSIE|Firefox)\b/i.test(t)||"Firefox"==j&&/\bOS X (?:\d+\.){2,}/.test($)||"IE"==j&&($&&!/^Win/.test($)&&G>5.5||/\bWindows XP\b/.test($)&&G>8||8==G&&!/\bTrident\b/.test(t)))&&!I.test(g=parse.call(forOwn,t.replace(I,"")+";"))&&g.name&&(g="ing as "+g.name+((g=g.version)?" "+g:""),I.test(j)?(/\bIE\b/.test(g)&&"Mac OS"==$&&($=null),g="identify"+g):(g="mask"+g,j=L?format(L.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(g)&&($=null),x||(G=null)),B=["Presto"],w.push(g));else j+=" Mobile";(g=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(t)||0)[1])&&(g=[parseFloat(g.replace(/\.(\d)$/,".0$1")),g],"Safari"==j&&"+"==g[1].slice(-1)?(j="WebKit Nightly",U="alpha",G=g[1].slice(0,-1)):G!=g[1]&&G!=(g[2]=(/\bSafari\/([\d.]+\+?)/i.exec(t)||0)[1])||(G=null),g[1]=(/\b(?:Headless)?Chrome\/([\d.]+)/i.exec(t)||0)[1],537.36==g[0]&&537.36==g[2]&&parseFloat(g[1])>=28&&"WebKit"==B&&(B=["Blink"]),x&&(E||g[1])?(B&&(B[1]="like Chrome"),g=g[1]||((g=g[0])<530?1:g<532?2:g<532.05?3:g<533?4:g<534.03?5:g<534.07?6:g<534.1?7:g<534.13?8:g<534.16?9:g<534.24?10:g<534.3?11:g<535.01?12:g<535.02?"13+":g<535.07?15:g<535.11?16:g<535.19?17:g<536.05?18:g<536.1?19:g<537.01?20:g<537.11?"21+":g<537.13?23:g<537.18?24:g<537.24?25:g<537.36?26:"Blink"!=B?"27":"28")):(B&&(B[1]="like Safari"),g=(g=g[0])<400?1:g<500?2:g<526?3:g<533?4:g<534?"4+":g<535?5:g<537?6:g<538?7:g<601?8:g<602?9:g<604?10:g<606?11:g<608?12:"12"),B&&(B[1]+=" "+(g+="number"==typeof g?".x":/[.+]/.test(g)?"":"+")),"Safari"==j&&(!G||parseInt(G)>45)?G=g:"Chrome"==j&&/\bHeadlessChrome/i.test(t)&&w.unshift("headless")),"Opera"==j&&(g=/\bzbov|zvav$/.exec($))?(j+=" ",w.unshift("desktop mode"),"zvav"==g?(j+="Mini",G=null):j+="Mobile",$=$.replace(RegExp(" *"+g+"$"),"")):"Safari"==j&&/\bChrome\b/.exec(B&&B[1])?(w.unshift("desktop mode"),j="Chrome Mobile",G=null,/\bOS X\b/.test($)?(H="Apple",$="iOS 4.3+"):$=null):/\bSRWare Iron\b/.test(j)&&!G&&(G=getVersion("Chrome")),G&&0==G.indexOf(g=/[\d.]+$/.exec($))&&t.indexOf("/"+g+"-")>-1&&($=trim($.replace(g,""))),$&&-1!=$.indexOf(j)&&!RegExp(j+" OS").test($)&&($=$.replace(RegExp(" *"+qualify(j)+" *"),"")),B&&!/\b(?:Avant|Nook)\b/.test(j)&&(/Browser|Lunascape|Maxthon/.test(j)||"Safari"!=j&&/^iOS/.test($)&&/\bSafari\b/.test(B[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|SRWare Iron|Vivaldi|Web)/.test(j)&&B[1])&&(g=B[B.length-1])&&w.push(g),w.length&&(w=["("+w.join("; ")+")"]),H&&Y&&Y.indexOf(H)<0&&w.push("on "+H),Y&&w.push((/^on /.test(w[w.length-1])?"":"on ")+Y),$&&(g=/ ([\d.+]+)$/.exec($),_=g&&"/"==$.charAt($.length-g[0].length-1),$={architecture:32,family:g&&!_?$.replace(g[0],""):$,version:g?g[1]:null,toString:function(){var t=this.version;return this.family+(t&&!_?" "+t:"")+(64==this.architecture?" 64-bit":"")}}),(g=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(D))&&!/\bi686\b/i.test(D)?($&&($.architecture=64,$.family=$.family.replace(RegExp(" *"+g),"")),j&&(/\bWOW64\b/i.test(t)||x&&/\w(?:86|32)$/.test(m.cpuClass||m.platform)&&!/\bWin64; x64\b/i.test(t))&&w.unshift("32-bit")):$&&/^OS X/.test($.family)&&"Chrome"==j&&parseFloat(G)>=39&&($.architecture=64),t||(t=null);var q={};return q.description=t,q.layout=B&&B[0],q.manufacturer=H,q.name=j,q.prerelease=U,q.product=Y,q.ua=t,q.version=j&&G,q.os=$||{architecture:null,family:null,version:null,toString:function(){return"null"}},q.parse=parse,q.toString=function toStringPlatform(){return this.description||""},q.version&&w.unshift(G),q.name&&w.unshift(j),$&&j&&($!=String($).split(" ")[0]||$!=j.split(" ")[0]&&!Y)&&w.push(Y?"("+$+")":"on "+$),w.length&&(q.description=w.join(" ")),q}();m&&h?forOwn(S,(function(t,o){m[o]=t})):c.platform=S}).call(t)})),ec=createCommonjsModule((function(t,o){self,t.exports=function(){var t={d:function(o,a){for(var c in a)t.o(a,c)&&!t.o(o,c)&&Object.defineProperty(o,c,{enumerable:!0,get:a[c]})},o:function(t,o){return Object.prototype.hasOwnProperty.call(t,o)}},o={};t.d(o,{default:function(){return M}});var a=function e(t){for(var o in function(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}(this,e),this.directUploadAddr="https://wanproxy-web.127.net",this.retryCount=4,this.trunkSize=4194304,this.trunkUploadTimeout=5e4,this.getOffsetTimeout=1e4,this.version="1.0",this.enableCache=!0,this.logger=console,this.onError=function(t){},this.onProgress=function(t){},this.onUploadProgress=function(t){},this.onComplete=function(t){},t)this[o]=t[o]};function n(t,o){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function(t,o){if(t){if("string"==typeof t)return r(t,o);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?r(t,o):void 0}}(t))||o&&t&&"number"==typeof t.length){a&&(t=a);var c=0,i=function(){};return{s:i,n:function(){return c>=t.length?{done:!0}:{done:!1,value:t[c++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var m,h=!0,g=!1;return{s:function(){a=a.call(t)},n:function(){var t=a.next();return h=t.done,t},e:function(t){g=!0,m=t},f:function(){try{h||null==a.return||a.return()}finally{if(g)throw m}}}}function r(t,o){(null==o||o>t.length)&&(o=t.length);for(var a=0,c=new Array(o);a<o;a++)c[a]=t[a];return c}var c={privateObj:{},setItem:function(t,o){c.privateObj[t]=o},getItem:function(t){return c.privateObj[t]},removeItem:function(t){delete c.privateObj[t]},getKeys:function(){return Object.keys(c.privateObj)}},m={getFileKey:function(t){var o=t.size.toString(),a=t.lastModified.toString();return"_NosUploader_"+t.name+o.slice(o.length-5)+a.slice(a.length-5)},getFileInfo:function(t){var o=c.getItem(t);if(!o)return null;try{return JSON.parse(o)}catch(t){return null}},initFile:function(t,o,a){m.clearExpiredInfo();var h=this.getFileKey(o),g={ctx:void 0!==t.ctx?t.ctx:"",bucket:t.bucketName,obj:t.objectName,token:t.token,modifyAt:Date.now(),end:!1};return t.payload&&(g.payload=t.payload),a&&c.setItem(h,JSON.stringify(g)),h},setUploadContext:function(t,o,a){var m=this.getFileInfo(t);m&&(m.ctx=o,a&&c.setItem(t,JSON.stringify(m)))},setComplete:function(t,o){var a=this.getFileInfo(t);a&&(a.modifyAt=Date.now(),a.end=!0,o&&c.setItem(t,JSON.stringify(a)))},getUploadContext:function(t){var o=this.getFileInfo(t);return o?o.ctx:""},removeFileInfo:function(t){0===t.indexOf("_NosUploader_")&&c.removeItem(t)},clearExpiredInfo:function(){var t,o="function"==typeof c.getKeys?c.getKeys():Object.keys(c),a=Date.now(),h=[],g=n(o);try{for(g.s();!(t=g.n()).done;){var _=t.value;if(0===_.indexOf("_NosUploader_")){var I=m.getFileInfo(_);null===I||a-I.modifyAt>M.expireTime?c.removeItem(_):h.push({fileInfo:I,key:_})}}}catch(t){g.e(t)}finally{g.f()}if(h.length>M.maxFileCache){var E,T=n(h.sort((function(t,o){return o.fileInfo.modifyAt-t.fileInfo.modifyAt})).slice(M.maxFileCache));try{for(T.s();!(E=T.n()).done;){var S=E.value;0===S.key.indexOf("_NosUploader_")&&c.removeItem(S.key)}}catch(t){T.e(t)}finally{T.f()}}}},h=m;function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function f(t,o){return!o||"object"!==u(o)&&"function"!=typeof o?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):o}function l(t){var o="function"==typeof Map?new Map:void 0;return(l=function(t){if(null===t||(a=t,-1===Function.toString.call(a).indexOf("[native code]")))return t;var a;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==o){if(o.has(t))return o.get(t);o.set(t,n)}function n(){return s(t,arguments,y(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),d(n,t)})(t)}function s(t,o,a){return(s=p()?Reflect.construct:function(t,o,a){var c=[null];c.push.apply(c,o);var m=new(Function.bind.apply(t,c));return a&&d(m,a.prototype),m}).apply(null,arguments)}function p(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function d(t,o){return(d=Object.setPrototypeOf||function(t,o){return t.__proto__=o,t})(t,o)}function y(t){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var g=function(t){!function(t,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(o&&o.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),o&&d(t,o)}(r,t);var o,a,c=(o=r,a=p(),function(){var t,c=y(o);if(a){var m=y(this).constructor;t=Reflect.construct(c,arguments,m)}else t=c.apply(this,arguments);return f(this,t)});function r(t,o){var a;return function(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}(this,r),(a=c.call(this,"NosUploadError:"+t)).errCode=o,a.errMsg=t,a}return r}(l(Error)),_=function e(t,o,a){if("uploading"===t.uploadState){var c=t.config,m=t.param,_=h.getUploadContext(t.fileKey);if(!_)return a(0);var I=new XMLHttpRequest,E=c.directUploadAddr+"/".concat(m.bucketName)+"/".concat(encodeURIComponent(m.objectName))+"?uploadContext"+"&context=".concat(_)+"&version=".concat(c.version);I.onreadystatechange=function(){var m;if("abort"!==t.uploadState&&4===I.readyState){var _;try{_=JSON.parse(I.responseText)}catch(t){_={errMsg:"JsonParseError in getOffset",errCode:500}}200===I.status?_.errCode?t.config.onError(new g(_.errMsg,_.errCode)):a(_.offset):I.status.toString().match(/^5/)?e(t,o-1,a):o>0?("function"==typeof(null===(m=c.logger)||void 0===m?void 0:m.error)&&c.logger.error("getOffset(".concat(E,") error. retry after 3 seconds. ").concat((new Date).toTimeString())),setTimeout((function(){e(t,o-1,a)}),3500)):I.status?(h.removeFileInfo(t.fileKey),c.onError(new g("getOffset(".concat(E,") error: ").concat(I.status," ").concat(I.statusText)))):c.onError(new g("getOffset(".concat(E,") error. no Error Code")))}},I.open("get",E),I.setRequestHeader("x-nos-token",m.token),I.timeout=c.getOffsetTimeout,I.send()}},I=function e(t,o,a,c){if("uploading"===t.uploadState){var m=t.param,_=t.config,I=File.prototype.slice,E=void 0!==m.ctx?m.ctx:"",T=o+_.trunkSize>t.file.size,M=T?t.file.size:o+_.trunkSize,S=new XMLHttpRequest,N=_.directUploadAddr+"/".concat(m.bucketName)+"/".concat(encodeURIComponent(m.objectName));if(S.upload.onprogress=function(a){if("abort"!==t.uploadState){var c=0;a.lengthComputable?(c=(o+a.loaded)/t.file.size,_.onProgress(c),_.onUploadProgress({loaded:a.loaded,total:t.file.size,percentage:c,percentageText:(100*c).toFixed(2)+"%"})):_.onError(new g("browser does not support query upload progress"))}},S.onreadystatechange=function(){var m,I;if("abort"!==t.uploadState&&4===S.readyState){var E;try{E=JSON.parse(S.responseText)}catch(t){"function"==typeof(null===(m=_.logger)||void 0===m?void 0:m.error)&&_.logger.error("JsonParseError in uploadTrunk",t),E={errMsg:"JsonParseError in uploadTrunk"}}200===S.status?(t.setContext(E.context),T?(c(),t.setComplete()):e(t,E.offset,_.retryCount,c)):S.status.toString().match(/^5/)?a>0?e(t,o,a-1,c):(h.removeFileInfo(t.fileKey),_.onError(new g(E.errMsg,E.errCode))):a>0?("function"==typeof(null===(I=_.logger)||void 0===I?void 0:I.error)&&_.logger.error("uploadTrunk(".concat(N,") error. retry after 3 seconds. ").concat((new Date).toTimeString())),setTimeout((function(){e(t,o,a-1,c)}),3500)):S.status?(h.removeFileInfo(t.fileKey),_.onError(new g("uploadTrunk(".concat(N,") error: ").concat(S.status," ").concat(S.statusText)))):_.onError(new g("uploadTrunk(".concat(N,") error. no Error Code. Please check your network")))}},S.open("post",N+"?offset=".concat(o)+"&complete=".concat(T)+"&context=".concat(E)+"&version=".concat(_.version)),S.setRequestHeader("x-nos-token",m.token),m.md5&&S.setRequestHeader("content-md5",m.md5),t.file.type&&S.setRequestHeader("content-type",t.file.type),S.timeout=_.trunkUploadTimeout,"undefined"!=typeof FileReader){var C=new FileReader;C.addEventListener("load",(function(t){var o;(null===(o=null==t?void 0:t.target)||void 0===o?void 0:o.result)instanceof ArrayBuffer&&t.target.result.byteLength>0?S.send(t.target.result):_.onError(new g("Read ArrayBuffer failed",194003))})),C.addEventListener("error",(function(t){var o=t.target.error;_.onError(new g("Read ArrayBuffer error. ".concat(o.toString()),194003))})),C.readAsArrayBuffer(I.call(t.file,o,M))}else S.send(I.call(t.file,o,M))}};function v(t,o){for(var a=0;a<o.length;a++){var c=o[a];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(t,c.key,c)}}var E=function(){function e(t,o,a){!function(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}(this,e),this.uploadState="paused",this.config=a,this.file=t,this.param=o,this.fileKey=h.initFile(o,t,this.config.enableCache),this.resume()}var t;return(t=[{key:"resume",value:function(){var t=this;if("uploading"!==this.uploadState){this.setUploadState("uploading");var o=this.config;_(this,o.retryCount,(function(a){I(t,a,o.retryCount,(function(){t.setUploadState("ended"),"function"==typeof o.onComplete&&o.onComplete(t.param)}))}))}}},{key:"pause",value:function(){this.setUploadState("paused")}},{key:"abort",value:function(){"ended"!==this.uploadState&&"abort"!==this.uploadState&&(this.setUploadState("abort"),this.config.onError(new g("Upload Aborted",10499)))}},{key:"setUploadState",value:function(t){t!==this.uploadState&&(this.uploadState=t)}},{key:"setContext",value:function(t){h.setUploadContext(this.fileKey,t,this.config.enableCache),this.param.ctx=t}},{key:"setComplete",value:function(){h.setComplete(this.fileKey,this.config.enableCache),this.setUploadState("ended")}}])&&v(e.prototype,t),e}(),T={maxFileCache:1/0,expireTime:864e5,getFileUploadInformation:function(t){var o=h.getFileKey(t),a=h.getFileInfo(o);return null===a?null:Date.now()-a.modifyAt>T.expireTime?(h.removeFileInfo(o),null):{uploadInfo:Object.assign({bucketName:a.bucket,objectName:a.obj,token:a.token,ctx:a.ctx},a.payload?{payload:a.payload}:{}),complete:a.end}},setMaxFileCache:function(t){T.maxFileCache=t},setExpireTime:function(t){T.expireTime=t},printCaches:function(){if("undefined"!=typeof localStorage)for(var t=0,o=Object.keys(localStorage);t<o.length;t++){var a=o[t],c=h.getFileInfo(a);c&&console.log(c,"modifiedAt",new Date(c.modifyAt).toTimeString())}},createConfig:function(t){return new a(t)},createTask:function(t,o,a){return new E(t,o,a)}},M=T;return o.default}()})),tc=createCommonjsModule((function(t,o){t.exports=function(){function object2String(t){if(t){var o="";return Object.keys(t).forEach((function(a,c){o+=0===c?"?":"&",o+=`${a}=${t[a]}`})),o}return""}class V2NIMError extends Error{constructor(t,o,a,c){super(a),this.source=t,this.code=o,this.desc=a,this.detail=c||{}}}function request(t,o={dataType:"json",method:"GET",timeout:5e3}){var a="text"===o.dataType?"text/plain; charset=UTF-8":"application/json; charset=UTF-8",c="GET"===o.method?object2String(o.params):"";return new Promise((function(m,h){if(window.XMLHttpRequest){var g,_=new XMLHttpRequest;if(_.onreadystatechange=function(){if(4===_.readyState)if(200===_.status){try{g=JSON.parse(_.response||"{}")}catch(t){g=_.response}m({status:_.status,data:g})}else setTimeout((()=>{h(new V2NIMError(1,_.status,`readyState: ${_.readyState}; statusText: ${_.statusText}`))}),0)},_.open(o.method,`${t}${c}`),_.timeout=o.timeout||5e3,_.setRequestHeader("Content-Type",a),o.headers)for(var I in o.headers)_.setRequestHeader(I,o.headers[I]);_.ontimeout=function(t){h(new V2NIMError(1,408,t&&t.message?t.message:"request timeout"))},_.send(JSON.stringify(o.data))}else h(new V2NIMError(2,10400,"request no suppout"))}))}return request}()})),rc=console;function uploadFile$4(t){return __awaiter(this,void 0,void 0,(function*(){if(!t.fileInput&&!t.file)throw new Error("File not exist");var o;if(t.file)o=t.file;else if("string"==typeof t.fileInput){var a=document.getElementById(t.fileInput);if(!(a&&a.files&&a.files[0]))throw new Error("Can not get file from fileInput");o=a.files[0]}else{if(!(t.fileInput&&t.fileInput.files&&t.fileInput.files[0]))throw new Error(`Can not get file from fileInput ${t.fileInput}`);o=t.fileInput.files[0]}if(t.maxSize&&o.size>t.maxSize)throw new Error(`The file exceeds maxSize limit. maxSize: ${t.maxSize}, get ${o.size}`);var c=yield new Promise(((a,c)=>{var m,h=ec.getFileUploadInformation(o),g=ec.createConfig({enableCache:!0,retryCount:0,directUploadAddr:t.chunkUploadHost,onError:function(t){c(t)},onUploadProgress:t.onUploadProgress||function(){},onComplete:function(t){a(t)}});if(h)if(h.complete)t.onUploadProgress&&t.onUploadProgress({total:o.size,loaded:o.size,percentage:1,percentageText:"100%"}),a(h.uploadInfo);else{m=ec.createTask(o,h.uploadInfo,g);try{t.onUploadStart&&t.onUploadStart(m)}catch(t){rc.error("Adapter uploadFile: options.onUploadStart error",t&&t.message),m.abort(),c(t)}}else{m=ec.createTask(o,Object.assign(Object.assign({bucketName:t.nosToken.bucket,objectName:decodeURIComponent(t.nosToken.objectName),token:t.nosToken.token},t.md5?{md5:t.md5}:{}),t.payload?{payload:t.payload}:{}),g);try{t.onUploadStart&&t.onUploadStart(m)}catch(t){rc.error("Adapter uploadFile: options.onUploadStart error",t&&t.message),m.abort(),c(t)}}}));return c.name=o.name,c.size=o.size,c.type=o.type,c.ext=c.name.lastIndexOf(".")>-1?c.name.slice(c.name.lastIndexOf(".")+1).toLowerCase():"",c}))}function getFileUploadInformation$4(t){var o;if(t.file)o=t.file;else if("string"==typeof t.fileInput){var a=document.getElementById(t.fileInput);if(!(a&&a.files&&a.files[0]))throw new Error("Can not get file from fileInput");o=a.files[0]}else{if(!(t.fileInput&&t.fileInput.files&&t.fileInput.files[0]))throw new Error(`Can not get file from fileInput ${t.fileInput}`);o=t.fileInput.files[0]}return ec.getFileUploadInformation(o)}function getSystemInfo$4(){var t,o,a=Za.version||"";if(isElectron())try{var c=navigator.userAgent.match(/Electron\/([\d.]+\d+)/);c&&c[1]&&"string"==typeof c[1]&&(a=c[1])}catch(t){}return{os:(null===(t=Za.os)||void 0===t?void 0:t.family)||"",osVer:(null===(o=Za.os)||void 0===o?void 0:o.version)||"",browser:Za.name||"",browserVer:Za.version||"",libEnv:"BROWSER",hostEnv:getBrowserHostEnv(),hostEnvEnum:getBrowserHostEnvEnum(),hostEnvVer:a,userAgent:navigator&&navigator.userAgent,model:a,manufactor:Za.name||""}}var ic=null,nc=null,getAdapter$4=()=>({setLogger(t){rc=t},platform:"BROWSER",localStorage:window.localStorage,request:tc,WebSocket:window.WebSocket,uploadFile:uploadFile$4,getFileUploadInformation:getFileUploadInformation$4,getSystemInfo:getSystemInfo$4,net:{getNetworkStatus:()=>Promise.resolve({net_type:ii.kStatNetTypeUnkonw,net_connect:"undefined"==typeof navigator||"boolean"!=typeof navigator.onLine||navigator.onLine}),onNetworkStatusChange(t){ic=function(){t({isConnected:!0,networkType:ii.kStatNetTypeUnkonw})},nc=function(){t({isConnected:!1,networkType:ii.kStatNetTypeUnkonw})},window.addEventListener("online",ic),window.addEventListener("offline",nc)},offNetworkStatusChange(){ic&&window.removeEventListener("online",ic),nc&&window.removeEventListener("offline",nc),ic=null,nc=null}}}),oc=console,sc={clear(){try{wx.clearStorageSync()}catch(t){oc.error("wx-app::ws: clearStorage ",t)}},getItem:t=>wx.getStorageSync(t),setItem:(t,o)=>wx.setStorageSync(t,o),removeItem:t=>wx.removeStorageSync(t)};class WebSocket$3{constructor(t,o=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(t){oc.log("wx-app: sockets on close ",t)},this.onerror=function(t){oc.error("wx-app: sockets error ",t)},this.onmessage=function(t){},this.onopen=function(){},!t)throw new Error("Failed to construct 'socket': url required");this.url=t.replace(/:443(\/|$)/,"$1"),this.protocol=o,this.readyState=this.CONNECTING;var a=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=wx.connectSocket(Object.assign(Object.assign({url:this.url},a),{fail:t=>{this.errorHandler(t)},success:()=>{}})),this.socketTask.onOpen((t=>{this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:t})})),this.socketTask.onError((t=>{this.errorHandler(t)})),this.socketTask.onClose((t=>{this.readyState=this.CLOSED;var{code:o,reason:a,wasClean:c}=t;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:o,reason:a,wasClean:c,type:"close"})})),this.socketTask.onMessage((t=>{this.onmessage&&this.onmessage(t)}))}close(){this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(t){if(this.readyState!==this.OPEN)throw new Error(`wx-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof t||t instanceof ArrayBuffer))throw new TypeError("wx-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask.send({data:t})}errorHandler(t){oc.error("wx-app::ws: onerror ",t),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:t&&t.errMsg})}}function request$3(t,o){return o&&(o.header=o.headers,o.data=o.data||(null==o?void 0:o.params)||{}),new Promise(((a,c)=>{wx.request(Object.assign(Object.assign({url:t},o),{success:function(t){t={data:t.data,status:t.statusCode,errMsg:t.errMsg,header:t.header},a(t)},fail:function(t){t.code=5===t.errno?wt.V2NIM_ERROR_CODE_TIMEOUT:t.errno,t.message=t.errMsg,c(t)}}))}))}function uploadFile$3(t){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((o,a)=>{var c=wx.uploadFile(Object.assign(Object.assign({url:`${t.commonUploadHost}/${t.nosToken.bucket}`},t.md5?{header:{"Content-MD5":t.md5}}:{}),{formData:{Object:decodeURIComponent(t.nosToken.objectName),"x-nos-token":t.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:t.filePath,success(c){if(200==c.statusCode)try{var m=JSON.parse(c.data);m.name=t.filePath,m.ext=m.name.lastIndexOf(".")>-1?m.name.slice(m.name.lastIndexOf(".")+1).toLowerCase():"",o(m)}catch(t){a(new Error(`Upload Error parse result error: ${c.data}`))}else a(new Error(`Upload error ${c.statusCode}: ${c.errMsg}`))},fail(t){t.code="uploadFile:fail abort"===t.errMsg?wt.V2NIM_ERROR_CODE_CANCELLED:t.errno,t.message=t.errMsg,a(t)}}));try{t.onUploadStart&&t.onUploadStart(c)}catch(t){oc.error("uploadFile: options.onUploadStart error",t),c.abort(),a(t)}t.onUploadProgress&&c.onProgressUpdate((function(o){t.onUploadProgress&&t.onUploadProgress({total:o.totalBytesExpectedToSend,loaded:o.totalBytesSent,percentage:o.progress,percentageText:o.progress+"%"})}))}))}))}function getSystemInfo$3(){var t=wx.getSystemInfoSync()||{};return{os:t.platform||"",osVer:t.system||"",browser:"",browserVer:"",libEnv:"MINIAPP",hostEnv:"WeiXin",hostEnvEnum:ri.WeiXin,hostEnvVer:t.version,model:t.SDKVersion,manufactor:"WeiXin",userAgent:`WeChat MiniApp: model/${t.model} system/${t.system}`,pushDeviceInfo:{PRODUCT:t.model,DEVICE:t.model,MANUFACTURER:t.brand}}}function getFileUploadInformation$3(t){return null}var getAdapter$3=()=>({setLogger(t){oc=t},platform:"WXAPP",localStorage:sc,request:request$3,WebSocket:WebSocket$3,uploadFile:uploadFile$3,getFileUploadInformation:getFileUploadInformation$3,getSystemInfo:getSystemInfo$3,net:{__getEnv:()=>wx}}),ac=console,cc={clear(){try{my.clearStorageSync()}catch(t){ac.error("ali-app::ws: clearStorage ",t)}},getItem:t=>my.getStorageSync({key:t}).data,setItem:(t,o)=>my.setStorageSync({key:t,data:o}),removeItem:t=>my.removeStorageSync({key:t})};class WebSocket$2{constructor(t,o=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(t){ac.log("my-app: sockets on close ",t)},this.onerror=function(t){ac.error("my-app: sockets error ",t)},this.onmessage=function(t){},this.onopen=function(){},!t)throw new Error("Failed to construct 'socket': url required");this.url=t.replace(/:443(\/|$)/,"$1"),this.protocol=o,this.readyState=this.CONNECTING,this.socketTask=my.connectSocket({url:this.url,multiple:!0,fail:t=>{this.errorHandler(t)},success:()=>{this.readyState=this.OPEN}}),this.socketTask.onOpen((t=>{this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:t})})),this.socketTask.onError((t=>{this.errorHandler(t)})),this.socketTask.onClose((t=>{this.readyState=this.CLOSED;var{code:o,reason:a,wasClean:c}=t;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:o,reason:a,wasClean:c,type:"close"}),this.socketTask=null})),this.socketTask.onMessage((t=>{var o,a=null===(o=t.data)||void 0===o?void 0:o.data,c=a;t.data.isBuffer&&(c=base64ToArrayBuffer(a)),this.onmessage&&this.onmessage({data:c})}))}close(){this.socketTask&&this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(t){if(this.readyState!==this.OPEN)throw new Error(`my-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof t||t instanceof ArrayBuffer))throw new TypeError("my-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask&&this.socketTask.send({data:t,isBuffer:t instanceof ArrayBuffer})}errorHandler(t){ac.error("my-app::ws: onerror ",t),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:t&&t.errMsg})}}function request$2(t,o){return o&&(o.data=o.data||(null==o?void 0:o.params)||{}),new Promise(((a,c)=>{my.request(Object.assign(Object.assign({url:t},o),{success:function(t){t={data:t.data,status:t.status,errMsg:t.errMsg,header:t.header},a(t)},fail:function(t){t.code=13===t.error?wt.V2NIM_ERROR_CODE_TIMEOUT:t.error,t.message=t.errorMessage,c(t)}}))}))}function uploadFile$2(t){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((o,a)=>{var c=my.uploadFile(Object.assign(Object.assign({url:`${t.commonUploadHost}/${t.nosToken.bucket}`},t.md5?{header:{"Content-MD5":t.md5}}:{}),{formData:{Object:decodeURIComponent(t.nosToken.objectName),"x-nos-token":t.nosToken.token,"x-nos-entity-type":"json"},fileType:t.type,fileName:"file",filePath:t.filePath,success(c){if(200==c.statusCode)try{var m=JSON.parse(c.data);m.name=t.filePath,m.ext=m.name.lastIndexOf(".")>-1?m.name.slice(m.name.lastIndexOf(".")+1).toLowerCase():"",o(m)}catch(t){a(new Error(`Upload Error parse result error: ${c.data}`))}else a(new Error(`Upload error ${c.statusCode}: ${c.errMsg}`))},fail(t){t.code=9===t.error?wt.V2NIM_ERROR_CODE_CANCELLED:t.error,t.message=t.errorMessage,a(t)}}));try{t.onUploadStart&&t.onUploadStart(c)}catch(t){ac.error("uploadFile: options.onUploadStart error",t),c.abort(),a(t)}t.onUploadProgress&&c.onProgressUpdate((function(o){t.onUploadProgress&&t.onUploadProgress({total:o.totalBytesExpectedToWrite,loaded:o.totalBytesWritten,percentage:o.progress,percentageText:o.progress+"%"})}))}))}))}function getFileUploadInformation$2(t){return null}function getSystemInfo$2(){var t=my.getSystemInfoSync()||{};return{libEnv:"MINIAPP",os:t.platform||"",osVer:t.system||"",browser:"",browserVer:"",hostEnv:"Ali",hostEnvEnum:ri.Ali,hostEnvVer:t.version,userAgent:`Ali MiniApp: model/${t.model} system/${t.system}`,model:my.SDKVersion,manufactor:"Ali",pushDeviceInfo:{PRODUCT:t.model,DEVICE:t.model,MANUFACTURER:t.brand}}}var getAdapter$2=()=>({setLogger(t){ac=t},platform:"ALIAPP",localStorage:cc,request:request$2,WebSocket:WebSocket$2,uploadFile:uploadFile$2,getSystemInfo:getSystemInfo$2,getFileUploadInformation:getFileUploadInformation$2,net:{__getEnv:()=>my}}),dc=console,lc={clear(){try{swan.clearStorageSync()}catch(t){dc.error("baidu-app::ws: clearStorage ",t)}},getItem:t=>swan.getStorageSync(t),setItem:(t,o)=>swan.setStorageSync(t,o),removeItem:t=>swan.removeStorageSync(t)};class WebSocket$1{constructor(t,o=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(t){dc.log("baidu-app: sockets on close ",t)},this.onerror=function(t){dc.error("baidu-app: sockets error ",t)},this.onmessage=function(t){},this.onopen=function(){},!t)throw new Error("Failed to construct 'socket': url required");this.url=t.replace(/:443(\/|$)/,"$1"),this.protocol=o,this.readyState=this.CONNECTING;var a=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=swan.connectSocket(Object.assign(Object.assign({url:this.url},a),{fail:t=>{this.errorHandler(t)},success:()=>{}})),this.socketTask.onOpen((t=>{this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:t})})),this.socketTask.onError((t=>{this.errorHandler(t)})),this.socketTask.onClose((t=>{this.readyState=this.CLOSED;var{code:o,reason:a,wasClean:c}=t;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:o,reason:a,wasClean:c,type:"close"})})),this.socketTask.onMessage((t=>{this.onmessage&&this.onmessage({data:t.data})}))}close(){this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(t){if(this.readyState!==this.OPEN)throw new Error(`wx-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof t||t instanceof ArrayBuffer))throw new TypeError("wx-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask.send({data:t})}errorHandler(t){this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:t&&t.errMsg})}}function request$1(t,o){return o&&(o.header=o.headers,o.data=o.data||(null==o?void 0:o.params)||{}),new Promise(((a,c)=>{swan.request(Object.assign(Object.assign({url:t},o),{success:function(t){t={data:t.data,status:t.statusCode,errMsg:t.errMsg,header:t.header},a(t)},fail:function(t){t.code=1===t.errCode?wt.V2NIM_ERROR_CODE_TIMEOUT:t.errCode,t.message=t.errMsg,c(t)}}))}))}function uploadFile$1(t){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((o,a)=>{var c=swan.uploadFile(Object.assign(Object.assign({url:`${t.commonUploadHost}/${t.nosToken.bucket}`},t.md5?{header:{"Content-MD5":t.md5}}:{}),{formData:{Object:decodeURIComponent(t.nosToken.objectName),"x-nos-token":t.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:t.filePath,success(c){if(200==c.statusCode)try{var m=JSON.parse(c.data);m.name=t.filePath,m.ext=m.name.lastIndexOf(".")>-1?m.name.slice(m.name.lastIndexOf(".")+1).toLowerCase():"",o(m)}catch(t){a(new Error(`Upload Error parse result error: ${c.data}`))}else a(new Error(`Upload error ${c.statusCode}: ${c.errMsg}`))},fail(t){t.code="uploadFile:fail abort"===t.errMsg?wt.V2NIM_ERROR_CODE_CANCELLED:t.errCode,t.message=t.errMsg,a(t)}}));try{t.onUploadStart&&t.onUploadStart(c)}catch(t){dc.error("uploadFile: options.onUploadStart error",t),c.abort(),a(t)}t.onUploadProgress&&c.onProgressUpdate((function(o){t.onUploadProgress&&t.onUploadProgress({total:o.totalBytesExpectedToSend,loaded:o.totalBytesSent,percentage:o.progress,percentageText:o.progress+"%"})}))}))}))}function getFileUploadInformation$1(t){return null}function getSystemInfo$1(){var t=swan.getSystemInfoSync()||{};return{os:t.platform||"",osVer:t.system||"",browser:"",browserVer:"",libEnv:"MINIAPP",hostEnv:"Baidu",userAgent:`Baidu MiniApp: model/${t.model} system/${t.system}`,hostEnvVer:t.version,hostEnvEnum:ri.Baidu,model:t.SDKVersion,manufactor:"Baidu",pushDeviceInfo:{PRODUCT:t.model,DEVICE:t.model,MANUFACTURER:t.brand}}}var getAdapter$1=()=>({setLogger(t){dc=t},platform:"BAIDUAPP",localStorage:lc,request:request$1,WebSocket:WebSocket$1,uploadFile:uploadFile$1,getFileUploadInformation:getFileUploadInformation$1,getSystemInfo:getSystemInfo$1,net:{__getEnv:()=>swan}}),pc=console,uc={clear(){try{tt.clearStorageSync()}catch(t){pc.error("tt-app::ws: clearStorage ",t)}},getItem:t=>tt.getStorageSync(t),setItem:(t,o)=>tt.setStorageSync(t,o),removeItem:t=>tt.removeStorageSync(t)};class WebSocket{constructor(t,o=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(t){pc.log("wx-app: sockets on close ",t)},this.onerror=function(t){pc.error("wx-app: sockets error ",t)},this.onmessage=function(t){},this.onopen=function(){},!t)throw new Error("Failed to construct 'socket': url required");this.url=t.replace(/:443(\/|$)/,"$1"),this.protocol=o,this.readyState=this.CONNECTING;var a=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=tt.connectSocket(Object.assign(Object.assign({url:this.url},a),{fail:t=>{this.errorHandler(t)},success:()=>{}})),this.socketTask.onOpen((t=>{this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:t.header})})),this.socketTask.onError((t=>{this.errorHandler(t)})),this.socketTask.onClose((t=>{this.readyState=this.CLOSED;var{code:o,reason:a,wasClean:c}=t;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:o,reason:a,wasClean:c,type:"close"})})),this.socketTask.onMessage((t=>{this.onmessage&&this.onmessage({data:t.data})}))}close(){this.socketTask&&this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{}})}send(t){if(this.readyState!==this.OPEN)throw new Error(`tt-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof t||t instanceof ArrayBuffer))throw new TypeError("tt-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask&&this.socketTask.send({data:t})}errorHandler(t){pc.error("tt-app::ws: onerror ",t),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:t&&t.errMsg})}}function request(t,o){return o&&(o.header=o.headers,o.data=o.data||(null==o?void 0:o.params)||{}),new Promise(((a,c)=>{tt.request(Object.assign(Object.assign({url:t},o),{success:function(t){t={data:t.data,status:t.statusCode,errMsg:t.errMsg,header:t.header},a(t)},fail:function(t){t.code=21103===t.errNo?wt.V2NIM_ERROR_CODE_TIMEOUT:t.errNo,t.message=t.errMsg,c(t)}}))}))}function uploadFile(t){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((o,a)=>{var c=tt.uploadFile(Object.assign(Object.assign({url:`${t.commonUploadHost}/${t.nosToken.bucket}`},t.md5?{header:{"Content-MD5":t.md5}}:{}),{formData:{Object:decodeURIComponent(t.nosToken.objectName),"x-nos-token":t.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:t.filePath,success(c){if(200==c.statusCode)try{var m=JSON.parse(c.data);m.name=t.filePath,m.ext=m.name.lastIndexOf(".")>-1?m.name.slice(m.name.lastIndexOf(".")+1).toLowerCase():"",o(m)}catch(t){a(new Error(`Upload Error parse result error: ${c.data}`))}else a(new Error(`Upload error ${c.statusCode}: ${c.errMsg}`))},fail(t){t.code=21104===t.errNo?wt.V2NIM_ERROR_CODE_CANCELLED:t.errNo,t.message=t.errMsg,a(t)}}));try{t.onUploadStart&&t.onUploadStart(c)}catch(t){pc.error("uploadFile: options.onUploadStart error",t),c.abort(),a(t)}t.onUploadProgress&&c.onProgressUpdate((function(o){t.onUploadProgress&&t.onUploadProgress({total:o.totalBytesExpectedToSend,loaded:o.totalBytesSent,percentage:o.progress,percentageText:o.progress+"%"})}))}))}))}function getFileUploadInformation(t){return null}function getSystemInfo(){var t=tt.getSystemInfoSync()||{};return{os:t.platform||"",osVer:t.system||"",browser:"",browserVer:"",libEnv:"MINIAPP",hostEnv:"Tiktok",hostEnvEnum:ri.Tiktok,hostEnvVer:t.version,model:t.SDKVersion,manufactor:"Tiktok",userAgent:`Tiktok MiniApp: model/${t.model} system/${t.system}`,pushDeviceInfo:{PRODUCT:t.model,DEVICE:t.model,MANUFACTURER:t.brand}}}var getAdapter=()=>({setLogger(t){pc=t},platform:"TTAPP",localStorage:uc,request:request,WebSocket:WebSocket,uploadFile:uploadFile,getSystemInfo:getSystemInfo,getFileUploadInformation:getFileUploadInformation,net:{__getEnv:()=>tt}}),mc={"28_9":"v2ConversationGroupCreate","28_10":"v2ConversationGroupDelete","28_11":"v2ConversationGroupUpdate","28_12":"v2ConversationGroupGet","28_13":"v2ConversationGroupsGet","28_14":"v2ConversationGroupListGet","28_15":"v2ConversationGroupAddTo","28_16":"v2ConversationGroupRemoveFrom","28_22":"v2ConversationGroupNotifySyncOnline"},hc="V2NIMConversationGroupService",gc={groupId:1,name:2,serverExtension:3,createTime:4,updateTime:5},_c={v2ConversationGroupCreate:{sid:28,cid:9,service:hc,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1,name:2,serverExtension:3}}],response:[{type:"Property",name:"data",reflectMapper:mn(gc)},{type:"PropertyArray",name:"conversations",reflectMapper:mn(as)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupDelete:{sid:28,cid:10,service:hc,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"info",reflectMapper:{1:"type",2:"deleteVersion",3:"groupList"}}]},v2ConversationGroupUpdate:{sid:28,cid:11,service:hc,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,name:2,serverExtension:3}}],response:[{type:"Property",name:"data",reflectMapper:mn(gc)}]},v2ConversationGroupGet:{sid:28,cid:12,service:hc,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"data",reflectMapper:mn(gc)}]},v2ConversationGroupsGet:{sid:28,cid:13,service:hc,params:[{type:"Property",name:"tag",reflectMapper:{groupIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:mn(gc)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupListGet:{sid:28,cid:14,service:hc,response:[{type:"PropertyArray",name:"datas",reflectMapper:mn(gc)}]},v2ConversationGroupAddTo:{sid:28,cid:15,service:hc,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,conversationIds:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:mn(as)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupRemoveFrom:{sid:28,cid:16,service:hc,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,conversationIds:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:mn(as)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupNotifySyncOnline:{sid:28,cid:22,service:hc,response:[{type:"Property",name:"info",reflectMapper:{1:"type",2:"deleteVersion",3:"conversationIds"}},{type:"Property",name:"data",reflectMapper:mn(gc)}]}};class V2NIMConversationGroupServiceImpl extends V2Service{constructor(t,o={}){super("V2NIMConversationGroupService",t),this.config={},"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:mc,cmdConfig:_c}),this.setOptions(o))}setOptions(t){this.config=Object.assign(this.config,t)}createConversationGroup(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({name:{type:"string",allowEmpty:!1}},{name:t},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:o},"",!0),validate({conversationIds:{type:"array",itemType:"string",required:!1}},{conversationIds:a},"",!0);var c=yield this.core.sendCmd("v2ConversationGroupCreate",{tag:{name:t,serverExtension:o||"",conversationIds:a&&JSON.stringify(a)}}),m=formatConversationGroup(Ue(c,"content.data")),h=formatConversationFields(this.core,Ue(c,"content.conversations")),g=formatFailedMap(Ue(c,"content.info.failedMap"));return this.emit("onConversationGroupCreated",m),h.length>0&&(this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(h),this.emit("onConversationsAddedToGroup",m.groupId,h.map((t=>this.core.V2NIMConversationService.model.getById(t.conversationId))).filter((t=>!!t)))),{group:m,failedList:g}}))}deleteConversationGroup(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:t},"",!0);var o=yield this.core.sendCmd("v2ConversationGroupDelete",{tag:{groupId:t}}),a=formatConversationGroupNotify(Ue(o,"content.info"));this.core.V2NIMConversationService.versionCache.compareAndDeleteGroupInModel(a.deleteVersion,t),this.emit("onConversationGroupDeleted",t)}))}updateConversationGroup(t,o,a){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:t},"",!0),validate({name:{type:"string",required:!1}},{name:o},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:a},"",!0),void 0===o&&void 0===a)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER});var c=yield this.core.sendCmd("v2ConversationGroupUpdate",{tag:{groupId:t,name:o,serverExtension:a}}),m=formatConversationGroup(Ue(c,"content.data"));this.emit("onConversationGroupChanged",m)}))}addConversationsToGroup(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:t},"",!0),validate({conversationIds:{type:"array",itemType:"string",min:1,allowEmpty:!1}},{conversationIds:o},"",!0);var a=yield this.core.sendCmd("v2ConversationGroupAddTo",{tag:{groupId:t,conversationIds:JSON.stringify(o)}}),c=Ue(a,"content.info.failedMap")||"",m=[];c&&(m=formatFailedMap(c));var h=formatConversationFields(this.core,Ue(a,"content.datas"));this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(h);var g=h.map((t=>this.core.V2NIMConversationService.model.getById(t.conversationId))).filter((t=>!!t));return g.length>0&&this.emit("onConversationsAddedToGroup",t,g),m}))}removeConversationsFromGroup(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:t},"",!0),validate({conversationIds:{type:"array",itemType:"string",min:1,allowEmpty:!1}},{conversationIds:o},"",!0);var a=yield this.core.sendCmd("v2ConversationGroupRemoveFrom",{tag:{groupId:t,conversationIds:JSON.stringify(o)}}),c=Ue(a,"content.info.failedMap")||"",m=[];c&&(m=formatFailedMap(c));var h=formatConversationFields(this.core,Ue(a,"content.datas"));return this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(h),this.emit("onConversationsRemovedFromGroup",t,h.map((t=>t.conversationId))),m}))}getConversationGroup(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:t},"",!0);var o=yield this.core.sendCmd("v2ConversationGroupGet",{tag:{groupId:t}});return formatConversationGroup(Ue(o,"content.data"))}))}getConversationGroupList(){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var t=yield this.core.sendCmd("v2ConversationGroupListGet");return formatConversationGroups(Ue(t,"content.datas"))}))}getConversationGroupListByIds(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupIds:{type:"array",itemType:"string",min:1}},{groupIds:t},"",!0);var o=yield this.core.sendCmd("v2ConversationGroupsGet",{tag:{groupIds:t&&JSON.stringify(t)}}),a=formatConversationGroups(Ue(o,"content.datas"));return t.map((t=>a.filter((o=>o.groupId===t))[0])).filter((t=>!!t))}))}v2ConversationGroupNotifySyncOnlineHandler(t){var o=formatConversationGroupNotify(Ue(t,"content.info")),{type:a,deleteVersion:c,conversationIds:m}=o,h=formatConversationGroup(Ue(t,"content.data"));if(this.core.logger.log("v2ConversationGroupNotifySyncOnlineHandler",o,h),a===ps.createConversationGroup)this.emit("onConversationGroupCreated",h),m&&m.length>0&&this.emit("onConversationsAddedToGroup",h.groupId,m.map((t=>this.core.V2NIMConversationService.model.getById(t))).filter((t=>!!t)));else if(a===ps.deleteConversationGroup)this.emit("onConversationGroupDeleted",h.groupId),this.core.V2NIMConversationService.versionCache.compareAndDeleteGroupInModel(c,h.groupId);else if(a===ps.updateConversationGroup)this.emit("onConversationGroupChanged",h);else if(a===ps.addConversationToGroup){var g=m.map((t=>this.core.V2NIMConversationService.model.getById(t))).filter((t=>!!t));this.emit("onConversationsAddedToGroup",h.groupId,g)}else a===ps.removeConversationFromGroup&&this.emit("onConversationsRemovedFromGroup",h.groupId,m)}}var vc={muteMode:{type:"enum",values:getEnumValues(mt)}},Ic={accountId:{type:"string",required:!0,allowEmpty:!1},muteMode:{type:"enum",required:!0,values:getEnumValues(ht)}},Ec={type:"object",required:!1,rules:{certificateName:{type:"string",required:!0,allowEmpty:!1},appId:{type:"string",required:!1,allowEmpty:!1},appKey:{type:"string",required:!1,allowEmpty:!1},secret:{type:"string",required:!1,allowEmpty:!1}}},fc={config:{type:"object",required:!0,rules:{apns:Ec,hwPush:Ec,miPush:Ec,vivoPush:Ec,oppoPush:Ec,honorPush:Ec,fcmPush:Ec,mzPush:Ec}}},Tc={"34_1":"v2SetDeviceToken","34_2":"v2SetAppBackground","34_15":"v2SetPushMobileOnDesktopOnline"},Mc={v2SetDeviceToken:{sid:34,cid:1,service:"V2NIMSettingService",params:[{type:"String",name:"certificateName"},{type:"String",name:"pushDeviceToken"},{type:"Int",name:"pushkit"}]},v2SetAppBackground:{sid:34,cid:2,service:"V2NIMSettingService",params:[{type:"Bool",name:"isBackground"},{type:"Int",name:"badge"}]},v2SetPushMobileOnDesktopOnline:{sid:34,cid:15,service:"V2NIMSettingService",params:[{type:"Property",name:"tag",reflectMapper:{need:{id:1,converter:t=>t?2:1}}}]}},yc=yc||function(t){var o;"undefined"!=typeof window&&window.crypto&&(o=window.crypto),"undefined"!=typeof self&&self.crypto&&(o=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(o=globalThis.crypto),!o&&"undefined"!=typeof window&&window.msCrypto&&(o=window.msCrypto),!o&&"undefined"!=typeof global&&global.crypto&&(o=global.crypto);var cryptoSecureRandomInt=function(){if(o){if("function"==typeof o.getRandomValues)try{return o.getRandomValues(new Uint32Array(1))[0]}catch(t){}if("function"==typeof o.randomBytes)try{return o.randomBytes(4).readInt32LE()}catch(t){}}throw new Error("Native crypto module could not be used to get secure random number.")},a=Object.create||function(){function F(){}return function(t){var o;return F.prototype=t,o=new F,F.prototype=null,o}}(),c={},m=c.lib={},h=m.Base={extend:function(t){var o=a(this);return t&&o.mixIn(t),o.hasOwnProperty("init")&&this.init!==o.init||(o.init=function(){o.$super.init.apply(this,arguments)}),o.init.prototype=o,o.$super=this,o},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var o in t)t.hasOwnProperty(o)&&(this[o]=t[o]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},g=m.WordArray=h.extend({init:function(t,o){t=this.words=t||[],this.sigBytes=null!=o?o:4*t.length},toString:function(t){return(t||I).stringify(this)},concat:function(t){var o=this.words,a=t.words,c=this.sigBytes,m=t.sigBytes;if(this.clamp(),c%4)for(var h=0;h<m;h++){var g=a[h>>>2]>>>24-h%4*8&255;o[c+h>>>2]|=g<<24-(c+h)%4*8}else for(var _=0;_<m;_+=4)o[c+_>>>2]=a[_>>>2];return this.sigBytes+=m,this},clamp:function(){var o=this.words,a=this.sigBytes;o[a>>>2]&=4294967295<<32-a%4*8,o.length=t.ceil(a/4)},clone:function(){var t=h.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var o=[],a=0;a<t;a+=4)o.push(cryptoSecureRandomInt());return new g.init(o,t)}}),_=c.enc={},I=_.Hex={stringify:function(t){for(var o=t.words,a=t.sigBytes,c=[],m=0;m<a;m++){var h=o[m>>>2]>>>24-m%4*8&255;c.push((h>>>4).toString(16)),c.push((15&h).toString(16))}return c.join("")},parse:function(t){for(var o=t.length,a=[],c=0;c<o;c+=2)a[c>>>3]|=parseInt(t.substr(c,2),16)<<24-c%8*4;return new g.init(a,o/2)}},E=_.Latin1={stringify:function(t){for(var o=t.words,a=t.sigBytes,c=[],m=0;m<a;m++){var h=o[m>>>2]>>>24-m%4*8&255;c.push(String.fromCharCode(h))}return c.join("")},parse:function(t){for(var o=t.length,a=[],c=0;c<o;c++)a[c>>>2]|=(255&t.charCodeAt(c))<<24-c%4*8;return new g.init(a,o)}},T=_.Utf8={stringify:function(t){try{return decodeURIComponent(escape(E.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return E.parse(unescape(encodeURIComponent(t)))}},M=m.BufferedBlockAlgorithm=h.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=T.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(o){var a,c=this._data,m=c.words,h=c.sigBytes,_=this.blockSize,I=h/(4*_),E=(I=o?t.ceil(I):t.max((0|I)-this._minBufferSize,0))*_,T=t.min(4*E,h);if(E){for(var M=0;M<E;M+=_)this._doProcessBlock(m,M);a=m.splice(0,E),c.sigBytes-=T}return new g.init(a,T)},clone:function(){var t=h.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});m.Hasher=M.extend({cfg:h.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){M.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(o,a){return new t.init(a).finalize(o)}},_createHmacHelper:function(t){return function(o,a){return new S.HMAC.init(t,a).finalize(o)}}});var S=c.algo={};return c}(Math),Sc=yc.enc.Utf8,Nc=yc,Cc=Nc.lib,Ac=Cc.WordArray,Oc=Cc.Hasher,Rc=Nc.algo,bc=[],Vc=Rc.SHA1=Oc.extend({_doReset:function(){this._hash=new Ac.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,o){for(var a=this._hash.words,c=a[0],m=a[1],h=a[2],g=a[3],_=a[4],I=0;I<80;I++){if(I<16)bc[I]=0|t[o+I];else{var E=bc[I-3]^bc[I-8]^bc[I-14]^bc[I-16];bc[I]=E<<1|E>>>31}var T=(c<<5|c>>>27)+_+bc[I];T+=I<20?1518500249+(m&h|~m&g):I<40?1859775393+(m^h^g):I<60?(m&h|m&g|h&g)-1894007588:(m^h^g)-899497514,_=g,g=h,h=m<<30|m>>>2,m=c,c=T}a[0]=a[0]+c|0,a[1]=a[1]+m|0,a[2]=a[2]+h|0,a[3]=a[3]+g|0,a[4]=a[4]+_|0},_doFinalize:function(){var t=this._data,o=t.words,a=8*this._nDataBytes,c=8*t.sigBytes;return o[c>>>5]|=128<<24-c%32,o[14+(c+64>>>9<<4)]=Math.floor(a/4294967296),o[15+(c+64>>>9<<4)]=a,t.sigBytes=4*o.length,this._process(),this._hash},clone:function(){var t=Oc.clone.call(this);return t._hash=this._hash.clone(),t}});Nc.SHA1=Oc._createHelper(Vc),Nc.HmacSHA1=Oc._createHmacHelper(Vc),yc.SHA1,function(t){var o=t,a=o.lib.Base,c=o.enc.Utf8;o.algo.HMAC=a.extend({init:function(t,o){t=this._hasher=new t.init,"string"==typeof o&&(o=c.parse(o));var a=t.blockSize,m=4*a;o.sigBytes>m&&(o=t.finalize(o)),o.clamp();for(var h=this._oKey=o.clone(),g=this._iKey=o.clone(),_=h.words,I=g.words,E=0;E<a;E++)_[E]^=1549556828,I[E]^=909522486;h.sigBytes=g.sigBytes=m,this.reset()},reset:function(){var t=this._hasher;t.reset(),t.update(this._iKey)},update:function(t){return this._hasher.update(t),this},finalize:function(t){var o=this._hasher,a=o.finalize(t);return o.reset(),o.finalize(this._oKey.clone().concat(a))}})}(yc);var Pc=yc,kc=Pc.lib,Lc=kc.Base,Dc=kc.WordArray,wc=Pc.algo,Uc=wc.MD5,xc=wc.EvpKDF=Lc.extend({cfg:Lc.extend({keySize:4,hasher:Uc,iterations:1}),init:function(t){this.cfg=this.cfg.extend(t)},compute:function(t,o){for(var a,c=this.cfg,m=c.hasher.create(),h=Dc.create(),g=h.words,_=c.keySize,I=c.iterations;g.length<_;){a&&m.update(a),a=m.update(t).finalize(o),m.reset();for(var E=1;E<I;E++)a=m.finalize(a),m.reset();h.concat(a)}return h.sigBytes=4*_,h}});Pc.EvpKDF=function(t,o,a){return xc.create(a).compute(t,o)},yc.EvpKDF;var Fc=yc,Gc=Fc.lib.WordArray;Fc.enc.Base64={stringify:function(t){var o=t.words,a=t.sigBytes,c=this._map;t.clamp();for(var m=[],h=0;h<a;h+=3)for(var g=(o[h>>>2]>>>24-h%4*8&255)<<16|(o[h+1>>>2]>>>24-(h+1)%4*8&255)<<8|o[h+2>>>2]>>>24-(h+2)%4*8&255,_=0;_<4&&h+.75*_<a;_++)m.push(c.charAt(g>>>6*(3-_)&63));var I=c.charAt(64);if(I)for(;m.length%4;)m.push(I);return m.join("")},parse:function(t){var o=t.length,a=this._map,c=this._reverseMap;if(!c){c=this._reverseMap=[];for(var m=0;m<a.length;m++)c[a.charCodeAt(m)]=m}var h=a.charAt(64);if(h){var g=t.indexOf(h);-1!==g&&(o=g)}return function parseLoop(t,o,a){for(var c=[],m=0,h=0;h<o;h++)if(h%4){var g=a[t.charCodeAt(h-1)]<<h%4*2|a[t.charCodeAt(h)]>>>6-h%4*2;c[m>>>2]|=g<<24-m%4*8,m++}return Gc.create(c,m)}(t,o,c)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},yc.enc.Base64;var Bc=yc,jc=Bc.lib,Yc=jc.WordArray,Hc=jc.Hasher,$c=Bc.algo,qc=[];!function(){for(var t=0;t<64;t++)qc[t]=4294967296*Math.abs(Math.sin(t+1))|0}();var zc=$c.MD5=Hc.extend({_doReset:function(){this._hash=new Yc.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(t,o){for(var a=0;a<16;a++){var c=o+a,m=t[c];t[c]=16711935&(m<<8|m>>>24)|4278255360&(m<<24|m>>>8)}var h=this._hash.words,g=t[o+0],_=t[o+1],I=t[o+2],E=t[o+3],T=t[o+4],M=t[o+5],S=t[o+6],N=t[o+7],C=t[o+8],A=t[o+9],O=t[o+10],R=t[o+11],b=t[o+12],V=t[o+13],P=t[o+14],k=t[o+15],L=h[0],D=h[1],w=h[2],U=h[3];L=FF(L,D,w,U,g,7,qc[0]),U=FF(U,L,D,w,_,12,qc[1]),w=FF(w,U,L,D,I,17,qc[2]),D=FF(D,w,U,L,E,22,qc[3]),L=FF(L,D,w,U,T,7,qc[4]),U=FF(U,L,D,w,M,12,qc[5]),w=FF(w,U,L,D,S,17,qc[6]),D=FF(D,w,U,L,N,22,qc[7]),L=FF(L,D,w,U,C,7,qc[8]),U=FF(U,L,D,w,A,12,qc[9]),w=FF(w,U,L,D,O,17,qc[10]),D=FF(D,w,U,L,R,22,qc[11]),L=FF(L,D,w,U,b,7,qc[12]),U=FF(U,L,D,w,V,12,qc[13]),w=FF(w,U,L,D,P,17,qc[14]),L=GG(L,D=FF(D,w,U,L,k,22,qc[15]),w,U,_,5,qc[16]),U=GG(U,L,D,w,S,9,qc[17]),w=GG(w,U,L,D,R,14,qc[18]),D=GG(D,w,U,L,g,20,qc[19]),L=GG(L,D,w,U,M,5,qc[20]),U=GG(U,L,D,w,O,9,qc[21]),w=GG(w,U,L,D,k,14,qc[22]),D=GG(D,w,U,L,T,20,qc[23]),L=GG(L,D,w,U,A,5,qc[24]),U=GG(U,L,D,w,P,9,qc[25]),w=GG(w,U,L,D,E,14,qc[26]),D=GG(D,w,U,L,C,20,qc[27]),L=GG(L,D,w,U,V,5,qc[28]),U=GG(U,L,D,w,I,9,qc[29]),w=GG(w,U,L,D,N,14,qc[30]),L=HH(L,D=GG(D,w,U,L,b,20,qc[31]),w,U,M,4,qc[32]),U=HH(U,L,D,w,C,11,qc[33]),w=HH(w,U,L,D,R,16,qc[34]),D=HH(D,w,U,L,P,23,qc[35]),L=HH(L,D,w,U,_,4,qc[36]),U=HH(U,L,D,w,T,11,qc[37]),w=HH(w,U,L,D,N,16,qc[38]),D=HH(D,w,U,L,O,23,qc[39]),L=HH(L,D,w,U,V,4,qc[40]),U=HH(U,L,D,w,g,11,qc[41]),w=HH(w,U,L,D,E,16,qc[42]),D=HH(D,w,U,L,S,23,qc[43]),L=HH(L,D,w,U,A,4,qc[44]),U=HH(U,L,D,w,b,11,qc[45]),w=HH(w,U,L,D,k,16,qc[46]),L=II(L,D=HH(D,w,U,L,I,23,qc[47]),w,U,g,6,qc[48]),U=II(U,L,D,w,N,10,qc[49]),w=II(w,U,L,D,P,15,qc[50]),D=II(D,w,U,L,M,21,qc[51]),L=II(L,D,w,U,b,6,qc[52]),U=II(U,L,D,w,E,10,qc[53]),w=II(w,U,L,D,O,15,qc[54]),D=II(D,w,U,L,_,21,qc[55]),L=II(L,D,w,U,C,6,qc[56]),U=II(U,L,D,w,k,10,qc[57]),w=II(w,U,L,D,S,15,qc[58]),D=II(D,w,U,L,V,21,qc[59]),L=II(L,D,w,U,T,6,qc[60]),U=II(U,L,D,w,R,10,qc[61]),w=II(w,U,L,D,I,15,qc[62]),D=II(D,w,U,L,A,21,qc[63]),h[0]=h[0]+L|0,h[1]=h[1]+D|0,h[2]=h[2]+w|0,h[3]=h[3]+U|0},_doFinalize:function(){var t=this._data,o=t.words,a=8*this._nDataBytes,c=8*t.sigBytes;o[c>>>5]|=128<<24-c%32;var m=Math.floor(a/4294967296),h=a;o[15+(c+64>>>9<<4)]=16711935&(m<<8|m>>>24)|4278255360&(m<<24|m>>>8),o[14+(c+64>>>9<<4)]=16711935&(h<<8|h>>>24)|4278255360&(h<<24|h>>>8),t.sigBytes=4*(o.length+1),this._process();for(var g=this._hash,_=g.words,I=0;I<4;I++){var E=_[I];_[I]=16711935&(E<<8|E>>>24)|4278255360&(E<<24|E>>>8)}return g},clone:function(){var t=Hc.clone.call(this);return t._hash=this._hash.clone(),t}});function FF(t,o,a,c,m,h,g){var _=t+(o&a|~o&c)+m+g;return(_<<h|_>>>32-h)+o}function GG(t,o,a,c,m,h,g){var _=t+(o&c|a&~c)+m+g;return(_<<h|_>>>32-h)+o}function HH(t,o,a,c,m,h,g){var _=t+(o^a^c)+m+g;return(_<<h|_>>>32-h)+o}function II(t,o,a,c,m,h,g){var _=t+(a^(o|~c))+m+g;return(_<<h|_>>>32-h)+o}Bc.MD5=Hc._createHelper(zc),Bc.HmacMD5=Hc._createHmacHelper(zc),yc.MD5,function(t){t.lib.Cipher||function(){var o=t,a=o.lib,c=a.Base,m=a.WordArray,h=a.BufferedBlockAlgorithm,g=o.enc;g.Utf8;var _=g.Base64,I=o.algo.EvpKDF,E=a.Cipher=h.extend({cfg:c.extend(),createEncryptor:function(t,o){return this.create(this._ENC_XFORM_MODE,t,o)},createDecryptor:function(t,o){return this.create(this._DEC_XFORM_MODE,t,o)},init:function(t,o,a){this.cfg=this.cfg.extend(a),this._xformMode=t,this._key=o,this.reset()},reset:function(){h.reset.call(this),this._doReset()},process:function(t){return this._append(t),this._process()},finalize:function(t){return t&&this._append(t),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function selectCipherStrategy(t){return"string"==typeof t?b:O}return function(t){return{encrypt:function(o,a,c){return selectCipherStrategy(a).encrypt(t,o,a,c)},decrypt:function(o,a,c){return selectCipherStrategy(a).decrypt(t,o,a,c)}}}}()});a.StreamCipher=E.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var T=o.mode={},M=a.BlockCipherMode=c.extend({createEncryptor:function(t,o){return this.Encryptor.create(t,o)},createDecryptor:function(t,o){return this.Decryptor.create(t,o)},init:function(t,o){this._cipher=t,this._iv=o}}),S=T.CBC=function(){var t=M.extend();function xorBlock(t,o,a){var c,m=this._iv;m?(c=m,this._iv=void 0):c=this._prevBlock;for(var h=0;h<a;h++)t[o+h]^=c[h]}return t.Encryptor=t.extend({processBlock:function(t,o){var a=this._cipher,c=a.blockSize;xorBlock.call(this,t,o,c),a.encryptBlock(t,o),this._prevBlock=t.slice(o,o+c)}}),t.Decryptor=t.extend({processBlock:function(t,o){var a=this._cipher,c=a.blockSize,m=t.slice(o,o+c);a.decryptBlock(t,o),xorBlock.call(this,t,o,c),this._prevBlock=m}}),t}(),N=(o.pad={}).Pkcs7={pad:function(t,o){for(var a=4*o,c=a-t.sigBytes%a,h=c<<24|c<<16|c<<8|c,g=[],_=0;_<c;_+=4)g.push(h);var I=m.create(g,c);t.concat(I)},unpad:function(t){var o=255&t.words[t.sigBytes-1>>>2];t.sigBytes-=o}};a.BlockCipher=E.extend({cfg:E.cfg.extend({mode:S,padding:N}),reset:function(){var t;E.reset.call(this);var o=this.cfg,a=o.iv,c=o.mode;this._xformMode==this._ENC_XFORM_MODE?t=c.createEncryptor:(t=c.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==t?this._mode.init(this,a&&a.words):(this._mode=t.call(c,this,a&&a.words),this._mode.__creator=t)},_doProcessBlock:function(t,o){this._mode.processBlock(t,o)},_doFinalize:function(){var t,o=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(o.pad(this._data,this.blockSize),t=this._process(!0)):(t=this._process(!0),o.unpad(t)),t},blockSize:4});var C=a.CipherParams=c.extend({init:function(t){this.mixIn(t)},toString:function(t){return(t||this.formatter).stringify(this)}}),A=(o.format={}).OpenSSL={stringify:function(t){var o=t.ciphertext,a=t.salt;return(a?m.create([1398893684,1701076831]).concat(a).concat(o):o).toString(_)},parse:function(t){var o,a=_.parse(t),c=a.words;return 1398893684==c[0]&&1701076831==c[1]&&(o=m.create(c.slice(2,4)),c.splice(0,4),a.sigBytes-=16),C.create({ciphertext:a,salt:o})}},O=a.SerializableCipher=c.extend({cfg:c.extend({format:A}),encrypt:function(t,o,a,c){c=this.cfg.extend(c);var m=t.createEncryptor(a,c),h=m.finalize(o),g=m.cfg;return C.create({ciphertext:h,key:a,iv:g.iv,algorithm:t,mode:g.mode,padding:g.padding,blockSize:t.blockSize,formatter:c.format})},decrypt:function(t,o,a,c){return c=this.cfg.extend(c),o=this._parse(o,c.format),t.createDecryptor(a,c).finalize(o.ciphertext)},_parse:function(t,o){return"string"==typeof t?o.parse(t,this):t}}),R=(o.kdf={}).OpenSSL={execute:function(t,o,a,c){c||(c=m.random(8));var h=I.create({keySize:o+a}).compute(t,c),g=m.create(h.words.slice(o),4*a);return h.sigBytes=4*o,C.create({key:h,iv:g,salt:c})}},b=a.PasswordBasedCipher=O.extend({cfg:O.cfg.extend({kdf:R}),encrypt:function(t,o,a,c){var m=(c=this.cfg.extend(c)).kdf.execute(a,t.keySize,t.ivSize);c.iv=m.iv;var h=O.encrypt.call(this,t,o,m.key,c);return h.mixIn(m),h},decrypt:function(t,o,a,c){c=this.cfg.extend(c),o=this._parse(o,c.format);var m=c.kdf.execute(a,t.keySize,t.ivSize,o.salt);return c.iv=m.iv,O.decrypt.call(this,t,o,m.key,c)}})}()}(yc);var Kc=yc,Wc=Kc.lib.StreamCipher,Jc=Kc.algo,Xc=Jc.RC4=Wc.extend({_doReset:function(){for(var t=this._key,o=t.words,a=t.sigBytes,c=this._S=[],m=0;m<256;m++)c[m]=m;m=0;for(var h=0;m<256;m++){var g=m%a,_=o[g>>>2]>>>24-g%4*8&255;h=(h+c[m]+_)%256;var I=c[m];c[m]=c[h],c[h]=I}this._i=this._j=0},_doProcessBlock:function(t,o){t[o]^=generateKeystreamWord.call(this)},keySize:8,ivSize:0});function generateKeystreamWord(){for(var t=this._S,o=this._i,a=this._j,c=0,m=0;m<4;m++){a=(a+t[o=(o+1)%256])%256;var h=t[o];t[o]=t[a],t[a]=h,c|=t[(t[o]+t[a])%256]<<24-8*m}return this._i=o,this._j=a,c}Kc.RC4=Wc._createHelper(Xc);var Qc=Jc.RC4Drop=Xc.extend({cfg:Xc.cfg.extend({drop:192}),_doReset:function(){Xc._doReset.call(this);for(var t=this.cfg.drop;t>0;t--)generateKeystreamWord.call(this)}});Kc.RC4Drop=Wc._createHelper(Qc);var Zc=yc.RC4;class V2NIMSettingServiceImpl extends V2Service{constructor(t){super("V2NIMSettingService",t),this.offlinePushPlugin=void 0,this.offlinePushConfig=void 0,this.appBackgroundOptions={badge:0,isBackground:!1},this.p2pMessageMuteModeChangeHandler=(t,o)=>{this.emit("onP2PMessageMuteModeChanged",t,o),this.core.V2NIMUserService.model.setAccountMuteMode(t,o);var a=this.core.V2NIMConversationIdUtil.p2pConversationId(t),c=o===ht.V2NIM_P2P_MESSAGE_MUTE_MODE_ON;this.core.eventBus.emit("V2NIMConversationService/setMute",a,c)},this.setTokenAndBackgroundStateAfterLogin=t=>{this.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin"),this.offlinePushPlugin&&(this.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin plugin is provided"),this.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin pushType is: ",t&&t.pushType),this.regToken(t),this.core.sendCmd("v2SetAppBackground",{isBackground:this.appBackgroundOptions.isBackground,badge:this.appBackgroundOptions.badge||0}))},"v2"===this.core.options.apiVersion&&(this.setListener(),registerParser({cmdMap:Tc,cmdConfig:Mc}))}setListener(){this.core.eventBus.on("V2NIMSettingService/updateBits",((t,o,a)=>{this.emit("onTeamMessageMuteModeChanged",t,o,a)})),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",this.setTokenAndBackgroundStateAfterLogin),this.core.eventBus.on("v2NIMUserService/updateMuteList",this.p2pMessageMuteModeChangeHandler),this.core.eventBus.on("forwardReceive/v2NIMSettingService/setP2PMessageMuteMode",this.p2pMessageMuteModeChangeHandler)}getConversationMuteStatus(t){if("string"!=typeof t)return!1;var o=this.core.V2NIMConversationIdUtil.parseConversationType(t),a=this.core.V2NIMConversationIdUtil.parseConversationTargetId(t);return o===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?this.getTeamMessageMuteMode(a,_t.V2NIM_TEAM_TYPE_SUPER)!==mt.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF:o===Be.V2NIM_CONVERSATION_TYPE_TEAM?this.getTeamMessageMuteMode(a,_t.V2NIM_TEAM_TYPE_ADVANCED)!==mt.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF:o===Be.V2NIM_CONVERSATION_TYPE_P2P&&!!this.core.V2NIMUserService.model.muteList.has(a)}setTeamMessageMuteMode(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate(vc,{muteMode:a},"",!0);var c=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamUpdateSelfMemberInfo":"v2TeamUpdateSelfMemberInfo",m={teamId:t,teamType:o,accountId:this.core.account,bits:a};yield this.core.sendCmd(c,{teamMember:m}),this.core.V2NIMTeamService.memberModel.upsert(m),this.emit("onTeamMessageMuteModeChanged",t,o,a);var h=o===_t.V2NIM_TEAM_TYPE_ADVANCED?this.core.V2NIMConversationIdUtil.teamConversationId(t):this.core.V2NIMConversationIdUtil.superTeamConversationId(t),g=this.core.V2NIMSettingService.getConversationMuteStatus(h);this.core.eventBus.emit("V2NIMConversationService/setMute",h,g)}))}getTeamMessageMuteMode(t,o){var a;return"string"!=typeof t||"number"!=typeof o?0:3&((null===(a=this.core.V2NIMTeamService.memberModel.getById(t,o,this.core.account))||void 0===a?void 0:a.bits)||0)}setP2PMessageMuteMode(t,o){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Ic,{accountId:t,muteMode:o},"",!0),t===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"can not set mute mode for self"}});yield this.core.sendCmd("v2SetP2PMessageMuteMode",{accountId:t,muteMode:o===ht.V2NIM_P2P_MESSAGE_MUTE_MODE_ON}),this.p2pMessageMuteModeChangeHandler(t,o)}))}getP2PMessageMuteMode(t){return validate({accountId:{type:"string",required:!0,allowEmpty:!1}},{accountId:t},"",!0),this.core.V2NIMUserService.model.muteList.has(t)?ht.V2NIM_P2P_MESSAGE_MUTE_MODE_ON:ht.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF}getP2PMessageMuteList(){return __awaiter(this,void 0,void 0,(function*(){return Promise.resolve(Array.from(this.core.V2NIMUserService.model.muteList))}))}setAppBackground(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({isBackground:{type:"boolean"},badge:{type:"number",required:!1}},{isBackground:t,badge:o},"",!0),this.appBackgroundOptions={isBackground:t,badge:o||0},yield this.core.sendCmd("v2SetAppBackground",{isBackground:t,badge:o||0})}))}setPushMobileOnDesktopOnline(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({need:{type:"boolean",required:!1}},{need:t},"",!0),t=void 0===t||t,yield this.core.sendCmd("v2SetPushMobileOnDesktopOnline",{tag:{need:t}})}))}setOfflinePushConfig(t,o){validate(fc,{config:o},"",!0),this.offlinePushPlugin=t,this.offlinePushConfig=o}regToken(t){var o,a,c,m,h,g,_,I,E,T,M,S,N,C,A,O,R,b,V,P,k,L,D,w,U,x,G,B,j,Y,H,$,q,z,K,W,J=ai.getSystemInfo()||{},X=J.os?J.os.toLowerCase():"";if(this.logger.log("OfflinePushService: os",X),"ios"===X||"android"===X)if(this.offlinePushPlugin&&"function"==typeof this.offlinePushPlugin.getDeviceToken){var Q="";t&&t.pushType?Q=t.pushType:"ios"===X?Q="":"android"===X&&(Q="8"),this.logger.log("OfflinePushService:: prepare to get device token. suggestPushType: "+Q);var Z={xmAppId:null===(a=null===(o=this.offlinePushConfig)||void 0===o?void 0:o.miPush)||void 0===a?void 0:a.appId,xmAppKey:null===(m=null===(c=this.offlinePushConfig)||void 0===c?void 0:c.miPush)||void 0===m?void 0:m.appKey,xmCertificateName:null===(g=null===(h=this.offlinePushConfig)||void 0===h?void 0:h.miPush)||void 0===g?void 0:g.certificateName,hwAppId:null===(I=null===(_=this.offlinePushConfig)||void 0===_?void 0:_.hwPush)||void 0===I?void 0:I.appId,hwCertificateName:null===(T=null===(E=this.offlinePushConfig)||void 0===E?void 0:E.hwPush)||void 0===T?void 0:T.certificateName,oppoAppId:null===(S=null===(M=this.offlinePushConfig)||void 0===M?void 0:M.oppoPush)||void 0===S?void 0:S.appId,oppoAppKey:null===(C=null===(N=this.offlinePushConfig)||void 0===N?void 0:N.oppoPush)||void 0===C?void 0:C.appKey,oppoAppSecret:null===(O=null===(A=this.offlinePushConfig)||void 0===A?void 0:A.oppoPush)||void 0===O?void 0:O.secret,oppoCertificateName:null===(b=null===(R=this.offlinePushConfig)||void 0===R?void 0:R.oppoPush)||void 0===b?void 0:b.certificateName,vivoAppId:null===(P=null===(V=this.offlinePushConfig)||void 0===V?void 0:V.vivoPush)||void 0===P?void 0:P.appId,vivoAppKey:null===(L=null===(k=this.offlinePushConfig)||void 0===k?void 0:k.vivoPush)||void 0===L?void 0:L.appKey,vivoCertificateName:null===(w=null===(D=this.offlinePushConfig)||void 0===D?void 0:D.vivoPush)||void 0===w?void 0:w.certificateName,fcmCertificateName:null===(x=null===(U=this.offlinePushConfig)||void 0===U?void 0:U.fcmPush)||void 0===x?void 0:x.certificateName,mzAppId:null===(B=null===(G=this.offlinePushConfig)||void 0===G?void 0:G.mzPush)||void 0===B?void 0:B.appId,mzAppKey:null===(Y=null===(j=this.offlinePushConfig)||void 0===j?void 0:j.mzPush)||void 0===Y?void 0:Y.appKey,mzCertificateName:null===($=null===(H=this.offlinePushConfig)||void 0===H?void 0:H.mzPush)||void 0===$?void 0:$.certificateName,apnsCertificateName:null===(z=null===(q=this.offlinePushConfig)||void 0===q?void 0:q.apns)||void 0===z?void 0:z.certificateName,honorCertificateName:null===(W=null===(K=this.offlinePushConfig)||void 0===K?void 0:K.honorPush)||void 0===W?void 0:W.certificateName};this.logger.log("OfflinePushService push config",JSON.stringify(Z,null,2)),this.offlinePushPlugin.getDeviceToken({suggestPushType:Q,config:Z},(t=>{t?(this.logger.log("OfflinePushService:: token is :"+t),this.pushTokenToServer(Q,t)):this.logger.warn("OfflinePushService:: token is empty. Please check your parameters")}))}else this.logger.warn("OfflinePushService: plugin.getDeviceToken is not a function");else this.logger.warn("OfflinePushService: only Android or IOS support offline push")}pushTokenToServer(t,o){var a,c,m,h,g,_,I,E,T="",M=this.offlinePushConfig;switch(t){case"5":T=null===(a=null==M?void 0:M.miPush)||void 0===a?void 0:a.certificateName;break;case"6":T=null===(c=null==M?void 0:M.hwPush)||void 0===c?void 0:c.certificateName;break;case"7":T=null===(m=null==M?void 0:M.mzPush)||void 0===m?void 0:m.certificateName;break;case"8":T=null===(h=null==M?void 0:M.fcmPush)||void 0===h?void 0:h.certificateName;break;case"9":T=null===(g=null==M?void 0:M.vivoPush)||void 0===g?void 0:g.certificateName;break;case"10":T=null===(_=null==M?void 0:M.oppoPush)||void 0===_?void 0:_.certificateName;break;case"11":T=null===(I=null==M?void 0:M.honorPush)||void 0===I?void 0:I.certificateName;break;default:T=null===(E=null==M?void 0:M.apns)||void 0===E?void 0:E.certificateName}if(""===T||void 0===T)this.logger.warn("OfflinePushService:: certificate name is empty for push type: ",t);else try{var S=Sc.parse("557d1e3cafa43e2589a588270c53d56f"),N=Sc.stringify(Zc.decrypt(o,S));this.logger.log("OfflinePushService:: token",N),this.core.sendCmd("v2SetDeviceToken",{certificateName:T,pushDeviceToken:N,pushkit:0})}catch(t){return this.logger.log("OfflinePushService:: decrypt error",t),void this.logger.warn("OfflinePushService:: token before decrypt",o)}}}var ed,td,rd,id,nd,od,sd=Object.assign(Object.assign({scene:0,to:1,from:2,fromClientType:4,fromDeviceId:5,fromNick:6,time:7,type:8,body:9,attach:10,idClient:11,idServer:12,resendFlag:13,userUpdateTime:14,ext:15,needAntiSpam:21,antiSpamContent:22,antiSpamBIZID:23,clientAntispamHitting:24,antiSpamUsingYidun:25,needACK:26,yidunCallbackURL:27,needUpdateSession:28,replyMsgFromAccount:29,replyMsgToAccount:30,replyMsgTime:31,replyMsgIdServer:32,replyMsgIdClient:33,threadMsgFromAccount:34,threadMsgToAccount:35,threadMsgTime:36,threadMsgIdServer:37,threadMsgIdClient:38,isDeleted:39,callbackExt:40,subType:41,yidunAntiCheating:42,envConfig:43,yidunAntiSpamExtension:44,yidunAntiSpamResult:45,__clientExt:{id:46,converter:objectToJSONString,retConverter:stringToJSONObject},needSaveHistory:100,needRoaming:101,needSelfSync:102,isMuted:104,needRouted:105,isInBlackList:106,needOffline:108,isReplyMsg:111,ackSnapshot:112},{pushContent:17,pushPayload:16,forcePushIDsList:18,forcePushContent:19,needForcePush:20,needPush:107,needPushBadge:109,needPushNick:110}),{function:47,topic:48,customContent:49,account:50}),ad={msg:sd,recallMsgTag:Object.assign({time:0,type:1,to:2,from:3,ps:4,attach:5,deletedIdClient:10,deletedIdServer:11,deleteMsgCreatetime:14,opeAccount:16,env:21},{pushContent:8,pushPayload:9,needPush:107,needPushBadge:109,needPushNick:110}),deleteSelfMsgTag:{scene:1,from:2,to:3,idServer:4,idClient:5,deletedMsgCreateTime:6,time:7,ext:8},msgReceiptTag:{to:1,from:2,time:7,idClient:11},broadcastMsg:{id:1,fromAccid:2,time:4,body:5}},cd=invertSerializeMap(ad);cd.msg,cd.msg,cd.msg,cd.msg,cd.msg,cd.msg,cd.msg,cd.msgReceiptTag,cd.msgReceiptTag,cd.msg,cd.msg,cd.broadcastMsg,cd.broadcastMsg,cd.deleteSelfMsgTag,cd.deleteSelfMsgTag,cd.deleteSelfMsgTag,function(t){t[t.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN=0]="V2NIM_MESSAGE_SENDING_STATE_UNKNOWN",t[t.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED=1]="V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED",t[t.V2NIM_MESSAGE_SENDING_STATE_FAILED=2]="V2NIM_MESSAGE_SENDING_STATE_FAILED",t[t.V2NIM_MESSAGE_SENDING_STATE_SENDING=3]="V2NIM_MESSAGE_SENDING_STATE_SENDING"}(ed||(ed={})),function(t){t[t.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN=0]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN",t[t.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS=1]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS",t[t.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED=2]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED",t[t.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING=3]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING"}(td||(td={})),function(t){t[t.V2NIM_MESSAGE_TYPE_INVALID=-1]="V2NIM_MESSAGE_TYPE_INVALID",t[t.V2NIM_MESSAGE_TYPE_TEXT=0]="V2NIM_MESSAGE_TYPE_TEXT",t[t.V2NIM_MESSAGE_TYPE_IMAGE=1]="V2NIM_MESSAGE_TYPE_IMAGE",t[t.V2NIM_MESSAGE_TYPE_AUDIO=2]="V2NIM_MESSAGE_TYPE_AUDIO",t[t.V2NIM_MESSAGE_TYPE_VIDEO=3]="V2NIM_MESSAGE_TYPE_VIDEO",t[t.V2NIM_MESSAGE_TYPE_LOCATION=4]="V2NIM_MESSAGE_TYPE_LOCATION",t[t.V2NIM_MESSAGE_TYPE_NOTIFICATION=5]="V2NIM_MESSAGE_TYPE_NOTIFICATION",t[t.V2NIM_MESSAGE_TYPE_FILE=6]="V2NIM_MESSAGE_TYPE_FILE",t[t.V2NIM_MESSAGE_TYPE_AVCHAT=7]="V2NIM_MESSAGE_TYPE_AVCHAT",t[t.V2NIM_MESSAGE_TYPE_TIPS=10]="V2NIM_MESSAGE_TYPE_TIPS",t[t.V2NIM_MESSAGE_TYPE_ROBOT=11]="V2NIM_MESSAGE_TYPE_ROBOT",t[t.V2NIM_MESSAGE_TYPE_CALL=12]="V2NIM_MESSAGE_TYPE_CALL",t[t.V2NIM_MESSAGE_TYPE_CUSTOM=100]="V2NIM_MESSAGE_TYPE_CUSTOM"}(rd||(rd={})),function(t){t[t.V2NIM_QUERY_DIRECTION_DESC=0]="V2NIM_QUERY_DIRECTION_DESC",t[t.V2NIM_QUERY_DIRECTION_ASC=1]="V2NIM_QUERY_DIRECTION_ASC"}(id||(id={})),function(t){t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_ENTER=0]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_ENTER",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_EXIT=1]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_EXIT",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_BLOCK_ADDED=2]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_BLOCK_ADDED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_BLOCK_REMOVED=3]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_BLOCK_REMOVED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_CHAT_BANNED_ADDED=4]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_CHAT_BANNED_ADDED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_CHAT_BANNED_REMOVED=5]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_CHAT_BANNED_REMOVED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_ROOM_INFO_UPDATED=6]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_ROOM_INFO_UPDATED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_KICKED=7]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_KICKED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_TEMP_CHAT_BANNED_ADDED=8]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_TEMP_CHAT_BANNED_ADDED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_TEMP_CHAT_BANNED_REMOVED=9]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_TEMP_CHAT_BANNED_REMOVED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_INFO_UPDATED=10]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_INFO_UPDATED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_QUEUE_CHANGE=11]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_QUEUE_CHANGE",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_CHAT_BANNED=12]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_CHAT_BANNED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_CHAT_BANNED_REMOVED=13]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_CHAT_BANNED_REMOVED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAG_TEMP_CHAT_BANNED_ADDED=14]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAG_TEMP_CHAT_BANNED_ADDED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAG_TEMP_CHAT_BANNED_REMOVED=15]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAG_TEMP_CHAT_BANNED_REMOVED",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MESSAGE_REVOKE=16]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MESSAGE_REVOKE",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAGS_UPDATE=17]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAGS_UPDATE",t[t.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_ROLE_UPDATE=18]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_ROLE_UPDATE"}(nd||(nd={})),function(t){t[t.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE=0]="V2NIM_CLIENT_ANTISPAM_OPERATE_NONE",t[t.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE=1]="V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE",t[t.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD=2]="V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD",t[t.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD=3]="V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD"}(od||(od={}));var dd=mn({none:0,normal:1,all:3}),ld=mn({normal:0,advanced:1});mn({normal:0,owner:1,manager:2});var pd,ud=mn({noVerify:0,needVerify:1,rejectAll:2}),md=mn({needVerify:0,noVerify:1}),hd=mn({manager:0,all:1}),gd=mn({manager:0,all:1}),_d=mn({manager:0,all:1});!function(t){t[t.unknown=0]="unknown",t[t.male=1]="male",t[t.female=2]="female"}(pd||(pd={}));var vd={team:{teamId:1,name:3,type:4,owner:5,level:6,selfCustom:7,valid:8,memberNum:9,memberUpdateTime:10,createTime:11,updateTime:12,validToCurrentUser:13,intro:14,announcement:15,joinMode:16,bits:17,ext:18,serverExt:19,avatar:20,beInviteMode:21,inviteMode:22,updateTeamMode:23,updateExtMode:24,mute:100,muteType:101},teamMsgReceiptTag:{teamId:0,idServer:1,read:100,unread:101,idClient:102,account:103},teamMember:{teamId:1,account:3,type:4,nickInTeam:5,bits:7,active:8,valid:9,joinTime:10,updateTime:11,ext:12,mute:13,invitorAccid:14}},Id=invertSerializeMap(vd);Id.team,Id.team,Id.team,Id.teamMsgReceiptTag,Id.teamMsgReceiptTag,Id.teamMsgReceiptTag,Id.teamMsgReceiptTag,Id.team,Id.teamMember,Id.teamMember,Id.team,Id.team,Id.team,Id.teamMember,Id.teamMember;var Ed={user:{account:1,nick:3,avatar:4,signature:5,gender:6,email:7,birth:8,tel:9,ext:10,createTime:12,updateTime:13},relationMember:{account:0,isMuted:1,isBlack:2,createTime:3,updateTime:4}},fd=invertSerializeMap(Ed);fd.user,fd.relationMember,fd.user,fd.user;var Td={subType:{type:"string"},setting:{resendFlag:{type:"boolean"},envConfig:{type:"string"},needSaveHistory:{type:"boolean"},needRoaming:{type:"boolean"},needOffline:{type:"boolean"},needSelfSync:{type:"boolean"},needRouted:{type:"boolean"},needUpdateSession:{type:"boolean"},isMuted:{type:"boolean"}},antiSpamInfo:{needAntiSpam:{type:"boolean"},antiSpamContent:{type:"string"},antiSpamBIZID:{type:"string"},clientAntispamHitting:{type:"boolean"},antiSpamUsingYidun:{type:"boolean"},yidunCallbackURL:{type:"string"},yidunAntiCheating:{type:"string"},yidunAntiSpamExtension:{type:"string"},yidunAntiSpamResult:{type:"string"}},pushInfo:{needPush:{type:"boolean",required:!1},needPushBadge:{type:"boolean",required:!1},needPushNick:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},needForcePush:{type:"boolean",required:!1},forcePushIDsList:{type:"string",allowEmpty:!1,required:!1},forcePushContent:{type:"string",allowEmpty:!1,required:!1}},robotInfo:{function:{type:"string",required:!1},topic:{type:"string",required:!1},customContent:{type:"string",required:!1},account:{type:"string",required:!1}},teamSpecializationInfo:{needACK:{type:"boolean"},isACKSent:{type:"boolean"},ackSnapshot:{type:"number"}},threadMessageInfo:{replyMsgFromAccount:{type:"string"},replyMsgToAccount:{type:"string"},replyMsgTime:{type:"number"},replyMsgIdServer:{type:"string"},replyMsgIdClient:{type:"string"},threadMsgFromAccount:{type:"string"},threadMsgToAccount:{type:"string"},threadMsgTime:{type:"number"},threadMsgIdServer:{type:"string"},threadMsgIdClient:{type:"string"}}},Md={0:"addTeamMembers",1:"removeTeamMembers",2:"leaveTeam",3:"updateTeam",4:"dismissTeam",5:"passTeamApply",6:"transferTeam",7:"addTeamManagers",8:"removeTeamManagers",9:"acceptTeamInvite",10:"updateTeamMemberMute",101:"netcallMiss",102:"netcallBill",103:"netcallReject",401:"addSuperTeamMembers",402:"removeSuperTeamMembers",403:"leaveSuperTeam",404:"updateSuperTeam",405:"dismissSuperTeam",406:"transferSuperTeam",407:"addSuperTeamManagers",408:"removeSuperTeamManagers",409:"updateSuperTeamMembersMute",410:"passSuperTeamApply",411:"acceptSuperTeamInvite"};function formatNotificationAttach(t){var o={};if(o.type=Md[t.id]||t.id,!t.data)return o;var a={ids:"accounts",id:"account",attach:"custom",channel:"channelId",calltype:"netcallType",mute:"mute",duration:"duration",time:"time",from:"from",ext:"ext"},c=t.data;return Object.keys(a).forEach((t=>{void 0!==c[t]&&(o[a[t]]=c[t])})),c.tinfo&&(o.team=function formatTeam(t){var o={type:ld,muteType:dd,joinMode:ud,beInviteMode:md,inviteMode:hd,updateTeamMode:gd,updateExtMode:_d},a=__rest(t,["bits"]);return["teamId"].forEach((t=>{a[t]&&(a[t]=a[t].toString())})),["level","memberNum","memberUpdateTime","createTime","updateTime"].forEach((t=>{void 0!==a[t]&&(a[t]=parseInt(a[t]))})),["valid","validToCurrentUser","mute"].forEach((t=>{void 0!==a[t]&&(a[t]=1===parseInt(a[t]))})),Object.keys(o).forEach((t=>{void 0!==a[t]&&(a[t]=o[t][a[t]]||a[t])})),a}(deserialize(c.tinfo,Id.team))),c.uinfos&&(o.users=c.uinfos.map((t=>function formatUser(t){var o=Object.assign({},t);return o.createTime&&(o.createTime=+o.createTime),o.updateTime&&(o.updateTime=+o.updateTime),o.gender&&(o.gender=pd[+o.gender]),o}(deserialize(t,fd.user))))),void 0!==c.mute&&(o.mute=1===parseInt(c.mute)),o}function msgFlow(t,o){return t.from===o?t.to===o?"in":"out":"in"}function formatMsg(t,o){var{account:a,featureValue:c,statusValue:m,sessionAck:h,msgReceiptTime:g}=o,_=mi[t.scene],I=t.to===a?t.from:t.to,E=_i.default,T=gi.unread;parseInt(t.isInBlackList)>0?(T=gi.refused,delete t.isInBlackList):T=t.from===a?g&&g>=+t.time?gi.receipt:gi.sent:h&&h>=+t.time?gi.read:gi.unread;var M=Object.assign(Object.assign({},format(Td,t)),{scene:_,type:ui[t.type],fromClientType:hi[t.fromClientType],flow:msgFlow(t,a),target:I,to:t.to,from:t.from,time:t.time?+t.time:void 0,userUpdateTime:t.userUpdateTime?+t.userUpdateTime:void 0,idClient:t.idClient,sessionId:`${_}-${I}`,status:gi[m||T],feature:_i[c||E]});if("string"==typeof M.attach)try{M.attach=JSON.parse(M.attach)}catch(t){}return"notification"===M.type&&(M.attach=M.attach?formatNotificationAttach(M.attach):{}),M}function generatorMsgForCmd(t,o,a,c){var{onSendBefore:m,onUploadStart:h,onUploadDone:g,replyMsg:_}=t,I=__rest(t,["onSendBefore","onUploadStart","onUploadDone","replyMsg"]),E=Object.assign(Object.assign({},formatReverse(Td,I)),{scene:mi[t.scene],type:ui[t.type],from:o,fromClientType:16,fromDeviceId:a,fromNick:null==c?void 0:c.nick,userUpdateTime:null==c?void 0:c.updateTime,status:gi[gi.sending]});if(E.idClient=E.resendFlag?t.idClient:Ai(),!E.idClient)throw new FormatError("idClient is required to resend a message","idClient","required");return E=function processPushInfoInMsg(t,o=!0){var a=Object.assign({},t);if(a.pushInfo&&o){for(var c in a.pushInfo)"boolean"==typeof a.pushInfo[c]?a[c]=a.pushInfo[c]?1:0:a[c]=a.pushInfo[c];delete a.pushInfo}return a.scene===mi.team&&a.needForcePush&&(a.forcePushContent=a.forcePushContent||a.pushContent,a.forcePushIDsList=a.forcePushIDsList?a.forcePushIDsList:"#%@all@%#"),a}(E,!1),_&&(E.replyMsgFromAccount=_.from,E.replyMsgToAccount=_.to,E.replyMsgTime=+_.time,E.replyMsgIdServer=_.idServer,E.replyMsgIdClient=_.idClient,E.threadMsgFromAccount=_.from,E.threadMsgToAccount=_.to,E.threadMsgTime=+_.time,E.threadMsgIdServer=_.idServer,E.threadMsgIdClient=_.idClient,_.threadMessageInfo&&_.threadMessageInfo.threadMsgIdServer&&(E.threadMsgFromAccount=_.threadMessageInfo.threadMsgFromAccount,E.threadMsgToAccount=_.threadMessageInfo.threadMsgToAccount,E.threadMsgTime=_.threadMessageInfo.threadMsgTime,E.threadMsgIdServer=_.threadMessageInfo.threadMsgIdServer,E.threadMsgIdClient=_.threadMessageInfo.threadMsgIdClient)),E}class DataStructureConverterImpl{constructor(t){this.core=t}messageConvertToV1(t){var o,a=deserialize(serialize(t,Jo),mn(sd)),c=function getSessionId(t,o){return`${mi[t.scene]}-${t.to===o?t.from:t.to}`}(a,this.core.account),m=null===(o=this.core.session)||void 0===o?void 0:o.getSessionWithUncomplete({id:c});return formatMsg(a,m?{account:this.core.account,sessionAck:m.ack,msgReceiptTime:m.msgReceiptTime}:{account:this.core.account})}messageConvertToV2(t){var o=deserialize(serialize(generatorMsgForCmd(t,t.from,t.fromDeviceId),sd),Xo);return(o=completeMessage(this.core,o)).sendingState="sending"===t.status?ed.V2NIM_MESSAGE_SENDING_STATE_SENDING:"sendFailed"===t.status?ed.V2NIM_MESSAGE_SENDING_STATE_FAILED:ed.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED,o}}class V2NIMMessageConverterImpl{constructor(t){this.core=t}messageSerialization(t){if(!t)return null;var o=serialize(t,Jo);return JSON.stringify(o)}messageDeserialization(t){var o,a,c,m,h,g,_,I,E,T,M,S,N,C,A,O,R,b,V,P,k,L,D;if(!t)return null;try{var w=deserialize(JSON.parse(t),Xo);return w.sendingState=ed.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN,w.conversationType!==Be.V2NIM_CONVERSATION_TYPE_P2P||w.senderId!==this.core.account&&w.receiverId!==this.core.account?w.conversationType===Be.V2NIM_CONVERSATION_TYPE_TEAM?w.conversationId=this.core.V2NIMConversationIdUtil.teamConversationId(w.receiverId):w.conversationType===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM&&(w.conversationId=this.core.V2NIMConversationIdUtil.superTeamConversationId(w.receiverId)):w.conversationId=this.core.V2NIMConversationIdUtil.p2pConversationId(w.senderId===this.core.account?w.receiverId:w.senderId),w.threadReply&&(w.threadReply.conversationType=w.conversationType,w.threadReply=completeMessageRefer(this.core,w.threadReply)),w.threadRoot&&(w.threadRoot.conversationType=w.conversationType,w.threadRoot=completeMessageRefer(this.core,w.threadRoot)),Object.values(Be).includes(w.conversationType)||this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): ${w.conversationType}`),w.senderId&&"string"!=typeof w.senderId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): ${w.senderId}`),w.receiverId&&"string"!=typeof w.receiverId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): ${w.receiverId}`),"createTime"in w&&isNaN(w.createTime)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): ${w.createTime}`),Object.values(rt).includes(w.messageType)||this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageType(enum): ${w.messageType}`),"subType"in w&&isNaN(w.subType)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid subType(number): ${w.subType}`),w.messageClientId&&"string"!=typeof w.messageClientId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): ${w.messageClientId}`),w.messageServerId&&"string"!=typeof w.messageServerId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): ${w.messageServerId}`),w.attachment&&"object"!=typeof w.attachment&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid attachment(object): ${w.attachment}`),w.text&&"string"!=typeof w.text&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid text(string): ${w.text}`),w.serverExtension&&"string"!=typeof w.serverExtension&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid serverExtension(string): ${w.serverExtension}`),w.callbackExtension&&"string"!=typeof w.callbackExtension&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid callbackExtension(string): ${w.callbackExtension}`),(null===(o=w.pushConfig)||void 0===o?void 0:o.pushContent)&&"string"!=typeof w.pushConfig.pushContent&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid pushContent(string): ${w.pushConfig.pushContent}`),(null===(a=w.pushConfig)||void 0===a?void 0:a.pushPayload)&&"string"!=typeof w.pushConfig.pushPayload&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid pushPayload(string): ${w.pushConfig.pushPayload}`),(null===(c=w.pushConfig)||void 0===c?void 0:c.forcePushContent)&&"string"!=typeof w.pushConfig.forcePushContent&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid forcePushContent(string): ${w.pushConfig.forcePushContent}`),(null===(m=w.pushConfig)||void 0===m?void 0:m.forcePushAccountIds)&&!Array.isArray(w.pushConfig.forcePushAccountIds)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid forcePushAccountIds(array): ${w.pushConfig.forcePushAccountIds}`),(null===(h=w.routeConfig)||void 0===h?void 0:h.routeEnvironment)&&"string"!=typeof w.routeConfig.routeEnvironment&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid routeEnvironment(string): ${w.routeConfig.routeEnvironment}`),(null===(g=w.antispamConfig)||void 0===g?void 0:g.antispamBusinessId)&&"string"!=typeof w.antispamConfig.antispamBusinessId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid antispamBusinessId(string): ${w.antispamConfig.antispamBusinessId}`),(null===(_=w.antispamConfig)||void 0===_?void 0:_.antispamCustomMessage)&&"string"!=typeof w.antispamConfig.antispamCustomMessage&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid antispamCustomMessage(string): ${w.antispamConfig.antispamCustomMessage}`),(null===(I=w.antispamConfig)||void 0===I?void 0:I.antispamCheating)&&"string"!=typeof w.antispamConfig.antispamCheating&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid antispamCheating(string): ${w.antispamConfig.antispamCheating}`),(null===(E=w.antispamConfig)||void 0===E?void 0:E.antispamExtension)&&"string"!=typeof w.antispamConfig.antispamExtension&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid antispamExtension(string): ${w.antispamConfig.antispamExtension}`),(null===(T=w.robotConfig)||void 0===T?void 0:T.accountId)&&"string"!=typeof w.robotConfig.accountId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid accountId(string): ${w.robotConfig.accountId}`),(null===(M=w.robotConfig)||void 0===M?void 0:M.topic)&&"string"!=typeof w.robotConfig.topic&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid topic(string): ${w.robotConfig.topic}`),(null===(S=w.robotConfig)||void 0===S?void 0:S.function)&&"string"!=typeof w.robotConfig.function&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid function(string): ${w.robotConfig.function}`),(null===(N=w.robotConfig)||void 0===N?void 0:N.customContent)&&"string"!=typeof w.robotConfig.customContent&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid customContent(string): ${w.robotConfig.customContent}`),(null===(C=w.threadRoot)||void 0===C?void 0:C.senderId)&&"string"!=typeof w.threadRoot.senderId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): ${w.threadRoot.senderId}`),(null===(A=w.threadRoot)||void 0===A?void 0:A.receiverId)&&"string"!=typeof w.threadRoot.receiverId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): ${w.threadRoot.receiverId}`),(null===(O=w.threadRoot)||void 0===O?void 0:O.messageClientId)&&"string"!=typeof w.threadRoot.messageClientId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): ${w.threadRoot.messageClientId}`),(null===(R=w.threadRoot)||void 0===R?void 0:R.messageServerId)&&"string"!=typeof w.threadRoot.messageServerId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): ${w.threadRoot.messageServerId}`),w.threadRoot&&"createTime"in w.threadRoot&&isNaN(w.threadRoot.createTime)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): ${w.threadRoot.createTime}`),w.threadRoot&&!Object.values(Be).includes(w.threadRoot.conversationType)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): ${w.threadRoot.conversationType}`),(null===(b=w.threadRoot)||void 0===b?void 0:b.conversationId)&&"string"!=typeof w.threadRoot.conversationId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationId(string): ${w.threadRoot.conversationId}`),(null===(V=w.threadReply)||void 0===V?void 0:V.senderId)&&"string"!=typeof w.threadReply.senderId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): ${w.threadReply.senderId}`),(null===(P=w.threadReply)||void 0===P?void 0:P.receiverId)&&"string"!=typeof w.threadReply.receiverId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): ${w.threadReply.receiverId}`),(null===(k=w.threadReply)||void 0===k?void 0:k.messageClientId)&&"string"!=typeof w.threadReply.messageClientId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): ${w.threadReply.messageClientId}`),(null===(L=w.threadReply)||void 0===L?void 0:L.messageServerId)&&"string"!=typeof w.threadReply.messageServerId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): ${w.threadReply.messageServerId}`),w.threadReply&&"createTime"in w.threadReply&&isNaN(w.threadReply.createTime)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): ${w.threadReply.createTime}`),w.threadReply&&!Object.values(Be).includes(w.threadReply.conversationType)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): ${w.threadReply.conversationType}`),(null===(D=w.threadReply)||void 0===D?void 0:D.conversationId)&&"string"!=typeof w.threadReply.conversationId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationId(string): ${w.threadReply.conversationId}`),delete w.__clientExt,delete w.userUpdateTime,w}catch(o){return this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid message string: ${t}`),null}}}var yd="V2NIMMessageLogUtil",Sd={"30_6":"v2GetMessageList","33_2":"v2GetMessageListByRefers","30_18":"v2ClearHistoryMessage","7_118":"onClearHistoryMessage","4_24":"syncClearHistoryMessage","31_23":"v2GetTeamMessageList","32_14":"v2GetSuperTeamMessageList"},Nd={conversationType:{id:0,retType:"number"},receiverId:1,deleteRoam:{id:2,converter:boolToInt},teamId:3,onlineSync:{id:4,converter:boolToInt},deleteTime:{id:6,retType:"number"},serverExtension:7},Cd=[{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"direction"},{type:"LongArray",name:"msgTypes"}],Ad={v2GetMessageList:{sid:30,cid:6,service:yd,params:[{type:"String",name:"to"},...Cd],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(Jo)}]},v2GetMessageListByRefers:{sid:33,cid:2,service:yd,params:[{type:"PropertyArray",name:"tag",reflectMapper:Jo,select:["conversationType","senderId","receiverId","createTime","messageServerId"]}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(Jo)}]},v2ClearHistoryMessage:{sid:30,cid:18,service:yd,params:[{type:"Property",name:"tag",reflectMapper:Nd}],response:[{type:"Long",name:"timetag"}]},v2GetTeamMessageList:{sid:31,cid:23,service:yd,params:[{type:"Long",name:"to"},...Cd],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(Jo)}]},v2GetSuperTeamMessageList:{sid:32,cid:14,service:yd,params:[{type:"Long",name:"to"},...Cd],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(Jo)}]},onClearHistoryMessage:{sid:7,cid:118,service:yd,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nd)}]},syncClearHistoryMessage:{sid:4,cid:24,service:yd,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Nd)}]}};class V2NIMMessageLogUtil extends V2Service{constructor(t){super("V2NIMMessageLogUtil",t),this.clearHistoryMessageHandler=t=>{var o=formatClearHistoryNotification(this.core,t);this.emitClearHistoryMessage([o])},this.core=t,this.service=this.core.V2NIMMessageService,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Sd,cmdConfig:Ad}),this.setListener())}setListener(){this.core.eventBus.on("forwardReceive/V2NIMMessageLogService/clearHistoryMessage",this.clearHistoryMessageHandler)}getMessageListByRefers(t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Ns,{messageRefers:t},"",!0),0===t.length)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageListByRefers: messageRefers cannot be an empty array"}});var o=[],a=t.map((t=>{var a=this.service.model.getMessageById(t.messageClientId);return!a&&t.messageServerId&&"0"!==t.messageServerId&&o.push(t),a})),c=[];if(o.length>0){var m=yield this.core.sendCmd("v2GetMessageListByRefers",{tag:o});c=m.content.msgs}return a.map(((o,a)=>{if(o)return o;var m=t[a],h=c.find((t=>t.messageServerId===m.messageServerId));return h?completeMessage(this.core,h):void 0})).filter((t=>void 0!==t)).map((t=>formatMessageAttachment(t,this.core)))}))}getMessageList(t){var o;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),!this.core.V2NIMConversationIdUtil||!this.core.V2NIMConversationIdUtil.parseConversationType)throw new Error('Service "V2NIMConversationService" does not exist');validate(ys,t,"",!0),validateConversationId(this.core.account,t.conversationId);var a=this.core.V2NIMConversationIdUtil.parseConversationType(t.conversationId),c=this.core.V2NIMConversationIdUtil.parseConversationTargetId(t.conversationId),m=a===Be.V2NIM_CONVERSATION_TYPE_P2P?"v2GetMessageList":a===Be.V2NIM_CONVERSATION_TYPE_TEAM?"v2GetTeamMessageList":"v2GetSuperTeamMessageList",h=t.beginTime||0,g=t.endTime||0;if(0!==h&&0!==g&&h>g)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: beginTime cannot be greater than endTime"}});var _=void 0===t.direction?st.V2NIM_QUERY_DIRECTION_DESC:t.direction;if(t.anchorMessage)if(t.direction===st.V2NIM_QUERY_DIRECTION_DESC){if(0===g)g=t.anchorMessage.createTime;else if(g!==t.anchorMessage.createTime)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: When providing anchorMessage, when sorting in descending order, endTime does not need to be provided, or endTime should be equal to anchorMessage.createTime"}})}else if(0===h)h=t.anchorMessage.createTime;else if(h!==t.anchorMessage.createTime)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: When providing anchorMessage, when sorting in ascending order, there is no need to provide beginTime, or beginTime should be equal to anchorMessage.createTime"}});var I=null===(o=t.anchorMessage)||void 0===o?void 0:o.messageServerId,E=yield this.core.sendCmd(m,{beginTime:h,endTime:g,lastMsgId:I||0,limit:t.limit||50,direction:_,msgTypes:t.messageTypes?t.messageTypes.slice():[],to:c}),{content:T}=E,M=[];return M=T.msgs.map((t=>completeMessage(this.core,t))),I&&(M=M.filter((t=>t.messageServerId!==I))),this.getMessageListMonkeyPatch(M,t).map((t=>formatMessageAttachment(t,this.core)))}))}getMessageListMonkeyPatch(t,o){var a=o.conversationId,c=t,m=c.reduce(((t,o)=>(t[o.messageClientId]=!0,t)),{}),h=this.core.V2NIMMessageService.model.getMessagesByConversationId(a);h=h.sort(((t,a)=>o.direction===st.V2NIM_QUERY_DIRECTION_ASC?t.createTime-a.createTime:a.createTime-t.createTime));var g=0,_=o.beginTime||0,I=o.endTime||0;o.anchorMessage&&(o.direction===st.V2NIM_QUERY_DIRECTION_DESC?I=o.anchorMessage.createTime:_=o.anchorMessage.createTime,g=h.findIndex((t=>{var a;return t.messageClientId===(null===(a=o.anchorMessage)||void 0===a?void 0:a.messageClientId)})),g+=1);for(var E=g;E<h.length;E++){var T=h[E],M=!m[T.messageClientId],S=void 0===T.sendingState||T.sendingState===ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED,N=T.conversationId===a,C=T.createTime>_&&(T.createTime<I||0===I),A=!o.messageTypes||o.messageTypes.includes(T.messageType);M&&S&&N&&C&&A&&c.push(h[E])}return(c=c.sort(((t,a)=>o.direction===st.V2NIM_QUERY_DIRECTION_ASC?t.createTime-a.createTime:a.createTime-t.createTime))).slice(0,o.limit||50)}clearHistoryMessage(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Os,t,"",!0),validateConversationId(this.core.account,t.conversationId);var{conversationId:o,deleteRoam:a,onlineSync:c,serverExtension:m}=t,h=this.core.V2NIMConversationIdUtil.parseConversationType(o),g=this.core.V2NIMConversationIdUtil.parseConversationTargetId(o),_={deleteRoam:a,onlineSync:c,serverExtension:m,conversationType:h};h===Be.V2NIM_CONVERSATION_TYPE_P2P?_.receiverId=g:_.teamId=g;var I=yield this.core.sendCmd("v2ClearHistoryMessage",{tag:_});this.core.eventBus.emit("forwardSend/V2NIMMessageLogService/clearHistoryMessage",Object.assign(Object.assign({},_),{deleteTime:I.content.timetag})),this.emitClearHistoryMessage([{deleteTime:I.content.timetag,serverExtension:m,conversationId:o}])}))}syncClearHistoryMessageHandler(t){var o=t.content.data.map((t=>formatClearHistoryNotification(this.core,t)));this.emitClearHistoryMessage(o)}onClearHistoryMessageHandler(t){var o=formatClearHistoryNotification(this.core,t.content.data);this.emitClearHistoryMessage([o])}emitClearHistoryMessage(t){t.forEach((t=>{this.core.V2NIMMessageService.model.deleteMessages(t.conversationId,t.deleteTime)})),this.core.V2NIMMessageService.emit("onClearHistoryNotifications",t)}}var Od="V2NIMMessageExtendUtil",Rd={"29_5":"v2VoiceToText","33_15":"v2PinMessage","33_16":"v2UpdatePinMessage","33_17":"v2UnpinMessage","23_18":"onPinMessage","23_19":"onUpdatePinMessage","23_20":"onUnpinMessage","23_115":"onPinMessage","23_116":"onUpdatePinMessage","23_117":"onUnpinMessage","33_21":"v2GetPinMessageList","33_3":"v2AddQuickComment","33_4":"v2RemoveQuickComment","33_7":"v2GetQuickComment","23_5":"onAddQuickComment","23_6":"onRemoveQuickComment","23_103":"onAddQuickComment","23_104":"onRemoveQuickComment","33_8":"v2AddCollection","33_9":"v2RemoveCollections","33_10":"v2UpdateCollectionExtension","33_11":"v2GetCollectionListByOption","30_26":"v2SearchCloudMessagesGroupByConversation","30_27":"v2SearchCloudMessages","33_1":"v2GetThreadMessageList"},bd={conversationType:{id:1,converter:conversationTypeV2ToV1,retConverter:conversationTypeV1ToV2,access:"messageRefer.conversationType"},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},createTime:{id:4,retType:"number",access:"messageRefer.createTime"},messageServerId:{id:5,access:"messageRefer.messageServerId"},messageClientId:{id:6,access:"messageRefer.messageClientId"},detail:7,modify:{id:8,retType:"number"}},Vd={conversationType:{id:1,access:"messageRefer.conversationType",retConverter:conversationTypeV1ToV2},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},time:{id:4,access:"messageRefer.createTime",converter:boolToInt,retType:"number"},messageServerId:{id:5,access:"messageRefer.messageServerId"},messageClientId:{id:6,access:"messageRefer.messageClientId"},operatorId:7,serverExtension:8,createTime:{id:9,converter:boolToInt,retType:"number"},updateTime:{id:10,converter:boolToInt,retType:"number"}},Pd={operatorId:1,index:{id:2,retType:"number"},createTime:{id:3,retType:"number"},serverExtension:4,pushEnabled:{id:5,access:"pushConfig.pushEnabled",converter:boolToInt},needBadge:{id:6,access:"pushConfig.needBadge",converter:boolToInt},title:{id:7,access:"pushConfig.title"},pushContent:{id:8,access:"pushConfig.pushContent"},pushPayload:{id:9,access:"pushConfig.pushPayload"}},kd={accid:1,serverExtension:2,createTime:{id:3,retType:"number"},updateTime:{id:4,retType:"number"}},Ld={collectionId:1,collectionType:{id:2,retType:"number"},collectionData:3,serverExtension:4,uniqueId:5,createTime:{id:6,retType:"number"},updateTime:{id:7,retType:"number"}},Dd={keyword:1,beginTime:2,endTime:3,messageLimit:5,sortOrder:{id:6,converter:t=>0===t?2:1},p2pAccountIds:{id:7,converter:t=>t.join(",")},teamIds:{id:8,converter:t=>t.join(",")},senderAccountIds:{id:9,converter:t=>t.join(",")},messageTypes:{id:10,converter:t=>t.join(",")},messageSubtypes:{id:11,converter:t=>t.join(",")}},wd=Object.assign(Object.assign({},Dd),{conversationLimit:4}),Ud={v2PinMessage:{sid:33,cid:15,service:Od,params:[{type:"Property",name:"msg",reflectMapper:Jo,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:kd}],response:[{type:"Long",name:"timetag"}]},v2UnpinMessage:{sid:33,cid:17,service:Od,params:[{type:"Property",name:"msg",reflectMapper:Jo,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:kd}],response:[{type:"Long",name:"timetag"}]},v2UpdatePinMessage:{sid:33,cid:16,service:Od,params:[{type:"Property",name:"msg",reflectMapper:Jo,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:kd}],response:[{type:"Long",name:"timetag"}]},v2GetPinMessageList:{sid:33,cid:21,service:Od,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,timetag:2}}],response:[{type:"Long",name:"timetag"},{type:"Bool",name:"changed"},{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Vd)}]},v2VoiceToText:{sid:29,cid:5,service:Od,params:[{type:"Property",name:"tag",reflectMapper:{mimeType:0,sampleRate:1,voiceUrl:2,duration:3}}],response:[{type:"String",name:"data"}]},v2AddQuickComment:{sid:33,cid:3,service:Od,params:[{type:"Property",name:"message",reflectMapper:Jo,select:["conversationType","senderId","receiverId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"quickComment",reflectMapper:Pd}],response:[{type:"Long",name:"timetag"}]},v2RemoveQuickComment:{sid:33,cid:4,service:Od,params:[{type:"Property",name:"message",reflectMapper:Jo,select:["conversationType","senderId","receiverId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"quickComment",reflectMapper:Pd}],response:[{type:"Long",name:"timetag"}]},onAddQuickComment:{sid:23,cid:5,service:Od,response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(Jo)},{type:"Property",name:"quickComment",reflectMapper:invertSerializeItem(Pd)}]},onRemoveQuickComment:{sid:23,cid:6,service:Od,response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(Jo)},{type:"Property",name:"quickComment",reflectMapper:invertSerializeItem(Pd)}]},v2GetQuickComment:{sid:33,cid:7,service:Od,params:[{type:"PropertyArray",name:"tag",reflectMapper:bd}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(bd)}]},onPinMessage:{sid:23,cid:18,service:Od,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(Jo)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(kd)}]},onUpdatePinMessage:{sid:23,cid:19,service:Od,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(Jo)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(kd)}]},onUnpinMessage:{sid:23,cid:20,service:Od,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(Jo)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(kd)}]},v2AddCollection:{sid:33,cid:8,service:Od,params:[{type:"Property",name:"tag",reflectMapper:Ld}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ld)}]},v2RemoveCollections:{sid:33,cid:9,service:Od,params:[{type:"PropertyArray",name:"tag",reflectMapper:Ld,select:["collectionId","createTime"]}],response:[{type:"Int",name:"data"}]},v2UpdateCollectionExtension:{sid:33,cid:10,service:Od,params:[{type:"Property",name:"tag",reflectMapper:Ld}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ld)}]},v2GetCollectionListByOption:{sid:33,cid:11,service:Od,params:[{type:"Property",name:"tag",reflectMapper:{beginTime:1,endTime:2,excludeId:3,limit:4,direction:5,collectionType:6}}],response:[{type:"Long",name:"total"},{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Ld)}]},v2SearchCloudMessagesGroupByConversation:{sid:30,cid:26,service:Od,params:[{type:"Property",name:"tag",reflectMapper:wd}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2SearchCloudMessages:{sid:30,cid:27,service:Od,params:[{type:"Property",name:"tag",reflectMapper:Dd}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Jo)}]},v2GetThreadMessageList:{sid:33,cid:1,service:Od,params:[{type:"Property",name:"messageRefer",reflectMapper:Jo},{type:"Property",name:"tag",reflectMapper:{beginTime:1,endTime:2,excludeMessageServerId:3,limit:4,reverse:5}}],response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(Jo)},{type:"Property",name:"replyResult",reflectMapper:invertSerializeItem({total:{id:1,retType:"number"},timestamp:{id:2,retType:"number"}})},{type:"PropertyArray",name:"replyList",reflectMapper:invertSerializeItem(Jo)}]}};class V2NIMMessageExtendUtil extends V2Service{constructor(t){super("V2NIMMessageExtendService",t),this.core=t,"v2"===this.core.options.apiVersion&&registerParser({cmdMap:Rd,cmdConfig:Ud})}pinMessage(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ss,t,"message",!0),validate(Rs,{serverExtension:o},"",!0);var a=yield this.core.sendCmd("v2PinMessage",{msg:t,msgPin:{serverExtension:o}});this.emitPinNotification({pinState:ct.V2NIM_MESSAGE_PIN_STATE_PINNED,message:t,serverExtension:o,createTime:a.content.timetag,updateTime:a.content.timetag,operatorId:this.core.account})}))}unpinMessage(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ss,t,"messageRefer",!0),validate(Rs,{serverExtension:o},"",!0);var a=yield this.core.sendCmd("v2UnpinMessage",{msg:t,msgPin:{serverExtension:o}});this.emitPinNotification({pinState:ct.V2NIM_MESSAGE_PIN_STATE_NOT_PINNED,message:t,serverExtension:o,updateTime:a.content.timetag,operatorId:this.core.account})}))}updatePinMessage(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ss,t,"message",!0),validate(Rs,{serverExtension:o},"",!0);var a=yield this.core.sendCmd("v2UpdatePinMessage",{msg:t,msgPin:{serverExtension:o}});this.emitPinNotification({pinState:ct.V2NIM_MESSAGE_PIN_STATE_UPDATED,message:t,serverExtension:o,updateTime:a.content.timetag,operatorId:this.core.account})}))}getPinnedMessageList(t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),!this.core.V2NIMConversationIdUtil||!this.core.V2NIMConversationIdUtil.parseConversationType)throw new Error('Service "V2NIMConversationService" does not exist');validateConversationId(this.core.account,t);var o=this.core.V2NIMConversationIdUtil.convertToV1ConversationId(t);return o=o.replace("superTeam","super_team"),(yield this.core.sendCmd("v2GetPinMessageList",{tag:{conversationId:o,timetag:0}})).content.data.map((t=>Object.assign(Object.assign({},t),{messageRefer:Object.assign(Object.assign({},t.messageRefer),{conversationId:this.core.V2NIMConversationIdUtil.messageConversationId(t.messageRefer)})}))).sort(((t,o)=>o.updateTime-t.updateTime))}))}addQuickComment(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ks,{message:t,index:o,serverExtension:a,pushConfig:c},"",!0);var m=yield this.core.sendCmd("v2AddQuickComment",{message:t,quickComment:{index:o,serverExtension:a,pushConfig:c}}),h={operationType:dt.V2NIM_QUICK_COMMENT_STATE_ADD,quickComment:{messageRefer:formatMessageRefer(this.core,t),createTime:m.content.timetag,index:o,serverExtension:a||"",operatorId:this.core.account}};this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",h)}))}removeQuickComment(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ss,t,"messageRefer",!0),validate({index:{type:"number",min:1}},{index:o},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:a},"",!0);var c=yield this.core.sendCmd("v2RemoveQuickComment",{message:t,quickComment:{index:o,serverExtension:a}}),m={operationType:dt.V2NIM_QUICK_COMMENT_STATE_REMOVE,quickComment:{messageRefer:formatMessageRefer(this.core,t),createTime:c.content.timetag,index:o,serverExtension:a||"",operatorId:this.core.account}};this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",m)}))}getQuickCommentList(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ls,{messages:t},"",!0);var o={};return(yield this.core.sendCmd("v2GetQuickComment",{tag:t.map((t=>({messageRefer:t})))})).content.data.forEach((t=>{var a,c;try{if(!t.detail)return void(o[a=t.messageRefer.messageClientId]||(o[a]=[]));var m=JSON.parse(t.detail);o[c=t.messageRefer.messageClientId]||(o[c]=[]),m.forEach((a=>{o[t.messageRefer.messageClientId].push({messageRefer:Object.assign(Object.assign({},t.messageRefer),{conversationId:this.core.V2NIMConversationIdUtil.messageConversationId(t.messageRefer)}),operatorId:a[1],index:parseInt(a[2]),createTime:parseInt(a[3]),serverExtension:a[4]})}))}catch(o){this.logger.error("getQuickCommentList JSON Parse Error",t.detail,o)}})),o}))}voiceToText(t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Ps,t,"",!0),!t.voicePath&&!t.voiceUrl&&!t.file)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"voiceToText: voicePathã€voiceUrlã€file cannot be empty at the same time"}});var{voicePath:o,file:a,mimeType:c,sampleRate:m,duration:h,sceneName:g}=t,_=g?this.core.V2NIMStorageService.getStorageScene(g):null,I=t.voiceUrl;if(!I){var E={};a?E.file=a:0===(null==o?void 0:o.indexOf("nim-external"))?E.fileInput=o:E.filePath=o,I=(yield this.core.cloudStorage.uploadFile(Object.assign({type:"audio",nosScenes:_?_.sceneName:void 0,nosSurvivalTime:_?_.expireTime:void 0},E))).url}return(yield this.core.sendCmd("v2VoiceToText",{tag:{voiceUrl:I,mimeType:c,sampleRate:m,duration:h}})).content.data}))}onPinMessageHandler(t){return this.pinMessageChangeHandler(t,ct.V2NIM_MESSAGE_PIN_STATE_PINNED)}onUnpinMessageHandler(t){return this.pinMessageChangeHandler(t,ct.V2NIM_MESSAGE_PIN_STATE_NOT_PINNED)}onUpdatePinMessageHandler(t){return this.pinMessageChangeHandler(t,ct.V2NIM_MESSAGE_PIN_STATE_UPDATED)}pinMessageChangeHandler(t,o){var a=t.content.msg,c=t.content.pinInfo;a.conversationId=this.core.V2NIMConversationIdUtil.messageConversationId(a),this.emitPinNotification({pinState:o,message:a,serverExtension:c.serverExtension,createTime:c.createTime,updateTime:c.updateTime,operatorId:c.accid})}emitPinNotification(t){var o={pinState:t.pinState,pin:Object.assign(Object.assign({serverExtension:t.serverExtension||"",operatorId:t.operatorId},t.createTime?{createTime:t.createTime}:{}),{updateTime:t.updateTime,messageRefer:formatMessageRefer(this.core,t.message)})};this.core.V2NIMMessageService.emit("onMessagePinNotification",o)}onAddQuickCommentHandler(t){return this.onQuickCommentNotificationHandler(t,dt.V2NIM_QUICK_COMMENT_STATE_ADD)}onRemoveQuickCommentHandler(t){return this.onQuickCommentNotificationHandler(t,dt.V2NIM_QUICK_COMMENT_STATE_REMOVE)}onQuickCommentNotificationHandler(t,o){var a={operationType:o,quickComment:Object.assign({messageRefer:Object.assign(Object.assign({},t.content.message),{conversationId:this.core.V2NIMConversationIdUtil.messageConversationId(t.content.message)})},t.content.quickComment)};this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",a)}addCollection(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(Ds,{params:t},"",!0),(yield this.core.sendCmd("v2AddCollection",{tag:t})).content.data}))}removeCollections(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(ws,{collections:t},"",!0),(yield this.core.sendCmd("v2RemoveCollections",{tag:t})).content.data}))}updateCollectionExtension(t,o){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(Us,{collection:t,serverExtension:o},"",!0),(yield this.core.sendCmd("v2UpdateCollectionExtension",{tag:Object.assign(Object.assign({},t),{serverExtension:o})})).content.data}))}getCollectionListByOption(t){var o,a;return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(xs,t,"",!0);var c=t.beginTime||0,m=t.endTime||0;if(0!==c&&0!==m&&c>m)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListByOption: beginTime cannot be greater than endTime"}});var h=void 0===t.direction?st.V2NIM_QUERY_DIRECTION_DESC:t.direction;if(void 0!==(null===(o=t.anchorCollection)||void 0===o?void 0:o.collectionId))if(t.direction===st.V2NIM_QUERY_DIRECTION_DESC){if(0===m)m=t.anchorCollection.createTime;else if(m!==t.anchorCollection.createTime)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListByOption: When providing anchorCollection, when sorting in descending order, endTime does not need to be provided, or endTime should be equal to anchorCollection.createTime"}})}else if(0===c)c=t.anchorCollection.createTime;else if(c!==t.anchorCollection.createTime)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListByOption: When providing anchorCollection, when sorting in ascending order, there is no need to provide beginTime, or beginTime should be equal to anchorCollection.createTime"}});var g={beginTime:c,endTime:m,direction:h,limit:t.limit,collectionType:t.collectionType,excludeId:(null===(a=t.anchorCollection)||void 0===a?void 0:a.collectionId)?t.anchorCollection.collectionId:0};return g.collectionType||delete g.collectionType,(yield this.core.sendCmd("v2GetCollectionListByOption",{tag:g})).content.data}))}searchCloudMessages(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Fs,t,"",!0);var o=t.beginTime||0,a=t.endTime||0;if(0!==o&&0!==a&&o>a)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"searchCloudMessages: beginTime cannot be greater than endTime"}});var c=void 0===t.sortOrder?pt.V2NIM_SORT_ORDER_DESC:t.sortOrder,m=t.conversationLimit||0,h=t.messageLimit||10,g=m>0?"v2SearchCloudMessagesGroupByConversation":"v2SearchCloudMessages";return(yield this.core.sendCmd(g,{tag:Object.assign(Object.assign({},t),{beginTime:o,endTime:a,sortOrder:c,conversationLimit:m,messageLimit:h})})).content.data.map((t=>completeMessage(this.core,t)))}))}getThreadMessageList(t){return __awaiter(this,void 0,void 0,(function*(){if(validate(qs,t,"getThreadMessageList",!0),t.beginTime=t.beginTime||0,t.endTime&&t.beginTime>t.endTime)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getThreadMessageList: beginTime cannot be greater than endTime"}});var o=yield this.core.sendCmd("v2GetThreadMessageList",{messageRefer:t.messageRefer,tag:{beginTime:t.beginTime,endTime:t.endTime,limit:t.limit,reverse:t.direction===st.V2NIM_QUERY_DIRECTION_ASC?1:0,excludeMessageServerId:t.excludeMessageServerId}}),{message:a,replyResult:c,replyList:m}=o.content;return{message:completeMessage(this.core,a),timestamp:c.timestamp,replyCount:c.total,replyList:m.map((t=>completeMessage(this.core,t)))}}))}}var xd=function castSlice(t,o,a){var c=t.length;return a=void 0===a?c:a,!o&&a>=c?t:ho(t,o,a)},Fd=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");var Gd=function hasUnicode(t){return Fd.test(t)};var Bd=function asciiToArray(t){return t.split("")},jd="[\\ud800-\\udfff]",Yd="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",Hd="\\ud83c[\\udffb-\\udfff]",$d="[^\\ud800-\\udfff]",qd="(?:\\ud83c[\\udde6-\\uddff]){2}",zd="[\\ud800-\\udbff][\\udc00-\\udfff]",Kd="(?:"+Yd+"|"+Hd+")"+"?",Wd="[\\ufe0e\\ufe0f]?"+Kd+("(?:\\u200d(?:"+[$d,qd,zd].join("|")+")[\\ufe0e\\ufe0f]?"+Kd+")*"),Jd="(?:"+[$d+Yd+"?",Yd,qd,zd,jd].join("|")+")",Xd=RegExp(Hd+"(?="+Hd+")|"+Jd+Wd,"g");var Qd=function unicodeToArray(t){return t.match(Xd)||[]};var Zd=function stringToArray(t){return Gd(t)?Qd(t):Bd(t)};var el=function createCaseFirst(t){return function(o){o=ke(o);var a=Gd(o)?Zd(o):void 0,c=a?a[0]:o.charAt(0),m=a?xd(a,1).join(""):o.slice(1);return c[t]()+m}}("toUpperCase");var tl=function capitalize(t){return el(ke(t).toLowerCase())};var rl=function arrayReduce(t,o,a,c){var m=-1,h=null==t?0:t.length;for(c&&h&&(a=t[++m]);++m<h;)a=o(a,t[m],m,t);return a};var il=function basePropertyOf(t){return function(o){return null==t?void 0:t[o]}}({"Ã€":"A","Ã":"A","Ã‚":"A","Ãƒ":"A","Ã„":"A","Ã…":"A","Ã ":"a","Ã¡":"a","Ã¢":"a","Ã£":"a","Ã¤":"a","Ã¥":"a","Ã‡":"C","Ã§":"c","Ã":"D","Ã°":"d","Ãˆ":"E","Ã‰":"E","ÃŠ":"E","Ã‹":"E","Ã¨":"e","Ã©":"e","Ãª":"e","Ã«":"e","ÃŒ":"I","Ã":"I","ÃŽ":"I","Ã":"I","Ã¬":"i","Ã­":"i","Ã®":"i","Ã¯":"i","Ã‘":"N","Ã±":"n","Ã’":"O","Ã“":"O","Ã”":"O","Ã•":"O","Ã–":"O","Ã˜":"O","Ã²":"o","Ã³":"o","Ã´":"o","Ãµ":"o","Ã¶":"o","Ã¸":"o","Ã™":"U","Ãš":"U","Ã›":"U","Ãœ":"U","Ã¹":"u","Ãº":"u","Ã»":"u","Ã¼":"u","Ã":"Y","Ã½":"y","Ã¿":"y","Ã†":"Ae","Ã¦":"ae","Ãž":"Th","Ã¾":"th","ÃŸ":"ss","Ä€":"A","Ä‚":"A","Ä„":"A","Ä":"a","Äƒ":"a","Ä…":"a","Ä†":"C","Äˆ":"C","ÄŠ":"C","ÄŒ":"C","Ä‡":"c","Ä‰":"c","Ä‹":"c","Ä":"c","ÄŽ":"D","Ä":"D","Ä":"d","Ä‘":"d","Ä’":"E","Ä”":"E","Ä–":"E","Ä˜":"E","Äš":"E","Ä“":"e","Ä•":"e","Ä—":"e","Ä™":"e","Ä›":"e","Äœ":"G","Äž":"G","Ä ":"G","Ä¢":"G","Ä":"g","ÄŸ":"g","Ä¡":"g","Ä£":"g","Ä¤":"H","Ä¦":"H","Ä¥":"h","Ä§":"h","Ä¨":"I","Äª":"I","Ä¬":"I","Ä®":"I","Ä°":"I","Ä©":"i","Ä«":"i","Ä­":"i","Ä¯":"i","Ä±":"i","Ä´":"J","Äµ":"j","Ä¶":"K","Ä·":"k","Ä¸":"k","Ä¹":"L","Ä»":"L","Ä½":"L","Ä¿":"L","Å":"L","Äº":"l","Ä¼":"l","Ä¾":"l","Å€":"l","Å‚":"l","Åƒ":"N","Å…":"N","Å‡":"N","ÅŠ":"N","Å„":"n","Å†":"n","Åˆ":"n","Å‹":"n","ÅŒ":"O","ÅŽ":"O","Å":"O","Å":"o","Å":"o","Å‘":"o","Å”":"R","Å–":"R","Å˜":"R","Å•":"r","Å—":"r","Å™":"r","Åš":"S","Åœ":"S","Åž":"S","Å ":"S","Å›":"s","Å":"s","ÅŸ":"s","Å¡":"s","Å¢":"T","Å¤":"T","Å¦":"T","Å£":"t","Å¥":"t","Å§":"t","Å¨":"U","Åª":"U","Å¬":"U","Å®":"U","Å°":"U","Å²":"U","Å©":"u","Å«":"u","Å­":"u","Å¯":"u","Å±":"u","Å³":"u","Å´":"W","Åµ":"w","Å¶":"Y","Å·":"y","Å¸":"Y","Å¹":"Z","Å»":"Z","Å½":"Z","Åº":"z","Å¼":"z","Å¾":"z","Ä²":"IJ","Ä³":"ij","Å’":"Oe","Å“":"oe","Å‰":"'n","Å¿":"s"}),nl=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,ol=RegExp("[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]","g");var sl=function deburr(t){return(t=ke(t))&&t.replace(nl,il).replace(ol,"")},al=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g;var cl=function asciiWords(t){return t.match(al)||[]},dl=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/;var ll=function hasUnicodeWord(t){return dl.test(t)},pl="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",ul="["+pl+"]",ml="\\d+",hl="[\\u2700-\\u27bf]",gl="[a-z\\xdf-\\xf6\\xf8-\\xff]",_l="[^\\ud800-\\udfff"+pl+ml+"\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde]",vl="(?:\\ud83c[\\udde6-\\uddff]){2}",Il="[\\ud800-\\udbff][\\udc00-\\udfff]",El="[A-Z\\xc0-\\xd6\\xd8-\\xde]",fl="(?:"+gl+"|"+_l+")",Tl="(?:"+El+"|"+_l+")",Ml="(?:[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]|\\ud83c[\\udffb-\\udfff])?",yl="[\\ufe0e\\ufe0f]?"+Ml+("(?:\\u200d(?:"+["[^\\ud800-\\udfff]",vl,Il].join("|")+")[\\ufe0e\\ufe0f]?"+Ml+")*"),Sl="(?:"+[hl,vl,Il].join("|")+")"+yl,Nl=RegExp([El+"?"+gl+"+(?:['â€™](?:d|ll|m|re|s|t|ve))?(?="+[ul,El,"$"].join("|")+")",Tl+"+(?:['â€™](?:D|LL|M|RE|S|T|VE))?(?="+[ul,El+fl,"$"].join("|")+")",El+"?"+fl+"+(?:['â€™](?:d|ll|m|re|s|t|ve))?",El+"+(?:['â€™](?:D|LL|M|RE|S|T|VE))?","\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",ml,Sl].join("|"),"g");var Cl=function unicodeWords(t){return t.match(Nl)||[]};var Al=function words(t,o,a){return t=ke(t),void 0===(o=a?void 0:o)?ll(t)?Cl(t):cl(t):t.match(o)||[]},Ol=RegExp("['â€™]","g");var Rl=function createCompounder(t){return function(o){return rl(Al(sl(o).replace(Ol,"")),t,"")}}((function(t,o,a){return o=o.toLowerCase(),t+(a?tl(o):o)})),bl={"4_26":"v2AIChatNotify","29_35":"v2AIProxyModelCall","29_36":"v2AIGetUserList"},Vl={accountId:1,messages:{id:2,converter:objectToJSONString,retConverter:stringToJSONObject},requestId:3,content:{id:4,converter:objectToJSONString,retConverter:stringToJSONObject},promptVariables:5,modelConfigParams:{id:6,converter:objectToJSONString,retConverter:stringToJSONObject},antispamBusinessId:7,antispamEnabled:{id:8,converter:boolToInt}},Pl={accountId:1,name:3,avatar:4,sign:5,gender:{id:6,retType:"number"},email:7,birthday:8,mobile:9,serverExtension:10,modelType:{id:11,retType:"number"},modelConfig:{id:12,retConverter:t=>{if(t=stringToJSONObject(t)){var o=Object.keys(t).reduce(((o,a)=>(o[Rl(a)]=t[a],o)),{});if("string"==typeof o.promptKeys)try{o.promptKeys=JSON.parse(o.promptKeys)}catch(t){}return o}}},yunxinConfig:{id:13,retConverter:t=>{if(t=stringToJSONObject(t))return t}},valid:{id:14,retType:"boolean"},createTime:{id:15,retType:"number"},updateTime:{id:16,retType:"number"}},kl={v2AIChatNotify:{sid:4,cid:26,service:"V2NIMAIService",response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem({code:{id:1,retType:"number"},accountId:2,requestId:3,content:{id:4,retConverter:stringToJSONObject}})}]},v2AIProxyModelCall:{sid:29,cid:35,service:"V2NIMAIService",params:[{type:"Property",name:"tag",reflectMapper:Vl}]},v2AIGetUserList:{sid:29,cid:36,service:"V2NIMAIService",params:[{type:"Property",name:"tag",reflectMapper:{pageToken:1,limit:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Pl)},{type:"Property",name:"queryTag",reflectMapper:invertSerializeItem({hasMore:{id:16,retType:"boolean"},nextToken:2})}]}};class V2NIMAIServiceImpl extends V2Service{constructor(t){super("V2NIMAIService",t),registerParser({cmdMap:bl,cmdConfig:kl})}getAIUserList(){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),(yield this.core.sendCmd("v2AIGetUserList",{tag:{}})).content.datas}))}proxyAIModelCall(t){return __awaiter(this,void 0,void 0,(function*(){validate(hs,t,"",!0),yield this.core.sendCmd("v2AIProxyModelCall",{tag:t})}))}v2AIChatNotifyHandler(t){var o=t.content.data;o&&o.requestId?this.emit("onProxyAIModelCall",{code:o.code||200,accountId:o.accountId,requestId:o.requestId,content:o.content}):this.logger.warn("v2AIChatNotifyHandler: invalid data",o)}}var Ll={"18_1":"v2SignallingCreateRoom","18_2":"v2SignallingDelayRoom","18_3":"v2SignallingCloseRoom","18_4":"v2SignallingJoinRoom","18_5":"v2SignallingLeaveRoom","18_6":"v2SignallingInvite","18_7":"v2SignallingCancelInvite","18_16":"v2SignallingCall","18_17":"v2SignallingCallSetup","18_8":"v2SignallingRejectInvite","18_9":"v2SignallingAcceptInvite","18_10":"v2SignallingSendControl","15_11":"v2SignallingOnlineEvent","15_12":"v2SignallingMultiClientEvent","15_13":"v2SignallingOfflineEvent","15_14":"v2SignallingSyncChannels","18_15":"v2SignallingGetRoomInfo"},Dl="V2NIMSignallingService",wl={accountId:1,uid:{id:2,retType:"number"},joinTime:{id:3,retType:"number"},expireTime:{id:4,retType:"number"},deviceId:5},Ul={channelType:{id:1,retType:"number",retAccess:"channelInfo.channelType"},channelName:{id:2,retAccess:"channelInfo.channelName"},channelId:{id:3,retAccess:"channelInfo.channelId"},createTime:{id:4,retType:"number",retAccess:"channelInfo.createTime"},expireTime:{id:5,retType:"number",retAccess:"channelInfo.expireTime"},creatorAccountId:{id:6,retAccess:"channelInfo.creatorAccountId"},channelExtension:{id:7,retAccess:"channelInfo.channelExtension"},invalid:8,fromAccid:10,toAccid:11,requestId:12,pushEnabled:{id:13,access:"pushConfig.pushEnabled",converter:boolToInt,retType:"boolean"},pushTitle:{id:14,access:"pushConfig.pushTitle"},pushContent:{id:15,access:"pushConfig.pushContent"},pushPayload:{id:16,access:"pushConfig.pushPayload"},unreadEnabled:{id:17,access:"signallingConfig.unreadEnabled",converter:boolToInt,retType:"boolean",def:1},members:{id:18,retAccess:"members",retConverter:t=>{try{return JSON.parse(t).map((t=>deserialize(t,invertSerializeItem(wl))))}catch(t){return}}},attach:{id:19,retConverter:stringToJSONObject},serverExtension:{id:20,retDef:""},offlineEnabled:{id:21,converter:boolToInt,retType:"boolean",def:1},msgId:22,selfUid:{id:23,retType:"number",access:"signallingConfig.selfUid"},time:{id:24,retType:"number"},rtcChannelName:{id:25,access:"rtcConfig.rtcChannelName"},rtcTokenTtl:{id:26,retType:"number",access:"rtcConfig.rtcTokenTtl",retAccess:"rtcInfo.rtcTokenTtl"},rtcToken:{id:27,retAccess:"rtcInfo.rtcToken"},rtcParams:{id:28,access:"rtcConfig.rtcParams",retAccess:"rtcInfo.rtcParams"},callStatus:{id:30,retType:"number"}},xl={v2SignallingCall:{sid:18,cid:16,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingCallSetup:{sid:18,cid:17,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingCreateRoom:{sid:18,cid:1,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingDelayRoom:{sid:18,cid:2,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingCloseRoom:{sid:18,cid:3,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingJoinRoom:{sid:18,cid:4,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingLeaveRoom:{sid:18,cid:5,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingInvite:{sid:18,cid:6,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingCancelInvite:{sid:18,cid:7,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingRejectInvite:{sid:18,cid:8,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}]},v2SignallingAcceptInvite:{sid:18,cid:9,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}]},v2SignallingSendControl:{sid:18,cid:10,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}]},v2SignallingOnlineEvent:{sid:15,cid:11,service:Dl,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingMultiClientEvent:{sid:15,cid:12,service:Dl,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingOfflineEvent:{sid:15,cid:13,service:Dl,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingSyncChannels:{sid:15,cid:14,service:Dl,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingGetRoomInfo:{sid:18,cid:15,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:Ul}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ul)}]},v2SignallingBatchMarkRead:{sid:4,cid:5,hasPacketResponse:!1,service:Dl,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]}},Fl={calleeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},channelType:{type:"enum",values:getEnumValues(Vt)},channelName:{type:"string",required:!1,allowEmpty:!0},channelExtension:{type:"string",required:!1,allowEmpty:!0},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushTitle:{type:"string",required:!1,allowEmpty:!0},pushContent:{type:"string",required:!1,allowEmpty:!0},pushPayload:{type:"string",required:!1,allowEmpty:!0}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},Gl={channelId:{type:"string",required:!0,allowEmpty:!1},callerAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},Bl={channelType:{type:"enum",values:getEnumValues(Vt)},channelName:{type:"string",required:!1,allowEmpty:!0},channelExtension:{type:"string",required:!1,allowEmpty:!0}},jl={channelId:{type:"string",required:!0,allowEmpty:!1},offlineEnabled:{type:"boolean",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},Yl={channelId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},Hl={channelId:{type:"string",required:!0,allowEmpty:!1},offlineEnabled:{type:"boolean",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},$l={channelId:{type:"string",required:!0,allowEmpty:!1},inviteeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushTitle:{type:"string",required:!1,allowEmpty:!0},pushContent:{type:"string",required:!1,allowEmpty:!0},pushPayload:{type:"string",required:!1,allowEmpty:!0}}}},ql={channelId:{type:"string",required:!0,allowEmpty:!1},inviteeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},offlineEnabled:{type:"boolean",required:!1}},zl={channelId:{type:"string",allowEmpty:!1},receiverAccountId:{type:"string",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},Kl={channelId:{type:"string",allowEmpty:!1},inviterAccountId:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},offlineEnabled:{type:"boolean",required:!1}},Wl=Kl;function formatSignalingEvent(t){var o,a=t.attach,c={eventType:a.type,channelInfo:t.channelInfo,operatorAccountId:t.fromAccid,time:t.time,serverExtension:t.serverExtension,requestId:t.requestId,pushConfig:t.pushConfig,unreadEnabled:null===(o=t.signallingConfig)||void 0===o?void 0:o.unreadEnabled},{fromAccid:m,toAccid:h}=t;switch(c.eventType){case bt.V2NIM_SIGNALLING_EVENT_TYPE_CLOSE:break;case bt.V2NIM_SIGNALLING_EVENT_TYPE_JOIN:c.member={accountId:a.member[1],uid:Number(a.member[2]),joinTime:Number(a.member[3]),expireTime:Number(a.member[4]),deviceId:a.member[5]};break;case bt.V2NIM_SIGNALLING_EVENT_TYPE_INVITE:case bt.V2NIM_SIGNALLING_EVENT_TYPE_CANCEL_INVITE:c.operatorAccountId=m,c.inviteeAccountId=h,c.inviterAccountId=m;break;case bt.V2NIM_SIGNALLING_EVENT_TYPE_REJECT:case bt.V2NIM_SIGNALLING_EVENT_TYPE_ACCEPT:c.operatorAccountId=m,c.inviterAccountId=h,c.inviteeAccountId=m;case bt.V2NIM_SIGNALLING_EVENT_TYPE_LEAVE:case bt.V2NIM_SIGNALLING_EVENT_TYPE_CONTROL:}return JSON.parse(JSON.stringify(c))}var Jl=function arrayEach(t,o){for(var a=-1,c=null==t?0:t.length;++a<c&&!1!==o(t[a],a,t););return t};var Xl=function baseAssign(t,o){return t&&kr(o,Ni(o),t)};var Ql=function baseAssignIn(t,o){return t&&kr(o,jr(o),t)};var Zl=function copySymbols(t,o){return kr(t,wn(t),o)};var ep=function copySymbolsIn(t,o){return kr(t,ra(t),o)},tp=Object.prototype.hasOwnProperty;var rp=function initCloneArray(t){var o=t.length,a=new t.constructor(o);return o&&"string"==typeof t[0]&&tp.call(t,"index")&&(a.index=t.index,a.input=t.input),a};var ip=function cloneDataView(t,o){var a=o?Qt(t.buffer):t.buffer;return new t.constructor(a,t.byteOffset,t.byteLength)},np=/\w*$/;var op=function cloneRegExp(t){var o=new t.constructor(t.source,np.exec(t));return o.lastIndex=t.lastIndex,o},sp=_?_.prototype:void 0,ap=sp?sp.valueOf:void 0;var cp=function cloneSymbol(t){return ap?Object(ap.call(t)):{}};var dp=function initCloneByTag(t,o,a){var c=t.constructor;switch(o){case"[object ArrayBuffer]":return Qt(t);case"[object Boolean]":case"[object Date]":return new c(+t);case"[object DataView]":return ip(t,a);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return Zt(t,a);case"[object Map]":case"[object Set]":return new c;case"[object Number]":case"[object String]":return new c(t);case"[object RegExp]":return op(t);case"[object Symbol]":return cp(t)}};var lp=function baseIsMap(t){return R(t)&&"[object Map]"==Wn(t)},pp=Ar&&Ar.isMap,up=pp?Cr(pp):lp;var mp=function baseIsSet(t){return R(t)&&"[object Set]"==Wn(t)},hp=Ar&&Ar.isSet,gp=hp?Cr(hp):mp,_p={};_p["[object Arguments]"]=_p["[object Array]"]=_p["[object ArrayBuffer]"]=_p["[object DataView]"]=_p["[object Boolean]"]=_p["[object Date]"]=_p["[object Float32Array]"]=_p["[object Float64Array]"]=_p["[object Int8Array]"]=_p["[object Int16Array]"]=_p["[object Int32Array]"]=_p["[object Map]"]=_p["[object Number]"]=_p["[object Object]"]=_p["[object RegExp]"]=_p["[object Set]"]=_p["[object String]"]=_p["[object Symbol]"]=_p["[object Uint8Array]"]=_p["[object Uint8ClampedArray]"]=_p["[object Uint16Array]"]=_p["[object Uint32Array]"]=!0,_p["[object Error]"]=_p["[object Function]"]=_p["[object WeakMap]"]=!1;var vp=function baseClone(t,o,a,m,h,g){var _,I=1&o,E=2&o,T=4&o;if(a&&(_=h?a(t,m,h,g):a(t)),void 0!==_)return _;if(!L(t))return t;var M=c(t);if(M){if(_=rp(t),!I)return er(t,_)}else{var S=Wn(t),N="[object Function]"==S||"[object GeneratorFunction]"==S;if(vr(t))return Jt(t,I);if("[object Object]"==S||"[object Arguments]"==S||N&&!h){if(_=E||N?{}:ar(t),!I)return E?ep(t,Ql(_,t)):Zl(t,Xl(_,t))}else{if(!_p[S])return h?t:{};_=dp(t,S,I)}}g||(g=new $t);var C=g.get(t);if(C)return C;g.set(t,_),gp(t)?t.forEach((function(c){_.add(baseClone(c,o,a,c,t,g))})):up(t)&&t.forEach((function(c,m){_.set(m,baseClone(c,o,a,m,t,g))}));var A=M?void 0:(T?E?ia:Un:E?jr:Ni)(t);return Jl(A||t,(function(c,m){A&&(c=t[m=c]),Pr(_,m,baseClone(c,o,a,m,t,g))})),_};var Ip=function cloneDeep(t){return vp(t,5)};class V2NIMSignallingServiceImpl extends V2Service{constructor(t,o={}){super("V2NIMSignallingService",t),this.config={compatibleWithV1:!0},this.channels={},this.timer=0,this.pollingInterval=12e4,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Ll,cmdConfig:xl}),this.setOptions(o))}reset(){this.timer=0,this.channels={}}setOptions(t){var o;(null===(o=this.core.signaling)||void 0===o?void 0:o.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Object.assign(this.config,t)}call(t){var o;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Fl,t,"",!0),t.calleeAccountId===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"You cannot call yourself"}});var a=void 0!==t.pushConfig&&(void 0!==t.pushConfig.pushEnabled&&t.pushConfig.pushEnabled),c=(yield this.core.sendCmd("v2SignallingCall",{tag:Object.assign(Object.assign({},t),{toAccid:t.calleeAccountId,offlineEnabled:void 0===(null===(o=t.signallingConfig)||void 0===o?void 0:o.offlineEnabled)||t.signallingConfig.offlineEnabled,pushConfig:Object.assign(Object.assign({},t.pushConfig||{}),{pushEnabled:a})})})).content.data;return this.channels[c.channelInfo.channelId]=Ip(c.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),{callStatus:c.callStatus,rtcInfo:c.rtcInfo,roomInfo:{channelInfo:c.channelInfo,members:c.members}}}))}callSetup(t){var o;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Gl,t,"",!0),t.callerAccountId===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"callSetup: cannot be yourself"}});var a=(yield this.core.sendCmd("v2SignallingCallSetup",{tag:Object.assign(Object.assign({},t),{toAccid:t.callerAccountId,offlineEnabled:void 0===(null===(o=t.signallingConfig)||void 0===o?void 0:o.offlineEnabled)||t.signallingConfig.offlineEnabled})})).content.data;return this.channels[a.channelInfo.channelId]=Ip(a.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),{callStatus:a.callStatus,rtcInfo:a.rtcInfo,roomInfo:{channelInfo:a.channelInfo,members:a.members}}}))}createRoom(t,o,a){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(Bl,{channelType:t,channelName:o,channelExtension:a},"",!0),(yield this.core.sendCmd("v2SignallingCreateRoom",{tag:{channelType:t,channelName:o,channelExtension:a}})).content.data.channelInfo}))}delayRoom(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var o=yield this.core.sendCmd("v2SignallingDelayRoom",{tag:{channelId:t}});return{channelInfo:o.content.data.channelInfo,members:o.content.data.members}}))}closeRoom(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(jl,{channelId:t,offlineEnabled:o,serverExtension:a},"",!0),yield this.core.sendCmd("v2SignallingCloseRoom",{tag:{channelId:t,offlineEnabled:void 0!==o&&o,serverExtension:a}})}))}joinRoom(t){var o;return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Yl,t,"",!0);var a=yield this.core.sendCmd("v2SignallingJoinRoom",{tag:Object.assign(Object.assign({},t),{offlineEnabled:void 0===(null===(o=t.signallingConfig)||void 0===o?void 0:o.offlineEnabled)||t.signallingConfig.offlineEnabled})}),c=a.content.data;return this.channels[c.channelInfo.channelId]=Ip(c.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),{channelInfo:a.content.data.channelInfo,members:a.content.data.members}}))}leaveRoom(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Hl,{channelId:t,offlineEnabled:o,serverExtension:a},"",!0),yield this.core.sendCmd("v2SignallingLeaveRoom",{tag:{channelId:t,offlineEnabled:void 0!==o&&o,serverExtension:a}}),delete this.channels[t]}))}invite(t){var o;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate($l,t,"",!0),t.inviteeAccountId===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"invite: cannot be yourself"}});var a=void 0!==t.pushConfig&&(void 0!==t.pushConfig.pushEnabled&&t.pushConfig.pushEnabled);return(yield this.core.sendCmd("v2SignallingInvite",{tag:Object.assign(Object.assign({},t),{toAccid:t.inviteeAccountId,offlineEnabled:void 0===(null===(o=t.signallingConfig)||void 0===o?void 0:o.offlineEnabled)||t.signallingConfig.offlineEnabled,pushConfig:Object.assign(Object.assign({},t.pushConfig||{}),{pushEnabled:a})})})).content.data}))}cancelInvite(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(ql,t,"",!0),(yield this.core.sendCmd("v2SignallingCancelInvite",{tag:Object.assign(Object.assign({},t),{toAccid:t.inviteeAccountId})})).content.data}))}rejectInvite(t){return __awaiter(this,void 0,void 0,(function*(){if(validate(Kl,t,"",!0),t.inviterAccountId===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"rejectInvite: cannot be yourself"}});yield this.core.sendCmd("v2SignallingRejectInvite",{tag:Object.assign(Object.assign({},t),{toAccid:t.inviterAccountId})})}))}acceptInvite(t){return __awaiter(this,void 0,void 0,(function*(){if(validate(Wl,t,"",!0),t.inviterAccountId===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"acceptInvite: cannot be yourself"}});yield this.core.sendCmd("v2SignallingAcceptInvite",{tag:Object.assign(Object.assign({},t),{toAccid:t.inviterAccountId})})}))}sendControl(t,o,a){return __awaiter(this,void 0,void 0,(function*(){validate(zl,{channelId:t,receiverAccountId:o,serverExtension:a},"",!0),yield this.core.sendCmd("v2SignallingSendControl",{tag:{channelId:t,toAccid:o,serverExtension:a}})}))}getRoomInfoByChannelName(t){return __awaiter(this,void 0,void 0,(function*(){validate({channelName:{type:"string",allowEmpty:!1}},{channelName:t},"",!0);var o=yield this.core.sendCmd("v2SignallingGetRoomInfo",{tag:{channelName:t}}),{members:a,channelInfo:c}=o.content.data;return{channelInfo:c,members:a||[]}}))}aotoDelay(){return __awaiter(this,void 0,void 0,(function*(){var t=Object.keys(this.channels);if(0===t.length)return this.timer&&this.core.timerManager.deleteTimer(this.timer),void(this.timer=0);this.logger.log("v2Signlling:autoDelay",t);for(var o=0;o<t.length;o++){var a=t[o];try{var c=yield this.core.sendCmd("v2SignallingDelayRoom",{tag:{channelId:a}});this.channels[a]=c.content.data.channelInfo}catch(t){this.logger.warn(`signling:autoDelay ${a} failed`,t),delete this.channels[a]}}}))}v2SignallingOnlineEventHandler(t){var o=t.content.data,a="number"==typeof Ue(t,"raw.r[0]")?`${t.raw.r[0]}`:"0";!this.config.compatibleWithV1&&a&&parseInt(a)&&this.core.sendCmd("v2SignallingBatchMarkRead",{sid:15,cid:11,ids:[a]}),this.emit("onOnlineEvent",formatSignalingEvent(o))}v2SignallingMultiClientEventHandler(t){this.emit("onMultiClientEvent",formatSignalingEvent(t.content.data))}v2SignallingOfflineEventHandler(t){if(t.content.datas&&t.content.datas.length>0){if(!this.config.compatibleWithV1){var o=t.content.datas.map((t=>t.msgId));o.length>0&&this.core.sendCmd("v2SignallingBatchMarkRead",{sid:15,cid:11,ids:o})}var a=t.content.datas.map((t=>formatSignalingEvent(t)));this.emit("onOfflineEvent",a)}}v2SignallingSyncChannelsHandler(t){if(this.timer=0,this.channels={},t.content.datas&&t.content.datas.length>0){var o=t.content.datas;o.forEach((t=>{var o=t.channelInfo.channelId;this.channels[o]=Ip(t.channelInfo)})),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),this.emit("onSyncRoomInfoList",o)}}}var Ep={attachment:{type:"object",rules:{url:{type:"string",allowEmpty:!1}}},thumbSize:{type:"object",rules:{width:{type:"number",required:!1,min:0},height:{type:"number",required:!1,min:0}}}};class V2NIMStorageUtil extends V2Service{constructor(t){super("V2NIMStorageUtil",t),this.core=t}imageThumbUrl(t,o){return t+`?imageView&thumbnail=${o}z${o}`}videoCoverUrl(t,o){return t+`?vframe&offset=${o}`}getImageThumbUrl(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var a=t;validate(Ep,{attachment:a,thumbSize:o},"",!0),o.width=o.width||0,o.height=o.height||0,0===o.width&&0===o.height&&(o.width=150);var c=a.url;try{c=yield this.core.V2NIMStorageService.shortUrlToLong(a.url)}catch(t){this.core.logger.warn("shortUrlToLong error:",t)}return{url:this.core.cloudStorage.getThumbUrl(c,o)}}))}getVideoCoverUrl(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var a=t;validate(Ep,{attachment:a,thumbSize:o},"",!0),o.width=o.width||0,o.height=o.height||0,0===o.width&&0===o.height&&(o.width=150);var c=a.url;try{c=yield this.core.V2NIMStorageService.shortUrlToLong(a.url)}catch(t){this.core.logger.warn("shortUrlToLong error:",t)}return{url:this.core.cloudStorage.getVideoCoverUrl(c,o)}}))}}var fp={"19_1":"v2PublishEvent","14_2":"v2OnUserStatusChange","19_3":"v2SubscribeUserStatus","19_4":"v2UnsubscribeUserStatus","19_5":"v2UnsubscribeAllUserStatus","19_6":"v2QuerySubscribeEvent","19_7":"v2QueryAllSubscribeEvent","14_9":"v2OnMultiUserStatusChange"},Tp="V2NIMSubscriptionService",Mp={eventType:{id:1,retType:"number"},statusType:{id:2,retType:"number"},uniqueId:3,extension:4,duration:{id:5,retType:"number"},onlineOnly:{id:6,retType:"boolean",converter:t=>t?1:2},multiSync:{id:7,retType:"boolean",converter:boolToInt},publishTime:{id:10,retType:"number"},serverId:11,clientType:{id:12,retType:"number"},serverExtension:13,extensionReceived:14,accountId:103},yp={eventType:{id:1,retType:"number"},duration:{id:2,retType:"number"},immediateSync:{id:3,retType:"number",converter:boolToInt},accountId:102,subscribeTime:{id:105,retType:"number"}},Sp={v2PublishEvent:{sid:19,cid:1,service:Tp,params:[{type:"Property",name:"tag",reflectMapper:Mp}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Mp)}]},v2OnUserStatusChange:{sid:14,cid:2,service:Tp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Mp)}]},v2SubscribeUserStatus:{sid:19,cid:3,service:Tp,params:[{type:"Property",name:"tag",reflectMapper:yp},{type:"StrArray",name:"accountIds"}],response:[{type:"StrArray",name:"failedList"}]},v2UnsubscribeUserStatus:{sid:19,cid:4,service:Tp,params:[{type:"Property",name:"tag",reflectMapper:yp},{type:"StrArray",name:"accountIds"}],response:[{type:"StrArray",name:"failedList"}]},v2UnsubscribeAllUserStatus:{sid:19,cid:5,service:Tp,params:[{type:"Property",name:"tag",reflectMapper:yp}]},v2QuerySubscribeEvent:{sid:19,cid:6,service:Tp,params:[{type:"Property",name:"tag",reflectMapper:yp},{type:"StrArray",name:"accountIds"}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(yp)}]},v2QueryAllSubscribeEvent:{sid:19,cid:7,service:Tp,params:[{type:"Property",name:"tag",reflectMapper:yp}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(yp)}]},v2OnMultiUserStatusChange:{sid:14,cid:9,service:Tp,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Mp)}]}},Np={accountIds:{type:"array",required:!0,itemType:"string",min:1,max:100},duration:{type:"number",required:!1,min:60,max:2592e3},immediateSync:{type:"boolean",required:!1}},Cp={accountIds:{type:"array",required:!1,itemType:"string",max:100}},Ap={statusType:{type:"number",required:!0,min:1e4,max:2147483647},duration:{type:"number",required:!1,min:60,max:604800},extension:{type:"jsonstr",required:!1},onlineOnly:{type:"boolean",required:!1},multiSync:{type:"boolean",required:!1}};class V2NIMSubscriptionServiceImpl extends V2Service{constructor(t){super("V2NIMSubscriptionService",t),"v2"===this.core.options.apiVersion&&registerParser({cmdMap:fp,cmdConfig:Sp})}subscribeUserStatus(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkLogin(),this.checkV2(),validate(Np,t,"",!0),(yield this.core.sendCmd("v2SubscribeUserStatus",{tag:{eventType:1,duration:t.duration||60,immediateSync:void 0!==t.immediateSync&&t.immediateSync},accountIds:t.accountIds})).content.failedList}))}unsubscribeUserStatus(t){return __awaiter(this,void 0,void 0,(function*(){this.checkLogin(),this.checkV2(),validate(Cp,t,"",!0);var o=[];t.accountIds.length>0?o=(yield this.core.sendCmd("v2UnsubscribeUserStatus",{tag:{eventType:1},accountIds:t.accountIds})).content.failedList:(yield this.core.sendCmd("v2UnsubscribeAllUserStatus",{tag:{eventType:1}}),o=[]);return o}))}publishCustomUserStatus(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkLogin(),this.checkV2(),validate(Ap,t,"",!0),(yield this.core.sendCmd("v2PublishEvent",{tag:Object.assign(Object.assign({},t),{eventType:1,uniqueId:Ai(),duration:t.duration||60,onlineOnly:void 0===t.onlineOnly||t.onlineOnly,multiSync:void 0!==t.multiSync&&t.multiSync})})).content.data}))}queryUserStatusSubscriptions(t){return __awaiter(this,void 0,void 0,(function*(){this.checkLogin(),this.checkV2(),validate({accountIds:{type:"array",required:!0,itemType:"string",max:3e3}},{accountIds:t},"",!0);var o=[];if(t.length>0)for(var a=0;a<t.length;a+=100){var c=yield this.core.sendCmd("v2QuerySubscribeEvent",{tag:{eventType:1},accountIds:t.slice(a,a+100)});o=o.concat(c.content.data.map((t=>({accountId:t.accountId,subscribeTime:t.subscribeTime,duration:t.duration}))))}else{var m=yield this.core.sendCmd("v2QueryAllSubscribeEvent",{tag:{eventType:1}});o=o.concat(m.content.data.map((t=>({accountId:t.accountId,subscribeTime:t.subscribeTime,duration:t.duration}))))}return o}))}v2OnUserStatusChangeHandler(t){var o=t.content.data,{eventType:a,extensionReceived:c}=o,m=__rest(o,["eventType","extensionReceived"]);1===a?this.emit("onUserStatusChanged",[Object.assign(Object.assign({},m),{extension:c})]):this.logger.log("v2OnUserStatusChangeHandler eventType = ",a,"msgEvent = ",o)}v2OnMultiUserStatusChangeHandler(t){var o=t.content.data.filter((t=>1===t.eventType)).map((t=>{var{eventType:o,extensionReceived:a}=t,c=__rest(t,["eventType","extensionReceived"]);return Object.assign(Object.assign({},c),{extension:a})}));o.length>0&&this.emit("onUserStatusChanged",o)}}class V2NIMMessageAttachmentCreatorImpl{constructor(){this.name="V2NIMMessageAttachmentCreator"}createLocationMessageAttachment(t,o,a){return{latitude:"number"==typeof t?t:0,longitude:"number"==typeof o?o:0,address:"string"==typeof a?a:""}}createCustomMessageAttachment(t){return{raw:"string"==typeof t?t:""}}}var Op=NIM$1;Op.registerService(V2NIMLoginServiceImpl,"V2NIMLoginService"),Op.registerService(class V2NIMSyncServiceImpl extends V2Service{constructor(t){super("V2NIMSyncService",t),this.teamKey=["teams","superTeams","myTeamMembers","mySuperTeamMembers"],this.config={},this.timetags={},"v2"===this.core.options.apiVersion&&(this.initEventListeners(),registerParser({cmdMap:Uo,cmdConfig:xo}))}reset(){this.timetags={}}setOptions(t){var o=this.core;return this.config=Object.assign({myInfo:!0,offlineMsgs:!!o.V2NIMMessageService.name,roamingMsgs:!!o.V2NIMMessageService.name,relations:!0,friends:!0,friendUsers:!0,msgReceipts:!!o.V2NIMMessageService.name,broadcastMsgs:!!o.V2NIMMessageService.name,recallMsg:!!o.V2NIMMessageService.name,sessionAck:!0,superTeamSessionAck:!!o.V2NIMConversationService.name,superTeamRoamingMsgs:!!o.V2NIMTeamService.name,deleteSuperTeamMsg:!!o.V2NIMTeamService.name,deleteSelfMsgs:!!o.V2NIMMessageService.name,sessionHistoryMsgsDelete:!!o.V2NIMMessageService.name,avSignal:!!o.signaling.name,teams:!!o.V2NIMTeamService.name,superTeams:!!o.V2NIMTeamService.name,myTeamMembers:!!o.V2NIMTeamService.name,mySuperTeamMembers:!!o.V2NIMTeamService.name,p2pTeamModifyMessage:!!o.V2NIMMessageService.name,superTeamModifyMessage:!!o.V2NIMMessageService.name},t),this.config}doBasicSync(){return __awaiter(this,void 0,void 0,(function*(){var t=Object.keys(this.config).filter((t=>!this.teamKey.includes(t)&&this.config[t])),o=this.genSyncParams(t),a=(yield this.core.clientSocket.sendCmd("v2NIMSync",{tag:o})).content.timetag;this.setTimetags(a,t),yield this.delaySyncDone(),yield this.handleImmediate(),this.core.logger.log("sync::basic sync complete in",a)}))}doTeamSync(){return __awaiter(this,void 0,void 0,(function*(){var t=this.teamKey.filter((t=>this.config[t])),o=this.genSyncParams(t);this.core.eventBus.emit("V2NIMTeamService/onSyncStarted");var a=null;try{a=yield this.core.clientSocket.sendCmd("v2NIMSync",{tag:o})}catch(t){throw this.core.eventBus.emit("V2NIMTeamService/onSyncFailed",t),t}this.core.eventBus.emit("V2NIMTeamService/onSyncFinished");var c=a.content.timetag;this.setTimetags(c,this.teamKey),this.core.logger.log("sync::team sync complete in",c)}))}doQchatSync(){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.clientSocket.sendCmd("v2QChatSync",{tag:{systemNotification:0}});this.core.logger.log("sync::qchat sync complete in",t.content.timetag)}))}doSync(){return __awaiter(this,void 0,void 0,(function*(){var t=Ue(this.core,"V2NIMLoginService.authenticator.loginClientOfThisConnection.loginType");if(void 0!==t){if(this.logger.log(`sync::doSync:type ${t}`),this.core.V2NIMLoginService.dataSync.switchDataSync({type:Fe.V2NIM_DATA_SYNC_TYPE_MAIN,state:Ge.V2NIM_DATA_SYNC_STATE_SYNCING}),1===t)try{yield this.doBasicSync(),yield this.doTeamSync()}catch(t){return void this.doSyncComplete(t)}else if(2===t)try{yield this.doQchatSync()}catch(t){return void this.doSyncComplete(t)}else{if(3!==t)return;try{yield this.doBasicSync(),yield this.doTeamSync(),yield this.doQchatSync()}catch(t){return void this.doSyncComplete(t)}}this.doSyncComplete()}else this.logger.warn("sync::doSync: no loginType, stop sync")}))}doSyncComplete(t){t&&this.core.logger.log("sync::doSync complete but got error",t),this.core.V2NIMLoginService.dataSync.switchDataSync({type:Fe.V2NIM_DATA_SYNC_TYPE_MAIN,state:Ge.V2NIM_DATA_SYNC_STATE_COMPLETED,error:t,subType:"mainSync"})}initEventListeners(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.doSync()}))}genSyncParams(t){return t.reduce(((t,o)=>{var a=o;return t[a]=this.timetags[a]||0,t}),{})}setTimetags(t,o){o.forEach((o=>{this.timetags[o]=t}))}handleImmediate(){return this.core.session&&this.core.session.onSyncDone&&this.core.session.onSyncDone(),Promise.resolve()}delaySyncDone(){return"ALI"===getMiniappEnv()?(this.core.logger.log("sync: emit ALIAPP sycnHandler, handle later"),new Promise((t=>{setTimeout((()=>{t()}),100)}))):Promise.resolve()}},"V2NIMSyncService"),Op.registerService(class V2NIMConversationServiceImpl extends V2Service{constructor(t,o={}){super("V2NIMConversationService",t),this.config={},this.core.V2NIMConversationIdUtil=new V2NIMConversationIdUtilImpl(this.core),this.model=new V2NIMConversationModelImpl,this.versionCache=new V2NIMConversationVersionCacheImpl(this.core,this),this.unread=new V2NIMConversationUnreadImpl(this.core,this),"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:os,cmdConfig:ds}),this.setOptions(o),this.setListener())}setOptions(t){this.config=Object.assign(this.config,t)}setListener(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.versionCache.doSync()})),this.core.eventBus.on("V2NIMConversationService/conversationOnlineSyncNotify",((t,o)=>{var a;!1!==(null===(a=null==o?void 0:o.messageConfig)||void 0===a?void 0:a.lastMessageUpdateEnabled)&&(t.content.info=deserialize(t.content.info,mn(cs)),t.content.data=deserialize(t.content.data,mn(as)),o&&(t.content.data.lastMessage=formatLastMessageFromMessage(this.core,o,je.V2NIM_MESSAGE_STATUS_DEFAULT)),t.content.datas=[t.content.data],this.v2ConversationNotifySyncOnlineHandler.call(this,t))})),this.core.eventBus.on("V2NIMConversationService/sendMessage",((t,o)=>{var a,c;o===ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED&&!0===(null===(a=t.messageConfig)||void 0===a?void 0:a.historyEnabled)||!1!==(null===(c=null==t?void 0:t.messageConfig)||void 0===c?void 0:c.lastMessageUpdateEnabled)&&this.versionCache.updateModelWithLastMessage(t.conversationId,t,je.V2NIM_MESSAGE_STATUS_BACKFILL,o)})),this.core.eventBus.on("V2NIMConversationService/deleteMessages",(t=>{var o=t.map((t=>t.messageRefer.conversationId));this.versionCache.backfillLastMsg(o,!0)})),this.core.eventBus.on("V2NIMConversationService/revokeMessages",(t=>{this.versionCache.updateModelByRevoke(t)})),this.core.eventBus.on("V2NIMConversationService/checkBackFill",(t=>{this.versionCache.backfillLastMsg(t,!1)})),this.core.eventBus.on("V2NIMConversationService/setMute",((t,o)=>{var a=this.model.getById(t);a&&a.mute!==o&&(a.mute=o,this.model.upsert(a),this.emit("onConversationChanged",[a]))}))}reset(){this.versionCache.reset(),this.model.reset(),this.unread.reset()}getConversationList(t,o){this.checkV2(),validate({offset:{type:"number",min:0}},{offset:t},"",!0),validate({limit:{type:"number",min:1}},{limit:o},"",!0),this.core.V2NIMLoginService.checkIllegalState();var a=this.model.getByOption(t,o,{});return a.conversationList=this.computedFieldForConversations(a.conversationList),Promise.resolve(a)}getConversationListByOption(t,o,a){this.checkV2(),validate({offset:{type:"number",min:0}},{offset:t},"",!0),validate({limit:{type:"number",min:1}},{limit:o},"",!0),validate({option:{type:"object",required:!0,rules:{conversationTypes:{type:"array",itemType:"number",required:!1},onlyUnread:{type:"boolean",required:!1},conversationGroupIds:{type:"array",itemType:"string",required:!1}}}},{option:a},"",!0),this.core.V2NIMLoginService.checkIllegalState();var c=this.model.getByOption(t,o,a);return c.conversationList=this.computedFieldForConversations(c.conversationList),Promise.resolve(c)}getConversation(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,t),this.core.V2NIMLoginService.checkIllegalState();var o=this.model.getById(t);if(o)return this.computedFieldForConversation(o);throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST})}))}getConversationListByIds(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:t},"",!0),this.core.V2NIMLoginService.checkIllegalState();var o=t.map((t=>this.model.getById(t))).filter((t=>!!t));return o=this.computedFieldForConversations(o)}))}createConversation(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,t);var o=yield this.core.sendCmd("v2ConversationCreate",{tag:{conversationId:t}}),a=Ue(o,"content.data"),c=formatConversationField(this.core,a);this.versionCache.compareAndUpdateModel([c]);var m=this.model.getById(t);if(m)return this.computedFieldForConversation(m);throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST})}))}deleteConversation(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,t),validate({clearMessage:{type:"boolean",required:!1}},{clearMessage:o},"",!0);try{yield this.core.sendCmd("v2ConversationDelete",{tag:{conversationId:t,clearMessage:Number(o||!1)}})}catch(o){if(o.code!==wt.V2NIM_ERROR_CODE_CONVERSATION_NOT_EXIST||!this.model.getById(t))throw o}o&&this.core.eventBus.emit("V2NIMConversationService/deleteConversation",[t]),this.versionCache.compareAndDeleteModel([t])}))}deleteConversationListByIds(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:t},"",!0),validate({clearMessage:{type:"boolean",required:!1}},{clearMessage:o},"",!0);var a=yield this.core.sendCmd("v2ConversationsDelete",{tag:{conversationIds:JSON.stringify(t),clearMessage:Number(o||!1)}}),c=formatFailedMap(Ue(a,"content.info.failedMap")).filter((t=>t.error.code!==wt.V2NIM_ERROR_CODE_CONVERSATION_NOT_EXIST||!this.model.getById(t.conversationId)));return o&&this.core.eventBus.emit("V2NIMConversationService/deleteConversation",t),this.versionCache.compareAndDeleteModel(t),c}))}stickTopConversation(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,t),validate({stickTop:{type:"boolean"}},{stickTop:o},"",!0);var a=yield this.core.sendCmd("v2ConversationSetTop",{tag:{conversationId:t,stickTop:Number(o)}}),c=Ue(a,"content.data"),m=formatConversationField(this.core,c);this.versionCache.compareAndUpdateModel([m])}))}updateConversation(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,t),validate({updateInfo:{type:"object",required:!0,rules:{serverExtension:{type:"string"}}}},{updateInfo:o},"",!0);var a=yield this.core.sendCmd("v2ConversationUpdate",{tag:Object.assign({conversationId:t},o)}),c=Ue(a,"content.data"),m=formatConversationField(this.core,c);this.versionCache.compareAndUpdateModel([m])}))}updateConversationLocalExtension(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,t),validate({localExtension:{type:"string"}},{localExtension:o},"",!0);var a=this.model.getById(t);if(!a)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST});if(a.localExtension!==o){var c=Object.assign(Object.assign({},a),{localExtension:o});this.model.upsert(c),this.triggerConversationChanged([c])}}))}getTotalUnreadCount(){return this.checkV2(),this.unread.getTotalUnreadCount()||0}getUnreadCountByIds(t){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:t},"",!0);var o=this.unread.getUnreadCountByIds(t);return Promise.resolve(o)}getUnreadCountByFilter(t){this.checkV2(),this.valiteFilter(t);var o=this.unread.getUnreadCountByFilter(t);return Promise.resolve(o)}clearTotalUnreadCount(){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var t=yield this.core.sendCmd("v2ConversationClearTotalUnread"),o=formatConversationNotify(Ue(t,"content.info"));this.versionCache.compareAndClearUnreadInModel(o.oneClickClearUnreadVersion,o.oneClickClearUnreadType)}))}clearUnreadCountByIds(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:t},"",!0);var o=yield this.core.sendCmd("v2ConversationsUnreadClear",{tag:{conversationIds:JSON.stringify(t)}}),a=formatConversationFields(this.core,Ue(o,"content.datas")),c=formatFailedMap(Ue(o,"content.info.failedMap"));return this.versionCache.compareAndUpdateModel(a),c}))}clearUnreadCountByGroupId(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string"}},{groupId:t},"",!0),yield this.core.sendCmd("v2ConversationClearGroupUnread",{tag:{groupId:t}})}))}clearUnreadCountByTypes(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({types:{type:"array",itemType:"number",min:1}},{types:t},"",!0);var o=yield this.core.sendCmd("v2ConversationClearTypeUnread",{tag:{conversationType:JSON.stringify(t)}}),a=formatConversationNotify(Ue(o,"content.info"));this.versionCache.compareAndClearUnreadInModel(a.oneClickClearUnreadVersion,a.oneClickClearUnreadType,{conversationTypes:a.oneClickClearUnreadConversationType})}))}markConversationRead(t){var o,a;return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),this.checkLogin(),validateConversationId(this.core.account,t);var c=this.model.getById(t);if(!c)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Conversation not exist"}});var m,h=this.core.V2NIMConversationIdUtil.parseConversationTargetId(t),g=this.core.V2NIMConversationIdUtil.parseConversationType(t),_=this.model.getReadTime(t);if(null===(a=null===(o=null==c?void 0:c.lastMessage)||void 0===o?void 0:o.messageRefer)||void 0===a?void 0:a.createTime)m=c.lastMessage.messageRefer.createTime;else{if(!this.core.timeOrigin.checkNodeReliable())return this.logger.log("markConversationRead","NTP time is not reliable",t),_||0;m=this.core.timeOrigin.getNTPTime()}return _>=m?(this.logger.log("markConversationRead","currentReadTime >= readTime",t,_,m),_):(g===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?yield this.core.sendCmd("v2MarkSuperTeamReadTime",{timetag:m,to:h}):yield this.core.sendCmd("v2MarkConversationReadTime",{scene:g===Be.V2NIM_CONVERSATION_TYPE_P2P?0:g===Be.V2NIM_CONVERSATION_TYPE_TEAM?1:2,timetag:m,to:h}),this.model.updateReadTime(t,m),m)}))}getConversationReadTime(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validateConversationId(this.core.account,t),this.model.getReadTime(t)}))}subscribeUnreadCountByFilter(t){var o;this.checkV2(),this.checkLogin(),this.valiteFilter(t),0===(null===(o=t.conversationTypes)||void 0===o?void 0:o.length)&&delete t.conversationTypes,this.unread.addFilter(t)}unsubscribeUnreadCountByFilter(t){var o;this.checkV2(),this.checkLogin(),this.valiteFilter(t),0===(null===(o=t.conversationTypes)||void 0===o?void 0:o.length)&&delete t.conversationTypes,this.unread.deleteFilter(t)}v2ConversationNotifySyncHandler(t){this.versionCache.recvConversationFromSyncAction(t)}v2ConversationNotifySyncOnlineHandler(t){this.versionCache.recvConversation(t)}syncConversationReadTimeHandler(t){var o,a,c;if(null===(o=null==t?void 0:t.content)||void 0===o?void 0:o.p2p)for(var[m,h]of Object.entries(t.content.p2p))this.model.updateReadTime(this.core.V2NIMConversationIdUtil.p2pConversationId(m),h),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.p2pConversationId(m),h);if(null===(c=null===(a=null==t?void 0:t.content)||void 0===a?void 0:a.team)||void 0===c?void 0:c.m_map)for(var[g,_]of Object.entries(t.content.team.m_map))this.model.updateReadTime(this.core.V2NIMConversationIdUtil.teamConversationId(g),_),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.teamConversationId(g),_)}syncSuperTeamReadTimeHandler(t){var o,a;if(null===(a=null===(o=null==t?void 0:t.content)||void 0===o?void 0:o.superTeam)||void 0===a?void 0:a.m_map)for(var[c,m]of Object.entries(t.content.superTeam.m_map))this.model.updateReadTime(this.core.V2NIMConversationIdUtil.superTeamConversationId(c),m),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.superTeamConversationId(c),m)}v2MultiDeviceConversationReadTimeHandler(t){var o;(null===(o=null==t?void 0:t.content)||void 0===o?void 0:o.to)&&(0===t.content.scene?(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.p2pConversationId(t.content.to),t.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.p2pConversationId(t.content.to),t.content.timetag)):(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.teamConversationId(t.content.to),t.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.teamConversationId(t.content.to),t.content.timetag)))}v2MultiDeviceSuperTeamReadTimeHandler(t){var o;(null===(o=null==t?void 0:t.content)||void 0===o?void 0:o.to)&&(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.superTeamConversationId(t.content.to),t.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.superTeamConversationId(t.content.to),t.content.timetag))}valiteFilter(t){if(validate({filter:{type:"object",required:!0,rules:{conversationTypes:{type:"array",itemType:"number",required:!1},conversationGroupId:{type:"string",allowEmpty:!1,required:!1},ignoreMuted:{type:"boolean",required:!1}}}},{filter:t},"",!0),void 0===t.conversationTypes&&void 0===t.conversationGroupId&&!0!==t.ignoreMuted)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Filter cannot be empty"}})}computedFieldForConversations(t){return t.map((t=>this.computedFieldForConversation(t)))}computedFieldForConversation(t){var o,a,c,m;if(t.type===Be.V2NIM_CONVERSATION_TYPE_UNKNOWN)return t;var h=this.core.V2NIMConversationIdUtil.parseConversationType(t.conversationId),g=this.core.V2NIMConversationIdUtil.parseConversationTargetId(t.conversationId),_={};if((null===(o=this.core.V2NIMSettingService)||void 0===o?void 0:o.name)&&(_.mute=this.core.V2NIMSettingService.getConversationMuteStatus(t.conversationId)),h===Be.V2NIM_CONVERSATION_TYPE_P2P&&(null===(a=this.core.V2NIMUserService)||void 0===a?void 0:a.name)){var I=this.core.V2NIMUserService.model.getUser(g),E=this.core.V2NIMFriendService.model.getFriend(g);_.name=(null==E?void 0:E.alias)||(null==I?void 0:I.name)||g,_.avatar=(null==I?void 0:I.avatar)||""}else if(h===Be.V2NIM_CONVERSATION_TYPE_TEAM&&(null===(c=this.core.V2NIMTeamService)||void 0===c?void 0:c.name)){var T=this.core.V2NIMTeamService.model.getById(g,_t.V2NIM_TEAM_TYPE_ADVANCED);_.name=(null==T?void 0:T.name)||g,_.avatar=(null==T?void 0:T.avatar)||""}else if(h===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM&&(null===(m=this.core.V2NIMTeamService)||void 0===m?void 0:m.name)){var M=this.core.V2NIMTeamService.model.getById(g,_t.V2NIM_TEAM_TYPE_SUPER);_.name=(null==M?void 0:M.name)||g,_.avatar=(null==M?void 0:M.avatar)||""}return Object.assign(t,_),t}triggerConversationChanged(t){t=this.computedFieldForConversations(t),(t=JSON.parse(JSON.stringify(t))).forEach((t=>{t.lastMessage||(t.lastMessage=void 0),delete t.lastMessageState})),this.emit("onConversationChanged",t)}triggerConversationCreated(t){t=this.computedFieldForConversation(t),delete(t=JSON.parse(JSON.stringify(t))).lastMessageState,this.emit("onConversationCreated",t)}},"V2NIMConversationService"),Op.registerService(class V2NIMMessageServiceImpl extends V2Service{constructor(t,o={}){super("V2NIMMessageService",t),this.config={compatibleWithV1:!0},this.emitRevokeMessage=t=>{var o=t.map((t=>formatRevokeMessage(this.core,t)));o.forEach((t=>{this.model.deleteMessage(t.messageRefer.messageClientId)})),this.emit("onMessageRevokeNotifications",o),this.core.eventBus.emit("V2NIMConversationService/revokeMessages",o)},this.sendMessageHandler=t=>{if(t.msgAckSnapshot){var o=t.msgAckSnapshot,a={conversationId:t.conversationId,messageServerId:t.messageServerId,messageClientId:t.messageClientId,readCount:0,unreadCount:Number(o)};delete t.msgAckSnapshot,this.emit("onReceiveTeamMessageReadReceipts",[a])}t=formatMessageAttachment(t,this.core),this.model.upsertMessages([t]),this.core.eventBus.emit("V2NIMConversationService/sendMessage",t,t.sendingState)},this.revokeMessagesHandler=t=>{t.forEach((t=>{this.model.deleteMessage(t.messageRefer.messageClientId)})),this.emit("onMessageRevokeNotifications",t),this.core.eventBus.emit("V2NIMConversationService/revokeMessages",t)},this.deleteMessagesHandler=t=>{t.forEach((t=>{this.model.deleteMessage(t.messageRefer.messageClientId)})),this.emit("onMessageDeletedNotifications",t),this.core.eventBus.emit("V2NIMConversationService/deleteMessages",t)},this.core.V2NIMMessageCreator=new V2NIMMessageCreatorImpl(this.core),this.core.V2NIMClientAntispamUtil=new V2NIMClientAntispamUtilImpl(this.core),this.receiptUtil=new ReceiptUtil(this.core,this),this.fileUtil=new FileUtil(this.core,this),this.sendUtil=new SendUtil(this.core,this),this.modifyUtil=new ModifyUtil(this.core,this),this.model=new V2NIMMessageModel,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Wo,cmdConfig:rs}),this.setOptions(o),this.setListener())}setOptions(t){var o;(null===(o=this.core.msg)||void 0===o?void 0:o.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Object.assign(this.config,t)}setListener(){this.core.eventBus.on("forwardReceive/V2NIMMessageService/sendMsg",this.sendMessageHandler),this.core.eventBus.on("forwardReceive/V2NIMMessageService/revokeMessages",this.emitRevokeMessage),this.core.eventBus.on("forwardReceive/V2NIMMessageService/deleteMessages",this.deleteMessagesHandler),this.core.eventBus.on("V2NIMConversationService/deleteConversation",(t=>{t.forEach((t=>this.model.deleteMessages(t)))}))}reset(){this.model.reset()}getMessageList(t){return this.checkV2(),this.core.V2NIMMessageLogUtil.getMessageList(t)}getMessageListByRefers(t){return this.checkV2(),this.core.V2NIMMessageLogUtil.getMessageListByRefers(t)}clearHistoryMessage(t){return this.checkV2(),this.core.V2NIMMessageLogUtil.clearHistoryMessage(t)}pinMessage(t,o){return this.checkV2(),this.core.V2NIMMessageExtendUtil.pinMessage(t,o)}unpinMessage(t,o){return this.checkV2(),this.core.V2NIMMessageExtendUtil.unpinMessage(t,o)}updatePinMessage(t,o){return this.checkV2(),this.core.V2NIMMessageExtendUtil.updatePinMessage(t,o)}voiceToText(t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.voiceToText(t)}getPinnedMessageList(t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.getPinnedMessageList(t)}addQuickComment(t,o,a,c){return this.checkV2(),this.core.V2NIMMessageExtendUtil.addQuickComment(t,o,a,c)}removeQuickComment(t,o,a){return this.checkV2(),this.core.V2NIMMessageExtendUtil.removeQuickComment(t,o,a)}getQuickCommentList(t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.getQuickCommentList(t)}addCollection(t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.addCollection(t)}removeCollections(t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.removeCollections(t)}updateCollectionExtension(t,o){return this.checkV2(),this.core.V2NIMMessageExtendUtil.updateCollectionExtension(t,o)}getCollectionListByOption(t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.getCollectionListByOption(t)}searchCloudMessages(t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.searchCloudMessages(t)}getThreadMessageList(t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.getThreadMessageList(t)}sendP2PMessageReceipt(t){return this.checkV2(),this.receiptUtil.sendP2PMessageReceipt(t)}isPeerRead(t){return this.checkV2(),this.receiptUtil.isPeerRead(t)}getP2PMessageReceipt(t){return this.checkV2(),this.receiptUtil.getP2PMessageReceipt(t)}getTeamMessageReceipts(t){return this.checkV2(),this.receiptUtil.getTeamMessageReceipts(t)}getTeamMessageReceiptDetail(t){return this.checkV2(),this.receiptUtil.getTeamMessageReceiptDetail(t)}sendTeamMessageReceipts(t){return this.checkV2(),this.receiptUtil.sendTeamMessageReceipts(t)}revokeMessage(t,o){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Ms,{message:t,params:o},"",!0),validateConversationId(this.core.account,t.conversationId),t.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P&&t.senderId!==this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"revokeMessage: p2p message senderId is not current user"}});if(!t.messageServerId||"0"===t.messageServerId)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"revokeMessage: cannot revoke message with invalid messageServerId: "+t.messageServerId}});var a=t.conversationType===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?"v2RevokeSuperTeamMessage":"v2RevokeMessage",c={[Be.V2NIM_CONVERSATION_TYPE_P2P]:ut.P2P_DELETE_MSG,[Be.V2NIM_CONVERSATION_TYPE_TEAM]:ut.TEAM_DELETE_MSG,[Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM]:ut.SUPERTEAM_DELETE_MSG},m=Object.assign(Object.assign(Object.assign({},t),o),{attach:o&&o.serverExtension,sysMsgType:c[t.conversationType],opeAccount:this.core.account});yield this.core.sendCmd(a,{tag:m});var h={[Be.V2NIM_CONVERSATION_TYPE_P2P]:at.V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY,[Be.V2NIM_CONVERSATION_TYPE_TEAM]:at.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY,[Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM]:at.V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY},g=[JSON.parse(JSON.stringify({postscript:o&&o.postscript,revokeType:h[t.conversationType],revokeAccountId:this.core.account,serverExtension:o&&o.serverExtension,messageRefer:formatMessageRefer(this.core,t)}))];this.revokeMessagesHandler(g),this.core.eventBus.emit("forwardSend/V2NIMMessageService/revokeMessage",m)}))}deleteMessage(t,o){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Cs,t,"",!0),t.sendingState===ot.V2NIM_MESSAGE_SENDING_STATE_SENDING)this.fileUtil.cancelMessageAttachmentUpload(t);else if(t.sendingState&&t.sendingState!==ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessage: cannot delete unsent message"}});var a={messageRefer:formatMessageRefer(this.core,t),serverExtension:o},c=Date.now();t.messageServerId&&"0"!==t.messageServerId&&(c=(yield this.core.sendCmd("v2DeleteMessage",{tag:a})).content.timetag);var m=[{serverExtension:o,messageRefer:formatMessageRefer(this.core,t),deleteTime:c}];this.core.eventBus.emit("forwardSend/V2NIMMessageService/deleteSelfMsgs",[Object.assign(Object.assign({},a),{deleteTime:c})]),this.deleteMessagesHandler(m)}))}deleteMessages(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(As,{messages:t},"",!0);var a=[],c=[];if(0===t.length)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessages: message array length is 0"}});for(var m=t[0].conversationId,h=0;h<t.length;h++){if(t[h].sendingState===ot.V2NIM_MESSAGE_SENDING_STATE_SENDING)this.fileUtil.cancelMessageAttachmentUpload(t[h]);else if(t[h].sendingState&&t[h].sendingState!==ot.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:`deleteMessage: sendingState should be succeeded, please check message at index: ${h}`}});if(h>=1&&t[h].conversationId!==m)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessages: only allow to delete messages from same conversation"}});t[h].messageServerId&&"0"!==t[h].messageServerId?a.push(t[h]):c.push(t[h])}var g=Date.now(),_=[...c];try{if(a.length>0){var I=yield this.core.sendCmd("v2DeleteMessages",{tag:a.map((t=>({messageRefer:t,serverExtension:o})))});g=I.content.timetag,_=[..._,...a]}}catch(t){if(0===c.length)throw t;this.logger.warn("V2NIMMessageService:deleteMessages: delete messages with serverId failed")}var E=_.map((t=>({serverExtension:o,messageRefer:formatMessageRefer(this.core,t),deleteTime:g})));this.core.eventBus.emit("forwardSend/V2NIMMessageService/deleteSelfMsgs",_.map((t=>({messageRefer:t,serverExtension:o,deleteTime:g})))),this.deleteMessagesHandler(E)}))}cancelMessageAttachmentUpload(t){return this.checkV2(),this.fileUtil.cancelMessageAttachmentUpload(t)}markMsgsAck(t){if(t&&t.length>0){var o=[],a=[];t.forEach((t=>{t.senderId===this.core.account&&t.senderId!==t.receiverId||(t.conversationType===Be.V2NIM_CONVERSATION_TYPE_P2P?o.push(t):t.conversationType===Be.V2NIM_CONVERSATION_TYPE_TEAM&&a.push(t))})),o.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:7,cid:2,ids:o.map((t=>t.messageServerId))}),a.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:8,cid:3,ids:a.map((t=>t.messageServerId))})}}onMsgHandler(t){var o=t.content.msg,{_conversationOnlineSyncNotify:a,_conversationOnlineSyncData:c}=o,m=__rest(o,["_conversationOnlineSyncNotify","_conversationOnlineSyncData"]),h=completeMessage(this.core,m),g=formatMessageAttachment(h,this.core);g.messageType!==rt.V2NIM_MESSAGE_TYPE_NOTIFICATION&&this.core.V2NIMUserService.checkUserUpdate(g,g.userUpdateTime),!this.config.compatibleWithV1&&this.sendUtil.doMsgReceiveReport(g,t),delete g.__clientExt,this.emit("onReceiveMessages",[g]),this.model.upsertMessages([g]),!this.config.compatibleWithV1&&this.markMsgsAck([g]),a&&this.core.eventBus.emit("V2NIMConversationService/conversationOnlineSyncNotify",{content:{info:JSON.parse(a),data:JSON.parse(c)}},g),g.messageType===rt.V2NIM_MESSAGE_TYPE_NOTIFICATION&&this.core.eventBus.emit("V2NIMTeamService/notification",h)}syncOfflineMsgsHandler(t){var o=t.content.data,a=0;o=o.map((t=>(t.createTime>a&&(a=t.createTime),formatMessageAttachment(completeMessage(this.core,t),this.core)))),!this.config.compatibleWithV1&&this.markMsgsAck(o),this.emit("onReceiveMessages",o),this.model.upsertMessages(o),this.core.eventBus.emit("V2NIMConversationService/checkBackFill",o.map((t=>t.conversationId)))}syncRoamingMsgsHandler(t){var o=t.content.data;o=o.map((t=>formatMessageAttachment(completeMessage(this.core,t),this.core))),this.emit("onReceiveMessages",o),this.model.upsertMessages(o),this.core.eventBus.emit("V2NIMConversationService/checkBackFill",o.map((t=>t.conversationId)))}onP2PMessageReceiptsHandler(t){this.receiptUtil.onP2PMessageReceiptsHandler(t)}onTeamMessageReceiptsHandler(t){this.receiptUtil.onTeamMessageReceiptsHandler(t)}syncP2PMessagReceiptsHandler(t){this.receiptUtil.syncP2PMessagReceiptsHandler(t)}syncRevokeMessageHandler(t){this.emitRevokeMessage(t.content.datas)}onRevokeMessageHandler(t){this.emitRevokeMessage([t.content.data])}onDeleteMessageHandler(t){var o=t.content.data,a={serverExtension:o.serverExtension,deleteTime:o.deleteTime,messageRefer:completeMessageRefer(this.core,o.messageRefer)};this.deleteMessagesHandler([a])}onDeleteMessagesHandler(t){var o=t.content.data.map((t=>({serverExtension:t.serverExtension,deleteTime:t.deleteTime,messageRefer:completeMessageRefer(this.core,t.messageRefer)})));this.deleteMessagesHandler(o)}syncOnDeleteMessagesHandler(t){var o=t.content.datas.map((t=>({serverExtension:t.serverExtension,deleteTime:t.deleteTime,messageRefer:completeMessageRefer(this.core,t.messageRefer)})));this.emit("onMessageDeletedNotifications",o)}sendMessage(t,o,a={},c){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate({message:{type:"object"}},{message:t},"",!0),t.messageClientId=t.messageClientId||Ai(),t.conversationId&&t.conversationId!==o)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message.conversationId is not equal to conversationId"}});validate(Ts,{conversationId:o,message:t,params:a},"",!0),validateConversationId(this.core.account,o);var m=this.core.V2NIMConversationIdUtil.parseConversationType(o);if((m===Be.V2NIM_CONVERSATION_TYPE_TEAM||m===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM)&&a.robotConfig&&!a.robotConfig.accountId)throw new ValidateErrorV2({detail:{reason:"When conversationType is team or superTeam, account is required in robotInfo account is required"}});if(m!==Be.V2NIM_CONVERSATION_TYPE_TEAM&&m!==Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM||!a.targetConfig)a.targetConfig=void 0;else{var h=a.targetConfig.receiverIds;if(m===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM&&!1===a.targetConfig.inclusive)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"setting inclusive to false for super teams is not allowed"}});if(0===(h=h.filter((t=>t&&t!==this.core.account))).length)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"receiverIds cannot be empty or only contain yourself"}});a.targetConfig.receiverIds=h}var g=this.core.timeOrigin.getTimeNode(),{messageBeforeSend:_,clientAntispamResult:I,hiddenParams:E}=this.sendUtil.prepareMessage(t,o,a),T=yield this.sendUtil.doSendMessage({apiCallingTimeNode:g,messageBeforeSend:_,clientAntispamResult:I,hiddenParams:E,progress:c});return T.message.senderId===T.message.receiverId&&this.markMsgsAck([T.message]),T}))}replyMessage(t,o,a={},c){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate({message:{type:"object"}},{message:t},"",!0),t.messageClientId=t.messageClientId||Ai(),validate(fs,{message:t,replyMessage:o,params:a},"",!0),validateConversationId(this.core.account,o.conversationId),(t.conversationType===Be.V2NIM_CONVERSATION_TYPE_TEAM||t.conversationType===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM)&&a.robotConfig&&!a.robotConfig.accountId)throw new ValidateErrorV2({detail:{reason:"When conversationType is team or superTeam, account is required in robotInfo account is required"}});var m=this.core.timeOrigin.getTimeNode(),{messageBeforeSend:h,clientAntispamResult:g,hiddenParams:_}=this.sendUtil.prepareMessage(t,o.conversationId,a,o),I=yield this.sendUtil.doSendMessage({apiCallingTimeNode:m,messageBeforeSend:h,clientAntispamResult:g,hiddenParams:_,progress:c});return I.message.senderId===I.message.receiverId&&this.markMsgsAck([I.message]),I}))}modifyMessage(t,o){this.checkV2(),this.checkLogin(),validate(zs,t,"message",!0),validate(Ks,o,"params",!0),this.modifyUtil.checkIfModify(t,o);var{messageBeforeSend:a,clientAntispamResult:c}=this.modifyUtil.prepareMessage(t,o);return this.modifyUtil.modifyMessage(a,c)}v2MessageOnModifiedHandler(t){var o=completeMessage(this.core,t.content.data);this.model.upsertMessages([o]),this.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",o),this.emit("onReceiveMessagesModified",[o])}v2MessageSyncModifiedHandler(t){var o=t.content.datas.map((t=>completeMessage(this.core,t))).filter((t=>{var o,a=(null===(o=this.model.getMessageById(t.messageClientId))||void 0===o?void 0:o.modifyTime)||0;return(t.modifyTime||0)>a}));o.length>0&&(this.model.upsertMessages(o),o.forEach((t=>this.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",t))),this.emit("onReceiveMessagesModified",o))}v2MessageSyncSuperTeamModifiedHandler(t){this.v2MessageSyncModifiedHandler(t)}},"V2NIMMessageService"),Op.registerService(class V2NIMStorageServiceImpl extends V2Service{constructor(t){super("V2NIMStorageService",t),this.sceneMap={nim_default_profile_icon:{sceneName:"nim_default_profile_icon",expireTime:0},nim_default_im:{sceneName:"nim_default_im",expireTime:0},nim_system_nos_scene:{sceneName:"nim_system_nos_scene",expireTime:0},nim_security:{sceneName:"nim_security",expireTime:0}},this.uploadingMessageInfo={},this.core=t}addCustomStorageScene(t,o){return this.checkV2(),validate({sceneName:{type:"string",allowEmpty:!1},expireTime:{type:"number",min:0}},{sceneName:t,expireTime:o},"",!0),this.sceneMap[t]={sceneName:t,expireTime:o},{sceneName:t,expireTime:o}}getStorageSceneList(){return this.checkV2(),Object.values(this.sceneMap)}getStorageScene(t){return t&&this.sceneMap[t]||this.sceneMap.nim_default_im}hasStorageScene(t){return void 0!==this.sceneMap[t]}createUploadFileTask(t){if(this.checkV2(),"string"==typeof t.fileObj&&0===t.fileObj.indexOf("nim-external")){var o=document.getElementById(t.fileObj);o&&o.files&&o.files[0]&&(t.fileObj=o.files[0])}return{taskId:Ai(),uploadParams:t}}uploadFile(t,o){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate({taskId:{type:"string",allowEmpty:!1}},t,"fileTask",!0),(yield this._uploadFile(t,o))[0]}))}_uploadFile(t,o,a){var c;return __awaiter(this,void 0,void 0,(function*(){if(!this.core.cloudStorage||!this.core.cloudStorage.uploadFile)throw new Error('Service "cloudStorage" does not exist');var{uploadParams:m,taskId:h}=t,{file:g,path:_}=getFileOrPath(m.fileObj),{fileType:I}=a||{};if(this.uploadingMessageInfo[h])throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST,detail:{reason:"V2NIMStorageService.uploadFile: repeat upload"}});try{var E={};g?E.file=g:_&&(0===(null==_?void 0:_.indexOf("nim-external"))?E.fileInput=_:E.filePath=_);var T=this.getStorageScene(m.sceneName);if(E.nosScenes=T.sceneName,E.nosSurvivalTime=T.expireTime,I===rt.V2NIM_MESSAGE_TYPE_IMAGE?E.type="image":I===rt.V2NIM_MESSAGE_TYPE_AUDIO?E.type="audio":I===rt.V2NIM_MESSAGE_TYPE_VIDEO?E.type="video":E.type="file",E.file&&this.core.pluginMap["browser-md5-file"]){var M=yield this.getFileMd5(this.core.pluginMap["browser-md5-file"],h,E.file);E.md5=M}E.onUploadProgress=t=>{"function"==typeof o&&o(100*t.percentage)},E.onUploadStart=t=>{var o;if(null===(o=this.uploadingMessageInfo[h])||void 0===o?void 0:o.abort)return t.abort(),void delete this.uploadingMessageInfo[h];this.uploadingMessageInfo[h]={abort:!1,task:t}},this.uploadingMessageInfo[h]={abort:!1};var S=yield this.core.cloudStorage.uploadFile(E);if(null===(c=this.uploadingMessageInfo[h])||void 0===c?void 0:c.abort)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"upload file aborted"}});return delete this.uploadingMessageInfo[h],[S.url,S]}catch(t){throw delete this.uploadingMessageInfo[h],this.core.logger.error("sendFile:: upload File error or abort.",t),t}}))}cancelUploadFile(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),yield this._cancelUploadFile(t.taskId)}))}_cancelUploadFile(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var o=this.uploadingMessageInfo[t];if(null==o?void 0:o.task)try{this.logger.log("V2NIMStorageService.cancelUploadFile: uploadInfo task exist"),yield o.task.abort(),delete this.uploadingMessageInfo[t]}catch(o){delete this.uploadingMessageInfo[t],this.core.logger.error("cancelMessageAttachmentUpload::abort error.",o)}else{if(!o)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST,detail:{reason:"V2NIMStorageService.cancelUploadFile: uploadInfo not exist"}});this.logger.log("V2NIMStorageService.cancelUploadFile: uploadInfo task not exist"),o.abort=!0}}))}getFileMd5(t,o,a){return __awaiter(this,void 0,void 0,(function*(){return new Promise(((c,m)=>{var h,g=new t;(null===(h=this.uploadingMessageInfo[o])||void 0===h?void 0:h.abort)?m(new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"upload file aborted"}})):this.uploadingMessageInfo[o]={abort:!1,task:g};try{g.md5(a,((t,o)=>{"aborted"===t?m(new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:t}})):t?m(new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"md5 calculate error in callback",rawError:t}})):c(o)}))}catch(t){m(new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"md5 calculate error",rawError:t}}))}}))}))}shortUrlToLong(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.cloudStorage.getOriginUrl(t)}))}getImageThumbUrl(t,o){return __awaiter(this,void 0,void 0,(function*(){return this.core.V2NIMStorageUtil.getImageThumbUrl(t,o)}))}getVideoCoverUrl(t,o){return __awaiter(this,void 0,void 0,(function*(){return this.core.V2NIMStorageUtil.getVideoCoverUrl(t,o)}))}},"V2NIMStorageService"),Op.registerService(class CloudStorageService{constructor(t,o={}){this.config={},this.uploadTaskMap={},this.name="cloudStorage",this.logger=t.logger,this.core=t,this.nos=new NOS(t,this),this.mixStorage=new MixStorage(t,this),this.aws=new AWS(t,this),registerParser({cmdMap:oa,cmdConfig:aa}),this.setOptions(o),this.setListeners()}setOptions(t={}){var o=t.storageKeyPrefix||"NIMClient";this.mixStorage.GRAYKEY=o+"-AllGrayscaleConfig",this.mixStorage.MIXSTOREKEY=o+"-AllMixStorePolicy";var{s3:a}=t,c=__rest(t,["s3"]),m=Object.assign({},Zs,this.config);if(c&&Object.prototype.hasOwnProperty.call(c,"cdn")){var h=Object.assign(Object.assign({},m.cdn),c.cdn);this.config=Object.assign({},m,c),this.config.cdn=h}else this.config=Object.assign({},m,c);a&&(this.aws.s3=a)}setListeners(){this.core.eventBus.on("kicked",this._clearUnCompleteTask.bind(this)),this.core.eventBus.on("disconnect",this._clearUnCompleteTask.bind(this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLogout",this._clearUnCompleteTask.bind(this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleKicked",this._clearUnCompleteTask.bind(this))}_clearUnCompleteTask(){Object.keys(this.uploadTaskMap).forEach((t=>{var o=this.uploadTaskMap[t];o&&o.abort&&o.abort()})),this.uploadTaskMap={}}init(){return __awaiter(this,void 0,void 0,(function*(){this.mixStorage.reset(),this.nos.reset(),this.config.isNeedToGetUploadPolicyFromServer&&(yield this.mixStorage.getGrayscaleConfig(this.core.options.appkey)),yield this.nos._getNosCdnHost()}))}processCallback(t,o){var a=t.onUploadProgress,c=t.onUploadDone,m=t.onUploadStart;return{onUploadStart:"function"==typeof m?t=>{this.uploadTaskMap[o]=t;try{m(t)}catch(t){this.logger.error("CloudStorage::uploadFile:options.onUploadStart execute error",t)}}:t=>{this.uploadTaskMap[o]=t},onUploadProgress:"function"==typeof a?t=>{this.core.reporterHookCloudStorage.update({transferred_size:t.loaded});try{a(t)}catch(t){this.logger.error("CloudStorage::uploadFile:options.onUploadProgress execute error",t)}}:t=>{this.core.reporterHookCloudStorage.update({transferred_size:t.loaded})},onUploadDone:"function"==typeof c?t=>{this.core.reporterHookCloudStorage.end(0);try{c(t)}catch(t){this.logger.error("CloudStorage::uploadFile:options.onUploadDone execute error",t)}}:()=>{this.core.reporterHookCloudStorage.end(0)},taskKey:o}}uploadFile(t){return __awaiter(this,void 0,void 0,(function*(){if(validate({maxSize:{type:"number",required:!1},type:{type:"enum",values:["file","image","audio","video"]}},t),!t.fileInput&&!t.file&&!t.filePath)throw new Error("uploadFile needs target file object or a filePath");if(t.type&&"file"!==t.type){var o=Ue(t,"file.type");if(o&&"string"==typeof o&&-1===o.indexOf(t.type))throw new Error(`The meta type "${o}" does not match "${t.type}"`)}if(this.core.reporterHookCloudStorage.start(),t.file)this.core.reporterHookCloudStorage.update({full_size:t.file.size});else if("string"==typeof t.fileInput){var a=document.getElementById(t.fileInput);a&&a.files&&a.files[0]&&this.core.reporterHookCloudStorage.update({full_size:a.files[0].size})}else t.fileInput&&t.fileInput.files&&t.fileInput.files[0]&&this.core.reporterHookCloudStorage.update({full_size:t.fileInput.files[0].size});var c=Ai(),{onUploadStart:m,onUploadProgress:h,onUploadDone:g}=this.processCallback(t,c);t.onUploadStart=m,t.onUploadProgress=h,t.onUploadDone=g;var _=null;try{_=yield this._uploadFile(t),t.md5&&(_.md5=t.md5),delete this.uploadTaskMap[c]}catch(t){throw delete this.uploadTaskMap[c],this.core.reporterHookCloudStorage.end((t&&t.code)===wt.V2NIM_ERROR_CODE_CANCELLED?3:1),t}return _&&(_.size=void 0===_.size?void 0:Number(_.size),_.w=void 0===_.w?void 0:Number(_.w),_.h=void 0===_.h?void 0:Number(_.h),_.dur=void 0===_.dur?void 0:Number(_.dur)),_.url=decodeURIComponent(_.url),t.onUploadDone({size:_.size,name:_.name,url:_.url,ext:_.name.split(".")[1]||"unknown"}),_}))}_uploadFile(t){var o,a;return __awaiter(this,void 0,void 0,(function*(){if(!Ue(this.mixStorage,"grayConfig.mixStoreEnable")||!Ue(this.mixStorage,"mixStorePolicy.providers.length"))return this.logger.log("uploadFile:: uploadFile begin, use old nos"),this.nos.nosUpload(t);this.logger.log(`uploadFile::_uploadFile, grayConfig enable:${Ue(this.mixStorage,"grayConfig.mixStoreEnable")} curProvider:${Ue(this.mixStorage,"curProvider")}`);var c=this.core.adapters.getFileUploadInformation(t),m=!0;c?!1===c.complete&&this.mixStorage.curProvider===Ws.s3&&(m=!1):m=!1,this.aws.s3||(this.mixStorage.curProvider=Ws.nos);var h=Qs;if(!m)try{h=(yield this.core.sendCmd("getMixStoreToken",{mixStoreTokenReqTag:{provider:this.mixStorage.curProvider,tokenCount:1,tag:"qchat",nosSurvivalTime:t.nosSurvivalTime,returnBody:getUploadResponseFormat(t.type)}})).content.mixStoreTokenResTag}catch(t){if(this.core.logger.error("uploadFile:: getMixStoreToken error",t),t instanceof V2NIMErrorImpl)throw t;throw new UploadError({code:"v2"===Ue(this.core,"options.apiVersion")?wt.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"getMixStoreToken error",rawError:t,curProvider:this.mixStorage.curProvider,mixStorePolicy:this.mixStorage.mixStorePolicy}})}return m?this.nos.nosUpload(t,null===(a=null===(o=null==c?void 0:c.uploadInfo)||void 0===o?void 0:o.payload)||void 0===a?void 0:a.mixStoreToken):this.mixStorage.curProvider===Ws.s3?this.aws.s3Upload(t,h):this.nos.nosUpload(t,h)}))}getThumbUrl(t,o){var a,c,m,h,g;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(t))return this.logger.error("illegal file url:"+t),t;var[_,I,E,T,M,S,N,C]=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(t);if(null===(a=this.grayConfig)||void 0===a?void 0:a.mixStoreEnable){var A=this._getUrlType(t);if(A===Ws.s3&&this.mixStorePolicy.s3Policy&&Ue(this.mixStorePolicy,"s3Policy.thumbPolicy.imagethumb"))return(null===(m=null===(c=this.mixStorePolicy.s3Policy)||void 0===c?void 0:c.thumbPolicy)||void 0===m?void 0:m.imagethumb).replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",S).replace("{x}",o.width.toString()).replace("{y}",o.height.toString());if(A===Ws.nos&&this.mixStorePolicy.nosPolicy&&Ue(this.mixStorePolicy,"nosPolicy.thumbPolicy.imagethumb"))return(null===(g=null===(h=this.mixStorePolicy.nosPolicy)||void 0===h?void 0:h.thumbPolicy)||void 0===g?void 0:g.imagethumb).replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",S).replace("{x}",o.width.toString()).replace("{y}",o.height.toString())}return t.includes("?")?t+`&imageView&thumbnail=${o.width}x${o.height}`:t+`?imageView&thumbnail=${o.width}x${o.height}`}getVideoCoverUrl(t,o){var a,c,m,h,g;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(t))return this.logger.error("illegal file url:"+t),t;var[_,I,E,T,M,S,N,C]=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(t);if(null===(a=this.grayConfig)||void 0===a?void 0:a.mixStoreEnable){var A=this._getUrlType(t);if(A===Ws.s3&&this.mixStorePolicy.s3Policy&&Ue(this.mixStorePolicy,"s3Policy.thumbPolicy.vframe"))return(null===(m=null===(c=this.mixStorePolicy.s3Policy)||void 0===c?void 0:c.thumbPolicy)||void 0===m?void 0:m.vframe).replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",S).replace("{x}",o.width.toString()).replace("{y}",o.height.toString()).replace("{offset}","0").replace("{type}","png");if(A===Ws.nos&&this.mixStorePolicy.nosPolicy&&Ue(this.mixStorePolicy,"nosPolicy.thumbPolicy.vframe"))return(null===(g=null===(h=this.mixStorePolicy.nosPolicy)||void 0===h?void 0:h.thumbPolicy)||void 0===g?void 0:g.vframe).replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",S).replace("{x}",o.width.toString()).replace("{y}",o.height.toString()).replace("{offset}","0").replace("{type}","png")}return t.includes("?")?t+`&vframe&offset=0&resize=${o.width}x${o.height}&type=png`:t+`?vframe&offset=0&resize=${o.width}x${o.height}&type=png`}getPrivateUrl(t){var o;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(t))return this.logger.error("illegal file url:"+t),"";var[a,c,m,h,g,_,I,E]=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(t);if(null===(o=this.grayConfig)||void 0===o?void 0:o.mixStoreEnable){var T=this._getUrlType(t);return T===Ws.s3&&this.mixStorePolicy.s3Policy&&(t=this.mixStorePolicy.s3Policy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",_)),T===Ws.nos&&this.mixStorePolicy.nosPolicy&&(t=this.mixStorePolicy.nosPolicy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",_)),t}var{downloadUrl:M,downloadHostList:S,nosCdnEnable:N}=this.config,C=this.config.cdn.cdnDomain,A=this.config.cdn.objectNamePrefix?decodeURIComponent(this.config.cdn.objectNamePrefix):"",O=decodeURIComponent(_),R=O.indexOf(A);if(C&&R>-1&&N)return`${c}${C}/${O.slice(R)}`;if(S.includes(h)&&_.includes("/")){var b=_.indexOf("/"),V=_.substring(0,b),P=_.substring(b+1);return M.replace("{bucket}",V).replace("{object}",P)}var k=S.filter((t=>"string"==typeof h&&h.includes(t)))[0],L=k?h.replace(k,"").replace(/\W/g,""):null;return L?M.replace("{bucket}",L).replace("{object}",_):t}getOriginUrl(t){return __awaiter(this,void 0,void 0,(function*(){return"string"==typeof t&&t.includes("_im_url=1")?(yield this.core.sendCmd("getOriginUrl",{nosSafeUrlTag:{safeUrl:t}})).content.nosSafeUrlTag.originUrl:t}))}getFileToken(t){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number",min:2,max:3},urls:{type:"array",required:!1,itemType:"string"}},t);var o=this.mixStorePolicy.nosPolicy?this.mixStorePolicy.nosPolicy.authPolicy.policyType:null,a=this.mixStorePolicy.s3Policy?this.mixStorePolicy.s3Policy.authPolicy.policyType:null;if(o===String(Js.dontNeed)&&a===String(Js.dontNeed))throw this.logger.error("don't need token"),new Error("don't need token");if(t.type===Js.time){if(o&&o.indexOf(String(Js.time))>=0||a&&a.indexOf(String(Js.time))>0)return this.mixStorage.getFileAuthToken(t);throw this.logger.error("don't support time token "),new Error("don't support type time token ")}if(!t.urls||!t.urls.length)throw this.logger.error("urls is required when urls token"),new Error("urls is required when urls token");var c=[],m=[];if(t.urls.forEach((t=>{var o=this._getUrlType(t);o===Ws.nos&&m.push(t),o===Ws.s3&&c.push(t)})),(!a||0!==c.length&&a.indexOf(String(Js.urls))<0)&&(this.logger.warn("s3 url don't support url token"),c=[]),(!o||0!==m.length&&o.indexOf(String(Js.urls))<0)&&(this.logger.warn("nos url don't support url token"),m=[]),0===c.length&&0===m.length)throw this.logger.error("not support urls"),new Error("not support urls");if(0===c.length||0===m.length)return t.urls=JSON.stringify(t.urls),this.mixStorage.getFileAuthToken(t)}))}_getUrlType(t){return this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.nosPolicy.dlcdns.some((o=>t.indexOf(o)>=0))?Ws.nos:this.mixStorePolicy.s3Policy&&this.mixStorePolicy.s3Policy.dlcdns.some((o=>t.indexOf(o)>=0))?Ws.s3:null}getNosAccessToken(t){return validate({url:{type:"string",allowEmpty:!1}},t),this.nos.getNosAccessToken(t)}deleteNosAccessToken(t){return validate({token:{type:"string",allowEmpty:!1}},t),this.nos.deleteNosAccessToken(t)}get grayConfig(){return this.mixStorage.grayConfig}get mixStorePolicy(){return this.mixStorage.mixStorePolicy}process(t){var o=Ue(t,"error.detail.ignore");return t.error&&!o?Promise.reject(t.error):Promise.resolve(t)}},"cloudStorage"),Op.registerService(class V2NIMNotificationServiceImpl extends V2Service{constructor(t,o){super("V2NIMNotificationService",t),this.config={compatibleWithV1:!0},"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:da,cmdConfig:ua}),this.setOptions(o))}setOptions(t){var o;(null===(o=this.core.systemMessage)||void 0===o?void 0:o.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Object.assign(this.config,t)}sendCustomNotification(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,t),validate(ma,{content:o,params:a},"",!0);var c=this.core.V2NIMConversationIdUtil.parseConversationType(t),m=this.core.V2NIMConversationIdUtil.parseConversationTargetId(t),h={[Be.V2NIM_CONVERSATION_TYPE_P2P]:100,[Be.V2NIM_CONVERSATION_TYPE_TEAM]:101,[Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM]:103},g=Date.now(),_=c===Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?"v2SendCustomNotificationWithSuperTeam":"v2SendCustomNotification";yield this.core.sendCmd(_,{tag:Object.assign(Object.assign({},a),{notificationConfig:Object.assign({unreadEnabled:!0,offlineEnabled:!0},null==a?void 0:a.notificationConfig),pushConfig:Object.assign({pushEnabled:!0,pushNickEnabled:!0},null==a?void 0:a.pushConfig),antispamConfig:Object.assign({antispamEnabled:!0},null==a?void 0:a.antispamConfig),routeConfig:Object.assign({routeEnabled:!0},null==a?void 0:a.routeConfig),timestamp:g,type:h[c],receiverId:m,content:o})})}))}processSystemNotification(t){var o=t.type;if(![0,1,2,3,4,15,16,17,18].includes(o)){[5,6].includes(o)&&this.core.eventBus.emit("V2NIMFriendService/sysNotification",t);var a={100:Be.V2NIM_CONVERSATION_TYPE_P2P,101:Be.V2NIM_CONVERSATION_TYPE_TEAM,102:Be.V2NIM_CONVERSATION_TYPE_P2P,103:Be.V2NIM_CONVERSATION_TYPE_SUPER_TEAM},c=Object.assign(Object.assign({},t),{conversationType:a[o]});return delete c.type,c}this.core.eventBus.emit("V2NIMTeamService/sysNotification",t)}markBroadcastMsgAck(t){this.config.compatibleWithV1||this.core.sendCmd("v2BatchMarkRead",{sid:7,cid:17,ids:t.map((t=>t.id))})}syncBroadcastMsgHandler(t){var o=t.content.datas;this.markBroadcastMsgAck(o),this.emit("onReceiveBroadcastNotifications",o)}onBroadcastMsgHandler(t){var o=t.content.data;this.markBroadcastMsgAck([o]),this.emit("onReceiveBroadcastNotifications",[o])}onSysNotificationHandler(t){this.markSysNotificationAck([t.content.data]);var o=this.processSystemNotification(t.content.data);o&&this.emit("onReceiveCustomNotifications",[o])}v2SyncOfflineSysNotificationsHandler(t){this.markSysNotificationAck([t.content.datas]);var o=t.content.datas.sort(((t,o)=>t.timestamp-o.timestamp)).map((t=>this.processSystemNotification(t))).filter((t=>t));o&&this.emit("onReceiveCustomNotifications",o)}v2NotificationRevokeHandler(t){this.markSysNotificationAck([t.content.data])}v2NotificationSyncRevokeHandler(t){var{type:o}=t.content;1===parseInt(o)&&this.markSysNotificationAck(t.content.datas)}markSysNotificationAck(t){if(!this.config.compatibleWithV1){var o=[],a=[],c=[15,16,17,18,103];t.forEach((t=>{t.idServer&&(c.includes(t.type)?a.push(t.idServer):o.push(t.idServer))})),o.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:"7",cid:"3",ids:o}),a.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:"21",cid:"19",ids:a})}}},"V2NIMNotificationService"),Op.registerService(class V2NIMTeamServiceImpl extends V2Service{constructor(t){super("V2NIMTeamService",t),this.notification=new V2NIMTeamNotificationImpl(t,this),this.model=new V2NIMTeamModelImpl,this.memberModel=new V2NIMTeamMemberModelImpl,this.notificationModel=new V2NIMTeamNotificationModelImpl,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Go,cmdConfig:zo}),this.setListener())}setListener(){this.core.eventBus.on("forwardReceive/V2NIMTeamService/created",(t=>{this.model.upsert(t);var o=generateMemberByTeamId(t.teamId,t.teamType,this.core.account,{memberRole:St.V2NIM_TEAM_MEMBER_ROLE_OWNER});this.memberModel.upsert(o),this.emit("onTeamCreated",t)})),this.core.eventBus.on("forwardReceive/V2NIMTeamService/updateSelfTeamMemberInfo",(t=>{this.memberModel.upsert(t),this.emit("onTeamInfoUpdated",[t])})),this.core.eventBus.on("forwardReceive/V2NIMTeamService/updateTeamActionStatus",this.notification.updateTeamActionStatus.bind(this.notification)),this.core.eventBus.on("V2NIMTeamService/sysNotification",this.notification.processSysNotification.bind(this.notification)),this.core.eventBus.on("V2NIMTeamService/notification",this.notification.processNotification.bind(this.notification)),this.core.eventBus.on("V2NIMTeamService/onSyncStarted",(()=>{this.emit("onSyncStarted")})),this.core.eventBus.on("V2NIMTeamService/onSyncFinished",(()=>{this.emit("onSyncFinished")})),this.core.eventBus.on("V2NIMTeamService/onSyncFailed",(t=>{this.emit("onSyncFailed",t)}))}reset(){this.model.reset(),this.memberModel.reset(),this.notificationModel.reset()}createTeam(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({createTeamParams:ga},{createTeamParams:t},"",!0),validate({inviteeAccountIds:Object.assign(Object.assign({},_a),{min:0,required:!1})},{inviteeAccountIds:o},"",!0),validate({antispamConfig:fa},{antispamConfig:c},"",!0);var m=t.teamType===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamCreate":"v2TeamCreate",h=yield this.core.sendCmd(m,{team:t,inviteeAccountIds:o||[],postscript:a||"",antispamConfig:c}),g=h.content.team;this.model.upsert(g);var _=generateMemberByTeamId(g.teamId,g.teamType,this.core.account,{memberRole:St.V2NIM_TEAM_MEMBER_ROLE_OWNER});return this.memberModel.upsert(_),this.emit("onTeamCreated",g),{team:g,failedList:h.content.failedList}}))}updateTeamInfo(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate(Na,{updateTeamInfoParams:a},"",!0),validate({antispamConfig:fa},{antispamConfig:c},"",!0);var m=Object.assign({teamId:t,teamType:o},a),h=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamUpdateInfo":"v2TeamUpdateInfo";yield this.core.sendCmd(h,{team:m,antispamConfig:c}),this.model.upsert(m)}))}leaveTeam(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0);var a=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamLeave":"v2TeamLeave";yield this.core.sendCmd(a,{teamId:t}),this.model.deleteById(t,o)}))}getTeamInfo(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0);var a=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamGetInfo":"v2TeamGetInfo",c=this.model.getById(t,o,!1);if(c)return c;var m=(yield this.core.sendCmd(a,{teamId:t})).content.team;return this.model.upsert(m),m}))}getJoinedTeamList(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Sa,{teamTypes:t},"",!0),this.core.V2NIMLoginService.checkIllegalState(),t&&0!==t.length||(t=[_t.V2NIM_TEAM_TYPE_ADVANCED,_t.V2NIM_TEAM_TYPE_SUPER]);var o=[];return t.forEach((t=>{o=o.concat(this.model.getAll(t))})),o.sort(((t,o)=>t.createTime-o.createTime))}))}getJoinedTeamCount(t){this.checkV2(),validate(Sa,{teamTypes:t},"",!0),this.core.V2NIMLoginService.checkIllegalState(),t&&0!==t.length||(t=[_t.V2NIM_TEAM_TYPE_ADVANCED,_t.V2NIM_TEAM_TYPE_SUPER]);var o=0;return t.forEach((t=>{o+=this.model.count(t)})),o}getTeamInfoByIds(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ma,{teamIds:t},"",!0),validate(ya,{teamType:o},"",!0);var a=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamGetByIds":"v2TeamGetByIds",c=t.map((t=>this.model.getById(t,o,!1))),m=t.filter(((t,o)=>!c[o]));if(0===m.length)return c;var h=(yield this.core.sendCmd(a,{teamIds:m})).content.teams;return c.map(((o,a)=>{if(o)return o;var c=t[a],m=h.find((t=>t.teamId===c));return m&&this.model.upsert(m),m})).filter((t=>!!t))}))}dismissTeam(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0);var a=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamDismiss":"v2TeamDismiss";yield this.core.sendCmd(a,{teamId:t})}))}inviteMember(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate({inviteeAccountIds:_a},{inviteeAccountIds:a},"",!0),validate({postscript:Object.assign(Object.assign({},Ia),{required:!1})},{postscript:c},"",!0);var m=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamInviteMembers":"v2TeamInviteMembers";return(yield this.core.sendCmd(m,{teamId:t,accounts:a,ps:c||""})).content.abortedAccidList}))}acceptInvitation(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Va,t,"invitationInfo",!0),validate(Pa,t,"invitationInfo",!0);var{teamType:o,teamId:a,operatorAccountId:c}=t,m=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamAcceptInvitation":"v2TeamAcceptInvitation";try{var h=yield this.core.sendCmd(m,{teamId:a,from:c});return this.notification.updateTeamActionStatus(t,Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED),h.content.team}catch(o){var g=o;throw this.notification.checkIfExpired(g.code)&&this.notification.updateTeamActionStatus(t,Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED),o}}))}rejectInvitation(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Va,t,"invitationInfo",!0),validate(Pa,t,"invitationInfo",!0),validate({postscript:Object.assign(Object.assign({},Ia),{required:!1})},{postscript:o},"",!0);var{teamType:a,teamId:c,operatorAccountId:m}=t,h=a===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamRejectInvite":"v2TeamRejectInvite";try{yield this.core.sendCmd(h,{teamId:c,from:m,ps:o||""}),this.notification.updateTeamActionStatus(t,Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED)}catch(o){var g=o;throw this.notification.checkIfExpired(g.code)&&this.notification.updateTeamActionStatus(t,Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED),o}}))}kickMember(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate({memberAccountIds:_a},{memberAccountIds:a},"",!0);var c=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamKickMembers":"v2TeamKickMembers";yield this.core.sendCmd(c,{teamId:t,accounts:a})}))}applyJoinTeam(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0);var c=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamApplyToJoin":"v2TeamApplyToJoin";return(yield this.core.sendCmd(c,{teamId:t,ps:a||""})).content.team}))}acceptJoinApplication(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Va,t,"applicationInfo",!0),validate(ka,t,"applicationInfo",!0);var{teamType:o,teamId:a,operatorAccountId:c}=t,m=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamAcceptJoinApplication":"v2TeamAcceptJoinApplication";try{yield this.core.sendCmd(m,{teamId:a,from:c}),this.notification.updateTeamActionStatus(t,Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED)}catch(o){var h=o;throw this.notification.checkIfExpired(h.code)&&this.notification.updateTeamActionStatus(t,Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED),o}}))}rejectJoinApplication(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Va,t,"applicationInfo",!0),validate(ka,t,"applicationInfo",!0),validate({postscript:Object.assign(Object.assign({},Ia),{required:!1})},{postscript:o},"",!0);var{teamType:a,teamId:c,operatorAccountId:m}=t,h=a===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamRejectJoinApplication":"v2TeamRejectJoinApplication";try{yield this.core.sendCmd(h,{teamId:c,from:m,ps:o||""}),this.notification.updateTeamActionStatus(t,Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED)}catch(o){var g=o;throw this.notification.checkIfExpired(g.code)&&this.notification.updateTeamActionStatus(t,Ct.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED),o}}))}updateTeamMemberRole(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate({memberAccountIds:_a},{memberAccountIds:a},"",!0),validate({memberRole:Ca},{memberRole:c},"",!0);var m=c===St.V2NIM_TEAM_MEMBER_ROLE_MANAGER?"AddManagers":"RemoveManagers";m=o===_t.V2NIM_TEAM_TYPE_SUPER?`v2SuperTeam${m}`:`v2Team${m}`,yield this.core.sendCmd(m,{teamId:t,accounts:a})}))}transferTeamOwner(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate({accountId:Ea},{accountId:a},"",!0),validate({leave:{type:"boolean",required:!1}},{leave:c},"",!0);var m=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamTransferOwner":"v2TeamTransferOwner";yield this.core.sendCmd(m,{teamId:t,account:a,leave:c||!1})}))}updateSelfTeamMemberInfo(t,o,a){var c;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate(Aa,{memberInfoParams:a},"",!0),void 0===a.teamNick&&void 0===a.serverExtension)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER});var m=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamUpdateSelfMemberInfo":"v2TeamUpdateSelfMemberInfo",h=Object.assign(Object.assign({},a),{teamId:t,accountId:this.core.account});yield this.core.sendCmd(m,{teamMember:h}),yield this.notification.updateTeamMemberRole(t,o,[this.core.account],h);var g=this.memberModel.getById(t,o,this.core.account);if(null===(c=this.core.V2NIMSettingService)||void 0===c?void 0:c.name){var _=o===_t.V2NIM_TEAM_TYPE_ADVANCED?this.core.V2NIMConversationIdUtil.teamConversationId(t):this.core.V2NIMConversationIdUtil.superTeamConversationId(t),I=this.core.V2NIMSettingService.getConversationMuteStatus(_);this.core.eventBus.emit("V2NIMConversationService/setMute",_,I)}this.core.eventBus.emit("forwardSend/V2NIMTeamService/updateSelfTeamMemberInfo",g)}))}updateTeamMemberNick(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate({accountId:Ea},{accountId:a},"",!0),validate({nick:Ia},{nick:c},"",!0),a===this.core.account)return this.updateSelfTeamMemberInfo(t,o,{teamNick:c});var m=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamUpdateMember":"v2TeamUpdateMember";yield this.core.sendCmd(m,{teamMember:{teamNick:c,teamId:t,accountId:a}})}))}setTeamChatBannedMode(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate(Ra,{chatBannedMode:a},"",!0);var c=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamSetChatBannedMode":"v2TeamSetChatBannedMode";yield this.core.sendCmd(c,{teamId:t,chatBannedMode:a}),this.model.upsert({teamId:t,teamType:o,chatBannedMode:a})}))}setTeamMemberChatBannedStatus(t,o,a,c){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate({accountId:Ea},{accountId:a},"",!0),validate({chatBanned:va},{chatBanned:c},"",!0);var m=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamMemberSetChatBannedStatus":"v2TeamMemberSetChatBannedStatus";yield this.core.sendCmd(m,{teamId:t,accountId:o===_t.V2NIM_TEAM_TYPE_SUPER?[a]:a,chatBanned:c?1:0})}))}getTeamMemberList(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate(ba,{queryOption:a},"",!0);var c=void 0===a.direction?st.V2NIM_QUERY_DIRECTION_DESC:a.direction;c=c===st.V2NIM_QUERY_DIRECTION_DESC?1:0;var m=yield this.core.sendCmd("v2TeamMemberGetList",{tag:Object.assign(Object.assign({teamId:t,teamType:o,onlyChatBanned:!1,nextToken:"",limit:100},a),{direction:c})});return{nextToken:m.content.pageInfo.nextToken||"",finished:!+m.content.pageInfo.hasMore,memberList:processTeamMembers(m.content.datas,o)}}))}getTeamMemberListByIds(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate({accountIds:_a},{accountIds:a},"",!0);for(var c=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamMemberGetListByIds":"v2TeamMemberGetListByIds",m=a.filter((a=>!this.memberModel.getById(t,o,a))).map((o=>`${t}|${o}`)),h=0;h<m.length;h+=20){processTeamMembers((yield this.core.sendCmd(c,{tag:m.slice(h,h+20)})).content.datas,o).forEach((t=>this.memberModel.upsert(t)))}return a.map((a=>this.memberModel.getById(t,o,a))).filter((t=>!!t))}))}getTeamMemberInvitor(t,o,a){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ta,{teamId:t},"",!0),validate(ya,{teamType:o},"",!0),validate({accountIds:_a},{accountIds:a},"",!0);var c=o===_t.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamGetMemberInvitor":"v2TeamGetMemberInvitor";return(yield this.core.sendCmd(c,{teamId:t,accounts:a})).content.accountsMap}))}searchTeamByKeyword(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.checkLogin(),validate({keyword:Ea},{keyword:t},"",!0),this.model.searchTeamByKeyword(t)}))}getTeamJoinActionInfoList(t){return this.checkV2(),validate(La,t,"option",!0),this.core.V2NIMLoginService.checkIllegalState(),Promise.resolve(this.notificationModel.getByOption(t))}v2TeamSyncHandler(t){this.model.set(t.content.datas)}v2SuperTeamSyncHandler(t){this.model.set(t.content.datas)}v2TeamCreateMultiSyncHandler(t){var o=t.content.data;this.model.upsert(o);var a=generateMemberByTeamId(o.teamId,o.teamType,this.core.account,{memberRole:St.V2NIM_TEAM_MEMBER_ROLE_OWNER});this.memberModel.upsert(a),this.emit("onTeamCreated",o)}v2SuperTeamCreateMultiSyncHandler(t){var o=t.content.data;this.model.upsert(o);var a=generateMemberByTeamId(o.teamId,o.teamType,this.core.account,{memberRole:St.V2NIM_TEAM_MEMBER_ROLE_OWNER});this.memberModel.upsert(a),this.emit("onTeamCreated",o)}v2TeamMemberUpdateMultiSyncHandler(t){var o=t.content.data;o.teamType=_t.V2NIM_TEAM_TYPE_ADVANCED;var a=this.memberModel.getById(o.teamId,o.teamType,o.accountId);this.notification.updateTeamMemberRole(o.teamId,o.teamType,[o.accountId],o),o.accountId===this.core.account&&a&&a.bits!==o.bits&&this.core.eventBus.emit("V2NIMSettingService/updateBits",o.teamId,o.teamType,o.bits)}v2SuperTeamMemberUpdateMultiSyncHandler(t){var o=t.content.data;o.teamType=_t.V2NIM_TEAM_TYPE_SUPER;var a=this.memberModel.getById(o.teamId,o.teamType,o.accountId);this.notification.updateTeamMemberRole(o.teamId,o.teamType,[o.accountId],o),o.accountId===this.core.account&&a&&a.bits!==o.bits&&this.core.eventBus.emit("V2NIMSettingService/updateBits",o.teamId,o.teamType,o.bits)}v2TeamMembersOfSelfInSyncHandler(t){var o=t.content.datas;o.forEach((t=>{t.teamType=_t.V2NIM_TEAM_TYPE_ADVANCED})),this.memberModel.setData(o)}v2SuperTeamMembersOfSelfInSyncHandler(t){var o=t.content.datas;o.forEach((t=>{t.teamType=_t.V2NIM_TEAM_TYPE_SUPER})),this.memberModel.setData(o)}},"V2NIMTeamService"),Op.registerService(class V2NIMUserServiceImpl extends V2Service{constructor(t){super("V2NIMUserService",t),registerParser({cmdMap:wa,cmdConfig:xa}),this.model=new V2NIMUserModelImpl,"v2"===this.core.options.apiVersion&&this.setListener()}reset(){this.model.reset()}setListener(){this.core.eventBus.on("forwardReceive/V2NIMUserService/updateBlockList",((t,o)=>{o?this.model.addToBlockList([t]):this.model.removeFromBlockList([t]),o?this.emitBlockListAdded(t):this.emit("onBlockListRemoved",t)})),this.core.eventBus.on("forwardReceive/V2NIMUserService/updateUserProfile",(t=>{this.updateUserProfileInMemory(t)}))}getUserList(t){var o;return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({accountIds:_a},{accountIds:t},"",!0);var a=[];t.forEach((t=>{this.model.getUser(t)||a.push(t)}));var c=null;a.length>0&&(c=yield this.core.sendCmd("v2GetUserList",{accountIds:a})),((null===(o=null==c?void 0:c.content)||void 0===o?void 0:o.data)||[]).forEach((t=>{this.model.setUser(t)}));var m=[];return t.forEach((t=>{var o=this.model.getUser(t);o&&m.push(o)})),m}))}getUserListFromCloud(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({accountIds:{type:"array",min:1,max:500,itemType:"string"}},{accountIds:t},"",!0);var o=(yield this.core.sendCmd("v2GetUserList",{accountIds:t})).content.data||[],a=[];o.forEach((t=>{var o=this.model.getUser(t.accountId);this.compareUserForUpdate(o,t)&&a.push(t),this.model.setUser(t)}));var c=t.reduce(((t,o)=>{var a=this.model.getUser(o);return a&&t.push(a),t}),[]);return a.length>0&&this.emit("onUserProfileChanged",a),c}))}compareUserForUpdate(t,o){return!t||!("number"==typeof t.updateTime&&"number"==typeof o.updateTime&&t.updateTime>=o.updateTime)}updateSelfUserProfile(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ba,t,"",!0);var o=yield this.core.sendCmd("v2UpdateSelfUserProfile",{tag:Object.assign(Object.assign({},t),{accountId:this.core.account})});yield this.updateUserProfileInMemory(Object.assign({updateTime:o.content.updateTime},t))}))}addUserToBlockList(t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),t===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot block yourself"}});validate({accountId:Fa},{accountId:t},"",!0),yield this.core.sendCmd("v2UpdateBlockList",{accountId:t,addToBlockList:!0}),this.model.addToBlockList([t]),this.emitBlockListAdded(t)}))}removeUserFromBlockList(t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),t===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot unblock yourself"}});validate({accountId:Fa},{accountId:t},"",!0),yield this.core.sendCmd("v2UpdateBlockList",{accountId:t,addToBlockList:!1}),this.model.removeFromBlockList([t]),this.emit("onBlockListRemoved",t)}))}searchUserByOption(t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({keyword:{type:"string",allowEmpty:!1},searchName:{type:"boolean",required:!1},searchAccountId:{type:"boolean",required:!1},searchMobile:{type:"boolean",required:!1}},t,"",!0),!1===(void 0===t.searchName||t.searchName)&&!t.searchAccountId&&!t.searchMobile)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"one of searchName, searchAccountId, searchMobile must be true"}});return this.model.getUserListBySearchOption(t)}))}getBlockList(){return this.checkV2(),Promise.resolve(this.model.blockList)}updateUserProfileInMemory(t){return __awaiter(this,void 0,void 0,(function*(){var o=this.model.getUser(this.core.account);o?(Object.assign(o,t),this.model.setUser(o)):o=(yield this.getUserList([this.core.account]))[0];o&&this.emit("onUserProfileChanged",[o])}))}onUpdateUserProfileHandler(t){return __awaiter(this,void 0,void 0,(function*(){var o=t.content.data;yield this.updateUserProfileInMemory(o)}))}onUpdateBlockListHandler(t){var o=t.content.accountId;t.content.addToBlockList?(this.model.addToBlockList([o]),this.emitBlockListAdded(o)):(this.model.removeFromBlockList([o]),this.emit("onBlockListRemoved",o))}syncBlockAndMuteListHandler(t){t.content.data.forEach((t=>{t.isBlock?this.model.addToBlockList([t.accountId]):this.model.setAccountMuteMode(t.accountId,t.isMute?ht.V2NIM_P2P_MESSAGE_MUTE_MODE_ON:ht.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF)}))}v2SyncSelfUserInfoHandler(t){var o=t.content.user;this.model.setUser(o)}checkUserUpdate(t,o){var a=t.senderId;if(a!==this.core.account){var c=this.model.getUser(a);if(c){var m=c.updateTime;"number"==typeof m&&"number"==typeof o&&!isNaN(m)&&!isNaN(o)&&m<o&&this.refreshUserInfo(a)}else this.refreshUserInfo(a)}}refreshUserInfo(t){var o;return __awaiter(this,void 0,void 0,(function*(){var a=yield this.core.sendCmd("v2GetUserList",{accountIds:[t]}),c=(null===(o=null==a?void 0:a.content)||void 0===o?void 0:o.data)||[];for(var m of c)this.model.setUser(m),this.emit("onUserProfileChanged",[m])}))}emitBlockListAdded(t){return __awaiter(this,void 0,void 0,(function*(){var o=yield this.getUserList([t]);1===o.length&&this.emit("onBlockListAdded",o[0])}))}v2OnUpdateMuteListHandler(t){return __awaiter(this,void 0,void 0,(function*(){var{accountId:o,mute:a}=t.content,c=a?ht.V2NIM_P2P_MESSAGE_MUTE_MODE_ON:ht.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF;this.core.eventBus.emit("v2NIMUserService/updateMuteList",o,c)}))}},"V2NIMUserService"),Op.registerService(class V2NIMUFriendServiceImpl extends V2Service{constructor(t){super("V2NIMFriendService",t),this.notification=new V2NIMFriendNotificationImpl(this.core,this),this.model=new V2NIMFriendModelImpl,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Ya,cmdConfig:$a}),this.setListener())}reset(){this.model.reset()}setListener(){this.core.eventBus.on("V2NIMFriendService/sysNotification",this.notification.processSysNotification.bind(this.notification)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/addFriend",this.handleAddFriend.bind(this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/deleteFriend",this.handleDeleteFriend.bind(this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/setFriendInfo",this.handleSetFriendInfo.bind(this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/acceptAddApplication",this.handlePassFriendApply.bind(this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/rejectAddApplication",this.handleRejectFriendApply.bind(this))}addFriend(t,o){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),t===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot add yourself"}});validate(qa,{accountId:t,params:o},"",!0),yield this.core.sendCmd("v2AddFriend",{accountId:t,verifyType:o.addMode,postscript:o.postscript||""}),o.addMode===Ye.V2NIM_FRIEND_MODE_TYPE_ADD&&(yield this.handleAddFriend(t))}))}deleteFriend(t,o){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),t===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot delete yourself"}});validate(za,{accountId:t,params:o},"",!0),yield this.core.sendCmd("v2DeleteFriend",{accountId:t,params:o}),o.deleteAlias&&this.model.upsertFriend(t,{alias:""}),this.handleDeleteFriend(t)}))}acceptAddApplication(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Wa,t,"",!0);try{yield this.core.sendCmd("v2AddFriend",{accountId:t.applicantAccountId,verifyType:ze.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT,postscript:""}),this.handlePassFriendApply(t.applicantAccountId)}catch(o){throw this.handlePassFriendApply(t.applicantAccountId,o),o}}))}rejectAddApplication(t,o){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Wa,t,"",!0);try{yield this.core.sendCmd("v2AddFriend",{accountId:t.applicantAccountId,verifyType:ze.V2NIM_FRIEND_VERIFY_TYPE_REJECT,postscript:o||""}),this.handleRejectFriendApply({applicantAccountId:t.applicantAccountId,recipientAccountId:t.recipientAccountId,operatorAccountId:this.core.account,postscript:o||"",timestamp:this.core.timeOrigin.getNTPTime(),read:!0,status:$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED})}catch(a){throw this.handleRejectFriendApply({applicantAccountId:t.applicantAccountId,recipientAccountId:t.recipientAccountId,operatorAccountId:this.core.account,postscript:o||"",timestamp:this.core.timeOrigin.getNTPTime(),read:!0,status:$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED},a),a}}))}setFriendInfo(t,o){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Ka,{accountId:t,params:o},"",!0),t===this.core.account)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot set yourself"}});yield this.core.sendCmd("v2SetFriendInfo",{tag:Object.assign({accountId:t},o)}),this.handleSetFriendInfo(t,o)}))}getFriendList(){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),Promise.resolve(this.computedFields(this.model.getFriendList()))}))}getFriendByIds(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({accountIds:{type:"array",itemType:"string",required:!0,min:1}},{accountIds:t},"",!0),Promise.resolve(this.computedFields(this.model.getFriendByIds(t)))}))}checkFriend(t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({accountIds:{type:"array",itemType:"string",required:!0,min:1}},{accountIds:t},"",!0);var o={};return t.forEach((t=>{o[t]=!!this.model.getFriend(t)})),Promise.resolve(o)}))}getAddApplicationList(t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate(Ja,t,"",!0),Promise.resolve(this.model.getAddApplicationList(t))}))}setAddApplicationRead(){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),this.model.setAddApplicationRead()}))}getAddApplicationUnreadCount(){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),Promise.resolve(this.model.getAddApplicationUnreadCount())}))}searchFriendByOption(t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({keyword:{type:"string",allowEmpty:!1},searchAccountId:{type:"boolean",required:!1}},t,"",!0),!(void 0===t.searchAlias||t.searchAlias)&&!t.searchAccountId)throw new V2NIMErrorImpl({code:wt.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"searchAlias and searchAccountId cannot be false at the same time"}});return this.computedFields(this.model.getFriendListBySearchOption(t))}))}v2OnAddFriendHandler(t){var{accountId:o,verifyType:a,postscript:c}=t.content;if(a===ze.V2NIM_FRIEND_VERIFY_TYPE_ADD)this.handleAddFriend(o);else if(a===ze.V2NIM_FRIEND_VERIFY_TYPE_APPLY){var m={applicantAccountId:this.core.account,recipientAccountId:o,operatorAccountId:this.core.account,postscript:c,timestamp:this.core.timeOrigin.getNTPTime(),status:$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT,read:!1};this.handleApplyFriend(m)}else if(a===ze.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT)this.handlePassFriendApply(o);else if(a===ze.V2NIM_FRIEND_VERIFY_TYPE_REJECT){var h={applicantAccountId:o,recipientAccountId:this.core.account,operatorAccountId:this.core.account,postscript:c,timestamp:this.core.timeOrigin.getNTPTime(),status:$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED,read:!0};this.handleRejectFriendApply(h)}}v2OnDeleteFriendHandler(t){var{accountId:o}=t.content;this.handleDeleteFriend(o)}v2OnUpdateFriendInfoHandler(t){var{data:o}=t.content,a=this.model.upsertFriend(o.accountId,o);this.emit("onFriendInfoChanged",a)}v2SyncFriendListHandler(t){var{friends:o,timetag:a}=t.content;this.model.setFriendTimetag(a),o.forEach((t=>{t.serverExtension||(t.serverExtension=""),t.customerExtension||(t.customerExtension=""),this.model.upsertFriend(t.accountId,t)}))}v2SyncFriendUserListHandler(t){var{users:o}=t.content;this.core.V2NIMUserService.model&&o.forEach((t=>{this.core.V2NIMUserService.model.setUser(t)}))}handleApplyFriend(t){this.emit("onFriendAddApplication",t)}handleAddFriend(t,o){return __awaiter(this,void 0,void 0,(function*(){this.model.addFriend(t),yield this.incrementSyncFriend();var o=this.model.getFriend(t);o&&this.emit("onFriendAdded",this.computedField(o))}))}handleDeleteFriend(t,o){o=void 0===o?qe.V2NIM_FRIEND_DELETION_TYPE_BY_SELF:o,this.emit("onFriendDeleted",t,o),this.model.deleteFriend(t)}handleSetFriendInfo(t,o){var a=this.model.upsertFriend(t,o);this.emit("onFriendInfoChanged",this.computedField(a))}handlePassFriendApply(t,o){var a=o?null==o?void 0:o.code:200;if(!(a>=19e4||a===wt.V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT))if(200===a||a===wt.V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST)this.model.updateFriendAddApplicationStatus(t,$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED,this.core.account),this.handleAddFriend(t);else{if(a>=500&&a<=599&&509!==a)return;this.model.updateFriendAddApplicationStatus(t,$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED,this.core.account)}}handleRejectFriendApply(t,o){var a=o?null==o?void 0:o.code:200;if(!(a>=19e4||a===wt.V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT))if(200===a)this.emit("onFriendAddRejected",t),this.model.updateFriendAddApplicationStatus(t.applicantAccountId,$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED,this.core.account);else if(a===wt.V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST)this.model.updateFriendAddApplicationStatus(t.applicantAccountId,$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED,this.core.account);else{if(a>=500&&a<=599&&509!==a)return;this.model.updateFriendAddApplicationStatus(t.applicantAccountId,$e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED,this.core.account)}}incrementSyncFriend(){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.sendCmd("v2IncFriendInfo",{timetag:this.model.getFriendTimetag()}),{friends:o,timetag:a}=t.content;this.model.setFriendTimetag(a),o.forEach((t=>{this.model.upsertFriend(t.accountId,t)}))}))}computedFields(t){return t.map((t=>this.computedField(t)))}computedField(t){var o,a,c=null===(a=null===(o=this.core.V2NIMUserService)||void 0===o?void 0:o.model)||void 0===a?void 0:a.getUser(t.accountId);return c?Object.assign({},t,{userProfile:c}):t}},"V2NIMFriendService");export{DataStructureConverterImpl as DataStructureConverter,Op as NIM,V2NIMAIServiceImpl as V2NIMAIService,xt as V2NIMConst,V2NIMConversationGroupServiceImpl as V2NIMConversationGroupService,V2NIMMessageAttachmentCreatorImpl as V2NIMMessageAttachmentCreator,V2NIMMessageConverterImpl as V2NIMMessageConverter,V2NIMMessageExtendUtil,V2NIMMessageLogUtil,V2NIMSettingServiceImpl as V2NIMSettingService,V2NIMSignallingServiceImpl as V2NIMSignallingService,V2NIMStorageUtil,V2NIMSubscriptionServiceImpl as V2NIMSubscriptionService,getAdapter$2 as aliAdapters,getAdapter$1 as baiduAdapters,getAdapter$4 as browserAdapters,setAdapters,getAdapter as ttAdapters,getAdapter$5 as uniAppAdapters,getAdapter$3 as wxAdapters};
