/**
 * 
 *   Version: 10.4.0
 * 
 *   Git Hash: 18a110e8a09523bcccd386391747f378b0b20912
 * 
 *   Created At: 2024/8/21 19:54:23
 * 
 *   Target: NIM_MINIAPP_SDK.js
 *   
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NIM={})}(this,(function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}var r=createCommonjsModule((function(e){var t=Object.prototype.hasOwnProperty,r="~";function Events(){}function EE(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function addListener(e,t,i,n,a){if("function"!=typeof i)throw new TypeError("The listener must be a function");var s=new EE(i,n||e,a),o=r?r+t:t;return e._events[o]?e._events[o].fn?e._events[o]=[e._events[o],s]:e._events[o].push(s):(e._events[o]=s,e._eventsCount++),e}function clearEvent(e,t){0==--e._eventsCount?e._events=new Events:delete e._events[t]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(r=!1)),EventEmitter.prototype.eventNames=function eventNames(){var e,i,n=[];if(0===this._eventsCount)return n;for(i in e=this._events)t.call(e,i)&&n.push(r?i.slice(1):i);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},EventEmitter.prototype.listeners=function listeners(e){var t=r?r+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var n=0,a=i.length,s=new Array(a);n<a;n++)s[n]=i[n].fn;return s},EventEmitter.prototype.listenerCount=function listenerCount(e){var t=r?r+e:e,i=this._events[t];return i?i.fn?1:i.length:0},EventEmitter.prototype.emit=function emit(e,t,i,n,a,s){var o=r?r+e:e;if(!this._events[o])return!1;var c,d,l=this._events[o],m=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),m){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,i),!0;case 4:return l.fn.call(l.context,t,i,n),!0;case 5:return l.fn.call(l.context,t,i,n,a),!0;case 6:return l.fn.call(l.context,t,i,n,a,s),!0}for(d=1,c=new Array(m-1);d<m;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var p,u=l.length;for(d=0;d<u;d++)switch(l[d].once&&this.removeListener(e,l[d].fn,void 0,!0),m){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,t);break;case 3:l[d].fn.call(l[d].context,t,i);break;case 4:l[d].fn.call(l[d].context,t,i,n);break;default:if(!c)for(p=1,c=new Array(m-1);p<m;p++)c[p-1]=arguments[p];l[d].fn.apply(l[d].context,c)}}return!0},EventEmitter.prototype.on=function on(e,t,r){return addListener(this,e,t,r,!1)},EventEmitter.prototype.once=function once(e,t,r){return addListener(this,e,t,r,!0)},EventEmitter.prototype.removeListener=function removeListener(e,t,i,n){var a=r?r+e:e;if(!this._events[a])return this;if(!t)return clearEvent(this,a),this;var s=this._events[a];if(s.fn)s.fn!==t||n&&!s.once||i&&s.context!==i||clearEvent(this,a);else{for(var o=0,c=[],d=s.length;o<d;o++)(s[o].fn!==t||n&&!s[o].once||i&&s[o].context!==i)&&c.push(s[o]);c.length?this._events[a]=1===c.length?c[0]:c:clearEvent(this,a)}return this},EventEmitter.prototype.removeAllListeners=function removeAllListeners(e){var t;return e?(t=r?r+e:e,this._events[t]&&clearEvent(this,t)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=r,EventEmitter.EventEmitter=EventEmitter,e.exports=EventEmitter})),i=createCommonjsModule((function(e,t){e.exports=function(){function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}var e={isDataReportEnable:!0,maxSize:100,msgListMaxSize:1e3,cacheMaxSize:1e3,maxDelay:3e5,maxInterval:3e4,minInterval:1e4,timeout:5e3,autoStart:!0,loginFailIgnoreInterval:6e5},t=function emptyFn(){},r=function(){function Reporter(t){_classCallCheck(this,Reporter),this.isUploadEnable=!1,this.initConfigLoaded=!1,this.loading=!1,this.isDestroyed=!1,this.reportConfig=e,this.traceMsgCache={},this.highPriorityMsgList=[],this.msgList=[],this.lowPriorityMsgList=[],this.cacheMsgList=[],this.lastReportTime=Date.now(),this.timer=null,this.endedAsyncMsgByModule={},this.lastFailLogin={},this.setConfig(t),this.reportConfig.isDataReportEnable&&this.reportConfig.autoStart&&this.initUploadConfig()}return _createClass(Reporter,[{key:"setConfig",value:function setConfig(e){var t=Object.assign({},this.reportConfig.common,e.common);this.reportConfig=Object.assign({},this.reportConfig,e),this.reportConfig.common=t,this.reportConfig.common.sdk_type||(this.reportConfig.common.sdk_type="im")}},{key:"reportImmediately",value:function reportImmediately(e,t){var r=this;this.reportConfig.isDataReportEnable&&this.reportConfig.request(e,Object.assign({dataType:"json",method:"POST",timeout:this.reportConfig.timeout},t)).catch((function(e){var t,i;null===(i=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===i||i.warn("Reporter immediately upload failed",e)}))}},{key:"report",value:function report(t,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i.priority||(i.priority=this.getEventPriority(t,r)),this.reportConfig.isDataReportEnable&&t){if("login"===t&&!1===r.succeed&&r.process_id){var n=this.lastFailLogin[r.process_id]||0;if(r.start_time-n<e.loginFailIgnoreInterval)return;this.lastFailLogin[r.process_id]=r.start_time}var a=Date.now();"HIGH"===i.priority?this.highPriorityMsgList.push({module:t,msg:r,createTime:a}):"NORMAL"===i.priority?this.msgList.push({module:t,msg:r,createTime:a}):"LOW"===i.priority&&this.lowPriorityMsgList.push({module:t,msg:r,createTime:a}),this.highPriorityMsgList.length>this.reportConfig.msgListMaxSize&&this.highPriorityMsgList.shift(),this.msgList.length>this.reportConfig.msgListMaxSize&&this.msgList.shift(),this.lowPriorityMsgList.length>this.reportConfig.msgListMaxSize&&this.lowPriorityMsgList.shift(),this.doReport()}}},{key:"reportTraceStart",value:function reportTraceStart(e,t){if(this.reportConfig.isDataReportEnable&&e&&!this.traceMsgCache[e]){var r=Object.assign(Object.assign({start_time:Date.now()},t),{extension:[]});this.traceMsgCache[e]=r}}},{key:"reportTraceUpdate",value:function reportTraceUpdate(e){}},{key:"reportTraceUpdateV2",value:function reportTraceUpdateV2(e,t,r){var i,n=this;if(this.reportConfig.isDataReportEnable&&this.traceMsgCache[e]){var a=this.traceMsgCache[e].extension,s=a.length,o=(new Date).getTime();0===s?t.duration=o-this.traceMsgCache[e].start_time:a[s-1].end_time?t.duration=o-a[s-1].end_time:t.duration=o-this.traceMsgCache[e].start_time,a.push(Object.assign({end_time:o},t));var c=a.length-1;(null==r?void 0:r.asyncParams)&&((i=this.traceMsgCache[e]).asyncPromiseArray||(i.asyncPromiseArray=[]),this.traceMsgCache[e].asyncPromiseArray.push(r.asyncParams.then((function(t){n.traceMsgCache[e]&&n.traceMsgCache[e].extension[c]&&Object.assign(n.traceMsgCache[e].extension[c],t)}))))}}},{key:"reportTraceEnd",value:function reportTraceEnd(e){var t,r=this,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reportConfig.isDataReportEnable&&this.traceMsgCache[e])if("nos"!==e||!1===i){"boolean"==typeof i?this.traceMsgCache[e].succeed=!!i:this.traceMsgCache[e].state=i,this.traceMsgCache[e].duration=Date.now()-this.traceMsgCache[e].start_time,this.traceMsgCache[e].extension.forEach((function(e){delete e.end_time}));var n=this.traceMsgCache[e];if(this.traceMsgCache[e]=null,n.asyncPromiseArray){(t=this.endedAsyncMsgByModule)[e]||(t[e]=[]),this.endedAsyncMsgByModule[e].push(n);var a=function asyncCallback(){r.endedAsyncMsgByModule[e]&&r.endedAsyncMsgByModule[e].includes(n)&&(delete n.asyncPromiseArray,r.report(e,n,{priority:r.getEventPriority(e,n)}))};Promise.all(n.asyncPromiseArray).then(a).catch(a)}else this.report(e,n,{priority:this.getEventPriority(e,n)})}else this.traceMsgCache[e]=null}},{key:"getEventPriority",value:function getEventPriority(e,t){if("exceptions"===e){if(0===t.action)return"HIGH";if(2===t.action)return"HIGH";if(1===t.action&&0!==t.exception_service)return"HIGH"}else{if("msgReceive"===e)return"LOW";if("nim_api_trace"===e)return"LOW"}return"NORMAL"}},{key:"reportTraceCancel",value:function reportTraceCancel(e){this.reportConfig.isDataReportEnable&&(this.endedAsyncMsgByModule[e]=[],this.traceMsgCache[e]=null)}},{key:"pause",value:function pause(){this.reportConfig.isDataReportEnable&&(this.isUploadEnable=!1)}},{key:"restore",value:function restore(){this.reportConfig.isDataReportEnable&&(this.isUploadEnable=!0,this.initConfigLoaded||this.initUploadConfig())}},{key:"destroy",value:function destroy(){var e=this;this.reportConfig.isDataReportEnable&&(Object.keys(this.traceMsgCache).forEach((function(t){e.reportTraceEnd(t,1)})),null!==this.timer&&clearTimeout(this.timer),this.setConfig=t,this.report=t,this.reportTraceStart=t,this.reportTraceUpdate=t,this.reportTraceEnd=t,this.pause=t,this.restore=t,this.destroy=t,this.cacheMsgList=[],this.traceMsgCache={},this.lowPriorityMsgList=[],this.msgList=[],this.highPriorityMsgList=[],this.reportConfig={},this.isDestroyed=!0)}},{key:"initUploadConfig",value:function initUploadConfig(){var e,t,r=this;if(!this.loading){this.loading=!0;var i=this.reportConfig.common||{};try{this.reportConfig.request(this.reportConfig.reportConfigUrl,{method:"GET",dataType:"json",params:{deviceId:i.dev_id,sdkVer:i.sdk_ver,platform:i.platform,appkey:i.app_key},timeout:this.reportConfig.timeout}).then((function(e){var t,i;if(!r.isDestroyed){if(200===e.status&&e.data&&200===e.data.code){var n=e.data.data||{};r.reportConfig.maxSize=n.maxSize>1e3?1e3:n.maxSize,r.reportConfig.maxInterval=n.maxInterval>1e4?1e4:n.maxInterval,r.reportConfig.maxInterval=n.maxInterval<10?10:n.maxInterval,r.reportConfig.minInterval=n.minInterval<2?2:n.minInterval,r.reportConfig.maxDelay=n.maxDelay||300,r.reportConfig.maxInterval=1e3*r.reportConfig.maxInterval,r.reportConfig.minInterval=1e3*r.reportConfig.minInterval,r.reportConfig.maxDelay=1e3*r.reportConfig.maxDelay,r.isUploadEnable=!0,r.initConfigLoaded=!0,r.loading=!1,r.reportHeartBeat()}null===(i=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===i||i.log("Get reporter upload config success")}})).catch((function(e){var t,i;r.loading=!1,null===(i=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===i||i.error("Get reporter upload config failed",e)}))}catch(r){this.loading=!1,null===(t=null===(e=this.reportConfig)||void 0===e?void 0:e.logger)||void 0===t||t.error("Exec reporter request failed",r)}}}},{key:"reportHeartBeat",value:function reportHeartBeat(){var e=this;this.isDestroyed||(this.timer=setTimeout((function(){e.reportHeartBeat()}),this.reportConfig.minInterval),this.doReport())}},{key:"doReport",value:function doReport(){if(!this.isDestroyed){var e=this.highPriorityMsgList.length+this.msgList.length+this.lowPriorityMsgList.length+this.cacheMsgList.length>2*this.reportConfig.maxSize?this.reportConfig.minInterval:this.reportConfig.maxInterval;Date.now()-this.lastReportTime>=e&&this.upload()}}},{key:"getUploadMsg",value:function getUploadMsg(){var e=this,t={},r=Date.now();this.highPriorityMsgList=this.highPriorityMsgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay})),this.msgList=this.msgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay})),this.lowPriorityMsgList=this.lowPriorityMsgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay})),this.cacheMsgList=this.cacheMsgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay}));var i=this.highPriorityMsgList.slice(0,this.reportConfig.maxSize);if(this.highPriorityMsgList=this.highPriorityMsgList.slice(i.length),i.length<this.reportConfig.maxSize){var n=this.reportConfig.maxSize-i.length;i=i.concat(this.msgList.slice(0,n)),this.msgList=this.msgList.slice(n)}if(i.length<this.reportConfig.maxSize){var a=this.reportConfig.maxSize-i.length;i=i.concat(this.lowPriorityMsgList.slice(0,a)),this.lowPriorityMsgList=this.lowPriorityMsgList.slice(a)}if(i.length<this.reportConfig.maxSize){var s=this.reportConfig.maxSize-i.length;i=i.concat(this.cacheMsgList.slice(0,s)),this.cacheMsgList=this.cacheMsgList.slice(s)}return i.forEach((function(e){t[e.module]?t[e.module].push(e.msg):t[e.module]=[e.msg]})),{uploadMsgArr:i,uploadMsg:t}}},{key:"upload",value:function upload(){var e,t,r=this;if(this.isUploadEnable&&!(this.lastReportTime&&Date.now()-this.lastReportTime<this.reportConfig.minInterval)){var i=this.getUploadMsg(),n=i.uploadMsgArr,a=i.uploadMsg;if(n.length){this.lastReportTime=Date.now();try{this.reportConfig.request(this.reportConfig.reportUrl,{dataType:"json",method:"POST",data:{common:this.reportConfig.common,event:a},headers:{sdktype:"im"},timeout:this.reportConfig.timeout}).catch((function(e){var t,i;r.cacheMsgList=r.cacheMsgList.concat(n).slice(0,r.reportConfig.cacheMaxSize),null===(i=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===i||i.warn("Reporter upload failed",e)}))}catch(r){null===(t=null===(e=this.reportConfig)||void 0===e?void 0:e.logger)||void 0===t||t.warn("Exec reporter request failed",r)}clearTimeout(this.timer),this.reportHeartBeat()}}}}]),Reporter}();return r}()})),n=Array.isArray,a="object"==typeof t&&t&&t.Object===Object&&t,s="object"==typeof self&&self&&self.Object===Object&&self,o=a||s||Function("return this")(),c=o.Symbol,d=Object.prototype,l=d.hasOwnProperty,m=d.toString,p=c?c.toStringTag:void 0;var u=function getRawTag(e){var t=l.call(e,p),r=e[p];try{e[p]=void 0;var i=!0}catch(e){}var n=m.call(e);return i&&(t?e[p]=r:delete e[p]),n},h=Object.prototype.toString;var g=function objectToString(e){return h.call(e)},v=c?c.toStringTag:void 0;var y=function baseGetTag(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":v&&v in Object(e)?u(e):g(e)};var I=function isObjectLike(e){return null!=e&&"object"==typeof e};var _=function isSymbol(e){return"symbol"==typeof e||I(e)&&"[object Symbol]"==y(e)},M=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,f=/^\w*$/;var T=function isKey(e,t){if(n(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!_(e))||(f.test(e)||!M.test(e)||null!=t&&e in Object(t))};var E=function isObject$1(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};var S,C=function isFunction(e){if(!E(e))return!1;var t=y(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},N=o["__core-js_shared__"],A=(S=/[^.]+$/.exec(N&&N.keys&&N.keys.IE_PROTO||""))?"Symbol(src)_1."+S:"";var b=function isMasked(e){return!!A&&A in e},R=Function.prototype.toString;var O=function toSource(e){if(null!=e){try{return R.call(e)}catch(e){}try{return e+""}catch(e){}}return""},P=/^\[object .+?Constructor\]$/,V=Function.prototype,k=Object.prototype,w=V.toString,L=k.hasOwnProperty,D=RegExp("^"+w.call(L).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var U=function baseIsNative(e){return!(!E(e)||b(e))&&(C(e)?D:P).test(O(e))};var q=function getValue(e,t){return null==e?void 0:e[t]};var x=function getNative(e,t){var r=q(e,t);return U(r)?r:void 0},B=x(Object,"create");var G=function hashClear(){this.__data__=B?B(null):{},this.size=0};var j=function hashDelete(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},H=Object.prototype.hasOwnProperty;var Y=function hashGet(e){var t=this.__data__;if(B){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return H.call(t,e)?t[e]:void 0},$=Object.prototype.hasOwnProperty;var W=function hashHas(e){var t=this.__data__;return B?void 0!==t[e]:$.call(t,e)};var z=function hashSet(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=B&&void 0===t?"__lodash_hash_undefined__":t,this};function Hash(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}Hash.prototype.clear=G,Hash.prototype.delete=j,Hash.prototype.get=Y,Hash.prototype.has=W,Hash.prototype.set=z;var K=Hash;var J=function listCacheClear(){this.__data__=[],this.size=0};var Q=function eq(e,t){return e===t||e!=e&&t!=t};var X=function assocIndexOf(e,t){for(var r=e.length;r--;)if(Q(e[r][0],t))return r;return-1},Z=Array.prototype.splice;var ee=function listCacheDelete(e){var t=this.__data__,r=X(t,e);return!(r<0)&&(r==t.length-1?t.pop():Z.call(t,r,1),--this.size,!0)};var te=function listCacheGet(e){var t=this.__data__,r=X(t,e);return r<0?void 0:t[r][1]};var re=function listCacheHas(e){return X(this.__data__,e)>-1};var ie=function listCacheSet(e,t){var r=this.__data__,i=X(r,e);return i<0?(++this.size,r.push([e,t])):r[i][1]=t,this};function ListCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}ListCache.prototype.clear=J,ListCache.prototype.delete=ee,ListCache.prototype.get=te,ListCache.prototype.has=re,ListCache.prototype.set=ie;var ne=ListCache,ae=x(o,"Map");var se=function mapCacheClear(){this.size=0,this.__data__={hash:new K,map:new(ae||ne),string:new K}};var oe=function isKeyable(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var ce=function getMapData(e,t){var r=e.__data__;return oe(t)?r["string"==typeof t?"string":"hash"]:r.map};var de=function mapCacheDelete(e){var t=ce(this,e).delete(e);return this.size-=t?1:0,t};var le=function mapCacheGet(e){return ce(this,e).get(e)};var me=function mapCacheHas(e){return ce(this,e).has(e)};var pe=function mapCacheSet(e,t){var r=ce(this,e),i=r.size;return r.set(e,t),this.size+=r.size==i?0:1,this};function MapCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}MapCache.prototype.clear=se,MapCache.prototype.delete=de,MapCache.prototype.get=le,MapCache.prototype.has=me,MapCache.prototype.set=pe;var ue=MapCache;function memoize(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var memoized=function(){var r=arguments,i=t?t.apply(this,r):r[0],n=memoized.cache;if(n.has(i))return n.get(i);var a=e.apply(this,r);return memoized.cache=n.set(i,a)||n,a};return memoized.cache=new(memoize.Cache||ue),memoized}memoize.Cache=ue;var he=memoize;var ge=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ve=/\\(\\)?/g,ye=function memoizeCapped(e){var t=he(e,(function(e){return 500===r.size&&r.clear(),e})),r=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(ge,(function(e,r,i,n){t.push(i?n.replace(ve,"$1"):r||e)})),t}));var Ie=function arrayMap(e,t){for(var r=-1,i=null==e?0:e.length,n=Array(i);++r<i;)n[r]=t(e[r],r,e);return n},_e=c?c.prototype:void 0,Me=_e?_e.toString:void 0;var fe=function baseToString(e){if("string"==typeof e)return e;if(n(e))return Ie(e,baseToString)+"";if(_(e))return Me?Me.call(e):"";var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t};var Te=function toString(e){return null==e?"":fe(e)};var Ee=function castPath(e,t){return n(e)?e:T(e,t)?[e]:ye(Te(e))};var Se=function toKey(e){if("string"==typeof e||_(e))return e;var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t};var Ce=function baseGet(e,t){for(var r=0,i=(t=Ee(t,e)).length;null!=e&&r<i;)e=e[Se(t[r++])];return r&&r==i?e:void 0};var Ne=function get(e,t,r){var i=null==e?void 0:Ce(e,t);return void 0===i?r:i};function __rest(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(r[i[n]]=e[i[n]])}return r}function __awaiter(e,t,r,i){return new(r||(r=Promise))((function(n,a){function fulfilled(e){try{step(i.next(e))}catch(e){a(e)}}function rejected(e){try{step(i.throw(e))}catch(e){a(e)}}function step(e){e.done?n(e.value):function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))}var Ae,be,Re,Oe,Pe,Ve,ke,we,Le,De,Ue,qe,xe,Be,Fe,Ge,je,He,Ye,$e,We,ze,Ke,Je,Qe,Xe,Ze,et,rt,it,nt,at,st,ot,ct,dt,lt,mt,pt,ut,ht,gt,vt,yt,It,_t,Mt,ft,Tt=function isUndefined(e){return void 0===e};!function(e){e[e.V2NIM_DATA_SYNC_TYPE_LEVEL_FULL=0]="V2NIM_DATA_SYNC_TYPE_LEVEL_FULL",e[e.V2NIM_DATA_SYNC_TYPE_LEVEL_BASIC=1]="V2NIM_DATA_SYNC_TYPE_LEVEL_BASIC"}(Ae||(Ae={})),function(e){e[e.V2NIM_DATA_SYNC_TYPE_MAIN=1]="V2NIM_DATA_SYNC_TYPE_MAIN",e[e.V2NIM_DATA_SYNC_TYPE_TEAM_MEMBER=2]="V2NIM_DATA_SYNC_TYPE_TEAM_MEMBER",e[e.V2NIM_DATA_SYNC_TYPE_SUPER_TEAM_MEMBER=3]="V2NIM_DATA_SYNC_TYPE_SUPER_TEAM_MEMBER"}(be||(be={})),function(e){e[e.V2NIM_DATA_SYNC_STATE_WAITING=1]="V2NIM_DATA_SYNC_STATE_WAITING",e[e.V2NIM_DATA_SYNC_STATE_SYNCING=2]="V2NIM_DATA_SYNC_STATE_SYNCING",e[e.V2NIM_DATA_SYNC_STATE_COMPLETED=3]="V2NIM_DATA_SYNC_STATE_COMPLETED"}(Re||(Re={})),function(e){e[e.V2NIM_CONVERSATION_TYPE_UNKNOWN=0]="V2NIM_CONVERSATION_TYPE_UNKNOWN",e[e.V2NIM_CONVERSATION_TYPE_P2P=1]="V2NIM_CONVERSATION_TYPE_P2P",e[e.V2NIM_CONVERSATION_TYPE_TEAM=2]="V2NIM_CONVERSATION_TYPE_TEAM",e[e.V2NIM_CONVERSATION_TYPE_SUPER_TEAM=3]="V2NIM_CONVERSATION_TYPE_SUPER_TEAM"}(Oe||(Oe={})),function(e){e[e.V2NIM_MESSAGE_STATUS_DEFAULT=0]="V2NIM_MESSAGE_STATUS_DEFAULT",e[e.V2NIM_MESSAGE_STATUS_REVOKE=1]="V2NIM_MESSAGE_STATUS_REVOKE",e[e.V2NIM_MESSAGE_STATUS_BACKFILL=2]="V2NIM_MESSAGE_STATUS_BACKFILL"}(Pe||(Pe={})),function(e){e[e.V2NIM_FRIEND_MODE_TYPE_ADD=1]="V2NIM_FRIEND_MODE_TYPE_ADD",e[e.V2NIM_FRIEND_MODE_TYPE_APPLY=2]="V2NIM_FRIEND_MODE_TYPE_APPLY"}(Ve||(Ve={})),function(e){e[e.V2NIM_FRIEND_ADD_APPLICATION_TYPE_RECEIVED=1]="V2NIM_FRIEND_ADD_APPLICATION_TYPE_RECEIVED",e[e.V2NIM_FRIEND_ADD_APPLICATION_TYPE_REJECTED=2]="V2NIM_FRIEND_ADD_APPLICATION_TYPE_REJECTED"}(ke||(ke={})),function(e){e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT=0]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT",e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED=1]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED",e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED=2]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED",e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED=3]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED",e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD=4]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD"}(we||(we={})),function(e){e[e.V2NIM_FRIEND_DELETION_TYPE_BY_SELF=1]="V2NIM_FRIEND_DELETION_TYPE_BY_SELF",e[e.V2NIM_FRIEND_DELETION_TYPE_BY_PEER=2]="V2NIM_FRIEND_DELETION_TYPE_BY_PEER"}(Le||(Le={})),function(e){e[e.V2NIM_FRIEND_VERIFY_TYPE_ADD=1]="V2NIM_FRIEND_VERIFY_TYPE_ADD",e[e.V2NIM_FRIEND_VERIFY_TYPE_APPLY=2]="V2NIM_FRIEND_VERIFY_TYPE_APPLY",e[e.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT=3]="V2NIM_FRIEND_VERIFY_TYPE_ACCEPT",e[e.V2NIM_FRIEND_VERIFY_TYPE_REJECT=4]="V2NIM_FRIEND_VERIFY_TYPE_REJECT"}(De||(De={})),function(e){e[e.V2NIM_LOGIN_AUTH_TYPE_DEFAULT=0]="V2NIM_LOGIN_AUTH_TYPE_DEFAULT",e[e.V2NIM_LOGIN_AUTH_TYPE_DYNAMIC_TOKEN=1]="V2NIM_LOGIN_AUTH_TYPE_DYNAMIC_TOKEN",e[e.V2NIM_LOGIN_AUTH_TYPE_THIRD_PARTY=2]="V2NIM_LOGIN_AUTH_TYPE_THIRD_PARTY"}(Ue||(Ue={})),function(e){e[e.V2NIM_LOGIN_STATUS_LOGOUT=0]="V2NIM_LOGIN_STATUS_LOGOUT",e[e.V2NIM_LOGIN_STATUS_LOGINED=1]="V2NIM_LOGIN_STATUS_LOGINED",e[e.V2NIM_LOGIN_STATUS_LOGINING=2]="V2NIM_LOGIN_STATUS_LOGINING",e[e.V2NIM_LOGIN_STATUS_UNLOGIN=3]="V2NIM_LOGIN_STATUS_UNLOGIN"}(qe||(qe={})),function(e){e[e.V2NIM_LOGIN_CLIENT_TYPE_UNKNOWN=0]="V2NIM_LOGIN_CLIENT_TYPE_UNKNOWN",e[e.V2NIM_LOGIN_CLIENT_TYPE_ANDROID=1]="V2NIM_LOGIN_CLIENT_TYPE_ANDROID",e[e.V2NIM_LOGIN_CLIENT_TYPE_IOS=2]="V2NIM_LOGIN_CLIENT_TYPE_IOS",e[e.V2NIM_LOGIN_CLIENT_TYPE_PC=4]="V2NIM_LOGIN_CLIENT_TYPE_PC",e[e.V2NIM_LOGIN_CLIENT_TYPE_WP=8]="V2NIM_LOGIN_CLIENT_TYPE_WP",e[e.V2NIM_LOGIN_CLIENT_TYPE_WEB=16]="V2NIM_LOGIN_CLIENT_TYPE_WEB",e[e.V2NIM_LOGIN_CLIENT_TYPE_RESTFUL=32]="V2NIM_LOGIN_CLIENT_TYPE_RESTFUL",e[e.V2NIM_LOGIN_CLIENT_TYPE_MAC_OS=64]="V2NIM_LOGIN_CLIENT_TYPE_MAC_OS",e[e.V2NIM_LOGIN_CLIENT_TYPE_HARMONY_OS=65]="V2NIM_LOGIN_CLIENT_TYPE_HARMONY_OS"}(xe||(xe={})),function(e){e[e.V2NIM_KICKED_OFFLINE_REASON_CLIENT_EXCLUSIVE=1]="V2NIM_KICKED_OFFLINE_REASON_CLIENT_EXCLUSIVE",e[e.V2NIM_KICKED_OFFLINE_REASON_SERVER=2]="V2NIM_KICKED_OFFLINE_REASON_SERVER",e[e.V2NIM_KICKED_OFFLINE_REASON_CLIENT=3]="V2NIM_KICKED_OFFLINE_REASON_CLIENT",e[e.V2NIM_KICKED_OFFLINE_REASON_CLIENT_QUIETLY=4]="V2NIM_KICKED_OFFLINE_REASON_CLIENT_QUIETLY"}(Be||(Be={})),function(e){e[e.V2NIM_LOGIN_CLIENT_CHANGE_LIST=1]="V2NIM_LOGIN_CLIENT_CHANGE_LIST",e[e.V2NIM_LOGIN_CLIENT_CHANGE_LOGIN=2]="V2NIM_LOGIN_CLIENT_CHANGE_LOGIN",e[e.V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT=3]="V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT"}(Fe||(Fe={})),function(e){e[e.V2NIM_CONNECT_STATUS_DISCONNECTED=0]="V2NIM_CONNECT_STATUS_DISCONNECTED",e[e.V2NIM_CONNECT_STATUS_CONNECTED=1]="V2NIM_CONNECT_STATUS_CONNECTED",e[e.V2NIM_CONNECT_STATUS_CONNECTING=2]="V2NIM_CONNECT_STATUS_CONNECTING",e[e.V2NIM_CONNECT_STATUS_WAITING=3]="V2NIM_CONNECT_STATUS_WAITING"}(Ge||(Ge={})),function(e){e[e.V2NIM_MESSAGE_AI_STATUS_UNKNOW=0]="V2NIM_MESSAGE_AI_STATUS_UNKNOW",e[e.V2NIM_MESSAGE_AI_STATUS_AT=1]="V2NIM_MESSAGE_AI_STATUS_AT",e[e.V2NIM_MESSAGE_AI_STATUS_RESPONSE=2]="V2NIM_MESSAGE_AI_STATUS_RESPONSE"}(je||(je={})),function(e){e[e.V2NIM_MESSAGE_TYPE_INVALID=-1]="V2NIM_MESSAGE_TYPE_INVALID",e[e.V2NIM_MESSAGE_TYPE_TEXT=0]="V2NIM_MESSAGE_TYPE_TEXT",e[e.V2NIM_MESSAGE_TYPE_IMAGE=1]="V2NIM_MESSAGE_TYPE_IMAGE",e[e.V2NIM_MESSAGE_TYPE_AUDIO=2]="V2NIM_MESSAGE_TYPE_AUDIO",e[e.V2NIM_MESSAGE_TYPE_VIDEO=3]="V2NIM_MESSAGE_TYPE_VIDEO",e[e.V2NIM_MESSAGE_TYPE_LOCATION=4]="V2NIM_MESSAGE_TYPE_LOCATION",e[e.V2NIM_MESSAGE_TYPE_NOTIFICATION=5]="V2NIM_MESSAGE_TYPE_NOTIFICATION",e[e.V2NIM_MESSAGE_TYPE_FILE=6]="V2NIM_MESSAGE_TYPE_FILE",e[e.V2NIM_MESSAGE_TYPE_AVCHAT=7]="V2NIM_MESSAGE_TYPE_AVCHAT",e[e.V2NIM_MESSAGE_TYPE_TIPS=10]="V2NIM_MESSAGE_TYPE_TIPS",e[e.V2NIM_MESSAGE_TYPE_ROBOT=11]="V2NIM_MESSAGE_TYPE_ROBOT",e[e.V2NIM_MESSAGE_TYPE_CALL=12]="V2NIM_MESSAGE_TYPE_CALL",e[e.V2NIM_MESSAGE_TYPE_CUSTOM=100]="V2NIM_MESSAGE_TYPE_CUSTOM"}(He||(He={})),function(e){e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_UNDEFINED=-1]="V2NIM_MESSAGE_NOTIFICATION_TYPE_UNDEFINED",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE=0]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_KICK=1]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_KICK",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_LEAVE=2]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_LEAVE",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_UPDATE_TINFO=3]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_UPDATE_TINFO",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_DISMISS=4]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_DISMISS",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_APPLY_PASS=5]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_APPLY_PASS",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_OWNER_TRANSFER=6]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_OWNER_TRANSFER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_ADD_MANAGER=7]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_ADD_MANAGER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_REMOVE_MANAGER=8]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_REMOVE_MANAGER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE_ACCEPT=9]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE_ACCEPT",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_BANNED_TEAM_MEMBER=10]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_BANNED_TEAM_MEMBER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE=401]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_KICK=402]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_KICK",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_LEAVE=403]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_LEAVE",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_UPDATE_TINFO=404]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_UPDATE_TINFO",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_DISMISS=405]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_DISMISS",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_APPLY_PASS=410]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_APPLY_PASS",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_OWNER_TRANSFER=406]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_OWNER_TRANSFER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_ADD_MANAGER=407]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_ADD_MANAGER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_REMOVE_MANAGER=408]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_REMOVE_MANAGER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE_ACCEPT=411]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE_ACCEPT",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_BANNED_TEAM_MEMBER=409]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_BANNED_TEAM_MEMBER"}(Ye||(Ye={})),function(e){e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN=0]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS=1]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED=2]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING=3]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING"}($e||($e={})),function(e){e[e.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN=0]="V2NIM_MESSAGE_SENDING_STATE_UNKNOWN",e[e.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED=1]="V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED",e[e.V2NIM_MESSAGE_SENDING_STATE_FAILED=2]="V2NIM_MESSAGE_SENDING_STATE_FAILED",e[e.V2NIM_MESSAGE_SENDING_STATE_SENDING=3]="V2NIM_MESSAGE_SENDING_STATE_SENDING"}(We||(We={})),function(e){e[e.V2NIM_QUERY_DIRECTION_DESC=0]="V2NIM_QUERY_DIRECTION_DESC",e[e.V2NIM_QUERY_DIRECTION_ASC=1]="V2NIM_QUERY_DIRECTION_ASC"}(ze||(ze={})),function(e){e[e.V2NIM_MESSAGE_REVOKE_TYPE_UNDEFINED=0]="V2NIM_MESSAGE_REVOKE_TYPE_UNDEFINED",e[e.V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY=1]="V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY",e[e.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY=2]="V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY",e[e.V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY=3]="V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY",e[e.V2NIM_MESSAGE_REVOKE_TYPE_P2P_ONEWAY=4]="V2NIM_MESSAGE_REVOKE_TYPE_P2P_ONEWAY",e[e.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_ONEWAY=5]="V2NIM_MESSAGE_REVOKE_TYPE_TEAM_ONEWAY"}(Ke||(Ke={})),function(e){e[e.V2NIM_MESSAGE_PIN_STATE_NOT_PINNED=0]="V2NIM_MESSAGE_PIN_STATE_NOT_PINNED",e[e.V2NIM_MESSAGE_PIN_STATE_PINNED=1]="V2NIM_MESSAGE_PIN_STATE_PINNED",e[e.V2NIM_MESSAGE_PIN_STATE_UPDATED=2]="V2NIM_MESSAGE_PIN_STATE_UPDATED"}(Je||(Je={})),function(e){e[e.V2NIM_QUICK_COMMENT_STATE_ADD=1]="V2NIM_QUICK_COMMENT_STATE_ADD",e[e.V2NIM_QUICK_COMMENT_STATE_REMOVE=2]="V2NIM_QUICK_COMMENT_STATE_REMOVE"}(Qe||(Qe={})),function(e){e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE=0]="V2NIM_CLIENT_ANTISPAM_OPERATE_NONE",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE=1]="V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD=2]="V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD=3]="V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD"}(Xe||(Xe={})),function(e){e[e.V2NIM_SORT_ORDER_DESC=0]="V2NIM_SORT_ORDER_DESC",e[e.V2NIM_SORT_ORDER_ASC=1]="V2NIM_SORT_ORDER_ASC"}(Ze||(Ze={})),function(e){e[e.P2P_DELETE_MSG=7]="P2P_DELETE_MSG",e[e.TEAM_DELETE_MSG=8]="TEAM_DELETE_MSG",e[e.SUPERTEAM_DELETE_MSG=12]="SUPERTEAM_DELETE_MSG",e[e.P2P_ONE_WAY_DELETE_MSG=13]="P2P_ONE_WAY_DELETE_MSG",e[e.TEAM_ONE_WAY_DELETE_MSG=14]="TEAM_ONE_WAY_DELETE_MSG",e[e.CUSTOM_P2P_MSG=100]="CUSTOM_P2P_MSG",e[e.CUSTOM_TEAM_MSG=101]="CUSTOM_TEAM_MSG",e[e.CUSTOM_SUPERTEAM_MSG=103]="CUSTOM_SUPERTEAM_MSG"}(et||(et={})),function(e){e[e.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF=0]="V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF",e[e.V2NIM_TEAM_MESSAGE_MUTE_MODE_ON=1]="V2NIM_TEAM_MESSAGE_MUTE_MODE_ON",e[e.V2NIM_TEAM_MESSAGE_MUTE_MODE_NORMAL_ON=2]="V2NIM_TEAM_MESSAGE_MUTE_MODE_NORMAL_ON"}(rt||(rt={})),function(e){e[e.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF=0]="V2NIM_P2P_MESSAGE_MUTE_MODE_OFF",e[e.V2NIM_P2P_MESSAGE_MUTE_MODE_ON=1]="V2NIM_P2P_MESSAGE_MUTE_MODE_ON"}(it||(it={})),function(e){e[e.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_ALL=0]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_ALL",e[e.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_NORMAL=1]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_NORMAL",e[e.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_MANAGER=2]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_MANAGER"}(nt||(nt={})),function(e){e[e.V2NIM_TEAM_TYPE_INVALID=0]="V2NIM_TEAM_TYPE_INVALID",e[e.V2NIM_TEAM_TYPE_ADVANCED=1]="V2NIM_TEAM_TYPE_ADVANCED",e[e.V2NIM_TEAM_TYPE_SUPER=2]="V2NIM_TEAM_TYPE_SUPER"}(at||(at={})),function(e){e[e.V2NIM_TEAM_JOIN_MODE_FREE=0]="V2NIM_TEAM_JOIN_MODE_FREE",e[e.V2NIM_TEAM_JOIN_MODE_APPLY=1]="V2NIM_TEAM_JOIN_MODE_APPLY",e[e.V2NIM_TEAM_JOIN_MODE_INVITE=2]="V2NIM_TEAM_JOIN_MODE_INVITE"}(st||(st={})),function(e){e[e.V2NIM_TEAM_AGREE_MODE_AUTH=0]="V2NIM_TEAM_AGREE_MODE_AUTH",e[e.V2NIM_TEAM_AGREE_MODE_NO_AUTH=1]="V2NIM_TEAM_AGREE_MODE_NO_AUTH"}(ot||(ot={})),function(e){e[e.V2NIM_TEAM_INVITE_MODE_MANAGER=0]="V2NIM_TEAM_INVITE_MODE_MANAGER",e[e.V2NIM_TEAM_INVITE_MODE_ALL=1]="V2NIM_TEAM_INVITE_MODE_ALL"}(ct||(ct={})),function(e){e[e.V2NIM_TEAM_UPDATE_INFO_MODE_MANAGER=0]="V2NIM_TEAM_UPDATE_INFO_MODE_MANAGER",e[e.V2NIM_TEAM_UPDATE_INFO_MODE_ALL=1]="V2NIM_TEAM_UPDATE_INFO_MODE_ALL"}(dt||(dt={})),function(e){e[e.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN=0]="V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN",e[e.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL=1]="V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL",e[e.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_ALL=2]="V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_ALL"}(lt||(lt={})),function(e){e[e.V2NIM_TEAM_UPDATE_EXTENSION_MODE_MANAGER=0]="V2NIM_TEAM_UPDATE_EXTENSION_MODE_MANAGER",e[e.V2NIM_TEAM_UPDATE_EXTENSION_MODE_ALL=1]="V2NIM_TEAM_UPDATE_EXTENSION_MODE_ALL"}(mt||(mt={})),function(e){e[e.V2NIM_TEAM_MESSAGE_NOTIFY_MODE_ALL=0]="V2NIM_TEAM_MESSAGE_NOTIFY_MODE_ALL",e[e.V2NIM_TEAM_MESSAGE_NOTIFY_MODE_MANAGER=1]="V2NIM_TEAM_MESSAGE_NOTIFY_MODE_MANAGER",e[e.V2NIM_TEAM_MESSAGE_NOTIFY_MODE_CLOSE=2]="V2NIM_TEAM_MESSAGE_NOTIFY_MODE_CLOSE"}(pt||(pt={})),function(e){e[e.V2NIM_TEAM_MEMBER_ROLE_NORMAL=0]="V2NIM_TEAM_MEMBER_ROLE_NORMAL",e[e.V2NIM_TEAM_MEMBER_ROLE_OWNER=1]="V2NIM_TEAM_MEMBER_ROLE_OWNER",e[e.V2NIM_TEAM_MEMBER_ROLE_MANAGER=2]="V2NIM_TEAM_MEMBER_ROLE_MANAGER"}(ut||(ut={})),function(e){e[e.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION=0]="V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION",e[e.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION=1]="V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION",e[e.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION=2]="V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION",e[e.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION=3]="V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION"}(ht||(ht={})),function(e){e[e.V2NIM_TEAM_JOIN_ACTION_STATUS_INIT=0]="V2NIM_TEAM_JOIN_ACTION_STATUS_INIT",e[e.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED=1]="V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED",e[e.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED=2]="V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED",e[e.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED=3]="V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED"}(gt||(gt={})),function(e){e[e.teamApply=0]="teamApply",e[e.teamApplyReject=1]="teamApplyReject",e[e.teamInvite=2]="teamInvite",e[e.teamInviteReject=3]="teamInviteReject",e[e.tlistUpdate=4]="tlistUpdate",e[e.superTeamApply=15]="superTeamApply",e[e.superTeamApplyReject=16]="superTeamApplyReject",e[e.superTeamInvite=17]="superTeamInvite",e[e.superTeamInviteReject=18]="superTeamInviteReject"}(vt||(vt={})),function(e){e[e.V2NIM_AI_MODEL_TYPE_UNKNOW=0]="V2NIM_AI_MODEL_TYPE_UNKNOW",e[e.V2NIM_AI_MODEL_TYPE_QWEN=1]="V2NIM_AI_MODEL_TYPE_QWEN",e[e.V2NIM_AI_MODEL_TYPE_AZURE=2]="V2NIM_AI_MODEL_TYPE_AZURE",e[e.V2NIM_AI_MODEL_TYPE_PRIVATE=3]="V2NIM_AI_MODEL_TYPE_PRIVATE"}(yt||(yt={})),function(e){e.V2NIM_AI_MODEL_ROLE_TYPE_SYSTEM="system",e.V2NIM_AI_MODEL_ROLE_TYPE_USER="user",e.V2NIM_AI_MODEL_ROLE_TYPE_ASSISTANT="assistant"}(It||(It={})),function(e){e[e.V2NIM_SIGNALLING_EVENT_TYPE_UNKNOWN=0]="V2NIM_SIGNALLING_EVENT_TYPE_UNKNOWN",e[e.V2NIM_SIGNALLING_EVENT_TYPE_CLOSE=1]="V2NIM_SIGNALLING_EVENT_TYPE_CLOSE",e[e.V2NIM_SIGNALLING_EVENT_TYPE_JOIN=2]="V2NIM_SIGNALLING_EVENT_TYPE_JOIN",e[e.V2NIM_SIGNALLING_EVENT_TYPE_INVITE=3]="V2NIM_SIGNALLING_EVENT_TYPE_INVITE",e[e.V2NIM_SIGNALLING_EVENT_TYPE_CANCEL_INVITE=4]="V2NIM_SIGNALLING_EVENT_TYPE_CANCEL_INVITE",e[e.V2NIM_SIGNALLING_EVENT_TYPE_REJECT=5]="V2NIM_SIGNALLING_EVENT_TYPE_REJECT",e[e.V2NIM_SIGNALLING_EVENT_TYPE_ACCEPT=6]="V2NIM_SIGNALLING_EVENT_TYPE_ACCEPT",e[e.V2NIM_SIGNALLING_EVENT_TYPE_LEAVE=7]="V2NIM_SIGNALLING_EVENT_TYPE_LEAVE",e[e.V2NIM_SIGNALLING_EVENT_TYPE_CONTROL=8]="V2NIM_SIGNALLING_EVENT_TYPE_CONTROL"}(_t||(_t={})),function(e){e[e.V2NIM_SIGNALLING_CHANNEL_TYPE_AUDIO=1]="V2NIM_SIGNALLING_CHANNEL_TYPE_AUDIO",e[e.V2NIM_SIGNALLING_CHANNEL_TYPE_VIDEO=2]="V2NIM_SIGNALLING_CHANNEL_TYPE_VIDEO",e[e.V2NIM_SIGNALLING_CHANNEL_TYPE_CUSTOM=3]="V2NIM_SIGNALLING_CHANNEL_TYPE_CUSTOM"}(Mt||(Mt={})),function(e){e[e.V2NIM_USER_STATUS_TYPE_UNKNOWN=0]="V2NIM_USER_STATUS_TYPE_UNKNOWN",e[e.V2NIM_USER_STATUS_TYPE_LOGIN=1]="V2NIM_USER_STATUS_TYPE_LOGIN",e[e.V2NIM_USER_STATUS_TYPE_LOGOUT=2]="V2NIM_USER_STATUS_TYPE_LOGOUT",e[e.V2NIM_USER_STATUS_TYPE_DISCONNECT=3]="V2NIM_USER_STATUS_TYPE_DISCONNECT"}(ft||(ft={}));var Et={V2NIM_ERROR_CODE_UNKNOWN:{code:0,message:"unknown error"},V2NIM_ERROR_CODE_SUCCESS:{code:200,message:"success"},V2NIM_ERROR_CODE_HANDSHAKE:{code:201,message:"handshake error"},V2NIM_ERROR_CODE_REQUEST_TEMPERARY_FORBIDDEN:{code:398,message:"request temprary forbidden"},V2NIM_ERROR_CODE_SERVER_UNIT_ERROR:{code:399,message:"server unit error"},V2NIM_ERROR_CODE_FORBIDDEN:{code:403,message:"forbidden"},V2NIM_ERROR_CODE_NOT_FOUND:{code:404,message:"not found"},V2NIM_ERROR_CODE_PARAMETER_ERROR:{code:414,message:"parameter error"},V2NIM_ERROR_CODE_RATE_LIMIT_REACHED:{code:416,message:"rate limit reached"},V2NIM_ERROR_CODE_MULTI_LOGIN_FORBIDDEN:{code:417,message:"multi login forbidden"},V2NIM_ERROR_CODE_SERVER_INTERNAL_ERROR:{code:500,message:"server internal error"},V2NIM_ERROR_CODE_SERVER_BUSY:{code:503,message:"server busy"},V2NIM_ERROR_CODE_APP_UNREACHABLE:{code:511,message:"app server unreachable"},V2NIM_ERROR_CODE_SERVICE_UNAVAILABLE:{code:514,message:"service unavailable"},V2NIM_ERROR_CODE_PROTOCOL_BLACKHOLE_FILTERED:{code:599,message:"protocol filtered by blackhole rule"},V2NIM_ERROR_CODE_NO_PERMISSION:{code:997,message:"appid has no permission to call the protocol"},V2NIM_ERROR_CODE_UNPACK_ERROR:{code:998,message:"unpack error"},V2NIM_ERROR_CODE_PACK_ERROR:{code:999,message:"pack error"},V2NIM_ERROR_CODE_IM_DISABLED:{code:101301,message:"IM disabled"},V2NIM_ERROR_CODE_SERVICE_ADDRESS_INVALID:{code:101302,message:"service address invalid"},V2NIM_ERROR_CODE_APPKEY_NOT_EXIST:{code:101303,message:"appkey not exist"},V2NIM_ERROR_CODE_BUNDLEID_CHECK_FAILED:{code:101304,message:"bundleid check failed"},V2NIM_ERROR_CODE_APPKEY_BLOCKED:{code:101403,message:"appkey blocked"},V2NIM_ERROR_CODE_INVALID_TOKEN:{code:102302,message:"invalid token"},V2NIM_ERROR_CODE_ROBOT_NOT_ALLOWED:{code:102303,message:"robot not allowed"},V2NIM_ERROR_CODE_ACCOUNT_NOT_EXIST:{code:102404,message:"account not exist"},V2NIM_ERROR_CODE_ACCOUNT_CHAT_BANNED:{code:102421,message:"account chat banned"},V2NIM_ERROR_CODE_ACCOUNT_BANNED:{code:102422,message:"account banned"},V2NIM_ERROR_CODE_ACCOUNT_IN_BLOCK_LIST:{code:102426,message:"account in block list"},V2NIM_ERROR_CODE_USER_PROFILE_NOT_EXIST:{code:103404,message:"user profile not exist"},V2NIM_ERROR_CODE_USER_PROFILE_HIT_ANTISPAM:{code:103451,message:"user profile hit antispam"},V2NIM_ERROR_CODE_PEER_FRIEND_LIMIT:{code:104301,message:"peer friend limit"},V2NIM_ERROR_CODE_FRIEND_APPLICATION_NOT_EXIST:{code:104302,message:"friend application not exist"},V2NIM_ERROR_CODE_FRIEND_NOT_EXIST:{code:104404,message:"friend not exist"},V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST:{code:104405,message:"friend already exist"},V2NIM_ERROR_CODE_SELF_FRIEND_OPERATION_NOT_ALLOWED:{code:104429,message:"self friend operation not allowed"},V2NIM_ERROR_CODE_FRIEND_LIMIT:{code:104435,message:"friend limit"},V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT:{code:104449,message:"friend operation rate limit"},V2NIM_ERROR_CODE_FRIEND_HIT_ANTISPAM:{code:104451,message:"friend hit antispam"},V2NIM_ERROR_CODE_SELF_MUTE_OPERATION_NOT_ALLOWED:{code:105429,message:"self mute operation not allowed"},V2NIM_ERROR_CODE_MUTE_LIST_LIMIT:{code:105435,message:"mute list limit"},V2NIM_ERROR_CODE_SELF_BLOCK_LIST_OPERATION_NOT_ALLOWED:{code:106429,message:"self block list operation not allowed"},V2NIM_ERROR_CODE_BLOCK_LIST_LIMIT:{code:106435,message:"block list limit"},V2NIM_ERROR_CODE_REVOKE_THIRD_PARTY_MESSAGE_NOT_ALLOWED:{code:107301,message:"revoke third party message not allowed"},V2NIM_ERROR_CODE_SHORT_TO_LONG_URL_FAILED:{code:107307,message:"short to long URL failed"},V2NIM_ERROR_CODE_URL_INVALID:{code:107308,message:"URL invalid"},V2NIM_ERROR_CODE_DURATION_OUT_OF_RANGE:{code:107309,message:"duration out of range"},V2NIM_ERROR_CODE_GET_FILE_META_INFO_FAILED:{code:107310,message:"get file meta info failed"},V2NIM_ERROR_CODE_AUDIO_FILE_SIZE_LIMIT:{code:107311,message:"audio file size limit"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_TIMEOUT:{code:107312,message:"voice to text timeout"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_FAILED:{code:107313,message:"voice to text failed"},V2NIM_ERROR_CODE_REVOKE_EXCEED_TIME_LIMIT:{code:107314,message:"revoke message exceed time limit"},V2NIM_ERROR_CODE_REVOKE_MESSAGE_NOT_ALLOWED:{code:107315,message:"revoke specific message not allowed"},V2NIM_ERROR_CODE_FORCE_PUSH_LIST_LIMIT:{code:107316,message:"force push list limit"},V2NIM_ERROR_CODE_TEAM_MESSAGE_RECEIPT_RATE_LIMIT:{code:107317,message:"team message receipt rate limit"},V2NIM_ERROR_CODE_SNAPSHOT_NOT_EXIST:{code:107318,message:"snapshot not exist"},V2NIM_ERROR_CODE_PIN_LIMIT:{code:107319,message:"pin limit"},V2NIM_ERROR_CODE_PIN_NOT_EXIST:{code:107320,message:"pin not exist"},V2NIM_ERROR_CODE_QUICK_COMMENT_LIMIT:{code:107321,message:"quick comment limit"},V2NIM_ERROR_CODE_PIN_ALREADY_EXIST:{code:107322,message:"pin already exist"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_FUNCTION_DISABLED:{code:107333,message:"voice to text function disabled"},V2NIM_ERROR_CODE_CLOUD_SEARCH_FUNCTION_DISABLED:{code:107334,message:"cloud search function disabled"},V2NIM_ERROR_CODE_ONE_WAY_DELETE_FUNCTION_DISABLED:{code:107335,message:"one-way delete function disabled"},V2NIM_ERRPR_CODE_ONEWAY_DELETION_NOT_ALLOW_FOR_TARGET_MESSAGES:{code:107338,message:"one-way deletion is not allowed for target messages"},V2NIM_ERRPR_CODE_SENDER_CANNOT_INCLUDED_IN_TARGET_LIST:{code:107339,message:"The message sender cannot be included in the target list"},V2NIM_ERROR_CODE_ROBOT_CANNOT_SEND_TARGET_MESSAGE:{code:107340,message:"Robot can not send target message"},V2NIM_ERROR_CODE_PIN_TARGET_MESSAGE_NOT_ALLOWED:{code:107345,message:"Pin target message is not allowed"},V2NIM_ERROR_CODE_TARGET_MESSAGE_NOT_ALLOWED_REPLY:{code:107346,message:"Target message not allowed reply"},V2NIM_ERROR_CODE_TARGET_MESSAGE_NOT_ALLOWED_QUICK_COMMENT:{code:107347,message:"Target message not allowed quick comment"},V2NIM_ERROR_CODE_REVOKE_MESSAGE_TO_SELF_NOT_ALLOWED:{code:107429,message:"revoke message to self not allowed"},V2NIM_ERROR_CODE_APP_CHAT_BANNED:{code:107410,message:"app chat banned"},V2NIM_ERROR_CODE_QUICK_COMMENT_FUNCTION_DISABLED:{code:107326,message:"quick comment function disabled"},V2NIM_ERROR_CODE_PIN_FUNCTION_DISABLED:{code:107327,message:"PIN function disabled"},V2NIM_ERROR_CODE_TEAM_READ_RECEIPT_FUNCTION_DISABLED:{code:107324,message:"read receipt for team messages function disabled"},V2NIM_ERROR_CODE_P2P_READ_RECEIPT_FUNCTION_DISABLED:{code:107325,message:"read receipt for p2p messages function disabled"},V2NIM_ERROR_CODE_RATE_LIMIT_FOR_MESSAGING_REACHED:{code:107323,message:"rate limit for messaging reached"},V2NIM_ERROR_CODE_MESSAGE_HIT_ANTISPAM:{code:107451,message:"message hit antispam"},V2NIM_ERROR_CODE_MESSAGE_NOT_EXIST:{code:107404,message:"message not exist"},V2NIM_ERROR_CODE_UNSENDING_MESSAGE_EXPIRED:{code:107406,message:"unsending message expired"},V2NIM_ERROR_CODE_TEAM_MARK_READ_FAILED:{code:107302,message:"sending message failed for marking message read failed for too many team members"},V2NIM_ERROR_CODE_SENDER_OR_MANAGER_PERMISSION_ONLY_REVOKE:{code:107303,message:"only sender or manager can revoke message"},V2NIM_ERROR_CODE_DELETE_SELF_MESSAGE_NOT_ALLOWED:{code:107328,message:"delete self message not allowed"},V2NIM_ERROR_CODE_NOT_CHATBOT_ACCOUNT:{code:107329,message:"is not chatbot account"},V2NIM_ERROR_CODE_MESSAGE_SENSE_REQUIRED:{code:107330,message:"sender or receiver must sense message"},V2NIM_ERROR_CODE_HIGH_PRIORITY_MESSAGE_RATE_LIMIT:{code:107304,message:"rate limit of high-priority messages exceeded"},ACK_MESSAGE_BE_HIGH_PRIORITY:{code:107305,message:"ack message should be high-priority"},V2NIM_ERROR_CODE_DUPLICATE_CLIENT_MESSAGE_ID:{code:107306,message:"duplicate client message ID"},V2NIM_ERROR_CODE_INVALID_TIME_RANGE:{code:107439,message:"invalid time range"},V2NIM_ERROR_CODE_NOT_ADVANCED_TEAM:{code:108302,message:"not advanced team"},V2NIM_ERROR_CODE_TEAM_MANAGER_LIMIT:{code:108303,message:"team manager limit"},V2NIM_ERROR_CODE_JOINED_TEAM_LIMIT:{code:108305,message:"joined team limit"},V2NIM_ERROR_CODE_TEAM_NORMAL_MEMBER_CHAT_BANNED:{code:108306,message:"team normal member chat banned"},V2NIM_ERROR_CODE_INVITED_ACCOUNT_NOT_FRIEND:{code:108307,message:"invited account not friend"},V2NIM_ERROR_CODE_REJECT_ALL_TEAM_APPLICATIONS:{code:108308,message:"reject all team applications"},V2NIM_ERROR_CODE_TARGETING_MESSAGE_FOR_TEAM_DISABLED:{code:108318,message:"Targeting messages for group chat is disabled"},V2NIM_ERROR_CODE_INCLUSIVE_AS_FALSE_NOT_ALLOWED_FOR_SUPER_TEAM:{code:108319,message:'Setting "inclusive" to false for super teams is not allowed'},V2NIM_ERROR_CODE_CANNOT_MAKE_SUPER_TEAM_MESSAGE_VISIBLE_TO_NEW_MEMBERS:{code:108320,message:"Cannot make super team targeted messages visible to new members"},V2NIM_ERROR_CODE_CANNOT_ALLOW_TARGETED_MESSAGES_INCLUSIVE_TO_NEW_MEMBERS:{code:108321,message:"Cannot allow targeted messages inclusive to new members"},V2NIM_ERROR_CODE_TEAM_NOT_EXIST:{code:108404,message:"team not exist"},V2NIM_ERROR_CODE_TEAM_ALREADY_CHAT_BANNED:{code:108420,message:"team already chat banned"},V2NIM_ERROR_CODE_ALL_TEAM_MEMBER_CHAT_BANNED:{code:108423,message:"all team member chat banned"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_LIMIT:{code:108434,message:"extended super team limit"},V2NIM_ERROR_CODE_CREATED_TEAM_LIMIT:{code:108435,message:"created team limit"},V2NIM_ERROR_CODE_TEAM_INVITATION_LIMIT:{code:108437,message:"team invitation limit"},V2NIM_ERROR_CODE_TEAM_HIT_ANTISPAM:{code:108451,message:"team hit antispam"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_LIMIT_NOT_CONFIGURED:{code:108304,message:"extended super team limit not configured"},V2NIM_ERROR_CODE_SUPER_TEAM_SERVICE_DISABLED:{code:108311,message:"super team service disabled"},V2NIM_ERROR_CODE_TEAM_READ_RECEIPT_RECORD_NOT_FOUND:{code:108301,message:"read receipt record for the team message not found"},V2NIM_ERROR_CODE_NOT_MANAGER:{code:108430,message:"unable to assign owner manager"},V2NIM_ERROR_CODE_ONLINE_MEMBER_COUNT_DISABLED:{code:108406,message:"number of online users service disabled"},V2NIM_ERROR_CODE_TRANSFER_DISABLED:{code:108310,message:"unable to transfer the ownership to owner"},V2NIM_ERROR_CODE_CREATE_TEAM_DISABLED:{code:108309,message:"unable to create team with more than %s people"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_CREATE_FAILED:{code:108313,message:"/ extended super team creation failed，use open api to create the team"},V2NIM_ERROR_CODE_TEAM_MESSAGE_READ_RECEIPT_DISABLED:{code:108312,message:"read receipt for team messages function disabled"},V2NIM_ERROR_CODE_RETRY:{code:108449,message:"an error occurred, try again"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_NOT_TEAM_MEMBER:{code:109301,message:"list of chat banned users contains non team members"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_OPERATOR:{code:109303,message:"list of chat banned users contains the operator"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_TEAM_OWNER:{code:109304,message:"list of chat banned users contains the team owner"},V2NIM_ERROR_CODE_OPERATION_ON_TEAM_MANAGER_NOT_ALLOWED:{code:109305,message:"operation on team manager not allowed"},V2NIM_ERROR_CODE_NO_TEAM_INVITE_PERMISSION:{code:109306,message:"no team invite permission"},V2NIM_ERROR_CODE_TEAM_OWNER_QUIT_NOT_ALLOWED:{code:109307,message:"team owner quit not allowed"},V2NIM_ERROR_CODE_TEAM_OWNER_IN_KICK_LIST:{code:109308,message:"list of kicked user contains the team owner"},V2NIM_ERROR_CODE_INVITE_ROBOT_ACCOUNT_NOT_ALLOWED:{code:109309,message:"invite robot account not allowed"},V2NIM_ERROR_CODE_KICK_OPERATOR_NOT_ALLOWED:{code:109310,message:"kick operator not allowed"},V2NIM_ERROR_CODE_TEAM_MEMBER_ALREADY_EXIST:{code:109311,message:"team member already exist"},V2NIM_ERROR_CODE_TEAM_INVITATION_OR_APPLICATION_NOT_EXIST:{code:109313,message:"team invitation or application not exist"},V2NIM_ERROR_CODE_OPERATION_ON_TEAM_OWNER_NOT_ALLOWED:{code:109314,message:"operation on team owner not allowed"},V2NIM_ERROR_CODE_FORCED_PUSH_LIST_INCLUDES_NON_TARGETED_ACCOUNTS:{code:109318,message:"The forced push list includes non-targeted accounts"},V2NIM_ERROR_CODE_TEAM_MEMBER_NOT_EXIST:{code:109404,message:"team member not exist"},V2NIM_ERROR_CODE_TEAM_MEMBER_CHAT_BANNED:{code:109424,message:"team member chat banned"},V2NIM_ERROR_CODE_TEAM_OWNER_OPERATION_PERMISSION_REQUIRED:{code:109427,message:"team owner operation permission required"},V2NIM_ERROR_CODE_TEAM_OWNER_OR_MANAGER_OPERATION_PERMISSION_REQUIRED:{code:109432,message:"team owner or manager operation permission required"},V2NIM_ERROR_CODE_TEAM_MEMBER_CONCURRENT_OPERATION_FAILED:{code:109449,message:"team member concurrent operation failed"},V2NIM_ERROR_CODE_TEAM_MEMBER_HIT_ANTISPAM:{code:109451,message:"team member hit antispam"},V2NIM_ERROR_CODE_CONVERSATION_AND_ACCOUNT_MISMATCH:{code:110302,message:"conversation and account mismatch"},V2NIM_ERROR_CODE_CONVERSATION_STICK_TOP_LIMIT:{code:110303,message:"conversation stick top limit"},V2NIM_ERROR_CODE_CONVERSATION_BELONGED_GROUP_LIMIT:{code:110304,message:"conversation belonged group limit"},V2NIM_ERROR_CODE_CONVERSATION_NOT_EXIST:{code:110404,message:"conversation not exist"},V2NIM_ERROR_CODE_CHATROOM_LINK_UNAVAILABLE:{code:113304,message:"chatroom link unavailable"},V2NIM_ERROR_CODE_IM_CONNECTION_ABNORMAL:{code:113305,message:"IM connection abnormal"},V2NIM_ERROR_CODE_CHATROOM_NOT_EXIST:{code:113404,message:"chatroom not exist"},V2NIM_ERROR_CODE_CHATROOM_CLOSED:{code:113406,message:"chatroom closed"},V2NIM_ERROR_CODE_CHATROOM_REPEATED_OPERATION:{code:113409,message:"chatroom repeated operation"},V2NIM_ERROR_CODE_CHATROOM_DISABLED:{code:113410,message:"chatroom disabled"},V2NIM_ERROR_CODE_ALL_CHATROOM_MEMBER_CHAT_BANNED:{code:113423,message:"all chatroom member chat banned"},V2NIM_ERROR_CODE_CHATROOM_HIT_ANTISPAM:{code:113451,message:"chatroom hit antispam"},V2NIM_ERROR_CODE_ANONYMOUS_MEMBER_FORBIDDEN:{code:114303,message:"anonymous member forbidden"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_NOT_EXIST:{code:114404,message:"chatroom member not exist"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_REPEATED_OPERATION:{code:114405,message:"chatroom member repeated operation"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_CHAT_BANNED:{code:114421,message:"chatroom member chat banned"},V2NIM_ERROR_CODE_ACCOUNT_IN_CHATROOM_BLOCK_LIST:{code:114426,message:"account in chatroom block list"},V2NIM_ERROR_CODE_CHATROOM_OWNER_OPERATION_PERMISSION_REQUIRED:{code:114427,message:"chatroom owner operation permission required"},V2NIM_ERROR_CODE_SELF_IN_CHATROOM_MEMBER_OPERATION_LIST:{code:114429,message:"self in chatroom member operation list"},V2NIM_ERROR_CODE_CHATROOM_OWNER_OR_MANAGER_OPERATION_PERMISSION_REQUIRED:{code:114432,message:"chatroom owner or manager operation permission required"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_LIMIT:{code:114437,message:"chatroom member limit"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_CONCURRENT_OPERATION_FAILED:{code:114449,message:"chatroom member concurrent operation failed"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_HIT_ANTISPAM:{code:114451,message:"chatroom member hit antispam"},V2NIM_ERROR_CODE_CONVERSATION_GROUP_NOT_EXIST:{code:116404,message:"conversation group not exist"},V2NIM_ERROR_CODE_CONVERSATION_GROUP_LIMIT:{code:116435,message:"conversation group limit"},V2NIM_ERROR_CODE_CONVERSATIONS_IN_GROUP_LIMIT:{code:116437,message:"conversations in group limit"},V2NIM_ERROR_CODE_COLLECTION_LIMIT:{code:189301,message:"collection limit"},V2NIM_ERROR_CODE_COLLECTION_NOT_EXIST:{code:189302,message:"collection not exist"},V2NIM_ERROR_CODE_COLLECTION_CONCURRENT_OPERATION_FAILED:{code:189449,message:"collection concurrent operation failed"},V2NIM_ERROR_CODE_INTERNAL:{code:190001,message:"internal error"},V2NIM_ERROR_CODE_ILLEGAL_STATE:{code:190002,message:"illegal state"},V2NIM_ERROR_CODE_MISUSE:{code:191001,message:"misuse"},V2NIM_ERROR_CODE_CANCELLED:{code:191002,message:"operation cancelled"},V2NIM_ERROR_CODE_CALLBACK_FAILED:{code:191003,message:"callback failed"},V2NIM_ERROR_CODE_INVALID_PARAMETER:{code:191004,message:"invalid parameter"},V2NIM_ERROR_CODE_TIMEOUT:{code:191005,message:"timeout"},V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST:{code:191006,message:"resource not exist"},V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST:{code:191007,message:"resource already exist"},V2NIM_ERROR_CODE_CONNECT_FAILED:{code:192001,message:"connect failed"},V2NIM_ERROR_CODE_CONNECT_TIMEOUT:{code:192002,message:"connect timeout"},V2NIM_ERROR_CODE_DISCONNECT:{code:192003,message:"disconnect"},V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT:{code:192004,message:"protocol timeout"},V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED:{code:192005,message:"protocol send failed"},V2NIM_ERROR_CODE_REQUEST_FAILED:{code:192006,message:"request failed"},V2NIM_ERROR_CODE_FILE_NOT_FOUND:{code:194001,message:"file not found"},V2NIM_ERROR_CODE_FILE_CREATE_FAILED:{code:194002,message:"file create failed"},V2NIM_ERROR_CODE_FILE_OPEN_FAILED:{code:194003,message:"file open failed"},V2NIM_ERROR_CODE_FILE_WRITE_FAILED:{code:194004,message:"file write failed"},V2NIM_ERROR_CODE_FILE_READ_FAILED:{code:194005,message:"file read failed"},V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:{code:194006,message:"file upload failed"},V2NIM_ERROR_CODE_FILE_DOWNLOAD_FAILED:{code:194007,message:"file download failed"},V2NIM_ERROR_CODE_CLIENT_ANTISPAM:{code:195001,message:"client anti-spam"},V2NIM_ERROR_CODE_SERVER_ANTISPAM:{code:195002,message:"server anti-spam"}},St=Object.keys(Et),Ct=St.reduce((function(e,t){var r=Et[t];return e[t]=r.code,e}),{}),Nt=St.reduce((function(e,t){var r=Et[t];return e[r.code]=r.message,e}),{}),At=Object.freeze({__proto__:null,V2NIMErrorCode:Ct,V2NIMErrorDesc:Nt,get V2NIMDataSyncLevel(){return Ae},get V2NIMDataSyncType(){return be},get V2NIMDataSyncState(){return Re},get V2NIMConversationType(){return Oe},get V2NIMLastMessageState(){return Pe},get V2NIMFriendAddMode(){return Ve},get V2NIMFriendAddApplicationType(){return ke},get V2NIMFriendAddApplicationStatus(){return we},get V2NIMFriendDeletionType(){return Le},get V2NIMFriendVerifyType(){return De},get V2NIMLoginAuthType(){return Ue},get V2NIMLoginStatus(){return qe},get V2NIMLoginClientType(){return xe},get V2NIMKickedOfflineReason(){return Be},get V2NIMLoginClientChange(){return Fe},get V2NIMConnectStatus(){return Ge},get V2NIMMessageType(){return He},get V2NIMMessageNotificationType(){return Ye},get V2NIMMessageAttachmentUploadState(){return $e},get V2NIMMessageSendingState(){return We},get V2NIMQueryDirection(){return ze},get V2NIMMessageRevokeType(){return Ke},get V2NIMMessagePinState(){return Je},get V2NIMMessageQuickCommentType(){return Qe},get V2NIMClientAntispamOperateType(){return Xe},get V2NIMSortOrder(){return Ze},get V2NIMSystemMessageType(){return et},get V2NIMTeamMessageMuteMode(){return rt},get V2NIMP2PMessageMuteMode(){return it},get V2NIMTeamMemberRoleQueryType(){return nt},get V2NIMTeamType(){return at},get V2NIMTeamJoinMode(){return st},get V2NIMTeamAgreeMode(){return ot},get V2NIMTeamInviteMode(){return ct},get V2NIMTeamUpdateInfoMode(){return dt},get V2NIMTeamChatBannedMode(){return lt},get V2NIMTeamUpdateExtensionMode(){return mt},get V2NIMTeamMessageNotifyMode(){return pt},get V2NIMTeamJoinActionType(){return ht},get V2NIMTeamJoinActionStatus(){return gt},get V2NIMTeamNotificationType(){return vt},get V2NIMTeamMemberRole(){return ut},get V2NIMAIModelRoleType(){return It},get V2NIMAIModelType(){return yt},get V2NIMSignallingChannelType(){return Mt},get V2NIMSignallingEventType(){return _t},get V2NIMUserStatusType(){return ft}});class V2NIMErrorImpl extends Error{constructor(e){super(e.desc),this.name="V2NIMError",this.code=e.code||0,this.desc=e.desc||Nt[this.code]||bt[this.code]||"",this.message=this.desc,this.detail=e.detail||{}}toString(){var e,t=`${this.name}\n code: ${this.code}\n message: "${this.message}"\n detail: ${this.detail?JSON.stringify(this.detail):""}`;return(null===(e=null==this?void 0:this.detail)||void 0===e?void 0:e.rawError)&&(t+=`\n rawError: ${this.detail.rawError.message}`),t}}class ValidateError extends V2NIMErrorImpl{constructor(e,t={},r){super({code:Ct.V2NIM_ERROR_CODE_PARAMETER_ERROR,detail:{reason:e,rules:r,data:t}}),this.name="validateError",this.message=this.message+"\n"+JSON.stringify(this.detail,null,2),this.data=t,this.rules=r}}class ValidateErrorV2 extends V2NIMErrorImpl{constructor(e){var t,r,i;super({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:null===(t=e.detail)||void 0===t?void 0:t.reason,rules:null===(r=e.detail)||void 0===r?void 0:r.rules,data:null===(i=e.detail)||void 0===i?void 0:i.data}}),this.name="ValidateErrorV2"}}class FormatError extends V2NIMErrorImpl{constructor(e,t,r){super({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:e,key:t,rules:r}}),this.name="formatError"}}class UploadError extends V2NIMErrorImpl{constructor(e){super(Object.assign({code:400},e)),this.desc=this.desc||"upload file error",this.message=this.desc,this.name="uploadError"}}class CustomError extends V2NIMErrorImpl{constructor(e,t={},r=400){super({code:r,desc:e,detail:t}),this.name="customError",this.data=t}}var bt={200:null,406:null,808:null,810:null,302:"The user name or password is incorrect.",405:"Parameter length too long",408:"Client request timed out",415:"Client network unavailable",422:"Account disabled",508:"Expiration date",509:"Invalid",7101:"Be pulled black",700:"Partial failure of batch operation",801:"The number of people in the team has reached the upper limit",802:"No permission",803:"The team does not exist or has not changed",804:"The user is not in the team",805:"Team type mismatch",806:"The number of teams created has reached the limit",807:"Team member not valid",809:"Already in the team",811:"The number of accounts in the forced push list exceeds the limit",812:"The team is muted",813:"Due to the limited number of team, some pull people successfully",814:"Disable team message read service",815:"Maximum number of team administrators",816:"Batch operation partial failure",9102:"Channel failure",9103:"This call has been answered / rejected at another end",10201:"Signaling: target NIM client is offline",10202:"Signaling: push is unreachable",10404:"Signaling: channel not exists",10405:"Signaling: channel already exists",10406:"Signaling: member of channel not exists",10407:"Signaling: member of channel already exists",10408:"Signaling: the invitation request does not exist or has expired",10409:"Signaling: the invitation request has been rejected",10410:"Signaling: the invitation request has been accepted",10414:"Signaling: request parameter error",10417:"Signaling: uid conflict",10419:"Signaling: the number of members of channel exceed the limit",10420:"Signaling: member is already in the channel on other client",10700:"Signaling: phased success",13002:"Abnormal chatroom status",13003:"In the blacklist",13004:"In the mute list",13006:"All members are muted, and only the administrator can speak"};var Rt=function stackClear(){this.__data__=new ne,this.size=0};var Ot=function stackDelete(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r};var Pt=function stackGet(e){return this.__data__.get(e)};var Vt=function stackHas(e){return this.__data__.has(e)};var kt=function stackSet(e,t){var r=this.__data__;if(r instanceof ne){var i=r.__data__;if(!ae||i.length<199)return i.push([e,t]),this.size=++r.size,this;r=this.__data__=new ue(i)}return r.set(e,t),this.size=r.size,this};function Stack(e){var t=this.__data__=new ne(e);this.size=t.size}Stack.prototype.clear=Rt,Stack.prototype.delete=Ot,Stack.prototype.get=Pt,Stack.prototype.has=Vt,Stack.prototype.set=kt;var wt=Stack,Lt=function(){try{var e=x(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();var Dt=function baseAssignValue(e,t,r){"__proto__"==t&&Lt?Lt(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r};var Ut=function assignMergeValue(e,t,r){(void 0!==r&&!Q(e[t],r)||void 0===r&&!(t in e))&&Dt(e,t,r)};var qt=function createBaseFor(e){return function(t,r,i){for(var n=-1,a=Object(t),s=i(t),o=s.length;o--;){var c=s[e?o:++n];if(!1===r(a[c],c,a))break}return t}}(),xt=createCommonjsModule((function(e,t){var r=t&&!t.nodeType&&t,i=r&&e&&!e.nodeType&&e,n=i&&i.exports===r?o.Buffer:void 0,a=n?n.allocUnsafe:void 0;e.exports=function cloneBuffer(e,t){if(t)return e.slice();var r=e.length,i=a?a(r):new e.constructor(r);return e.copy(i),i}})),Bt=o.Uint8Array;var Ft=function cloneArrayBuffer(e){var t=new e.constructor(e.byteLength);return new Bt(t).set(new Bt(e)),t};var Gt=function cloneTypedArray(e,t){var r=t?Ft(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)};var jt=function copyArray(e,t){var r=-1,i=e.length;for(t||(t=Array(i));++r<i;)t[r]=e[r];return t},Ht=Object.create,Yt=function(){function object(){}return function(e){if(!E(e))return{};if(Ht)return Ht(e);object.prototype=e;var t=new object;return object.prototype=void 0,t}}();var $t=function overArg(e,t){return function(r){return e(t(r))}},Wt=$t(Object.getPrototypeOf,Object),zt=Object.prototype;var Kt=function isPrototype(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||zt)};var Jt=function initCloneObject(e){return"function"!=typeof e.constructor||Kt(e)?{}:Yt(Wt(e))};var Qt=function baseIsArguments(e){return I(e)&&"[object Arguments]"==y(e)},Xt=Object.prototype,Zt=Xt.hasOwnProperty,er=Xt.propertyIsEnumerable,tr=Qt(function(){return arguments}())?Qt:function(e){return I(e)&&Zt.call(e,"callee")&&!er.call(e,"callee")},rr=tr;var ir=function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991};var nr=function isArrayLike(e){return null!=e&&ir(e.length)&&!C(e)};var ar=function isArrayLikeObject(e){return I(e)&&nr(e)};var sr=function stubFalse(){return!1},or=createCommonjsModule((function(e,t){var r=t&&!t.nodeType&&t,i=r&&e&&!e.nodeType&&e,n=i&&i.exports===r?o.Buffer:void 0,a=(n?n.isBuffer:void 0)||sr;e.exports=a})),cr=Function.prototype,dr=Object.prototype,lr=cr.toString,mr=dr.hasOwnProperty,pr=lr.call(Object);var ur=function isPlainObject(e){if(!I(e)||"[object Object]"!=y(e))return!1;var t=Wt(e);if(null===t)return!0;var r=mr.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&lr.call(r)==pr},hr={};hr["[object Float32Array]"]=hr["[object Float64Array]"]=hr["[object Int8Array]"]=hr["[object Int16Array]"]=hr["[object Int32Array]"]=hr["[object Uint8Array]"]=hr["[object Uint8ClampedArray]"]=hr["[object Uint16Array]"]=hr["[object Uint32Array]"]=!0,hr["[object Arguments]"]=hr["[object Array]"]=hr["[object ArrayBuffer]"]=hr["[object Boolean]"]=hr["[object DataView]"]=hr["[object Date]"]=hr["[object Error]"]=hr["[object Function]"]=hr["[object Map]"]=hr["[object Number]"]=hr["[object Object]"]=hr["[object RegExp]"]=hr["[object Set]"]=hr["[object String]"]=hr["[object WeakMap]"]=!1;var gr=function baseIsTypedArray(e){return I(e)&&ir(e.length)&&!!hr[y(e)]};var vr=function baseUnary(e){return function(t){return e(t)}},yr=createCommonjsModule((function(e,t){var r=t&&!t.nodeType&&t,i=r&&e&&!e.nodeType&&e,n=i&&i.exports===r&&a.process,s=function(){try{var e=i&&i.require&&i.require("util").types;return e||n&&n.binding&&n.binding("util")}catch(e){}}();e.exports=s})),Ir=yr&&yr.isTypedArray,_r=Ir?vr(Ir):gr;var Mr=function safeGet(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]},fr=Object.prototype.hasOwnProperty;var Tr=function assignValue(e,t,r){var i=e[t];fr.call(e,t)&&Q(i,r)&&(void 0!==r||t in e)||Dt(e,t,r)};var Er=function copyObject(e,t,r,i){var n=!r;r||(r={});for(var a=-1,s=t.length;++a<s;){var o=t[a],c=i?i(r[o],e[o],o,r,e):void 0;void 0===c&&(c=e[o]),n?Dt(r,o,c):Tr(r,o,c)}return r};var Sr=function baseTimes(e,t){for(var r=-1,i=Array(e);++r<e;)i[r]=t(r);return i},Cr=/^(?:0|[1-9]\d*)$/;var Nr=function isIndex(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&Cr.test(e))&&e>-1&&e%1==0&&e<t},Ar=Object.prototype.hasOwnProperty;var br=function arrayLikeKeys(e,t){var r=n(e),i=!r&&rr(e),a=!r&&!i&&or(e),s=!r&&!i&&!a&&_r(e),o=r||i||a||s,c=o?Sr(e.length,String):[],d=c.length;for(var l in e)!t&&!Ar.call(e,l)||o&&("length"==l||a&&("offset"==l||"parent"==l)||s&&("buffer"==l||"byteLength"==l||"byteOffset"==l)||Nr(l,d))||c.push(l);return c};var Rr=function nativeKeysIn(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t},Or=Object.prototype.hasOwnProperty;var Pr=function baseKeysIn(e){if(!E(e))return Rr(e);var t=Kt(e),r=[];for(var i in e)("constructor"!=i||!t&&Or.call(e,i))&&r.push(i);return r};var Vr=function keysIn(e){return nr(e)?br(e,!0):Pr(e)};var kr=function toPlainObject(e){return Er(e,Vr(e))};var wr=function baseMergeDeep(e,t,r,i,a,s,o){var c=Mr(e,r),d=Mr(t,r),l=o.get(d);if(l)Ut(e,r,l);else{var m=s?s(c,d,r+"",e,t,o):void 0,p=void 0===m;if(p){var u=n(d),h=!u&&or(d),g=!u&&!h&&_r(d);m=d,u||h||g?n(c)?m=c:ar(c)?m=jt(c):h?(p=!1,m=xt(d,!0)):g?(p=!1,m=Gt(d,!0)):m=[]:ur(d)||rr(d)?(m=c,rr(c)?m=kr(c):E(c)&&!C(c)||(m=Jt(d))):p=!1}p&&(o.set(d,m),a(m,d,i,s,o),o.delete(d)),Ut(e,r,m)}};var Lr=function baseMerge(e,t,r,i,n){e!==t&&qt(t,(function(a,s){if(n||(n=new wt),E(a))wr(e,t,s,r,baseMerge,i,n);else{var o=i?i(Mr(e,s),a,s+"",e,t,n):void 0;void 0===o&&(o=a),Ut(e,s,o)}}),Vr)};var Dr=function identity(e){return e};var Ur=function apply(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)},qr=Math.max;var xr=function overRest(e,t,r){return t=qr(void 0===t?e.length-1:t,0),function(){for(var i=arguments,n=-1,a=qr(i.length-t,0),s=Array(a);++n<a;)s[n]=i[t+n];n=-1;for(var o=Array(t+1);++n<t;)o[n]=i[n];return o[t]=r(s),Ur(e,this,o)}};var Br=function constant(e){return function(){return e}},Fr=Lt?function(e,t){return Lt(e,"toString",{configurable:!0,enumerable:!1,value:Br(t),writable:!0})}:Dr,Gr=Date.now;var jr=function shortOut(e){var t=0,r=0;return function(){var i=Gr(),n=16-(i-r);if(r=i,n>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}},Hr=jr(Fr);var Yr=function baseRest(e,t){return Hr(xr(e,t,Dr),e+"")};var $r=function isIterateeCall(e,t,r){if(!E(r))return!1;var i=typeof t;return!!("number"==i?nr(r)&&Nr(t,r.length):"string"==i&&t in r)&&Q(r[t],e)};var Wr,zr,Kr=function createAssigner(e){return Yr((function(t,r){var i=-1,n=r.length,a=n>1?r[n-1]:void 0,s=n>2?r[2]:void 0;for(a=e.length>3&&"function"==typeof a?(n--,a):void 0,s&&$r(r[0],r[1],s)&&(a=n<3?void 0:a,n=1),t=Object(t);++i<n;){var o=r[i];o&&e(t,o,i,a)}return t}))},Jr=Kr((function(e,t,r){Lr(e,t,r)}));!function(e){e[e.Unset=0]="Unset",e[e.RN=2]="RN",e[e.UNIAPP=3]="UNIAPP",e[e.Electron=5]="Electron",e[e.WeiXin=6]="WeiXin",e[e.BROWSER=100]="BROWSER",e[e.H5=101]="H5",e[e.Ali=102]="Ali",e[e.Baidu=103]="Baidu",e[e.Tiktok=104]="Tiktok"}(Wr||(Wr={})),function(e){e[e.kStatNetTypeUnkonw=0]="kStatNetTypeUnkonw",e[e.kStatNetTypeEthernet=1]="kStatNetTypeEthernet",e[e.kStatNetTypeWifi=2]="kStatNetTypeWifi",e[e.kStatNetType2G=3]="kStatNetType2G",e[e.kStatNetType3G=4]="kStatNetType3G",e[e.kStatNetType4G=5]="kStatNetType4G",e[e.kStatNetType5G=6]="kStatNetType5G"}(zr||(zr={}));var Qr={wifi:zr.kStatNetTypeWifi,"2g":zr.kStatNetType2G,"3g":zr.kStatNetType3G,"4g":zr.kStatNetType4G,"5g":zr.kStatNetType5G,ethernet:zr.kStatNetTypeEthernet,unknown:zr.kStatNetTypeUnkonw,none:zr.kStatNetTypeUnkonw,notreachable:zr.kStatNetTypeUnkonw,wwan:zr.kStatNetTypeUnkonw};function base64ToArrayBuffer(e){for(var t=function base64Decode(e){var t=String(e).replace(/[=]+$/,"");if(t.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,i=0,n=0,a=0,s="";r=t.charAt(a++);~r&&(n=i%4?64*n+r:r,i++%4)?s+=String.fromCharCode(255&n>>(-2*i&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return s}(e),r=t.length,i=new Uint8Array(r),n=0;n<r;n++)i[n]=t.charCodeAt(n);return i.buffer}var Xr={setLogger:function(e){throw new Error("Function not implemented.")},platform:"",WebSocket:class AdapterSocket{constructor(e,t){throw this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",new Error("Method not implemented.")}close(e,t){throw new Error("Method not implemented.")}send(e){throw new Error("Method not implemented.")}onclose(e){throw new Error("Method not implemented.")}onerror(e){throw new Error("Method not implemented.")}onmessage(e){throw new Error("Method not implemented.")}onopen(e){throw new Error("Method not implemented.")}},localStorage:{},request:function(e,t){throw new Error("Function not implemented.")},uploadFile:function(e){throw new Error("Function not implemented.")},getSystemInfo:function(){throw new Error("Function not implemented.")},getFileUploadInformation(e){throw new Error("Function not implemented.")},net:{__getEnv:()=>null,__onNetworkStatusChangeFn:null,getNetworkStatus(){var e=this.__getEnv();return new Promise(((t,r)=>{e.getNetworkType({success:function(e){var r=!1;r="boolean"==typeof e.networkAvailable?e.networkAvailable:"none"!==e.networkType.toLowerCase(),t({net_type:Qr[e.networkType.toLowerCase()],net_connect:r})},fail:function(){r(new Error("getNetworkType failed"))}})}))},onNetworkStatusChange(e){var t=this.__getEnv();this.offNetworkStatusChange(),t.onNetworkStatusChange&&(this.__onNetworkStatusChangeFn=function(t){var r=t.networkType.toLowerCase();e({isConnected:t.isConnected||"none"!==r,networkType:Qr[r]})},t.onNetworkStatusChange(this.__onNetworkStatusChangeFn))},offNetworkStatusChange(){var e=this.__getEnv();e.offNetworkStatusChange&&(this.__onNetworkStatusChangeFn&&e.offNetworkStatusChange(this.__onNetworkStatusChangeFn),this.__onNetworkStatusChangeFn=null)}}};class PromiseManager{constructor(){this.abortFns=[]}add(e){var t=function getPromiseWithAbort(e){var t={},r=new Promise((function(e,r){t.abort=r}));return t.promise=Promise.race([e,r]),t}(e);return this.abortFns.push(t.abort),t.promise}clear(e){this.abortFns.forEach((t=>t(e||new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"Aborted"}})))),this.abortFns=[]}destroy(){this.clear()}}var Zr={tolerantRTT:3e3,bestRTT:100,maxChances:5,enable:!0},ei={timestamp:0,rtt:0,baseClock:0,baseTime:0};class TimeOrigin{constructor(e,t,r="getServerTime"){this.serverOrigin=ei,this.config=Zr,this.isSettingNTP=!1,this.currentChance=0,this.failedDelay=2e3,this.successDelay=3e5,this.timer=0,this.cmdName="getServerTime",this.core=e,this.logger=e.logger,this.promiseManager=new PromiseManager,this.cmdName=r,t&&this.setOptions(t)}setOptions(e){this.config=Object.assign({},Zr,this.config,e)}reset(){this.timer&&clearTimeout(this.timer),this.promiseManager.clear(),this.serverOrigin=ei,this.currentChance=0}setOriginTimetick(){return __awaiter(this,void 0,void 0,(function*(){if(this.config.enable&&!(this.isSettingNTP||this.currentChance>=this.config.maxChances)){var e=Ne(this.core,"auth.status"),t=Ne(this.core,"status"),r=Ne(this.core,"V2NIMLoginService.lifeCycle.loginStatus");if("logined"===e||"logined"===t||r===qe.V2NIM_LOGIN_STATUS_LOGINED){this.isSettingNTP=!0,this.currentChance++,this.timer&&clearTimeout(this.timer),this.timer=0;var i,n="TimeOrigin::setOriginTimetick:",a=Date.now();this.core.logger.log(`${n} getServerTime start, times ${this.currentChance}`);try{var s=yield this.promiseManager.add(this.core.sendCmd(this.cmdName));i=Ne(s,"content.time"),this.isSettingNTP=!1}catch(e){var o=e;return this.isSettingNTP=!1,this.logger.warn(`${n} Calculate Delay time, getServerTime error`,o),void(o.code!==Ct.V2NIM_ERROR_CODE_CANCELLED&&(this.timer=setTimeout(this.setOriginTimetick.bind(this),this.failedDelay)))}if(!i)return this.core.logger.warn(`${n} Calculate Delay time incorrect format`),void(this.config.enable=!1);var c=Date.now()-a;this.doSet(i,c)}}}))}doSet(e,t){var r="TimeOrigin::setOriginTimetick:";t>this.config.tolerantRTT?(this.logger.warn(`${r} Denied, cause of exceeding the maximum tolerance range of RTT: ${t}`),this.timer=setTimeout(this.setOriginTimetick.bind(this),this.failedDelay)):t>this.config.bestRTT?(this.serverOrigin.rtt&&t>=this.serverOrigin.rtt?this.logger.log(`${r} Denied, cause of current.RTT >= serverOrigin.RTT: ${t}`):(this.setServerOrigin(t,e),this.logger.log(`${r} Accept within maximum tolerance range of RTT: ${t}, ntpTimestamp: ${this.serverOrigin.timestamp}, localClock: ${this.serverOrigin.baseClock}, localTime: ${this.serverOrigin.baseTime}`)),this.timer=setTimeout(this.setOriginTimetick.bind(this),this.failedDelay)):(this.setServerOrigin(t,e),this.logger.log(`${r} Accept within best RTT: ${t}, ntpTimestamp: ${this.serverOrigin.timestamp}, localClock: ${this.serverOrigin.baseClock}, localTime: ${this.serverOrigin.baseTime}`),this.currentChance=0,this.timer=setTimeout(this.setOriginTimetick.bind(this),this.successDelay))}getNTPTime(e){if(void 0===e&&(e=this.getTimeNode()),this.checkNodeReliable(e)){var t=Math.floor(e.time-this.serverOrigin.baseTime);return this.serverOrigin.timestamp+t}return Date.now()}checkNodeReliable(e){if(void 0===e&&(e=this.getTimeNode()),this.serverOrigin.timestamp){if(0===this.serverOrigin.baseClock)return!0;var t=e.clock-this.serverOrigin.baseClock,r=e.time-this.serverOrigin.baseTime;return Math.abs(r-t)<500}return!1}checkPerformance(){return"BROWSER"===Xr.platform&&!("undefined"==typeof performance||!performance.now)}static checkPerformance(){return"BROWSER"===Xr.platform&&!("undefined"==typeof performance||!performance.now)}getTimeNode(){return{clock:this.checkPerformance()?performance.now():0,time:Date.now()}}static getTimeNode(){return{clock:TimeOrigin.checkPerformance()?performance.now():0,time:Date.now()}}setServerOrigin(e,t){this.serverOrigin={timestamp:t+Math.floor(e/2),rtt:e,baseClock:this.checkPerformance()?performance.now():0,baseTime:Date.now()}}}var ti={},ri={};function createCmd(e,t,r,i){var n=ti[e];if(!n)return r.error("createCmd:: can not find cmd config: ",e),null;var a={SER:t,SID:n.sid,CID:n.cid,Q:[]};return n.params&&i&&n.params.forEach((function(e){var t=i[e.name];if(null!=t){var r=e.type,{reflectMapper:n,select:s}=e;switch(e.type){case"PropertyArray":r="ArrayMable",t=t.map((e=>({t:"Property",v:n?serialize(e,n,s):e})));break;case"Property":t=n?serialize(t,n,s):t;break;case"Bool":t=t?"true":"false"}a.Q.push({t:r,v:t})}})),{packet:a,hasPacketResponse:"boolean"!=typeof n.hasPacketResponse||n.hasPacketResponse,hasPacketTimer:"boolean"!=typeof n.hasPacketTimer||n.hasPacketTimer}}function parseCmd(e,t){var r;try{r=JSON.parse(e)}catch(r){return void t.error(`Parse command error:"${e}"`)}var i=r.sid+"_"+r.cid,n=r.r;if(["4_1","4_2","4_10","4_11"].includes(i)){var a=r.r[1].headerPacket;i=`${a.sid}_${a.cid}`,r.sid=a.sid,r.cid=a.cid,n=r.r[1].body}var s=ri[i],o=[];if(s){for(var c of s)o.push(parseEachCmd(r,c.config,c.cmd,n,t));return o}t.error("parseCmd:: mapper not exist",i,r.code)}function parseEachCmd(e,t,r,i,n){var a,s={cmd:r,raw:e,error:null,service:null==t?void 0:t.service,content:{},__receiveTimeNode:TimeOrigin.getTimeNode()};if(!r||!t)return s.notFound=!0,s;(18===t.sid||t.sid>=26&&t.sid<100)&&(e.code=function toReadableCode(e){if("number"!=typeof e||e!=e)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"Read code failed",rawData:`${e}`}});if(e<0||e>=0&&e<1e3||e>=2e4&&e<=20099)return e;var t=(65535&e)>>9;t-=t<=38?1:2;return 1e5+1e3*t+(511&e)}(e.code));var o=function genCmdError(e,t){var r=Nt[e],i=bt[e];return null===i?null:new V2NIMErrorImpl({code:e,desc:r||i||e,detail:{cmd:t,timetag:Date.now()}})}(e.code,r);if(s.error=o,s.error){if(s.error.detail.cmd=r,!(null===(a=null==t?void 0:t.ignoreErrCodes)||void 0===a?void 0:a.includes(e.code)))return s;n.warn("parseCmd:: ignore error ",s.error),s.error.detail.ignore=!0}return t.response&&t.response.forEach(((e,t)=>{var r=i[t],n=e.type,a=e.name,o=e.reflectMapper;if(!Tt(r))switch(n){case"Property":s.content[a]=o?deserialize(r,o):r;break;case"PropertyArray":s.content[a]=r.map((e=>o?deserialize(e,o):e));break;case"Int":case"Long":case"Byte":s.content[a]=+r;break;case"Bool":s.content[a]="true"===r||!0===r||1===r;break;default:s.content[a]=r}})),s}function serialize(e,t,r){var i={};for(var n in e=function flattenObjByMapper(e,t){var r={};for(var i in t){var n=t[i],a="number"==typeof n?i:n.access?n.access:i,s=a.split("."),o=e;for(var c of s){if(void 0===o[c]||null===o[c]){o=void 0;break}o=o[c]}void 0!==o&&(r[a]=o)}return r}(e,t),t){var a=t[n],s="number"==typeof a?n:a.access?a.access:n;if(!r||r.includes(n))if(s in e){if("number"==typeof a)i[a]=e[s];else if("object"==typeof a)if(a.converter){var o=a.converter(e[s],e);void 0!==o&&(i[a.id]=o)}else i[a.id]=e[s]}else"object"==typeof a&&a.def&&("function"==typeof a.def?i[a.id]=a.def(e):i[a.id]=a.def)}return i}function deserialize(e,t){var r={};for(var i in e){var n=t[i];if("string"==typeof n)r[n]=e[i];else if("object"==typeof n&&"prop"in n){var a=n.access?n.access:n.prop;if(n.converter){var s=n.converter(e[i],e);void 0!==s&&(r[a]=s)}else n.type&&"number"===n.type?r[a]=+e[i]:n.type&&"boolean"===n.type?r[a]=!("0"===e[i]||!e[i]):r[a]=e[i]}}for(var o in t){var c=t[o];if(c&&void 0!==c.def){var d=c.access?c.access:c.prop;d in r||("function"==typeof c.def?r[d]=c.def(e):r[d]=c.def)}}return r=function unflattenObj(e){var t={},_loop=function(r){var i=r.split(".");i.reduce((function(t,n,a){return t[n]||(t[n]=isNaN(Number(i[a+1]))?i.length-1==a?e[r]:{}:[])}),t)};for(var r in e)_loop(r);return t}(r),r}function registerParser(e){for(var t in Object.assign(ti,e.cmdConfig),e.cmdMap){var r=e.cmdMap[t],i=e.cmdConfig[r];if(i)if(Array.isArray(ri[t])){var n=!1;for(var a of ri[t])if(a.cmd===r&&a.config.service===i.service){n=!0;break}n||ri[t].push({config:i,cmd:r})}else ri[t]=[{config:i,cmd:r}]}}function invertSerializeMap(e){var t={};return Object.keys(e).forEach((r=>{t[r]=invertSerializeItem(e[r])})),t}function invertSerializeItem(e){var t={};for(var r in e){var i=e[r];"number"==typeof i?t[i]=r:"object"==typeof i&&(t[i.id]={prop:r,type:i.retType,access:i.retAccess?i.retAccess:i.access?i.access:r,def:i.retDef,converter:i.retConverter})}return t}function boolToInt(e){return e?1:0}function objectToJSONString(e){if(e&&"object"==typeof e)try{return JSON.stringify(e)}catch(e){return}}function stringToJSONObject(e){if(e&&"string"==typeof e)try{return JSON.parse(e)}catch(e){return}}var ii,ni,ai,si,oi,ci={"1_2":"heartbeat","2_3":"login","2_5":"kicked","2_6":"logout","2_7":"nimLoginClientChange","2_8":"kick"},di={login:{clientType:3,os:4,sdkVersion:6,appLogin:8,protocolVersion:9,pushTokenName:10,pushToken:11,deviceId:13,appkey:18,account:19,browser:24,clientSession:26,deviceInfo:32,isReactNative:112,token:1e3,customTag:38,customClientType:39,sdkHumanVersion:40,hostEnv:41,userAgent:42,libEnv:44,authType:115,loginExt:116},loginRes:{lastLoginDeviceId:17,customTag:38,connectionId:102,ip:103,port:104,country:106,hasXMPush:111},loginPort:{type:3,os:4,mac:5,deviceId:13,account:19,deviceInfo:32,customTag:38,customClientType:39,connectionId:102,ip:103,port:104,time:109,pushType:110,hasTokenPreviously:111},aosPushInfo:{pushType:110,hasTokenPreviously:111}},li=invertSerializeMap(di),mi={login:{sid:2,cid:3,service:"auth",params:[{type:"Property",name:"login",reflectMapper:di.login}],response:[{type:"Property",name:"loginRes",reflectMapper:li.loginRes},{type:"PropertyArray",name:"loginPorts",reflectMapper:li.loginPort},{type:"Property",name:"aosPushInfo",reflectMapper:li.aosPushInfo}]},logout:{sid:2,cid:6,service:"auth"},heartbeat:{sid:1,cid:2,service:"auth"},kicked:{sid:2,cid:5,service:"auth",response:[{type:"Int",name:"clientType"},{type:"Int",name:"reason"},{type:"String",name:"ext"},{type:"Int",name:"customClientType"}]},nimLoginClientChange:{sid:2,cid:7,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:li.loginPort}]},kick:{sid:2,cid:8,service:"auth",params:[{type:"StrArray",name:"deviceIds"}],response:[{type:"StrArray",name:"deviceIds"}]}};!function(e){e[e.text=0]="text",e[e.image=1]="image",e[e.audio=2]="audio",e[e.video=3]="video",e[e.geo=4]="geo",e[e.notification=5]="notification",e[e.file=6]="file",e[e.tip=10]="tip",e[e.robot=11]="robot",e[e.g2=12]="g2",e[e.custom=100]="custom"}(ii||(ii={})),function(e){e[e.p2p=0]="p2p",e[e.team=1]="team",e[e.superTeam=5]="superTeam"}(ni||(ni={})),function(e){e[e.Android=1]="Android",e[e.iOS=2]="iOS",e[e.PC=4]="PC",e[e.WindowsPhone=8]="WindowsPhone",e[e.Web=16]="Web",e[e.Server=32]="Server",e[e.Mac=64]="Mac",e[e.HarmonyOS=65]="HarmonyOS"}(ai||(ai={})),function(e){e[e.unread=1]="unread",e[e.read=2]="read",e[e.deleted=3]="deleted",e[e.sending=4]="sending",e[e.sendFailed=5]="sendFailed",e[e.sent=6]="sent",e[e.receipt=7]="receipt",e[e.refused=10]="refused"}(si||(si={})),function(e){e[e.default=0]="default",e[e.leave=1]="leave",e[e.roam=2]="roam"}(oi||(oi={}));var pi=$t(Object.keys,Object),ui=Object.prototype.hasOwnProperty;var hi=function baseKeys(e){if(!Kt(e))return pi(e);var t=[];for(var r in Object(e))ui.call(e,r)&&"constructor"!=r&&t.push(r);return t};var gi,vi=function keys(e){return nr(e)?br(e):hi(e)},yi=Kr((function(e,t,r,i){Er(t,vi(t),e,i)})),Ii=(gi=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},function(){return gi()+gi()+gi()+gi()+gi()+gi()+gi()+gi()});function getEnumKeys(e){return Object.keys(e).filter((e=>!(+e>=0)))}function getEnumValues(e){return Object.keys(e).filter((e=>+e>=0)).map((e=>parseInt(e)))}function getEnumKeyByEnumValue(e,t){var r=Object.keys(e).filter((r=>e[r]==t));return r.length>0?r[0]:void 0}function getAccountFromSessionId(e,t="-"){if(!e)throw new CustomError("No sessionId",{},400);var r=e.indexOf(t);if(-1===r)throw new CustomError("Can not find conjunctions",{},400);var i=e.slice(0,r);return{accid:e.slice(r+1),scene:"super_team"===i?"superTeam":i}}function getMiniappEnv(){return"undefined"!=typeof tt&&tt.getSystemInfo?"TT":"undefined"!=typeof swan&&swan.getSystemInfo?"BAIDU":"undefined"!=typeof my&&my.getSystemInfo?"ALI":"undefined"!=typeof wx&&wx.getSystemInfo?"WX":"unknow environment"}function assignOptions(e,t){return yi({},e,t,(function(e,t){return Tt(t)?e:t}))}function emptyFuncWithPromise(){return Promise.resolve()}function emptyFunc$1(){}function getFileExtension(e){var t=e.lastIndexOf(".");return t>-1?e.slice(t):""}function findIndexWithinTargetValue(e,t,r){return 0===e.length||e[0][t]<=r?0:e[e.length-1][t]>r?e.length:e.findIndex(((i,n)=>{if(e[n-1]&&e[n-1][t]>r&&r>=i[t])return!0}))}function format(e,t){if(!ur(t))return{};var r=JSON.parse(JSON.stringify(t)),i=doFormat(e,r);return JSON.parse(JSON.stringify(Object.assign(Object.assign({},r),i)))}function doFormat(e,t){if(!ur(t))return{};var r={};return Object.keys(e).forEach((i=>{var n=e[i].type;if("string"!=typeof n){var a=doFormat(e[i],t);Object.keys(a).length>0&&(r[i]=a)}else{var s=e[i],o=s.rawKey||i,c=_i[n](t,o,s);void 0!==c&&(t[o]=void 0,r[i]=c)}})),r}var _i={number:function(e,t){if(void 0!==e[t])return+e[t]},string:function(e,t){if(void 0!==e[t])return e[t]},boolean:function(e,t){return+e[t]>0||0!=+e[t]&&void 0},enum:function(e,t,r){return r.values[e[t]]},object:function(e,t){if(void 0!==e[t])try{return JSON.parse(e[t])}catch(e){return{}}}};function formatReverse(e,t){if(!ur(t))return{};var r=JSON.parse(JSON.stringify(t)),i=doFormatReverse(e,r);return JSON.parse(JSON.stringify(Object.assign(Object.assign({},r),i)))}function doFormatReverse(e,t){if(!ur(t))return Object.keys(e).reduce(((t,r)=>(t[e[r].rawKey||r]=void 0,t)),{});var r={};return Object.keys(e).forEach((i=>{var n=e[i].type;if("string"!=typeof n){var a=doFormatReverse(e[i],t[i]);return Object.assign(r,a),void(t[i]=void 0)}var s=e[i],o=s.rawKey||i,c=Mi[n](t,i,s);t[o]=void 0,r[o]=c})),r}var Mi={number:function(e,t){return e[t]},string:function(e,t){return e[t]},boolean:function(e,t){return!0===e[t]?1:!1===e[t]?0:void 0},enum:function(e,t,r){return r.values[e[t]]},object:function(e,t){if(void 0!==e[t])try{return JSON.stringify(e[t])}catch(e){return""}}},fi=Mi;function formatMultiPortLoginInfo(e,t){return e&&e.length>0?e.map((e=>Object.assign(Object.assign({},e),{account:e.account,connectionId:e.connectionId,deviceId:e.deviceId,ip:e.ip,mac:e.mac,os:e.os,type:getEnumKeyByEnumValue(ai,e.type)||e.type,time:parseInt(e.time),online:3!==t}))):[]}var Ti={1:{reason:"samePlatformKick",message:"The same account is not allowed to multiple login at the same time"},2:{reason:"serverKick",message:"Kicked out by IM server"},3:{reason:"otherPlatformKick",message:"Kicked out by other client of your account"},4:{reason:"silentlyKick",message:"Quietly kicked"}};var Ei=Backoff;function Backoff(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}Backoff.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),r=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-r:e+r}return 0|Math.min(e,this.max)},Backoff.prototype.reset=function(){this.attempts=0},Backoff.prototype.setMin=function(e){this.ms=e},Backoff.prototype.setMax=function(e){this.max=e},Backoff.prototype.setJitter=function(e){this.jitter=e};var Si=function setCacheAdd(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this};var Ci=function setCacheHas(e){return this.__data__.has(e)};function SetCache(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new ue;++t<r;)this.add(e[t])}SetCache.prototype.add=SetCache.prototype.push=Si,SetCache.prototype.has=Ci;var Ni=SetCache;var Ai=function baseFindIndex(e,t,r,i){for(var n=e.length,a=r+(i?1:-1);i?a--:++a<n;)if(t(e[a],a,e))return a;return-1};var bi=function baseIsNaN(e){return e!=e};var Ri=function strictIndexOf(e,t,r){for(var i=r-1,n=e.length;++i<n;)if(e[i]===t)return i;return-1};var Oi=function baseIndexOf(e,t,r){return t==t?Ri(e,t,r):Ai(e,bi,r)};var Pi=function arrayIncludes(e,t){return!!(null==e?0:e.length)&&Oi(e,t,0)>-1};var Vi=function arrayIncludesWith(e,t,r){for(var i=-1,n=null==e?0:e.length;++i<n;)if(r(t,e[i]))return!0;return!1};var ki=function cacheHas(e,t){return e.has(t)},wi=x(o,"Set");var Li=function noop(){};var Di=function setToArray(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r},Ui=wi&&1/Di(new wi([,-0]))[1]==1/0?function(e){return new wi(e)}:Li;var qi=function baseUniq(e,t,r){var i=-1,n=Pi,a=e.length,s=!0,o=[],c=o;if(r)s=!1,n=Vi;else if(a>=200){var d=t?null:Ui(e);if(d)return Di(d);s=!1,n=ki,c=new Ni}else c=t?[]:o;e:for(;++i<a;){var l=e[i],m=t?t(l):l;if(l=r||0!==l?l:0,s&&m==m){for(var p=c.length;p--;)if(c[p]===m)continue e;t&&c.push(m),o.push(l)}else n(c,m,r)||(c!==o&&c.push(m),o.push(l))}return o};var xi=function uniq(e){return e&&e.length?qi(e):[]},Bi=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],Fi=["transport not supported","client not handshaken","unauthorized"],Gi=["reconnect"];class BaseWebsocket$1 extends r{constructor(e,t){super(),this.url=t,this.websocket=null,this.socketConnectTimer=0,this.core=e,this.url=t,this.status="disconnected",this.logger=e.logger,this.connect()}connect(){"connecting"!==this.status&&"connected"!==this.status?(this.status="connecting",this.core.adapters.request("https://"+this.url+"/socket.io/1/?t="+Date.now(),{method:"GET",dataType:"text",timeout:this.core.options.xhrConnectTimeout||8e3},{exception_service:6}).then((e=>{if("connecting"===this.status){var[t,r]=e.data.split(":");return this.sessionId=t,this.logger.log(`imsocket::XHR success. status ${this.status}, ${"connecting"===this.status?"continue websocket connection":"stop websocket connection"}`),this._createWebsocket("wss://"+this.url+"/socket.io/1/websocket/"+t)}})).catch((e=>{if("connecting"===this.status){var t=`imsocket::XHR fail. raw message: "${(e=e||{}).message}", code: "${e.code}"`,r=e.code;r="v2"===Ne(this.core,"options.apiVersion")?e.code===Ct.V2NIM_ERROR_CODE_CONNECT_TIMEOUT?Ct.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:Ct.V2NIM_ERROR_CODE_CONNECT_FAILED:408===e.code?408:415;var i=new V2NIMErrorImpl({code:r,detail:{reason:t,rawError:e}});this.logger.error(t),this.status="disconnected",this.emit("handshakeFailed",i)}}))):this.logger.warn("imsocket::socket is connecting or connected",this.status)}close(){if(this.status="disconnected",this.websocket){this.logger.log("imsocket:: close websocket");try{this.websocket.send(this.encodePacket({type:"disconnect"}))}catch(e){this.logger.warn("imsocket::attempt to send encodePacket error",e)}try{this.websocket.close()}catch(e){this.logger.warn("imsocket::attempt to close websocket error",e)}this.clean(),this.emit("disconnect",{code:0,reason:"Active close websocket"})}}clean(){this.status="disconnected",this.websocket&&(this.socketUrl=void 0,this.websocket.onmessage=null,this.websocket.onopen=null,this.websocket.onerror=null,this.websocket.onclose=null,this.websocket=null)}onConnect(){this.status="connected",this.emit("connect"),clearTimeout(this.socketConnectTimer)}_createWebsocket(e){this.socketConnectTimer=setTimeout((()=>{this.logger.error("imsocket::Websocket connect timeout. url: ",this.socketUrl),this.emit("handshakeFailed",new V2NIMErrorImpl({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:415,detail:{reason:`imsocket::Websocket connect timeout. url: ${this.socketUrl}`}}))}),this.core.options.socketConnectTimeout||8e3),this.socketUrl=e,this.websocket=new Xr.WebSocket(e),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onclose=e=>{var t=(null==e?void 0:e.reason)||(null==e?void 0:e.message)||(null==e?void 0:e.errMsg)||"websocket.onclose";this.logger.log(`imsocket::Websocket onclose done. code is ${null==e?void 0:e.code} and reason is ${t}`),this.clean(),this.emit("disconnect",{code:(null==e?void 0:e.code)||0,reason:t})},this.websocket.onerror=e=>{this.logger.error("imsocket::Websocket onerror",e),"logined"===this.core.status&&this.core.clientSocket.ping()}}onMessage(e){var t,r=this.decodePacket(e.data);if(r)switch(r.type){case"connect":this.onConnect();break;case"disconnect":this.close(),this.emit("disconnect",{code:0,reason:"MessageEvent type disconnect"});break;case"message":case"json":this.emit("message",r.data);break;case"event":r.name&&this.emit(r.name,r.args);break;case"error":"unauthorized"===r.reason?this.emit("connect_failed",r.reason):this.emit("error",r.reason),this.logger.error("imsocket::Websocket connect failed, onmessage type error. url: ",this.socketUrl),clearTimeout(this.socketConnectTimer),this.emit("handshakeFailed",new V2NIMErrorImpl({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_CONNECT_FAILED:408,detail:{reason:`imsocket::Websocket connect failed, onMessage socket error. url: ${this.socketUrl}`}}));break;case"heartbeat":null===(t=this.websocket)||void 0===t||t.send(this.encodePacket({type:"heartbeat"}));break;default:this.logger.warn("imsocket::Websocket no handler type",r.type)}}encodePacket(e){var t,r,{type:i,id:n="",endpoint:a="",ack:s}=e,o=null;if(!i)return"";switch(i){case"error":t=e.reason?Fi.indexOf(e.reason):"",r=e.advice?Gi.indexOf(e.advice):"",""===t&&""===r||(o=t+(""!==r?"+"+r:""));break;case"message":""!==e.data&&(o=e.data);break;case"event":t={name:e.name},t=e.args&&e.args.length?{name:e.name,args:e.args}:{name:e.name},o=JSON.stringify(t);break;case"json":o=JSON.stringify(e.data);break;case"connect":e.qs&&(o=e.qs);break;case"ack":o=e.ackId+(e.args&&e.args.length?"+"+JSON.stringify(e.args):"")}var c=[Bi.indexOf(i),n+("data"===s?"+":""),a];return null!=o&&c.push(o),c.join(":")}decodePacket(e){if(e)if("�"!=e.charAt(0)){var t=e.match(/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/);if(t){var r,[,i,n,a,s,o]=t,c={type:Bi[+i],endpoint:s};switch(n&&(c.id=n,c.ack=!a||"data"),c.type){case"error":r=o.split("+"),c.reason=Fi[+r[0]]||"";break;case"message":c.data=o||"";break;case"connect":c.qs=o||"";break;case"event":try{var d=JSON.parse(o);c.name=d.name,c.args=d.args}catch(e){this.logger.error("imsocket::parseData::type::event error",e)}c.args=c.args||[];break;case"json":try{c.data=JSON.parse(o)}catch(e){this.logger.error("imsocket::parseData::type::json error",e)}break;case"ack":if((r=o.match(/^([0-9]+)(\+)?(.*)/))&&(c.ackId=r[1],c.args=[],r[3]))try{c.args=r[3]?JSON.parse(r[3]):[]}catch(e){this.logger.error("imsocket::parseData::type::ack error",e)}}return c}}else this.logger.error("imsocket::unrecognize dataStr",e.slice(0,20))}send(e){var t,r={data:e,type:"message",endpoint:""};null===(t=this.websocket)||void 0===t||t.send(this.encodePacket(r))}}var ji=function baseIsRegExp(e){return I(e)&&"[object RegExp]"==y(e)},Hi=yr&&yr.isRegExp,Yi=Hi?vr(Hi):ji;var $i=function baseDifference(e,t,r,i){var n=-1,a=Pi,s=!0,o=e.length,c=[],d=t.length;if(!o)return c;r&&(t=Ie(t,vr(r))),i?(a=Vi,s=!1):t.length>=200&&(a=ki,s=!1,t=new Ni(t));e:for(;++n<o;){var l=e[n],m=null==r?l:r(l);if(l=i||0!==l?l:0,s&&m==m){for(var p=d;p--;)if(t[p]===m)continue e;c.push(l)}else a(t,m,i)||c.push(l)}return c},Wi=Yr((function(e,t){return ar(e)?$i(e,t):[]}));function replacer(e,t){return t instanceof RegExp?"__REGEXP "+t.toString():t}function validate(e,t={},r,i=!1){var n={};return Object.keys(e).forEach((a=>{var s=e[a].type,o=r?`In ${r}, `:"";if(null==t){var c=`${o}param is null or undefined`;throw i?new ValidateErrorV2({detail:{reason:c,data:{key:a},rules:"required"}}):new ValidateError(c,{key:a},"required")}if(void 0===t[a]){if(!1===e[a].required)return void(n[a]=t[a]);var d=`${o}param '${a}' is required`;throw i?new ValidateErrorV2({detail:{reason:d,data:{key:a},rules:"required"}}):new ValidateError(d,{key:a},"required")}var l=zi[s];if(l&&!l(t,a,e[a],i)){var m=`${o}param '${a}' unexpected`,p={key:a,value:t[a]};throw i?new ValidateErrorV2({detail:{reason:m,data:p,rules:JSON.stringify(e[a],replacer)}}):new ValidateError(m,p,JSON.stringify(e[a],replacer))}n[a]=t[a]})),n}var zi={string:function(e,t,r){var{allowEmpty:i,max:n,min:a,regExp:s}=r,o=e[t];return"string"==typeof o&&((!1!==i||""!==o)&&(!("number"==typeof n&&o.length>n)&&(!("number"==typeof a&&o.length<a)&&!(Yi(s)&&!s.test(o)))))},number:function(e,t,r){var{min:i,max:n}=r,a=e[t];return"number"==typeof a&&(!("number"==typeof i&&a<i)&&!("number"==typeof n&&a>n))},boolean:function(e,t){return"boolean"==typeof e[t]},file:function(e,t){return!0},enum:function(e,t,r){var{values:i}=r,n=e[t];return!i||i.indexOf(n)>-1},jsonstr:function(e,t){try{var r=JSON.parse(e[t]);return"object"==typeof r&&null!==r}catch(e){return!1}},func:function(e,t){return"function"==typeof e[t]},array:function(e,t,r,i=!1){var{itemType:n,rules:a,min:s,max:o,values:c}=r,d=e[t];return!!Array.isArray(d)&&(!("number"==typeof o&&d.length>o)&&(!("number"==typeof s&&d.length<s)&&(!(n&&"enum"!==n&&!d.every((e=>typeof e===n)))&&(("enum"!==n||!c||!Wi(d,...c).length)&&(a&&d.forEach(((e,r)=>validate(a,e,`${t}[${r}]`,i))),!0)))))},object:function(e,t,r,i=!1){var{rules:n,allowEmpty:a}=r,s=e[t];if("object"!=typeof s||null===s)return!1;if(n){var o=Object.keys(n),c=Object.keys(s).filter((e=>o.indexOf(e)>-1));if(!1===a&&0===c.length)return!1;validate(n,s,t,i)}return!0}};function validateConversationId(e,t){if(!e)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE});validate({conversationId:{type:"string",allowEmpty:!1,regExp:new RegExp(`^${e}\\|[1-3]\\|`)}},{conversationId:t},"",!0)}var Ki,Ji="weblink.netease.im:443",Qi=["https://lbs.netease.im/lbs/webconf.jsp"],Xi="https://abt-online.netease.im/v1/api/abt/client/getExperimentInfo",Zi="imElite_sdk_abtest_web";!function(e){e[e.ACTIVE=1]="ACTIVE",e[e.KICKED=2]="KICKED",e[e.OFFLINE=3]="OFFLINE"}(Ki||(Ki={}));class V1ClientSocket{constructor(e,t){this.linkUrls=[],this.isAutoReconnect=!1,this.packetTimeout=3e4,this.packetSer=1,this.retryCount=0,this.reconnectTimer=0,this.backoff=new Ei({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new Map,this.pingTimer=0,this.hasNetworkListener=!1,this.core=e,t&&(this.auth=t),this.logger=e.logger,this.reporter=e.reporter,this.timerManager=e.timerManager}setSessionId(e){}connect(e={},t){return __awaiter(this,void 0,void 0,(function*(){if(validate({linkUrls:{type:"array",itemType:"string",required:!1}},e),!/^(unconnected|waitReconnect)$/.test(this.core.status)){var r=`Core socket status is ${this.core.status}, and would not connect`;return this.logger.warn(r),Promise.reject(r)}this.core.status="connecting",e.linkUrls&&e.linkUrls.length>0&&(this.linkUrls=e.linkUrls.concat(this.linkUrls),this.linkUrls=xi(this.linkUrls)),0===this.linkUrls.length&&this.linkUrls.push(Ji);for(var i=0;i<this.linkUrls.length;i++){var n=this.linkUrls[i],a=(new Date).getTime();try{return yield this.doConnect(n),this.core.status="connected",this.logger.log(`clientsocketV1::connect success with url: ${n}`),n}catch(e){var s=e;t&&t(s,n),this.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,start_time:a,action:0,exception_service:6}),this.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof s.code?s.code:0,description:s.message||`${s.code}`,operation_type:0,target:n},{asyncParams:Xr.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1),this.logger.warn(`clientsocketV1::connect failed with url: ${n}`,e)}}throw 0===this.retryCount?this.doDisconnect(Ki.ACTIVE,"SocketHandshakeFailed"):this.doDisconnect(Ki.OFFLINE,"ReconnectHadRetryAllLinks"),new Error("clientSocketV1::socket xhr or socket connect failed")}))}doConnect(e){var t=!1;return new Promise(((r,i)=>{this.socket=new BaseWebsocket$1(this.core,e),this.socket.on("connect",(()=>{this.logger.log("clientSocketV1::on connect",e),this.core.reporterHookLinkKeep&&(this.core.reporterHookLinkKeep.start(),this.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:e})),t=!0,r()})),this.socket.on("message",this.onMessage.bind(this)),this.socket.on("disconnect",(r=>__awaiter(this,void 0,void 0,(function*(){this.logger.log("clientSocketV1::socket on disconnect",r),this.core.reporterHookLinkKeep&&(yield this.core.reporterHookLinkKeep.update({code:(null==r?void 0:r.code)||0,description:(null==r?void 0:r.reason)||"socket on disconnect",operation_type:1,target:e}),this.core.reporterHookLinkKeep.end(!1)),t=!0,this.doDisconnect(Ki.OFFLINE,"SocketOnDisconnect")})))),this.socket.on("handshakeFailed",(e=>{t?this.ping():(this.logger.error(`clientsocketV1::handshake failed: "${e&&e.message}"`),this.cleanSocket()),t=!0,i(e)}))}))}cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)}beforeConnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer)}resetConnectStatus(){clearTimeout(this.reconnectTimer),this.backoff.reset(),this.retryCount=0,this.initOnlineListener()}doDisconnect(e,t,r){var i,n,a,s,o;if(this.logger.log(`doDisconnect: type ${e}, description ${t}`),"unconnected"!==this.core.status){var c={1:"close",2:"kicked",3:"broken"}[e]||"";this.markAllCmdInvaild(new V2NIMErrorImpl({code:415,desc:"Packet timeout due to instance disconnect",detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:c}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket();var d=!this.core.options.needReconnect||this.retryCount>=this.core.options.reconnectionAttempts;if(e===Ki.ACTIVE||d)this.logger.log("doDisconnect: emit disconnect, type "+e,d),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(i=this.auth)||void 0===i||i.emit("disconnect"),this.destroyOnlineListener();else if(e===Ki.KICKED){this.logger.log("doDisconnect: kicked"),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer);var l="string"==typeof t?{reason:"unknow",message:t}:t;this.core.eventBus.emit("kicked",l),this.core.emit("kicked",l),null===(n=this.auth)||void 0===n||n.emit("kicked",l),this.destroyOnlineListener()}else e===Ki.OFFLINE&&this.core.V1NIMLoginService.isManualLoginAttempt?(this.logger.log("doDisconnect: offline in manual login phase. no reconnect"),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.destroyOnlineListener()):e===Ki.OFFLINE&&(null===(s=null===(a=this.auth)||void 0===a?void 0:a.authenticator)||void 0===s?void 0:s.checkLoginTerminalCode(null==r?void 0:r.code))?(this.logger.log(`doDisconnect: login terminal code ${null==r?void 0:r.code}, no reconnect`),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.destroyOnlineListener(),this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(o=this.auth)||void 0===o||o.emit("disconnect")):e===Ki.OFFLINE?(this.logger.log("doDisconnect: start to reconnect"),this.attempToReconnect()):this.logger.log("doDisconnect: nothing to do")}else this.logger.warn("doDisconnect: already unconnected")}attempToReconnect(){var e,t;if("waitReconnect"!==this.core.status){0===this.retryCount&&(this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(e=this.auth)||void 0===e||e.emit("disconnect"));var r=this.backoff.duration();this.retryCount++,this.logger.log(`willReconnect ${this.retryCount} ${r}`),this.core.eventBus.emit("willReconnect",{retryCount:this.retryCount,duration:r}),this.core.emit("willReconnect",{retryCount:this.retryCount,duration:r}),null===(t=this.auth)||void 0===t||t.emit("willReconnect",{retryCount:this.retryCount,duration:r}),this.core.status="waitReconnect",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){"waitReconnect"===this.core.status?!1===(yield Xr.net.getNetworkStatus()).net_connect?(this.logger.log("doDisconnect: skip this reconnection attempt because network is offline"),this.core.status="connecting",this.retryCount>=this.core.options.reconnectionAttempts?this.doDisconnect(Ki.OFFLINE,"MaxReconnectionAttemptExceed"):this.attempToReconnect()):this.core.V1NIMLoginService.login({isAutoReconnect:!0}).catch((()=>{this.logger.error(`clientsocketV1::attempToReconnect failed ${this.retryCount}`)})):this.logger.warn(`doDisconnect: reconnectTimer status is ${this.core.status}, would not go on reconnecting`)}))),r)}else this.logger.warn("doDisconnect: already is waiting reconnect")}sendCmd(e,t,r){if("logined"!==this.core.status&&"login"!==e&&"chatroomLogin"!==e&&"qchatLogin"!==e)return this.logger.warn(`instance status is ${this.core.status}, so can not sendCmd ${e}`),Promise.reject({cmd:e,error:{code:"No_connected",message:"Connection not established",timetag:(new Date).getTime()}});if(!this.socket||!this.socket.send)return Promise.reject("No_socket");var i="heartbeat"!==e,n=i?this.packetSer++:0,a=createCmd(e,n,this.logger,t);if(!a){var s=`SendCmd ${n} ${e} error`;return this.logger.error(s),Promise.reject(new Error(s))}var{packet:o,hasPacketResponse:c,hasPacketTimer:d}=a,l=JSON.stringify(o);i&&("debug"===this.core.options.debugLevel?this.logger.debug("clientsocketV1::sendCmd",e,`ser:${n}`,l):this.logger.log("clientsocketV1::sendCmd",e,`ser:${n}`));var m=(new Date).getTime();return new Promise(((i,a)=>{c&&this.sendingCmdMap.set(n,{cmd:e,params:t,callback:[i,a],timer:d?setTimeout((()=>{var t=new V2NIMErrorImpl({code:408,desc:"Packet Timeout",detail:{reason:"Packet Timeout",cmd:e,ser:n,timetag:Date.now()}});this.markCmdInvalid(n,t,e)}),r&&r.timeout?r.timeout:this.core.config.timeout):null});try{this.socket.send(l),c||i(o)}catch(t){var s=new V2NIMErrorImpl({code:415,detail:{reason:t&&t.message||"Unable to send packet",cmd:e,ser:n,timetag:Date.now(),rawError:t}});this.markCmdInvalid(n,s,e),a(t)}})).catch((e=>{var t;if(![408,415].includes(e.code))return Promise.reject(e);this.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,trace_id:null===(t=this.socket)||void 0===t?void 0:t.sessionId,start_time:m,action:2,exception_service:6});var r=Ne(e,"data.disconnect_reason")||"",i=408===e.code?"Send failed due to timeout":"Send failed. Reason unknown";return i=415===e.code?JSON.stringify({disconnect_reason:r}):i,this.reporter.reportTraceUpdateV2("exceptions",{code:e.code||415,description:i,operation_type:1,target:`${o.SID}-${o.CID}`,context:`${o.SER}`},{asyncParams:Xr.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1),Promise.reject(e)}))}onMessage(e){var t=parseCmd(e,this.logger);if(t)for(var r of t){var i=r.raw.ser;if(r.error&&this.logger.error("core:onMessage packet error",`${r.raw.sid}_${r.raw.cid}, ser:${i},`,r.error),r.notFound)return void this.logger.warn("clientsocketV1::onMessage packet not found",`${r.raw.sid}_${r.raw.cid}, ser:${i}`);"heartbeat"!==r.cmd&&("debug"===this.core.options.debugLevel?this.logger.debug(`imsocket::recvCmd ser:${i}`,r.cmd,r.content):this.logger.log(`imsocket::recvCmd ser:${i}`,r.cmd)),this.packetHandler(r)}}packetHandler(e){var t,r;if(e){var i=e.raw.ser,n=this.sendingCmdMap.get(i);if(n&&n.cmd===e.cmd){var{callback:a,timer:s,params:o}=n;if(clearTimeout(s),e.params=o,this.sendingCmdMap.delete(i),"heartbeat"===e.cmd)return void a[0]();var c=null===(t=this.core[e.service])||void 0===t?void 0:t.process(e);c&&"function"==typeof c.then?c.then((e=>{a[0](e)})).catch((e=>{a[1](e)})):(this.logger.log("imsocket:: handlerFn without promise",e.service,e.cmd),a[0]())}else null===(r=this.core[e.service])||void 0===r||r.process(e)}}markCmdInvalid(e,t,r){var i=this.sendingCmdMap.get(e);if(i){var{callback:n,timer:a}=i;a&&clearTimeout(a),this.sendingCmdMap.delete(e),this.logger.warn(`packet ${e}, ${r} is invalid:`,t),n[1](t)}}markAllCmdInvaild(e){this.logger.log("markAllCmdInvaild",e),this.sendingCmdMap.forEach((t=>{var{callback:r,timer:i,cmd:n}=t;this.logger.debug(`markAllCmdInvaild:: cmd "${n}"`),i&&clearTimeout(i),r[1](e)})),this.sendingCmdMap.clear()}ping(){var e;return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);try{yield this.sendCmd("heartbeat")}catch(t){if(yield this.testHeartBeat5Timeout())return this.core.reporterHookLinkKeep&&(yield this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(e=this.socket)||void 0===e?void 0:e.url}),this.core.reporterHookLinkKeep.end(!0)),void this.doDisconnect(Ki.OFFLINE,"PingError")}this.pingTimer=setTimeout((()=>{this.ping()}),3e4)}))}testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);for(var e=0;e<5;e++)try{return yield this.sendCmd("heartbeat",{},{timeout:3e3}),!1}catch(t){this.logger.debug(`clientsocketV1:: test heartbeat ${e} Timeout`)}return!0}))}initOnlineListener(){this.hasNetworkListener||(this.logger.log("clientsocketV1::onlineListener:init"),this.hasNetworkListener=!0,Xr.net.onNetworkStatusChange((e=>{this.logger.log("clientsocketV1::onlineListener:network change",e),e.isConnected&&"logined"===this.core.status?this.ping():e.isConnected&&"waitReconnect"===this.core.status?(this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.core.V1NIMLoginService.login({isAutoReconnect:!0}).catch((()=>{this.logger.error(`clientsocketV1::attempToReconnect failed ${this.retryCount}`)}))):e.isConnected||this.doDisconnect(Ki.OFFLINE,"OfflineListener")})))}destroyOnlineListener(){this.logger.log("clientsocketV1::onlineListener:destroy"),Xr.net.offNetworkStatusChange(),this.hasNetworkListener=!1}disconnect(){switch(this.core.status){case"connected":case"logined":case"connecting":case"waitReconnect":return this.doDisconnect(Ki.ACTIVE,"UserActiveDisconnect"),Promise.resolve();default:return Promise.resolve()}}}class V1NIMLoginLbs{constructor(e){this.socketLinkUrls=[],this.timer=0,this.failedCount=0,this.core=e,this.auth=e.V1NIMLoginService,this.logger=this.core.logger}getLbsInfos(){return __awaiter(this,void 0,void 0,(function*(){if(this.socketLinkUrls.length>0){var e=this.socketLinkUrls;return this.socketLinkUrls=[],this.core.logger.log("V1NIMLoginService::getLbsInfos:use cache link",e),Promise.resolve(e)}this.core.reporterHookLBS.start(this.core.account);var t=xi(this.auth.config.lbsUrls);try{var r=yield this.ladderLoad(t);if(200!==r.status||!r.data)throw this.core.logger.error("V1NIMLoginService::getLbsInfos:error status",r.status,r),new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:`V1NIMLoginService::getLbsInfos failed, status ${r.status}`}});this.success(r)}catch(e){var i=e;if(this.core.logger.error(`V1NIMLoginService::lbs getLbsInfos error, use default link: ${this.auth.config.linkUrl}. error:`,e),this.reportForFail(t[0],i.code,i.message),this.checkTerminator(i.code))throw e;this.socketLinkUrls=[this.auth.config.linkUrl]}return this.socketLinkUrls}))}checkTerminator(e){return e===Ct.V2NIM_ERROR_CODE_CANCELLED||e===Ct.V2NIM_ERROR_CODE_TIMEOUT}generateUrl(e){var t=e.indexOf("?")>-1?"&":"?";return e+t+"k="+this.core.options.appkey+"&id="+this.core.auth.getLoginUser()+"&sv=180&pv=1&networkType=0&lv=1"}requstLbs(e){return this.auth.doLoginStepsManager.add(this.core.adapters.request(this.generateUrl(e),{method:"GET",dataType:"json",timeout:8e3}))}setLadderTimer(e,t,r,i){this.timer&&clearTimeout(this.timer);var n=e[t];this.timer=setTimeout((()=>{n&&(this.setLadderTimer(e,t+1,r,i),this.core.logger.log(`V1NIMLoginService::getLbsInfos ${t}:`,n),this.reportForLbsStart(n,t),this.requstLbs(n).then((e=>{this.reset(),r(Object.assign(Object.assign({},e),{url:n}))})).catch((r=>{var a;if(this.core.logger.warn(`V1NIMLoginService::getLbsInfos ${t} failed:`,r),this.failedCount+=1,this.reportForFailOnce(n,r.code,(null===(a=r.detail)||void 0===a?void 0:a.reason)||r.message),this.failedCount>=e.length||this.checkTerminator(r.code))return this.reset(),void i(r)})))}),2e3)}ladderLoad(e){return new Promise(((t,r)=>{e.length>1&&this.setLadderTimer(e,1,t,r);var i=e[0];this.core.logger.log("V1NIMLoginService::getLbsInfos 0:",i),this.reportForLbsStart(i,0),this.requstLbs(i).then((e=>{this.reset(),t(Object.assign(Object.assign({},e),{url:i}))})).catch((t=>{var n;this.failedCount+=1,this.core.logger.warn("V1NIMLoginService::getLbsInfos 0 failed:",t),this.reportForFailOnce(i,t.code,(null===(n=t.detail)||void 0===n?void 0:n.reason)||t.message),(this.failedCount>=e.length||this.checkTerminator(t.code))&&(this.reset(),r(t))}))}))}success(e){var t,r,i=e.data,n=[this.auth.config.linkUrl];Ne(i,"common.link")&&(n=Ne(i,"common.link").concat(n)),Ne(i,'common["link.default"]')&&(n=n.concat(Ne(i,'common["link.default"]'))),this.socketLinkUrls=xi(n),i["nos-chunk"]&&(this.logger.log("getLbsInfos success. lbs.nos-chunk",i["nos-chunk"]),null===(t=this.core.cloudStorage)||void 0===t||t.setOptions({chunkUploadHost:i["nos-chunk"]})),Array.isArray(i.nosup)&&i.nosup.length>0&&(this.logger.log("getLbsInfos success. lbs.nosup",i.nosup),null===(r=this.core.cloudStorage)||void 0===r||r.setOptions({commonUploadHostBackupList:i.nosup,commonUploadHost:i.nosup[0]})),this.core.logger.log("V1NIMLoginService::getLbsInfos success, socket link:",this.socketLinkUrls.slice(0),"chunkUploadHost: ",e.data["nos-chunk"]),this.reportForLbsSuccess(e.url,e.data)}reportForLbsStart(e,t){this.core.reporterHookLBS.updateBegin({target:e,index:t})}reportForLbsSuccess(e,t){this.core.reporterHookLBS.updateComplete({target:e,code:200,body:JSON.stringify(t)}),this.core.reporterHookLBS.end(!0),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:e,code:200,succeed:!0},{asyncParams:Xr.net.getNetworkStatus()})}reportForFailOnce(e,t,r){this.core.reporterHookLBS.updateComplete({target:e,code:t,body:r})}reportForFail(e,t,r){this.core.reporterHookLBS.end(!1),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:e,description:r,code:t,succeed:!1},{asyncParams:Xr.net.getNetworkStatus()})}reset(){this.socketLinkUrls=[],this.failedCount=0,clearTimeout(this.timer)}}class V1NIMLoginAuthenticator{constructor(e){this.core=e}verifyAuthentication(e=!1){var t,r,i;return __awaiter(this,void 0,void 0,(function*(){var n=this.core.options,a=Xr.getSystemInfo(),s=Object.assign(Object.assign({},n),{appLogin:e?0:1,appkey:n.appkey,account:n.account,token:n.token,deviceId:this.core.auth.deviceId,clientSession:this.core.auth.clientSession,clientType:16,protocolVersion:1,sdkVersion:100400,sdkHumanVersion:"10.4.0",os:a.os,browser:a.browser,userAgent:this.core.options.loginSDKTypeParamCompat?"Native/10.4.0":a.userAgent.slice(0,299),libEnv:this.core.options.loginSDKTypeParamCompat?void 0:a.libEnv,hostEnv:this.core.options.loginSDKTypeParamCompat?0:a.hostEnvEnum}),o=a.os.toLowerCase();if("UNIAPP"===Xr.platform&&("ios"===o||"android"===o)){s.isReactNative=1,s.clientType="ios"===o?2:1;var c=!!(null===(t=this.core.offlinePush.authConfig)||void 0===t?void 0:t.honorCertificateName);a.pushDeviceInfo&&a.pushDeviceInfo.MANUFACTURER&&(s.deviceInfo=JSON.stringify(Object.assign({IS_SUPPORT_HONOR:c},a.pushDeviceInfo)))}this.core.logger.log("clientSocketV1::do login ",n.account,null===(i=null===(r=this.core.clientSocket)||void 0===r?void 0:r.socket)||void 0===i?void 0:i.sessionId);var d=yield this.core.clientSocket.sendCmd("login",{login:s});if(d.error)throw d.error;var{loginRes:l,loginPorts:m,aosPushInfo:p}=d.content,u=formatMultiPortLoginInfo(m,2);return(u=u.filter((e=>e.connectionId!==l.connectionId))).length>0&&this.core.emit("multiPortLogin",u),Object.assign(Object.assign({},l),{aosPushInfo:p})}))}checkLoginTerminalCode(e){if(void 0===e)return!1;return[201,302,317,403,404,417,422].includes(e)}}class V2Service extends r{constructor(e,t){super(),this.name=e,this.logger=t.logger,this.core=t}checkV2(){var e=this.core.options.apiVersion;if("v2"===e)return!0;throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:`The version "${e}" of client is not supported.`}})}checkLogin(){if(this.core.V2NIMLoginService.getLoginStatus()!==qe.V2NIM_LOGIN_STATUS_LOGINED)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:"The client is not logged in."}})}emit(e,...t){try{return this.logger.debug(`${this.name}::emit event: "${e.toString()}",`,void 0!==t[0]?t[0]:"",void 0!==t[1]?t[1]:"",void 0!==t[2]?t[2]:""),super.emit(e,...t)}catch(t){return setTimeout((()=>{throw this.logger.error(`${this.name}::emit throw error in setTimeout. event: ${e.toString()}. Error`,t),t}),0),!1}}process(e){var t=this[e.cmd+"Handler"];if("function"==typeof t){if(e.error)return this.logger.error(`${e.cmd}::recvError`,e.error),Promise.reject(e.error);try{var r=t.call(this,e);return Promise.resolve(r)}catch(e){return Promise.reject(e)}}var i=Ne(e,"error.detail.ignore");return e.error&&!i?Promise.reject(e.error):Promise.resolve(e)}}var en={needReconnect:!0,reconnectionAttempts:Number.MAX_SAFE_INTEGER,lbsUrls:Qi,linkUrl:Ji,xhrConnectTimeout:8e3,socketConnectTimeout:8e3};class V1NIMLoginServiceImpl extends V2Service{constructor(e,t){super("V1NIMLoginService",e),this.account="",this.token="",this.deviceId="",this.processId="",this.clientSession="",this.status="unconnected",this.config=en,this.isManualLoginAttempt=!1,registerParser({cmdMap:ci,cmdConfig:mi}),e.V1NIMLoginService=this,t&&this.setOptions(t);var r=new V1ClientSocket(this.core,this);this.clientSocket=r,"v1"===this.core.options.apiVersion&&(this.core.clientSocket=r,this.core.auth=this),this.lbs=new V1NIMLoginLbs(e),this.authenticator=new V1NIMLoginAuthenticator(e),this.doLoginStepsManager=new PromiseManager}reset(){this.lbs.reset()}setOptions(e){e&&Object.keys(e).length>0?(this.config=assignOptions(this.config,e),this.account=e.account||this.core.options.account,this.token=e.token||this.core.options.token,this.core.options=Object.assign(Object.assign({},this.core.options),this.config)):(this.config=assignOptions(this.core.options,this.config),this.account=this.core.options.account,this.token=this.core.options.token);var t="",r="";this.config.isFixedDeviceId?(t=Xr.localStorage.getItem("__NIM_DEVC_ID__")||Ii(),r=Xr.localStorage.getItem("__NIM_CLIENT_SESSION_ID__")||Ii(),Xr.localStorage.setItem("__NIM_DEVC_ID__",t),Xr.localStorage.setItem("__NIM_CLIENT_SESSION_ID__",r)):(t=Ii(),r=Ii()),this.deviceId=t,this.clientSession=r,this.core.reporter.setConfig({common:{dev_id:t}})}connect(e={}){return this.login(e)}login(e={}){return __awaiter(this,void 0,void 0,(function*(){this._checkApiVersion(),e.isAutoReconnect||(this.isManualLoginAttempt=!0,this.processId=Ii()),yield this._connect(e),this.core.abtest.abtRequest();try{yield this.doLogin(e.isAutoReconnect),this.processId=Ii(),this.isManualLoginAttempt=!1}catch(e){throw this.isManualLoginAttempt=!1,e}}))}_connect(e={}){return __awaiter(this,void 0,void 0,(function*(){if(!/^(unconnected|waitReconnect)$/.test(this.core.status)){var t=`NIM status is ${this.core.status}, and would not connect`;return this.logger.warn(t),Promise.reject(t)}this.clientSocket.beforeConnect(),this.core.reporter.reportTraceCancel("login"),this.core.reporter.reportTraceStart("login",{user_id:this.core.options.account,action:e.isAutoReconnect?"auto_login":"manual_login",binary_websocket:!1,process_id:this.processId}),this.core.reporter.reportTraceUpdateV2("login",{code:0,description:JSON.stringify(Object.assign(Object.assign({},this.core.options),{account:"***",token:"***"})),operation_type:"conf_init",succeed:!0,duration:0,target:""},{asyncParams:Xr.net.getNetworkStatus()});var r=yield this.lbs.getLbsInfos();try{var i=yield this.clientSocket.connect({linkUrls:r,isAutoReconnect:e.isAutoReconnect},((e,t)=>{this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:t,code:e.code||408,description:`ws_handshake_failed:${e.message}`,succeed:!1},{asyncParams:Xr.net.getNetworkStatus()})}));i&&this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:i,code:200,succeed:!0},{asyncParams:Xr.net.getNetworkStatus()})}catch(e){throw this.core.reporter.reportTraceEnd("login",!1),e}}))}doLogin(e=!1){return __awaiter(this,void 0,void 0,(function*(){var t;try{t=yield this.authenticator.verifyAuthentication(e),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"2-3",code:200,succeed:!0},{asyncParams:Xr.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("login",!0),this.core.status="logined"}catch(e){var r=e,i=Ne(r,"data.disconnect_reason")||"",n=415===r.code?JSON.stringify({disconnect_reason:i}):r.message;if(this.core.logger.warn("nim login:: login failed",e),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"2-3",code:r.code||0,succeed:!1,description:n},{asyncParams:Xr.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("login",!1),this.clientSocket.doDisconnect(Ki.OFFLINE,this.isManualLoginAttempt?"FailedToInitializeLogin":"ReconnectLoginFailed",e),this.isManualLoginAttempt)throw e;return}try{yield this.core.cloudStorage.init()}catch(e){this.core.logger.error("NIM:login cloudStorage init failed ",e)}this.core.eventBus.emit("logined",t),this.core.emit("logined",t),this.emit("logined",t),this.core.logger.log("login done"),this.clientSocket.resetConnectStatus(),this.clientSocket.ping()}))}disconnect(){return this.logout()}logout(){return __awaiter(this,void 0,void 0,(function*(){switch(this._checkApiVersion(),this.doLoginStepsManager.clear(),this.status){case"logined":try{yield this.clientSocket.sendCmd("logout",void 0,{timeout:1e3}),this.clientSocket.doDisconnect(Ki.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData()}catch(e){this.logger.error("Instance::disconnect sendCmd:logout error",e),this.clientSocket.doDisconnect(Ki.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData()}break;case"connected":case"connecting":case"waitReconnect":return this.clientSocket.doDisconnect(Ki.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),Promise.resolve();case"unconnected":case"destroyed":return Promise.resolve()}}))}kick(e){var t;return __awaiter(this,void 0,void 0,(function*(){this._checkApiVersion();var r=yield this.clientSocket.sendCmd("kick",e);return null===(t=r.content)||void 0===t?void 0:t.deviceIds}))}_checkApiVersion(){if("v1"!==this.core.options.apiVersion)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:'apiVersion is not "v1"'}})}nimLoginClientChangeHandler(e){if(e.error)this.logger.error("nimLoginClientChangeHandler:: error, ",e.error);else{var{datas:t,state:r}=e.content,i=formatMultiPortLoginInfo(t,r);i.length>0&&(this.core.emit("multiPortLogin",i),this.emit("multiPortLogin",i))}}kickedHandler(e){if(e.error)this.logger.error("kickedHandler:: error, ",e.error);else{var t=function formatBeKickedTag$1(e){var t=format({clientType:{type:"enum",values:ai},customClientType:{type:"number"}},e),r=Ti[t.reason];return r=r||{reason:"unknow",message:"Unknown reason"},Object.assign(t,r)}(e.content);this.logger.warn("kicked::",t),this.clientSocket.doDisconnect(Ki.KICKED,t),this.core._clearModuleData()}}getConnectStatus(){switch(this.core.status){case"unconnected":case"destroyed":default:return 0;case"connecting":return 2;case"connected":case"logined":return 1;case"waitReconnect":return 3}}getLoginStatus(){switch(this.core.status){case"unconnected":case"destroyed":case"waitReconnect":default:return 0;case"connecting":case"connected":return 2;case"logined":return 1}}getLoginUser(){return this.core.options.account}}function formatLoginInfo(e){return format({type:{type:"number"},port:{type:"number"},customClientType:{type:"number"},timetag:{type:"number"},loginType:{type:"number"}},e)}class TimerManager{constructor(){this.timerList=[],this.id=1,this.timer=null,this.timeout=0}addTimer(e,t=0,r=1){var i=(new Date).getTime(),n=this.id;return this.timerList.push({id:n,loop:r,count:0,timeout:i+t,interval:t,callback:e}),this.id++,this.checkTimer(i),n}checkTimer(e=(new Date).getTime()){if(this.removeFinished(),0!==this.timerList.length||null==this.timer){var t=0;for(var r of this.timerList)(0===t||t>r.timeout)&&(t=r.timeout);0!==this.timerList.length&&(null===this.timer||t<this.timeout||this.timeout<e)&&(this.timer=setTimeout(this.nowTime.bind(this),t-e),this.timeout=t)}}nowTime(){var e=(new Date).getTime();for(var t of this.timerList)e>=t.timeout&&(t.callback(),t.count++,t.timeout=e+t.interval);this.clerTime(),this.checkTimer(e)}clerTime(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)}deleteTimer(e){for(var t=this.timerList.length-1;t>=0;t--){this.timerList[t].id===e&&this.timerList.splice(t,1)}}removeFinished(){for(var e=this.timerList.length-1;e>=0;e--){var t=this.timerList[e];t.loop>=0&&t.count>=t.loop&&this.timerList.splice(e,1)}}destroy(){this.clerTime(),this.timerList=[],this.id=1,this.timer=null}}var tn=function baseForOwn(e,t){return e&&qt(e,t,vi)};var rn=function baseInverter(e,t,r,i){return tn(e,(function(e,n,a){t(i,r(e),n,a)})),i};var nn=function createInverter(e,t){return function(r,i){return rn(r,e,t(i),{})}},an=Object.prototype.toString,sn=nn((function(e,t,r){null!=t&&"function"!=typeof t.toString&&(t=an.call(t)),e[t]=r}),Br(Dr)),cn={"26_3":"v2Login","26_5":"v2Logout","26_8":"v2KickOffline","26_9":"v2BeKicked","26_10":"v2LoginClientChange","36_1":"v2GetChatroomLinkAddress"},dn={"1_2":"heartbeat","2_7":"nimLoginClientChange","24_8":"qchatLoginClientChange"},ln={webLoginReqTag:{clientType:3,os:4,sdkVersion:6,appLogin:8,protocolVersion:9,pushTokenName:10,pushToken:11,clientId:13,appkey:18,account:19,browser:24,clientSession:26,deviceInfo:32,isReactNative:112,customTag:38,customClientType:39,sdkHumanVersion:40,hostEnv:41,userAgent:42,libEnv:44,authType:115,thirdPartyExtension:116,token:1e3},mixAuthRepTag:{clientId:1,consid:2,ip:3,port:4,type:5,customClientType:6,timetag:7,customTag:8,os:9,pushType:10,hasTokenPreviously:11,loginType:12},nimAuthRepTag:{type:3,os:4,mac:5,clientId:13,account:19,deviceInfo:32,customTag:38,customClientType:39,consid:102,ip:103,port:104,timetag:109,pushType:110,hasTokenPreviously:111},qchatAuthRepTag:{clientId:8,consid:102,ip:103,port:104,type:6,customClientType:13,timetag:105,os:30,pushType:100,hasTokenPreviously:101}},mn={v2Login:{sid:26,cid:3,service:"auth",params:[{type:"Property",name:"tag",reflectMapper:ln.webLoginReqTag}],response:[{type:"Property",name:"data",reflectMapper:sn(ln.mixAuthRepTag)},{type:"PropertyArray",name:"loginClients",reflectMapper:sn(ln.mixAuthRepTag)}]},v2Logout:{sid:26,cid:5,service:"auth"},v2KickOffline:{sid:26,cid:8,service:"auth",params:[{type:"StrArray",name:"clientIds"}],response:[{type:"StrArray",name:"clientIds"}]},v2BeKicked:{sid:26,cid:9,service:"auth",response:[{type:"Int",name:"clientType"},{type:"Int",name:"reason"},{type:"String",name:"reasonDesc"},{type:"Int",name:"customClientType"}]},v2LoginClientChange:{sid:26,cid:10,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:sn(ln.mixAuthRepTag)}]},v2GetChatroomLinkAddress:{sid:36,cid:1,service:"auth",params:[{type:"Long",name:"roomId"},{type:"Bool",name:"miniProgram"}],response:[{type:"StrArray",name:"linkAddress"}]}},pn={heartbeat:{sid:1,cid:2,service:"auth"},nimLoginClientChange:{sid:2,cid:7,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:sn(ln.nimAuthRepTag)}]},qchatLoginClientChange:{sid:24,cid:8,service:"auth",response:[{type:"Byte",name:"state"},{type:"Property",name:"data",reflectMapper:sn(ln.qchatAuthRepTag)}]}},abs=function(e){var t;if(void 0!==e)return(t=BigNumber(e)).sign=1,t},isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},isValidType=function(e){return["number"==typeof e,"string"==typeof e&&e.length>0,isArray(e)&&e.length>0,e instanceof BigNumber].some((function(e){return!0===e}))},un="Invalid Number",hn="Invalid Number - Division By Zero";function BigNumber(e){var t;if(!(this instanceof BigNumber))return new BigNumber(e);if(this.number=[],this.sign=1,this.rest=0,isValidType(e)){if(isArray(e)){for((e.length&&"-"===e[0]||"+"===e[0])&&(this.sign="+"===e[0]?1:-1,e.shift(0)),t=e.length-1;t>=0;t--)if(!this.addDigit(e[t]))return}else for("-"!==(e=e.toString()).charAt(0)&&"+"!==e.charAt(0)||(this.sign="+"===e.charAt(0)?1:-1,e=e.substring(1)),t=e.length-1;t>=0;t--)if(!this.addDigit(parseInt(e.charAt(t),10)))return}else this.number=un}BigNumber.prototype.addDigit=function(e){return function(e){return/^\d$/.test(e)}(e)?(this.number.push(e),this):(this.number=un,!1)},BigNumber.prototype._compare=function(e){var t,r;if(!isValidType(e))return null;if(t=BigNumber(e),this.sign!==t.sign)return this.sign;if(this.number.length>t.number.length)return this.sign;if(this.number.length<t.number.length)return-1*this.sign;for(r=this.number.length-1;r>=0;r--){if(this.number[r]>t.number[r])return this.sign;if(this.number[r]<t.number[r])return-1*this.sign}return 0},BigNumber.prototype.gt=function(e){return this._compare(e)>0},BigNumber.prototype.gte=function(e){return this._compare(e)>=0},BigNumber.prototype.equals=function(e){return 0===this._compare(e)},BigNumber.prototype.lte=function(e){return this._compare(e)<=0},BigNumber.prototype.lt=function(e){return this._compare(e)<0},BigNumber.prototype.subtract=function(e){var t;return void 0===e?this:(t=BigNumber(e),this.sign!==t.sign?(this.number=BigNumber._add(this,t),this):(this.sign=this.lt(t)?-1:1,this.number=abs(this).lt(abs(t))?BigNumber._subtract(t,this):BigNumber._subtract(this,t),this))},BigNumber._add=function(e,t){var r,i=0,n=Math.max(e.number.length,t.number.length);for(r=0;r<n||i>0;r++)e.number[r]=(i+=(e.number[r]||0)+(t.number[r]||0))%10,i=Math.floor(i/10);return e.number},BigNumber._subtract=function(e,t){var r,i=0,n=e.number.length;for(r=0;r<n;r++)e.number[r]-=(t.number[r]||0)+i,e.number[r]+=10*(i=e.number[r]<0?1:0);for(r=0,n=e.number.length-1;0===e.number[n-r]&&n-r>0;)r++;return r>0&&e.number.splice(-r),e.number},BigNumber.prototype.multiply=function(e){if(void 0===e)return this;var t,r,i=BigNumber(e),n=0,a=[];if(this.isZero()||i.isZero())return BigNumber(0);for(this.sign*=i.sign,t=0;t<this.number.length;t++)for(n=0,r=0;r<i.number.length||n>0;r++)a[t+r]=(n+=(a[t+r]||0)+this.number[t]*(i.number[r]||0))%10,n=Math.floor(n/10);return this.number=a,this},BigNumber.prototype.divide=function(e){if(void 0===e)return this;var t,r,i=BigNumber(e),n=[],a=BigNumber(0);if(i.isZero())return this.number=hn,this;if(this.isZero())return this.rest=BigNumber(0),this;if(this.sign*=i.sign,i.sign=1,1===i.number.length&&1===i.number[0])return this.rest=BigNumber(0),this;for(t=this.number.length-1;t>=0;t--)for(a.multiply(10),a.number[0]=this.number[t],n[t]=0;i.lte(a);)n[t]++,a.subtract(i);for(t=0,r=n.length-1;0===n[r-t]&&r-t>0;)t++;return t>0&&n.splice(-t),this.rest=a,this.number=n,this},BigNumber.prototype.mod=function(e){return this.divide(e).rest},BigNumber.prototype.isZero=function(){var e;for(e=0;e<this.number.length;e++)if(0!==this.number[e])return!1;return!0},BigNumber.prototype.toString=function(){var e,t="";if("string"==typeof this.number)return this.number;for(e=this.number.length-1;e>=0;e--)t+=this.number[e];return this.sign>0?t:"-"+t};var gn,vn,yn=Math.pow(2,32);function varintToBytes(e){var t=new Uint8Array(4),r=new DataView(t.buffer),i=0;do{var n=127&e;(e>>>=7)>0&&(n|=128),r.setUint8(i++,n)}while(e>0);return t.slice(0,i)}function decodeText(e){return"function"==typeof TextDecoder?new TextDecoder("utf-8").decode(e):function textDecoder(e){for(var t="",r=0;r<e.length;){var i=e[r],n=0,a=0;if(i<=127?(n=0,a=255&i):i<=223?(n=1,a=31&i):i<=239?(n=2,a=15&i):i<=244&&(n=3,a=7&i),e.length-r-n>0)for(var s=0;s<n;)a=a<<6|63&(i=e[r+s+1]),s+=1;else a=65533,n=e.length-r;t+=String.fromCodePoint(a),r+=n+1}return t}(e)}class Unpack{constructor(e){this.offset=0,this.buffer=new Uint8Array(e),this.view=new DataView(e)}checkBufferBoundaryAccess(){return this.offset>=this.buffer.byteLength}length(){var e;return(null===(e=this.view)||void 0===e?void 0:e.byteLength)||0}getBuffer(){return this.view.buffer}popRaw(e){try{var t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}catch(e){throw new Error("UnpackException raw")}}popByte(){try{var e=this.view.getUint8(this.offset);return this.offset+=1,e}catch(e){throw new Error("UnpackException byte")}}popVarbin(){return this.popRaw(this.popVarInt())}popString(){try{return decodeText(this.popVarbin())}catch(e){throw new Error("UnpackException string")}}popInt(){try{var e=this.view.getUint32(this.offset,!0);return this.offset+=4,e}catch(e){throw new Error("UnpackException int")}}popVarInt(){var e=1,t=0,r=0;do{t+=(127&(r=this.popByte()))*e,e*=128}while(0!=(128&r));return t}popLong(){try{var e=function getBigUint64(e,t=!1){var r=new DataView(e.buffer),[i,n]=t?[4,0]:[0,4],a=r.getUint32(i,t),s=r.getUint32(n,t);return a>0?a*yn+s:s}(this.buffer.slice(this.offset,this.offset+8),!0);return this.offset+=8,Number(e)}catch(e){throw new Error("UnpackException long")}}popShort(){try{var e=this.view.getUint16(this.offset,!0);return this.offset+=2,e}catch(e){throw new Error("UnpackException short")}}popBoolean(){return this.popByte()>0}toString(){return Array.from(new Uint8Array(this.buffer)).toString()}reset(){this.offset=0,this.buffer=null,this.view=null}}class PacketDecoder{constructor(e){this.packetLength=0,this.serviceId=0,this.commandId=0,this.serialId=0,this.tag=0,this.resCode=200,this.innerHeader=null,this.msgId=0,this.unpack=new Unpack(e)}reset(){this.innerHeader=null,this.unpack.reset()}unmarshalHeader(){var e=this._unmarshalHeader();this.packetLength=e.packetLength,this.serviceId=e.serviceId,this.commandId=e.commandId,this.serialId=e.serialId,this.tag=e.tag,this.resCode=e.resCode,4===e.serviceId&&[1,2,10,11].includes(e.commandId)&&(this.msgId=this.unmarshalLong(),this.innerHeader=this._unmarshalHeader())}_unmarshalHeader(){var e=this.unpack.popVarInt(),t=this.unpack.popByte(),r=this.unpack.popByte(),i=this.unpack.popShort(),n=this.unpack.popByte(),a=200;return this.hasRescode(n)&&(a=this.unpack.popShort()),{packetLength:e,serviceId:t,commandId:r,serialId:i,tag:n,resCode:a}}hasRescode(e){return 0!=((e=e||this.tag)&PacketDecoder.RES_CODE)}getHeader(){return{packetLength:this.packetLength,sid:this.serviceId,cid:this.commandId,ser:this.serialId,code:this.resCode}}getInnerHeader(){return this.innerHeader?{sid:this.innerHeader.serviceId,cid:this.innerHeader.commandId}:null}unmarshalProperty(){for(var e=this.unpack.popVarInt(),t={},r=0;r<e;r++){var i=this.unpack.popVarInt(),n=this.unpack.popString();t[i]=n}return t}unmarshalPropertyArray(){for(var e=this.unpack.popVarInt(),t=[],r=0;r<e;r++)t.push(this.unmarshalProperty());return t}unmarshalLong(){return this.unpack.popLong()}unmarshalLongArray(){for(var e=this.unpack.popVarInt(),t=[],r=0;r<e;r++)t.push(this.unpack.popLong());return t}unmarshalStrArray(){for(var e=this.unpack.popVarInt(),t=[],r=0;r<e;r++)t.push(this.unpack.popString());return t}unmarshalStrLongMap(){for(var e=this.unpack.popVarInt(),t={},r=0;r<e;r++){var i=this.unpack.popString(),n=this.unpack.popLong();t[i]=n}return t}unmarshalStrStrMap(){for(var e=this.unpack.popVarInt(),t={},r=0;r<e;r++){var i=this.unpack.popString(),n=this.unpack.popString();t[i]=n}return t}unmarshalLongLongMap(){for(var e=this.unpack.popVarInt(),t={},r=0;r<e;r++){var i=this.unpack.popLong(),n=this.unpack.popLong();t[i]=n}return{m_map:t}}unmarshalKVArray(){for(var e=this.unpack.popVarInt(),t=[],r=0;r<e;r++)t.push(this.unmarshalStrStrMap());return t}unmarshal(e){var t=Object.assign(Object.assign({},this.getHeader()),{r:[]});if(this.innerHeader&&(t.r[0]=this.msgId,t.r[1]={body:[],headerPacket:this.getInnerHeader()}),![200,406,808,810,7101].includes(t.code))return JSON.stringify(t);var r=[];return e&&e.forEach((e=>{if(!this.unpack.checkBufferBoundaryAccess())switch(e.type){case"PropertyArray":r.push(this.unmarshalPropertyArray());break;case"Property":r.push(this.unmarshalProperty());break;case"Byte":r.push(this.unpack.popByte());break;case"Int":r.push(this.unpack.popInt());break;case"Bool":r.push(this.unpack.popBoolean());break;case"Long":r.push(this.unmarshalLong());break;case"LongArray":r.push(this.unmarshalLongArray());break;case"String":r.push(this.unpack.popString());break;case"StrArray":r.push(this.unmarshalStrArray());break;case"StrStrMap":r.push(this.unmarshalStrStrMap());break;case"StrLongMap":r.push(this.unmarshalStrLongMap());break;case"LongLongMap":r.push(this.unmarshalLongLongMap());break;case"KVArray":r.push(this.unmarshalKVArray())}})),this.innerHeader?t.r[1].body=r:t.r=r,JSON.stringify(t)}}PacketDecoder.RES_CODE=2;class Pack{constructor(){this.offset=0,this.pageSize=1024,this.capacity=1048576,this.buffer=new Uint8Array(this.pageSize),this.view=new DataView(this.buffer.buffer)}reset(){this.offset=0,this.buffer=null,this.view=null}size(){return this.offset}getBuffer(){return this.buffer.slice(0,this.offset).buffer}ensureCapacity(e){var t=this.offset+e;if(t>this.capacity)throw new Error("PackException over limit");if(t>this.buffer.byteLength){var r=Math.ceil(t/this.pageSize)*this.pageSize,i=new Uint8Array(r);i.set(this.buffer),this.buffer=i,this.view=new DataView(this.buffer.buffer)}}putRaw(e){this.ensureCapacity(e.length);try{this.buffer.set(e,this.offset),this.offset+=e.length}catch(e){throw new Error("PackException raw")}}putByte(e){this.ensureCapacity(1);try{this.view.setUint8(this.offset++,e)}catch(e){throw new Error("PackException byte")}}putString(e){try{var t=function encodeText(e){if("function"==typeof TextEncoder)return(new TextEncoder).encode(e);var t=function textEncoder(e){for(var t=[],r=e.length,i=0;i<r;){var n=e.codePointAt(i),a=0,s=0;for(n<=127?(a=0,s=0):n<=2047?(a=6,s=192):n<=65535?(a=12,s=224):n<=2097151&&(a=18,s=240),t.push(s|n>>a),a-=6;a>=0;)t.push(128|n>>a&63),a-=6;i+=n>=65536?2:1}return t}(e);return new Uint8Array(t)}(e);this.putVarbin(t)}catch(e){throw new Error("PackException string")}}putInt(e){this.ensureCapacity(4);try{this.view.setInt32(this.offset,e,!0),this.offset+=4}catch(e){throw new Error("PackException int")}}putVarInt(e){var t=varintToBytes(e);this.putRaw(t)}putBoolean(e){this.ensureCapacity(1);try{this.view.setUint8(this.offset++,e?1:0)}catch(e){throw new Error("PackException boolean")}}putLong(e){this.ensureCapacity(8);try{var t=function setBigUint64(e,t=!1){var r=new Uint8Array(8),i=new DataView(r.buffer),n=Number(e>yn-1?e/yn:0),a=Number(4294967295&e),[s,o]=t?[4,0]:[0,4];return i.setUint32(s,n,t),i.setUint32(o,a,t),r}(e,!0);this.buffer.set(t,this.offset),this.offset+=8}catch(e){throw new Error("PackException long")}}putStringAsLong(e){this.ensureCapacity(8);try{var t=function setBigUint64ForNumberOverflow(e,t=!1){var r=new Uint8Array(8),i=new DataView(r.buffer),n=BigNumber(e).divide(yn).number.reverse().join(""),a=BigNumber(e).mod(yn).number.reverse().join(""),s=Number(n),o=Number(a),[c,d]=t?[4,0]:[0,4];return i.setUint32(c,s,t),i.setUint32(d,o,t),r}(e,!0);this.buffer.set(t,this.offset),this.offset+=8}catch(e){throw new Error("PackException stringAsLong")}}putShort(e){this.ensureCapacity(2);try{this.view.setInt16(this.offset,e,!0),this.offset+=2}catch(e){throw new Error("PackException short")}}putVarbin(e){if(!e)return this.ensureCapacity(1),this.putVarInt(0);if(e.byteLength>Math.pow(2,31)-2)throw new Error("PackException varbin. too long");var t=varintToBytes(e.length);this.ensureCapacity(t.length+e.length);try{this.buffer.set(t,this.offset),this.offset+=t.length,this.buffer.set(e,this.offset),this.offset+=e.length}catch(e){throw new Error("PackException varbin")}}}function isConvertibleToNumber(e){if("number"!=typeof e){if(null==e)return!1;e=Number(e)}if(isNaN(e))throw new Error("Number type conversion error");return!0}function isUndefinedOrNull(e){return null==e}class PacketEncoder{constructor(e,t,r){this.pack=new Pack,this.packetLength=0,this.serviceId=0,this.commandId=0,this.serialId=0,this.tag=0,this.serviceId=e,this.commandId=t,this.serialId=r}marshalHeader(){this.pack.putVarInt(this.packetLength),this.pack.putByte(this.serviceId),this.pack.putByte(this.commandId),this.pack.putShort(this.serialId),this.pack.putByte(this.tag)}marshalProperty(e){var t=Object.keys(e).filter((e=>!isUndefinedOrNull(e)));this.pack.putVarInt(t.length),t.forEach((t=>{this.pack.putVarInt(Number(t)),Array.isArray(e[t])||"[object Object]"===Object.prototype.toString.call(e[t])?this.pack.putString(JSON.stringify(e[t])):this.pack.putString(String(e[t]))}))}marshalPropertyArray(e){var t=e.length;this.pack.putVarInt(t),e.forEach((e=>{this.marshalProperty(null==e?void 0:e.v)}))}marshalStrArray(e){var t=e.filter((e=>!isUndefinedOrNull(e))),r=t.length;this.pack.putVarInt(r),t.forEach((e=>{this.pack.putString(String(e))}))}marshalLongArray(e){var t=e.filter((e=>isConvertibleToNumber(e))),r=t.length;this.pack.putVarInt(r),t.forEach((e=>{this.putLong(e)}))}marshalStrStrMap(e){var t=Object.keys(e).filter((t=>!isUndefinedOrNull(e[t])&&!isUndefinedOrNull(t)));this.pack.putVarInt(t.length),t.forEach((t=>{this.pack.putString(String(t)),this.pack.putString(String(e[t]))}))}marshalStrLongMap(e){var t=Object.keys(e).filter((t=>isConvertibleToNumber(e[t])&&!isUndefinedOrNull(t)));this.pack.putVarInt(t.length),t.forEach((t=>{this.pack.putString(String(t)),this.putLong(e[t])}))}marshalLongLongMap(e){var t=Object.keys(e).filter((t=>{var r=Number(t);return isConvertibleToNumber(r)&&isConvertibleToNumber(e[r])}));this.pack.putVarInt(t.length),t.forEach((t=>{var r=Number(t);this.putLong(r),this.putLong(e[r])}))}marshalKVArray(e){var t=e.length;this.pack.putVarInt(t),e.forEach((e=>{this.marshalStrStrMap(e)}))}putLong(e){"string"==typeof e&&e.length>15?this.pack.putStringAsLong(e):this.pack.putLong(Number(e))}marshal(e,t){return this.marshalHeader(),t&&t.forEach(((t,r)=>{var i,n=t.type,a=null===(i=e[r])||void 0===i?void 0:i.v;if(!isUndefinedOrNull(a))switch(n){case"PropertyArray":this.marshalPropertyArray(a);break;case"Property":this.marshalProperty(a);break;case"Byte":if(!isConvertibleToNumber(a))return;this.pack.putByte(Number(a));break;case"Int":if(!isConvertibleToNumber(a))return;this.pack.putInt(Number(a));break;case"Bool":"false"===a?a=!1:"true"===a&&(a=!0),this.pack.putBoolean(a);break;case"Long":if(!isConvertibleToNumber(a))return;this.putLong(a);break;case"LongArray":this.marshalLongArray(a);break;case"String":this.pack.putString(String(a));break;case"StrArray":this.marshalStrArray(a);break;case"StrStrMap":this.marshalStrStrMap(a);break;case"StrLongMap":this.marshalStrLongMap(a);break;case"LongLongMap":this.marshalLongLongMap(a);break;case"KVArray":this.marshalKVArray(a)}})),this.pack.getBuffer()}reset(){this.pack.reset()}}class BaseWebsocket extends r{constructor(e,t){super(),this.url=t,this.websocket=null,this.socketConnectTimer=0,this.core=e,this.url=t,this.status="disconnected",this.logger=e.logger,this.connect()}connect(){"connecting"!==this.status&&"connected"!==this.status?(this.status="connecting",this._createWebsocket("wss://"+this.url+"/websocket")):this.logger.warn("imsocket::socket is connecting or connected",this.status)}close(){if(this.status="disconnected",this.websocket){this.logger.log("imsocket:: close websocket");try{this.websocket.close()}catch(e){this.logger.warn("imsocket::attempt to close websocket error",e)}this.clean(),this.emit("disconnect")}}clean(){this.status="disconnected",this.websocket&&(this.socketUrl=void 0,this.websocket.onmessage=null,this.websocket.onopen=null,this.websocket.onerror=null,this.websocket.onclose=null,this.websocket=null)}onConnect(){this.status="connected",this.emit("connect"),clearTimeout(this.socketConnectTimer)}_createWebsocket(e){this.socketConnectTimer=setTimeout((()=>{this.logger.error("imsocket::Websocket connect timeout. url: ",this.socketUrl),this.emit("connectFailed",new V2NIMErrorImpl({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:415,detail:{reason:`imsocket::Websocket connect timeout. url: ${this.socketUrl}`}}))}),this.core.options.socketConnectTimeout||8e3),this.socketUrl=e,this.websocket=new Xr.WebSocket(e),this.websocket.binaryType="arraybuffer",this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onclose=()=>{this.logger.log("imsocket::Websocket onclose done"),"connected"===this.status?(this.clean(),this.emit("disconnect")):(this.clean(),this.emit("connectFailed",new V2NIMErrorImpl({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_CONNECT_FAILED:414,detail:{reason:"imsocket::Websocket onclose done"}})))},this.websocket.onerror=e=>{this.logger.error("imsocket::Websocket onerror",e),"connected"===this.status?(this.clean(),this.emit("disconnect")):(this.clean(),this.emit("connectFailed",new V2NIMErrorImpl({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_CONNECT_FAILED:414,detail:{reason:"imsocket::Websocket onerror."}})))},this.websocket.onopen=()=>{this.onConnect()}}onMessage(e){if(e.data){var t=new PacketDecoder(e.data),r={sid:-1,cid:-1,ser:-1,packetLength:-1},i=null;try{t.unmarshalHeader(),r=t.getHeader(),i=t.getInnerHeader()}catch(t){this.reportBinaryError({err:t,sid:i?i.sid:null==r?void 0:r.sid,cid:i?i.cid:null==r?void 0:r.cid,rawBuf:e.data,type:"decode"})}var n=i?i.sid:r.sid,a=i?i.cid:r.cid,s=`${n}_${a}`,o=ri[s];if(o&&o.length>0){var c,d=o[0].config;try{c=t.unmarshal(d.response)}catch(i){this.reportBinaryError({err:i,rawBuf:e.data,sid:n,cid:a,type:"decode"}),t.reset();var l=Object.assign(Object.assign({},r),{sid:n,cid:a,code:Ct.V2NIM_ERROR_CODE_UNPACK_ERROR});return this.logger.error(`imsocket::onMessage "${l.sid}_${l.cid}", ser ${l.ser}, packetLength ${l.packetLength} unmarshal error`,i),void this.emit("message",JSON.stringify(l))}this.emit("message",c)}else this.core.logger.warn("imsocket::onMessage cmd not found",s);t.reset()}}send(e,t,r,i,n){var a,s,o=new PacketEncoder(e,t,r),c=ti[i],d="";try{d=JSON.stringify(n),s=o.marshal(JSON.parse(d),c.params)}catch(i){throw this.reportBinaryError({err:i,sid:e,cid:t,rawStr:d,type:"encode"}),o.reset(),new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_PACK_ERROR,detail:{reason:`${e}-${t}, ser ${r} marshal error`,rawError:i}})}null===(a=this.websocket)||void 0===a||a.send(s),o.reset()}reportBinaryError(e){var t,r,i,{err:n,rawStr:a,sid:s,cid:o,type:c}=e,d=e.rawBuf;if(d){try{i=function arrayBufferToBase64(e){if("function"!=typeof btoa)return"";for(var t="",r=new Uint8Array(e),i=r.byteLength,n=0;n<i;n++)t+=String.fromCharCode(r[n]);return r=null,btoa(t)}(d)}catch(e){i=`reportBinaryError::arrayBufferToBase64 parsing failed, error: ${null==e?void 0:e.message}, sid: ${s}, cid: ${o}`,this.core.logger.error(i)}d=null}this.core.reporter.reportTraceStart("exceptions",{user_id:null===(t=this.core.auth)||void 0===t?void 0:t.account,trace_id:null===(r=this.core.clientSocket.socket)||void 0===r?void 0:r.sessionId,start_time:Date.now(),action:2,exception_service:9}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"encode"===c?Ct.V2NIM_ERROR_CODE_PACK_ERROR:Ct.V2NIM_ERROR_CODE_UNPACK_ERROR,description:n&&(n.message||`${n.code}`)+(a?` rawStr: ${a}`:"")+(i?` rawBuf: ${i}`:""),operation_type:"encode"===c?3:4,target:`${s}-${o}`},{asyncParams:Xr.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1)}}!function(e){e[e.ACTIVE=1]="ACTIVE",e[e.KICKED=2]="KICKED",e[e.OFFLINE=3]="OFFLINE"}(gn||(gn={}));class V2BinaryClientSocket{constructor(e){this.isReconnect=!1,this.packetTimeout=8e3,this.packetSer=1,this.backoff=new Ei({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new Map,this.pingTimer=0,this.hasNetworkListener=!1,this.core=e,this.auth=e.auth,this.logger=e.logger,this.reporter=e.reporter,this.timerManager=e.timerManager,this.eventBus=e.eventBus,this.setListener()}setListener(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.isReconnect=!0}))}setSessionId(e){this.socket&&(this.socket.sessionId=e)}connect(e,t=!1){var r,i;return __awaiter(this,void 0,void 0,(function*(){this.isReconnect=t;var n=this.core.auth.getConnectStatus();if(n===Ge.V2NIM_CONNECT_STATUS_CONNECTED){var a=`clientSocket::connect status is ${n}, and would not repeat connect`,s=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:a}});return this.logger.warn(a),Promise.reject(s)}this.auth.lifeCycle.processEvent("connect");try{yield this.auth.doLoginStepsManager.add(this.doConnect(e)),this.logger.log(`clientSocketV2:: connect success with link url: ${e}, isReconnect: ${t}`),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:e,code:200,mixlink:!0,succeed:!0},{asyncParams:Xr.net.getNetworkStatus()}),this.auth.lifeCycle.processEvent("connectSucc")}catch(t){var o=t;if(this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:e,code:o.code||0,description:`connectFailed:${o.message}`,mixlink:!0,succeed:!1},{asyncParams:Xr.net.getNetworkStatus()}),o.code===Ct.V2NIM_ERROR_CODE_CANCELLED||o.code===Ct.V2NIM_ERROR_CODE_TIMEOUT)throw null===(r=this.socket)||void 0===r||r.close(),null===(i=this.socket)||void 0===i||i.removeAllListeners(),this.socket=void 0,t;throw this.logger.warn(`clientSocketV2::connect failed with link url: ${e}`,o),this.auth.lifeCycle.processEvent("connectFail",o),t}}))}doConnect(e){var t=!1;return new Promise(((r,i)=>{this.socket=new BaseWebsocket(this.core,e),this.socket.on("connect",(()=>{this.logger.log("clientSocketV2::socket on connect",e),this.core.reporterHookLinkKeep.start(),this.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:e}),t=!0,r()})),this.socket.on("message",this.onMessage.bind(this)),this.socket.on("disconnect",(r=>__awaiter(this,void 0,void 0,(function*(){t=!0,this.logger.log("clientSocketV2::socket on disconnect",r),yield this.core.reporterHookLinkKeep.update({code:(null==r?void 0:r.code)||0,description:(null==r?void 0:r.reason)||"socket on disconnect",operation_type:1,target:e}),this.core.reporterHookLinkKeep.end(!1),this.doDisconnect(gn.OFFLINE,"SocketOnDisconnect")})))),this.socket.on("connectFailed",(e=>{t?this.ping():(this.logger.error(`clientSocketV2::connectFailed: "${e&&e.message}"`),this.cleanSocket()),t=!0,i(e)}))}))}cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)}resetSocketConfig(){this.backoff.reset(),this.initOnlineListener()}doDisconnect(e,t){if(this.logger.log(`clientSocketV2::doDisconnect: type ${e}, reason `,t),this.core.auth.getConnectStatus()!==Ge.V2NIM_CONNECT_STATUS_DISCONNECTED){var r={1:"close",2:"kicked",3:"broken"}[e]||"";this.markAllCmdInvaild(new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:r}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket(),e===gn.ACTIVE||e===gn.KICKED?this.destroyOnlineListener():e===gn.OFFLINE&&(this.auth.lifeCycle.processEvent("connectionBroken",new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"connection broken due to internal reasons"}})),this.logger.log(`clientSocketV2::doDisconnect: pending reconnect ${this.isReconnect}`),this.isReconnect&&this.auth.lifeCycle.processEvent("waiting"))}else this.logger.warn("clientSocketV2::doDisconnect: already disconnected")}sendCmd(e,t,r){var i=this.core.auth.getLoginStatus(),n={cmd:e};if(i!==qe.V2NIM_LOGIN_STATUS_LOGINED&&!["v2Login","login","chatroomLogin","v2ChatroomLogin"].includes(e))return this.logger.warn(`clientSocketV2::NIM login status is ${i}, so can not sendCmd ${e}`),Promise.reject(new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:Object.assign({reason:"Can not sendCmd due to no logined"},n)}));var a="heartbeat"!==e,s=a?this.packetSer++:0,o=createCmd(e,s,this.logger,t);if(!o){var c=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:Object.assign(Object.assign({},n),{reason:`SendCmd::createCmd error: ${s} ${e}`})});return this.logger.error(c),Promise.reject(c)}var{packet:d,hasPacketResponse:l,hasPacketTimer:m}=o,p=JSON.stringify(d);a&&("debug"===this.core.options.debugLevel?this.logger.debug("clientSocketV2::sendCmd",e,`ser:${s}`,p):this.logger.log("clientSocketV2::sendCmd",e,`ser:${s}`));var u=(new Date).getTime();return new Promise(((i,a)=>{l&&this.sendingCmdMap.set(s,{cmd:e,params:t,callback:[i,a],timer:m?setTimeout((()=>{var t=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,detail:Object.assign({ser:s,reason:`Packet Timeout: ser ${s} cmd ${e}`,timetag:(new Date).getTime()},n)});this.markCmdInvalid(s,t,e)}),r&&r.timeout?r.timeout:this.packetTimeout):null});try{this.socket.send(d.SID,d.CID,s,e,d.Q),l||i(d)}catch(t){var o=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED,detail:Object.assign({ser:s,reason:"Unable to send packet"+(t&&t.message?": "+t.message:""),timetag:(new Date).getTime(),rawError:t},n)});this.markCmdInvalid(s,o,e),a(o)}})).catch((e=>__awaiter(this,void 0,void 0,(function*(){var t=e;return[Ct.V2NIM_ERROR_CODE_DISCONNECT,Ct.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,Ct.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED].includes(t.code)?(this.reportSendCmdFailed(t,{sid:d.SID,cid:d.CID,ser:s},u),Promise.reject(t)):Promise.reject(t)}))))}reportSendCmdFailed(e,t,r){var i;this.reporter.reportTraceStart("exceptions",{user_id:this.core.auth.getLoginUser(),trace_id:null===(i=this.socket)||void 0===i?void 0:i.sessionId,start_time:r,action:2,exception_service:6});var n=Ne(e,"detail.disconnect_reason")||"",a=e.code===Ct.V2NIM_ERROR_CODE_DISCONNECT?JSON.stringify({disconnect_reason:n}):e.detail.reason;this.reporter.reportTraceUpdateV2("exceptions",{code:e.code,description:a,operation_type:1,target:`${t.sid}-${t.cid}`,context:`${t.ser}`},{asyncParams:Xr.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1)}onMessage(e){var t=parseCmd(e,this.logger);if(t){var r=t[0],i=r.raw.ser;for(var n of("heartbeat"!==r.cmd&&("debug"===this.core.options.debugLevel?this.logger.debug(`clientSocketV2::recvCmd ser:${i} ${r.raw.sid}_${r.raw.cid}. ${e}`):this.logger.log(`clientSocketV2::recvCmd ser:${i} ${r.raw.sid}_${r.raw.cid}`)),t)){if(n.error&&this.logger.error("clientSocketV2::onMessage packet error",`${n.raw.sid}_${n.raw.cid}, ser:${i},`,n.error),n.notFound)return void this.logger.warn("clientSocketV2::onMessage packet not found",`${n.raw.sid}_${n.raw.cid}, ser:${i}`);this.packetHandler(n)}}}packetHandler(e){var t,r;if(e){var i=e.raw.ser,n=this.sendingCmdMap.get(i);if(n&&n.cmd===e.cmd){var{callback:a,timer:s,params:o}=n;if(clearTimeout(s),e.params=o,this.sendingCmdMap.delete(i),"heartbeat"===e.cmd)return void a[0]();var c=null===(t=this.core[e.service])||void 0===t?void 0:t.process(e);c&&"function"==typeof c.then?c.then((e=>{a[0](e)})).catch((e=>{a[1](e)})):(this.logger.log("clientSocketV2::handlerFn without promise",e.service,e.cmd),a[0](e))}else null===(r=this.core[e.service])||void 0===r||r.process(e)}}markCmdInvalid(e,t,r){var i=this.sendingCmdMap.get(e);if(i){var{callback:n,timer:a}=i;a&&clearTimeout(a),this.sendingCmdMap.delete(e),this.logger.warn(`clientSocketV2::packet ${e}, ${r} is invalid:`,t),n[1](t)}}markAllCmdInvaild(e){this.logger.log("markAllCmdInvaild",e),this.sendingCmdMap.forEach((t=>{var{callback:r,timer:i,cmd:n}=t;this.logger.debug(`clientSocketV2::markAllCmdInvaild:cmd ${n}`),i&&clearTimeout(i),r[1](e)})),this.sendingCmdMap.clear()}ping(){var e;return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);try{yield this.sendCmd("heartbeat")}catch(t){if(t.code===Ct.V2NIM_ERROR_CODE_DISCONNECT)return;if(yield this.testHeartBeat5Timeout())return yield this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(e=this.socket)||void 0===e?void 0:e.url}),this.core.reporterHookLinkKeep.end(!0),void this.doDisconnect(gn.OFFLINE,"PingError")}this.pingTimer=setTimeout((()=>{this.ping()}),3e4)}))}testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);for(var e=0;e<5;e++)try{return yield this.sendCmd("heartbeat",{},{timeout:3e3}),!1}catch(t){this.logger.debug(`clientSocketV2::test heartbeat ${e} Timeout`)}return!0}))}initOnlineListener(){this.hasNetworkListener||(this.logger.log("clientSocketV2::onlineListener:init"),this.hasNetworkListener=!0,Xr.net.onNetworkStatusChange((e=>{this.logger.log("clientSocketV2::onlineListener:network change",e);var t=this.auth.getConnectStatus(),r=this.auth.getLoginStatus();e.isConnected&&r===qe.V2NIM_LOGIN_STATUS_LOGINED?this.ping():e.isConnected&&t===Ge.V2NIM_CONNECT_STATUS_WAITING?(this.logger.log("clientSocketV2::onlineListener:online and connectStatus is waiting, do reLogin"),this.auth.reconnect.clearReconnectTimer(),this.auth.reconnect.doReLogin()):e.isConnected||this.doDisconnect(gn.OFFLINE,"OfflineListener")})))}destroyOnlineListener(){this.logger.log("clientSocketV2::onlineListener:destroy"),Xr.net.offNetworkStatusChange(),this.hasNetworkListener=!1}}!function(e){e[e.ACTIVE=1]="ACTIVE",e[e.KICKED=2]="KICKED",e[e.OFFLINE=3]="OFFLINE"}(vn||(vn={}));class V2ClientSocket{constructor(e){this.isReconnect=!1,this.packetTimeout=8e3,this.packetSer=1,this.backoff=new Ei({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new Map,this.pingTimer=0,this.hasNetworkListener=!1,this.core=e,this.auth=e.auth,this.logger=e.logger,this.reporter=e.reporter,this.timerManager=e.timerManager,this.eventBus=e.eventBus,this.setListener()}setListener(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.isReconnect=!0}))}setSessionId(e){this.socket&&(this.socket.sessionId=e)}connect(e,t=!1){var r,i;return __awaiter(this,void 0,void 0,(function*(){this.isReconnect=t;var n=this.core.auth.getConnectStatus();if(n===Ge.V2NIM_CONNECT_STATUS_CONNECTED){var a=`clientSocket::connect status is ${n}, and would not repeat connect`,s=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:a}});return this.logger.warn(a),Promise.reject(s)}this.auth.lifeCycle.processEvent("connect");try{yield this.auth.doLoginStepsManager.add(this.doConnect(e)),this.logger.log(`clientSocketV2:: connect success with link url: ${e}, isReconnect: ${t}`),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:e,code:200,mixlink:!0,succeed:!0},{asyncParams:Xr.net.getNetworkStatus()}),this.auth.lifeCycle.processEvent("connectSucc")}catch(t){var o=t;if(this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:e,code:o.code||0,description:`connectFailed:${o.message}`,mixlink:!0,succeed:!1},{asyncParams:Xr.net.getNetworkStatus()}),o.code===Ct.V2NIM_ERROR_CODE_CANCELLED||o.code===Ct.V2NIM_ERROR_CODE_TIMEOUT)throw null===(r=this.socket)||void 0===r||r.close(),null===(i=this.socket)||void 0===i||i.removeAllListeners(),this.socket=void 0,t;throw this.logger.warn(`clientSocketV2::connect failed with link url: ${e}`,o),this.auth.lifeCycle.processEvent("connectFail",o),t}}))}doConnect(e){var t=!1;return new Promise(((r,i)=>{this.socket=new BaseWebsocket$1(this.core,e),this.socket.on("connect",(()=>{this.logger.log("clientSocketV2::socket on connect",e),this.core.reporterHookLinkKeep.start(),this.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:e}),t=!0,r()})),this.socket.on("message",this.onMessage.bind(this)),this.socket.on("disconnect",(r=>__awaiter(this,void 0,void 0,(function*(){t=!0,this.logger.log("clientSocketV2::socket on disconnect",r),yield this.core.reporterHookLinkKeep.update({code:(null==r?void 0:r.code)||0,description:(null==r?void 0:r.reason)||"socket on disconnect",operation_type:1,target:e}),this.core.reporterHookLinkKeep.end(!1),this.doDisconnect(vn.OFFLINE,"SocketOnDisconnect")})))),this.socket.on("handshakeFailed",(e=>{t?this.ping():(this.logger.error(`clientSocketV2::handshake failed: "${e&&e.message}"`),this.cleanSocket()),t=!0,i(e)}))}))}cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)}resetSocketConfig(){this.backoff.reset(),this.initOnlineListener()}doDisconnect(e,t){if(this.logger.log(`clientSocketV2::doDisconnect: type ${e}, reason `,t),this.core.auth.getConnectStatus()!==Ge.V2NIM_CONNECT_STATUS_DISCONNECTED){var r={1:"close",2:"kicked",3:"broken"}[e]||"";this.markAllCmdInvaild(new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:r}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket(),e===vn.ACTIVE||e===vn.KICKED?this.destroyOnlineListener():e===vn.OFFLINE&&(this.auth.lifeCycle.processEvent("connectionBroken",new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"connection broken due to internal reasons"}})),this.logger.log(`clientSocketV2::doDisconnect: pending reconnect ${this.isReconnect}`),this.isReconnect&&this.auth.lifeCycle.processEvent("waiting"))}else this.logger.warn("clientSocketV2::doDisconnect: already disconnected")}sendCmd(e,t,r){var i=this.core.auth.getLoginStatus(),n={cmd:e};if(i!==qe.V2NIM_LOGIN_STATUS_LOGINED&&!["v2Login","login","chatroomLogin","v2ChatroomLogin"].includes(e))return this.logger.warn(`clientSocketV2::NIM login status is ${i}, so can not sendCmd ${e}`),Promise.reject(new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:Object.assign({reason:"Can not sendCmd due to no logined"},n)}));var a="heartbeat"!==e,s=a?this.packetSer++:0,o=createCmd(e,s,this.logger,t);if(!o){var c=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:Object.assign(Object.assign({},n),{reason:`SendCmd::createCmd error: ${s} ${e}`})});return this.logger.error(c),Promise.reject(c)}var{packet:d,hasPacketResponse:l,hasPacketTimer:m}=o,p=JSON.stringify(d);a&&("debug"===this.core.options.debugLevel?this.logger.debug("clientSocketV2::sendCmd",e,`ser:${s}`,p):this.logger.log("clientSocketV2::sendCmd",e,`ser:${s}`));var u=(new Date).getTime();return new Promise(((i,a)=>{l&&this.sendingCmdMap.set(s,{cmd:e,params:t,callback:[i,a],timer:m?setTimeout((()=>{var t=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,detail:Object.assign({ser:s,reason:`Packet Timeout: ser ${s} cmd ${e}`,timetag:(new Date).getTime()},n)});this.markCmdInvalid(s,t,e)}),r&&r.timeout?r.timeout:this.packetTimeout):null});try{this.socket.send(p),l||i(d)}catch(t){var o=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED,detail:Object.assign({ser:s,reason:"Unable to send packet"+(t&&t.message?": "+t.message:""),timetag:(new Date).getTime(),rawError:t},n)});this.markCmdInvalid(s,o,e),a(o)}})).catch((e=>__awaiter(this,void 0,void 0,(function*(){var t,r=e;if(![Ct.V2NIM_ERROR_CODE_DISCONNECT,Ct.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,Ct.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED].includes(r.code))return Promise.reject(r);this.reporter.reportTraceStart("exceptions",{user_id:this.core.auth.getLoginUser(),trace_id:null===(t=this.socket)||void 0===t?void 0:t.sessionId,start_time:u,action:2,exception_service:6});var i=Ne(r,"detail.disconnect_reason")||"",n=r.code===Ct.V2NIM_ERROR_CODE_DISCONNECT?JSON.stringify({disconnect_reason:i}):r.detail.reason;return this.reporter.reportTraceUpdateV2("exceptions",{code:r.code,description:n,operation_type:1,target:`${d.SID}-${d.CID}`,context:`${d.SER}`},{asyncParams:Xr.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1),Promise.reject(r)}))))}onMessage(e){var t=parseCmd(e,this.logger);if(t)for(var r of t){var i=r.raw.ser;if(r.error&&this.logger.error("clientSocketV2::onMessage packet error",`${r.raw.sid}_${r.raw.cid}, ser:${i},`,r.error),r.notFound)return void this.logger.warn("clientSocketV2::onMessage packet not found",`${r.raw.sid}_${r.raw.cid}, ser:${i}`);"heartbeat"!==r.cmd&&("debug"===this.core.options.debugLevel?this.logger.debug(`clientSocketV2::recvCmd ser:${i}`,r.cmd,r.content):this.logger.log(`clientSocketV2::recvCmd ser:${i}`,r.cmd)),this.packetHandler(r)}}packetHandler(e){var t,r;if(e){var i=e.raw.ser,n=this.sendingCmdMap.get(i);if(n&&n.cmd===e.cmd){var{callback:a,timer:s,params:o}=n;if(clearTimeout(s),e.params=o,this.sendingCmdMap.delete(i),"heartbeat"===e.cmd)return void a[0]();var c=null===(t=this.core[e.service])||void 0===t?void 0:t.process(e);c&&"function"==typeof c.then?c.then((e=>{a[0](e)})).catch((e=>{a[1](e)})):(this.logger.log("clientSocketV2::handlerFn without promise",e.service,e.cmd),a[0](e))}else null===(r=this.core[e.service])||void 0===r||r.process(e)}}markCmdInvalid(e,t,r){var i=this.sendingCmdMap.get(e);if(i){var{callback:n,timer:a}=i;a&&clearTimeout(a),this.sendingCmdMap.delete(e),this.logger.warn(`clientSocketV2::packet ${e}, ${r} is invalid:`,t),n[1](t)}}markAllCmdInvaild(e){this.logger.log("markAllCmdInvaild",e),this.sendingCmdMap.forEach((t=>{var{callback:r,timer:i,cmd:n}=t;this.logger.debug(`clientSocketV2::markAllCmdInvaild:cmd ${n}`),i&&clearTimeout(i),r[1](e)})),this.sendingCmdMap.clear()}ping(){var e;return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);try{yield this.sendCmd("heartbeat")}catch(t){if(t.code===Ct.V2NIM_ERROR_CODE_DISCONNECT)return;if(yield this.testHeartBeat5Timeout())return yield this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(e=this.socket)||void 0===e?void 0:e.url}),this.core.reporterHookLinkKeep.end(!0),void this.doDisconnect(vn.OFFLINE,"PingError")}this.pingTimer=setTimeout((()=>{this.ping()}),3e4)}))}testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);for(var e=0;e<5;e++)try{return yield this.sendCmd("heartbeat",{},{timeout:3e3}),!1}catch(t){this.logger.debug(`clientSocketV2::test heartbeat ${e} Timeout`)}return!0}))}initOnlineListener(){this.hasNetworkListener||(this.logger.log("clientSocketV2::onlineListener:init"),this.hasNetworkListener=!0,Xr.net.onNetworkStatusChange((e=>{this.logger.log("clientSocketV2::onlineListener:network change",e);var t=this.auth.getConnectStatus(),r=this.auth.getLoginStatus();e.isConnected&&r===qe.V2NIM_LOGIN_STATUS_LOGINED?this.ping():e.isConnected&&t===Ge.V2NIM_CONNECT_STATUS_WAITING?(this.logger.log("clientSocketV2::onlineListener:online and connectStatus is waiting, do reLogin"),this.auth.reconnect.clearReconnectTimer(),this.auth.reconnect.doReLogin()):e.isConnected||this.doDisconnect(vn.OFFLINE,"OfflineListener")})))}destroyOnlineListener(){this.logger.log("clientSocketV2::onlineListener:destroy"),Xr.net.offNetworkStatusChange(),this.hasNetworkListener=!1}}class V2NIMLoginReconnect{constructor(e){this.currenRetryCount=0,this.backoff=new Ei({max:8e3,min:1600,jitter:.01}),this.reconnectTimer=0,this.core=e,this.auth=e.V2NIMLoginService}reset(){this.currenRetryCount=0,this.backoff.reset(),this.reconnectTimer&&clearTimeout(this.reconnectTimer)}clearReconnectTimer(){this.reconnectTimer&&clearTimeout(this.reconnectTimer)}attempToReLogin(){var e=this.backoff.duration();if("function"==typeof this.reconnectDelayProvider)try{var t=this.reconnectDelayProvider(e);"number"==typeof t&&t>=0&&(e=t>=1e3?t:t+200+Math.ceil(300*Math.random()))}catch(e){this.core.logger.error("reconnect::connectDelayProvider excute failed,",e)}return this.currenRetryCount++,this.core.logger.log(`reconnect::reconnect timer is about to be set, delay ${e} ms, current retry count is ${this.currenRetryCount}`),this.core.reporter.reportTraceStart("login",{user_id:this.auth.getLoginUser(),action:"auto_login",binary_websocket:this.auth.binaryWebsocket}),this.clearReconnectTimer(),this.reconnectTimer=setTimeout((()=>{this.core.logger.log("reconnect::reconnect timer is now triggered");var e=this.auth.getConnectStatus();e===Ge.V2NIM_CONNECT_STATUS_WAITING?this.doReLogin():this.core.logger.warn(`reconnect::reconnect timer is over because connect status now is ${e}`)}),e),!0}doReLogin(){this.auth.loginOption.forceMode=!1,this.auth.originLoginPromise=this.auth.doLogin(!0);var e=this.auth.previousLoginManager.add(this.auth.originLoginPromise);return e.then((()=>{this.core.reporter.reportTraceEnd("login",!0)})).catch((e=>{var t=e;if(this.core.logger.warn("reconnect::try login but failed due to",t),this.core.reporter.reportTraceEnd("login",!1),this.auth.checkLoginTerminalCode(t&&t.code))return this.auth.clientSocket.doDisconnect(gn.ACTIVE,"ReloginTerminated"),void this.auth.lifeCycle.processEvent("exited",t);t&&399===t.code&&this.auth.lbs.reset(),this.auth.lifeCycle.processEvent("waiting")})),e}_setReconnectDelayProvider(e){this.reconnectDelayProvider=e}}class V2NIMLoginLbs{constructor(e){this.socketLinkUrls=[],this.timer=0,this.failedCount=0,this.core=e,this.auth=e.V2NIMLoginService}getLbsInfos(){return __awaiter(this,void 0,void 0,(function*(){if(this.socketLinkUrls.length>0){var e=this.socketLinkUrls.shift();return this.socketLinkUrls=[],this.core.logger.log("V2NIMLoginService::getLbsInfos:use cache link",e),Promise.resolve(e)}this.auth.lifeCycle.processEvent("addressing"),this.core.reporterHookLBS.start(this.core.account);var t=xi(this.auth.config.lbsUrls);try{var r=yield this.ladderLoad(t);if(200!==r.status||!r.data)throw this.core.logger.error("V1NIMLoginService::getLbsInfos:error status",r.status,r),new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:`V2NIMLoginService::getLbsInfos failed, status ${r.status}`}});this.success(r)}catch(e){var i=e;if(this.core.logger.error(`V2NIMLoginService::lbs getLbsInfos error, use default link: ${this.auth.config.linkUrl}. error:`,e),this.reportForFail(t[0],i.code,i.message),this.checkTerminator(i.code))throw e;this.socketLinkUrls=[this.auth.config.linkUrl]}return this.socketLinkUrls.shift()}))}checkTerminator(e){return e===Ct.V2NIM_ERROR_CODE_CANCELLED||e===Ct.V2NIM_ERROR_CODE_TIMEOUT}generateUrl(e){var t=e.indexOf("?")>-1?"&":"?";return e+t+"k="+this.core.options.appkey+"&id="+this.core.auth.getLoginUser()+"&sv=180&pv=1&networkType=0&lv=1"}requstLbs(e){return this.auth.doLoginStepsManager.add(this.core.adapters.request(this.generateUrl(e),{method:"GET",dataType:"json",timeout:8e3}))}setLadderTimer(e,t,r,i){this.timer&&clearTimeout(this.timer);var n=e[t];this.timer=setTimeout((()=>{n&&(this.setLadderTimer(e,t+1,r,i),this.core.logger.log(`V2NIMLoginService::getLbsInfos ${t}:`,n),this.reportForLbsStart(n,t),this.requstLbs(n).then((e=>{this.reset(),r(Object.assign(Object.assign({},e),{url:n}))})).catch((r=>{var a;if(this.core.logger.warn(`V2NIMLoginService::getLbsInfos ${t} failed:`,r),this.failedCount+=1,this.reportForFailOnce(n,r.code,(null===(a=r.detail)||void 0===a?void 0:a.reason)||r.message),this.failedCount>=e.length||this.checkTerminator(r.code))return this.reset(),void i(r)})))}),2e3)}ladderLoad(e){return new Promise(((t,r)=>{e.length>1&&this.setLadderTimer(e,1,t,r);var i=e[0];this.core.logger.log("V2NIMLoginService::getLbsInfos 0:",i),this.reportForLbsStart(i,0),this.requstLbs(i).then((e=>{this.reset(),t(Object.assign(Object.assign({},e),{url:i}))})).catch((t=>{var n;this.failedCount+=1,this.core.logger.warn("V2NIMLoginService::getLbsInfos 0 failed:",t),this.reportForFailOnce(i,t.code,(null===(n=t.detail)||void 0===n?void 0:n.reason)||t.message),(this.failedCount>=e.length||this.checkTerminator(t.code))&&(this.reset(),r(t))}))}))}success(e){var t,r,i=e.data.common;this.socketLinkUrls=xi(i["mix.link"].concat(i["link.default"]).concat([this.auth.config.linkUrl])),e.data["nos-chunk"]&&(null===(t=this.core.cloudStorage)||void 0===t?void 0:t.setOptions)&&(this.core.logger.log("getLbsInfos success. lbs.nos-chunk",e.data["nos-chunk"]),this.core.cloudStorage.setOptions({chunkUploadHost:e.data["nos-chunk"]})),Array.isArray(e.data.nosup)&&e.data.nosup.length>0&&(this.core.logger.log("getLbsInfos success. lbs.nosup",e.data.nosup),null===(r=this.core.cloudStorage)||void 0===r||r.setOptions({commonUploadHostBackupList:e.data.nosup,commonUploadHost:e.data.nosup[0]})),this.core.logger.log("V2NIMLoginService::getLbsInfos success, socket link:",this.socketLinkUrls.slice(0),"chunkUploadHost: ",e.data["nos-chunk"]),this.reportForLbsSuccess(e.url,e.data)}reportForLbsStart(e,t){this.core.reporterHookLBS.updateBegin({target:e,index:t})}reportForLbsSuccess(e,t){this.core.reporterHookLBS.updateComplete({target:e,code:200,body:JSON.stringify(t)}),this.core.reporterHookLBS.end(!0),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:e,code:200,succeed:!0},{asyncParams:Xr.net.getNetworkStatus()})}reportForFailOnce(e,t,r){this.core.reporterHookLBS.updateComplete({target:e,code:t,body:r})}reportForFail(e,t,r){this.core.reporterHookLBS.end(!1),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:e,description:r,code:t,succeed:!1},{asyncParams:Xr.net.getNetworkStatus()})}reset(){this.socketLinkUrls=[],this.failedCount=0,clearTimeout(this.timer)}}var In=function arraySome(e,t){for(var r=-1,i=null==e?0:e.length;++r<i;)if(t(e[r],r,e))return!0;return!1};var _n=function equalArrays(e,t,r,i,n,a){var s=1&r,o=e.length,c=t.length;if(o!=c&&!(s&&c>o))return!1;var d=a.get(e),l=a.get(t);if(d&&l)return d==t&&l==e;var m=-1,p=!0,u=2&r?new Ni:void 0;for(a.set(e,t),a.set(t,e);++m<o;){var h=e[m],g=t[m];if(i)var v=s?i(g,h,m,t,e,a):i(h,g,m,e,t,a);if(void 0!==v){if(v)continue;p=!1;break}if(u){if(!In(t,(function(e,t){if(!ki(u,t)&&(h===e||n(h,e,r,i,a)))return u.push(t)}))){p=!1;break}}else if(h!==g&&!n(h,g,r,i,a)){p=!1;break}}return a.delete(e),a.delete(t),p};var Mn=function mapToArray(e){var t=-1,r=Array(e.size);return e.forEach((function(e,i){r[++t]=[i,e]})),r},fn=c?c.prototype:void 0,Tn=fn?fn.valueOf:void 0;var En=function equalByTag(e,t,r,i,n,a,s){switch(r){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!a(new Bt(e),new Bt(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return Q(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var o=Mn;case"[object Set]":var c=1&i;if(o||(o=Di),e.size!=t.size&&!c)return!1;var d=s.get(e);if(d)return d==t;i|=2,s.set(e,t);var l=_n(o(e),o(t),i,n,a,s);return s.delete(e),l;case"[object Symbol]":if(Tn)return Tn.call(e)==Tn.call(t)}return!1};var Sn=function arrayPush(e,t){for(var r=-1,i=t.length,n=e.length;++r<i;)e[n+r]=t[r];return e};var Cn=function baseGetAllKeys(e,t,r){var i=t(e);return n(e)?i:Sn(i,r(e))};var Nn=function arrayFilter(e,t){for(var r=-1,i=null==e?0:e.length,n=0,a=[];++r<i;){var s=e[r];t(s,r,e)&&(a[n++]=s)}return a};var An=function stubArray(){return[]},bn=Object.prototype.propertyIsEnumerable,Rn=Object.getOwnPropertySymbols,On=Rn?function(e){return null==e?[]:(e=Object(e),Nn(Rn(e),(function(t){return bn.call(e,t)})))}:An;var Pn=function getAllKeys(e){return Cn(e,vi,On)},Vn=Object.prototype.hasOwnProperty;var kn=function equalObjects(e,t,r,i,n,a){var s=1&r,o=Pn(e),c=o.length;if(c!=Pn(t).length&&!s)return!1;for(var d=c;d--;){var l=o[d];if(!(s?l in t:Vn.call(t,l)))return!1}var m=a.get(e),p=a.get(t);if(m&&p)return m==t&&p==e;var u=!0;a.set(e,t),a.set(t,e);for(var h=s;++d<c;){var g=e[l=o[d]],v=t[l];if(i)var y=s?i(v,g,l,t,e,a):i(g,v,l,e,t,a);if(!(void 0===y?g===v||n(g,v,r,i,a):y)){u=!1;break}h||(h="constructor"==l)}if(u&&!h){var I=e.constructor,_=t.constructor;I==_||!("constructor"in e)||!("constructor"in t)||"function"==typeof I&&I instanceof I&&"function"==typeof _&&_ instanceof _||(u=!1)}return a.delete(e),a.delete(t),u},wn=x(o,"DataView"),Ln=x(o,"Promise"),Dn=x(o,"WeakMap"),Un="[object Map]",qn="[object Promise]",xn="[object Set]",Bn="[object WeakMap]",Fn="[object DataView]",Gn=O(wn),jn=O(ae),Hn=O(Ln),Yn=O(wi),$n=O(Dn),Wn=y;(wn&&Wn(new wn(new ArrayBuffer(1)))!=Fn||ae&&Wn(new ae)!=Un||Ln&&Wn(Ln.resolve())!=qn||wi&&Wn(new wi)!=xn||Dn&&Wn(new Dn)!=Bn)&&(Wn=function(e){var t=y(e),r="[object Object]"==t?e.constructor:void 0,i=r?O(r):"";if(i)switch(i){case Gn:return Fn;case jn:return Un;case Hn:return qn;case Yn:return xn;case $n:return Bn}return t});var zn=Wn,Kn="[object Arguments]",Jn="[object Array]",Qn="[object Object]",Xn=Object.prototype.hasOwnProperty;var Zn=function baseIsEqualDeep(e,t,r,i,a,s){var o=n(e),c=n(t),d=o?Jn:zn(e),l=c?Jn:zn(t),m=(d=d==Kn?Qn:d)==Qn,p=(l=l==Kn?Qn:l)==Qn,u=d==l;if(u&&or(e)){if(!or(t))return!1;o=!0,m=!1}if(u&&!m)return s||(s=new wt),o||_r(e)?_n(e,t,r,i,a,s):En(e,t,d,r,i,a,s);if(!(1&r)){var h=m&&Xn.call(e,"__wrapped__"),g=p&&Xn.call(t,"__wrapped__");if(h||g){var v=h?e.value():e,y=g?t.value():t;return s||(s=new wt),a(v,y,r,i,s)}}return!!u&&(s||(s=new wt),kn(e,t,r,i,a,s))};var ea=function baseIsEqual(e,t,r,i,n){return e===t||(null==e||null==t||!I(e)&&!I(t)?e!=e&&t!=t:Zn(e,t,r,i,baseIsEqual,n))};var ta=function baseIsMatch(e,t,r,i){var n=r.length,a=n,s=!i;if(null==e)return!a;for(e=Object(e);n--;){var o=r[n];if(s&&o[2]?o[1]!==e[o[0]]:!(o[0]in e))return!1}for(;++n<a;){var c=(o=r[n])[0],d=e[c],l=o[1];if(s&&o[2]){if(void 0===d&&!(c in e))return!1}else{var m=new wt;if(i)var p=i(d,l,c,e,t,m);if(!(void 0===p?ea(l,d,3,i,m):p))return!1}}return!0};var ra=function isStrictComparable(e){return e==e&&!E(e)};var ia=function getMatchData(e){for(var t=vi(e),r=t.length;r--;){var i=t[r],n=e[i];t[r]=[i,n,ra(n)]}return t};var na=function matchesStrictComparable(e,t){return function(r){return null!=r&&(r[e]===t&&(void 0!==t||e in Object(r)))}};var aa=function baseMatches(e){var t=ia(e);return 1==t.length&&t[0][2]?na(t[0][0],t[0][1]):function(r){return r===e||ta(r,e,t)}};var sa=function baseHasIn(e,t){return null!=e&&t in Object(e)};var oa=function hasPath(e,t,r){for(var i=-1,a=(t=Ee(t,e)).length,s=!1;++i<a;){var o=Se(t[i]);if(!(s=null!=e&&r(e,o)))break;e=e[o]}return s||++i!=a?s:!!(a=null==e?0:e.length)&&ir(a)&&Nr(o,a)&&(n(e)||rr(e))};var ca=function hasIn(e,t){return null!=e&&oa(e,t,sa)};var da=function baseMatchesProperty(e,t){return T(e)&&ra(t)?na(Se(e),t):function(r){var i=Ne(r,e);return void 0===i&&i===t?ca(r,e):ea(t,i,3)}};var la=function baseProperty(e){return function(t){return null==t?void 0:t[e]}};var ma=function basePropertyDeep(e){return function(t){return Ce(t,e)}};var pa=function property(e){return T(e)?la(Se(e)):ma(e)};var ua=function baseIteratee(e){return"function"==typeof e?e:null==e?Dr:"object"==typeof e?n(e)?da(e[0],e[1]):aa(e):pa(e)};var ha=function last(e){var t=null==e?0:e.length;return t?e[t-1]:void 0};var ga=function baseSlice(e,t,r){var i=-1,n=e.length;t<0&&(t=-t>n?0:n+t),(r=r>n?n:r)<0&&(r+=n),n=t>r?0:r-t>>>0,t>>>=0;for(var a=Array(n);++i<n;)a[i]=e[i+t];return a};var va=function parent(e,t){return t.length<2?e:Ce(e,ga(t,0,-1))};var ya=function baseUnset(e,t){return t=Ee(t,e),null==(e=va(e,t))||delete e[Se(ha(t))]},Ia=Array.prototype.splice;var _a=function basePullAt(e,t){for(var r=e?t.length:0,i=r-1;r--;){var n=t[r];if(r==i||n!==a){var a=n;Nr(n)?Ia.call(e,n,1):ya(e,n)}}return e};var Ma=function remove(e,t){var r=[];if(!e||!e.length)return r;var i=-1,n=[],a=e.length;for(t=ua(t);++i<a;){var s=e[i];t(s,i,e)&&(r.push(s),n.push(i))}return _a(e,n),r};class V2NIMLoginAuthenticator{constructor(e){this.lastLoginClientKey="__NIM_LAST_LOGIN_CLIENT__",this.loginClients=[],this.loginClientOfThisConnection={},this.core=e,this.auth=e.V2NIMLoginService}verifyAuthentication(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.auth.doLoginStepsManager.add(this.refreshLoginToken(this.auth.account)),r=yield this.auth.doLoginStepsManager.add(this.refreshThirdPartyExt(this.auth.account));this.auth.token=t;var i,n=Xr.getSystemInfo(),a={appkey:this.core.options.appkey,account:this.auth.account,token:t,authType:this.auth.loginOption.authType,appLogin:e?0:1,clientType:xe.V2NIM_LOGIN_CLIENT_TYPE_WEB,clientSession:this.auth.clientSession,clientId:this.auth.deviceId,sdkVersion:100400,userAgent:this.core.options.loginSDKTypeParamCompat?"Native/10.4.0":n.userAgent.slice(0,299),libEnv:this.core.options.loginSDKTypeParamCompat?void 0:n.libEnv,hostEnv:this.core.options.loginSDKTypeParamCompat?0:n.hostEnvEnum,sdkHumanVersion:"10.4.0",os:n.os,browser:n.browser,protocolVersion:1,customClientType:this.auth.config.customClientType,customTag:this.auth.config.customTag,thirdPartyExtension:r},s=n.os.toLowerCase();"UNIAPP"!==Xr.platform||"ios"!==s&&"android"!==s||(a.isReactNative=1,a.clientType="ios"===s?xe.V2NIM_LOGIN_CLIENT_TYPE_IOS:xe.V2NIM_LOGIN_CLIENT_TYPE_ANDROID,n.pushDeviceInfo&&n.pushDeviceInfo.MANUFACTURER&&(a.deviceInfo=JSON.stringify(Object.assign({IS_SUPPORT_HONOR:!0},n.pushDeviceInfo)))),this.core.logger.log("V2NIMLoginService::do login ",a.account,a.clientSession,a.appLogin);try{i=yield this.auth.doLoginStepsManager.add(this.auth.clientSocket.sendCmd("v2Login",{tag:a}))}catch(e){var o=e;if(this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"26-3",code:o.code||0,succeed:!1,description:o.message},{asyncParams:Xr.net.getNetworkStatus()}),o.code===Ct.V2NIM_ERROR_CODE_CANCELLED||o.code===Ct.V2NIM_ERROR_CODE_TIMEOUT)throw o;throw this.processLoginFailed(o),o}var{data:c,loginClients:d}=i.content;return this.changeLoginClient(Fe.V2NIM_LOGIN_CLIENT_CHANGE_LIST,d),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"26-3",code:200,succeed:!0},{asyncParams:Xr.net.getNetworkStatus()}),this.loginClientOfThisConnection=formatLoginInfo(c),this.core.clientSocket.setSessionId(c.consid),Xr.localStorage.setItem(this.lastLoginClientKey,JSON.stringify(Object.assign({account:this.auth.account},this.loginClientOfThisConnection))),this.loginClientOfThisConnection}))}refreshLoginToken(e){return __awaiter(this,void 0,void 0,(function*(){if(this.auth.loginOption.authType===Ue.V2NIM_LOGIN_AUTH_TYPE_DEFAULT)return this.auth.token;if("function"!=typeof this.auth.loginOption.tokenProvider)return this.auth.token;try{var t=yield this.auth.loginOption.tokenProvider(e);if("string"==typeof t)return t;throw this.core.logger.error("V2NIMLoginService::excute tokenProvider complete but got Unexpected value:",t),new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute tokenProvider complete but got Unexpected value",rawData:t}})}catch(e){var r=e,i=r;throw r.code!==Ct.V2NIM_ERROR_CODE_CALLBACK_FAILED&&(this.core.logger.error("V2NIMLoginService::excute tokenProvider error:",r),i=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CALLBACK_FAILED,desc:"Excute tokenProvider error",detail:{rawError:e}})),this.processLoginFailed(r),i}}))}refreshThirdPartyExt(e){return __awaiter(this,void 0,void 0,(function*(){if("function"!=typeof this.auth.loginOption.loginExtensionProvider)return"";try{var t=yield this.auth.loginOption.loginExtensionProvider(e);if("string"==typeof t)return t;throw this.core.logger.error("V2NIMLoginService::excute loginExtensionProvider complete but got Unexpected value:",t),new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute loginExtensionProvider complete but got Unexpected value",rawData:t}})}catch(e){var r=e,i=r;if(r.code!==Ct.V2NIM_ERROR_CODE_CALLBACK_FAILED&&(this.core.logger.error("V2NIMLoginService::excute loginExtensionProvider error:",r),i=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute loginExtensionProvider error",rawError:e}})),this.auth.loginOption.authType===Ue.V2NIM_LOGIN_AUTH_TYPE_THIRD_PARTY)throw this.processLoginFailed(r),i;return""}}))}processLoginFailed(e){this.auth.clientSocket.doDisconnect(gn.ACTIVE,e),this.checkLoginTerminalCode(e.code)&&(this.auth.authenticator.reset(),this.auth.authenticator.clearLastLoginClient()),this.auth.lifeCycle.processEvent("loginFail",e)}changeLoginClient(e,t){var r=t.map((e=>formatLoginInfo(e)));if(e===Fe.V2NIM_LOGIN_CLIENT_CHANGE_LIST)this.loginClients=r,this.auth.emit("onLoginClientChanged",e,this.loginClients);else if(e===Fe.V2NIM_LOGIN_CLIENT_CHANGE_LOGIN){var i=r.filter((e=>{var t=this.loginClients.filter((t=>t.clientId===e.clientId));return this.loginClients.push(e),0===t.length}));i.length>0&&this.auth.emit("onLoginClientChanged",e,i)}else if(e===Fe.V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT){var n=r.filter((e=>(Ma(this.loginClients,(t=>t.clientId===e.clientId&&t.consid===e.consid)),0===this.loginClients.filter((t=>t.clientId===e.clientId)).length)));n.length>0&&this.auth.emit("onLoginClientChanged",e,n)}}checkAutoLogin(e){if(e)return!1;var t=Xr.localStorage.getItem(this.lastLoginClientKey);if(!t)return!1;var r="",i="";try{var n=JSON.parse(t);r=Ne(n,"clientId"),i=Ne(n,"account")}catch(e){return!1}return r===this.auth.deviceId&&i===this.auth.account}checkLoginTerminalCode(e){return[Ct.V2NIM_ERROR_CODE_CANCELLED,Ct.V2NIM_ERROR_CODE_TIMEOUT,Ct.V2NIM_ERROR_CODE_HANDSHAKE,302,317,Ct.V2NIM_ERROR_CODE_FORBIDDEN,Ct.V2NIM_ERROR_CODE_NOT_FOUND,Ct.V2NIM_ERROR_CODE_PARAMETER_ERROR,Ct.V2NIM_ERROR_CODE_MULTI_LOGIN_FORBIDDEN,422,Ct.V2NIM_ERROR_CODE_IM_DISABLED,Ct.V2NIM_ERROR_CODE_APPKEY_NOT_EXIST,Ct.V2NIM_ERROR_CODE_BUNDLEID_CHECK_FAILED,Ct.V2NIM_ERROR_CODE_APPKEY_BLOCKED,Ct.V2NIM_ERROR_CODE_INVALID_TOKEN,Ct.V2NIM_ERROR_CODE_ROBOT_NOT_ALLOWED,Ct.V2NIM_ERROR_CODE_ACCOUNT_NOT_EXIST,Ct.V2NIM_ERROR_CODE_ACCOUNT_BANNED,Ct.V2NIM_ERROR_CODE_USER_PROFILE_NOT_EXIST].includes(e)}reset(){this.loginClients=[],this.loginClientOfThisConnection={}}clearLastLoginClient(){Xr.localStorage.removeItem(this.lastLoginClientKey)}}class V2NIMLoginLifeCycle{constructor(e){this.name="V2NIMLoginLifeCycle",this.loginStatus=qe.V2NIM_LOGIN_STATUS_LOGOUT,this.connectStatus=Ge.V2NIM_CONNECT_STATUS_DISCONNECTED,this.core=e,this.auth=e.V2NIMLoginService,this.logger=e.logger}processEvent(e,t,r){var i=this.getConnectStatus();switch(e){case"addressing":this.logger.log(`${this.name}::addressing`),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_LOGINING),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_CONNECTING);break;case"connect":this.logger.log(`${this.name}::connecting`),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_LOGINING),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_CONNECTING);break;case"connectSucc":this.logger.log(`${this.name}::connect success`),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_LOGINING),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_CONNECTED);break;case"connectFail":this.logger.log(`${this.name}::connect fail`,t),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_UNLOGIN),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_DISCONNECTED,t);break;case"connectionBroken":this.logger.log(`${this.name}::connectionBroken:`,t),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_UNLOGIN),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_DISCONNECTED,t),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleDisconnected",t);break;case"loginSucc":this.logger.log(`${this.name}::login success, verify authentication success`),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_LOGINED),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleLoginSucc",r);break;case"loginFail":if(this.logger.log(`${this.name}::login fail due to verify authentication failed:`,t),!t)return;this.setLoginStatus(this.auth.authenticator.checkLoginTerminalCode(t.code)?qe.V2NIM_LOGIN_STATUS_LOGOUT:qe.V2NIM_LOGIN_STATUS_UNLOGIN),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_DISCONNECTED,t),this.auth.emit("onLoginFailed",t);break;case"logout":this.logger.log(`${this.name}::logout`),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_LOGOUT),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_DISCONNECTED),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleLogout");break;case"kicked":this.logger.log(`${this.name}::kicked`,r),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_LOGOUT),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_DISCONNECTED,t),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleKicked");break;case"exited":this.logger.log(`${this.name}::exited`,t),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_LOGOUT),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_DISCONNECTED,t);break;case"waiting":this.logger.log(`${this.name}::waiting to reconnect`),this.setLoginStatus(qe.V2NIM_LOGIN_STATUS_UNLOGIN),this.setConnectStatus(Ge.V2NIM_CONNECT_STATUS_WAITING),i!==Ge.V2NIM_CONNECT_STATUS_CONNECTING&&this.auth.reconnect.attempToReLogin()}}getConnectStatus(){return this.connectStatus}getLoginStatus(){return this.loginStatus}setLoginStatus(e){e!==this.loginStatus&&(this.loginStatus=e,this.logger.log(`V2NIMLoginService::emit event "onLoginStatus", means ${qe[e]}`),this.auth.emit("onLoginStatus",e))}setConnectStatus(e,t){if(e!==this.connectStatus){var r=this.connectStatus;this.connectStatus=e,this.logger.log(`V2NIMLoginService::emit event "onConnectStatus", means ${Ge[e]}`),this.auth.emit("onConnectStatus",e),this.delegateConnectEvent(r,e,t)}}delegateConnectEvent(e,t,r){e===Ge.V2NIM_CONNECT_STATUS_CONNECTED&&t===Ge.V2NIM_CONNECT_STATUS_DISCONNECTED&&r&&this.auth.emit("onDisconnected",r),e===Ge.V2NIM_CONNECT_STATUS_CONNECTING&&t===Ge.V2NIM_CONNECT_STATUS_DISCONNECTED&&r&&this.auth.emit("onConnectFailed",r)}}class V2NIMLoginDataSync{constructor(e){this.core=e,this.auth=e.V2NIMLoginService,this.datas=[],this.mainSyncFlag=!1,this.conversationSyncFlag=!1}switchDataSync(e){return __awaiter(this,void 0,void 0,(function*(){var{type:t,state:r,error:i,subType:n}=e;t===be.V2NIM_DATA_SYNC_TYPE_MAIN&&r===Re.V2NIM_DATA_SYNC_STATE_COMPLETED&&("mainSync"===n?this.mainSyncFlag=!0:"conversationSync"===n&&(this.conversationSyncFlag=!0));var a=this.datas.filter((e=>e.type===t)),s=a.length>0?a[0]:null;s?(s.state=r,s.error=i):this.datas.push({type:t,state:r,error:i}),this.core.logger.log(`V2NIMLoginService::emit event "onDataSync", means ${be[t]} and ${Re[r]}`,i),t===be.V2NIM_DATA_SYNC_TYPE_MAIN&&(r===Re.V2NIM_DATA_SYNC_STATE_SYNCING?this.auth.emit("onDataSync",t,r,i):r===Re.V2NIM_DATA_SYNC_STATE_COMPLETED&&this.mainSyncFlag&&this.conversationSyncFlag&&(this.auth.emit("onDataSync",t,r,i),this.mainSyncFlag=!1,this.conversationSyncFlag=!1))}))}reset(){this.datas=[],this.mainSyncFlag=!1,this.conversationSyncFlag=!1}}var fa=function uniqBy(e,t){return e&&e.length?qi(e,ua(t)):[]},Ta=["https://lbs.netease.im/lbs/webconf.jsp"],Ea={retryCount:3,timeout:6e4,forceMode:!1,authType:Ue.V2NIM_LOGIN_AUTH_TYPE_DEFAULT,syncLevel:0};class V2NIMLoginServiceImpl extends V2Service{constructor(e,t={}){super("V2NIMLoginService",e),this.account="",this.previousLoginAccount="",this.token="",this.deviceId="",this.clientSession="",this.processId="",this.kickedDetail=null,this.binaryWebsocket=!0,registerParser({cmdMap:cn,cmdConfig:mn}),"v2"===e.options.apiVersion&&(registerParser({cmdMap:dn,cmdConfig:pn}),this.core.auth=this),this.previousLoginManager=new PromiseManager,this.doLoginStepsManager=new PromiseManager,this.loginTimerManager=new TimerManager,this.loginOption=Object.assign({},Ea),this.config={lbsUrls:Ta,linkUrl:"weblink05.netease.im:443"},this.setOptions(t),e.V2NIMLoginService=this;var r,i=this.core.options.binaryWebsocket,n="BROWSER"===Xr.platform&&"function"==typeof TextDecoder&&"function"==typeof TextEncoder&&"function"==typeof Uint8Array;"boolean"==typeof i&&(n=n&&i),n?(this.binaryWebsocket=!0,r=new V2BinaryClientSocket(this.core)):(this.binaryWebsocket=!1,r=new V2ClientSocket(this.core)),this.clientSocket=r,"v2"===this.core.options.apiVersion&&(this.core.clientSocket=r),this.lifeCycle=new V2NIMLoginLifeCycle(e),this.reconnect=new V2NIMLoginReconnect(e),this.lbs=new V2NIMLoginLbs(e),this.authenticator=new V2NIMLoginAuthenticator(e),this.dataSync=new V2NIMLoginDataSync(e)}setOptions(e){validate({lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},e,"",!0),this.config=assignOptions(this.config,e);var t="",r="";this.config.isFixedDeviceId?(t=Xr.localStorage.getItem("__NIM_DEVC_ID__")||Ii(),r=Xr.localStorage.getItem("__NIM_CLIENT_SESSION_ID__")||Ii(),Xr.localStorage.setItem("__NIM_DEVC_ID__",t),Xr.localStorage.setItem("__NIM_CLIENT_SESSION_ID__",r)):(t=Ii(),r=Ii()),this.deviceId=t,this.clientSession=r,this.core.reporter.setConfig({common:{dev_id:t}})}reset(){this.account="",this.token="",this.processId="",this.lbs.reset(),this.reconnect.reset(),this.authenticator.reset(),this.authenticator.clearLastLoginClient(),this.dataSync.reset()}login(e,t,r={}){return __awaiter(this,void 0,void 0,(function*(){if(this._checkApiVersion(),!e)throw new ValidateErrorV2({detail:{reason:"Empty account"}});if(validate({retryCount:{type:"number",min:0,required:!1},forceMode:{type:"boolean",required:!1},authType:{type:"enum",values:getEnumValues(Ue),required:!1},syncLevel:{type:"enum",values:getEnumValues(Ae),required:!1}},r,"",!0),0===r.authType&&!t)throw new ValidateErrorV2({detail:{reason:"When authType is 0, token cannot be empty"}});if(""!==this.previousLoginAccount&&this.previousLoginAccount!==e&&this.core._clearModuleData(),this.getLoginStatus()===qe.V2NIM_LOGIN_STATUS_LOGOUT)this.logger.log(`V2NIMLoginService::login:allowLogin:${e}`,r);else{if(this.getLoginStatus()===qe.V2NIM_LOGIN_STATUS_LOGINED)return this.smoothForLogined(e,t,r);if(this.getLoginStatus()===qe.V2NIM_LOGIN_STATUS_LOGINING)return this.smoothForLogining(e,t,r)}this.account=e,this.previousLoginAccount=e,this.token=t,this.processId=Ii(),this.loginOption=assignOptions(Ea,r),this.kickedDetail=null,this.loginTimerManager.destroy(),this.loginTimerManager.addTimer((()=>{var e=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_TIMEOUT,detail:{reason:"Login API timeout"}});this.doLoginStepsManager.clear(e),this.previousLoginManager.clear(e),this.originLoginPromise=void 0,this.lifeCycle.processEvent("exited",e)}),this.loginOption.timeout>0?this.loginOption.timeout:6e4,1);try{yield this.multiTryDoLogin(),this.loginTimerManager.destroy()}catch(e){throw this.loginTimerManager.destroy(),e}}))}getChatroomLinkAddress(e,t){return __awaiter(this,void 0,void 0,(function*(){validate({roomId:{type:"string",regExp:/^\d+$/,required:!0,allowEmpty:!1},miniProgram:{type:"boolean",required:!1}},{roomId:e,miniProgram:t},"",!0);var r="unknow environment"!==getMiniappEnv();return t=void 0===t?r:t,(yield this.clientSocket.sendCmd("v2GetChatroomLinkAddress",{roomId:e,miniProgram:t})).content.linkAddress}))}multiTryDoLogin(e){return __awaiter(this,void 0,void 0,(function*(){for(var t=new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"loginFailed"}}),r=0;r<=this.loginOption.retryCount;r++){var i=`V2NIMLoginService::times of login try: ${r}`;r>0?this.logger.warn(i):this.logger.log(i);try{this.originLoginPromise=e||this.doLogin(!1),e=void 0;var n=yield this.previousLoginManager.add(this.originLoginPromise);return this.core.reporter.reportTraceEnd("login",!0),this.doLoginStepsManager.clear(),this.previousLoginManager.clear(),this.originLoginPromise=void 0,n}catch(e){if(t=e||t,this.logger.error(`V2NIMLoginService::login failed, times of login try: ${r}, err.code: ${null==t?void 0:t.code}, err.message: "${null==t?void 0:t.message}"`),t.code!==Ct.V2NIM_ERROR_CODE_CANCELLED&&this.core.reporter.reportTraceEnd("login",!1),this.reconnect.clearReconnectTimer(),this.checkLoginTerminalCode(t&&t.code))throw this.lifeCycle.processEvent("exited",t),t;t&&399===t.code&&this.lbs.reset()}}throw this.lifeCycle.processEvent("exited",t),t}))}doLogin(e){return __awaiter(this,void 0,void 0,(function*(){var t=!!e||this.authenticator.checkAutoLogin(this.loginOption.forceMode);this.core.reporter.reportTraceCancel("login"),this.core.reporter.reportTraceStart("login",t?{user_id:this.account,action:"auto_login",process_id:this.processId,binary_websocket:this.binaryWebsocket}:{user_id:this.account,action:"manual_login",process_id:this.processId,binary_websocket:this.binaryWebsocket}),this.core.reporter.reportTraceUpdateV2("login",{code:0,description:JSON.stringify(this.loginOption),operation_type:"conf_init",succeed:!0,duration:0,target:""},{asyncParams:Xr.net.getNetworkStatus()});var r=yield this.doLoginStepsManager.add(this.lbs.getLbsInfos());yield this.doLoginStepsManager.add(this.clientSocket.connect(r,e));var i=yield this.doLoginStepsManager.add(this.authenticator.verifyAuthentication(t));this.lifeCycle.processEvent("loginSucc",void 0,Object.assign(Object.assign({},i),{isReconnect:e})),this.processId=Ii(),this.clientSocket.resetSocketConfig(),this.reconnect.reset(),this.clientSocket.ping(),this.core.abtest.abtRequest(),this.core.V2NIMClientAntispamUtil.downloadLocalAntiSpamVocabs();try{yield this.core.cloudStorage.init()}catch(e){this.logger.warn("doLogin::cloudStorage init error",e)}return i}))}smoothForLogined(e,t,r){return __awaiter(this,void 0,void 0,(function*(){var i=this.checkIsSameLogin(e,t,r);return this.logger.warn(`V2NIMLoginService::smoothForLogined:Logined, isSameLogin ${i}`),i?void 0:(yield this.logout(),this.login(e,t,r))}))}smoothForLogining(e,t,r){return __awaiter(this,void 0,void 0,(function*(){var i=this.checkIsSameLogin(e,t,r);if(this.logger.warn(`V2NIMLoginService::smoothForLogining:Logining progress exists, abort the previous login attempt and start next attempt, isSameLogin ${i}`),this.previousLoginManager.clear(),this.reconnect.reset(),this.account=e,this.previousLoginAccount=e,this.token=t,this.loginOption=assignOptions(this.loginOption,r),!i)return this.doLoginStepsManager.clear(),this.clientSocket.doDisconnect(gn.ACTIVE,"Aborted"),this.reset(),this.lifeCycle.processEvent("logout"),yield Promise.resolve(),this.login(e,t,r);if(!this.originLoginPromise)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"NoPreviousLoginExists"}});this.reconnect.reset(),yield Promise.resolve(),yield this.multiTryDoLogin(this.originLoginPromise)}))}checkIsSameLogin(e,t,r){return this.account===e&&this.loginOption.authType===r.authType&&(r.authType!==Ue.V2NIM_LOGIN_AUTH_TYPE_DEFAULT||this.token===t)}logout(){return __awaiter(this,void 0,void 0,(function*(){this._checkApiVersion(),this.doLoginStepsManager.clear(),this.previousLoginManager.clear(),this.loginTimerManager.destroy(),this.originLoginPromise=void 0;var e=this.getConnectStatus(),t=this.getLoginStatus();switch(t){case qe.V2NIM_LOGIN_STATUS_LOGINED:try{yield this.clientSocket.sendCmd("v2Logout",void 0,{timeout:1e3}),this.clientSocket.doDisconnect(gn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout")}catch(e){this.logger.error("Instance::disconnect sendCmd:logout error",e),this.clientSocket.doDisconnect(gn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout")}break;case qe.V2NIM_LOGIN_STATUS_LOGINING:case qe.V2NIM_LOGIN_STATUS_UNLOGIN:this.clientSocket.doDisconnect(gn.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout");break;case qe.V2NIM_LOGIN_STATUS_LOGOUT:throw this.core._clearModuleData(),new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:`Illegal logout. loginStatus ${t}. connectStatus ${e}`}});default:throw this.core._clearModuleData(),new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:`Illegal logout. illegal status: loginStatus ${t}. connectStatus ${e}`}})}}))}getConnectStatus(){return this.lifeCycle.getConnectStatus()}getLoginStatus(){return this.lifeCycle.getLoginStatus()}getLoginUser(){return this.account}getLoginClients(){return fa(this.authenticator.loginClients,"clientId")}getDataSync(){var e=this.dataSync.datas;return e&&e.length>0?e.map((e=>({type:e.type,state:e.state}))):null}setReconnectDelayProvider(e){this.reconnect._setReconnectDelayProvider(e)}kickOffline(e){return __awaiter(this,void 0,void 0,(function*(){this._checkApiVersion(),validate({clientId:{type:"string",allowEmpty:!1}},e,"",!0);var t=yield this.clientSocket.sendCmd("v2KickOffline",{clientIds:[e.clientId]});if(0===Ne(t,"content.clientIds.length"))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_REQUEST_FAILED})}))}getKickedOfflineDetail(){return this.kickedDetail}checkLoginTerminalCode(e){return this.authenticator.checkLoginTerminalCode(e)}checkIllegalState(){if(!this.getLoginUser())throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_ILLEGAL_STATE})}_checkApiVersion(){if("v2"!==this.core.options.apiVersion)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:'apiVersion is not "v2"'}})}v2LoginHandler(e){if(e.error)throw this.clientSocket.doDisconnect(gn.ACTIVE,e.error),e.error;return e}v2LoginClientChangeHandler(e){this.authenticator.changeLoginClient(parseInt(e.content.state),e.content.datas)}nimLoginClientChangeHandler(e){this.authenticator.changeLoginClient(parseInt(e.content.state),e.content.datas)}qchatLoginClientChangeHandler(e){var t=parseInt(e.content.state);t=1===t?Fe.V2NIM_LOGIN_CLIENT_CHANGE_LOGIN:Fe.V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT,this.authenticator.changeLoginClient(t,[e.content.data])}v2BeKickedHandler(e){if(e.error)this.core.logger.error("v2BeKickedHandler error, ",e.error);else{var t=function formatBeKickedTag(e){return format({reason:{type:"number"},clientType:{type:"number"},customClientType:{type:"number"}},e)}(e.content);this.core.logger.warn("v2Bekicked::",t),this.kickedDetail=t,this.clientSocket.doDisconnect(gn.KICKED,t),this.core._clearModuleData(),this.lifeCycle.processEvent("kicked",new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"disconnect due to kicked"}}),t),this.emit("onKickedOffline",t)}}}class Service$1{constructor(e,t){this.name=e,this.core=t,this.name=e,this.logger=t.logger,this.core=t}process(e){var t=this[e.cmd+"Handler"];if("function"==typeof t)return t.call(this,e);var r=Ne(e,"error.detail.ignore");return e.error&&!r?Promise.reject(e.error):Promise.resolve(e)}}var Sa={"5_1":"sync"},Ca={sync:{sid:5,cid:1,service:"sync",hasPacketTimer:!1,params:[{type:"Property",name:"sync",reflectMapper:{myInfo:1,offlineMsgs:2,teams:3,roamingMsgs:7,relations:9,friends:11,friendUsers:13,msgReceipts:14,myTeamMembers:15,donnop:16,recallMsg:17,sessionAck:18,broadcastMsgs:20,avSignal:21,superTeams:22,mySuperTeamMembers:23,superTeamRoamingMsgs:24,deleteSuperTeamMsg:25,superTeamSessionAck:26,deleteSelfMsgs:27,stickTopSessions:28,sessionHistoryMsgsDelete:29}}],response:[{type:"Long",name:"timetag"}]}};class SyncService extends Service$1{constructor(e,t={}){super("sync",e),this.syncDoneFlag=!1,this.config={myInfo:!!e.user.name,offlineMsgs:!!e.msg.name,teams:!!e.team.name,myTeamMembers:!!e.team.name,roamingMsgs:!!e.msg.name,relations:!!e.user.name,friends:!!e.friend.name,friendUsers:!!e.user.name,msgReceipts:!!e.msg.name,broadcastMsgs:!!e.msg.name,recallMsg:!!e.msg.name,sessionAck:!!e.session.name,superTeamSessionAck:!!e.session.name,superTeams:!!e.superTeam.name,mySuperTeamMembers:!!e.superTeam.name,superTeamRoamingMsgs:!!e.superTeam.name,deleteSuperTeamMsg:!!e.superTeam.name,deleteSelfMsgs:!!e.msg.name,sessionHistoryMsgsDelete:!!e.msgLog.name,avSignal:!!e.signaling.name},this.setOptions(t),this.timetags={},this.initEventListeners(),registerParser({cmdMap:Sa,cmdConfig:Ca})}setOptions(e){Object.assign(this.config,e)}reset(){this.timetags={},this.syncDoneFlag=!1}getSyncDoneFlag(){return this.syncDoneFlag}doSync(){var e;return __awaiter(this,void 0,void 0,(function*(){var t=this.genSyncParams();this.logger.log("sync::doSyncV1: ",t);try{var r=yield this.core.clientSocket.sendCmd("sync",{sync:t});this.core.logger.log("sync::doSyncV1 done in",null===(e=r.content)||void 0===e?void 0:e.timetag),this.syncDoneFlag=!0,this.core.emit("syncdone")}catch(e){return this.core.logger.error("sync::doSyncV1 error",e),this.syncDoneFlag=!0,void this.core.emit("syncdone")}}))}initEventListeners(){this.core.eventBus.on("logined",(()=>{this.syncDoneFlag=!1,this.doSync()})),this.core.eventBus.on("sync/updateTimetag",(e=>{Object.keys(e).forEach((t=>{e[t]>(this.timetags[t]||0)&&(this.timetags[t]=e[t])}))}))}genSyncParams(){return Object.keys(this.config).filter((e=>{var t=e;return this.config[t]})).reduce(((e,t)=>{var r=t;return e[r]=this.timetags[r]||0,e}),{})}handleImmediate(e){return this.core.session&&this.core.session.onSyncDone&&this.core.session.onSyncDone(),Promise.resolve(e)}delaySyncDone(e){return"ALI"===getMiniappEnv()?(this.core.logger.log("sync: emit ALIAPP sycnHandler, handle later"),new Promise((t=>{setTimeout((()=>{this.handleImmediate(e).then((()=>{t(e)}))}),100)}))):this.handleImmediate(e)}syncHandler(e){return this.delaySyncDone(e)}}var Na,Aa,ba=["error","warn","log","debug"],emptyFunc=function(){},Ra=["off","error","warn","log","debug"];class Logger{constructor(e){this.strategies={debug:{name:"debug",func:console.log},log:{name:"  log",func:console.log},warn:{name:" warn",func:console.warn},error:{name:"error",func:console.error}},this.debug=emptyFunc,this.log=emptyFunc,this.warn=emptyFunc,this.error=emptyFunc,Ra.includes(e)||(e="off"),this.setLogFunc(e)}setLogFunc(e){var t=ba.findIndex((t=>t===e));ba.forEach(((e,r)=>{r<=t&&(this[e]=function(){var t=Array.prototype.slice.call(arguments),r=this.strategies[e],i=this.formatArgs(t,r.name);r.func(i)})}))}formatArgs(e,t){var r=new Date;return`[NIM ${t} ${`${r.getMonth()+1}-${r.getDate()} ${r.getHours()}:${r.getMinutes()}:${r.getSeconds()}:${r.getMilliseconds()}`}] `+e.map((e=>e instanceof V2NIMErrorImpl?e.toString():e instanceof Error?e&&e.message?e.message:e:"object"==typeof e?JSON.stringify(e):e)).join(" ")}destroy(){this.debug=emptyFunc,this.log=emptyFunc,this.warn=emptyFunc,this.error=emptyFunc}}class CoreAdapters{constructor(e){this.lastCommonHost="",this.core=e}getFileUploadInformation(e){return Xr.getFileUploadInformation(e)}request(e,t,r){var i=(new Date).getTime(),n=(null==r?void 0:r.exception_service)||0;return Xr.request(e,t).catch((r=>{var a,s,o,c,d=r;throw this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account||(null===(s=null===(a=this.core)||void 0===a?void 0:a.auth)||void 0===s?void 0:s.account),trace_id:null===(c=null===(o=this.core.clientSocket)||void 0===o?void 0:o.socket)||void 0===c?void 0:c.sessionId,start_time:i,action:1,exception_service:n}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof d.code?d.code:0,description:d.message||`${d.code}`,operation_type:0,target:e,context:t?JSON.stringify(t):""},{asyncParams:Xr.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1),r}))}uploadFile(e){var t,r,i,n;return __awaiter(this,void 0,void 0,(function*(){for(var a=e.commonUploadHostBackupList.indexOf(e.commonUploadHost),s=-1===a?[e.commonUploadHost,...e.commonUploadHostBackupList]:[e.commonUploadHost,...e.commonUploadHostBackupList.slice(0,a),...e.commonUploadHostBackupList.slice(a+1)],o=Math.max(s.indexOf(this.lastCommonHost),0),c="BROWSER"===Xr.platform?1:s.length,d=null,l=0;l<c;l++){var m=(new Date).getTime();this.lastCommonHost=s[(l+o)%s.length];try{return yield Xr.uploadFile(Object.assign(Object.assign({},e),{commonUploadHost:this.lastCommonHost}))}catch(a){d=a;var p=a;this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account||(null===(r=null===(t=this.core)||void 0===t?void 0:t.auth)||void 0===r?void 0:r.account),trace_id:null===(n=null===(i=this.core.clientSocket)||void 0===i?void 0:i.socket)||void 0===n?void 0:n.sessionId,start_time:m,action:1,exception_service:3});var u="BROWSER"===Xr.platform?e.chunkUploadHost:`${this.lastCommonHost}/${e.nosToken&&e.nosToken.bucket}`;this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof p.code?p.code:0,description:p.message||`${p.code}`,operation_type:1,target:u},{asyncParams:Xr.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1)}}throw d}))}}class ABTest{constructor(e,t){this.abtInfo={},this.core=e,this.config=assignOptions({isAbtestEnable:!0,abtestUrl:Xi,abtestProjectKey:Zi},t)}setOptions(e){this.config=assignOptions(this.config,e)}abtRequest(){var e,t;return __awaiter(this,void 0,void 0,(function*(){if(this.config.isAbtestEnable&&!this.abtInfo.experiments&&this.config.abtestUrl){var r;try{r=yield this.core.adapters.request(this.config.abtestUrl,{method:"POST",dataType:"json",headers:{sdktype:"ABTest"},data:{clientInfo:{projectKey:this.config.abtestProjectKey,appKey:this.core.options.appkey,osType:"Web",sdkVersion:"10.4.0",deviceId:this.core.config.deviceId},useLocalCache:!0}},{exception_service:7})}catch(e){this.core.logger.warn("ABTest request failed")}this.abtInfo=(null===(t=null===(e=null==r?void 0:r.data)||void 0===e?void 0:e.data)||void 0===t?void 0:t.abtInfo)||{}}}))}}!function(e){e[e.Android=1]="Android",e[e.iOS=2]="iOS",e[e.PC=4]="PC",e[e.WindowsPhone=8]="WindowsPhone",e[e.Web=16]="Web",e[e.Server=32]="Server",e[e.Mac=64]="Mac",e[e.HarmonyOS=65]="HarmonyOS"}(Na||(Na={})),function(e){e.Destroy="destroy",e.Logout="logout"}(Aa||(Aa={}));var Oa={user_id:"",trace_id:"",action:7,exception_service:6,duration:0,start_time:0,state:1,extension:[]};class ReporterHookLinkKeep{constructor(e,t){this.traceData=Oa,this.core=e,this.traceData=Object.assign({},Oa,t),this.traceData.extension=[]}reset(){this.traceData=Object.assign({},Oa),this.traceData.extension=[]}start(){var e,t;this.reset(),this.traceData.user_id=this.core.account,this.traceData.trace_id=(null===(t=null===(e=this.core.clientSocket)||void 0===e?void 0:e.socket)||void 0===t?void 0:t.sessionId)||"",this.traceData.start_time=(new Date).getTime()}update(e){return __awaiter(this,void 0,void 0,(function*(){var{net_type:t,net_connect:r}=yield Xr.net.getNetworkStatus();this.traceData.extension.push(Object.assign({code:0,foreground:!0,foreg_backg_switch:!1,net_type:t,net_connect:r},e))}))}end(e){var t=this.traceData.extension[0],r=this.traceData.extension[1];if(t&&0===t.operation_type&&r&&1===r.operation_type){var i=t.net_type!==r.net_type||t.net_connect!==r.net_connect;if(e||!i)return this.traceData.duration=(new Date).getTime()-this.traceData.start_time,this.core.reporter.report("exceptions",this.traceData),void this.reset();this.reset()}else this.reset()}}var Pa={user_id:"",trace_id:"",net_connect:!0,net_type:0,duration:0,start_time:0,history:[],succeed:!1};class ReporterHookLBS{constructor(e){this.traceData=Pa,this.core=e,this.reset()}reset(){this.traceData=Object.assign({},Pa),this.traceData.history=[]}start(e){this.reset(),this.traceData.user_id=e,this.traceData.start_time=Date.now()}updateBegin(e){this.traceData.history.push(Object.assign({head:"",body:"",start_time:Date.now(),httpdns:!1,index:0},e))}updateComplete(e){this.traceData.history.forEach((t=>{t.target===e.target&&(Object.assign(t,e),t.duration=Date.now()-t.start_time)}))}end(e){return __awaiter(this,void 0,void 0,(function*(){if(this.traceData.succeed=e,this.traceData.history=this.traceData.history.filter((e=>void 0!==e.code)),0!==this.traceData.history.length){this.traceData.duration=Date.now()-this.traceData.start_time;var{net_type:t,net_connect:r}=yield Xr.net.getNetworkStatus();this.traceData.net_type=t,this.traceData.net_connect=r,this.core.reporter.report("nim_sdk_lbs_records",this.traceData),this.reset()}else this.reset()}))}}var Va={user_id:"",trace_id:"",action:0,state:0,duration:0,start_time:0,offset:0,full_size:0,transferred_size:0,operation_type:0,remote_addr:""},ka="ReporterHook::setMonitorForResources:";class ReporterHookCloudStorage{constructor(e,t){this.traceData=Va,this.core=e,this.traceData=Object.assign({},Va,t)}reset(){this.traceData=Object.assign({},Va)}start(){var e,t;this.reset(),this.traceData.user_id=this.core.account,this.traceData.trace_id=(null===(t=null===(e=this.core.clientSocket)||void 0===e?void 0:e.socket)||void 0===t?void 0:t.sessionId)||"",this.traceData.start_time="timeOrigin"in this.core?this.core.timeOrigin.getNTPTime():Date.now()}update(e){return __awaiter(this,void 0,void 0,(function*(){this.traceData.user_id&&(this.core.logger.log(`${ka} upload update`,e),Object.assign(this.traceData,e))}))}end(e){this.traceData.user_id&&(this.core.logger.log(`${ka} upload end cause of ${e}`),this.traceData.state=e,this.traceData.duration=("timeOrigin"in this.core?this.core.timeOrigin.getNTPTime():Date.now())-this.traceData.start_time,this.core.reporter.report("nim_sdk_resources",this.traceData),this.traceData=Va)}}function getIsDataReportEnable(e){var t,r,i=!0;return"boolean"==typeof(null===(t=null==e?void 0:e.reporterConfig)||void 0===t?void 0:t.enableCompass)?i=e.reporterConfig.enableCompass:"boolean"==typeof(null===(r=null==e?void 0:e.reporterConfig)||void 0===r?void 0:r.isDataReportEnable)&&(i=e.reporterConfig.isDataReportEnable),i}function getReportConfigUrl(e){var t,r,i="https://statistic.live.126.net/dispatcher/req";return"string"==typeof(null===(t=null==e?void 0:e.reporterConfig)||void 0===t?void 0:t.compassDataEndpoint)?((i=e.reporterConfig.compassDataEndpoint).endsWith("/")&&(i=i.slice(0,-1)),i+="/dispatcher/req"):"string"==typeof(null===(r=null==e?void 0:e.reporterConfig)||void 0===r?void 0:r.reportConfigUrl)&&(i=e.reporterConfig.reportConfigUrl),i}function getReportUrl(e){var t,r,i="https://statistic.live.126.net/statics/report/common/form";return"string"==typeof(null===(t=null==e?void 0:e.reporterConfig)||void 0===t?void 0:t.compassDataEndpoint)?((i=e.reporterConfig.compassDataEndpoint).endsWith("/")&&(i=i.slice(0,-1)),i+="/statics/report/common/form"):"string"==typeof(null===(r=null==e?void 0:e.reporterConfig)||void 0===r?void 0:r.reportUrl)&&(i=e.reporterConfig.reportUrl),i}var wa={},La={},Da={},Ua={apiVersion:"v1",debugLevel:"off",needReconnect:!0,reconnectionAttempts:Number.MAX_SAFE_INTEGER,lbsUrls:Qi,linkUrl:Ji,abtestUrl:Xi,isAbtestEnable:!0};class NIM extends r{constructor(e,t={}){super(),this.instanceName="NIM",this.pluginMap={},this.eventBus=new r,this.options={},this.V2NIMConversationIdUtil={},this.V2NIMMessageCreator={},this.V2NIMMessageAttachmentCreator={},this.V2NIMClientAntispamUtil={},this.DataStructureConverter={},this.V2NIMMessageConverter={},this.V2NIMMessageLogUtil={},this.V2NIMMessageExtendUtil={},this.V2NIMStorageUtil={},this.V2NIMNotificationService={},this.V2NIMStorageService={},this.V1NIMLoginService={},this.V2NIMLoginService={},this.clientSocket={},this.V2NIMSyncService={},this.V2NIMConversationService={},this.V2NIMConversationGroupService={},this.V2NIMMessageService={},this.V2NIMTeamService={},this.V2NIMUserService={},this.V2NIMFriendService={},this.V2NIMSettingService={},this.V2NIMAIService={},this.V2NIMSignallingService={},this.V2NIMSubscriptionService={},this.offlinePush={},this.sync={},this.msg={},this.msgLog={},this.session={},this.cloudSession={},this.misc={},this.user={},this.friend={},this.systemMessage={},this.team={},this.event={},this.msgExtend={},this.cloudStorage={},this.passThrough={},this.superTeam={},this.plugin={},this.signaling={},this.qchatChannel={},this.qchatMedia={},this.qchatMsg={},this.qchatRole={},this.qchatServer={},this.pluginMap=Da,this.logger=new Logger(e.debugLevel),this.setInitOptions(e),this.otherOptions=Object.assign(Object.assign({},t),{cloudStorageConfig:Object.assign({storageKeyPrefix:"NIM"},t.cloudStorageConfig)}),this.timerManager=new TimerManager,this.timeOrigin=new TimeOrigin(this),this.adapters=new CoreAdapters(this),this.abtest=new ABTest(this,{isAbtestEnable:this.options.isAbtestEnable,abtestUrl:this.options.abtestUrl,abtestProjectKey:Zi});var n=Xr.getSystemInfo();this.reporter=new i({reportConfigUrl:getReportConfigUrl(t),reportUrl:getReportUrl(t),isDataReportEnable:getIsDataReportEnable(t),common:{app_key:e.appkey,dev_id:"",platform:"Web",sdk_ver:"10.4.0",env:"online",os_name:n.os,os_ver:n.osVer,lib_env:n.libEnv,host_env:n.hostEnv,host_env_ver:n.hostEnvVer,manufactor:n.manufactor,model:n.model,v2:"v1"!==this.options.apiVersion},request:Xr.request,logger:this.logger,autoStart:!0}),this.reporterHookLinkKeep=new ReporterHookLinkKeep(this),this.reporterHookCloudStorage=new ReporterHookCloudStorage(this),this.reporterHookLBS=new ReporterHookLBS(this),Xr.setLogger(this.logger),"v1"===this.options.apiVersion?this.auth=new V1NIMLoginServiceImpl(this,this.options):this.auth=new V2NIMLoginServiceImpl(this,this.otherOptions.V2NIMLoginServiceConfig),Object.keys(wa).filter((e=>"V1NIMLoginService"!==e&&"V2NIMLoginService"!==e&&"sync"!==e)).forEach((e=>{var t=wa[e];this[e]=new t(this)})),wa.sync&&(this.sync=new SyncService(this,this.otherOptions.syncOptions)),Object.keys(wa).forEach((e=>{var t=`${e}Config`,r=this.otherOptions[t]||{},i=Ne(this,`${e}.setOptions`);"function"==typeof i&&("cloudStorage"===e&&(r=this.otherOptions[t]||this.otherOptions.serverConfig||{}),i.call(this[e],r))})),Object.keys(La).forEach((e=>{var t=La[e];void 0!==t&&(this[e]=new t(this))})),NIM.instance=this,this.logger.log("NIM init, version ","10.4.0"," sdk version ",100400," appkey ",e.appkey)}static getInstance(e,t){if(!NIM.instance){if(e)return new NIM(e,t);throw new Error("Instance not exist, please input options")}if(e){if(NIM.instance.options.account===e.account&&NIM.instance.options.appkey===e.appkey)return NIM.instance.setOptions(e),NIM.instance;throw new Error("Unexpected login")}return NIM.instance}setInitOptions(e){validate({appkey:{type:"string"},apiVersion:{type:"enum",values:["v1","v2"],required:!1},binaryWebsocket:{type:"boolean",required:!1},needReconnect:{type:"boolean",required:!1},reconnectionAttempts:{type:"number",required:!1},customClientType:{type:"number",min:1,required:!1},authType:{type:"number",min:0,max:2,required:!1},lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},e),this.logger.log("NIM::setInitOptions options is",e),this.options=Object.assign(Object.assign({},Ua),e)}connect(e={}){return this.V1NIMLoginService.login(e)}setOptions(e){if("object"==typeof e&&null!==e){if(Object.prototype.hasOwnProperty.call(e,"account")&&e.account!==this.options.account||Object.prototype.hasOwnProperty.call(e,"appkey")&&e.appkey!==this.options.appkey)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions account and appkey is not allowed to reset"}});if(Object.prototype.hasOwnProperty.call(e,"apiVersion")&&e.apiVersion!==this.options.apiVersion)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions apiVersion is not allowed to reset"}});if(Object.prototype.hasOwnProperty.call(e,"binaryWebsocket")&&e.binaryWebsocket!==this.options.binaryWebsocket)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions binaryWebsocket is not allowed to reset"}});validate({token:{type:"string",required:!1},needReconnect:{type:"boolean",required:!1},reconnectionAttempts:{type:"number",required:!1},customClientType:{type:"number",min:1,required:!1},authType:{type:"number",min:0,max:2,required:!1},lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},e),this.logger.log("NIM::setOptions options is",e),this.options=Object.assign(Object.assign({},this.options),e),this.V1NIMLoginService.setOptions&&this.V1NIMLoginService.setOptions(this.options)}}disconnect(){return this.V1NIMLoginService.logout()}_disconnect(){return"v1"===this.options.apiVersion?this.V1NIMLoginService.logout():"v2"===this.options.apiVersion?Ne(this.V2NIMLoginService,"lifeCycle.connectStatus")===Ge.V2NIM_CONNECT_STATUS_DISCONNECTED&&Ne(this.V2NIMLoginService,"lifeCycle.loginStatus")===qe.V2NIM_LOGIN_STATUS_LOGOUT?Promise.resolve():this.V2NIMLoginService.logout():Promise.resolve()}destroy(){return NIM.instance=void 0,this._disconnect().then((()=>{this.status="destroyed",this.removeAllListeners(),this.eventBus.removeAllListeners(),this.logger.destroy(),this.reporter.destroy(),this.timerManager.destroy(),this._clearModuleData(Aa.Destroy),this._removeAllModuleListeners(),this.connect=emptyFuncWithPromise,this.disconnect=emptyFuncWithPromise,this._disconnect=emptyFuncWithPromise,this.destroy=emptyFuncWithPromise}))}_clearModuleData(e=Aa.Logout){Object.values(this).forEach((t=>{t&&"function"==typeof t.reset&&t.reset(e)}))}_removeAllModuleListeners(){Object.values(this).forEach((e=>{e&&"function"==typeof e.removeAllListeners&&e.removeAllListeners()}))}kick(e){return this.V1NIMLoginService.kick(e)}sendCmd(e,t,r){return this.clientSocket.sendCmd(e,t,r)}emit(e,...t){try{var r=Date.now(),i=super.emit(e,...t),n=Date.now()-r;return n>=10&&this.logger.warn(`Core::emit event: ${e} process takes: ${n}ms`),i}catch(t){return this.logger.error(`Core::emit event: ${e}. Error: ${t}`),setTimeout((()=>{throw this.logger.error(`Core::emit throw error in setTimeout. event: ${e}. Error: ${t}`),t}),0),!1}}get account(){return this.auth.account}get status(){return this.V1NIMLoginService.status}set status(e){this.V1NIMLoginService.status=e}get config(){return{timeout:8e3,deviceId:this.auth.deviceId}}static registerService(e,t){wa[t]=e}static registerPrivateService(e,t){La[t]=e}static registerPlugin(e,t){Da[t]=e}}var qa=console,xa={clear(){try{my.clearStorageSync()}catch(e){qa.error("ali-app::ws: clearStorage ",e)}},getItem:e=>my.getStorageSync({key:e}).data,setItem:(e,t)=>my.setStorageSync({key:e,data:t}),removeItem:e=>my.removeStorageSync({key:e})};class WebSocket$3{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(e){qa.log("my-app: sockets on close ",e)},this.onerror=function(e){qa.error("my-app: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING,this.socketTask=my.connectSocket({url:this.url,multiple:!0,fail:e=>{this.errorHandler(e)},success:()=>{this.readyState=this.OPEN}}),this.socketTask.onOpen((e=>{this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:e})})),this.socketTask.onError((e=>{this.errorHandler(e)})),this.socketTask.onClose((e=>{this.readyState=this.CLOSED;var{code:t,reason:r,wasClean:i}=e;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:i,type:"close"}),this.socketTask=null})),this.socketTask.onMessage((e=>{var t,r=null===(t=e.data)||void 0===t?void 0:t.data,i=r;e.data.isBuffer&&(i=base64ToArrayBuffer(r)),this.onmessage&&this.onmessage({data:i})}))}close(){this.socketTask&&this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`my-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("my-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask&&this.socketTask.send({data:e,isBuffer:e instanceof ArrayBuffer})}errorHandler(e){qa.error("my-app::ws: onerror ",e),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg})}}function request$3(e,t){return t&&(t.data=t.data||(null==t?void 0:t.params)||{}),new Promise(((r,i)=>{my.request(Object.assign(Object.assign({url:e},t),{success:function(e){e={data:e.data,status:e.status,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){e.code=13===e.error?Ct.V2NIM_ERROR_CODE_TIMEOUT:e.error,e.message=e.errorMessage,i(e)}}))}))}function uploadFile$3(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{var i=my.uploadFile(Object.assign(Object.assign({url:`${e.commonUploadHost}/${e.nosToken.bucket}`},e.md5?{header:{"Content-MD5":e.md5}}:{}),{formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},fileType:e.type,fileName:"file",filePath:e.filePath,success(i){if(200==i.statusCode)try{var n=JSON.parse(i.data);n.name=e.filePath,n.ext=n.name.lastIndexOf(".")>-1?n.name.slice(n.name.lastIndexOf(".")+1).toLowerCase():"",t(n)}catch(e){r(new Error(`Upload Error parse result error: ${i.data}`))}else r(new Error(`Upload error ${i.statusCode}: ${i.errMsg}`))},fail(e){e.code=9===e.error?Ct.V2NIM_ERROR_CODE_CANCELLED:e.error,e.message=e.errorMessage,r(e)}}));try{e.onUploadStart&&e.onUploadStart(i)}catch(e){qa.error("uploadFile: options.onUploadStart error",e),i.abort(),r(e)}e.onUploadProgress&&i.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToWrite,loaded:t.totalBytesWritten,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))}function getFileUploadInformation$3(e){return null}function getSystemInfo$3(){var e=my.getSystemInfoSync()||{};return{libEnv:"MINIAPP",os:e.platform||"",osVer:e.system||"",browser:"",browserVer:"",hostEnv:"Ali",hostEnvEnum:Wr.Ali,hostEnvVer:e.version,userAgent:`Ali MiniApp: model/${e.model} system/${e.system}`,model:my.SDKVersion,manufactor:"Ali",pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}var Ba=console,Fa={clear(){try{wx.clearStorageSync()}catch(e){Ba.error("wx-app::ws: clearStorage ",e)}},getItem:e=>wx.getStorageSync(e),setItem:(e,t)=>wx.setStorageSync(e,t),removeItem:e=>wx.removeStorageSync(e)};class WebSocket$2{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(e){Ba.log("wx-app: sockets on close ",e)},this.onerror=function(e){Ba.error("wx-app: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING;var r=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=wx.connectSocket(Object.assign(Object.assign({url:this.url},r),{fail:e=>{this.errorHandler(e)},success:()=>{}})),this.socketTask.onOpen((e=>{this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:e})})),this.socketTask.onError((e=>{this.errorHandler(e)})),this.socketTask.onClose((e=>{this.readyState=this.CLOSED;var{code:t,reason:r,wasClean:i}=e;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:i,type:"close"})})),this.socketTask.onMessage((e=>{this.onmessage&&this.onmessage(e)}))}close(){this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`wx-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("wx-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask.send({data:e})}errorHandler(e){Ba.error("wx-app::ws: onerror ",e),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg})}}function request$2(e,t){return t&&(t.header=t.headers,t.data=t.data||(null==t?void 0:t.params)||{}),new Promise(((r,i)=>{wx.request(Object.assign(Object.assign({url:e},t),{success:function(e){e={data:e.data,status:e.statusCode,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){e.code=5===e.errno?Ct.V2NIM_ERROR_CODE_TIMEOUT:e.errno,e.message=e.errMsg,i(e)}}))}))}function uploadFile$2(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{var i=wx.uploadFile(Object.assign(Object.assign({url:`${e.commonUploadHost}/${e.nosToken.bucket}`},e.md5?{header:{"Content-MD5":e.md5}}:{}),{formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:e.filePath,success(i){if(200==i.statusCode)try{var n=JSON.parse(i.data);n.name=e.filePath,n.ext=n.name.lastIndexOf(".")>-1?n.name.slice(n.name.lastIndexOf(".")+1).toLowerCase():"",t(n)}catch(e){r(new Error(`Upload Error parse result error: ${i.data}`))}else r(new Error(`Upload error ${i.statusCode}: ${i.errMsg}`))},fail(e){e.code="uploadFile:fail abort"===e.errMsg?Ct.V2NIM_ERROR_CODE_CANCELLED:e.errno,e.message=e.errMsg,r(e)}}));try{e.onUploadStart&&e.onUploadStart(i)}catch(e){Ba.error("uploadFile: options.onUploadStart error",e),i.abort(),r(e)}e.onUploadProgress&&i.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToSend,loaded:t.totalBytesSent,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))}function getSystemInfo$2(){var e=wx.getSystemInfoSync()||{};return{os:e.platform||"",osVer:e.system||"",browser:"",browserVer:"",libEnv:"MINIAPP",hostEnv:"WeiXin",hostEnvEnum:Wr.WeiXin,hostEnvVer:e.version,model:e.SDKVersion,manufactor:"WeiXin",userAgent:`WeChat MiniApp: model/${e.model} system/${e.system}`,pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}function getFileUploadInformation$2(e){return null}var Ga=console,ja={clear(){try{swan.clearStorageSync()}catch(e){Ga.error("baidu-app::ws: clearStorage ",e)}},getItem:e=>swan.getStorageSync(e),setItem:(e,t)=>swan.setStorageSync(e,t),removeItem:e=>swan.removeStorageSync(e)};class WebSocket$1{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(e){Ga.log("baidu-app: sockets on close ",e)},this.onerror=function(e){Ga.error("baidu-app: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING;var r=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=swan.connectSocket(Object.assign(Object.assign({url:this.url},r),{fail:e=>{this.errorHandler(e)},success:()=>{}})),this.socketTask.onOpen((e=>{this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:e})})),this.socketTask.onError((e=>{this.errorHandler(e)})),this.socketTask.onClose((e=>{this.readyState=this.CLOSED;var{code:t,reason:r,wasClean:i}=e;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:i,type:"close"})})),this.socketTask.onMessage((e=>{this.onmessage&&this.onmessage({data:e.data})}))}close(){this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`wx-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("wx-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask.send({data:e})}errorHandler(e){this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg})}}function request$1(e,t){return t&&(t.header=t.headers,t.data=t.data||(null==t?void 0:t.params)||{}),new Promise(((r,i)=>{swan.request(Object.assign(Object.assign({url:e},t),{success:function(e){e={data:e.data,status:e.statusCode,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){e.code=1===e.errCode?Ct.V2NIM_ERROR_CODE_TIMEOUT:e.errCode,e.message=e.errMsg,i(e)}}))}))}function uploadFile$1(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{var i=swan.uploadFile(Object.assign(Object.assign({url:`${e.commonUploadHost}/${e.nosToken.bucket}`},e.md5?{header:{"Content-MD5":e.md5}}:{}),{formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:e.filePath,success(i){if(200==i.statusCode)try{var n=JSON.parse(i.data);n.name=e.filePath,n.ext=n.name.lastIndexOf(".")>-1?n.name.slice(n.name.lastIndexOf(".")+1).toLowerCase():"",t(n)}catch(e){r(new Error(`Upload Error parse result error: ${i.data}`))}else r(new Error(`Upload error ${i.statusCode}: ${i.errMsg}`))},fail(e){e.code="uploadFile:fail abort"===e.errMsg?Ct.V2NIM_ERROR_CODE_CANCELLED:e.errCode,e.message=e.errMsg,r(e)}}));try{e.onUploadStart&&e.onUploadStart(i)}catch(e){Ga.error("uploadFile: options.onUploadStart error",e),i.abort(),r(e)}e.onUploadProgress&&i.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToSend,loaded:t.totalBytesSent,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))}function getFileUploadInformation$1(e){return null}function getSystemInfo$1(){var e=swan.getSystemInfoSync()||{};return{os:e.platform||"",osVer:e.system||"",browser:"",browserVer:"",libEnv:"MINIAPP",hostEnv:"Baidu",userAgent:`Baidu MiniApp: model/${e.model} system/${e.system}`,hostEnvVer:e.version,hostEnvEnum:Wr.Baidu,model:e.SDKVersion,manufactor:"Baidu",pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}var Ha=console,Ya={clear(){try{tt.clearStorageSync()}catch(e){Ha.error("tt-app::ws: clearStorage ",e)}},getItem:e=>tt.getStorageSync(e),setItem:(e,t)=>tt.setStorageSync(e,t),removeItem:e=>tt.removeStorageSync(e)};class WebSocket{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",this.onclose=function(e){Ha.log("wx-app: sockets on close ",e)},this.onerror=function(e){Ha.error("wx-app: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING;var r=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=tt.connectSocket(Object.assign(Object.assign({url:this.url},r),{fail:e=>{this.errorHandler(e)},success:()=>{}})),this.socketTask.onOpen((e=>{this.readyState=this.OPEN,this.binaryType?this.onopen():this.onmessage&&this.onmessage({type:"open",header:e.header})})),this.socketTask.onError((e=>{this.errorHandler(e)})),this.socketTask.onClose((e=>{this.readyState=this.CLOSED;var{code:t,reason:r,wasClean:i}=e;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:i,type:"close"})})),this.socketTask.onMessage((e=>{this.onmessage&&this.onmessage({data:e.data})}))}close(){this.socketTask&&this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`tt-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("tt-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask&&this.socketTask.send({data:e})}errorHandler(e){Ha.error("tt-app::ws: onerror ",e),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg})}}function request(e,t){return t&&(t.header=t.headers,t.data=t.data||(null==t?void 0:t.params)||{}),new Promise(((r,i)=>{tt.request(Object.assign(Object.assign({url:e},t),{success:function(e){e={data:e.data,status:e.statusCode,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){e.code=21103===e.errNo?Ct.V2NIM_ERROR_CODE_TIMEOUT:e.errNo,e.message=e.errMsg,i(e)}}))}))}function uploadFile(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{var i=tt.uploadFile(Object.assign(Object.assign({url:`${e.commonUploadHost}/${e.nosToken.bucket}`},e.md5?{header:{"Content-MD5":e.md5}}:{}),{formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:e.filePath,success(i){if(200==i.statusCode)try{var n=JSON.parse(i.data);n.name=e.filePath,n.ext=n.name.lastIndexOf(".")>-1?n.name.slice(n.name.lastIndexOf(".")+1).toLowerCase():"",t(n)}catch(e){r(new Error(`Upload Error parse result error: ${i.data}`))}else r(new Error(`Upload error ${i.statusCode}: ${i.errMsg}`))},fail(e){e.code=21104===e.errNo?Ct.V2NIM_ERROR_CODE_CANCELLED:e.errNo,e.message=e.errMsg,r(e)}}));try{e.onUploadStart&&e.onUploadStart(i)}catch(e){Ha.error("uploadFile: options.onUploadStart error",e),i.abort(),r(e)}e.onUploadProgress&&i.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToSend,loaded:t.totalBytesSent,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))}function getFileUploadInformation(e){return null}function getSystemInfo(){var e=tt.getSystemInfoSync()||{};return{os:e.platform||"",osVer:e.system||"",browser:"",browserVer:"",libEnv:"MINIAPP",hostEnv:"Tiktok",hostEnvEnum:Wr.Tiktok,hostEnvVer:e.version,model:e.SDKVersion,manufactor:"Tiktok",userAgent:`Tiktok MiniApp: model/${e.model} system/${e.system}`,pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}var $a,Wa={WX:()=>({setLogger(e){Ba=e},platform:"WXAPP",localStorage:Fa,request:request$2,WebSocket:WebSocket$2,uploadFile:uploadFile$2,getFileUploadInformation:getFileUploadInformation$2,getSystemInfo:getSystemInfo$2,net:{__getEnv:()=>wx}}),ALI:()=>({setLogger(e){qa=e},platform:"ALIAPP",localStorage:xa,request:request$3,WebSocket:WebSocket$3,uploadFile:uploadFile$3,getSystemInfo:getSystemInfo$3,getFileUploadInformation:getFileUploadInformation$3,net:{__getEnv:()=>my}}),BAIDU:()=>({setLogger(e){Ga=e},platform:"BAIDUAPP",localStorage:ja,request:request$1,WebSocket:WebSocket$1,uploadFile:uploadFile$1,getFileUploadInformation:getFileUploadInformation$1,getSystemInfo:getSystemInfo$1,net:{__getEnv:()=>swan}}),TT:()=>({setLogger(e){Ha=e},platform:"TTAPP",localStorage:Ya,request:request,WebSocket:WebSocket,uploadFile:uploadFile,getSystemInfo:getSystemInfo,getFileUploadInformation:getFileUploadInformation,net:{__getEnv:()=>tt}})},za=sn({none:0,normal:1,all:3}),Ka={normal:0,advanced:1},Ja=sn(Ka),Qa=sn({normal:0,owner:1,manager:2}),Xa={noVerify:0,needVerify:1,rejectAll:2},Za=sn(Xa),es={needVerify:0,noVerify:1},ts=sn(es),rs={manager:0,all:1},is=sn(rs),ns={manager:0,all:1},as=sn(ns),ss={manager:0,all:1},os=sn(ss);function formatTeam(e){var t={type:Ja,muteType:za,joinMode:Za,beInviteMode:ts,inviteMode:is,updateTeamMode:as,updateExtMode:os},r=__rest(e,["bits"]);return["teamId"].forEach((e=>{r[e]&&(r[e]=r[e].toString())})),["level","memberNum","memberUpdateTime","createTime","updateTime"].forEach((e=>{void 0!==r[e]&&(r[e]=parseInt(r[e]))})),["valid","validToCurrentUser","mute"].forEach((e=>{void 0!==r[e]&&(r[e]=1===parseInt(r[e]))})),Object.keys(t).forEach((e=>{void 0!==r[e]&&(r[e]=t[e][r[e]]||r[e])})),r}function formatTeams(e){return e&&e.length>0?e.map((e=>formatTeam(e))):[]}function generateTeam(e){var t=Object.assign({},e),r={type:Ka,joinMode:Xa,beInviteMode:es,inviteMode:rs,updateTeamMode:ns,updateExtMode:ss};return["avatar","name","intro","announcement","ext"].forEach((e=>{void 0!==t[e]&&(t[e]=t[e].toString())})),Object.keys(r).forEach((e=>{void 0!==t[e]&&(t[e]=r[e][t[e]])})),t}function generatorTeamMemberForCmd(e){var t={};return void 0!==e.bitConfigMask&&(t.bits=parseInt(e.bitConfigMask)),["teamId","ext","account","nickInTeam"].forEach((r=>{e[r]&&(t[r]=e[r].toString())})),Object.prototype.hasOwnProperty.call(e,"nickInTeam")&&(t.nickInTeam=e.nickInTeam),t}function formatTeamMember(e){var t={type:Qa},{bits:r}=e,i=__rest(e,["bits"]);return void 0!==r&&(i.muteTeam=1===parseInt(r),i.bitConfigMask=r),i.id=`${i.teamId}-${i.account}`,["teamId"].forEach((e=>{i[e]&&(i[e]=i[e].toString())})),["joinTime","updateTime","bitConfigMask"].forEach((e=>{void 0!==i[e]&&(i[e]=parseInt(i[e]))})),["active","valid","mute"].forEach((e=>{void 0!==i[e]&&(i[e]=1===parseInt(i[e]))})),Object.keys(t).forEach((e=>{void 0!==i[e]&&(i[e]=t[e][i[e]]||i[e])})),i}function formatTeamMembers(e){return e&&e.length>0?e.map((e=>formatTeamMember(e))):[]}function generatorMemberByTeam(e,t,r="normal"){return{id:`${e.teamId}-${t}`,teamId:e.teamId,account:t,type:r,nickInTeam:"",muteTeam:!1,mute:!1,joinTime:e.memberUpdateTime,updateTime:e.memberUpdateTime,active:!0,valid:!0}}function generatorMembersByTeam(e,t,r="normal"){return t&&t.length>0?t.map((t=>generatorMemberByTeam(e,t,r))):[]}function formatUser(e){var t=Object.assign({},e);return t.createTime&&(t.createTime=+t.createTime),t.updateTime&&(t.updateTime=+t.updateTime),t.gender&&(t.gender=$a[+t.gender]),t}!function(e){e[e.unknown=0]="unknown",e[e.male=1]="male",e[e.female=2]="female"}($a||($a={}));var cs={"8_1":"createTeam","8_5":"addTeamMembers","8_6":"removeTeamMembers","8_7":"updateTeamInfo","8_8":"leaveTeam","8_9":"getTeamInfo","8_10":"getTeams","8_11":"getTeamMembers","8_12":"dismissTeam","8_13":"applyTeam","8_14":"passTeamApply","8_15":"rejectTeamApply","8_16":"addTeamManagers","8_17":"removeTeamManagers","8_18":"transferTeam","8_19":"updateMyMemberInfo","8_20":"updateNickInTeam","8_21":"acceptTeamInvite","8_22":"rejectTeamInvite","8_25":"muteTeamMember","8_27":"getMutedTeamMembers","8_28":"sendTeamMsgReceipt","8_29":"getTeamMsgReads","8_30":"getTeamMsgReadAccounts","8_31":"notifyTeamMsgReceipts","8_32":"muteTeam","8_33":"getTeamMemberInvitorAccid","8_34":"getTeamsById","8_101":"syncCreateTeam","8_109":"syncTeams","8_119":"syncUpdateTeamMember","8_126":"syncMyTeamMembers"},ds={team:{teamId:1,name:3,type:4,owner:5,level:6,selfCustom:7,valid:8,memberNum:9,memberUpdateTime:10,createTime:11,updateTime:12,validToCurrentUser:13,intro:14,announcement:15,joinMode:16,bits:17,ext:18,serverExt:19,avatar:20,beInviteMode:21,inviteMode:22,updateTeamMode:23,updateExtMode:24,mute:100,muteType:101},teamMsgReceiptTag:{teamId:0,idServer:1,read:100,unread:101,idClient:102,account:103},teamMember:{teamId:1,account:3,type:4,nickInTeam:5,bits:7,active:8,valid:9,joinTime:10,updateTime:11,ext:12,mute:13,invitorAccid:14}},ls=invertSerializeMap(ds),ms={getTeamInfo:{sid:8,cid:9,service:"team",params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:ls.team}]},getTeams:{sid:8,cid:10,service:"team",params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:ls.team},{type:"Long",name:"timetag"}],ignoreErrCodes:[803]},createTeam:{sid:8,cid:1,service:"team",params:[{type:"Property",name:"team",reflectMapper:ds.team},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:ls.team},{type:"StrArray",name:"abortedAccidList"}]},sendTeamMsgReceipt:{sid:8,cid:28,service:"team",params:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:ds.teamMsgReceiptTag}],response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:ls.teamMsgReceiptTag}]},getTeamMsgReads:{sid:8,cid:29,service:"team",params:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:ds.teamMsgReceiptTag}],response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:ls.teamMsgReceiptTag}]},getTeamMsgReadAccounts:{sid:8,cid:30,service:"team",params:[{type:"Property",name:"teamMsgReceiptTag",reflectMapper:ds.teamMsgReceiptTag}],response:[{type:"Property",name:"teamMsgReceipt",reflectMapper:ls.teamMsgReceiptTag},{type:"StrArray",name:"readAccounts"},{type:"StrArray",name:"unreadAccounts"}]},notifyTeamMsgReceipts:{sid:8,cid:31,service:"team",response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:ls.teamMsgReceiptTag}]},dismissTeam:{sid:8,cid:12,service:"team",params:[{type:"Long",name:"teamId"}]},leaveTeam:{sid:8,cid:8,service:"team",params:[{type:"Long",name:"teamId"}]},transferTeam:{sid:8,cid:18,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},updateTeamInfo:{sid:8,cid:7,service:"team",params:[{type:"Property",name:"team",reflectMapper:ds.team}],response:[{type:"Long",name:"id"},{type:"Long",name:"time"}]},getTeamsById:{sid:8,cid:34,service:"team",params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:ls.team},{type:"LongArray",name:"tids"}],ignoreErrCodes:[816]},getTeamMembers:{sid:8,cid:11,service:"team",params:[{type:"Long",name:"teamId"},{type:"Long",name:"timetag"}],response:[{type:"Long",name:"teamId"},{type:"PropertyArray",name:"teamMembers",reflectMapper:ls.teamMember},{type:"Long",name:"timetag"}]},getMutedTeamMembers:{sid:8,cid:27,service:"team",params:[{type:"Long",name:"teamId"}],response:[{type:"Long",name:"teamId"},{type:"PropertyArray",name:"teamMembers",reflectMapper:ls.teamMember}]},addTeamMembers:{sid:8,cid:5,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"},{type:"String",name:"attach"}],response:[{type:"Long",name:"time"},{type:"StrArray",name:"abortedAccidList"}]},removeTeamMembers:{sid:8,cid:6,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},applyTeam:{sid:8,cid:13,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:ls.team}]},addTeamManagers:{sid:8,cid:16,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},removeTeamManagers:{sid:8,cid:17,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},updateMyMemberInfo:{sid:8,cid:19,service:"team",params:[{type:"Property",name:"teamMember",reflectMapper:ds.teamMember}]},updateNickInTeam:{sid:8,cid:20,service:"team",params:[{type:"Property",name:"teamMember",reflectMapper:ds.teamMember}]},muteTeamMember:{sid:8,cid:25,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Int",name:"mute"}]},getTeamMemberInvitorAccid:{sid:8,cid:33,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"StrStrMap",name:"accountsMap"}]},muteTeam:{sid:8,cid:32,service:"team",params:[{type:"Long",name:"teamId"},{type:"Int",name:"mute"}]},passTeamApply:{sid:8,cid:14,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectTeamApply:{sid:8,cid:15,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},acceptTeamInvite:{sid:8,cid:21,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectTeamInvite:{sid:8,cid:22,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},syncTeams:{sid:8,cid:109,service:"team",response:[{type:"Long",name:"timetag"},{type:"PropertyArray",name:"teams",reflectMapper:ls.team}]},syncCreateTeam:{sid:8,cid:101,service:"team",response:[{type:"Property",name:"team",reflectMapper:ls.team}]},syncUpdateTeamMember:{sid:8,cid:119,service:"team",response:[{type:"Property",name:"teamMember",reflectMapper:ls.teamMember}]},syncMyTeamMembers:{sid:8,cid:126,ext:"sync",service:"team",response:[{type:"PropertyArray",name:"teamMembers",entity:"teamMember",reflectMapper:ls.teamMember},{type:"Long",name:"timetag"}]}},ps={"3_7":"getUsersNameCardFromServer","3_10":"updateMyNameCard","3_109":"syncMyNameCard","3_110":"onUpdateMyNameCard","3_3":"setBlack","3_103":"onUpdateBlackList","3_5":"setMute","3_105":"onUpdateMuteList","3_8":"syncRelations"},us={user:{account:1,nick:3,avatar:4,signature:5,gender:6,email:7,birth:8,tel:9,ext:10,createTime:12,updateTime:13},relationMember:{account:0,isMuted:1,isBlack:2,createTime:3,updateTime:4}},hs=invertSerializeMap(us),gs={syncMyNameCard:{sid:3,cid:109,service:"user",response:[{type:"Property",name:"user",reflectMapper:hs.user},{type:"Long",name:"timetag"}]},setBlack:{service:"user",sid:3,cid:3,params:[{type:"String",name:"account"},{type:"Bool",name:"isAdd"}]},onUpdateBlackList:{service:"user",sid:3,cid:103,response:[{type:"String",name:"account"},{type:"Bool",name:"isAdd"}]},setMute:{service:"user",sid:3,cid:5,params:[{type:"String",name:"account"},{type:"Bool",name:"isAdd"}]},onUpdateMuteList:{service:"user",sid:3,cid:105,response:[{type:"String",name:"account"},{type:"Bool",name:"isAdd"}]},syncRelations:{service:"user",sid:3,cid:8,params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"list",reflectMapper:hs.relationMember},{type:"Long",name:"timetag"}]},getUsersNameCardFromServer:{service:"user",sid:3,cid:7,params:[{type:"StrArray",name:"accounts"}],response:[{type:"PropertyArray",name:"users",reflectMapper:hs.user}]},updateMyNameCard:{service:"user",sid:3,cid:10,params:[{type:"Property",name:"user",reflectMapper:us.user}],response:[{type:"Long",name:"timetag"}]},onUpdateMyNameCard:{service:"user",sid:3,cid:110,response:[{type:"Property",name:"user",reflectMapper:hs.user}]}},vs={needPush:{type:"boolean",required:!1},needPushBadge:{type:"boolean",required:!1},needPushNick:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},needForcePush:{type:"boolean",required:!1},forcePushIDsList:{type:"string",allowEmpty:!1,required:!1},forcePushContent:{type:"string",allowEmpty:!1,required:!1}},ys={function:{type:"string",required:!1},topic:{type:"string",required:!1},customContent:{type:"string",required:!1},account:{type:"string",required:!1}},Is={subType:{type:"string"},setting:{resendFlag:{type:"boolean"},envConfig:{type:"string"},needSaveHistory:{type:"boolean"},needRoaming:{type:"boolean"},needOffline:{type:"boolean"},needSelfSync:{type:"boolean"},needRouted:{type:"boolean"},needUpdateSession:{type:"boolean"},isMuted:{type:"boolean"}},antiSpamInfo:{needAntiSpam:{type:"boolean"},antiSpamContent:{type:"string"},antiSpamBIZID:{type:"string"},clientAntispamHitting:{type:"boolean"},antiSpamUsingYidun:{type:"boolean"},yidunCallbackURL:{type:"string"},yidunAntiCheating:{type:"string"},yidunAntiSpamExtension:{type:"string"},yidunAntiSpamResult:{type:"string"}},pushInfo:vs,robotInfo:ys,teamSpecializationInfo:{needACK:{type:"boolean"},isACKSent:{type:"boolean"},ackSnapshot:{type:"number"}},threadMessageInfo:{replyMsgFromAccount:{type:"string"},replyMsgToAccount:{type:"string"},replyMsgTime:{type:"number"},replyMsgIdServer:{type:"string"},replyMsgIdClient:{type:"string"},threadMsgFromAccount:{type:"string"},threadMsgToAccount:{type:"string"},threadMsgTime:{type:"number"},threadMsgIdServer:{type:"string"},threadMsgIdClient:{type:"string"}}},_s={0:"addTeamMembers",1:"removeTeamMembers",2:"leaveTeam",3:"updateTeam",4:"dismissTeam",5:"passTeamApply",6:"transferTeam",7:"addTeamManagers",8:"removeTeamManagers",9:"acceptTeamInvite",10:"updateTeamMemberMute",101:"netcallMiss",102:"netcallBill",103:"netcallReject",401:"addSuperTeamMembers",402:"removeSuperTeamMembers",403:"leaveSuperTeam",404:"updateSuperTeam",405:"dismissSuperTeam",406:"transferSuperTeam",407:"addSuperTeamManagers",408:"removeSuperTeamManagers",409:"updateSuperTeamMembersMute",410:"passSuperTeamApply",411:"acceptSuperTeamInvite"};function getSessionId(e,t){return`${ni[e.scene]}-${e.to===t?e.from:e.to}`}function msgFlow(e,t){return e.from===t?e.to===t?"in":"out":"in"}function formatMsg$1(e,t){var{account:r,featureValue:i,statusValue:n,sessionAck:a,msgReceiptTime:s}=t,o=ni[e.scene],c=e.to===r?e.from:e.to,d=oi.default,l=si.unread;parseInt(e.isInBlackList)>0?(l=si.refused,delete e.isInBlackList):l=e.from===r?s&&s>=+e.time?si.receipt:si.sent:a&&a>=+e.time?si.read:si.unread;var m=Object.assign(Object.assign({},format(Is,e)),{scene:o,type:ii[e.type],fromClientType:ai[e.fromClientType],flow:msgFlow(e,r),target:c,to:e.to,from:e.from,time:e.time?+e.time:void 0,userUpdateTime:e.userUpdateTime?+e.userUpdateTime:void 0,idClient:e.idClient,sessionId:`${o}-${c}`,status:si[n||l],feature:oi[i||d]});if("string"==typeof m.attach)try{m.attach=JSON.parse(m.attach)}catch(e){}return"notification"===m.type&&(m.attach=m.attach?function formatNotificationAttach(e){var t={};if(t.type=_s[e.id]||e.id,!e.data)return t;var r={ids:"accounts",id:"account",attach:"custom",channel:"channelId",calltype:"netcallType",mute:"mute",duration:"duration",time:"time",from:"from",ext:"ext"},i=e.data;return Object.keys(r).forEach((e=>{void 0!==i[e]&&(t[r[e]]=i[e])})),i.tinfo&&(t.team=formatTeam(deserialize(i.tinfo,ls.team))),i.uinfos&&(t.users=i.uinfos.map((e=>formatUser(deserialize(e,hs.user))))),void 0!==i.mute&&(t.mute=1===parseInt(i.mute)),t}(m.attach):{}),m}function formatMsgs$1(e,t){return e&&e.length>0?removeDupMsgsByIdClient(e.map((e=>formatMsg$1(e,t)))):[]}function removeDupMsgsByIdClient(e){var t={};for(var r of e){var i=t[r.idClient];i&&i.time>r.time||(t[r.idClient]=r)}return Object.keys(t).map((e=>t[e]))}function processPushInfoInMsg(e,t=!0){var r=Object.assign({},e);if(r.pushInfo&&t){for(var i in r.pushInfo)"boolean"==typeof r.pushInfo[i]?r[i]=r.pushInfo[i]?1:0:r[i]=r.pushInfo[i];delete r.pushInfo}return r.scene===ni.team&&r.needForcePush&&(r.forcePushContent=r.forcePushContent||r.pushContent,r.forcePushIDsList=r.forcePushIDsList?r.forcePushIDsList:"#%@all@%#"),r}function generatorMsgForCmd$1(e,t,r,i){var{onSendBefore:n,onUploadStart:a,onUploadDone:s,replyMsg:o}=e,c=__rest(e,["onSendBefore","onUploadStart","onUploadDone","replyMsg"]),d=Object.assign(Object.assign({},formatReverse(Is,c)),{scene:ni[e.scene],type:ii[e.type],from:t,fromClientType:16,fromDeviceId:r,fromNick:null==i?void 0:i.nick,userUpdateTime:null==i?void 0:i.updateTime,status:si[si.sending]});if(d.idClient=d.resendFlag?e.idClient:Ii(),!d.idClient)throw new FormatError("idClient is required to resend a message","idClient","required");return d=processPushInfoInMsg(d,!1),o&&(d.replyMsgFromAccount=o.from,d.replyMsgToAccount=o.to,d.replyMsgTime=+o.time,d.replyMsgIdServer=o.idServer,d.replyMsgIdClient=o.idClient,d.threadMsgFromAccount=o.from,d.threadMsgToAccount=o.to,d.threadMsgTime=+o.time,d.threadMsgIdServer=o.idServer,d.threadMsgIdClient=o.idClient,o.threadMessageInfo&&o.threadMessageInfo.threadMsgIdServer&&(d.threadMsgFromAccount=o.threadMessageInfo.threadMsgFromAccount,d.threadMsgToAccount=o.threadMessageInfo.threadMsgToAccount,d.threadMsgTime=o.threadMessageInfo.threadMsgTime,d.threadMsgIdServer=o.threadMessageInfo.threadMsgIdServer,d.threadMsgIdClient=o.threadMessageInfo.threadMsgIdClient)),d}function formatDeletedMsgs(e,t){return e.map((e=>{var r;return r=t||(Number.isNaN(parseInt(e.scene))?e.scene:1===parseInt(e.scene)?"p2p":"team"),{deletedTime:parseInt(e.time),from:e.from,idClient:e.deletedIdClient||e.idClient,idServer:e.deletedIdServer||e.idServer,scene:r,time:parseInt(e.deletedMsgCreateTime),to:e.to,ext:"string"==typeof e.ext?e.ext:null}}))}var Ms=Array.prototype.reverse;var fs=function reverse(e){return null==e?e:Ms.call(e)};class ModuleService$2{constructor(e){this.core=e}processBroadcastMsg(e){var t=e.map((e=>Object.assign(Object.assign({},e),{time:parseInt(e.time)})));return this.core.sendCmd("batchMarkRead",{sid:7,cid:17,ids:t.map((e=>e.id))}),t}}var Ts,Es,Ss,Cs={needPush:{type:"boolean",required:!1},needPushBadge:{type:"boolean",required:!1},needPushNick:{type:"boolean",required:!1},pushContent:{type:"string",allowEmpty:!1,required:!1},pushPayload:{type:"string",allowEmpty:!1,required:!1}},Ns={pushContent:8,pushPayload:9,needPush:107,needPushBadge:109,needPushNick:110},As={"4_4":"syncOfflineMsgs","4_9":"syncRoamingMsgs","4_17":"syncRoamingMsgs","4_21":"syncDeleteSelfMsgs","7_1":"sendMsg","8_23":"getHistoryTeamMsgs","21_14":"getHistorySuperTeamMsgs","8_2":"sendTeamMsg","21_2":"sendSuperTeamMsg","7_11":"sendMsgReceipt","7_13":"recallMsg","7_24":"deleteSelfMsgs","21_17":"recallSuperTeamMsg","7_2":"onMsg","8_3":"onMsg","21_3":"onMsg","7_101":"onMsg","8_102":"onMsg","21_102":"onMsg","8_4":"nimOnTeamMsgs","4_16":"syncBroadcastMsg","7_17":"onBroadcastMsg","7_123":"onDeleteSelfMsg","7_124":"onDeleteSelfMsgs"},bs=Object.assign(Object.assign({scene:0,to:1,from:2,fromClientType:4,fromDeviceId:5,fromNick:6,time:7,type:8,body:9,attach:10,idClient:11,idServer:12,resendFlag:13,userUpdateTime:14,ext:15,needAntiSpam:21,antiSpamContent:22,antiSpamBIZID:23,clientAntispamHitting:24,antiSpamUsingYidun:25,needACK:26,yidunCallbackURL:27,needUpdateSession:28,replyMsgFromAccount:29,replyMsgToAccount:30,replyMsgTime:31,replyMsgIdServer:32,replyMsgIdClient:33,threadMsgFromAccount:34,threadMsgToAccount:35,threadMsgTime:36,threadMsgIdServer:37,threadMsgIdClient:38,isDeleted:39,callbackExt:40,subType:41,yidunAntiCheating:42,envConfig:43,yidunAntiSpamExtension:44,yidunAntiSpamResult:45,__clientExt:{id:46,converter:objectToJSONString,retConverter:stringToJSONObject},needSaveHistory:100,needRoaming:101,needSelfSync:102,isMuted:104,needRouted:105,isInBlackList:106,needOffline:108,isReplyMsg:111,ackSnapshot:112},{pushContent:17,pushPayload:16,forcePushIDsList:18,forcePushContent:19,needForcePush:20,needPush:107,needPushBadge:109,needPushNick:110}),{function:47,topic:48,customContent:49,account:50}),Rs={msg:bs,recallMsgTag:Object.assign({time:0,type:1,to:2,from:3,ps:4,attach:5,deletedIdClient:10,deletedIdServer:11,deleteMsgCreatetime:14,opeAccount:16,env:21},Ns),deleteSelfMsgTag:{scene:1,from:2,to:3,idServer:4,idClient:5,deletedMsgCreateTime:6,time:7,ext:8},msgReceiptTag:{to:1,from:2,time:7,idClient:11},broadcastMsg:{id:1,fromAccid:2,time:4,body:5}},Os=invertSerializeMap(Rs),Ps={sendMsg:{sid:7,cid:1,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:Rs.msg}],response:[{type:"Property",name:"msg",reflectMapper:Os.msg}],ignoreErrCodes:[7101]},sendTeamMsg:{sid:8,cid:2,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:Rs.msg}],response:[{type:"Property",name:"msg",reflectMapper:Os.msg}]},sendSuperTeamMsg:{sid:21,cid:2,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:Rs.msg}],response:[{type:"Property",name:"msg",reflectMapper:Os.msg}]},onMsg:{sid:7,cid:2,service:"msg",response:[{type:"Property",name:"msg",reflectMapper:Os.msg}]},nimOnTeamMsgs:{sid:8,cid:4,service:"msg",response:[{type:"PropertyArray",name:"datas",reflectMapper:Os.msg}]},getHistoryTeamMsgs:{sid:8,cid:23,service:"msg",params:[{type:"Long",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:Os.msg}]},getHistorySuperTeamMsgs:{sid:21,cid:14,params:[{type:"Long",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:Os.msg}],service:"msg"},recallMsg:{sid:7,cid:13,service:"msg",params:[{type:"Property",name:"recallMsgTag",reflectMapper:Rs.recallMsgTag}]},deleteSelfMsgs:{sid:7,cid:24,service:"msg",params:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:Rs.deleteSelfMsgTag}],response:[{type:"Long",name:"timetag"}]},recallSuperTeamMsg:{sid:21,cid:17,service:"msg",params:[{type:"Property",name:"recallMsgTag",reflectMapper:Rs.recallMsgTag}]},sendMsgReceipt:{sid:7,cid:11,service:"msg",params:[{type:"Property",name:"msgReceiptTag",reflectMapper:Rs.msgReceiptTag}],response:[{type:"Property",name:"msgReceiptTag",reflectMapper:Os.msgReceiptTag}]},batchMarkRead:{sid:4,cid:5,service:"msg",hasPacketResponse:!1,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]},syncMsgReceipts:{sid:4,cid:12,service:"msg",response:[{type:"PropertyArray",name:"msgReceipts",reflectMapper:Os.msgReceiptTag},{type:"Long",name:"timetag"}]},syncOfflineMsgs:{sid:4,cid:4,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:Os.msg}]},syncRoamingMsgs:{sid:4,cid:9,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:Os.msg}]},syncBroadcastMsg:{sid:4,cid:16,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:Os.broadcastMsg}]},onBroadcastMsg:{sid:7,cid:17,service:"msg",response:[{type:"Property",name:"msg",reflectMapper:Os.broadcastMsg}]},onDeleteSelfMsg:{sid:7,cid:123,service:"msg",response:[{type:"Property",name:"deletedMsg",reflectMapper:Os.deleteSelfMsgTag}]},onDeleteSelfMsgs:{sid:7,cid:124,service:"msg",response:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:Os.deleteSelfMsgTag}]},syncDeleteSelfMsgs:{sid:4,cid:21,service:"msg",response:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:Os.deleteSelfMsgTag}]}};!function(e){e[e.none=0]="none",e[e.pass=1]="pass",e[e.decline=2]="decline",e[e.read=3]="read",e[e.deleted=4]="deleted",e[e.invalid=5]="invalid"}(Ts||(Ts={})),function(e){e[e.default=0]="default",e[e.leave=1]="leave",e[e.roam=2]="roam"}(Es||(Es={})),function(e){e[e.applyTeam=0]="applyTeam",e[e.rejectTeamApply=1]="rejectTeamApply",e[e.teamInvite=2]="teamInvite",e[e.rejectTeamInvite=3]="rejectTeamInvite",e[e.friendRequest=5]="friendRequest",e[e.deleteFriend=6]="deleteFriend",e[e.recallMsgP2p=7]="recallMsgP2p",e[e.recallMsgTeam=8]="recallMsgTeam",e[e.recallMsgSuperTeam=12]="recallMsgSuperTeam",e[e.deleteMsgP2pOneWay=13]="deleteMsgP2pOneWay",e[e.deleteMsgTeamOneWay=14]="deleteMsgTeamOneWay",e[e.applySuperTeam=15]="applySuperTeam",e[e.rejectSuperTeamApply=16]="rejectSuperTeamApply",e[e.superTeamInvite=17]="superTeamInvite",e[e.rejectSuperTeamInvite=18]="rejectSuperTeamInvite",e[e.customP2p=100]="customP2p",e[e.customTeam=101]="customTeam",e[e.customSuperTeam=103]="customSuperTeam"}(Ss||(Ss={}));var Vs={1:"addFriend",2:"applyFriend",3:"passFriendApply",4:"rejectFriendApply"};var ks={setting:{needSaveOffline:{type:"boolean"},isRoutable:{type:"boolean"},envConfig:{type:"string"}},antiSpamInfo:{needAntiSpam:{type:"boolean"},antiSpamContent:{type:"boolean"}},pushInfo:Cs,recallMessageInfo:{idClient:{type:"string",rawKey:"deletedIdClient"},idServer:{type:"string",rawKey:"deletedIdServer"},createTime:{type:"number",rawKey:"deletedMsgCreateTime"},fromNick:{type:"string",rawKey:"deletedMsgFromNick"},opeAccount:{type:"string"}}};function formatSystemMessage(e,t,r){var i=+e.type,n=getEnumKeyByEnumValue(Ss,i);r=r||Es.default;var a=Object.assign(Object.assign({},format(ks,e)),{type:n,time:+e.time,to:e.to,from:e.from,idServer:e.idServer,state:Ts[Ts.none],feature:Es[r]});if("0"===a.idServer&&a.setting&&(a.setting.needSaveOffline=!1),"string"==typeof a.attach)try{a.attach=JSON.parse(a.attach)}catch(e){t.error(`formatSystemMessage: ${a.idServer} parse attach error`,e&&e.message)}return 5===i&&a.attach?(a.attach.type=Vs[+a.attach.vt],"passFriendApply"===a.attach.type?a.state=Ts[Ts.pass]:"rejectFriendApply"===a.attach.type&&(a.state=Ts[Ts.decline])):i<=3&&a.attach&&(a.attach=function formatTeamAttach(e){var{attach:t,tinfo:r}=e,i=__rest(e,["attach","tinfo"]);return i.ext=t,void 0!==r&&(i.team=formatTeam(deserialize(e.tinfo,ls.team))),i}(a.attach)),a}function generatorSysMsgForCmd$1(e){var t=Object.assign({},e);return Object.assign(Object.assign({},formatReverse(ks,t)),{type:Ss[t.type],to:t.to,attach:t.attach})}function getSceneFromRecallSysMsg(e){return e===Ss.recallMsgP2p?"p2p":e===Ss.recallMsgTeam?"team":e===Ss.recallMsgSuperTeam?"superTeam":""}var ws={"6_23":"getServerTime","6_31":"notifyDetect","6_32":"uploadDetect"},Ls={notifyDetectTag:{type:1,params:2,result:3,t1:100,t2:101,t3:102,t4:103,t5:104,t6:105}},Ds={getServerTime:{sid:6,cid:23,service:"misc",response:[{type:"Long",name:"time"}]},notifyDetect:{sid:6,cid:31,service:"misc",response:[{type:"Property",name:"data",reflectMapper:sn(Ls.notifyDetectTag)}]},uploadDetect:{sid:6,cid:32,service:"misc",hasPacketResponse:!1,params:[{type:"Property",name:"data",reflectMapper:Ls.notifyDetectTag}]}},Us={type:{type:"number"},t1:{type:"number"},t2:{type:"number"},t3:{type:"number"},t4:{type:"number"},t5:{type:"number"},t6:{type:"number"}};var qs=function baseSet(e,t,r,i){if(!E(e))return e;for(var n=-1,a=(t=Ee(t,e)).length,s=a-1,o=e;null!=o&&++n<a;){var c=Se(t[n]),d=r;if("__proto__"===c||"constructor"===c||"prototype"===c)return e;if(n!=s){var l=o[c];void 0===(d=i?i(l,c,o):void 0)&&(d=E(l)?l:Nr(t[n+1])?[]:{})}Tr(o,c,d),o=o[c]}return e};var xs=function basePickBy(e,t,r){for(var i=-1,n=t.length,a={};++i<n;){var s=t[i],o=Ce(e,s);r(o,s)&&qs(a,Ee(s,e),o)}return a};var Bs=function basePick(e,t){return xs(e,t,(function(t,r){return ca(e,r)}))},Fs=c?c.isConcatSpreadable:void 0;var Gs=function isFlattenable(e){return n(e)||rr(e)||!!(Fs&&e&&e[Fs])};var js=function baseFlatten(e,t,r,i,n){var a=-1,s=e.length;for(r||(r=Gs),n||(n=[]);++a<s;){var o=e[a];t>0&&r(o)?t>1?baseFlatten(o,t-1,r,i,n):Sn(n,o):i||(n[n.length]=o)}return n};var Hs=function flatten(e){return(null==e?0:e.length)?js(e,1):[]};var Ys=function flatRest(e){return Hr(xr(e,void 0,Hs),e+"")}((function(e,t){return null==e?{}:Bs(e,t)}));var $s=/\s/;var Ws=function trimmedEndIndex(e){for(var t=e.length;t--&&$s.test(e.charAt(t)););return t},zs=/^\s+/;var Ks=function baseTrim(e){return e?e.slice(0,Ws(e)+1).replace(zs,""):e},Js=/^[-+]0x[0-9a-f]+$/i,Qs=/^0b[01]+$/i,Xs=/^0o[0-7]+$/i,Zs=parseInt;var eo=function toNumber(e){if("number"==typeof e)return e;if(_(e))return NaN;if(E(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=E(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=Ks(e);var r=Qs.test(e);return r||Xs.test(e)?Zs(e.slice(2),r?2:8):Js.test(e)?NaN:+e},to=1/0;var ro=function toFinite(e){return e?(e=eo(e))===to||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};var io=function toInteger(e){var t=ro(e),r=t%1;return t==t?r?t-r:t:0},no=Math.max;var ao=function findIndex(e,t,r){var i=null==e?0:e.length;if(!i)return-1;var n=null==r?0:io(r);return n<0&&(n=no(i+n,0)),Ai(e,ua(t),n)},so={"4_12":"syncMsgReceipts","4_14":"syncSessionAck","4_20":"syncSuperTeamSessionAck","4_22":"nimSyncSessionsWithMoreRoaming","4_25":"syncSessionReliableInfo","7_12":"multiSyncMsgReceipt","7_16":"markSessionAck","7_25":"markMultSessionsAck","7_116":"syncMarkSessionAck","21_25":"markSuperTeamSessionAck","21_32":"markMultSuperTeamSessionsAck","21_125":"syncMarkSuperTeamSessionAck","4_23":"nimSyncStickTopSessions","23_12":"nimAddStickTopSession","23_13":"nimDeleteStickTopSession","23_14":"nimUpdateStickTopSession","23_112":"nimMultiSyncAddStickTopSession","23_113":"nimMultiSyncDeleteStickTopSession","23_114":"nimMultiSyncUpdateStickTopSession"},oo={msgReceiptTag:{to:1,from:2,time:7,idClient:11},stickTopSessionTag:{id:1,ext:2,createTime:3,updateTime:4},sessionAckTag:{scene:1,to:2,timetag:3},sessionReliableSyncTag:{scene:1,sessionId:2,syncStatus:3,syncEndMsgId:4,syncEndMsgidClient:5,syncEndMsgTime:6,syncStartMsgid:7,syncStartMsgidClient:8,syncStartMsgTime:9,nextMsgid:10,nextMsgidClient:11,nextMsgTime:12,roamMsgSync:13,offlineMsgSync:14,netCallOfflineMsgSync:15}},co=invertSerializeMap(oo),lo={syncMsgReceipts:{sid:4,cid:12,service:"session",response:[{type:"PropertyArray",name:"msgReceipts",reflectMapper:co.msgReceiptTag},{type:"Long",name:"timetag"}]},syncSessionAck:{sid:4,cid:14,service:"session",response:[{type:"StrLongMap",name:"p2p"},{type:"LongLongMap",name:"team"},{type:"Long",name:"timetag"}]},syncSuperTeamSessionAck:{sid:4,cid:20,service:"session",response:[{type:"LongLongMap",name:"superTeam"},{type:"Long",name:"timetag"}]},multiSyncMsgReceipt:{sid:7,cid:12,service:"session",response:[{type:"Property",name:"msgReceiptTag",reflectMapper:co.msgReceiptTag}]},markSessionAck:{sid:7,cid:16,service:"session",params:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},syncMarkSessionAck:{sid:7,cid:116,service:"session",response:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},syncMarkSuperTeamSessionAck:{sid:21,cid:125,service:"session",response:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]},markMultSessionsAck:{sid:7,cid:25,service:"session",ignoreErrCodes:[700],params:[{type:"PropertyArray",name:"datas",reflectMapper:oo.sessionAckTag}]},markSuperTeamSessionAck:{sid:21,cid:25,service:"session",params:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]},nimAddStickTopSession:{sid:23,cid:12,service:"session",params:[{type:"Property",name:"tag",reflectMapper:oo.stickTopSessionTag}],response:[{type:"Property",name:"data",reflectMapper:co.stickTopSessionTag}]},nimDeleteStickTopSession:{sid:23,cid:13,service:"session",params:[{type:"Property",name:"tag",reflectMapper:oo.stickTopSessionTag}],response:[{type:"Long",name:"timetag"}]},nimUpdateStickTopSession:{sid:23,cid:14,service:"session",params:[{type:"Property",name:"tag",reflectMapper:oo.stickTopSessionTag}],response:[{type:"Property",name:"data",reflectMapper:co.stickTopSessionTag}]},nimMultiSyncAddStickTopSession:{sid:23,cid:112,service:"session",response:[{type:"Property",name:"data",reflectMapper:co.stickTopSessionTag}]},nimMultiSyncDeleteStickTopSession:{sid:23,cid:113,service:"session",response:[{type:"Long",name:"timetag"},{type:"Property",name:"data",reflectMapper:co.stickTopSessionTag}]},nimMultiSyncUpdateStickTopSession:{sid:23,cid:114,service:"session",response:[{type:"Property",name:"data",reflectMapper:co.stickTopSessionTag}]},nimSyncStickTopSessions:{sid:4,cid:23,service:"session",response:[{type:"Long",name:"timetag"},{type:"Bool",name:"isThereAnyChange"},{type:"PropertyArray",name:"datas",reflectMapper:co.stickTopSessionTag}]},markMultSuperTeamSessionsAck:{sid:21,cid:32,service:"session",ignoreErrCodes:[700],params:[{type:"PropertyArray",name:"datas",reflectMapper:oo.sessionAckTag}]},nimSyncSessionsWithMoreRoaming:{sid:4,cid:22,service:"session",response:[{type:"PropertyArray",name:"datas",reflectMapper:{0:"scene",1:"to",2:"from",7:"time",12:"idServer"}}]},syncSessionReliableInfo:{sid:4,cid:25,service:"session",response:[{type:"Property",name:"context",reflectMapper:{1:"timetag",2:"type"}},{type:"PropertyArray",name:"datas",reflectMapper:co.sessionReliableSyncTag}]}},mo={id:{type:"string"},ext:{type:"string"},createTime:{type:"number"},updateTime:{type:"number"}};function formatStickTop(e,t,r=!0){var i=format(mo,e);i.isStickOnTop=r,i.id=t.id,r||(i.ext="");var n=Object.assign(Object.assign({},t),{stickTopInfo:t.stickTopInfo?Object.assign({},t.stickTopInfo,i):i});return void 0===n.lastMsg&&(n.lastMsg=null),n}class StickTopService{constructor(e){this.core=e}getSession(e){return this.core.session.getSessionWithUncomplete({id:e})||this.core.session.createSession(e)}addStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e);var{scene:t,accid:r}=getAccountFromSessionId(e.id),i=yield this.core.sendCmd("nimAddStickTopSession",{tag:{id:`${"superTeam"===t?"super_team":t}|${r}`,ext:e.ext||""}}),n=this.getSession(e.id);return formatStickTop(i.content.data,n)}))}deleteStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1}},e);var{scene:t,accid:r}=getAccountFromSessionId(e.id),i=yield this.core.sendCmd("nimDeleteStickTopSession",{tag:{id:`${"superTeam"===t?"super_team":t}|${r}`}}),n=this.getSession(e.id);return formatStickTop({updateTime:i.content.timetag,ext:""},n,!1)}))}updateStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e);var{scene:t,accid:r}=getAccountFromSessionId(e.id),i=yield this.core.sendCmd("nimUpdateStickTopSession",{tag:{id:`${"superTeam"===t?"super_team":t}|${r}`,ext:e.ext||""}}),n=this.getSession(e.id);return formatStickTop(i.content.data,n)}))}stickTopSessionHandler(e,t=!0){var{scene:r,accid:i}=getAccountFromSessionId(e.id,"|"),n=`${r}-${i}`;return formatStickTop(e,this.getSession(n),t)}}class UnreadModuleService{constructor(e){this.core=e,this.logger=e.logger}canSessionResetUnreadCount(e){var t=e.id;if(void 0===e.lastMsg)throw new Error(`Session::canSessionResetUnreadCount: session ${t} is not completly, lastMsg undefined`);return null!==e.lastMsg||e.unread>0?!(e.ack&&e.lastMsg&&e.ack>=e.lastMsg.time)||(this.logger.log(`Session::canSessionResetUnreadCount: session ${t} reset failed, ack time is greater than last message time`),!1):(this.logger.log(`Session::canSessionResetUnreadCount: session ${t} doesn't need to be updated, lastMsg null and unread 0`),!1)}filterSessionForResetUnreadCount(e){var t={cmd:"markMultSuperTeamSessionsAck",params:[]},r={cmd:"markMultSessionsAck",params:[]};return e.forEach((e=>{var i;try{if(!this.canSessionResetUnreadCount(e))return;var{accid:n,scene:a}=getAccountFromSessionId(e.id),s={to:n,sessionId:e.id,timetag:(null===(i=null==e?void 0:e.lastMsg)||void 0===i?void 0:i.time)||e.updateTime||0},o=function generateSceneForCmd(e){return formatReverse({scene:{type:"enum",values:ni}},e)}({scene:a});"superTeam"===a?t.params.push(s):r.params.push(Object.assign(Object.assign({},s),o))}catch(e){this.logger.warn(e)}})),{superTeam:t,p2pOrTeam:r}}}var po=Math.ceil,uo=Math.max;var ho=function chunk(e,t,r){t=(r?$r(e,t,r):void 0===t)?1:uo(io(t),0);var i=null==e?0:e.length;if(!i||t<1)return[];for(var n=0,a=0,s=Array(po(i/t));n<i;)s[a++]=ga(e,n,n+=t);return s};class ModuleService$1{constructor(e){this.core=e}notifyAddTeamMembers(e,t){this.core.emit("addTeamMembers",{team:e,accounts:t,members:generatorMembersByTeam(e,t)})}notifyUpdateTeamManagers(e,t,r,i){this.core.emit("updateTeamManagers",{team:{teamId:e,memberUpdateTime:i},accounts:t,isManager:r,members:t.map((t=>({id:`${e}-${t}`,account:t,type:r?"manager":"normal",updateTime:i})))})}notifyRemoveTeamMembers(e,t){this.core.emit("removeTeamMembers",{team:e,accounts:t})}notifyTransferTeam(e,t,r){this.core.emit("transferTeam",{team:e,from:{id:`${e.teamId}-${t}`,type:"normal",account:t,updateTime:e.memberUpdateTime},to:{id:`${e.teamId}-${r}`,type:"owner",account:r,updateTime:e.memberUpdateTime}})}notifyUpdateTeamMembersMute(e,t,r){this.core.emit("updateTeamMembersMute",{team:e,accounts:t,members:t.map((function(t){return{id:`${e.teamId}-${t}`,account:t,teamId:e.teamId,mute:r,updateTime:e.memberUpdateTime}})),mute:r})}}var go=function arrayEach(e,t){for(var r=-1,i=null==e?0:e.length;++r<i&&!1!==t(e[r],r,e););return e};var vo=function baseAssign(e,t){return e&&Er(t,vi(t),e)};var yo=function baseAssignIn(e,t){return e&&Er(t,Vr(t),e)};var Io=function copySymbols(e,t){return Er(e,On(e),t)},_o=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)Sn(t,On(e)),e=Wt(e);return t}:An;var Mo=function copySymbolsIn(e,t){return Er(e,_o(e),t)};var fo=function getAllKeysIn(e){return Cn(e,Vr,_o)},To=Object.prototype.hasOwnProperty;var Eo=function initCloneArray(e){var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&To.call(e,"index")&&(r.index=e.index,r.input=e.input),r};var So=function cloneDataView(e,t){var r=t?Ft(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)},Co=/\w*$/;var No=function cloneRegExp(e){var t=new e.constructor(e.source,Co.exec(e));return t.lastIndex=e.lastIndex,t},Ao=c?c.prototype:void 0,bo=Ao?Ao.valueOf:void 0;var Ro=function cloneSymbol(e){return bo?Object(bo.call(e)):{}};var Oo=function initCloneByTag(e,t,r){var i=e.constructor;switch(t){case"[object ArrayBuffer]":return Ft(e);case"[object Boolean]":case"[object Date]":return new i(+e);case"[object DataView]":return So(e,r);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return Gt(e,r);case"[object Map]":case"[object Set]":return new i;case"[object Number]":case"[object String]":return new i(e);case"[object RegExp]":return No(e);case"[object Symbol]":return Ro(e)}};var Po=function baseIsMap(e){return I(e)&&"[object Map]"==zn(e)},Vo=yr&&yr.isMap,ko=Vo?vr(Vo):Po;var wo=function baseIsSet(e){return I(e)&&"[object Set]"==zn(e)},Lo=yr&&yr.isSet,Do=Lo?vr(Lo):wo,Uo="[object Arguments]",qo="[object Function]",xo="[object Object]",Bo={};Bo[Uo]=Bo["[object Array]"]=Bo["[object ArrayBuffer]"]=Bo["[object DataView]"]=Bo["[object Boolean]"]=Bo["[object Date]"]=Bo["[object Float32Array]"]=Bo["[object Float64Array]"]=Bo["[object Int8Array]"]=Bo["[object Int16Array]"]=Bo["[object Int32Array]"]=Bo["[object Map]"]=Bo["[object Number]"]=Bo[xo]=Bo["[object RegExp]"]=Bo["[object Set]"]=Bo["[object String]"]=Bo["[object Symbol]"]=Bo["[object Uint8Array]"]=Bo["[object Uint8ClampedArray]"]=Bo["[object Uint16Array]"]=Bo["[object Uint32Array]"]=!0,Bo["[object Error]"]=Bo[qo]=Bo["[object WeakMap]"]=!1;var Fo=function baseClone(e,t,r,i,a,s){var o,c=1&t,d=2&t,l=4&t;if(r&&(o=a?r(e,i,a,s):r(e)),void 0!==o)return o;if(!E(e))return e;var m=n(e);if(m){if(o=Eo(e),!c)return jt(e,o)}else{var p=zn(e),u=p==qo||"[object GeneratorFunction]"==p;if(or(e))return xt(e,c);if(p==xo||p==Uo||u&&!a){if(o=d||u?{}:Jt(e),!c)return d?Mo(e,yo(o,e)):Io(e,vo(o,e))}else{if(!Bo[p])return a?e:{};o=Oo(e,p,c)}}s||(s=new wt);var h=s.get(e);if(h)return h;s.set(e,o),Do(e)?e.forEach((function(i){o.add(baseClone(i,t,r,i,e,s))})):ko(e)&&e.forEach((function(i,n){o.set(n,baseClone(i,t,r,n,e,s))}));var g=m?void 0:(l?d?fo:Pn:d?Vr:vi)(e);return go(g||e,(function(i,n){g&&(i=e[n=i]),Tr(o,n,baseClone(i,t,r,n,e,s))})),o};var Go=function cloneDeep(e){return Fo(e,5)};var jo={"4_6":"syncOfflineSysMsgs","4_18":"syncOfflineSysMsgs","4_19":"syncRecallMsgOfflineAndRoaming","4_101":"syncOfflineSysMsgs","7_3":"onSysMsg","7_7":"sendCustomSysMsg","7_14":"onRecallMsg","21_18":"onRecallMsg","21_117":"onRecallMsg","7_15":"syncRecallMsgOfflineAndRoaming","21_19":"onSysMsg","21_16":"sendSuperTeamCustomSysMsg","101_3":"onSysMsg","101_7":"sendFilterCustomSysMsg"},Ho={sysMsg:Object.assign({time:0,type:1,to:2,from:3,content:4,attach:5,idServer:6,needSaveOffline:7,deletedIdClient:10,deletedIdServer:11,needcAntiSpam:12,antiSpamContent:13,deletedMsgCreateTime:14,deletedMsgFromNick:15,opeAccount:16,envConfig:21,callbackExt:22,isRoutable:105},Ns)},Yo=invertSerializeMap(Ho),$o={onSysMsg:{service:"systemMessage",sid:7,cid:3,response:[{type:"Property",name:"sysMsg",reflectMapper:Yo.sysMsg}]},sendCustomSysMsg:{service:"systemMessage",sid:7,cid:7,params:[{type:"Property",name:"sysMsg",reflectMapper:Ho.sysMsg}]},sendSuperTeamCustomSysMsg:{service:"systemMessage",sid:21,cid:16,params:[{type:"Property",name:"sysMsg",reflectMapper:Ho.sysMsg}]},sendFilterCustomSysMsg:{service:"systemMessage",sid:101,cid:7,params:[{type:"Property",name:"sysMsg",reflectMapper:Ho.sysMsg}]},batchMarkRead:{service:"systemMessage",sid:4,cid:5,hasPacketResponse:!1,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]},onRecallMsg:{sid:7,cid:14,service:"systemMessage",response:[{type:"Property",name:"sysMsg",reflectMapper:Yo.sysMsg}]},syncRecallMsgOfflineAndRoaming:{sid:7,cid:15,service:"systemMessage",response:[{type:"PropertyArray",name:"sysMsgs",reflectMapper:Yo.sysMsg},{type:"Long",name:"timetag"},{type:"Byte",name:"type"}]},syncOfflineSysMsgs:{sid:4,cid:9,service:"systemMessage",response:[{type:"PropertyArray",name:"sysMsgs",reflectMapper:Yo.sysMsg}]}};function reverseFriend(e){var t=Object.assign({},e);return["bitsExtension","createTime","updateTime","passRelationShip","relationShip","source"].forEach((e=>{void 0!==t[e]&&(t[e]=parseInt(t[e]))})),void 0!==t.relationShip&&(t.valid=1===t.relationShip),t}var Wo={1:"addFriend",2:"applyFriend",3:"passFriendApply",4:"rejectFriendApply"};var zo={"12_4":"getFriends","12_1":"friendReuqest","12_2":"deleteFriend","12_3":"updateFriend","12_5":"syncFriends","12_6":"syncFriendUsers","12_101":"syncFriendRequest","12_102":"syncDeleteFriend","12_103":"syncUpdateFriend"},Ko={updateFriendTag:{account:4,alias:8,ext:10},delFriendParams:{delAlias:1},friendTag:{account:4,relationShip:5,passRelationShip:6,source:7,alias:8,bitsExtension:9,ext:10,createTime:11,updateTime:12,serverex:13},userTag:{account:1,nick:3,avatar:4,sign:5,gender:6,email:7,birth:8,tel:9,ext:10,createTime:12,updateTime:13}},Jo=invertSerializeMap(Ko),Qo={getFriends:{sid:12,cid:4,service:"friend",params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"friends",reflectMapper:Jo.friendTag},{type:"Long",name:"timetag"}]},friendReuqest:{sid:12,cid:1,service:"friend",params:[{type:"String",name:"account"},{type:"Byte",name:"type"},{type:"String",name:"ps"}]},deleteFriend:{sid:12,cid:2,service:"friend",params:[{type:"String",name:"account"},{type:"Property",name:"delFriendParams",reflectMapper:Ko.delFriendParams}]},updateFriend:{sid:12,cid:3,service:"friend",params:[{type:"Property",name:"updateFriendTag",reflectMapper:Ko.updateFriendTag}]},syncFriends:{sid:12,cid:5,service:"friend",response:[{type:"PropertyArray",name:"friends",entity:"friendTag",reflectMapper:Jo.friendTag},{type:"Long",name:"timetag"}]},syncFriendUsers:{sid:12,cid:6,service:"friend",response:[{type:"PropertyArray",name:"users",entity:"userTag",reflectMapper:Jo.userTag},{type:"Long",name:"timetag"}]},syncFriendRequest:{sid:12,cid:101,service:"friend",params:[{type:"String",name:"account"},{type:"Byte",name:"type"},{type:"String",name:"ps"}],response:[{type:"String",name:"account"},{type:"Byte",name:"type"},{type:"String",name:"ps"}]},syncDeleteFriend:{sid:12,cid:102,service:"friend",response:[{type:"String",name:"account"}]},syncUpdateFriend:{sid:12,cid:103,service:"friend",response:[{type:"Property",name:"friend",reflectMapper:Jo.friendTag}]}};function formatSubscribes(e){return e&&e.length>0?e.map((e=>function formatSubscribe(e){var t=Object.assign({},e);return["subscribeTime","time"].forEach((e=>{t[e]&&(t[e]=parseInt(t[e]))})),t}(e))):[]}function formatEvent(e){if(!e)return e;var{serverExt:t}=e,r=__rest(e,["serverExt"]);if(["time","type","value"].forEach((e=>{r[e]&&(r[e]=parseInt(r[e]))})),r.clientType&&(r.clientType=getEnumKeyByEnumValue(ai,r.clientType)||""),t)try{r.ext=JSON.parse(t),"string"==typeof r.ext[0]&&(r.ext=r.ext[0])}catch(e){}return r}var Xo={"14_1":"publishEvent","14_2":"pushEvent","14_3":"subscribeEvent","14_4":"unSubscribeEventsByAccounts","14_5":"unSubscribeEventsByType","14_6":"querySubscribeEventsByAccounts","14_7":"querySubscribeEventsByType","14_9":"pushEvents"},Zo={msgEvent:{type:1,value:2,idClient:3,ext:4,validTime:5,broadcastType:6,sync:7,validTimeType:8,durable:9,time:10,idServer:11,clientType:12,serverConfig:13,serverExt:14,appid:101,account:103,enableMultiClient:104,consid:106},msgEventSubscribe:{type:1,subscribeTime:2,sync:3,to:102,from:104,time:105}},ec=invertSerializeMap(Zo),tc={publishEvent:{sid:14,cid:1,service:"event",params:[{type:"Property",name:"msgEvent",reflectMapper:Zo.msgEvent}],response:[{type:"Property",name:"msgEvent",reflectMapper:ec.msgEvent}]},pushEvent:{sid:14,cid:2,service:"event",response:[{type:"Property",name:"msgEvent",reflectMapper:ec.msgEvent}]},subscribeEvent:{sid:14,cid:3,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:Zo.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"StrArray",name:"accounts"}]},unSubscribeEventsByAccounts:{sid:14,cid:4,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:Zo.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"StrArray",name:"accounts"}]},unSubscribeEventsByType:{sid:14,cid:5,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:Zo.msgEventSubscribe}]},querySubscribeEventsByAccounts:{sid:14,cid:6,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:Zo.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"PropertyArray",name:"msgEventSubscribes",reflectMapper:ec.msgEventSubscribe}]},querySubscribeEventsByType:{sid:14,cid:7,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:Zo.msgEventSubscribe}],response:[{type:"PropertyArray",name:"msgEventSubscribes",reflectMapper:ec.msgEventSubscribe}]},pushEvents:{sid:14,cid:9,service:"event",response:[{type:"PropertyArray",name:"msgEvents",reflectMapper:ec.msgEvent}]}};var rc,ic={"23_1":"getThreadMsgs","23_2":"getMsgsByIdServer"},nc={msg:bs,threadMsgReq:{beginTime:1,endTime:2,lastMsgId:3,limit:4,reverse:5},threadMsgsMeta:{total:1,lastMsgTime:2}},ac=invertSerializeMap(nc),sc={getThreadMsgs:{sid:23,cid:1,service:"msgExtend",params:[{type:"Property",name:"msg",reflectMapper:nc.msg},{type:"Property",name:"threadMsgReq",reflectMapper:nc.threadMsgReq}],response:[{type:"Property",name:"threadMsg",reflectMapper:ac.msg},{type:"Property",name:"threadMsgsMeta",reflectMapper:ac.threadMsgsMeta},{type:"PropertyArray",name:"msgs",reflectMapper:ac.msg}]},getMsgsByIdServer:{sid:23,cid:2,service:"msgExtend",params:[{type:"PropertyArray",name:"reqMsgs",reflectMapper:nc.msg}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:ac.msg}]}};!function(e){e[e.ASC=1]="ASC",e[e.DESC=2]="DESC"}(rc||(rc={}));var oc,cc={"7_6":"getHistoryMsgs","7_9":"deleteRoamingMsgs","4_24":"syncClearServerHistoryMsgs","7_18":"clearHistoryMsgsFromServer","7_118":"multiSyncClearServerHistoryMsgs","7_26":"nimFtsCloudMsgLogsAggWithSession","7_27":"nimFtsCloudMsgLogs"},dc={msg:bs,clearHistoryMsgsFromServerReqTag:{type:0,otherAccid:1,isDeleteRoam:2,toTid:3,isSyncSelf:4,time:6,ext:7},clearMsgsParamsWithSync:{type:0,otherAccid:1,isDeleteRoam:2,toTid:3,isSyncSelf:4,fromAccid:5,time:6,ext:7},ftsReqTag:{keyword:1,fromTime:2,toTime:3,sessionLimit:4,msglogsLimit:5,orderRule:6,p2pSessionList:7,teamSessionList:8,senderList:9,msgTypeList:10,msgSubTypeList:11}},lc=invertSerializeMap(dc),mc={deleteRoamingMsgs:{sid:7,cid:9,service:"msgLog",params:[{type:"StrArray",name:"ids"}]},getHistoryMsgs:{sid:7,cid:6,params:[{type:"String",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:lc.msg}],service:"msgLog"},clearHistoryMsgsFromServer:{sid:7,cid:18,params:[{type:"Property",name:"clearHistoryMsgsFromServerReqTag",reflectMapper:dc.clearHistoryMsgsFromServerReqTag}],response:[{type:"Long",name:"timetag"}],service:"msgLog"},multiSyncClearServerHistoryMsgs:{sid:7,cid:118,response:[{type:"Property",name:"data",reflectMapper:lc.clearMsgsParamsWithSync}],service:"msgLog"},syncClearServerHistoryMsgs:{sid:4,cid:24,service:"msgLog",response:[{type:"PropertyArray",name:"datas",reflectMapper:lc.clearMsgsParamsWithSync}]},nimFtsCloudMsgLogsAggWithSession:{sid:7,cid:26,service:"msgLog",params:[{type:"Property",name:"tag",reflectMapper:dc.ftsReqTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:lc.msg}]},nimFtsCloudMsgLogs:{sid:7,cid:27,service:"msgLog",params:[{type:"Property",name:"tag",reflectMapper:dc.ftsReqTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:lc.msg}]}};!function(e){e[e.p2p=1]="p2p",e[e.team=2]="team"}(oc||(oc={}));var pc={type:{type:"enum",values:oc},isDeleteRoam:{type:"boolean"},isSyncSelf:{type:"boolean"},time:{type:"number"}};function formatClearResult(e){var t=format(pc,e);return{sessionId:"p2p"===t.type?`p2p-${t.otherAccid}`:`team-${t.toTid}`,time:t.time}}var uc={orderRule:{type:"enum",values:rc}};var hc={"22_1":"requestProxy","22_2":"onRequestProxy"},gc={requestProxyTag:{zone:1,path:2,method:3,header:4,body:5},requestProxyMsgTag:{from:1,body:2,time:3}},vc=invertSerializeMap(gc),yc={requestProxy:{sid:22,cid:1,service:"passThrough",params:[{type:"Property",name:"requestProxyTag",reflectMapper:gc.requestProxyTag}],response:[{type:"Property",name:"requestProxyTag",reflectMapper:vc.requestProxyTag}]},onRequestProxy:{sid:22,cid:2,service:"passThrough",response:[{type:"Property",name:"proxyMsg",reflectMapper:vc.requestProxyMsgTag}]}};var Ic,_c,Mc={file:{md5:"$(Etag)",size:"$(ObjectSize)"},image:{md5:"$(Etag)",size:"$(ObjectSize)",w:"$(ImageInfo.Width)",h:"$(ImageInfo.Height)",orientation:"$(ImageInfo.Orientation)"},audio:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Audio.Duration)"},video:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Video.Duration)",w:"$(AVinfo.Video.Width)",h:"$(AVinfo.Video.Height)"}},fc={accessKeyId:"",secretAccessKey:"",sessionToken:"",region:"",maxRetries:0,bucket:"",objectName:"",token:"",shortUrl:""};function getUploadResponseFormat(e="file"){var t=Mc[e]||{};return JSON.stringify(t).replace(/"/gi,'\\"')}!function(e){e[e.nos=1]="nos",e[e.s3=2]="s3"}(Ic||(Ic={})),function(e){e[e.dontNeed=-1]="dontNeed",e[e.time=2]="time",e[e.urls=3]="urls"}(_c||(_c={}));var Tc={chunkUploadHost:"https://wannos-web.127.net",commonUploadHost:"https://fileup.chatnos.com",commonUploadHostBackupList:["https://oss.chatnos.com"],chunkMaxSize:4194304e4,commonMaxSize:104857600,uploadReplaceFormat:"https://{host}/{object}",cdn:{defaultCdnDomain:"nim-nosdn.netease.im",cdnDomain:"",bucket:"",objectNamePrefix:""},downloadUrl:"https://{bucket}-nosdn.netease.im/{object}",downloadHostList:["nos.netease.com"],nosCdnEnable:!0,isNeedToGetUploadPolicyFromServer:!0};var Ec=function pickBy(e,t){if(null==e)return{};var r=Ie(fo(e),(function(e){return[e]}));return t=ua(t),xs(e,r,(function(e,r){return t(e,r[0])}))};class NOS{constructor(e,t){this.nosCdnHostTimer=0,this.nosErrorCount=0,this.core=e,this.cloudStorage=t}get config(){return this.cloudStorage.config}reset(){this.nosErrorCount=0}getNosAccessToken(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.sendCmd("getNosAccessToken",{tag:e}),r=Ne(t,"content.nosAccessTokenTag.token"),i=e.url;return{token:r,url:-1!==i.indexOf("?")?i+"&token="+r:i+"?token="+r}}))}deleteNosAccessToken(e){return __awaiter(this,void 0,void 0,(function*(){yield this.core.sendCmd("deleteNosAccessToken",{tag:e})}))}nosUpload(e,t){var r,i,n,a,s,o,c,d;return __awaiter(this,void 0,void 0,(function*(){var l=Ne(this.core,"config.cdn.bucket"),m={tag:e.nosScenes||l||"nim"};e.nosSurvivalTime&&(m.expireSec=e.nosSurvivalTime);var p,u=this.core.adapters.getFileUploadInformation(e);if(!t&&!u)try{p=yield this.core.sendCmd("getNosToken",{responseBody:getUploadResponseFormat(e.type),nosToken:m})}catch(e){if(this.core.logger.error("uploadFile:: getNosToken error",e),e instanceof V2NIMErrorImpl)throw e;throw new UploadError({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"getNosToken error",rawError:e,curProvider:1}})}var h=this.config.uploadReplaceFormat.replace("{host}",this.config.cdn.cdnDomain||this.config.cdn.defaultCdnDomain).replace("{object}",u?null===(r=u.uploadInfo)||void 0===r?void 0:r.objectName:t?null==t?void 0:t.objectName:p.content.nosToken.objectName),g="";t&&t.shortUrl&&(g=t.shortUrl),(null===(a=null===(n=null===(i=null==u?void 0:u.uploadInfo)||void 0===i?void 0:i.payload)||void 0===n?void 0:n.mixStoreToken)||void 0===a?void 0:a.shortUrl)&&(g=u.uploadInfo.payload.mixStoreToken.shortUrl);var v,y=g||h;try{var I=u?{token:null===(s=null==u?void 0:u.uploadInfo)||void 0===s?void 0:s.token,bucket:null===(o=null==u?void 0:u.uploadInfo)||void 0===o?void 0:o.bucketName,objectName:null===(c=null==u?void 0:u.uploadInfo)||void 0===c?void 0:c.objectName}:t||p.content.nosToken;this.core.logger.debug("uploadFile:: uploadFile params",{nosToken:I,chunkUploadHost:this.config.chunkUploadHost,commonUploadHost:this.config.commonUploadHost,commonUploadHostBackupList:this.config.commonUploadHostBackupList,platform:Xr.platform});var _="BROWSER"===Xr.platform?this.config.chunkUploadHost:`${this.config.commonUploadHost}/${I&&I.bucket}`;this.core.reporterHookCloudStorage.update({remote_addr:_,operation_type:t?2:0}),v=yield this.core.adapters.uploadFile(Object.assign(Object.assign(Object.assign({},e),{nosToken:I,chunkUploadHost:this.config.chunkUploadHost,commonUploadHost:this.config.commonUploadHost,commonUploadHostBackupList:this.config.commonUploadHostBackupList,maxSize:e.maxSize||this.config.chunkMaxSize}),t?{payload:{mixStoreToken:t}}:{}))}catch(r){this.core.logger.error("uploadFile::nos uploadFile error:",r);var M="v2"===Ne(this.core,"options.apiVersion");if(r.code===Ct.V2NIM_ERROR_CODE_CANCELLED||10499===r.errCode)throw new UploadError({code:M?Ct.V2NIM_ERROR_CODE_CANCELLED:400,detail:{reason:Ne(r,"message")||"Request abort",rawError:r,curProvider:1}});if(M&&r.errCode===Ct.V2NIM_ERROR_CODE_FILE_OPEN_FAILED)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_FILE_OPEN_FAILED,detail:{reason:Ne(r,"message")||"Read file failed",rawError:r,curProvider:1}});var{net_connect:f}=yield Xr.net.getNetworkStatus();if(!1===f)throw new UploadError({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"No network",rawError:r,curProvider:1}});if(t){if(0===this.nosErrorCount){try{this.cloudStorage.mixStorage._addCircuitTimer()}catch(t){throw new UploadError({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"All upload attempts failed",rawError:t,curProvider:this.cloudStorage.mixStorage.curProvider,mixStorePolicy:this.cloudStorage.mixStorage.mixStorePolicy,file:e.file||e.filePath}})}return this.nosErrorCount=Ne(this.cloudStorage,"mixStorePolicy.nosPolicy.uploadConfig.retryPolicy.retry"),this.cloudStorage._uploadFile(e)}return this.nosErrorCount--,this.nosUpload(e,t)}throw new UploadError({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"NOS attempts failed",rawError:r,curProvider:1}})}var T=null==v?void 0:v.type,E=T&&T.indexOf("/")>-1?T.slice(0,T.indexOf("/")):"";E||(E=e.type||"");var S,C={image:"imageInfo",video:"vinfo",audio:"vinfo"};if(!C[E])return Object.assign({url:y},v);try{S=yield this.core.adapters.request(`${h}?${C[E]}`,{method:"GET",dataType:"json",timeout:5e3},{exception_service:3})}catch(e){return this.core.logger.error("uploadFile:: fetch file info error",e),Object.assign({url:y},v)}if(S){var{data:N}=S,A="imageInfo"===C[E]?N:null===(d=null==N?void 0:N.GetVideoInfo)||void 0===d?void 0:d.VideoInfo,b={url:y,name:v.name,size:v.size,ext:v.ext,w:null==A?void 0:A.Width,h:null==A?void 0:A.Height,orientation:null==A?void 0:A.Orientation,dur:null==A?void 0:A.Duration,audioCodec:null==A?void 0:A.AudioCodec,videoCodec:null==A?void 0:A.VideoCodec,container:null==A?void 0:A.Container};return Ec(b,(function(e,t){return void 0!==t}))}return Object.assign({url:y},v)}))}_getNosCdnHost(){var e;return __awaiter(this,void 0,void 0,(function*(){var t;try{t=yield this.core.sendCmd("getNosCdnHost")}catch(e){return void this.core.logger.error("getNosCdnHost::error",e)}if(t){var r=null===(e=null==t?void 0:t.content)||void 0===e?void 0:e.nosConfigTag,i=parseInt(null==r?void 0:r.expire);0!==i&&r.cdnDomain?-1===i?(this.config.cdn.bucket=r.bucket,this.config.cdn.cdnDomain=r.cdnDomain,this.config.cdn.objectNamePrefix=r.objectNamePrefix):(this.config.cdn.bucket=r.bucket,this.config.cdn.cdnDomain=r.cdnDomain,this.config.cdn.objectNamePrefix=r.objectNamePrefix,this.nosCdnHostTimer=this.core.timerManager.addTimer((()=>{this._getNosCdnHost()}),1e3*i)):(this.config.cdn.bucket="",this.config.cdn.cdnDomain="",this.config.cdn.objectNamePrefix="")}}))}}var Sc={"6_2":"getNosToken","6_22":"getOriginUrl","6_24":"getNosAccessToken","6_25":"deleteNosAccessToken","6_26":"getNosCdnHost","6_27":"getGrayscaleConfig","6_28":"getMixStorePolicy","6_29":"getMixStoreToken","6_30":"getFileAuthToken"},Cc={nosToken:{objectName:1,token:2,bucket:3,expireTime:4,expireSec:7,tag:8,shortUrl:9},mixStoreTokenReqTag:{provider:0,tokenCount:1,nosSurvivalTime:2,tag:3,returnBody:4},nosConfigTag:{bucket:1,cdnDomain:2,expire:3,objectNamePrefix:4},grayConfigTag:{config:0,ttl:1},mixStorePolicyTag:{providers:0,ttl:1,mixEnable:2,nosPolicy:3,s3Policy:4},mixStoreTokenResTag:{provider:0,accessKeyId:1,secretAccessKey:2,sessionToken:3,token:4,expireTime:5,bucket:6,objectName:7,fileExpireSec:8,tag:9,shortUrl:10,region:11},nosSafeUrlTag:{safeUrl:0,originUrl:1},mixStoreAuthTokenReqTag:{type:1,urls:2},mixStoreAuthTokenResTag:{type:1,tokens:2,token:3,ttl:4},nosAccessTokenTag:{token:0,url:1,userAgent:2,ext:3}},Nc={getNosToken:{sid:6,cid:2,service:"cloudStorage",params:[{type:"String",name:"responseBody"},{type:"Property",name:"nosToken",entity:"nosToken",reflectMapper:Cc.nosToken}],response:[{type:"Property",name:"nosToken",reflectMapper:sn(Cc.nosToken)}]},getOriginUrl:{sid:6,cid:22,service:"cloudStorage",params:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:Cc.nosSafeUrlTag}],response:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:sn(Cc.nosSafeUrlTag)}]},getNosCdnHost:{sid:6,cid:26,service:"cloudStorage",response:[{type:"Property",name:"nosConfigTag",reflectMapper:sn(Cc.nosConfigTag)}]},getGrayscaleConfig:{sid:6,cid:27,service:"cloudStorage",params:[{type:"Property",name:"config"}],response:[{type:"Property",name:"grayConfigTag",reflectMapper:sn(Cc.grayConfigTag)}]},getMixStorePolicy:{sid:6,cid:28,service:"cloudStorage",params:[{type:"LongArray",name:"supportType"}],response:[{type:"Property",name:"mixStorePolicyTag",reflectMapper:sn(Cc.mixStorePolicyTag)}]},getMixStoreToken:{sid:6,cid:29,service:"cloudStorage",params:[{type:"Property",name:"mixStoreTokenReqTag",reflectMapper:Cc.mixStoreTokenReqTag}],response:[{type:"Property",name:"mixStoreTokenResTag",reflectMapper:sn(Cc.mixStoreTokenResTag)}]},getFileAuthToken:{sid:6,cid:30,service:"cloudStorage",params:[{type:"Property",name:"mixStoreAuthTokenReqTag",reflectMapper:Cc.mixStoreAuthTokenReqTag}],response:[{type:"Property",name:"mixStoreAuthTokenResTag",reflectMapper:sn(Cc.mixStoreAuthTokenResTag)}]},getNosAccessToken:{sid:6,cid:24,service:"cloudStorage",params:[{type:"Property",name:"tag",reflectMapper:Cc.nosAccessTokenTag}],response:[{type:"Property",name:"tag",reflectMapper:sn(Cc.nosAccessTokenTag)}]},deleteNosAccessToken:{sid:6,cid:25,service:"cloudStorage",params:[{type:"Property",name:"tag",reflectMapper:Cc.nosAccessTokenTag}]}};class MixStorage{constructor(e,t){this.GRAYKEY="AllGrayscaleConfig",this.MIXSTOREKEY="AllMixStorePolicy",this.grayConfig={mixStoreEnable:!1,timeStamp:0,ttl:0},this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.curProvider=Ic.nos,this.mixStoreErrorCount=10,this.circuitTimer=0,this.core=e,this.cloudStorage=t,this.logger=e.logger}reset(){this.grayConfig=null,this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.curProvider=Ic.nos,this.mixStoreErrorCount=10}getGrayscaleConfig(e){var t;return __awaiter(this,void 0,void 0,(function*(){if(Xr.localStorage)try{Xr.localStorage.getItem&&Xr.localStorage.getItem(this.GRAYKEY)&&(this.grayConfig=JSON.parse(Xr.localStorage.getItem(this.GRAYKEY))[e])}catch(e){Xr.localStorage.getItem(this.GRAYKEY)&&this.core.logger.error("uploadFile:: JSON.parse grayscaleConfig error ",e)}if(!this.grayConfig||this.grayConfig.timeStamp+1e3*this.grayConfig.ttl<(new Date).getTime()){var r=yield this.core.sendCmd("getGrayscaleConfig",{config:{}});if(r.content&&r.content.grayConfigTag){this.logger.log("uploadFile::getAppGrayConfigRequest success ");try{this.grayConfig=JSON.parse(r.content.grayConfigTag.config),this.grayConfig.ttl=JSON.parse(r.content.grayConfigTag.ttl)}catch(e){this.logger.error("getGrayscaleConfig error",e)}if(!this.grayConfig)return;var i=Xr.localStorage.getItem(this.GRAYKEY)?JSON.parse(Xr.localStorage.getItem(this.GRAYKEY)):{};this.grayConfig.timeStamp=(new Date).getTime(),i[e]=this.grayConfig,Xr.localStorage.setItem(this.GRAYKEY,JSON.stringify(i))}else this.logger.debug("uploadFile:: result grayConfig:",r.content)}(null===(t=this.grayConfig)||void 0===t?void 0:t.mixStoreEnable)&&(yield this._getMixStorePolicy(e))}))}_getMixStorePolicy(e){return __awaiter(this,void 0,void 0,(function*(){var t=(new Date).getTime();if(Xr.localStorage)try{if(this.mixStorePolicy=JSON.parse(Xr.localStorage.getItem(this.MIXSTOREKEY))[e],this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.mixStorePolicy.timeStamp&&this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl>t){var r=this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl-t;this.core.timerManager.addTimer(this._getMixStorePolicy.bind(this,e),r)}}catch(t){Xr.localStorage.getItem(this.MIXSTOREKEY)&&JSON.parse(Xr.localStorage.getItem(this.MIXSTOREKEY))[e]&&this.core.logger.error("uploadFile:: JSON.parse mixStorePolicy error ",t)}if(!this.mixStorePolicy||this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl<=t)try{var i=(yield this.core.sendCmd("getMixStorePolicy",{supportType:this.cloudStorage.aws.s3?[1,2]:[1]})).content.mixStorePolicyTag;this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.mixStorePolicy.ttl=Number(i.ttl),this.mixStorePolicy.providers=i.providers.split(","),this.circuitTimer&&this.core.timerManager.deleteTimer(this.circuitTimer),this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.mixStorePolicy.nosPolicy=i.nosPolicy?JSON.parse(i.nosPolicy):null,this.mixStorePolicy.s3Policy=i.s3Policy?JSON.parse(i.s3Policy):null,null===this.mixStorePolicy.s3Policy?this.mixStorePolicy.providers=["1"]:null===this.mixStorePolicy.nosPolicy?this.mixStorePolicy.providers=["2"]:this.mixStorePolicy.providers=this.mixStorePolicy.s3Policy.priority<this.mixStorePolicy.nosPolicy.priority?["2","1"]:["1","2"],this.core.timerManager.addTimer(this._getMixStorePolicy.bind(this,e),1e3*this.mixStorePolicy.ttl);var n=Xr.localStorage.getItem(this.MIXSTOREKEY)?JSON.parse(Xr.localStorage.getItem(this.MIXSTOREKEY)):{};this.mixStorePolicy.timeStamp=(new Date).getTime(),n[e]=this.mixStorePolicy,Xr.localStorage.setItem(this.MIXSTOREKEY,JSON.stringify(n))}catch(t){if(this.logger.error("getMixStorePolicy error",t),0===this.mixStoreErrorCount)throw new Error("getMixStorePolicy all count error");this._getMixStorePolicy(e),this.mixStoreErrorCount--}this.mixStorePolicy.nosPolicy&&(this.cloudStorage.nos.nosErrorCount=this.mixStorePolicy.nosPolicy.uploadConfig.retryPolicy.retry)}))}_addCircuitTimer(){var e=this.mixStorePolicy.providers,t=e[(e.indexOf(String(this.curProvider))+1)%e.length];if(!t)throw new Error("uploadFile nextProvider error");if(t===e[0])throw new Error("uploadFile all policy fail");if(this.logger.log(`uploadFile:: upload policy will change,now policy:${this.curProvider} nextProvider:${t}`),this.curProvider=parseInt(t),this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.s3Policy){var r=this.mixStorePolicy[this.curProvider===Ic.nos?"nosPolicy":"s3Policy"].uploadConfig.retryPolicy.circuit;if(!r||0===r)throw new Error("uploadFile circuit error");this.circuitTimer=this.core.timerManager.addTimer((()=>{this.logger.log(`uploadFile:: upload policy will change,now policy:${this.curProvider} nextProvider:${parseInt(this.mixStorePolicy.providers[0])}`),this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.core.timerManager.deleteTimer(this.circuitTimer)}),1e3*r)}throw new Error("uploadFile will not retry again")}getFileAuthToken(e){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("getFileAuthToken",{mixStoreAuthTokenReqTag:e})).content.mixStoreAuthTokenResTag}))}}class AWS{constructor(e,t){this.s3=null,this.core=e,this.cloudStorage=t,this.logger=e.logger}get mixStorePolicy(){return this.cloudStorage.mixStorage.mixStorePolicy}s3Upload(e,t){return __awaiter(this,void 0,void 0,(function*(){var r;if(e.file)r=e.file;else if("string"==typeof e.fileInput){this.logger.warn("fileInput will abandon,Please use file or filepath");var i=document.getElementById(e.fileInput);if(!(i&&i.files&&i.files[0]))throw new Error("Can not get file from fileInput");r=i.files[0]}else{if(!(e.fileInput&&e.fileInput.files&&e.fileInput.files[0]))throw new Error(`Can not get file from fileInput ${e.fileInput}`);r=e.fileInput.files[0]}if(!this.mixStorePolicy.s3Policy)throw new Error("dont get s3 policy");var n={accessKeyId:t.accessKeyId,secretAccessKey:t.secretAccessKey,sessionToken:t.sessionToken,region:t.region,maxRetries:this.mixStorePolicy.s3Policy.uploadConfig.retryPolicy.retry},a=new(0,this.s3);a.config.update(n);var s=decodeURIComponent(t.bucket),o=decodeURIComponent(t.objectName),c=r,d={Bucket:s,Key:o,Body:c,Metadata:{token:t.token},ContentType:c.type||"application/octet-stream"};this.core.logger.debug("uploadFile:: s3 upload params:",d);var l=a.upload(d);return l.on("httpUploadProgress",(t=>{var r=parseFloat((t.loaded/t.total).toFixed(2));e.onUploadProgress&&e.onUploadProgress({total:t.total,loaded:t.loaded,percentage:r,percentageText:Math.round(100*r)+"%"})})),new Promise(((r,i)=>{var n=(new Date).getTime();l.send(((a,d)=>__awaiter(this,void 0,void 0,(function*(){var l,m,p;if(a&&"RequestAbortedError"===a.code)this.logger.error("uploadFile:","api::s3:upload file abort.",a),i(new UploadError({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_CANCELLED:400,detail:{reason:"S3RequestAbortedError",rawError:a,curProvider:2}}));else{if(!a){var u=this.mixStorePolicy.s3Policy.cdnSchema;u=u.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn),this.core.reporterHookCloudStorage.update({remote_addr:u,operation_type:1}),u=u.replace("{objectName}",d.Key);var h={size:c.size,name:c.name,url:t.shortUrl?t.shortUrl:u,ext:c.name.split(".")[1]||"unknown"},g=e.type||"",v={image:"imageInfo"};return r(v[g]?yield this.getS3FileInfo({url:u,infoSuffix:v[g],s3Result:h}):h)}this.logger.error("uploadFile:","api::s3:upload file failed.",a),this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account||(null===(m=null===(l=this.core)||void 0===l?void 0:l.auth)||void 0===m?void 0:m.account),trace_id:null===(p=this.core.clientSocket.socket)||void 0===p?void 0:p.sessionId,start_time:n,action:1,exception_service:4}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof a.status?a.status:"number"==typeof a.code?a.code:0,description:a.message||`${a.code}`,operation_type:1,target:JSON.stringify({bucket:s,object:o})},{asyncParams:Xr.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1);var{net_connect:y}=yield Xr.net.getNetworkStatus();if(!1===y)return i(new UploadError({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"No network",rawError:a,curProvider:this.cloudStorage.mixStorage.curProvider}}));try{this.cloudStorage.mixStorage._addCircuitTimer()}catch(t){return i(new UploadError({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"All upload attempts failed",rawError:t,curProvider:this.cloudStorage.mixStorage.curProvider,mixStorePolicy:this.mixStorePolicy,file:e.file||e.filePath}}))}r(this.cloudStorage._uploadFile(e))}})))),e.onUploadStart&&e.onUploadStart(l)}))}))}getS3FileInfo(e){var t;return __awaiter(this,void 0,void 0,(function*(){var r,{url:i,infoSuffix:n,s3Result:a}=e;try{r=yield this.core.adapters.request(`${i}?${n}`,{method:"GET",dataType:"text",timeout:5e3},{exception_service:3})}catch(e){return this.core.logger.error("uploadFile:: fetch file info error",e),a}if(r){var{data:s}=r,o="imageInfo"===n?s:null===(t=null==s?void 0:s.GetVideoInfo)||void 0===t?void 0:t.VideoInfo,c=Object.assign(Object.assign({},a),{w:null==o?void 0:o.Width,h:null==o?void 0:o.Height,orientation:null==o?void 0:o.Orientation,dur:null==o?void 0:o.Duration,audioCodec:null==o?void 0:o.AudioCodec,videoCodec:null==o?void 0:o.VideoCodec,container:null==o?void 0:o.Container});return Ec(c,(function(e,t){return void 0!==t}))}return this.core.logger.error("uploadFile:: fetch s3 file info no result",`${i}?${n}`),a}))}}var Ac=sn({none:0,normal:1,all:3}),bc=sn({normal:0,advanced:1}),Rc=sn({normal:0,owner:1,manager:2}),Oc={noVerify:0,needVerify:1,rejectAll:2},Pc=sn(Oc),Vc={needVerify:0,noVerify:1},kc=sn(Vc),wc={manager:0,all:1},Lc=sn(wc),Dc={manager:0,all:1},Uc=sn(Dc),qc={manager:0,all:1},xc=sn(qc);function formatSuperTeam(e){var t={type:bc,muteType:Ac,joinMode:Pc,beInviteMode:kc,inviteMode:Lc,updateTeamMode:Uc,updateExtMode:xc},r=__rest(e,["bits"]);return["teamId"].forEach((e=>{r[e]&&(r[e]=r[e].toString())})),["level","memberNum","memberUpdateTime","createTime","updateTime"].forEach((e=>{void 0!==r[e]&&(r[e]=parseInt(r[e]))})),["valid","validToCurrentUser","mute"].forEach((e=>{void 0!==r[e]&&(r[e]=1===parseInt(r[e]))})),Object.keys(t).forEach((e=>{void 0!==r[e]&&(r[e]=t[e][r[e]]||r[e])})),r}function formatSuperTeams(e){return e&&e.length>0?e.map((e=>formatSuperTeam(e))):[]}function generatorSuperTeamMemberForCmd(e){var t={};return void 0!==e.bitConfigMask&&(t.bits=parseInt(e.bitConfigMask)),["teamId","ext","account","nickInTeam"].forEach((r=>{e[r]&&(t[r]=e[r].toString())})),Object.prototype.hasOwnProperty.call(e,"nickInTeam")&&(t.nickInTeam=e.nickInTeam),t}function formatSuperTeamMember(e){var t={type:Rc},{bits:r}=e,i=__rest(e,["bits"]);return void 0!==r&&(i.muteTeam=1===parseInt(r),i.bitConfigMask=r),i.id=`${i.teamId}-${i.account}`,["teamId"].forEach((e=>{i[e]&&(i[e]=i[e].toString())})),["joinTime","updateTime","bitConfigMask"].forEach((e=>{void 0!==i[e]&&(i[e]=parseInt(i[e]))})),["active","valid","mute"].forEach((e=>{void 0!==i[e]&&(i[e]=1===parseInt(i[e]))})),Object.keys(t).forEach((e=>{void 0!==i[e]&&(i[e]=t[e][i[e]]||i[e])})),i}function formatSuperTeamMembers(e){return e&&e.length>0?e.map((e=>formatSuperTeamMember(e))):[]}function generatorMemberBySuperTeam(e,t,r="normal"){return{id:`${e.teamId}-${t}`,teamId:e.teamId,account:t,type:r,nickInTeam:"",muteTeam:!1,mute:!1,joinTime:e.memberUpdateTime,updateTime:e.memberUpdateTime,active:!0,valid:!0}}function generatorMembersBySuperTeam(e,t,r="normal"){return t&&t.length>0?t.map((t=>generatorMemberBySuperTeam(e,t,r))):[]}class ModuleService{constructor(e){this.core=e}notifyAddSuperTeamMembers(e,t){this.core.emit("addSuperTeamMembers",{team:e,accounts:t,members:generatorMembersBySuperTeam(e,t)})}notifyUpdateSuperTeamManagers(e,t,r,i){this.core.emit("updateSuperTeamManagers",{team:{teamId:e,memberUpdateTime:i},accounts:t,isManager:r,members:t.map((t=>({id:`${e}-${t}`,type:r?"manager":"normal",account:t,updateTime:i})))})}notifyRemoveSuperTeamMembers(e,t){this.core.emit("removeSuperTeamMembers",{team:e,accounts:t})}notifyTransferSuperTeam(e,t,r){this.core.emit("transferSuperTeam",{team:e,from:{id:`${e.teamId}-${t}`,account:t,type:"normal",updateTime:e.memberUpdateTime},to:{id:`${e.teamId}-${r}`,account:r,type:"owner",updateTime:e.memberUpdateTime}})}notifyUpdateSuperTeamMembersMute(e,t,r){this.core.emit("updateSuperTeamMembersMute",{team:e,accounts:t,members:t.map((function(t){return{id:`${e.teamId}-${t}`,account:t,teamId:e.teamId,mute:r,updateTime:e.memberUpdateTime}})),mute:r})}}var Bc={"21_5":"addSuperTeamMembers","21_6":"removeSuperTeamMembers","21_7":"leaveSuperTeam","21_8":"updateSuperTeamInfo","21_9":"getSuperTeamInfo","21_12":"getSuperTeams","21_15":"getSuperTeamMembers","21_10":"updateMySuperTeamMemberInfo","21_20":"applySuperTeam","21_21":"passSuperTeamApply","21_22":"rejectSuperTeamApply","21_23":"acceptSuperTeamInvite","21_24":"rejectSuperTeamInvite","21_26":"addSuperTeamManagers","21_27":"removeSuperTeamManagers","21_28":"muteSuperTeam","21_29":"muteSuperTeamMembers","21_30":"updateSuperTeamMemberNick","21_31":"transferSuperTeam","21_33":"getSuperTeamMembersByAccounts","21_34":"queryMuteSuperTeamMembers","21_101":"syncCreateSuperTeam","21_109":"syncSuperTeams","21_110":"syncUpdateSuperTeamMember","21_111":"syncMySuperTeamMembers"},Fc={superTeam:{teamId:1,name:3,type:4,owner:5,level:6,selfCustom:7,valid:8,memberNum:9,memberUpdateTime:10,createTime:11,updateTime:12,validToCurrentUser:13,intro:14,announcement:15,joinMode:16,bits:17,ext:18,serverExt:19,avatar:20,beInviteMode:21,inviteMode:22,updateTeamMode:23,updateExtMode:24,mute:100,muteType:101},superTeamMember:{teamId:1,account:3,type:4,nickInTeam:5,bits:7,active:8,valid:9,updateTime:11,ext:12,mute:13,invitorAccid:14,joinTime:15}},Gc=invertSerializeMap(Fc),jc={getSuperTeamInfo:{sid:21,cid:9,service:"superTeam",params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"superTeam",reflectMapper:Gc.superTeam}]},getSuperTeams:{sid:21,cid:12,service:"superTeam",params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"superTeams",reflectMapper:Gc.superTeam},{type:"Bool",name:"isAll"},{type:"Long",name:"timetag"}]},updateSuperTeamInfo:{sid:21,cid:8,service:"superTeam",params:[{type:"Property",name:"superTeam",reflectMapper:Fc.superTeam}],response:[{type:"Long",name:"time"}]},addSuperTeamMembers:{sid:21,cid:5,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"StrArray",name:"abortedAccidList"},{type:"Long",name:"time"}]},removeSuperTeamMembers:{sid:21,cid:6,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},addSuperTeamManagers:{sid:21,cid:26,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},removeSuperTeamManagers:{sid:21,cid:27,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},applySuperTeam:{sid:21,cid:20,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"superTeam",reflectMapper:Gc.superTeam}]},transferSuperTeam:{sid:21,cid:31,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},muteSuperTeam:{sid:21,cid:28,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Int",name:"mute"}]},muteSuperTeamMembers:{sid:21,cid:29,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"Int",name:"mute"}]},updateSuperTeamMemberNick:{sid:21,cid:30,service:"superTeam",params:[{type:"Property",name:"teamMember",reflectMapper:Fc.superTeamMember}]},updateMySuperTeamMemberInfo:{sid:21,cid:10,service:"superTeam",params:[{type:"Property",name:"teamMember",reflectMapper:Fc.superTeamMember}]},getSuperTeamMembersByAccounts:{sid:21,cid:33,service:"superTeam",params:[{type:"StrArray",name:"memberIds"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Gc.superTeamMember}]},getSuperTeamMembers:{sid:21,cid:15,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Long",name:"joinTime"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Gc.superTeamMember}]},queryMuteSuperTeamMembers:{sid:21,cid:34,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Long",name:"joinTime"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Gc.superTeamMember}]},leaveSuperTeam:{sid:21,cid:7,service:"superTeam",params:[{type:"Long",name:"teamId"}]},passSuperTeamApply:{sid:21,cid:21,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectSuperTeamApply:{sid:21,cid:22,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},acceptSuperTeamInvite:{sid:21,cid:23,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectSuperTeamInvite:{sid:21,cid:24,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},syncSuperTeams:{sid:21,cid:109,service:"superTeam",response:[{type:"PropertyArray",name:"teams",reflectMapper:Gc.superTeam},{type:"Bool",name:"isAll"},{type:"Long",name:"timetag"}]},syncCreateSuperTeam:{sid:21,cid:101,service:"superTeam",response:[{type:"Property",name:"superTeam",reflectMapper:Gc.superTeam}]},syncUpdateSuperTeamMember:{sid:21,cid:110,service:"superTeam",response:[{type:"Property",name:"teamMember",reflectMapper:Gc.superTeamMember}]},syncMySuperTeamMembers:{sid:21,cid:111,ext:"sync",service:"superTeam",response:[{type:"PropertyArray",name:"teamMembers",reflectMapper:Gc.superTeamMember},{type:"Long",name:"timetag"}]}};var Hc={"13_1":"getChatroomAddress","24_1":"getQChatAddress"},Yc={getChatroomAddress:{sid:13,cid:1,service:"plugin",params:[{type:"Long",name:"chatroomId"},{type:"Bool",name:"isWeixinApp"},{type:"Int",name:"ipType"}],response:[{type:"StrArray",name:"address"}]},getQChatAddress:{sid:24,cid:1,service:"plugin",params:[{type:"Property",name:"getQChatAddressTag",reflectMapper:{ipType:1}}],response:[{type:"StrArray",name:"address"}]}};var $c,Wc,zc,Kc={"7_19":"nimQueryCloudSessionList","7_20":"nimQueryCloudSession","7_21":"nimUpdateCloudSession","7_22":"nimDeleteCloudSessionList","7_121":"nimMultiSyncUpdateCloudSession"},Jc={sessionReqTag:{minTimestamp:1,maxTimestamp:2,includedLastMsg:3,limit:4,hasMore:5},sessionTag:{sessionId:1,updateTime:2,ext:3,lastMsg:4,lastMsgType:5}},Qc=invertSerializeMap(Jc),Xc={nimQueryCloudSessionList:{sid:7,cid:19,service:"cloudSession",params:[{type:"Property",name:"tag",reflectMapper:Jc.sessionReqTag}],response:[{type:"Property",name:"tag",reflectMapper:Qc.sessionReqTag},{type:"PropertyArray",name:"sessions",reflectMapper:Qc.sessionTag}]},nimQueryCloudSession:{sid:7,cid:20,service:"cloudSession",params:[{type:"Property",name:"tag",reflectMapper:Jc.sessionTag}],response:[{type:"Property",name:"session",reflectMapper:Qc.sessionTag}]},nimUpdateCloudSession:{sid:7,cid:21,service:"cloudSession",params:[{type:"Property",name:"tag",reflectMapper:Jc.sessionTag}]},nimDeleteCloudSessionList:{sid:7,cid:22,service:"cloudSession",params:[{type:"PropertyArray",name:"tags",reflectMapper:Jc.sessionTag}]},nimMultiSyncUpdateCloudSession:{sid:7,cid:121,service:"cloudSession",response:[{type:"Property",name:"session",reflectMapper:Qc.sessionTag}]}},Zc={sessionId:{type:"string"},updateTime:{type:"number"},ext:{type:"string"},lastMsg:{type:"object"},lastMsgType:{type:"number"}};function formatCloudSession(e,t,r){var i=format(Zc,e),{accid:n,scene:a}=getAccountFromSessionId(i.sessionId,"|");if(i.sessionId=`${a}-${n}`,i.lastMsg){var s=1===i.lastMsgType;i.lastMsgInfo=s?{isLastMsgRecalled:s,revokedMsg:formatSystemMessage(deserialize(i.lastMsg,Yo.sysMsg),r)}:{isLastMsgRecalled:s,lastMsg:formatMsg$1(deserialize(i.lastMsg,Os.msg),{account:t})}}return delete i.lastMsg,delete i.lastMsgType,i}!function(e){e[e.audio=1]="audio",e[e.video=2]="video",e[e.custom=3]="custom"}($c||($c={})),function(e){e[e.kClose=1]="kClose",e[e.kJoin=2]="kJoin",e[e.kInvite=3]="kInvite",e[e.kCancelInvite=4]="kCancelInvite",e[e.kReject=5]="kReject",e[e.kAccept=6]="kAccept",e[e.kLeave=7]="kLeave",e[e.kCustom=8]="kCustom"}(Wc||(Wc={})),function(e){e[e.kDefault=0]="kDefault",e[e.kLeave=1]="kLeave",e[e.kSelfSync=3]="kSelfSync"}(zc||(zc={}));var ed={needPush:{type:"boolean",required:!1},pushTitle:{type:"string",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},needPushBadge:{type:"boolean",required:!1}},td={"15_1":"signalingCreate","15_2":"signalingDelay","15_3":"signalingClose","15_4":"signalingJoin","15_5":"signalingLeave","15_6":"signalingInvite","15_7":"signalingCancelInvite","15_8":"signalingReject","15_9":"signalingAccept","15_10":"signalingSendCustomCommand","15_11":"signalingRecvNotification","15_12":"signalingMultiSyncNotification","15_13":"signalingSyncNotification","15_14":"singalingSyncChannels","15_15":"signalingQueryInfo","15_16":"signalingCallEx","15_17":"signalingJoinAndAccept"},rd={avSignalTag:Object.assign({type:1,name:2,channelId:3,createTime:4,expireTime:5,creatorAccid:6,ext:7,invalid:8,fromAccid:10,toAccid:11,requestId:12,members:18,attach:19,attachExt:20,needOffline:21,msgId:22,uid:23,time:24,nertcChannelName:25,nertcTokenTtl:26,nertcToken:27,nertcJoinRoomQueryParamMap:28,nertcJoinRoomResponse:29,callStatus:30},{needPush:13,pushTitle:14,pushContent:15,pushPayload:16,needPushBadge:17})},id=invertSerializeMap(rd),nd={signalingCreate:{sid:15,cid:1,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingDelay:{sid:15,cid:2,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingClose:{sid:15,cid:3,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingJoin:{sid:15,cid:4,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingLeave:{sid:15,cid:5,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}]},signalingInvite:{sid:15,cid:6,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}]},signalingCancelInvite:{sid:15,cid:7,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}]},signalingReject:{sid:15,cid:8,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}]},signalingAccept:{sid:15,cid:9,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}]},signalingSendCustomCommand:{sid:15,cid:10,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}]},signalingRecvNotification:{sid:15,cid:11,service:"signaling",response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingMultiSyncNotification:{sid:15,cid:12,service:"signaling",response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingSyncNotification:{sid:15,cid:13,service:"signaling",response:[{type:"PropertyArray",name:"datas",reflectMapper:id.avSignalTag}]},singalingSyncChannels:{sid:15,cid:14,service:"signaling",response:[{type:"PropertyArray",name:"datas",reflectMapper:id.avSignalTag}]},signalingQueryInfo:{sid:15,cid:15,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingCallEx:{sid:15,cid:16,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingJoinAndAccept:{sid:15,cid:17,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:rd.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:id.avSignalTag}]},signalingBatchMarkRead:{sid:4,cid:5,hasPacketResponse:!1,service:"signaling",params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]}},ad={type:{type:"number"},createTime:{type:"number"},expireTime:{type:"number"},invalid:{type:"boolean"},pushInfo:ed,pluginSetting:{nertcInfo:{nertcChannelName:{type:"string"},nertcTokenTtl:{type:"number"},nertcToken:{type:"string"},nertcJoinRoomQueryParamMap:{type:"string"},callStatus:{type:"number"}}},callStatus:{type:"number"},attach:{type:"object"},members:{type:"object"},needOffline:{type:"boolean"},uid:{type:"number"},time:{type:"number"}};function formatSignalingChannelMember(e){return format(ad,deserialize(e,{1:"accid",2:"uid",3:"createTime",4:"expireTime"}))}function formatSignaling(e){var t=format(ad,e),r=[];return t.members&&t.members.length>0&&(r=t.members.map((e=>formatSignalingChannelMember(e))),delete t.members),r.length>0?{channelInfo:t,memberList:r}:{channelInfo:t}}function formatSignalingWithCallStatus(e){var t=format(ad,e),r=[];t.members&&t.members.length>0&&(r=t.members.map((e=>formatSignalingChannelMember(e))),delete t.members);var i=200;return e.callStatus&&(i=Number(e.callStatus)),r.length>0?{channelInfo:t,memberList:r,callStatus:i}:{channelInfo:t,callStatus:i}}function generateSignalingForCmd(e){return formatReverse(ad,e)}class SignalingService extends r.EventEmitter{constructor(e){super(),this.timer=0,this.pollingInterval=12e4,this.name="signaling",this.logger=e.logger,this.core=e,this.channels={},registerParser({cmdMap:td,cmdConfig:nd})}callEx(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},toAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},needOffline:{type:"boolean",required:!1},pushInfo:{type:"object",required:!1,rules:ed},pluginSetting:{type:"object",required:!1,rules:{nertcInfo:{type:"object",required:!1}}}},e);var r=yield this.core.sendCmd("signalingCallEx",{tag:generateSignalingForCmd(e)}),i=formatSignalingWithCallStatus((null===(t=r.content)||void 0===t?void 0:t.data)||{});return this.channels[i.channelInfo.channelId]=Go(i.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),i}))}joinAndAccept(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},fromAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",required:!1},needOffline:{type:"boolean",required:!1},uid:{type:"number",required:!1},pluginSetting:{type:"object",required:!1,rules:{nertcInfo:{type:"object",required:!1}}}},e);var{fromAccid:r}=e,i=__rest(e,["fromAccid"]);i.toAccid=r;var n=yield this.core.sendCmd("signalingJoinAndAccept",{tag:generateSignalingForCmd(i)}),a=formatSignalingWithCallStatus((null===(t=n.content)||void 0===t?void 0:t.data)||{});return this.channels[a.channelInfo.channelId]=Go(a.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),a}))}create(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},ext:{type:"string",required:!1}},e);var r=yield this.core.sendCmd("signalingCreate",{tag:generateSignalingForCmd(e)});return formatSignaling((null===(t=r.content)||void 0===t?void 0:t.data)||{})}))}close(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1}},e),yield this.core.sendCmd("signalingClose",{tag:generateSignalingForCmd(e)})}))}queryInfo(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({name:{type:"string",allowEmpty:!1}},e);var r=yield this.core.sendCmd("signalingQueryInfo",{tag:e});return formatSignaling((null===(t=r.content)||void 0===t?void 0:t.data)||{})}))}join(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},uid:{type:"number",min:0,required:!1},needOffline:{type:"boolean",required:!1}},e);var r=yield this.core.sendCmd("signalingJoin",{tag:generateSignalingForCmd(e)}),i=formatSignaling((null===(t=r.content)||void 0===t?void 0:t.data)||{});return this.channels[i.channelInfo.channelId]=Go(i.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),i}))}aotoDelay(){return __awaiter(this,void 0,void 0,(function*(){var e=Object.keys(this.channels);if(0===e.length)return this.timer&&this.core.timerManager.deleteTimer(this.timer),void(this.timer=0);this.logger.log("signling:autoDelay",e);for(var t=0;t<e.length;t++){var r=e[t];try{var i=formatSignaling((yield this.core.sendCmd("signalingDelay",{tag:{channelId:r}})).content.data);this.channels[r]=i.channelInfo}catch(e){this.logger.warn(`signling:autoDelay ${r} failed`,e),delete this.channels[r]}}}))}leave(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1}},e),yield this.core.sendCmd("signalingLeave",{tag:generateSignalingForCmd(e)}),delete this.channels[e.channelId]}))}invite(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},toAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1},pushInfo:{type:"object",required:!1,rules:ed}},e),yield this.core.sendCmd("signalingInvite",{tag:generateSignalingForCmd(e)})}))}cancelInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},toAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1}},e),yield this.core.sendCmd("signalingCancelInvite",{tag:generateSignalingForCmd(e)})}))}reject(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},fromAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1}},e);var{fromAccid:t}=e,r=__rest(e,["fromAccid"]);r.toAccid=t,yield this.core.sendCmd("signalingReject",{tag:generateSignalingForCmd(r)})}))}accept(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},fromAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1},autoJoin:{type:"boolean",required:!1},uid:{type:"number",min:0,required:!1},joinAttachExt:{type:"string",required:!1}},e);var{autoJoin:t,joinAttachExt:r,fromAccid:i}=e,n=__rest(e,["autoJoin","joinAttachExt","fromAccid"]);if(n.toAccid=i,yield this.core.sendCmd("signalingAccept",{tag:generateSignalingForCmd(n)}),this.logger.log(`Signaling:accept, accept success, autoJoin ${e.autoJoin}`),t){var a={channelId:e.channelId,needOffline:e.needOffline,attachExt:r,uid:e.uid};yield this.join(a)}}))}sendCustomCommand(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1},fromAccid:{type:"string",allowEmpty:!1,required:!1},attachExt:{type:"string",required:!1}},e),yield this.core.sendCmd("signalingSendCustomCommand",{tag:generateSignalingForCmd(e)})}))}signalingRecvNotificationHandler(e){var t="number"==typeof Ne(e,"raw.r[0]")?`${e.raw.r[0]}`:"0";e.content.data.msgId=e.content.data.msgId||t,this.doNotify(e.content.data),t&&parseInt(t)&&this.core.sendCmd("signalingBatchMarkRead",{sid:15,cid:11,ids:[t]})}signalingMultiSyncNotificationHandler(e){this.doNotify(e.content.data,zc.kSelfSync)}doNotify(e,t=zc.kDefault){var{metaData:r,rawData:i}=function formatSignalingNotification(e,t=zc.kDefault){var r=format(ad,e),{attach:i,attachExt:n,time:a,msgId:s,fromAccid:o,toAccid:c,members:d,requestId:l,pushInfo:m}=r,p=__rest(r,["attach","attachExt","time","msgId","fromAccid","toAccid","members","requestId","pushInfo"]);if(2===i.type)try{r.member={accid:r.attach.member[1],uid:Number(r.attach.member[2]),createTime:Number(r.attach.member[3]),expireTime:Number(r.attach.member[4])}}catch(e){delete r.member}var u=i.type;return delete r.attach,{metaData:{eventType:u,channelInfo:p,feature:t,ext:n||"",time:a,msgId:s},rawData:r}}(e,t),{fromAccid:n,toAccid:a,requestId:s,pushInfo:o,msgId:c,member:d}=i;switch(r.eventType){case Wc.kClose:this.emit("signalingClose",{fromAccid:n,metaData:r});break;case Wc.kJoin:this.emit("signalingJoin",{fromAccid:n,metaData:r,member:d});break;case Wc.kInvite:this.emit("signalingInvite",{fromAccid:n,toAccid:a,requestId:s,pushInfo:o,metaData:r});break;case Wc.kCancelInvite:this.emit("signalingCancelInvite",{fromAccid:n,toAccid:a,requestId:s,metaData:r});break;case Wc.kReject:this.emit("signalingReject",{fromAccid:n,toAccid:a,requestId:s,metaData:r});break;case Wc.kAccept:this.emit("signalingAccept",{fromAccid:n,toAccid:a,requestId:s,metaData:r});break;case Wc.kLeave:this.emit("signalingLeave",{fromAccid:n,metaData:r});break;case Wc.kCustom:this.emit("signalingCustomCommand",{fromAccid:n,metaData:r});break;default:this.logger.warn(`signaling:notification, no such a type ${r.eventType}`,i)}return c}signalingSyncNotificationHandler(e){if(e.content.datas&&e.content.datas.length>0){var t=e.content.datas.map((e=>this.doNotify(e,zc.kLeave))).filter((e=>e));t.length>0&&this.core.sendCmd("signalingBatchMarkRead",{sid:15,cid:11,ids:t})}}singalingSyncChannelsHandler(e){if(this.timer=0,this.channels={},e.content.datas&&e.content.datas.length>0){var t=e.content.datas.map((e=>formatSignaling(e)));t.forEach((e=>{var t=e.channelInfo.channelId;this.channels[t]=Go(e.channelInfo)})),this.emit("singalingSyncChannels",t)}}process(e){var t=this[e.cmd+"Handler"];if("function"==typeof t)return t.call(this,e),Promise.resolve(e);var r=Ne(e,"error.detail.ignore");return e.error&&!r?Promise.reject(e.error):Promise.resolve(e)}}class Service extends r{constructor(e,t){super(),this.name=e,this.core=t,this.name=e,this.logger=t.logger,this.core=t}emit(e,...t){try{return super.emit(e,...t)}catch(t){return setTimeout((()=>{throw this.logger.error(`${this.name}::emit throw error in setTimeout. event: ${e.toString()}. Error`,t),t}),0),!1}}process(e){var t=this[e.cmd+"Handler"];if("function"==typeof t)return t.call(this,e);var r=Ne(e,"error.detail.ignore");return e.error&&!r?Promise.reject(e.error):Promise.resolve(e)}}var sd,od,cd,dd,ld,md,pd,ud={"24_15":"qchatSubscribe","24_27":"qchatGetUnreadInfo","24_48":"qchatCreateChannel","24_49":"qchatDeleteChannel","24_50":"qchatUpdateChannel","24_51":"qchatGetChannels","24_52":"qchatGetChannelsByPage","24_53":"qchatGetMembersByPage","24_54":"qchatUpdateWhiteBlackRole","24_55":"qchatGetWhiteBlackRolesPage","24_56":"qchatUpdateWhiteBlackMembers","24_57":"qchatGetWhiteBlackMembersPage","24_58":"qchatGetExistingWhiteBlackRoles","24_59":"qchatGetExistingWhiteBlackMembers","24_60":"qchatUpdateCategoryInfoOfChannel","24_109":"qchatCreateChannelCategory","24_110":"qchatRemoveChannelCategory","24_111":"qchatUpdateChannelCategory","24_112":"qchatGetChannelCategoriesByID","24_113":"qchatUpdateChannelCategoryWhiteBlackRole","24_114":"qchatGetChannelCategoryWhiteBlackRolesPage","24_115":"qchatUpdateChannelCategoryWhiteBlackMembers","24_116":"qchatGetChannelCategoryWhiteBlackMembersPage","24_117":"qchatGetChannelCategoryWhiteBlackRoles","24_118":"qchatGetChannelCategoryWhiteBlackMembers","24_119":"qchatGetChannelCategoriesPage","24_120":"qchatGetChannelCategoryChannelsPage","24_93":"qchatGetChannelSearchByPage","24_95":"qchatChannelMemberSearch","25_8":"qchatGetRoleIdsByServerId","25_9":"qchatSubscribeAsVisitor","25_12":"qchatAutoSubscribe","25_13":"qchatAutoSubscribeNotification"},hd={serverId:1,channelId:2,ackTimestamp:3,unreadCount:4,mentionedCount:5,maxCount:6,lastMsgTime:7},gd={channelInfo:{channelId:1,serverId:2,name:4,topic:5,ext:6,type:7,validFlag:8,createTime:9,updateTime:10,owner:11,viewMode:12,categoryId:13,syncMode:14,reorderWeight:15,visitorMode:16},antispamTag:{antiSpamBusinessId:1},memberInfo:{serverId:1,accid:3,nick:4,avatar:5,ext:6,type:7,joinTime:8,inviter:9,validFlag:10,createTime:11,updateTime:12},serverRole:{serverId:1,roleId:2,name:3,icon:4,ext:5,auths:6,type:7,memberCount:8,priority:9,createTime:10,updateTime:11},qchatSubReqTag:{type:1,opeType:2},qchatChannelIdInfoTag:{serverId:1,channelId:2},unreadInfo:hd,qchatGetChannelListPageTag:{serverId:1,timetag:2,limit:3},qchatGetMembersByPageTag:{serverId:1,channelId:2,timetag:3,limit:4},qchatUpdateWhiteBlackRoleTag:{serverId:1,channelId:2,type:3,opeType:4,roleId:5},qchatGetWhiteBlackRolesPageTag:{serverId:1,channelId:2,type:3,timetag:4,limit:5},qchatUpdateWhiteBlackMembersTag:{serverId:1,channelId:2,type:3,opeType:4,toAccids:5},qchatGetWhiteBlackMembersPageTag:{serverId:1,channelId:2,type:3,timetag:4,limit:5},qchatGetExistingWhiteBlackRolesTag:{serverId:1,channelId:2,type:3,roleIds:4},qchatGetExistingWhiteBlackMembersTag:{serverId:1,channelId:2,type:3,accids:4},QChatChannelCategoryInfo:{categoryId:1,serverId:2,name:4,ext:5,owner:6,viewMode:7,validFlag:8,createTime:9,updateTime:10,channelNumber:11},qchatUpdateChannelCategoryWhiteBlackRoleTag:{serverId:1,categoryId:2,type:3,opeType:4,roleId:5},qchatGetChannelCategoryWhiteBlackRolesPageTag:{serverId:1,categoryId:2,type:3,timetag:4,limit:5},qchatUpdateChannelCategoryWhiteBlackMembersTag:{serverId:1,categoryId:2,type:3,opeType:4,toAccids:5},qchatGetChannelCategoryWhiteBlackMembersPageTag:{serverId:1,categoryId:2,type:3,timetag:4,limit:5},qchatGetChannelCategoryWhiteBlackRolesTag:{serverId:1,categoryId:2,type:3,roleIds:4},qchatGetChannelCategoryWhiteBlackMembersTag:{serverId:1,categoryId:2,type:3,accids:4},qchatGetChannelCategoriesPageTag:{serverId:1,timetag:2,limit:3},qchatGetChannelCategoryChannelsPageTag:{serverId:1,categoryId:2,timetag:3,limit:4},qchatGetChannelSearchByPageTag:{keyword:1,startTime:2,endTime:3,order:4,limit:5,serverId:6,sort:7,cursor:8},qchatUpdateChannelTag:{channelId:1,name:4,topic:5,ext:6,viewMode:12,visitorMode:16},serverRoles:{serverId:1,roleIds:2,timeTag:3},qchatChannelMemberSearchTag:{serverId:1,channelId:2,keyword:3,limit:4},qchatChannelMemberInfo:{serverId:1,channelId:2,avatar:3,accid:4,nick:5,createTime:6,updateTime:7}},getDeserializeTag$4=()=>invertSerializeMap(gd),getCmdConfig$4=()=>{var e=getDeserializeTag$4();return{qchatCreateChannel:{sid:24,cid:48,service:"qchatChannel",params:[{type:"Property",name:"channelInfo",reflectMapper:gd.channelInfo},{type:"Property",name:"antispamTag",reflectMapper:gd.antispamTag}],response:[{type:"Property",name:"channelInfo",reflectMapper:e.channelInfo}]},qchatDeleteChannel:{sid:24,cid:49,service:"qchatChannel",params:[{type:"Long",name:"channelId"}]},qchatUpdateChannel:{sid:24,cid:50,service:"qchatChannel",params:[{type:"Property",name:"channelInfo",reflectMapper:gd.qchatUpdateChannelTag},{type:"Property",name:"antispamTag",reflectMapper:gd.antispamTag}],response:[{type:"Property",name:"channelInfo",reflectMapper:e.channelInfo}]},qchatGetChannels:{sid:24,cid:51,service:"qchatChannel",params:[{type:"LongArray",name:"channelIds"}],response:[{type:"PropertyArray",name:"channelList",reflectMapper:e.channelInfo}]},qchatGetChannelsByPage:{sid:24,cid:52,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelListPageTag",reflectMapper:gd.qchatGetChannelListPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.channelInfo}]},qchatGetMembersByPage:{sid:24,cid:53,service:"qchatChannel",params:[{type:"Property",name:"qchatGetMembersByPageTag",reflectMapper:gd.qchatGetMembersByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatUpdateWhiteBlackRole:{sid:24,cid:54,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateWhiteBlackRoleTag",reflectMapper:gd.qchatUpdateWhiteBlackRoleTag}]},qchatGetWhiteBlackRolesPage:{sid:24,cid:55,service:"qchatChannel",params:[{type:"Property",name:"qchatGetWhiteBlackRolesPageTag",reflectMapper:gd.qchatGetWhiteBlackRolesPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverRole}]},qchatUpdateWhiteBlackMembers:{sid:24,cid:56,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateWhiteBlackMembersTag",reflectMapper:gd.qchatUpdateWhiteBlackMembersTag}]},qchatGetWhiteBlackMembersPage:{sid:24,cid:57,service:"qchatChannel",params:[{type:"Property",name:"qchatGetWhiteBlackMembersPageTag",reflectMapper:gd.qchatGetWhiteBlackMembersPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatGetExistingWhiteBlackRoles:{sid:24,cid:58,service:"qchatChannel",params:[{type:"Property",name:"qchatGetExistingWhiteBlackRolesTag",reflectMapper:gd.qchatGetExistingWhiteBlackRolesTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.serverRole}]},qchatGetExistingWhiteBlackMembers:{sid:24,cid:59,service:"qchatChannel",params:[{type:"Property",name:"qchatGetExistingWhiteBlackMembersTag",reflectMapper:gd.qchatGetExistingWhiteBlackMembersTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatUpdateCategoryInfoOfChannel:{sid:24,cid:60,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateCategoryInfoOfChannelTag",reflectMapper:gd.channelInfo}],response:[{type:"Property",name:"channelInfo",reflectMapper:e.channelInfo}]},qchatCreateChannelCategory:{sid:24,cid:109,service:"qchatChannel",params:[{type:"Property",name:"qchatCreateChannelCategoryTag",reflectMapper:gd.QChatChannelCategoryInfo}],response:[{type:"Property",name:"QChatChannelCategoryInfo",reflectMapper:e.QChatChannelCategoryInfo}]},qchatRemoveChannelCategory:{sid:24,cid:110,service:"qchatChannel",params:[{type:"Long",name:"categoryId"}]},qchatUpdateChannelCategory:{sid:24,cid:111,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateChannelCategoryTag",reflectMapper:gd.QChatChannelCategoryInfo}],response:[{type:"Property",name:"QChatChannelCategoryInfo",reflectMapper:e.QChatChannelCategoryInfo}]},qchatGetChannelCategoriesByID:{sid:24,cid:112,service:"qchatChannel",params:[{type:"LongArray",name:"categoryIds"}],response:[{type:"PropertyArray",name:"channelCategoryList",reflectMapper:e.QChatChannelCategoryInfo}]},qchatUpdateChannelCategoryWhiteBlackRole:{sid:24,cid:113,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateChannelCategoryWhiteBlackRoleTag",reflectMapper:gd.qchatUpdateChannelCategoryWhiteBlackRoleTag}]},qchatGetChannelCategoryWhiteBlackRolesPage:{sid:24,cid:114,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryWhiteBlackRolesPageTag",reflectMapper:gd.qchatGetChannelCategoryWhiteBlackRolesPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverRole}]},qchatUpdateChannelCategoryWhiteBlackMembers:{sid:24,cid:115,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateChannelCategoryWhiteBlackMembersTag",reflectMapper:gd.qchatUpdateChannelCategoryWhiteBlackMembersTag}]},qchatGetChannelCategoryWhiteBlackMembersPage:{sid:24,cid:116,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryWhiteBlackMembersPageTag",reflectMapper:gd.qchatGetChannelCategoryWhiteBlackMembersPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatGetChannelCategoryWhiteBlackRoles:{sid:24,cid:117,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryWhiteBlackRolesTag",reflectMapper:gd.qchatGetChannelCategoryWhiteBlackRolesTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.serverRole}]},qchatGetChannelCategoryWhiteBlackMembers:{sid:24,cid:118,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryWhiteBlackMembersTag",reflectMapper:gd.qchatGetChannelCategoryWhiteBlackMembersTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatGetChannelCategoriesPage:{sid:24,cid:119,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoriesPageTag",reflectMapper:gd.qchatGetChannelCategoriesPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.QChatChannelCategoryInfo}]},qchatGetChannelCategoryChannelsPage:{sid:24,cid:120,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryChannelsPageTag",reflectMapper:gd.qchatGetChannelCategoryChannelsPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.channelInfo}]},qchatSubscribe:{sid:24,cid:15,service:"qchatChannel",params:[{type:"Property",name:"qchatSubReqTag",reflectMapper:gd.qchatSubReqTag},{type:"PropertyArray",name:"channels",reflectMapper:gd.qchatChannelIdInfoTag}],response:[{type:"PropertyArray",name:"unreadInfos",reflectMapper:e.unreadInfo},{type:"PropertyArray",name:"failedChannels",reflectMapper:e.qchatChannelIdInfoTag}]},qchatAutoSubscribe:{sid:25,cid:12,service:"qchatChannel",hasPacketTimer:!1,params:[{type:"Property",name:"qchatAutoSubReqTag"}],response:[{type:"Property",name:"qchatAutoSubInfo",reflectMapper:{1:"time"}}]},qchatAutoSubscribeNotification:{service:"qchatChannel",sid:25,cid:13,response:[{type:"PropertyArray",name:"serverIds",reflectMapper:e.unreadInfo},{type:"PropertyArray",name:"unreadInfos",reflectMapper:e.unreadInfo}]},qchatGetUnreadInfo:{sid:24,cid:27,service:"qchatChannel",params:[{type:"PropertyArray",name:"channels",reflectMapper:gd.qchatChannelIdInfoTag}],response:[{type:"PropertyArray",name:"unreadInfos",reflectMapper:e.unreadInfo}]},qchatGetChannelSearchByPage:{sid:24,cid:93,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelSearchByPageTag",reflectMapper:gd.qchatGetChannelSearchByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag",3:"cursor"}},{type:"PropertyArray",name:"datas",reflectMapper:e.channelInfo}]},qchatGetRoleIdsByServerId:{sid:25,cid:8,service:"qchatChannel",params:[{type:"Property",name:"qchatGetRoleIdsByServerIdTag",reflectMapper:{serverIdTimeTags:1}}],response:[{type:"PropertyArray",name:"serverRoles",reflectMapper:e.serverRoles},{type:"String",name:"failServerIds"}]},qchatChannelMemberSearch:{sid:24,cid:95,service:"qchatChannel",params:[{type:"Property",name:"qchatChannelMemberSearchTag",reflectMapper:gd.qchatChannelMemberSearchTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.qchatChannelMemberInfo}]},qchatSubscribeAsVisitor:{sid:25,cid:9,service:"qchatChannel",params:[{type:"Property",name:"tag",reflectMapper:gd.qchatSubReqTag},{type:"PropertyArray",name:"datas",reflectMapper:gd.qchatChannelIdInfoTag}],response:[{type:"PropertyArray",name:"failedArr",reflectMapper:e.qchatChannelIdInfoTag}]}}};!function(e){e[e.reorderWeight=0]="reorderWeight",e[e.createTime=1]="createTime"}(sd||(sd={})),function(e){e[e.white=1]="white",e[e.black=2]="black"}(od||(od={})),function(e){e[e.add=1]="add",e[e.remove=2]="remove"}(cd||(cd={})),function(e){e[e.message=0]="message",e[e.media=1]="media",e[e.ext=100]="ext"}(dd||(dd={})),function(e){e[e.ASC=1]="ASC",e[e.DESC=2]="DESC"}(ld||(ld={})),function(e){e[e.reorderWeight=0]="reorderWeight",e[e.createTime=1]="createTime",e[e.totalMember=2]="totalMember"}(md||(md={})),function(e){e[e.square=1]="square",e[e.person=2]="person"}(pd||(pd={}));var vd={channelId:{type:"string"},serverId:{type:"string"},name:{type:"string"},topic:{type:"string"},ext:{type:"string"},type:{type:"enum",values:dd},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},viewMode:{type:"number"},categoryId:{type:"string"},syncMode:{type:"number"},visitorMode:{type:"number"},reorderWeight:{type:"string"}},yd={serverId:{type:"string"},channelId:{type:"string"},ackTimestamp:{type:"number"},unreadCount:{type:"number"},mentionedCount:{type:"number"},maxCount:{type:"number"},lastMsgTime:{type:"number"}},Id={serverId:{type:"string"},channelId:{type:"string"},type:{type:"enum",values:od},opeType:{type:"enum",values:cd},toAccids:{type:"object"}},_d={serverId:{type:"string"},channelId:{type:"string"},type:{type:"enum",values:od},opeType:{type:"enum",values:cd},roleId:{type:"string"}},Md={categoryId:{type:"string"},serverId:{type:"string"},name:{type:"string"},ext:{type:"string"},owner:{type:"string"},viewMode:{type:"number"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},channelNumber:{type:"number"}},fd={serverId:{type:"string"},channelId:{type:"string"},accid:{type:"string"},avatar:{type:"string"},nick:{type:"string"},createTime:{type:"number"},updateTime:{type:"number"}};function formatUpdateWhiteBlackRole(e){return format(_d,e)}function formatChannel(e){return format(vd,e)}function formatChannels(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatChannel(e))):[]}function formatUnreadInfo(e){return format(yd,e)}function formatUnreadInfos(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatUnreadInfo(e))):[]}function formatChannelCategory(e){return format(Md,e)}function formatChannelCategorys(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatChannelCategory(e))):[]}function formatChannelMembers(e){return Array.isArray(e)&&e.length>0?e.map((e=>function formatChannelMember(e){return format(fd,e)}(e))):[]}function formatFailServerIds(e){try{return JSON.parse(e)}catch(e){return[]}}var Td={serverId:{type:"string"},name:{type:"string"},icon:{type:"string"},ext:{type:"string"},owner:{type:"string"},memberNumber:{type:"number"},inviteMode:{type:"number"},applyMode:{type:"number"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},channelNumber:{type:"number"},categoryNumber:{type:"number"},searchType:{type:"number"},searchEnable:{type:"boolean"},reorderWeight:{type:"string"}},Ed={serverId:{type:"string"},uid:{type:"string"},accid:{type:"string"},nick:{type:"string"},avatar:{type:"string"},ext:{type:"string"},type:{type:"number"},joinTime:{type:"number"},inviter:{type:"string"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}},Sd={serverId:{type:"string"},appid:{type:"string"},accid:{type:"string"},ext:{type:"string"},banTime:{type:"number"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}};function formatServer(e){return format(Td,e)}function formatServers(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatServer(e))):[]}function formatMember$1(e){return format(Ed,e)}function formatMembers$1(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatMember$1(e))):[]}function formatServerMemberBanInfos(e){return Array.isArray(e)&&e.length>0?e.map((e=>function formatServerMemberBanInfo(e){return format(Sd,e)}(e))):[]}function generateAntispamTag(e){var t,r,i;if(!e.antispamTag)return{};var n=Object.assign({},e.antispamTag);return(null===(t=e.antispamTag)||void 0===t?void 0:t.antiSpamBusinessId)&&"string"!=typeof(null===(r=e.antispamTag)||void 0===r?void 0:r.antiSpamBusinessId)&&(n.antiSpamBusinessId=JSON.stringify(null===(i=e.antispamTag)||void 0===i?void 0:i.antiSpamBusinessId)),n}var Cd={accid:{type:"string"},type:{type:"number"},serverId:{type:"string"},status:{type:"number"},requestId:{type:"string"},createTime:{type:"number"},updateTime:{type:"number"},expireTime:{type:"number"},data:{type:"object"}};function formatInviteApplyRecord(e){return format(Cd,e)}function formatInviteApplyRecords(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatInviteApplyRecord(e))):[]}var Nd,Ad,bd,Rd,Od={successServerIds:{type:"object"},failServerIds:{type:"object"},ackTimestamp:{type:"number"}};function formatClearServersUnread(e){return format(Od,e)}!function(e){e[e.everyone=1]="everyone",e[e.custom=2]="custom"}(Nd||(Nd={})),function(e){e[e.normal=0]="normal",e[e.owner=1]="owner"}(Ad||(Ad={})),function(e){e[e.ignore=0]="ignore",e[e.deny=-1]="deny",e[e.allow=1]="allow"}(bd||(bd={})),function(e){e[e.manageServer=1]="manageServer",e[e.manageChannel=2]="manageChannel",e[e.manageRole=3]="manageRole",e[e.sendMsg=4]="sendMsg",e[e.accountInfoSelf=5]="accountInfoSelf",e[e.inviteServer=6]="inviteServer",e[e.kickServer=7]="kickServer",e[e.accountInfoOther=8]="accountInfoOther",e[e.recallMsg=9]="recallMsg",e[e.deleteMsg=10]="deleteMsg",e[e.remindOther=11]="remindOther",e[e.remindEveryone=12]="remindEveryone",e[e.manageBlackWhiteList=13]="manageBlackWhiteList",e[e.banServerMember=14]="banServerMember",e[e.RTCChannelConnect=15]="RTCChannelConnect",e[e.RTCChannelDisconnectOther=16]="RTCChannelDisconnectOther",e[e.RTCChannelOpenMicrophone=17]="RTCChannelOpenMicrophone",e[e.RTCChannelOpenCamera=18]="RTCChannelOpenCamera",e[e.RTCChannelOpenCloseOtherMicrophone=19]="RTCChannelOpenCloseOtherMicrophone",e[e.RTCChannelOpenCloseOtherCamera=20]="RTCChannelOpenCloseOtherCamera",e[e.RTCChannelOpenCloseEveryoneMicrophone=21]="RTCChannelOpenCloseEveryoneMicrophone",e[e.RTCChannelOpenCloseEveryoneCamera=22]="RTCChannelOpenCloseEveryoneCamera",e[e.RTCChannelOpenShareScreen=23]="RTCChannelOpenShareScreen",e[e.RTCChannelCloseOtherShareScreen=24]="RTCChannelCloseOtherShareScreen",e[e.manageInviteApply=25]="manageInviteApply",e[e.manageInviteApplyHistory=26]="manageInviteApplyHistory",e[e.mentionedRole=27]="mentionedRole"}(Rd||(Rd={}));var Pd,Vd,kd,wd,Ld,Dd,Ud,qd,xd={type:{type:"enum",values:Nd},memberType:{type:"enum",values:Ad},createTime:{type:"number"},updateTime:{type:"number"},priority:{type:"number"},memberCount:{type:"number"},joinTime:{type:"number"}},Bd={roleId:{type:"string"},categoryId:{type:"string"},serverId:{type:"string"},type:{type:"enum",values:Nd},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},name:{type:"string"},icon:{type:"string"},ext:{type:"string"}},Fd={id:{type:"string"},accid:{type:"string"},categoryId:{type:"string"},serverId:{type:"string"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},nick:{type:"string"},avatar:{type:"string"},ext:{type:"string"},memberType:{type:"enum",values:Ad},joinTime:{type:"number"},inviter:{type:"string"}};function generatorRoleForCmd(e){var t=Object.assign({},e),r=formatReverse(xd,t);return r.auths&&(r.auths=function generateRoleAuthsForCmd(e){var t=Object.keys(e).reduce(((t,r)=>{var i=Rd[r];return i?t[i]=bd[e[r]]:t[r]=bd[e[r]],t}),{});return JSON.stringify(t)}(r.auths)),r}function formatRoleAuths(e){return Object.keys(e).reduce(((t,r)=>{var i=getEnumKeyByEnumValue(Rd,r);i?t[i]=bd[e[r]]:t[parseInt(r)]=bd[e[r]];return t}),{})}function formatRole(e){var t=format(xd,e);return e.auths&&(t.auths=formatRoleAuths(JSON.parse(t.auths))),t.isMember&&delete t.isMember,t}function formatRoles(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatRole(e))):[]}function formatChannelCategoryRole(e){return e.auths&&(e.auths=formatRoleAuths(JSON.parse(e.auths))),format(Bd,e)}function formatChannelCategoryMemberRole(e){return e.auths&&(e.auths=formatRoleAuths(JSON.parse(e.auths))),format(Fd,e)}function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}!function(e){e[e.default=1]="default",e[e.sync=2]="sync"}(Pd||(Pd={})),function(e){e[e.sendTime=1]="sendTime"}(Vd||(Vd={})),function(e){e[e.text=0]="text",e[e.image=1]="image",e[e.audio=2]="audio",e[e.video=3]="video",e[e.geo=4]="geo",e[e.notification=5]="notification",e[e.file=6]="file",e[e.tip=10]="tip",e[e.robot=11]="robot",e[e.g2=12]="g2",e[e.custom=100]="custom"}(kd||(kd={})),function(e){e[e.sending=1]="sending",e[e.success=2]="success",e[e.failed=3]="failed"}(wd||(wd={})),function(e){e[e.notifyAll=1]="notifyAll",e[e.notifySubscribe=2]="notifySubscribe"}(Ld||(Ld={})),function(e){e[e.unknown=0]="unknown",e[e.server=1]="server",e[e.channel=2]="channel",e[e.serverAccids=3]="serverAccids",e[e.channelAccids=4]="channelAccids",e[e.accids=5]="accids"}(Dd||(Dd={})),function(e){e[e.serverMemberInvite=1]="serverMemberInvite",e[e.serverMemberInviteReject=2]="serverMemberInviteReject",e[e.serverMemberApply=3]="serverMemberApply",e[e.serverMemberApplyReject=4]="serverMemberApplyReject",e[e.serverCreate=5]="serverCreate",e[e.serverRemove=6]="serverRemove",e[e.serverUpdate=7]="serverUpdate",e[e.serverMemberInviteDone=8]="serverMemberInviteDone",e[e.serverMemberInviteAccept=9]="serverMemberInviteAccept",e[e.serverMemberApplyDone=10]="serverMemberApplyDone",e[e.serverMemberApplyAccept=11]="serverMemberApplyAccept",e[e.serverMemberKick=12]="serverMemberKick",e[e.serverMemberLeave=13]="serverMemberLeave",e[e.serverMemberUpdate=14]="serverMemberUpdate",e[e.channelCreate=15]="channelCreate",e[e.channelRemove=16]="channelRemove",e[e.channelUpdate=17]="channelUpdate",e[e.channelUpdateWhiteBlackIdentify=18]="channelUpdateWhiteBlackIdentify",e[e.channelUpdateWhiteBlackIdentifyUser=19]="channelUpdateWhiteBlackIdentifyUser",e[e.updateQuickComment=20]="updateQuickComment",e[e.channelCategoryCreate=21]="channelCategoryCreate",e[e.channelCategoryRemove=22]="channelCategoryRemove",e[e.channelCategoryUpdate=23]="channelCategoryUpdate",e[e.channelCategoryUpdateWhiteBlackIdentify=24]="channelCategoryUpdateWhiteBlackIdentify",e[e.channelCategoryUpdateWhiteBlackIdentifyUser=25]="channelCategoryUpdateWhiteBlackIdentifyUser",e[e.serverIdentifyAdd=26]="serverIdentifyAdd",e[e.serverIdentifyRemove=27]="serverIdentifyRemove",e[e.serverIdentifyUpdate=28]="serverIdentifyUpdate",e[e.channelIdentifyUpdate=29]="channelIdentifyUpdate",e[e.userIdentifyUpdate=30]="userIdentifyUpdate",e[e.channelVisibilityUpdate=31]="channelVisibilityUpdate",e[e.serverEnterLeave=32]="serverEnterLeave",e[e.serverMemberJoinByInviteCode=33]="serverMemberJoinByInviteCode",e[e.channelVisibilityToVisitorUpdate=34]="channelVisibilityToVisitorUpdate",e[e.myMemberInfoUpdated=35]="myMemberInfoUpdated",e[e.custom=100]="custom",e[e.msgTyping=101]="msgTyping"}(Ud||(Ud={})),function(e){e[e.reply=1]="reply",e[e.thread=2]="thread",e[e.all=3]="all"}(qd||(qd={}));var Gd=Math.max,jd=Math.min;function debounce(e,t,r){var i,n,a,s,o,c,d=0,l=!1,m=!1,p=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function invokeFunc(t){var r=i,a=n;return i=n=void 0,d=t,s=e.apply(a,r)}function leadingEdge(e){return d=e,o=setTimeout(timerExpired,t),l?invokeFunc(e):s}function shouldInvoke(e){var r=e-c;return void 0===c||r>=t||r<0||m&&e-d>=a}function timerExpired(){var e=Date.now();if(shouldInvoke(e))return trailingEdge(e);o=setTimeout(timerExpired,function remainingWait(e){var r=t-(e-c);return m?jd(r,a-(e-d)):r}(e))}function trailingEdge(e){return o=void 0,p&&i?invokeFunc(e):(i=n=void 0,s)}function debounced(){var e=Date.now(),r=shouldInvoke(e);if(i=arguments,n=this,c=e,r){if(void 0===o)return leadingEdge(c);if(m)return clearTimeout(o),o=setTimeout(timerExpired,t),invokeFunc(c)}return void 0===o&&(o=setTimeout(timerExpired,t)),s}return t=Number(t)||0,isObject(r)&&(l=!!r.leading,a=(m="maxWait"in r)?Gd(Number(r.maxWait)||0,t):a,p="trailing"in r?!!r.trailing:p),debounced.cancel=function cancel(){void 0!==o&&clearTimeout(o),d=0,i=c=n=o=void 0},debounced.flush=function flush(){return void 0===o?s:trailingEdge(Date.now())},debounced}var Hd,Yd,$d;function throttle(e,t,r){var i=!0,n=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return isObject(r)&&(i="leading"in r?!!r.leading:i,n="trailing"in r?!!r.trailing:n),debounce(e,t,{leading:i,maxWait:t,trailing:n})}!function(e){e[e.sub=1]="sub",e[e.unSub=2]="unSub"}(Hd||(Hd={}));class UnreadInfoModuleService{constructor(e){this.unreadCount={},this.manualSubscribeUnreadMap={},this.manualSubscribeServerMap={},this.manualSubscribeTypingMap={},this.unreadServerCount={},this.serverRoleIdsMap={},this.autoSubscribeUnreadMap={},this.autoSubscribeServerMap={},this._serverUnreadInfo=throttle((e=>{this.core.emit("serverUnreadInfo",this.getServerUnreadInfo(e)),Ne(this.core,"qchatServer.emit")&&this.core.qchatServer.emit("serverUnreadInfo",this.getServerUnreadInfo(e))}),100),this.core=e}changeCacheServerRoleIds(e){return __awaiter(this,void 0,void 0,(function*(){var{serverId:t,roleId:r}=e.attach.serverIdentifyInfo;this.serverRoleIdsMap[t]||(yield this.getRoleIdsByServerId([t]));var i=this.serverRoleIdsMap[t];if(!(e.time<i.timeTag)){e.type===Ud[Ud.serverIdentifyAdd]?i.roleIds.add(r):i.roleIds.delete(r),this.core.logger.debug(`QChatChannel::qchatChannel/serverIdentifyChange::now ${t} roleIds is`,[...i.roleIds]);var n=this.unreadServerCount[t];if(n)ho(Object.keys(n),100).forEach((e=>{this.core.qchatChannel.getChannelUnreadInfos({channels:e.map((e=>({serverId:t,channelId:e})))})}))}}))}getRoleIdsByServerId(e){return __awaiter(this,void 0,void 0,(function*(){var t=e.filter((e=>!this.serverRoleIdsMap[e]));if(t.length){var r={serverIdTimeTags:t},i=yield this.core.sendCmd("qchatGetRoleIdsByServerId",{qchatGetRoleIdsByServerIdTag:r});this.core.logger.debug("QChatChannel:: getRoleIdsByServerId, params is ",r,"result is",i),i.content.serverRoles.forEach((e=>{try{e.roleIds=JSON.parse(e.roleIds)}catch(e){this.core.logger.error("QChatChannel:: getRoleIdsByServerId JSON parse roleIds error",e)}this.serverRoleIdsMap[e.serverId]={roleIds:new Set(e.roleIds),timeTag:e.timeTag}}))}}))}_unSubscribeChannel(e,t){return __awaiter(this,void 0,void 0,(function*(){var r=`${e}_${t}`,i=[];if(this.manualSubscribeUnreadMap[r]?i.push(this.manualSubscribeUnreadMap[r]):this.autoSubscribeUnreadMap[r]&&i.push(this.autoSubscribeUnreadMap[r]),this.manualSubscribeTypingMap[r]&&i.push(this.manualSubscribeTypingMap[r]),0!==i.length){for(var n of i)this.subscribe({opeType:Hd.unSub,type:n,channels:[{serverId:e,channelId:t}]});this.manualSubscribeUnreadMap[r]?this.manualSubscribeUnreadMap[r]=void 0:this.autoSubscribeUnreadMap[r]&&(this.autoSubscribeUnreadMap[r]=void 0),this.manualSubscribeTypingMap[r]&&(this.manualSubscribeTypingMap[r]=void 0)}}))}_unSubscribeServer(e){return __awaiter(this,void 0,void 0,(function*(){var t=e,r=this.manualSubscribeServerMap[t]||this.autoSubscribeServerMap[t];r&&(this.subscribe({opeType:Hd.unSub,type:r,channels:[{serverId:e,channelId:""}]}),this.manualSubscribeServerMap[t]?this.manualSubscribeServerMap[t]=void 0:this.autoSubscribeServerMap[t]&&(this.autoSubscribeServerMap[t]=void 0))}))}subscribe(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number",min:1,max:5},opeType:{type:"number",min:1,max:2}},e);var t=yield this.core.sendCmd("qchatSubscribe",{qchatSubReqTag:{type:e.type,opeType:e.opeType},channels:e.channels}),r=new Set;return e.channels.forEach((e=>__awaiter(this,void 0,void 0,(function*(){this.serverRoleIdsMap[e.serverId]||r.add(e.serverId)})))),ho(Array.from(r),10).forEach((e=>{this.getRoleIdsByServerId(e)})),t.content}))}autoSubscribe(){return __awaiter(this,void 0,void 0,(function*(){yield this.core.sendCmd("qchatAutoSubscribe",{qchatAutoSubReqTag:{}})}))}resumeSubscribe(e){return __awaiter(this,void 0,void 0,(function*(){this.serverRoleIdsMap={};if(!e)return this.unreadServerCount={},void(this.unreadCount={});var t={};Object.keys(this.manualSubscribeUnreadMap).forEach((e=>{var r=this.manualSubscribeUnreadMap[e];if(r){var[i,n]=e.split("_"),a={serverId:i,channelId:n};t[r]=t[r]||[],t[r].push(a)}})),t[5]=[],Object.keys(this.manualSubscribeTypingMap).forEach((e=>__awaiter(this,void 0,void 0,(function*(){if(this.manualSubscribeTypingMap[e]){var[r,i]=e.split("_"),n={serverId:r,channelId:i};t[5].push(n)}})))),t[4]=[],Object.keys(this.manualSubscribeServerMap).forEach((e=>__awaiter(this,void 0,void 0,(function*(){if(this.manualSubscribeServerMap[e]){var r={serverId:e};t[4].push(r)}}))));var r=[];Object.keys(t).forEach((e=>{var i=t[e];return i&&0===i.length?Promise.resolve():i.length>100?ho(i,100).forEach((t=>{r.push(this.createSubscribePromise(t,e))})):void r.push(this.createSubscribePromise(i,e))})),yield Promise.all(r)}))}createSubscribePromise(e,t){var r={type:parseInt(t),opeType:1,channels:e};return this.core.logger.debug("qchatChannel:: autoSubscribeUnread params",r),this.subscribe(r).then((({unreadInfos:e})=>{e&&e.length>0&&(e=formatUnreadInfos(e),this.updateUnreads(e))})).catch((e=>{this.core.logger.error("qchatChannel:: autoSubscribeUnread error ",e)}))}cacheSubscribe(e){e.channels.forEach((t=>{var r=t.channelId?`${t.serverId}_${t.channelId}`:`${t.serverId}`,i=5===e.type?this.manualSubscribeTypingMap:4===e.type?this.manualSubscribeServerMap:this.manualSubscribeUnreadMap;e.opeType===Hd.sub?i[r]=e.type:e.opeType===Hd.unSub&&(i[r]=void 0)}))}cacheAutoSubscribe(e){e.channels.forEach((t=>{var r=t.channelId?`${t.serverId}_${t.channelId}`:`${t.serverId}`,i=4===e.type?this.autoSubscribeServerMap:this.autoSubscribeUnreadMap;e.opeType===Hd.sub?i[r]=e.type:e.opeType===Hd.unSub&&(i[r]=void 0)}))}cacheUnreadCount(e){e.forEach((e=>{var t=`${e.serverId}_${e.channelId}`;this.unreadCount[t]=Object.assign({},e),this.unreadServerCount[e.serverId]||(this.unreadServerCount[e.serverId]={}),this.unreadServerCount[e.serverId][e.channelId]=!0}))}getServerUnreadInfo(e){var t={serverId:e,unreadCount:0,mentionedCount:0,maxCount:0},r=this.unreadServerCount[e];return r&&(Object.keys(r).forEach((r=>{var i=`${e}_${r}`,n=this.unreadCount[i];t.unreadCount+=n.unreadCount,t.mentionedCount+=n.mentionedCount,void 0!==n.maxCount&&(t.maxCount=n.maxCount)})),t.unreadCount=t.unreadCount>t.maxCount?t.maxCount:t.unreadCount,t.mentionedCount=t.mentionedCount>t.maxCount?t.maxCount:t.mentionedCount),t}getUnreadInfo(e){validate({serverId:{type:"string"},channelId:{type:"string"}},e);var t=`${e.serverId}_${e.channelId}`;return this.unreadCount[t]?this.unreadCount[t]:null}shouldChangeUnread(e,t){if(!e.serverId||!e.channelId)return!1;if(this.core.qchatChannel.subscribeForVisitorService.isInSubscribeChannels(e.serverId,e.channelId))return!1;if(!1===e.historyEnable)return!1;if(!1===e.needBadge)return!1;if(e.fromAccount===this.core.account)return!1;if(t&&2!==(null==e?void 0:e.status))return!1;if(e.notifyReason&&e.notifyReason===getEnumKeyByEnumValue(Ld,Ld.notifySubscribe)){if(!e.serverId||!e.channelId)return!1;var r=this.getUnreadInfo({serverId:e.serverId,channelId:e.channelId}),i=t?"ackTimestamp":"lastMsgTime";if(!r)return!1;if(e.time&&r[i]&&r[i]>e.time)return!1}return!0}shouldChangeMentionedUnread(e,t=!1){return __awaiter(this,void 0,void 0,(function*(){if(e.accidsOfMentionedRoles&&e.accidsOfMentionedRoles.includes(this.core.account))return!0;if(e.mentionRoleIds&&e.serverId){if(!this.serverRoleIdsMap[e.serverId]){if(!t)return this.handledRoleMsg(e),!1;yield this.getRoleIdsByServerId([e.serverId])}for(var r=0;r<e.mentionRoleIds.length;r++)if(this.serverRoleIdsMap[e.serverId].roleIds.has(e.mentionRoleIds[r]))return!0}return!1}))}handledRoleMsg(e){return __awaiter(this,void 0,void 0,(function*(){if(e.mentionRoleIds)if(this.serverRoleIdsMap[e.serverId]||(yield this.getRoleIdsByServerId([e.serverId])),this.serverRoleIdsMap[e.serverId]){var t=!1;if(e.mentionRoleIds.forEach((r=>{this.serverRoleIdsMap[e.serverId].roleIds.has(r)&&(t=!0,this.core.logger.debug("QChatChannel::handledRoleMsg::will update message mentionedCount，message is ",e))})),t){var r=this.unreadCount[`${e.serverId}_${e.channelId}`],i=2===(null==e?void 0:e.status);if(r.mentionedCount=i?r.mentionedCount?r.mentionedCount-1:0:r.mentionedCount?r.mentionedCount+1:1,"number"==typeof r.maxCount){var n=r.mentionedCount;if((n=n>r.maxCount?r.maxCount:n)>r.maxCount)return void this.core.logger.debug("QChatChannel::handledRoleMsg::tempUnreadCount more than maxCount");this.core.emit("unreadInfo",Object.assign(Object.assign({},r),{mentionedCount:n})),this.core.emit("unreadInfos",[Object.assign(Object.assign({},r),{mentionedCount:n})]),this.core.qchatChannel.emit("unreadInfos",[Object.assign(Object.assign({},r),{mentionedCount:n})]),this._serverUnreadInfo(e.serverId)}}}else this.core.logger.warn("QChatChannel::handledRoleMsg::can not get serverRoleIds,server id",e.serverId)}))}getMentionedFlag(e,t=!1){return __awaiter(this,void 0,void 0,(function*(){return!!e.mentionAll||(e.mentionRoleIds||e.accidsOfMentionedRoles?yield this.shouldChangeMentionedUnread(e,t):!(!e.mentionAccids||!e.mentionAccids.includes(this.core.account)))}))}changeUnread(e,t){return __awaiter(this,void 0,void 0,(function*(){var r=e.serverId,i=e.channelId,n=`${r}_${i}`;if(this.shouldChangeUnread(e,t)){if(!this.unreadCount[n])return yield this.core.qchatChannel.getChannelUnreadInfos({channels:[{serverId:r,channelId:i}]}),void(!this.serverRoleIdsMap[r]&&e.mentionRoleIds&&this.getRoleIdsByServerId([r]));var a=this.unreadCount[n],s=2===(null==e?void 0:e.status),o=yield this.getMentionedFlag(e);s?(a.unreadCount=a.unreadCount?a.unreadCount-1:0,o&&(a.mentionedCount=a.mentionedCount?a.mentionedCount-1:0),delete a.lastMsgTime,this.core.logger.debug(`changeUnread: ${n} unread reduce `,a)):(a.unreadCount=a.unreadCount?a.unreadCount+1:1,o&&(a.mentionedCount=a.mentionedCount?a.mentionedCount+1:1),e.time&&(a.lastMsgTime=e.time),this.core.logger.debug(`changeUnread: ${n} unread add `,a));var c="number"==typeof a.maxCount?a.maxCount:100;a.unreadCount>c?this.core.logger.debug("QChatChannel::subscribe::tempUnreadCount more than maxCount"):(this.core.logger.warn("unreadInfo event will abandon,please use unreadInfos"),this.core.emit("unreadInfo",Object.assign(Object.assign({},a),{mentionedCount:a.mentionedCount>c?c:a.mentionedCount,unreadCount:a.unreadCount>c?c:a.unreadCount})),this.core.emit("unreadInfos",[Object.assign(Object.assign({},a),{mentionedCount:a.mentionedCount>c?c:a.mentionedCount,unreadCount:a.unreadCount>c?c:a.unreadCount})]),this.core.qchatChannel.emit("unreadInfos",[Object.assign(Object.assign({},a),{mentionedCount:a.mentionedCount>c?c:a.mentionedCount,unreadCount:a.unreadCount>c?c:a.unreadCount})]),this._serverUnreadInfo(r))}else this.core.logger.debug(`changeUnread: ${n} does not need to update unreadInfo`)}))}updateUnreads(e){if(e&&e.length>0){var t=[],r=[],i=e.filter((e=>{var t=`${e.serverId}_${e.channelId}`,r=this.unreadCount[t],i=Ne(r,"ackTimestamp"),n=Ne(e,"ackTimestamp");return!(i&&n&&n<i)&&(Ne(r,"unreadCount")!==Ne(e,"unreadCount")||Ne(r,"mentionedCount")!==Ne(e,"mentionedCount"))})).map((e=>{t.push(this.getServerUnreadInfo(e.serverId)),r.push(this.unreadServerCount[e.serverId]);var i=e.serverId,n=e.channelId,a=`${i}_${n}`;return this.core.logger.debug("qchat channel updateUnread: ",e),this.unreadCount[a]=Object.assign({},e),this.unreadServerCount[i]||(this.unreadServerCount[i]={}),this.unreadServerCount[i][n]=!0,e}));if(0!==i.length){this.core.emit("unreadInfos",i),this.core.qchatChannel.emit("unreadInfos",i);var n={};i.forEach(((e,i)=>{this.core.emit("unreadInfo",e);var a=t[i],s=r[i],o=this.getServerUnreadInfo(e.serverId),c=this.unreadServerCount[e.serverId],d=a.unreadCount!==o.unreadCount,l=!s||0===Object.keys(s).length,m=c&&Object.keys(c).length>0,p=a.mentionedCount!==o.mentionedCount;(d||p||l&&m)&&(n[e.serverId]=!0)})),Object.keys(n).forEach((e=>{this.core.emit("serverUnreadInfo",this.getServerUnreadInfo(e)),Ne(this.core,"qchatServer.emit")&&this.core.qchatServer.emit("serverUnreadInfo",this.getServerUnreadInfo(e))}))}}}clearUnreadCountByServers(e,t){var r=[];e.forEach((e=>{this.unreadServerCount[e]&&Object.keys(this.unreadServerCount[e]).forEach((t=>{r.push(`${e}_${t}`)}))}));var i=[];r.forEach((e=>{i.push(Object.assign(Object.assign({},this.unreadCount[e]),{unreadCount:0,mentionedCount:0,ackTimestamp:t}))})),this.updateUnreads(i)}}class SubscribeForVisitorService{constructor(e){this.limitForBatchEnter=10,this.limitForBatchSubscribe=100,this.autoServers=new Set,this.autoVisitorSubscribeServer=new Set,this.autoVisitorSubscribeChannel=new Set,this.core=e}subscribeChannelAsVisitor(e){return __awaiter(this,void 0,void 0,(function*(){var t=(yield this.core.sendCmd("qchatSubscribeAsVisitor",{tag:{type:e.type||6,opeType:e.opeType},datas:e.channels})).content.failedArr;return e.channels.filter((e=>!t.some((t=>t.channelId===e.channelId&&t.serverId===e.serverId)))).forEach((t=>{1===e.opeType?this.autoVisitorSubscribeChannel.add(`${t.serverId}&${t.channelId}`):this.autoVisitorSubscribeChannel.delete(`${t.serverId}&${t.channelId}`)})),{failedChannels:t}}))}subscribeServerAsVisitor(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.sendCmd("qchatSubscribeAsVisitor",{tag:{type:e.type||7,opeType:e.opeType},datas:e.serverIds.map((e=>({serverId:e})))}),r=t.content.failedArr;return e.serverIds.filter((e=>!r.some((t=>t.serverId===e)))).forEach((t=>{1===e.opeType?this.autoVisitorSubscribeServer.add(t):this.autoVisitorSubscribeServer.delete(t)})),{failedServers:t.content.failedArr.map((e=>e.serverId))}}))}deleteServer(e){this.autoServers.delete(e),this.autoVisitorSubscribeServer.has(e)&&this.subscribeServerAsVisitor({opeType:2,serverIds:[e]});var t=[];this.autoVisitorSubscribeChannel.forEach((r=>{if(0===r.indexOf(e)){var i=r.replace(`${e}&`,"");t.push({serverId:e,channelId:i})}})),t.length>0&&this.subscribeChannelAsVisitor({opeType:2,channels:t})}deleteAutoSetInServerId(e){this.autoServers.delete(e),this.autoVisitorSubscribeServer.delete(e),this.autoVisitorSubscribeChannel.forEach((t=>{0===t.indexOf(e)&&this.autoVisitorSubscribeChannel.delete(t)}))}deleteAutoSetInChannel(e,t){this.autoVisitorSubscribeChannel.delete(`${e}&${t}`)}unSubscribeChannel(e,t){this.subscribeChannelAsVisitor({opeType:2,channels:[{serverId:e,channelId:t}]})}isInSubscribeChannels(e,t){return this.autoVisitorSubscribeChannel.has(`${e}&${t}`)}isInAutoServers(e){return this.autoServers.has(e)}doAutoSubscribe(){var e=[];return ho(Array.from(this.autoVisitorSubscribeServer),this.limitForBatchSubscribe).forEach((t=>{e.push(this.subscribeServerAsVisitor({opeType:1,serverIds:t}))})),ho(Array.from(this.autoVisitorSubscribeChannel),this.limitForBatchSubscribe).forEach((t=>{e.push(this.subscribeChannelAsVisitor({opeType:1,channels:t.map((e=>{var t=e.indexOf("&");return{serverId:e.slice(0,t),channelId:e.slice(t+1)}}))}))})),Promise.all(e)}doAutoEnterServer(){return __awaiter(this,void 0,void 0,(function*(){var e=ho(Array.from(this.autoServers),this.limitForBatchEnter),t=[];e.forEach((e=>{t.push(this.core.qchatServer.enterAsVisitor({serverIds:e}))})),(yield Promise.all(t)).forEach((e=>{e.failedServers.forEach((e=>{this.deleteAutoSetInServerId(e)}))}))}))}resumeSubscribe(e){return __awaiter(this,void 0,void 0,(function*(){e?(yield this.doAutoEnterServer(),yield this.doAutoSubscribe()):(this.autoServers.clear(),this.autoVisitorSubscribeChannel.clear(),this.autoVisitorSubscribeServer.clear())}))}cacheServer(e){e.forEach((e=>this.autoServers.add(e)))}}!function(e){e.UNKNOWN="UNKNOWN",e.LOGIN_STATE_ERROR="LOGIN_STATE_ERROR",e.CLOSE_BY_BACKEND="CLOSE_BY_BACKEND",e.ALL_MEMBERS_OUT="ALL_MEMBERS_OUT",e.END_OF_LIFE="END_OF_LIFE",e.CLOSE_BY_MEMBER="CLOSE_BY_MEMBER",e.KICK_OUT="KICK_OUT",e.SYNC_DATA_ERROR="SYNC_DATA_ERROR",e.LEAVE_BY_SELF="LEAVE_BY_SELF",e.kICK_BY_SELF="kICK_BY_SELF"}(Yd||(Yd={})),function(e){e.offNotAllowSelfOn="offNotAllowSelfOn",e.offAllowSelfOn="offAllowSelfOn",e.disable="disable"}($d||($d={}));var Wd={serverId:{type:"string"},uid:{type:"string"},accid:{type:"string"},nick:{type:"string"},avatar:{type:"string"},ext:{type:"string"},type:{type:"number"},joinTime:{type:"number"},inviter:{type:"string"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}},zd={limit:{type:"number"}};function formatMembers(e){return Array.isArray(e)&&e.length>0?e.map((e=>function formatMember(e){return format(Wd,e)}(e))):[]}var Kd={"25_1":"qchatGetNeroomToken","25_2":"qchatUpdateRTCChannelConfig","25_3":"qchatGetRTCChannelConfig","25_4":"qchatGetRTCChannelMembers"},Jd={QChatRTCChannelConfigTag:{serverId:1,channelId:2,limit:3,audio:4,video:5},QChatRTCChannelConfigResultTag:{limit:1,audio:2,video:3},QChatGetRTCParams:{serverId:1,channelId:2},qchatGetRTCChannelMembersTag:{serverId:1,channelId:2},memberInfo:{serverId:1,accid:3,nick:4,avatar:5,ext:6,type:7,joinTime:8,inviter:9,validFlag:10,createTime:11,updateTime:12},QChatGetNeroomTokenResultTag:{token:1,expire:2},QChatGetNeroomTokenParams:{neroomDeviceId:1}},getCmdConfig$3=()=>{var e=invertSerializeMap(Jd);return{qchatGetNeroomToken:{sid:25,cid:1,service:"qchatMedia",params:[{type:"Property",name:"qchatGetNeroomTokenTag",reflectMapper:Jd.QChatGetNeroomTokenParams}],response:[{type:"Property",name:"neroomToken",reflectMapper:e.QChatGetNeroomTokenResultTag}]},qchatUpdateRTCChannelConfig:{sid:25,cid:2,service:"qchatMedia",params:[{type:"Property",name:"RTCChannelConfig",reflectMapper:Jd.QChatRTCChannelConfigTag}]},qchatGetRTCChannelConfig:{sid:25,cid:3,service:"qchatMedia",params:[{type:"Property",name:"qchatGetRTCChannelConfigTag",reflectMapper:Jd.QChatGetRTCParams}],response:[{type:"Property",name:"RTCChannelConfig",reflectMapper:e.QChatRTCChannelConfigResultTag}]},qchatGetRTCChannelMembers:{sid:25,cid:4,service:"qchatMedia",params:[{type:"Property",name:"qchatGetRTCChannelMembersTag",reflectMapper:Jd.QChatGetRTCParams}],response:[{type:"PropertyArray",name:"memberList",reflectMapper:e.memberInfo}]}}};var Qd,Xd={"24_10":"qchatSendMsg","24_11":"qchatOnMsg","24_12":"qchatOnRecvUnreadInfo","24_13":"qchatSendCustomSysMsg","24_14":"qchatOnSysMsg","24_16":"qchatGetHistoryMsg","24_17":"qchatMarkMessageRead","24_18":"qchatMultiSyncMessageRead","24_22":"qchatUpdateSystemNotification","24_23":"qchatMultiSyncSystemNotificationUpdate","24_24":"qchatSyncSystemNotification","24_25":"qchatUpdateMessage","24_26":"qchatRecvMessageUpdate","24_28":"qchatMarkSysMsgRead","24_94":"qchatMessageSearchByPage","24_100":"qchatGetMessageHistoryByIds","24_101":"qchatGetThreadMessages","24_102":"qchatUpdateQuickComment","24_103":"qchatGetQuickComments","24_108":"qchatGetThreadRootMessagesMeta","24_121":"qchatGetLastMessageOfChannels","24_127":"qchatGetMentionedMeMessages","25_6":"qchatMultiSyncServersMessageRead"},Zd={getHistoryMsgTag:{serverId:1,channelId:2,beginTime:3,endTime:4,excludeMsgId:5,limit:6,reverse:7},getThreadHistoryMsgTag:{beginTime:1,endTime:2,excludeMsgId:3,limit:4,reverse:5},qchatMsgTag:{serverId:1,channelId:2,fromAccount:3,fromClientType:4,fromDeviceId:5,fromNick:6,time:7,updateTime:8,type:9,body:10,attach:11,ext:12,msgIdClient:13,msgIdServer:14,resendFlag:15,status:16,pushPayload:17,pushContent:18,mentionAccids:19,mentionAll:20,env:21,callbackExt:22,replyMsgFromAccount:23,replyMsgTime:24,replyMsgIdServer:25,replyMsgIdClient:26,threadMsgFromAccount:27,threadMsgTime:28,threadMsgIdServer:29,threadMsgIdClient:30,useCustomContent:31,antiSpamContent:32,antiSpamBusinessId:33,antiSpamUsingYidun:34,yidunCallback:35,yidunAntiCheating:36,yidunAntiSpamExt:37,yidunAntiSpamRes:38,mentionRoleIds:41,accidsOfMentionedRoles:42,updateContent:39,updateOperatorInfo:40,subType:61,historyEnable:100,pushEnable:101,needBadge:102,needPushNick:103,notifyReason:104,routeEnable:105,isAntispam:106},sysMsg:{toType:1,serverId:2,channelId:3,toAccids:4,fromAccount:5,fromClientType:6,fromDeviceId:7,fromNick:8,time:9,updateTime:10,type:11,msgIdClient:12,msgIdServer:13,body:14,attach:15,ext:16,resendFlag:17,status:18,pushPayload:19,pushContent:20,env:21,callbackExt:22,persistEnable:100,pushEnable:101,needBadge:102,needPushNick:103,routeEnable:104},qchatMsgUpdateTag:{operatorAccount:1,operatorClientType:2,ps:3,ext:4,pushContent:5,pushPayload:6,env:7,routeEnable:100},markMsgReadTag:{serverId:1,channelId:2,time:3},qchatQuickCommentRequestTag:{serverId:1,channelId:2,fromAccount:3,msgIdServer:4,time:5,type:6,opeType:7,opeAccid:8},qchatQuickCommentQueryTag:{serverId:1,channelId:2,msgIdServerList:3},qchatGetLastMessageOfChannelsTag:{serverId:1,channelIdList:2},qchatMultiSyncServersMessageReadTag:{successServerIds:1,failServerIds:2,ackTimestamp:3},qchatMessageSearchByPageTag:{keyword:1,serverId:2,channelId:3,fromAccid:4,fromTime:5,toTime:6,msgTypes:7,subTypes:8,includeSelf:9,order:10,limit:11,sort:12,cursor:13},qchatPageQueryTag:{hasMore:1,nextTimetag:2,cursor:3},unreadInfo:hd},getDeserializeTag$2=()=>invertSerializeMap(Zd),getCmdConfig$2=()=>{var e=getDeserializeTag$2();return{qchatSendMsg:{service:"qchatMsg",sid:24,cid:10,params:[{type:"Property",name:"qchatMsg",reflectMapper:Zd.qchatMsgTag}],response:[{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatOnMsg:{service:"qchatMsg",sid:24,cid:11,response:[{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatOnRecvUnreadInfo:{service:"qchatMsg",sid:24,cid:12,response:[{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatSendCustomSysMsg:{service:"qchatMsg",sid:24,cid:13,params:[{type:"Property",name:"sysMsg",reflectMapper:Zd.sysMsg}],response:[{type:"Property",name:"sysMsg",reflectMapper:e.sysMsg}]},qchatOnSysMsg:{service:"qchatMsg",sid:24,cid:14,response:[{type:"Property",name:"sysMsg",reflectMapper:e.sysMsg}]},qchatGetHistoryMsg:{service:"qchatMsg",sid:24,cid:16,params:[{type:"Property",name:"getHistoryMsgTag",reflectMapper:Zd.getHistoryMsgTag}],response:[{type:"PropertyArray",name:"qchatMsgs",reflectMapper:e.qchatMsgTag}]},qchatUpdateMessage:{service:"qchatMsg",sid:24,cid:25,params:[{type:"Property",name:"qchatMsgUpdateTag",reflectMapper:Zd.qchatMsgUpdateTag},{type:"Property",name:"qchatMsg",reflectMapper:Zd.qchatMsgTag}],response:[{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatRecvMessageUpdate:{service:"qchatMsg",sid:24,cid:26,response:[{type:"Property",name:"qchatMsgUpdateInfo",reflectMapper:e.qchatMsgUpdateTag},{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatMarkMessageRead:{sid:24,cid:17,service:"qchatMsg",params:[{type:"Property",name:"markMsgReadTag",reflectMapper:Zd.markMsgReadTag}],response:[{type:"Property",name:"unreadInfo",reflectMapper:e.unreadInfo}]},qchatMultiSyncMessageRead:{sid:24,cid:18,service:"qchatMsg",response:[{type:"Property",name:"unreadInfo",reflectMapper:e.unreadInfo}]},qchatUpdateSystemNotification:{service:"qchatMsg",sid:24,cid:22,params:[{type:"Property",name:"qchatMsgUpdateTag",reflectMapper:Zd.qchatMsgUpdateTag},{type:"Property",name:"sysMsg",reflectMapper:Zd.sysMsg}],response:[{type:"Property",name:"sysMsg",reflectMapper:e.sysMsg}]},qchatMultiSyncSystemNotificationUpdate:{service:"qchatMsg",sid:24,cid:23,response:[{type:"Property",name:"qchatMsgUpdateTag",reflectMapper:e.qchatMsgUpdateTag},{type:"Property",name:"sysMsg",reflectMapper:e.sysMsg}]},qchatSyncSystemNotification:{service:"qchatMsg",sid:24,cid:24,response:[{type:"PropertyArray",name:"systemNotifications",reflectMapper:e.sysMsg}]},qchatMarkSysMsgRead:{service:"qchatMsg",sid:24,cid:28,params:[{type:"PropertyArray",name:"sysMsgs",reflectMapper:Zd.sysMsg}]},qchatMessageSearchByPage:{service:"qchatMsg",sid:24,cid:94,params:[{type:"Property",name:"qchatMessageSearchByPageTag",reflectMapper:Zd.qchatMessageSearchByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:e.qchatPageQueryTag},{type:"PropertyArray",name:"datas",reflectMapper:e.qchatMsgTag}]},qchatGetMessageHistoryByIds:{service:"qchatMsg",sid:24,cid:100,params:[{type:"Property",name:"channelInfo",reflectMapper:{serverId:1,channelId:2}},{type:"PropertyArray",name:"messageReferList",reflectMapper:{msgIdServer:1,time:2}}],response:[{type:"PropertyArray",name:"qchatMsgs",reflectMapper:e.qchatMsgTag}]},qchatGetThreadMessages:{service:"qchatMsg",sid:24,cid:101,params:[{type:"Property",name:"qchatMsg",reflectMapper:Zd.qchatMsgTag},{type:"Property",name:"getThreadHistoryMsgTag",reflectMapper:Zd.getThreadHistoryMsgTag}],response:[{type:"Property",name:"thread",reflectMapper:e.qchatMsgTag},{type:"Property",name:"threadInfo",reflectMapper:{1:"messageCount",2:"lastMessageTimestamp"}},{type:"PropertyArray",name:"qchatMsgs",reflectMapper:e.qchatMsgTag}]},qchatUpdateQuickComment:{service:"qchatMsg",sid:24,cid:102,params:[{type:"Property",name:"tag",reflectMapper:Zd.qchatQuickCommentRequestTag}]},qchatGetQuickComments:{service:"qchatMsg",sid:24,cid:103,params:[{type:"Property",name:"tag",reflectMapper:Zd.qchatQuickCommentQueryTag}],response:[{type:"PropertyArray",name:"quickCommentResponse",reflectMapper:{1:"serverId",2:"channelId",3:"msgIdServer",4:"totalCount",5:"lastUpdateTime",6:"details"}}]},qchatGetThreadRootMessagesMeta:{service:"qchatMsg",sid:24,cid:108,params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,channelId:2}},{type:"PropertyArray",name:"qchatMsgs",reflectMapper:{time:7,msgIdServer:14}}],response:[{type:"PropertyArray",name:"metas",reflectMapper:{1:"total",2:"timestamp",3:"msgIdServer",4:"msgTime"}}]},qchatGetLastMessageOfChannels:{service:"qchatMsg",sid:24,cid:121,params:[{type:"Property",name:"tag",reflectMapper:Zd.qchatGetLastMessageOfChannelsTag}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:e.qchatMsgTag}]},qchatMultiSyncServersMessageRead:{service:"qchatMsg",sid:25,cid:6,response:[{type:"Property",name:"qchatMultiSyncServersMessageReadTag",reflectMapper:e.qchatMultiSyncServersMessageReadTag}]},qchatGetMentionedMeMessages:{service:"qchatMsg",sid:24,cid:127,params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,channelId:2,timestamp:3,limit:4}}],response:[{type:"Property",name:"page",reflectMapper:e.qchatPageQueryTag},{type:"PropertyArray",name:"datas",reflectMapper:e.qchatMsgTag}]}}};!function(e){e[e.Android=1]="Android",e[e.iOS=2]="iOS",e[e.PC=4]="PC",e[e.WindowsPhone=8]="WindowsPhone",e[e.Web=16]="Web",e[e.Server=32]="Server",e[e.Mac=64]="Mac",e[e.HarmonyOS=65]="HarmonyOS"}(Qd||(Qd={}));var el={"24_31":"qchatCreateServer","24_32":"qchatDeleteServer","24_33":"qchatUpdateServer","24_34":"qchatGetServers","24_35":"qchatGetServersByPage","24_36":"qchatInviteServerMembers","24_37":"qchatAcceptServerInvite","24_38":"qchatRejectInviteServer","24_39":"qchatApplyServerJoin","24_40":"qchatAcceptServerApply","24_41":"qchatRejectServerApply","24_42":"qchatKickServerMembers","24_43":"qchatLeaveServer","24_44":"qchatUpdateMyMemberInfo","24_45":"qchatUpdateServerMemberInfo","24_46":"qchatGetServerMembers","24_47":"qchatGetServerMembersByPage","24_104":"qchatUpdateServerMemberBan","24_105":"qchatGetBannedMembersByPage","24_91":"qchatServerSearchByPage","24_92":"qchatServerMemberSearchByPage","24_122":"qchatGenerateInviteCode","24_123":"qchatJoinByInviteCode","24_124":"qchatGetInviteApplyRecordOfServer","24_125":"qchatGetInviteApplyRecordOfSelf","25_5":"qchatClearServersUnread","25_7":"qchatSubscribeChannelsByServers","25_10":"qchatEnterAsVisitor","25_11":"qchatLeaveAsVisitor"},tl={serverInfo:{serverId:1,name:3,icon:4,ext:5,owner:6,memberNumber:7,inviteMode:8,applyMode:9,validFlag:10,createTime:11,updateTime:12,channelNumber:13,categoryNumber:14,searchType:15,searchEnable:16,reorderWeight:17},antispamTag:{antiSpamBusinessId:1},memberInfo:{serverId:1,accid:3,nick:4,avatar:5,ext:6,type:7,joinTime:8,inviter:9,validFlag:10,createTime:11,updateTime:12},otherMemberInfo:{serverId:1,accid:3,nick:4,avatar:5,type:7,joinTime:8,inviter:9,validFlag:10,createTime:11,updateTime:12},getServerListPageTag:{timestamp:1,limit:2},getServerMemberListPageTag:{serverId:1,timetag:2,limit:3},updateServerMemberBanTag:{serverId:1,opeType:2,accid:3,ext:4},getBannedMembersByPageTag:{serverId:1,timetag:2,limit:3},serverMemberBanInfo:{serverId:1,appid:2,accid:3,ext:4,banTime:5,validFlag:6,createTime:7,updateTime:8},serverSearchByPageTag:{keyword:1,startTime:2,endTime:3,order:4,limit:5,serverType:6,searchType:7,sort:8,cursor:9},serverMemberSearchByPageTag:{serverId:1,keyword:3,limit:4},inviteRespParamTag:{requestId:1},applyRespParamTag:{requestId:1,expireTime:2},inviteApplyRecord:{accid:1,type:2,serverId:3,status:4,requestId:5,createTime:6,updateTime:7,expireTime:8,data:9,recordId:10},clearServersUnreadTag:{successServerIds:1,failServerIds:2,ackTimestamp:3},unreadInfo:hd},getDeserializeTag$1=()=>invertSerializeMap(tl),getCmdConfig$1=()=>{var e=getDeserializeTag$1();return{qchatCreateServer:{sid:24,cid:31,service:"qchatServer",params:[{type:"Property",name:"serverInfo",reflectMapper:tl.serverInfo},{type:"Property",name:"antispamTag",reflectMapper:tl.antispamTag}],response:[{type:"Property",name:"serverInfo",reflectMapper:e.serverInfo}]},qchatDeleteServer:{sid:24,cid:32,service:"qchatServer",params:[{type:"Long",name:"serverId"}]},qchatUpdateServer:{sid:24,cid:33,service:"qchatServer",params:[{type:"Property",name:"serverInfo",reflectMapper:tl.serverInfo},{type:"Property",name:"antispamTag",reflectMapper:tl.antispamTag}],response:[{type:"Property",name:"serverInfo",reflectMapper:e.serverInfo}]},qchatGetServers:{sid:24,cid:34,service:"qchatServer",params:[{type:"LongArray",name:"serverIds"}],response:[{type:"PropertyArray",name:"serverList",reflectMapper:e.serverInfo}]},qchatGetServersByPage:{sid:24,cid:35,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:tl.getServerListPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverInfo}]},qchatInviteServerMembers:{sid:24,cid:36,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"StrArray",name:"accids"},{type:"String",name:"ps"},{type:"Property",name:"params",reflectMapper:{ttl:1}}],response:[{type:"StrArray",name:"failByOverAccids"},{type:"StrArray",name:"failByBanAccids"},{type:"Property",name:"record",reflectMapper:e.applyRespParamTag}]},qchatAcceptServerInvite:{sid:24,cid:37,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"accid"},{type:"Property",name:"recordInfo",reflectMapper:tl.inviteRespParamTag}]},qchatRejectInviteServer:{sid:24,cid:38,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"accid"},{type:"String",name:"ps"},{type:"Property",name:"recordInfo",reflectMapper:tl.inviteRespParamTag}]},qchatApplyServerJoin:{sid:24,cid:39,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"ps"},{type:"Property",name:"params",reflectMapper:{ttl:1}}],response:[{type:"Property",name:"data",reflectMapper:e.applyRespParamTag}]},qchatAcceptServerApply:{sid:24,cid:40,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"accid"},{type:"Property",name:"recordInfo",reflectMapper:tl.applyRespParamTag}]},qchatRejectServerApply:{sid:24,cid:41,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"accid"},{type:"String",name:"ps"},{type:"Property",name:"recordInfo",reflectMapper:tl.applyRespParamTag}]},qchatKickServerMembers:{sid:24,cid:42,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"StrArray",name:"accids"}]},qchatLeaveServer:{sid:24,cid:43,service:"qchatServer",params:[{type:"Long",name:"serverId"}]},qchatUpdateMyMemberInfo:{sid:24,cid:44,service:"qchatServer",params:[{type:"Property",name:"memberInfo",reflectMapper:tl.memberInfo},{type:"Property",name:"antispamTag",reflectMapper:tl.antispamTag}],response:[{type:"Property",name:"memberInfo",reflectMapper:e.memberInfo}]},qchatUpdateServerMemberInfo:{sid:24,cid:45,service:"qchatServer",params:[{type:"Property",name:"memberInfo",reflectMapper:tl.otherMemberInfo},{type:"Property",name:"antispamTag",reflectMapper:tl.antispamTag}],response:[{type:"Property",name:"memberInfo",reflectMapper:e.memberInfo}]},qchatGetServerMembers:{sid:24,cid:46,service:"qchatServer",params:[{type:"StrArray",name:"accids"}],response:[{type:"PropertyArray",name:"accidList",reflectMapper:e.memberInfo}]},qchatGetServerMembersByPage:{sid:24,cid:47,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:tl.getServerMemberListPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatUpdateServerMemberBan:{sid:24,cid:104,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:tl.updateServerMemberBanTag}]},qchatGetBannedMembersByPage:{sid:24,cid:105,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:tl.getBannedMembersByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverMemberBanInfo}]},qchatServerSearchByPage:{sid:24,cid:91,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:tl.serverSearchByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag",3:"cursor"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverInfo}]},qchatServerMemberSearchByPage:{sid:24,cid:92,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:tl.serverMemberSearchByPageTag}],response:[{type:"PropertyArray",name:"members",reflectMapper:e.memberInfo}]},qchatGenerateInviteCode:{sid:24,cid:122,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,ttl:2}}],response:[{type:"Property",name:"data",reflectMapper:{1:"serverId",2:"requestId",3:"inviteCode",4:"expireTime"}}]},qchatJoinByInviteCode:{sid:24,cid:123,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,inviteCode:2,ps:3}}]},qchatGetInviteApplyRecordOfServer:{sid:24,cid:124,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,fromTime:2,toTime:3,reverse:4,limit:5,cursor:6}}],response:[{type:"PropertyArray",name:"data",reflectMapper:e.inviteApplyRecord}]},qchatGetInviteApplyRecordOfSelf:{sid:24,cid:125,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{fromTime:1,toTime:2,reverse:3,limit:4,cursor:5}}],response:[{type:"PropertyArray",name:"data",reflectMapper:e.inviteApplyRecord}]},qchatClearServersUnread:{sid:25,cid:5,service:"qchatServer",params:[{type:"LongArray",name:"serverIds"}],response:[{type:"Property",name:"clearServersUnreadTag",reflectMapper:e.clearServersUnreadTag}]},qchatSubscribeChannelsByServers:{sid:25,cid:7,service:"qchatServer",params:[{type:"Int",name:"type"},{type:"LongArray",name:"serverIds"}],response:[{type:"PropertyArray",name:"unreadInfos",reflectMapper:e.unreadInfo},{type:"String",name:"failServerIds"}]},qchatEnterAsVisitor:{sid:25,cid:10,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverIds:1}}],response:[{type:"String",name:"failServerIds"}]},qchatLeaveAsVisitor:{sid:25,cid:11,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverIds:1}}],response:[{type:"String",name:"failServerIds"}]}}},rl={"24_61":"qchatCreateServerRole","24_62":"qchatDeleteServerRole","24_63":"qchatUpdateServerRole","24_64":"qchatGetServerRoles","24_65":"qchatAddChannelRole","24_66":"qchatRemoveChannelRole","24_67":"qchatUpdateChannelRole","24_68":"qchatGetChannelRoles","24_69":"qchatAddMemberRole","24_70":"qchatRemoveMemberRole","24_71":"qchatUpdateMemberRole","24_72":"qchatGetMemberRoles","24_73":"qchatAddMembersToServerRole","24_74":"qchatRemoveMembersFromServerRole","24_75":"qchatGetMembersFromServerRole","24_76":"qchatGetServerRolesByAccid","24_77":"qchatGetExistingServerRolesByAccids","24_78":"qchatGetExistingChannelRolesByServerRoleIds","24_79":"qchatGetExistingAccidsOfMemberRoles","24_80":"qchatUpdateServerRolePriorities","24_81":"qchatGetExistingAccidsInServerRole","24_82":"qchatCheckPermission","24_83":"qchatAddChannelCategoryRole","24_84":"qchatRemoveChannelCategoryRole","24_85":"qchatUpdateChannelCategoryRole","24_86":"qchatGetChannelCategoryRole","24_87":"qchatAddChannelCategoryMemberRole","24_88":"qchatRemoveChannelCategoryMemberRole","24_89":"qchatUpdateChannelCategoryMemberRole","24_90":"qchatGetChannelCategoryMemberRole","24_126":"qchatCheckPermissions"},il={channelRole:{serverId:1,roleId:2,parentRoleId:3,channelId:4,name:5,icon:6,ext:7,auths:8,type:9,createTime:10,updateTime:11},memberRole:{serverId:1,id:2,accid:3,channelId:4,auths:5,createTime:6,updateTime:7,nick:8,avatar:9,ext:10,memberType:11,joinTime:12,inviter:13},antispamTag:{antiSpamBusinessId:1},serverRole:{serverId:1,roleId:2,name:3,icon:4,ext:5,auths:6,type:7,memberCount:8,priority:9,createTime:10,updateTime:11,isMember:12},getRoleByPagesTag:{serverId:1,channelId:2,time:3,limit:4},checkPermissionTag:{serverId:1,channelId:2,auth:3},member:{serverId:1,roleId:2,accid:3,createTime:4,updateTime:5,nick:6,avatar:7,ext:8,type:9,joinTime:10,inviter:11},qchatAddChannelCategoryRoleTag:{categoryId:3,serverId:4,parentRoleId:5},channelCategoryRole:{roleId:1,categoryId:3,serverId:4,parentRoleId:5,type:6,validFlag:7,createTime:8,updateTime:9,auths:10,name:11,icon:12,ext:13},qchatGetChannelCategoryRoleTag:{serverId:1,categoryId:2,timetag:3,limit:4},channelCategoryMemberRole:{id:1,accid:3,categoryId:4,serverId:5,validFlag:6,createTime:7,updateTime:8,auths:9,nick:10,avatar:11,ext:12,memberType:13,joinTime:14,inviter:15},qchatGetChannelCategoryMemberRoleTag:{serverId:1,categoryId:2,timetag:3,limit:4},checkPermissionsTag:{serverId:1,channelId:2,auths:3}},getDeserializeTag=()=>invertSerializeMap(il),getCmdConfig=()=>{var e=getDeserializeTag();return{qchatCreateServerRole:{service:"qchatRole",sid:24,cid:61,params:[{type:"Property",name:"serverRole",reflectMapper:il.serverRole},{type:"Property",name:"antispamTag",reflectMapper:il.antispamTag}],response:[{type:"Property",name:"serverRole",reflectMapper:e.serverRole}]},qchatDeleteServerRole:{service:"qchatRole",sid:24,cid:62,params:[{type:"Long",name:"serverId"},{type:"Long",name:"roleId"}]},qchatUpdateServerRole:{service:"qchatRole",sid:24,cid:63,params:[{type:"Property",name:"updateServerRoleTag",reflectMapper:{serverId:1,roleId:2,name:3,icon:4,ext:5,auths:6,priority:7}},{type:"Property",name:"antispamTag",reflectMapper:il.antispamTag}],response:[{type:"Property",name:"serverRole",reflectMapper:e.serverRole}]},qchatGetServerRoles:{service:"qchatRole",sid:24,cid:64,params:[{type:"Property",name:"getServerRolesTag",reflectMapper:{serverId:1,timetag:2,limit:3,priority:4,channelId:5,categoryId:6}}],response:[{type:"PropertyArray",name:"serverRoles",reflectMapper:e.serverRole}]},qchatAddChannelRole:{service:"qchatRole",sid:24,cid:65,params:[{type:"Property",name:"channelRole",reflectMapper:il.channelRole}],response:[{type:"Property",name:"channelRole",reflectMapper:e.channelRole}]},qchatRemoveChannelRole:{service:"qchatRole",sid:24,cid:66,params:[{type:"Long",name:"serverId"},{type:"Long",name:"channelId"},{type:"Long",name:"roleId"}]},qchatUpdateChannelRole:{service:"qchatRole",sid:24,cid:67,params:[{type:"Property",name:"updateChannelRoleTag",reflectMapper:{serverId:1,roleId:2,channelId:3,auths:4}}],response:[{type:"Property",name:"channelRole",reflectMapper:e.channelRole}]},qchatGetChannelRoles:{service:"qchatRole",sid:24,cid:68,params:[{type:"Property",name:"getChannelRolesTag",reflectMapper:{serverId:1,channelId:2,timetag:3,limit:4}}],response:[{type:"PropertyArray",name:"channelRoles",reflectMapper:e.channelRole}]},qchatAddMemberRole:{service:"qchatRole",sid:24,cid:69,params:[{type:"Property",name:"memberRole",reflectMapper:il.memberRole}],response:[{type:"Property",name:"memberRole",reflectMapper:e.memberRole}]},qchatRemoveMemberRole:{service:"qchatRole",sid:24,cid:70,params:[{type:"Property",name:"memberRole",reflectMapper:il.memberRole}]},qchatUpdateMemberRole:{service:"qchatRole",sid:24,cid:71,params:[{type:"Property",name:"updateMemberRoleTag",reflectMapper:{serverId:1,accid:2,channelId:3,auths:4}}],response:[{type:"Property",name:"memberRole",reflectMapper:e.memberRole}]},qchatGetMemberRoles:{service:"qchatRole",sid:24,cid:72,params:[{type:"Property",name:"getMemberRolesTag",reflectMapper:{serverId:1,channelId:2,timetag:3,limit:4}}],response:[{type:"PropertyArray",name:"memberRoles",reflectMapper:e.memberRole}]},qchatAddMembersToServerRole:{service:"qchatRole",sid:24,cid:73,params:[{type:"Long",name:"serverId"},{type:"Long",name:"roleId"},{type:"String",name:"accids"}],response:[{type:"Property",name:"accids",reflectMapper:{1:"successAccids",2:"failedAccids"}}]},qchatRemoveMembersFromServerRole:{service:"qchatRole",sid:24,cid:74,params:[{type:"Long",name:"serverId"},{type:"Long",name:"roleId"},{type:"String",name:"accids"}],response:[{type:"Property",name:"accids",reflectMapper:{1:"successAccids",2:"failedAccids"}}]},qchatGetMembersFromServerRole:{service:"qchatRole",sid:24,cid:75,params:[{type:"Property",name:"getMembersFromServerRoleTag",reflectMapper:{serverId:1,roleId:2,timetag:3,accid:4,limit:5}}],response:[{type:"PropertyArray",name:"members",reflectMapper:e.member}]},qchatGetServerRolesByAccid:{service:"qchatRole",sid:24,cid:76,params:[{type:"Property",name:"getServerRolesByAccidTag",reflectMapper:{serverId:1,accid:2,timetag:3,limit:4}}],response:[{type:"PropertyArray",name:"serverRoles",reflectMapper:e.serverRole}]},qchatGetExistingServerRolesByAccids:{service:"qchatRole",sid:24,cid:77,params:[{type:"Long",name:"serverId"},{type:"String",name:"accids"}],response:[{type:"String",name:"serverRoles"}]},qchatGetExistingChannelRolesByServerRoleIds:{service:"qchatRole",sid:24,cid:78,params:[{type:"Long",name:"serverId"},{type:"Long",name:"channelId"},{type:"String",name:"roleIds"}],response:[{type:"PropertyArray",name:"channelRoles",reflectMapper:e.channelRole}]},qchatGetExistingAccidsOfMemberRoles:{service:"qchatRole",sid:24,cid:79,params:[{type:"Long",name:"serverId"},{type:"Long",name:"channelId"},{type:"String",name:"accids"}],response:[{type:"PropertyArray",name:"memberRoles",reflectMapper:e.memberRole}]},qchatUpdateServerRolePriorities:{service:"qchatRole",sid:24,cid:80,params:[{type:"Long",name:"serverId"},{type:"PropertyArray",name:"serverRoles",reflectMapper:{serverId:1,roleId:2,priority:7}}],response:[{type:"PropertyArray",name:"serverRoles",reflectMapper:e.serverRole}]},qchatGetExistingAccidsInServerRole:{service:"qchatRole",sid:24,cid:81,params:[{type:"Long",name:"serverId"},{type:"Long",name:"roleId"},{type:"String",name:"accids"}],response:[{type:"PropertyArray",name:"members",reflectMapper:e.member}]},qchatCheckPermission:{service:"qchatRole",sid:24,cid:82,params:[{type:"Property",name:"checkPermissionTag",reflectMapper:il.checkPermissionTag}],response:[{type:"Bool",name:"checked"}]},qchatAddChannelCategoryRole:{service:"qchatRole",sid:24,cid:83,params:[{type:"Property",name:"qchatAddChannelCategoryRoleTag",reflectMapper:il.channelCategoryRole}],response:[{type:"Property",name:"channelCategoryRole",reflectMapper:e.channelCategoryRole}]},qchatRemoveChannelCategoryRole:{service:"qchatRole",sid:24,cid:84,params:[{type:"Long",name:"serverId"},{type:"Long",name:"categoryId"},{type:"Long",name:"roleId"}]},qchatUpdateChannelCategoryRole:{service:"qchatRole",sid:24,cid:85,params:[{type:"Property",name:"qchatUpdateChannelCategoryRoleTag",reflectMapper:il.channelCategoryRole}],response:[{type:"Property",name:"channelCategoryRole",reflectMapper:e.channelCategoryRole}]},qchatGetChannelCategoryRole:{service:"qchatRole",sid:24,cid:86,params:[{type:"Property",name:"qchatGetChannelCategoryRoleTag",reflectMapper:il.qchatGetChannelCategoryRoleTag}],response:[{type:"PropertyArray",name:"list",reflectMapper:e.channelCategoryRole}]},qchatAddChannelCategoryMemberRole:{service:"qchatRole",sid:24,cid:87,params:[{type:"Property",name:"qchatAddChannelCategoryMemberRoleTag",reflectMapper:il.channelCategoryMemberRole}],response:[{type:"Property",name:"channelCategoryMemberRole",reflectMapper:e.channelCategoryMemberRole}]},qchatRemoveChannelCategoryMemberRole:{service:"qchatRole",sid:24,cid:88,params:[{type:"Long",name:"serverId"},{type:"Long",name:"categoryId"},{type:"String",name:"accid"}]},qchatUpdateChannelCategoryMemberRole:{service:"qchatRole",sid:24,cid:89,params:[{type:"Property",name:"qchatUpdateChannelCategoryMemberRoleTag",reflectMapper:il.channelCategoryMemberRole}],response:[{type:"Property",name:"channelCategoryMemberRole",reflectMapper:e.channelCategoryMemberRole}]},qchatGetChannelCategoryMemberRole:{service:"qchatRole",sid:24,cid:90,params:[{type:"Property",name:"qchatGetChannelCategoryMemberRoleTag",reflectMapper:il.qchatGetChannelCategoryMemberRoleTag}],response:[{type:"PropertyArray",name:"list",reflectMapper:e.channelCategoryMemberRole}]},qchatCheckPermissions:{service:"qchatRole",sid:24,cid:126,params:[{type:"Property",name:"checkPermissionsTag",reflectMapper:il.checkPermissionsTag}],response:[{type:"PropertyArray",name:"checkPermissionsResult",reflectMapper:{1:"auth",2:"isAllow"}}]}}},nl=["image","audio","video","file"],al={time:{type:"number"},updateTime:{type:"number"},resendFlag:{type:"boolean"},persistEnable:{type:"boolean"},routeEnable:{type:"boolean"},pushEnable:{type:"boolean"},needBadge:{type:"boolean"},needPushNick:{type:"boolean"},type:{type:"enum",values:Ud},fromClientType:{type:"enum",values:Qd},status:{type:"number"},toAccids:{type:"object"},toType:{type:"number"},attach:{type:"object"},pushPayload:{type:"object"}};function generatorSysMsgForCmd(e,t){var r=Object.assign({},e),i=Object.assign({type:t||Ud.custom},formatReverse(al,r));return i.serverId&&i.channelId&&i.toAccids?i.toType=Dd.channelAccids:i.serverId&&i.toAccids?i.toType=Dd.serverAccids:i.serverId&&i.channelId?i.toType=Dd.channel:i.serverId?i.toType=Dd.server:i.toAccids?i.toType=Dd.accids:i.toType=Dd.unknown,i}var sl={[Ud.channelUpdateWhiteBlackIdentify]:function(e){var t=getDeserializeTag$4();return e.notify=formatUpdateWhiteBlackRole(deserialize(e.notify,t.qchatUpdateWhiteBlackRoleTag)),e},[Ud.channelUpdateWhiteBlackIdentifyUser]:function(e){var t=getDeserializeTag$4();return e.notify=function formatUpdateWhiteBlackMembers(e){return format(Id,e)}(deserialize(e.notify,t.qchatUpdateWhiteBlackMembersTag)),e},[Ud.updateQuickComment]:function(e){var t=getDeserializeTag$2();return e.notify=function formatQuickCommentRequest(e){return format(dl,e)}(deserialize(e.notify,t.qchatQuickCommentRequestTag)),e},[Ud.channelCategoryCreate]:function(e){var t=getDeserializeTag$4();return e.categoryInfo=formatChannelCategory(deserialize(e.categoryInfo,t.QChatChannelCategoryInfo)),e},[Ud.channelCategoryUpdate]:function(e){var t=getDeserializeTag$4();return e.categoryInfo=formatChannelCategory(deserialize(e.categoryInfo,t.QChatChannelCategoryInfo)),e},[Ud.channelCategoryUpdateWhiteBlackIdentify]:function(e){var t=getDeserializeTag$4();return e.notify=formatUpdateWhiteBlackRole(deserialize(e.notify,t.qchatUpdateChannelCategoryWhiteBlackRoleTag)),e},[Ud.channelCategoryUpdateWhiteBlackIdentifyUser]:function(e){var t=getDeserializeTag$4();return e.notify=formatUpdateWhiteBlackRole(deserialize(e.notify,t.qchatUpdateChannelCategoryWhiteBlackMembersTag)),e},[Ud.serverIdentifyAdd]:function(e){var t=getDeserializeTag();return e.serverIdentifyInfo=formatRole(deserialize(e.serverIdentifyInfo,t.serverRole)),e},[Ud.serverIdentifyRemove]:function(e){var t=getDeserializeTag();return e.serverIdentifyInfo=formatRole(deserialize(e.serverIdentifyInfo,t.serverRole)),e},[Ud.serverIdentifyUpdate]:function(e){var t=getDeserializeTag();return e.serverIdentifyInfo=formatRole(deserialize(e.serverIdentifyInfo,t.serverRole)),e},[Ud.channelIdentifyUpdate]:function(e){var t=getDeserializeTag();return e.channelIdentifyInfo=formatRole(deserialize(e.channelIdentifyInfo,t.channelRole)),e},[Ud.userIdentifyUpdate]:function(e){var t=getDeserializeTag();return e.userIdentifyInfo=formatRole(deserialize(e.userIdentifyInfo,t.memberRole)),e},[Ud.myMemberInfoUpdated]:function(e){var t=Ne(e,"userInfo.name"),r=Ne(e,"userInfo.icon");return e.updatedInfos=e.reuseServers.map((e=>{var i={serverId:e.serverId};return 1==(1&e.bits)&&"string"==typeof t&&Object.assign(i,{nickChanged:!0,nick:t}),2==(2&e.bits)&&"string"==typeof r&&Object.assign(i,{avatarChanged:!0,avatar:r}),i})),delete e.userInfo,delete e.reuseServers,e}};function formatSystemNotification(e,t){var r=format(al,e);if(!r.attach)return r;var i=getDeserializeTag$1(),n=getDeserializeTag$4();if(r.attach.serverInfo&&(r.attach.serverInfo=formatServer(deserialize(r.attach.serverInfo,i.serverInfo))),r.attach.channelInfo&&(r.attach.channelInfo=formatChannel(deserialize(r.attach.channelInfo,n.channelInfo))),r.attach.serverMember&&(r.attach.serverMember=formatMember$1(deserialize(r.attach.serverMember,i.memberInfo))),sl[r.attach.type]&&(r.attach=sl[r.attach.type](r.attach)),r.attach.updateAuths)try{r.attach.updateAuths=formatRoleAuths(JSON.parse(r.attach.updateAuths))}catch(e){t.error("formatSystemNotification:JSON parse updateAuths error: ",e)}return r.attach.type&&(r.attach.rawType=r.attach.type,r.attach.type=Ud[r.attach.type]),r}var ol={type:{type:"enum",values:kd},fromClientType:{type:"enum",values:Qd},status:{type:"number"},resendFlag:{type:"boolean"},mentionAll:{type:"boolean"},notifyReason:{type:"enum",values:Ld},pushEnable:{type:"boolean"},historyEnable:{type:"boolean"},needBadge:{type:"boolean"},needPushNick:{type:"boolean"},routeEnable:{type:"boolean"},time:{type:"number"},updateTime:{type:"number"},mentionAccids:{type:"object"},mentionRoleIds:{type:"object"},accidsOfMentionedRoles:{type:"object"},attach:{type:"object"},pushPayload:{type:"object"},isAntispam:{type:"boolean"},antiSpamInfo:{useCustomContent:{type:"boolean"},antiSpamContent:{type:"string"},antiSpamBusinessId:{type:"string"},antiSpamUsingYidun:{type:"boolean"},yidunCallback:{type:"string"},yidunAntiCheating:{type:"object"},yidunAntiSpamExt:{type:"object"},yidunAntiSpamRes:{type:"string"}},replyRefer:{fromAccount:{type:"string",rawKey:"replyMsgFromAccount"},time:{type:"number",rawKey:"replyMsgTime"},msgIdServer:{type:"string",rawKey:"replyMsgIdServer"},msgIdClient:{type:"string",rawKey:"replyMsgIdClient"}},threadRefer:{fromAccount:{type:"string",rawKey:"threadMsgFromAccount"},time:{type:"number",rawKey:"threadMsgTime"},msgIdServer:{type:"string",rawKey:"threadMsgIdServer"},msgIdClient:{type:"string",rawKey:"threadMsgIdClient"}}};function generatorMsgForCmd(e){var t=__rest(e,["onSendBefore","onUploadStart","onUploadDone","onUploadProgress"]),r=formatReverse(ol,t);if(r.msgIdClient=e.resendFlag?e.msgIdClient:Ii(),!r.msgIdClient)throw new FormatError("msgIdClient is required for resend a message","msgIdClient","required");return e.replyMessage&&e.replyMessage.msgIdServer&&(r.replyMsgFromAccount=e.replyMessage.fromAccount,r.replyMsgTime=+e.replyMessage.time,r.replyMsgIdServer=e.replyMessage.msgIdServer,r.replyMsgIdClient=e.replyMessage.msgIdClient,e.replyMessage.threadRefer&&e.replyMessage.threadRefer.msgIdServer?(r.threadMsgFromAccount=e.replyMessage.threadRefer.fromAccount,r.threadMsgTime=+e.replyMessage.threadRefer.time,r.threadMsgIdServer=e.replyMessage.threadRefer.msgIdServer,r.threadMsgIdClient=e.replyMessage.threadRefer.msgIdClient):(r.threadMsgFromAccount=e.replyMessage.fromAccount,r.threadMsgTime=+e.replyMessage.time,r.threadMsgIdServer=e.replyMessage.msgIdServer,r.threadMsgIdClient=e.replyMessage.msgIdClient),delete r.replyMessage),r}function formatMsgOperatorInfo(e){return format({operatorClientType:{type:"enum",values:Qd},pushPayload:{type:"object"}},e)}function formatMsg(e,t={},r){var i,n;return __awaiter(this,void 0,void 0,(function*(){var a=format(ol,e);a.deliveryStatus=t.deliveryStatus?wd[t.deliveryStatus]:wd[wd.success],t.time&&(a.time=t.time);var s=getDeserializeTag$2();if(a.updateContent){var o=JSON.parse(a.updateContent);o=format({status:{type:"number"}},o=deserialize(o,s.qchatMsgTag)),a.updateContent=o}if(a.updateOperatorInfo){var c=JSON.parse(a.updateOperatorInfo);c=formatMsgOperatorInfo(deserialize(c,s.qchatMsgUpdateTag)),a.updateOperatorInfo=c}return""===(null===(i=null==a?void 0:a.threadRefer)||void 0===i?void 0:i.fromAccount)&&delete a.threadRefer,""===(null===(n=null==a?void 0:a.replyRefer)||void 0===n?void 0:n.fromAccount)&&delete a.replyRefer,a.attach&&t.attachUrl&&(a.attach.url=t.attachUrl),yield function formatMsgAttach(e,t){return __awaiter(this,void 0,void 0,(function*(){if(!(nl.includes(e.type)&&e.attach&&e.attach.url))return e;if(!t||!t.cloudStorage||"function"!=typeof t.cloudStorage.getPrivateUrl||"function"!=typeof t.cloudStorage.getOriginUrl)return e;if(e.attach.url.indexOf("_im_url=1")<0)return e.attach.url=t.cloudStorage.getPrivateUrl(e.attach.url),e;try{e.attach.url=yield t.cloudStorage.getOriginUrl(e.attach.url)}catch(t){throw new FormatError(`url "${e.attach.url}" parse error`,"message.attach.url","parse error")}return e}))}(a,r)}))}function formatMsgs(e,t={},r){return __awaiter(this,void 0,void 0,(function*(){if(!(Array.isArray(e)&&e.length>0))return[];var i=e.map((e=>formatMsg(e,t,r)));return yield Promise.all(i)}))}var cl={totalCount:{type:"number"},lastUpdateTime:{type:"number"},details:{type:"object"}};var dl={type:{type:"number"},time:{type:"number"},opeType:{type:"number"}};var ll={includeSelf:{type:"number"},order:{type:"enum",values:ld},sort:{type:"enum",values:Vd},msgTypes:{type:"object"},subTypes:{type:"object"}};var ml={hasMore:{type:"boolean"},nextTimetag:{type:"number"},cursor:{type:"string"}};var pl={6:function(e){return this.core.qchatChannel.subscribeForVisitorService.deleteAutoSetInServerId(e.serverId),!0},16:function(e){return this.core.qchatChannel.subscribeForVisitorService.deleteAutoSetInChannel(e.serverId,e.channelId),!0},26:function(e){var t=Ne(e,"attach.addAccids");return t&&t.includes(this.core.account)&&this.core.eventBus.emit("qchatChannel/serverIdentifyChange",e),!0},27:function(e){var t=Ne(e,"attach.deleteAccids");return t&&t.includes(this.core.account)&&this.core.eventBus.emit("qchatChannel/serverIdentifyChange",e),!0},31:function(e){var t,r;return 1===e.attach.event?(null===(r=null===(t=this.core.qchatChannel)||void 0===t?void 0:t.config)||void 0===r?void 0:r.autoSubscribe)&&this.core.qchatChannel.subscribeChannel({type:1,opeType:1,channels:[{serverId:e.serverId,channelId:e.channelId}],isInternalTrigger:!0}):2===e.attach.event&&(this.core.eventBus.emit("qchatChannel/autoUnSubscribe",e),this.core.eventBus.emit("qchatMedia/serverOrChannelLeave",e)),!0},32:function(e){var t,r;return 2===e.attach.event?(this.core.eventBus.emit("qchatChannel/autoUnSubscribe",e),this.core.eventBus.emit("qchatMedia/serverOrChannelLeave",e)):1===e.attach.event&&(this.core.qchatChannel.subscribeForVisitorService.deleteServer(e.serverId),(null===(r=null===(t=this.core.qchatChannel)||void 0===t?void 0:t.config)||void 0===r?void 0:r.autoSubscribe)&&this.core.qchatServer.subscribeServer({type:4,opeType:1,servers:[{serverId:e.serverId}],isInternalTrigger:!0})),!0},34:function(e){return 2===e.attach.event&&this.core.qchatChannel.subscribeForVisitorService.unSubscribeChannel(e.serverId,e.channelId),!0},101:function(e){var t=Ys(e,["serverId","channelId","ext","fromAccount","fromNick","time"]);return this.logger.log("qchat on recvTypingEvent: ",t),this.core.emit("recvTypingEvent",t),this.core.qchatMsg.emit("recvTypingEvent",t),!1}};class NotificationModuleService{constructor(e){this.core=e,this.logger=e.logger}sendSystemNotification(e){return __awaiter(this,void 0,void 0,(function*(){var t=formatSystemNotification((yield this.core.sendCmd("qchatSendCustomSysMsg",{sysMsg:generatorSysMsgForCmd(e)})).content.sysMsg,this.logger);return"debug"===this.core.options.debugLevel?this.logger.debug("sendCustomSysMsg success",t):this.logger.log("sendCustomSysMsg success",t.serverId,t.channelId,t.msgIdServer),t}))}updateSystemNotification(e){return __awaiter(this,void 0,void 0,(function*(){var{systemNotification:t}=e,r=__rest(e,["systemNotification"]),i=generatorSysMsgForCmd(Ys(t,["msgIdServer","type","body","ext","status"]));return formatSystemNotification((yield this.core.sendCmd("qchatUpdateSystemNotification",{sysMsg:i,qchatMsgUpdateTag:Object.assign(Object.assign({},r),{operatorAccount:this.core.account,operatorClientType:Qd.Web,pushPayload:JSON.stringify(e.pushPayload),routeEnable:fi.boolean(e,"routeEnable")})})).content.sysMsg,this.logger)}))}markSystemNotificationsRead(e){return __awaiter(this,void 0,void 0,(function*(){yield this.core.sendCmd("qchatMarkSysMsgRead",{sysMsgs:e.systemNotifications.map((e=>function generatorSysMsgMarkersForCmd(e){var t=Ys(e,["msgIdServer","type"]);return formatReverse(al,t)}(e)))})}))}onSysMsg(e){var t=e.content.sysMsg;if(t){var r=formatSystemNotification(t,this.core.logger),i=pl[Ud[r.type]];if(i)if(!1===i.call(this,r))return;var n={feature:"default",systemNotifications:[r]};this.logger.log("qchat on systemNotification: ",n),this.core.emit("systemNotification",n),this.core.qchatMsg.emit("systemNotification",n)}else this.core.logger.warn("No sysMsg in onSysMsg packet")}onMultiSysMsg(e){var t=e.content.sysMsg;if(t){var r=formatSystemNotification(t,this.logger);this.core.emit("systemNotificationUpdate",r),this.core.qchatMsg.emit("systemNotificationUpdate",r)}}onSyncSysMsg(e){var t=e.content.systemNotifications;if(t&&t.length>0){var r=t.map((e=>formatSystemNotification(e,this.logger)));this.core.emit("systemNotification",{feature:"sync",systemNotifications:r}),this.core.qchatMsg.emit("systemNotification",{feature:"sync",systemNotifications:r})}else this.logger.warn("sync system notification not exist")}}var ul=["image","audio","video","file"];class MessageModuleService{constructor(e){this.markMessageRead=throttle((e=>__awaiter(this,void 0,void 0,(function*(){var t=formatUnreadInfo((yield this.core.sendCmd("qchatMarkMessageRead",{markMsgReadTag:e})).content.unreadInfo);this.core.eventBus.emit("qchatChannel/updateUnreads",[t])}))),200),this.core=e,this.logger=e.logger}sendMessage(e){var t,r,i,n;return __awaiter(this,void 0,void 0,(function*(){ul.indexOf(e.type)>-1&&(e.attach=yield this.doSendFile(e));var a,s=generatorMsgForCmd(Object.assign({fromAccount:this.core.account},e)),o=yield formatMsg(s,{time:(new Date).getTime(),deliveryStatus:wd.sending},this.core);try{e.onSendBefore&&e.onSendBefore(o)}catch(e){this.logger.error("sendMsg: options.onSendBefore error",e)}try{a=yield this.core.sendCmd("qchatSendMsg",{qchatMsg:s})}catch(e){var c=yield formatMsg(s,{time:(new Date).getTime(),deliveryStatus:wd.failed,attachUrl:null===(t=o.attach)||void 0===t?void 0:t.url},this.core);throw e.msg=c,e}var{content:d}=a,l=yield formatMsg(Object.assign({},d.qchatMsg),{deliveryStatus:wd.success,attachUrl:null===(r=o.attach)||void 0===r?void 0:r.url},this.core);if(l.isAntispam)throw{code:10403,msg:l,message:(null===(i=null==l?void 0:l.antiSpamInfo)||void 0===i?void 0:i.yidunAntiSpamRes)||"message has be antispam",isAntispam:!0,yidunAntiSpamRes:(null===(n=null==l?void 0:l.antiSpamInfo)||void 0===n?void 0:n.yidunAntiSpamRes)||""};return l}))}doSendFile(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"enum",values:["image","audio","video","file"]},attach:{type:"object",rules:{url:{type:"string",allowEmpty:!1}},required:!1},maxSize:{type:"number",min:1,required:!1}},e);var t=e.attach;if(!t){if(!this.core.cloudStorage||!this.core.cloudStorage.uploadFile)throw new Error('Service "cloudStorage" does not exist');try{t=yield this.core.cloudStorage.uploadFile(e)}catch(e){throw this.logger.error("sendFile:: upload File error or abort.",e),e}}return t}))}resendMessage(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){var i,n=generatorMsgForCmd(Object.assign(Object.assign({},e),{resendFlag:!0}));n.deliveryStatus=wd.sending;try{i=yield this.core.sendCmd("qchatSendMsg",{qchatMsg:n})}catch(e){var a=yield formatMsg(n,{time:(new Date).getTime(),deliveryStatus:wd.failed},this.core);throw e.msg=a,e}var{content:s}=i,o=yield formatMsg(Object.assign({},s.qchatMsg),{deliveryStatus:wd.success},this.core);if(o.isAntispam)throw{code:10403,msg:o,message:(null===(t=null==o?void 0:o.antiSpamInfo)||void 0===t?void 0:t.yidunAntiSpamRes)||"message has be antispam",isAntispam:!0,yidunAntiSpamRes:(null===(r=null==o?void 0:o.antiSpamInfo)||void 0===r?void 0:r.yidunAntiSpamRes)||""};return o}))}doUpdateMessage(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){var{message:i}=e,n=__rest(e,["message"]),a=generatorMsgForCmd(i);a.msgIdClient=void 0,a.time=i.time;var s=yield this.core.sendCmd("qchatUpdateMessage",{qchatMsg:a,qchatMsgUpdateTag:Object.assign(Object.assign({},n),{operatorAccount:this.core.account,operatorClientType:Qd.Web,pushPayload:JSON.stringify(e.pushPayload),routeEnable:fi.boolean(e,"routeEnable")})}),o=yield formatMsg(s.content.qchatMsg,{},this.core);if(this.core.eventBus.emit("qchatChannel/changeUnread",o,!0),s.content.qchatMsg.isAntispam)throw{code:10403,msg:a,message:(null===(t=s.content.qchatMsg)||void 0===t?void 0:t.yidunAntiSpamRes)||"message has be antispam",isAntispam:!0,yidunAntiSpamRes:(null===(r=s.content.qchatMsg)||void 0===r?void 0:r.yidunAntiSpamRes)||""};return o}))}getHistoryMessage(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.sendCmd("qchatGetHistoryMsg",{getHistoryMsgTag:Object.assign(Object.assign({},e),{reverse:e.reverse?1:0})}),{content:r}=t;return yield Promise.all(r.qchatMsgs.map((e=>formatMsg(e,{},this.core))))}))}getMentionedMeMessages(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.sendCmd("qchatGetMentionedMeMessages",{tag:e}),{content:r}=t;return{pageInfo:function formatPageInfo(e){return format(ml,e)}(r.page),messages:yield Promise.all(r.datas.map((e=>formatMsg(e,{},this.core))))}}))}areMentionedMeMessages(e){return __awaiter(this,void 0,void 0,(function*(){for(var t={},r=0;r<e.length;r++){var i=e[r];i.fromAccount!==this.core.account?t[i.msgIdClient]=yield this.core.qchatChannel.subscribeModuleService.getMentionedFlag(i,!0):t[i.msgIdClient]=!1}return t}))}getLastMessageOfChannels(e){return __awaiter(this,void 0,void 0,(function*(){var t=(yield this.core.sendCmd("qchatGetLastMessageOfChannels",{tag:e})).content.msgs;return(yield formatMsgs(t,{},this.core)).reduce(((e,t)=>(e[t.channelId]=t,e)),{})}))}messageSearchByPage(e){return __awaiter(this,void 0,void 0,(function*(){var t,r=yield this.core.sendCmd("qchatMessageSearchByPage",{qchatMessageSearchByPageTag:Object.assign(Object.assign({},(t=e,formatReverse(ll,t))),{includeSelf:e.includeSelf?1:""})}),{datas:i,listQueryTag:n}=r.content,a=yield formatMsgs(i,{},this.core);return{listQueryTag:{hasMore:1==+n.hasMore,nextTimetag:n.nextTimetag?parseInt(n.nextTimetag):0,cursor:n.cursor},datas:a}}))}onMsg(e){return __awaiter(this,void 0,void 0,(function*(){var t=e.content.qchatMsg;if(t){var r=yield formatMsg(t,{},this.core);this.core.eventBus.emit("qchatChannel/changeUnread",r,!1),this.core.emit("message",r),this.core.qchatMsg.emit("message",r)}else this.logger.warn("No qchatMsg in qchatMsg packet")}))}onRecvUnreadInfo(e){return __awaiter(this,void 0,void 0,(function*(){var t=e.content.qchatMsg;if(t){var r=yield formatMsg(t);this.core.eventBus.emit("qchatChannel/changeUnread",r,!1)}}))}onMultiSyncRead(e){var t=e.content.unreadInfo;if(t){var r=formatUnreadInfo(t);this.core.eventBus.emit("qchatChannel/updateUnreads",[r])}}onMultiSyncServersRead(e){var t=e.content.qchatMultiSyncServersMessageReadTag;if(t){var{successServerIds:r,ackTimestamp:i}=formatClearServersUnread(t);this.core.eventBus.emit("qchatChannel/clearUnreadCountByServers",r,i)}}onRecvMsgUpdate(e){return __awaiter(this,void 0,void 0,(function*(){var t=e.content.qchatMsg,r=e.content.qchatMsgUpdateInfo;if(t){var i=yield formatMsg(t,{},this.core),n=formatMsgOperatorInfo(r);this.core.eventBus.emit("qchatChannel/changeUnread",i,!0),this.core.emit("messageUpdate",i,n),this.core.qchatMsg.emit("messageUpdate",i,n)}}))}}class ExtendModuleService{constructor(e){this._sendTypingEvent=throttle((e=>__awaiter(this,void 0,void 0,(function*(){yield this.core.sendCmd("qchatSendCustomSysMsg",{sysMsg:generatorSysMsgForCmd(Object.assign(Object.assign({},e),{resendFlag:!1,persistEnable:!1,routeEnable:!1,pushEnable:!1,needBadge:!1,needPushNick:!1}),Ud.msgTyping)})}))),3e3),this.core=e,this.logger=e.logger,this.lastChannelIdInTyping=""}getMessageHistoryByIds(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.sendCmd("qchatGetMessageHistoryByIds",{channelInfo:{serverId:e.serverId,channelId:e.channelId},messageReferList:e.messageReferList});return Promise.all(t.content.qchatMsgs.map((e=>formatMsg(e))))}))}getReferMessages(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){if(!(null===(t=e.message.replyRefer)||void 0===t?void 0:t.msgIdServer)||!(null===(r=e.message.threadRefer)||void 0===r?void 0:r.msgIdServer))throw new Error("Message has no reply");var i=yield this.getMessageHistoryByIds({serverId:e.message.serverId,channelId:e.message.channelId,messageReferList:[e.message.replyRefer,e.message.threadRefer]});return e.referType===qd[qd.all]?{replyMessage:i[0],threadMessage:i[1]}:e.referType===qd[qd.reply]?{replyMessage:i[0]}:e.referType===qd[qd.thread]?{threadMessage:i[1]}:{replyMessage:i[0],threadMessage:i[1]}}))}getThreadMessages(e){var t;return __awaiter(this,void 0,void 0,(function*(){var r;r=(null===(t=e.message.threadRefer)||void 0===t?void 0:t.msgIdServer)?Object.assign({serverId:e.message.serverId,channelId:e.message.channelId},e.message.threadRefer):e.message;var i=yield this.core.sendCmd("qchatGetThreadMessages",{qchatMsg:r,getThreadHistoryMsgTag:Object.assign(Object.assign({},e.messageQueryOption),{reverse:fi.boolean(e.messageQueryOption,"reverse")})}),n=yield formatMsg(i.content.thread),a=yield Promise.all(i.content.qchatMsgs.map((e=>formatMsg(e))));return{thread:n,threadInfo:{messageCount:+i.content.threadInfo.messageCount,lastMessageTimestamp:+i.content.threadInfo.lastMessageTimestamp},messages:a}}))}getThreadRootMessagesMeta(e){return __awaiter(this,void 0,void 0,(function*(){var{threadRootMessages:t}=e,r=__rest(e,["threadRootMessages"]),i=(yield this.core.sendCmd("qchatGetThreadRootMessagesMeta",{qchatMsgs:t,tag:r})).content.metas;return i&&i.length>0?i.map((e=>Object.assign(Object.assign({},e),{total:parseInt(e.total),timestamp:parseInt(e.timestamp),msgTime:parseInt(e.msgTime)}))):[]}))}getQuickComments(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.sendCmd("qchatGetQuickComments",{tag:{serverId:e.serverId,channelId:e.channelId,msgIdServerList:JSON.stringify(e.msgList.map((e=>e.msgIdServer)))}}),{quickCommentResponse:r}=t.content;return function formatQuickComments(e){var t=e.map((e=>{var t=format(cl,e);return t.details=t.details.map((e=>{var t=e.createTime?parseInt(e.createTime):0;return t=isNaN(t)?0:t,{count:e.count,hasSelf:e.self,severalAccids:e.topN,type:e.type,createTime:t}})),t})),r={};return t.forEach((e=>r[e.msgIdServer]=e)),r}(r)}))}updateQuickComment(e,t){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},commentMessage:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1}}}},e);var{serverId:r,channelId:i,fromAccount:n,msgIdServer:a,time:s}=e.commentMessage;yield this.core.sendCmd("qchatUpdateQuickComment",{tag:{serverId:r,channelId:i,fromAccount:n,msgIdServer:a,time:s,type:e.type,opeType:t,opeAccid:this.core.account}})}))}sendTypingEvent(e){return __awaiter(this,void 0,void 0,(function*(){if(e.channelId===this.lastChannelIdInTyping)return this.logger.log("qchatMsg sendTypingEvent throttle"),void this._sendTypingEvent(e);this.lastChannelIdInTyping=e.channelId,this._sendTypingEvent.flush(),this._sendTypingEvent(e)}))}}class CategoryModuleService{constructor(e){this.core=e}addChannelCategoryRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},parentRoleId:{type:"string",allowEmpty:!1}},e),formatChannelCategoryRole((yield this.core.sendCmd("qchatAddChannelCategoryRole",{qchatAddChannelCategoryRoleTag:e})).content.channelCategoryRole)}))}removeChannelCategoryRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("qchatRemoveChannelCategoryRole",e)}))}updateChannelCategoryRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},auths:{type:"object"}},e);var t=yield this.core.sendCmd("qchatUpdateChannelCategoryRole",{qchatUpdateChannelCategoryRoleTag:generatorRoleForCmd(e)});if(406===t.raw.code)throw new CustomError("No update required",{},406);return formatChannelCategoryRole(t.content.channelCategoryRole)}))}getChannelCategoryRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}},e),function formatChannelCategoryRoles(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatChannelCategoryRole(e))):[]}((yield this.core.sendCmd("qchatGetChannelCategoryRole",{qchatGetChannelCategoryRoleTag:e})).content.list)}))}addChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1}},e),formatChannelCategoryMemberRole((yield this.core.sendCmd("qchatAddChannelCategoryMemberRole",{qchatAddChannelCategoryMemberRoleTag:e})).content.channelCategoryMemberRole)}))}removeChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("qchatRemoveChannelCategoryMemberRole",e)}))}updateChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},auths:{type:"object"}},e);var t=yield this.core.sendCmd("qchatUpdateChannelCategoryMemberRole",{qchatUpdateChannelCategoryMemberRoleTag:generatorRoleForCmd(e)});if(406===t.raw.code)throw new CustomError("No update required",{},406);return formatChannelCategoryMemberRole(t.content.channelCategoryMemberRole)}))}getChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}},e),function formatChannelCategoryMemberRoles(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatChannelCategoryMemberRole(e))):[]}((yield this.core.sendCmd("qchatGetChannelCategoryMemberRole",{qchatGetChannelCategoryMemberRoleTag:e})).content.list)}))}}var hl=Yr((function(e,t){return ar(e)?$i(e,js(t,1,ar,!0)):[]}));class V2NIMConversationModelImpl{constructor(){this.map=new Map,this.readTimeMap=new Map}set(e){e.forEach((e=>{e=this.processConversation(e),this.map.set(e.conversationId,e)}))}reset(){this.map.clear()}count(){return this.map.size}sort(){var e=Array.from(this.map.values());e.sort(((e,t)=>t.sortOrder-e.sortOrder)),this.map.clear(),e.forEach((e=>{this.map.set(e.conversationId,e)}))}processConversation(e){return"string"==typeof e.lastMessage&&delete e.lastMessage,void 0===e.localExtension&&(e.localExtension=""),e}getById(e){return this.map.get(e)}getAll(){return Array.from(this.map.values()).sort(((e,t)=>t.sortOrder-e.sortOrder))}getByOption(e,t,r){var{conversationTypes:i,onlyUnread:n,conversationGroupIds:a}=r,s=[];this.map.forEach((e=>{if((!(i&&i.length>0)||i.includes(e.type))&&(!n||e.unreadCount)&&(!r.ignoreMuted||!e.mute)){if(a){var t=e.groupIds,o=(null==t?void 0:t.length)||0;if(0===a.length&&o>0)return;if(a.length>0&&0===o)return;if(a.length>0&&o>0&&!a.some((e=>t&&t.includes(e))))return}s.push(e)}})),s=s.sort(((e,t)=>t.sortOrder-e.sortOrder));var o=0;e>0&&(o=findIndexWithinTargetValue(s,"sortOrder",e),s[o]&&s[o].sortOrder===e&&(o+=1));var c=s.slice(o).length;return(s=s.slice(o,o+t)).length>0?{offset:c>t?s[s.length-1].sortOrder:0,finished:!(c>t),conversationList:s}:{offset:0,finished:!0,conversationList:s}}upsert(e){var t=e.conversationId,r=this.map.get(t);if(!r)return e=this.processConversation(Object.assign({},e)),this.map.set(t,e),e.unreadCount>0;var i=e.unreadCount!==r.unreadCount,n=Object.assign({},r,e);return n=this.processConversation(n),this.map.set(t,n),i}bulkUpsert(e){var t=!1;return e.forEach((e=>{this.upsert(e)&&(t=!0)})),t}deleteById(e){var t=this.getById(e);if(t)return this.map.delete(e),t}updateReadTime(e,t){this.readTimeMap.set(e,t)}getReadTime(e){return this.readTimeMap.get(e)||0}}class V2NIMConversationIdUtilImpl{constructor(e){this.core=e}p2pConversationId(e){return`${this.core.account}|${Oe.V2NIM_CONVERSATION_TYPE_P2P}|${e}`}teamConversationId(e){return`${this.core.account}|${Oe.V2NIM_CONVERSATION_TYPE_TEAM}|${e}`}superTeamConversationId(e){return`${this.core.account}|${Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM}|${e}`}messageConversationId(e){return e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P?e.senderId===this.core.account?this.p2pConversationId(e.receiverId):this.p2pConversationId(e.senderId):e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_TEAM?this.teamConversationId(e.receiverId):this.superTeamConversationId(e.receiverId)}parseConversationType(e){try{if(e&&e.startsWith(`${this.core.account}|`)){var t=e.replace(`${this.core.account}|`,"");return Number(t[0])}return this.core.logger.warn(`conversationId is not start with ${this.core.account}`),Oe.V2NIM_CONVERSATION_TYPE_UNKNOWN}catch(e){return Oe.V2NIM_CONVERSATION_TYPE_UNKNOWN}}parseConversationTargetId(e){try{return e&&e.startsWith(`${this.core.account}|`)?e.replace(`${this.core.account}|`,"").slice(2):(this.core.logger.warn(`conversationId is not start with ${this.core.account}`),"")}catch(e){return""}}convertToV1ConversationId(e){var t=this.parseConversationType(e),r=this.parseConversationTargetId(e);return`${t===Oe.V2NIM_CONVERSATION_TYPE_P2P?"p2p":t===Oe.V2NIM_CONVERSATION_TYPE_TEAM?"team":"superTeam"}|${r}`}}var gl=function isEqual(e,t){return ea(e,t)},vl={"31_1":"v2TeamCreate","32_1":"v2SuperTeamCreate","31_5":"v2TeamInviteMembers","32_5":"v2SuperTeamInviteMembers","31_6":"v2TeamKickMembers","32_6":"v2SuperTeamKickMembers","31_8":"v2TeamLeave","32_7":"v2SuperTeamLeave","31_7":"v2TeamUpdateInfo","32_8":"v2SuperTeamUpdateInfo","31_9":"v2TeamGetInfo","32_9":"v2SuperTeamGetInfo","31_12":"v2TeamDismiss","32_4":"v2SuperTeamDismiss","31_13":"v2TeamApplyToJoin","32_20":"v2SuperTeamApplyToJoin","31_14":"v2TeamAcceptJoinApplication","32_21":"v2SuperTeamAcceptJoinApplication","31_15":"v2TeamRejectJoinApplication","32_22":"v2SuperTeamRejectJoinApplication","31_16":"v2TeamAddManagers","32_26":"v2SuperTeamAddManagers","31_17":"v2TeamRemoveManagers","32_27":"v2SuperTeamRemoveManagers","31_18":"v2TeamTransferOwner","32_31":"v2SuperTeamTransferOwner","31_19":"v2TeamUpdateSelfMemberInfo","32_10":"v2SuperTeamUpdateSelfMemberInfo","31_20":"v2TeamUpdateMember","32_30":"v2SuperTeamUpdateMember","31_21":"v2TeamAcceptInvitation","32_23":"v2SuperTeamAcceptInvitation","31_22":"v2TeamRejectInvite","32_24":"v2SuperTeamRejectInvite","31_33":"v2TeamGetMemberInvitor","32_35":"v2SuperTeamGetMemberInvitor","31_25":"v2TeamMemberSetChatBannedStatus","32_29":"v2SuperTeamMemberSetChatBannedStatus","31_32":"v2TeamSetChatBannedMode","32_28":"v2SuperTeamSetChatBannedMode","31_34":"v2TeamGetByIds","32_36":"v2SuperTeamGetByIds","31_35":"v2TeamMemberGetListByIds","32_37":"v2SuperTeamMemberGetListByIds","31_36":"v2TeamMemberGetList","8_101":"v2TeamCreateMultiSync","8_109":"v2TeamSync","8_119":"v2TeamMemberUpdateMultiSync","8_126":"v2TeamMembersOfSelfInSync","21_101":"v2SuperTeamCreateMultiSync","21_109":"v2SuperTeamSync","21_110":"v2SuperTeamMemberUpdateMultiSync","21_111":"v2SuperTeamMembersOfSelfInSync"},yl={antispamBusinessId:1},Il="V2NIMTeamService",_l={teamId:1,name:3,teamType:{id:4,retConverter:e=>0==+e?1:+e},ownerAccountId:5,memberLimit:{id:6,retType:"number"},isValidTeam:{id:8,retConverter:(e,t)=>1==+e&&(void 0===t[13]||1==+t[13])},memberCount:{id:9,retType:"number"},memberUpdateTime:{id:10,retType:"number"},createTime:{id:11,retType:"number"},updateTime:{id:12,retType:"number"},intro:14,announcement:15,joinMode:{id:16,retType:"number"},serverExtension:18,customerExtension:19,avatar:20,agreeMode:{id:21,retType:"number"},inviteMode:{id:22,retType:"number"},updateInfoMode:{id:23,retType:"number"},updateExtensionMode:{id:24,retType:"number"},chatBannedMode:{id:101,retType:"number"}},Ml={teamId:1,accountId:3,memberRole:{id:4,retType:"number"},teamNick:5,bits:{id:7,retType:"number"},inTeam:{id:9,retType:"boolean"},joinTime:{id:10,retType:"number"},updateTime:{id:11,retType:"number"},serverExtension:12,chatBanned:{id:13,retType:"boolean"},invitorAccountId:14},fl={teamId:1,accountId:3,memberRole:{id:4,retType:"number"},teamNick:5,bits:{id:7,retType:"number"},inTeam:{id:9,retType:"boolean"},updateTime:{id:11,retType:"number"},serverExtension:12,chatBanned:{id:13,retType:"boolean"},invitorAccountId:14,joinTime:{id:15,retType:"number"}},Tl={teamId:1,teamType:2,roleQueryType:3,onlyChatBanned:{id:4,converter:e=>+e},nextToken:5,limit:6,direction:7},El={v2TeamCreate:{sid:31,cid:1,service:Il,params:[{type:"Property",name:"team",reflectMapper:_l},{type:"StrArray",name:"inviteeAccountIds"},{type:"String",name:"postscript"},{type:"Property",name:"antispamConfig",reflectMapper:yl}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(_l)},{type:"StrArray",name:"failedList"}]},v2SuperTeamCreate:{sid:32,cid:1,service:Il,params:[{type:"Property",name:"team",reflectMapper:_l},{type:"StrArray",name:"inviteeAccountIds"},{type:"String",name:"postscript"},{type:"Property",name:"antispamConfig",reflectMapper:yl}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(_l)},{type:"StrArray",name:"failedList"}]},v2TeamInviteMembers:{sid:31,cid:5,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"Long",name:"time"},{type:"StrArray",name:"abortedAccidList"}]},v2SuperTeamInviteMembers:{sid:32,cid:5,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"StrArray",name:"abortedAccidList"},{type:"Long",name:"time"}]},v2TeamUpdateInfo:{sid:31,cid:7,service:Il,params:[{type:"Property",name:"team",reflectMapper:_l},{type:"Property",name:"antispamConfig",reflectMapper:yl}],response:[{type:"Long",name:"teamId"},{type:"Long",name:"timestamp"}]},v2SuperTeamUpdateInfo:{sid:32,cid:8,service:Il,params:[{type:"Property",name:"team",reflectMapper:_l},{type:"Property",name:"antispamConfig",reflectMapper:yl}],response:[{type:"Long",name:"timestamp"}]},v2TeamLeave:{sid:31,cid:8,service:Il,params:[{type:"Long",name:"teamId"}]},v2SuperTeamLeave:{sid:32,cid:7,service:Il,params:[{type:"Long",name:"teamId"}]},v2TeamGetInfo:{sid:31,cid:9,service:Il,params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(_l)}]},v2SuperTeamGetInfo:{sid:32,cid:9,service:Il,params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(_l)}]},v2TeamGetByIds:{sid:31,cid:34,service:Il,params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:invertSerializeItem(_l)},{type:"LongArray",name:"tids"}]},v2SuperTeamGetByIds:{sid:32,cid:36,service:Il,params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:invertSerializeItem(_l)},{type:"LongArray",name:"tids"}]},v2TeamDismiss:{sid:31,cid:12,service:Il,params:[{type:"Long",name:"teamId"}]},v2SuperTeamDismiss:{sid:32,cid:4,service:Il,params:[{type:"Long",name:"teamId"}]},v2TeamAcceptInvitation:{sid:31,cid:21,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(_l)}]},v2SuperTeamAcceptInvitation:{sid:32,cid:23,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(_l)}]},v2TeamRejectInvite:{sid:31,cid:22,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2SuperTeamRejectInvite:{sid:32,cid:24,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2TeamKickMembers:{sid:31,cid:6,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamKickMembers:{sid:32,cid:6,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamApplyToJoin:{sid:31,cid:13,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(_l)}]},v2SuperTeamApplyToJoin:{sid:32,cid:20,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(_l)}]},v2TeamAcceptJoinApplication:{sid:31,cid:14,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},v2SuperTeamAcceptJoinApplication:{sid:32,cid:21,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},v2TeamRejectJoinApplication:{sid:31,cid:15,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2SuperTeamRejectJoinApplication:{sid:32,cid:22,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2TeamAddManagers:{sid:31,cid:16,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamAddManagers:{sid:32,cid:26,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamRemoveManagers:{sid:31,cid:17,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamRemoveManagers:{sid:32,cid:27,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamTransferOwner:{sid:31,cid:18,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},v2SuperTeamTransferOwner:{sid:32,cid:31,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},v2TeamUpdateSelfMemberInfo:{sid:31,cid:19,service:Il,params:[{type:"Property",name:"teamMember",reflectMapper:Ml}]},v2SuperTeamUpdateSelfMemberInfo:{sid:32,cid:10,service:Il,params:[{type:"Property",name:"teamMember",reflectMapper:fl}]},v2TeamUpdateMember:{sid:31,cid:20,service:Il,params:[{type:"Property",name:"teamMember",reflectMapper:Ml}]},v2SuperTeamUpdateMember:{sid:32,cid:30,service:Il,params:[{type:"Property",name:"teamMember",reflectMapper:fl}]},v2TeamGetMemberInvitor:{sid:31,cid:33,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"StrStrMap",name:"accountsMap"}]},v2SuperTeamGetMemberInvitor:{sid:32,cid:35,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"StrStrMap",name:"accountsMap"}]},v2TeamMemberSetChatBannedStatus:{sid:31,cid:25,service:Il,params:[{type:"Long",name:"teamId"},{type:"String",name:"accountId"},{type:"Int",name:"chatBanned"}]},v2SuperTeamMemberSetChatBannedStatus:{sid:32,cid:29,service:Il,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accountId"},{type:"Int",name:"chatBanned"}]},v2TeamSetChatBannedMode:{sid:31,cid:32,service:Il,params:[{type:"Long",name:"teamId"},{type:"Int",name:"chatBannedMode"}]},v2SuperTeamSetChatBannedMode:{sid:32,cid:28,service:Il,params:[{type:"Long",name:"teamId"},{type:"Int",name:"chatBannedMode"}]},v2TeamMemberGetListByIds:{sid:31,cid:35,service:Il,params:[{type:"StrArray",name:"tag"}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ml)}]},v2SuperTeamMemberGetListByIds:{sid:32,cid:37,service:Il,params:[{type:"StrArray",name:"tag"}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(fl)}]},v2TeamMemberGetList:{sid:31,cid:36,service:Il,params:[{type:"Property",name:"tag",reflectMapper:Tl}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ml)},{type:"Property",name:"pageInfo",reflectMapper:{1:"hasMore",2:"nextToken"}}]},v2TeamSync:{sid:8,cid:109,service:Il,response:[{type:"Long",name:"timetag"},{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(_l)}]},v2TeamCreateMultiSync:{sid:8,cid:101,service:Il,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(_l)}]},v2TeamMemberUpdateMultiSync:{sid:8,cid:119,service:Il,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ml)}]},v2TeamMembersOfSelfInSync:{sid:8,cid:126,service:Il,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ml)},{type:"Long",name:"timetag"}]},v2SuperTeamSync:{sid:21,cid:109,service:Il,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(_l)},{type:"Bool",name:"isAll"},{type:"Long",name:"timetag"}]},v2SuperTeamCreateMultiSync:{sid:21,cid:101,service:Il,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(_l)}]},v2SuperTeamMemberUpdateMultiSync:{sid:21,cid:110,service:Il,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(fl)}]},v2SuperTeamMembersOfSelfInSync:{sid:21,cid:111,service:Il,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(fl)},{type:"Long",name:"timetag"}]}};function formatTeamNotificationAttachData(e,t){if(!e)return{};var r=e;return r.tinfo&&(r.tinfo=function formatTeamFromTinfo(e){return deserialize(e,invertSerializeItem(_l))}(r.tinfo),r.tinfo.teamType=t),r.uinfos,void 0!==r.mute&&(r.mute=parseInt(r.mute)),r}function generateTeamByTeamId(e,t,r={}){return Object.assign({teamId:e,teamType:t,name:"",ownerAccountId:"",memberLimit:0,memberCount:0,createTime:0,updateTime:0,intro:"",announcement:"",avatar:"",joinMode:st.V2NIM_TEAM_JOIN_MODE_FREE,agreeMode:ot.V2NIM_TEAM_AGREE_MODE_AUTH,inviteMode:ct.V2NIM_TEAM_INVITE_MODE_MANAGER,updateInfoMode:dt.V2NIM_TEAM_UPDATE_INFO_MODE_MANAGER,updateExtensionMode:mt.V2NIM_TEAM_UPDATE_EXTENSION_MODE_MANAGER,chatBannedMode:lt.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN,isValidTeam:!0,messageNotifyMode:pt.V2NIM_TEAM_MESSAGE_NOTIFY_MODE_ALL},r)}function generateMemberByTeamId(e,t,r,i={}){return Object.assign({teamId:e,teamType:t,accountId:r,joinTime:0,inTeam:!0,memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_NORMAL,chatBanned:!1},i)}function processTeamMembers(e,t=at.V2NIM_TEAM_TYPE_ADVANCED){return e.map((e=>function processTeamMember(e,t=at.V2NIM_TEAM_TYPE_ADVANCED){return e.teamType=t,e.chatBanned=void 0!==e.chatBanned&&e.chatBanned,e}(e,t)))}function completeMessage(e,t){var r,i=Object.assign(Object.assign({},t),{conversationId:e.V2NIMConversationIdUtil.messageConversationId(t),isSelf:t.senderId===e.account,sendingState:We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED,messageStatus:{errorCode:(null===(r=null==t?void 0:t.messageStatus)||void 0===r?void 0:r.errorCode)||200}});return i.threadReply&&(i.threadReply=Object.assign(Object.assign({},i.threadReply),{conversationType:i.conversationType,conversationId:i.conversationId})),i.threadRoot&&(i.threadRoot=Object.assign(Object.assign({},i.threadRoot),{conversationType:i.conversationType,conversationId:i.conversationId})),i}function completeMessageRefer(e,t){return Object.assign(Object.assign({},t),{conversationId:e.V2NIMConversationIdUtil.messageConversationId(t)})}function formatMessageRefer(e,t){var{createTime:r,senderId:i,receiverId:n,conversationType:a}=t;return{conversationType:a,conversationId:e.V2NIMConversationIdUtil.messageConversationId({conversationType:a,senderId:i,receiverId:n}),senderId:t.senderId,receiverId:t.receiverId,messageServerId:t.messageServerId,createTime:r,messageClientId:t.messageClientId}}function formatRevokeMessage(e,t){var r={7:Ke.V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY,8:Ke.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY,12:Ke.V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY,13:Ke.V2NIM_MESSAGE_REVOKE_TYPE_P2P_ONEWAY,14:Ke.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_ONEWAY},i={7:Oe.V2NIM_CONVERSATION_TYPE_P2P,8:Oe.V2NIM_CONVERSATION_TYPE_TEAM,12:Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM,13:Oe.V2NIM_CONVERSATION_TYPE_P2P,14:Oe.V2NIM_CONVERSATION_TYPE_TEAM}[t.sysMsgType];return{postscript:t.postscript,revokeType:r[t.sysMsgType]||Ke.V2NIM_MESSAGE_REVOKE_TYPE_UNDEFINED,revokeAccountId:t.opeAccount||t.senderId,callbackExtension:t.callbackExtension,serverExtension:t.attach||"",messageRefer:{conversationType:i,conversationId:e.V2NIMConversationIdUtil.messageConversationId(Object.assign(Object.assign({},t),{conversationType:i,senderId:t.senderId,receiverId:t.receiverId})),senderId:t.senderId,receiverId:t.receiverId,messageServerId:t.messageServerId,createTime:t.deleteMsgCreatetime,messageClientId:t.messageClientId}}}function formatClearHistoryNotification(e,t){return{conversationId:t.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P?e.V2NIMConversationIdUtil.p2pConversationId(t.receiverId):t.conversationType===Oe.V2NIM_CONVERSATION_TYPE_TEAM?e.V2NIMConversationIdUtil.teamConversationId(t.teamId):e.V2NIMConversationIdUtil.superTeamConversationId(t.teamId),deleteTime:t.deleteTime,serverExtension:t.serverExtension}}function convertNotificationType(e,t){var r={0:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE,401:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE,1:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_KICK,402:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_KICK,2:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_LEAVE,403:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_LEAVE,3:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_UPDATE_TINFO,404:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_UPDATE_TINFO,4:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_DISMISS,405:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_DISMISS,5:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_APPLY_PASS,410:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_APPLY_PASS,6:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_OWNER_TRANSFER,406:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_OWNER_TRANSFER,7:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_ADD_MANAGER,407:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_ADD_MANAGER,8:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_REMOVE_MANAGER,408:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_REMOVE_MANAGER,9:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE_ACCEPT,411:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE_ACCEPT,10:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_BANNED_TEAM_MEMBER,409:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_BANNED_TEAM_MEMBER};return void 0===r[t]&&e.logger.warn(`[V2NIMMessageService] undefined notification type: ${t}`),"number"==typeof r[t]?r[t]:Ye.V2NIM_MESSAGE_NOTIFICATION_TYPE_UNDEFINED}function formatMessageAttachment(e,t){return e.messageType===He.V2NIM_MESSAGE_TYPE_NOTIFICATION?function formatNotificationMessage(e,t){var r,i,n,a,s,o=t.attachment||{};if(t.attachment&&"type"in t.attachment)return t;var c=void 0;if(null===(r=o.data)||void 0===r?void 0:r.tinfo){var{id:d,data:l}=o,m=d>400?at.V2NIM_TEAM_TYPE_SUPER:at.V2NIM_TEAM_TYPE_ADVANCED,{tinfo:p}=formatTeamNotificationAttachData(Object.assign({},l),m);c={},c=__rest(p,["teamId"])}var u=Object.assign(Object.assign(Object.assign(Object.assign({raw:o.raw,type:convertNotificationType(e,o.id)},c?{updatedTeamInfo:c}:{}),{targetIds:(null===(i=o.data)||void 0===i?void 0:i.ids)||((null===(n=o.data)||void 0===n?void 0:n.id)?[o.data.id]:[])}),"string"==typeof(null===(a=o.data)||void 0===a?void 0:a.attach)?{serverExtension:o.data.attach}:{}),"number"==typeof(null===(s=o.data)||void 0===s?void 0:s.mute)?{chatBanned:o.data.mute!==rt.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF}:{});return Object.assign(Object.assign({},t),{attachment:u})}(t,e):e}function attachmentToRaw(e,t){if(!t)return"";switch(e){case He.V2NIM_MESSAGE_TYPE_CUSTOM:return t.raw||"";case He.V2NIM_MESSAGE_TYPE_IMAGE:case He.V2NIM_MESSAGE_TYPE_VIDEO:case He.V2NIM_MESSAGE_TYPE_AUDIO:case He.V2NIM_MESSAGE_TYPE_FILE:return function mediaAttachmentToRaw(e){var t=e,{width:r,height:i,duration:n,path:a,file:s,raw:o,ctx:c,payload:d,bucketName:l,objectName:m,token:p,ext:u}=t,h=__rest(t,["width","height","duration","path","file","raw","ctx","payload","bucketName","objectName","token","ext"]),g="string"==typeof u&&"."===u[0]?u.slice(1):u;return JSON.stringify(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},h),void 0===u?{}:{ext:g}),void 0===r?{}:{w:r}),void 0===i?{}:{h:i}),void 0===n?{}:{dur:n}))}(t);case He.V2NIM_MESSAGE_TYPE_LOCATION:return function locationAttachmentToRaw(e){return JSON.stringify({lat:e.latitude,lng:e.longitude,title:e.address})}(t);case He.V2NIM_MESSAGE_TYPE_CALL:return function callAttachmentToRaw(e){var t=__rest(e,["raw"]);try{return JSON.stringify(Object.assign(Object.assign({},t),{durations:e.durations.map((e=>({accid:e.accountId,duration:e.duration})))}))}catch(t){return JSON.stringify(e)}}(t);default:return t.raw||JSON.stringify(t)}}function rawToAttachment(e,t){var r;try{switch(r=JSON.parse(e),t){case He.V2NIM_MESSAGE_TYPE_CUSTOM:return{raw:e};case He.V2NIM_MESSAGE_TYPE_LOCATION:return function locationRawToAttachment(e,t){return{latitude:t.lat,longitude:t.lng,address:t.title,raw:e}}(e,r);case He.V2NIM_MESSAGE_TYPE_AUDIO:case He.V2NIM_MESSAGE_TYPE_VIDEO:case He.V2NIM_MESSAGE_TYPE_IMAGE:case He.V2NIM_MESSAGE_TYPE_FILE:return function mediaRawToAttachment(e,t){var{w:r,h:i,dur:n,ext:a}=t,s=__rest(t,["w","h","dur","ext"]),o="string"==typeof a&&"."!==a[0]?`.${a}`:a;return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},s),void 0===a?{}:{ext:o}),void 0===r?{}:{width:r}),void 0===i?{}:{height:i}),void 0===n?{}:{duration:n}),{raw:e})}(e,r);case He.V2NIM_MESSAGE_TYPE_CALL:return function callRawToAttachment(e,t){return Object.assign(Object.assign({},t),{durations:t.durations.map((e=>({accountId:e.accid,duration:e.duration}))),raw:e})}(e,r);default:return"object"==typeof r&&r?Object.assign(Object.assign({},r),{raw:e}):{raw:e}}}catch(t){return"object"==typeof r&&r?Object.assign(Object.assign({},r),{raw:e}):{raw:e}}}var Sl="V2NIMMessageService",Cl={"30_1":"v2SendP2pMessage","31_2":"v2SendTeamMessage","30_31":"v2MessageP2pModify","31_37":"v2MessageTeamModify","32_38":"v2MessageSuperTeamModify","7_33":"v2MessageOnModified","4_27":"v2MessageSyncModified","4_28":"v2MessageSuperTeamSyncModified","4_5":"v2BatchMarkRead","4_12":"syncP2PMessagReceipts","30_11":"v2SendP2PMessageReceipt","31_28":"v2SendTeamMessageReceipts","32_2":"v2SendSuperTeamMessage","7_12":"onP2PMessageReceipts","8_31":"onTeamMessageReceipts","31_29":"v2GetTeamMessageReceipts","31_30":"v2GetTeamMessageReceiptDetail","7_2":"onMsg","8_3":"onMsg","7_101":"onMsg","8_102":"onMsg","21_3":"onMsg","21_102":"onMsg","4_4":"syncOfflineMsgs","4_9":"syncRoamingMsgs","4_17":"syncRoamingMsgs","30_13":"v2RevokeMessage","32_17":"v2RevokeSuperTeamMessage","7_14":"onRevokeMessage","7_15":"syncRevokeMessage","21_18":"onRevokeMessage","21_117":"onRevokeMessage","30_23":"v2DeleteMessage","30_24":"v2DeleteMessages","4_21":"syncOnDeleteMessages","7_123":"onDeleteMessage","7_124":"onDeleteMessages","29_17":"v2DownloadLocalAntiSpamVocabs"},Nl={conversationType:{id:0,converter:conversationTypeV2ToV1,retConverter:conversationTypeV1ToV2},receiverId:1,senderId:2,fromClientType:4,fromDeviceId:5,fromNick:6,createTime:{id:7,retType:"number"},messageType:{id:8,retType:"number"},text:9,attachment:{id:10,converter:(e,t)=>attachmentToRaw(t.messageType,e),retConverter:(e,t)=>rawToAttachment(e,Number(t[8]))},messageClientId:11,messageServerId:12,resend:{id:13,converter:boolToInt,retType:"boolean"},userUpdateTime:{id:14,retType:"number"},serverExtension:15,pushPayload:{id:16,access:"pushConfig.pushPayload"},pushContent:{id:17,access:"pushConfig.pushContent"},forcePushAccountIds:{id:18,access:"pushConfig.forcePushAccountIds",def:e=>{if(e["pushConfig.forcePush"])return"#%@all@%#"},converter:(e,t)=>{if(t["pushConfig.forcePush"]){if(0===e.length)return"#%@all@%#";try{return JSON.stringify(e)}catch(e){return"#%@all@%#"}}},retConverter(e){if("#%@all@%#"===e)return e;if(e)try{return JSON.parse(e)}catch(e){return[]}}},forcePushContent:{id:19,access:"pushConfig.forcePushContent"},forcePush:{id:20,access:"pushConfig.forcePush",converter:boolToInt,retType:"boolean"},antispamCustomMessageEnabled:{id:21,def:e=>Ne(e,"antispamConfig.antispamCustomMessage")?1:void 0,retConverter:()=>{}},antispamCustomMessage:{id:22,access:"antispamConfig.antispamCustomMessage"},antispamBusinessId:{id:23,access:"antispamConfig.antispamBusinessId"},clientAntispamHit:{id:24,access:"clientAntispamHit",converter:boolToInt,retType:"boolean"},antispamEnabled:{id:25,access:"antispamConfig.antispamEnabled",converter:boolToInt,retType:"boolean"},needAck:{id:26,access:"messageConfig.readReceiptEnabled",converter:boolToInt,retType:"boolean"},lastMessageUpdateEnabled:{id:28,access:"messageConfig.lastMessageUpdateEnabled",converter:boolToInt,retType:"boolean"},threadReplySenderId:{id:29,access:"threadReply.senderId"},threadReplyReceiverId:{id:30,access:"threadReply.receiverId"},threadReplyTime:{id:31,access:"threadReply.createTime",retType:"number"},threadReplyServerId:{id:32,access:"threadReply.messageServerId"},threadReplyClientId:{id:33,access:"threadReply.messageClientId"},threadRootSenderId:{id:34,access:"threadRoot.senderId"},threadRootReceiverId:{id:35,access:"threadRoot.receiverId"},threadRootTime:{id:36,access:"threadRoot.createTime",retType:"number"},threadRootServerId:{id:37,access:"threadRoot.messageServerId"},threadRootClientId:{id:38,access:"threadRoot.messageClientId"},callbackExtension:40,subType:{id:41,retType:"number"},antispamCheating:{id:42,access:"antispamConfig.antispamCheating"},routeEnvironment:{id:43,access:"routeConfig.routeEnvironment"},antispamExtension:{id:44,access:"antispamConfig.antispamExtension"},antispamResult:45,__clientExt:{id:46,converter:objectToJSONString,retConverter:stringToJSONObject},robotFunction:{id:47,access:"robotConfig.function"},robotTopic:{id:48,access:"robotConfig.topic"},robotCustomContent:{id:49,access:"robotConfig.customContent"},robotAccount:{id:50,access:"robotConfig.accountId"},_conversationOnlineSyncNotify:{id:51},_conversationOnlineSyncData:{id:52},aiAgentMsgDirection:{id:55,access:"aiConfig.aiStatus",retAccess:"aiConfig.aiStatus",retType:"number"},aiAgentAccount:{id:56,access:"aiConfig.accountId",retAccess:"aiConfig.accountId"},aiAgentContent:{id:57,access:"aiConfig.content",converter:objectToJSONString,retConverter:emptyFunc$1},aiAgentMessages:{id:58,access:"aiConfig.messages",converter:objectToJSONString,retConverter:emptyFunc$1},aiAgentPromptVariables:{id:59,access:"aiConfig.promptVariables",retConverter:emptyFunc$1},aiAgentModelConfigParams:{id:60,access:"aiConfig.modelConfigParams",converter:objectToJSONString,retConverter:emptyFunc$1},errorCode:{id:61,access:"messageStatus.errorCode",retType:"number"},modifyTime:{id:62,retType:"number"},modifyAccountId:63,historyEnabled:{id:100,access:"messageConfig.historyEnabled",converter:boolToInt,retType:"boolean"},roamingEnabled:{id:101,access:"messageConfig.roamingEnabled",converter:boolToInt,retType:"boolean"},onlineSyncEnabled:{id:102,access:"messageConfig.onlineSyncEnabled",converter:boolToInt,retType:"boolean"},routeEnabled:{id:105,access:"routeConfig.routeEnabled",converter:boolToInt,retType:"boolean"},pushEnable:{id:107,access:"pushConfig.pushEnabled",converter:boolToInt,retType:"boolean"},offlineEnabled:{id:108,access:"messageConfig.offlineEnabled",converter:boolToInt,retType:"boolean"},unreadEnabled:{id:109,access:"messageConfig.unreadEnabled",converter:boolToInt,retType:"boolean"},pushNickEnabled:{id:110,access:"pushConfig.pushNickEnabled",converter:boolToInt,retType:"boolean"},msgAckSnapshot:{id:112,retType:"number"},receiverIds:{id:154,access:"targetConfig.receiverIds",converter:objectToJSONString,retConverter:()=>{}},inclusive:{id:155,access:"targetConfig.inclusive",converter:e=>e?1:2,retConverter:()=>{}},newMemberVisible:{id:156,access:"targetConfig.newMemberVisible",converter:boolToInt,retConverter:()=>{}}},Al=invertSerializeItem(Nl),bl={conversationType:{id:1,access:"messageRefer.conversationType",retType:"number"},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},messageServerId:{id:4,access:"messageRefer.messageServerId"},messageClientId:{id:5,access:"messageRefer.messageClientId"},createTime:{id:6,access:"messageRefer.createTime",retType:"number"},deleteTime:{id:7,retType:"number"},serverExtension:8};invertSerializeItem(bl);var Rl={version:1,md5:2,nosurl:3,thesaurus:4},Ol={createTime:{id:0,retType:"number"},sysMsgType:1,receiverId:2,senderId:3,postscript:4,attach:5,pushContent:8,pushPayload:9,messageClientId:10,messageServerId:11,deleteMsgCreatetime:{id:14,retType:"number"},opeAccount:16,env:21,callbackExtension:22},Pl={receiverId:0,messageServerId:1,readCount:{id:100,retType:"number"},unreadCount:{id:101,retType:"number"},messageClientId:102,latestReadAccount:103},Vl={v2BatchMarkRead:{sid:4,cid:5,service:Sl,hasPacketResponse:!1,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]},v2SendP2pMessage:{sid:30,cid:1,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Nl}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},onMsg:{sid:7,cid:2,service:Sl,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(Nl)}]},syncOfflineMsgs:{sid:4,cid:4,service:Sl,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Nl)}]},syncRoamingMsgs:{sid:4,cid:9,service:Sl,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2SendP2PMessageReceipt:{sid:30,cid:11,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Nl}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2RevokeMessage:{sid:30,cid:13,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Ol}]},v2DeleteMessage:{sid:30,cid:23,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:bl}],response:[{type:"Long",name:"timetag"}]},v2DeleteMessages:{sid:30,cid:24,service:Sl,params:[{type:"PropertyArray",name:"tag",reflectMapper:bl}],response:[{type:"Long",name:"timetag"}]},v2SendTeamMessage:{sid:31,cid:2,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Nl}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2SendTeamMessageReceipts:{sid:31,cid:28,service:Sl,params:[{type:"PropertyArray",name:"tag",reflectMapper:Pl}],response:[{type:"PropertyArray",name:"tag",reflectMapper:invertSerializeItem(Pl)}]},v2SendSuperTeamMessage:{sid:32,cid:2,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Nl}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2RevokeSuperTeamMessage:{sid:32,cid:17,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Ol}]},syncP2PMessagReceipts:{sid:4,cid:12,service:Sl,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Nl)}]},onP2PMessageReceipts:{sid:7,cid:12,service:Sl,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2GetTeamMessageReceipts:{sid:31,cid:29,service:Sl,params:[{type:"PropertyArray",name:"tag",reflectMapper:Pl}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Pl)}]},v2GetTeamMessageReceiptDetail:{sid:31,cid:30,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Pl,select:["receiverId","messageServerId"]}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Pl)},{type:"StrArray",name:"readAccountList"},{type:"StrArray",name:"unreadAccountList"}]},onTeamMessageReceipts:{sid:8,cid:31,service:Sl,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Pl)}]},onRevokeMessage:{sid:7,cid:14,service:Sl,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Ol)}]},syncRevokeMessage:{sid:7,cid:15,service:Sl,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Ol)}]},syncOnDeleteMessages:{sid:4,cid:21,service:Sl,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(bl)}]},onDeleteMessage:{sid:7,cid:123,service:Sl,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(bl)}]},onDeleteMessages:{sid:7,cid:124,service:Sl,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(bl)}]},v2DownloadLocalAntiSpamVocabs:{sid:29,cid:17,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Rl}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Rl)}]},v2MessageP2pModify:{sid:30,cid:31,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Nl}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2MessageTeamModify:{sid:31,cid:37,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Nl}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2MessageSuperTeamModify:{sid:32,cid:38,service:Sl,params:[{type:"Property",name:"tag",reflectMapper:Nl}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2MessageOnModified:{sid:7,cid:33,service:Sl,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2MessageSyncModified:{sid:4,cid:27,service:Sl,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Nl)},{type:"Long",name:"time"}]},v2MessageSuperTeamSyncModified:{sid:4,cid:28,service:Sl,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Nl)},{type:"Long",name:"time"}]}};function conversationTypeV2ToV1(e){return e===Oe.V2NIM_CONVERSATION_TYPE_P2P?0:e===Oe.V2NIM_CONVERSATION_TYPE_TEAM?1:e===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?5:void 0}function conversationTypeV1ToV2(e){var t=parseInt(e);return 0===t?Oe.V2NIM_CONVERSATION_TYPE_P2P:1===t?Oe.V2NIM_CONVERSATION_TYPE_TEAM:5===t?Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM:Oe.V2NIM_CONVERSATION_TYPE_UNKNOWN}var kl={type:{type:"number"},lastMessageState:{type:"number"},unreadCount:{type:"number"},stickTop:{type:"boolean"},sortOrder:{type:"number"},version:{type:"number"},deleteFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}};function formatConversationFields(e,t){return t&&t.length>0?t.map((t=>formatConversationField(e,t))):[]}function formatLastMessageFromMessage(e,t,r=Pe.V2NIM_MESSAGE_STATUS_DEFAULT,i){var n,a;t=formatMessageAttachment(t,e);var{messageType:s,subType:o,text:c,attachment:d,serverExtension:l}=t,m="";if(t.senderId!==e.account){m=Ne(t,"fromNick");var p=null===(a=null===(n=e.V2NIMFriendService)||void 0===n?void 0:n.model)||void 0===a?void 0:a.getFriend(t.senderId);p&&p.alias&&(m=p.alias)}return JSON.parse(JSON.stringify({lastMessageState:r,messageRefer:formatMessageRefer(e,t),messageType:s,subType:o,text:c,attachment:d,serverExtension:l,callbackExtension:t.callbackExtension,sendingState:i,senderName:m}))}function formatLastMessageFromNotification(e,t){var{messageRefer:r,revokeAccountId:i,revokeType:n,callbackExtension:a,serverExtension:s,postscript:o}=t,c=function calcSenderNameFromNotification(e,t,r,i){var n,a,s,o,c,d;if(t!==e.account){var l=null===(a=null===(n=e.V2NIMFriendService)||void 0===n?void 0:n.model)||void 0===a?void 0:a.getFriend(t);if(l&&l.alias)return l.alias;if(r===Oe.V2NIM_CONVERSATION_TYPE_TEAM){var m=null===(o=null===(s=e.V2NIMTeamService)||void 0===s?void 0:s.memberModel)||void 0===o?void 0:o.getById(i,at.V2NIM_TEAM_TYPE_ADVANCED,t);if(m&&m.teamNick)return m.teamNick}else if(r===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM){var p=null===(d=null===(c=e.V2NIMTeamService)||void 0===c?void 0:c.memberModel)||void 0===d?void 0:d.getById(i,at.V2NIM_TEAM_TYPE_ADVANCED,t);if(p&&p.teamNick)return p.teamNick}var u=e.V2NIMUserService.model.getUser(t);return u&&u.name?u.name:void 0}}(e,t.revokeAccountId,t.messageRefer.conversationType,t.messageRefer.receiverId)||"";return JSON.parse(JSON.stringify({lastMessageState:Pe.V2NIM_MESSAGE_STATUS_REVOKE,messageRefer:r,revokeAccountId:i,revokeType:n,callbackExtension:a,serverExtension:s,text:o||"",senderName:c}))}function formatConversationField(e,t){var r=format(kl,t);if(r.groupIds?r.groupIds=JSON.parse(r.groupIds):delete r.groupIds,"string"==typeof r.lastMessage)if(""===r.lastMessage);else if(r.lastMessageState===Pe.V2NIM_MESSAGE_STATUS_REVOKE){var i=formatRevokeMessage(e,deserialize(JSON.parse(r.lastMessage),invertSerializeItem(Ol)));r.lastMessage=formatLastMessageFromNotification(e,i)}else if(r.lastMessageState===Pe.V2NIM_MESSAGE_STATUS_DEFAULT){var n=deserialize(JSON.parse(r.lastMessage),invertSerializeItem(Nl));r.lastMessage=formatLastMessageFromMessage(e,n,r.lastMessageState,n.senderId===e.account?We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED:void 0)}else r.lastMessageState===Pe.V2NIM_MESSAGE_STATUS_BACKFILL&&delete r.lastMessage;return r}function formatConversationByField(e){var{version:t,deleteFlag:r}=e;return{conversation:__rest(e,["version","deleteFlag"]),version:t,deleteFlag:r}}var wl={type:{type:"number"},oneClickClearUnreadType:{type:"number"},oneClickClearUnreadConversationType:{type:"object"},oneClickClearUnreadVersion:{type:"number"},deleteConversationClearMessage:{type:"boolean"}};function formatConversationNotify(e){return format(wl,e)}class V2NIMConversationVersionCacheImpl{constructor(e,t){this.fieldVersion={},this.conversationIdsForBackFill={},this.tempPacket=[],this.isSyncing=!1,this.nextCursor=0,this.core=e,this.service=t}reset(){this.tempPacket=[],this.fieldVersion={},this.conversationIdsForBackFill={},this.isSyncing=!1,this.nextCursor=0}doSync(){return __awaiter(this,void 0,void 0,(function*(){var e;this.isSyncing=!0,this.service.emit("onSyncStarted");try{e=yield this.core.sendCmd("v2ConversationSync",{tag:{cursor:this.nextCursor}})}catch(e){var t=e;if(t.code===Ct.V2NIM_ERROR_CODE_CANCELLED)return;return this.isSyncing=!1,this.service.emit("onSyncFailed",t),this.core.V2NIMLoginService.dataSync.switchDataSync({type:be.V2NIM_DATA_SYNC_TYPE_MAIN,state:Re.V2NIM_DATA_SYNC_STATE_COMPLETED,error:t,subType:"conversationSync"}),void this.processTempPacket()}var r=0===parseInt(Ne(e,"content.info.syncType")),i=Ne(e,"content.info.nextCursor");this.doSyncAndSuccess(r,i)}))}doSyncAndSuccess(e,t){e&&this.service.model.sort(),this.isSyncing=!1,this.nextCursor=parseInt(t)||0,this.service.unread.resetTotalAfterSyncDone(),this.service.unread.digestUnreadCountChange(),this.service.emit("onSyncFinished"),this.core.V2NIMLoginService.dataSync.switchDataSync({type:be.V2NIM_DATA_SYNC_TYPE_MAIN,state:Re.V2NIM_DATA_SYNC_STATE_COMPLETED,subType:"conversationSync"}),this.processTempPacket()}setBackFillIds(e){return e.forEach((e=>{var t;if(e.lastMessageState===Pe.V2NIM_MESSAGE_STATUS_BACKFILL&&(null===(t=this.core.V2NIMMessageService)||void 0===t?void 0:t.model)){this.conversationIdsForBackFill[e.conversationId]=!0;var r=this.core.V2NIMMessageService.model.getLastMessageOfConversation(e.conversationId);e.lastMessage=r?formatLastMessageFromMessage(this.core,r,e.lastMessageState,r.sendingState):""}else this.conversationIdsForBackFill[e.conversationId]=!1;delete e.lastMessageState})),e}recvConversationFromSyncAction(e){var{syncType:t}=Ne(e,"content.info"),r=formatConversationFields(this.core,Ne(e,"content.datas"));0===(t=parseInt(t))?(r.forEach((e=>{this.initFieldVersion(e.conversationId,e.version)})),r=this.setBackFillIds(r),this.setModel(r)):(r=this.setBackFillIds(r),this.recvConversationForCreated(r)<r.length&&this.recvConversationForChanged(r))}recvConversation(e){if(this.isSyncing)this.tempPacket.push(e);else{var t=formatConversationFields(this.core,Ne(e,"content.datas")).filter((e=>!!e.conversationId)),r=formatConversationNotify(Ne(e,"content.info"));if(this.core.logger.log(`V2NIMConversation::recvConversation:${r.type}`,r,t),2===r.type){var i=t.map((e=>(delete this.fieldVersion[e.conversationId],this.service.model.deleteById(e.conversationId),e.conversationId)));return this.service.emit("onConversationDeleted",i),void this.service.unread.digestUnreadCountChange()}if(12!==r.type)r.type,t=this.setBackFillIds(t),this.recvConversationForCreated(t)<t.length&&this.recvConversationForChanged(t);else this.compareAndClearUnreadInModel(r.oneClickClearUnreadVersion,r.oneClickClearUnreadType,{conversationGroupIds:r.oneClickClearUnreadGroupId?[r.oneClickClearUnreadGroupId]:void 0,conversationTypes:r.oneClickClearUnreadConversationType})}}recvConversationForCreated(e){var t=e.filter((e=>!this.fieldVersion[e.conversationId]));return t.reduce(((e,t)=>{if(!this.fieldVersion[t.conversationId]){this.initFieldVersion(t.conversationId,t.version),e=!!this.updateModel(t)||e;var r=this.service.model.getById(t.conversationId);return r&&this.service.triggerConversationCreated(r),e}return e}),!1)&&this.service.unread.digestUnreadCountChange(),t.length}recvConversationForChanged(e){var t=this.bulkCompare(e);if(0!==t.length){this.bulkUpdateModel(t);var r=t.map((e=>this.service.model.getById(e.conversationId))).filter((e=>!!e));this.service.triggerConversationChanged(r)}}processTempPacket(){this.tempPacket.forEach((e=>{this.recvConversation(e)})),this.tempPacket=[]}bulkCompare(e){return e.map((e=>this.compare(e))).filter((e=>!!e))}compare(e){var{version:t,conversationId:r,deleteFlag:i,type:n}=e,a={},s=0;return["stickTop","groupIds","serverExtension","localExtension","lastMessage","lastMessageState","unreadCount","sortOrder","createTime","updateTime"].forEach((i=>{var n=i;if(void 0!==e[n]){var o=this.fieldVersion[r];o&&"number"==typeof o[n]&&o[n]>=t||(this.fieldVersion[r]=this.fieldVersion[r]||{},this.fieldVersion[r][n]=t,a[n]=e[n],s+=1)}})),s?Object.assign(Object.assign({},a),{conversationId:r,deleteFlag:i,version:t,type:n}):void 0}bulkUpdateModel(e){var t=!1;e.forEach((e=>{this.updateModel(e)&&(t=!0)})),t&&this.service.unread.digestUnreadCountChange()}initFieldVersion(e,t){this.fieldVersion[e]={stickTop:t,groupIds:t,serverExtension:t,lastMessage:t,lastMessageState:t,unreadCount:t,sortOrder:t,createTime:t,updateTime:t}}initConversation(e,t){var r=Date.now();return Object.assign({conversationId:e,type:this.core.V2NIMConversationIdUtil.parseConversationType(e),stickTop:!1,localExtension:"",serverExtension:"",unreadCount:0,createTime:r,updateTime:r,sortOrder:r},t)}updateModel(e){var{deleteFlag:t,conversation:r}=formatConversationByField(e);if(t){var i=this.service.model.deleteById(r.conversationId);return!!(i&&i.unreadCount>0)}return this.service.model.upsert(r)}setModel(e){var t=e.filter((e=>!e.deleteFlag)).map((e=>formatConversationByField(e).conversation));this.service.model.set(t)}updateModelWithLastMessage(e,t,r,i){var n=this.service.model.getById(e),a=t?formatLastMessageFromMessage(this.core,t,r,i):void 0;if(!gl(null==n?void 0:n.lastMessage,a))if(n){var s=Object.assign(Object.assign({},n),{sortOrder:a?n.stickTop?a.messageRefer.createTime+1e15:a.messageRefer.createTime:n.sortOrder,lastMessage:a});this.service.model.upsert(s),this.service.triggerConversationChanged([s])}else{this.initFieldVersion(e,-1);var o=this.initConversation(e,{lastMessage:a});this.service.model.upsert(o),this.service.triggerConversationCreated(o)}}updateModelByRevoke(e){var t=[];e.forEach((e=>{var{postscript:r,messageRefer:i}=e,n=__rest(e,["postscript","messageRefer"]),a=i.conversationId,s=this.service.model.getById(a);s&&s.lastMessage&&s.lastMessage.messageRefer.messageClientId===i.messageClientId&&s.lastMessage.lastMessageState!==Pe.V2NIM_MESSAGE_STATUS_REVOKE&&(s.lastMessage.lastMessageState=Pe.V2NIM_MESSAGE_STATUS_REVOKE,r&&(s.lastMessage.text=r),Object.assign(s.lastMessage,n),this.service.model.upsert(s),t.push(s))})),t.length>0&&this.service.triggerConversationChanged(t)}compareAndUpdateModel(e){this.core.logger.log("V2NIMConversation::compareAndUpdateModel",e.map((e=>e.conversationId)));var t=!1,r=[];e.forEach((e=>{var i=this.compare(e);if(i){var n=this.service.model.getById(e.conversationId);this.updateModel(i)&&(t=!0);var a=this.service.model.getById(e.conversationId);a&&(n?r.push(a):this.service.triggerConversationCreated(a))}})),r.length>0&&this.service.triggerConversationChanged(r),t&&this.service.unread.digestUnreadCountChange()}compareAndDeleteModel(e){this.core.logger.log("V2NIMConversation::compareAndDeleteModel",e);var t=e.reduce(((e,t)=>{delete this.fieldVersion[t];var r=this.service.model.deleteById(t);return!!!!(r&&r.unreadCount>0)||e}),!1);this.service.emit("onConversationDeleted",e),t&&this.service.unread.digestUnreadCountChange()}compareAndDeleteGroupInModel(e,t){this.core.logger.log("V2NIMConversation::compareAndDeleteGroupInModel",e,t);var r=[];Object.keys(this.fieldVersion).forEach((i=>{var n=this.fieldVersion[i];if(void 0===n.groupIds||e>n.groupIds){n.groupIds=e;var a=this.service.model.getById(i);if(a&&a.groupIds&&a.groupIds.length>0){var s=a.groupIds.filter((e=>e!==t));if(s.length!==a.groupIds.length){var o=Object.assign(Object.assign({},a),{groupIds:s});this.service.model.upsert(o),o&&r.push(o)}}}})),r.length>0&&this.service.triggerConversationChanged(r)}compareAndClearUnreadInModel(e,t,r){this.core.logger.log("V2NIMConversation::compareAndClearUnreadInModel",e,t,r);var i=[],n=[];if(1===t)n=this.service.model.getAll();else if(r){var a=this.service.model.count();n=this.service.model.getByOption(0,a,r).conversationList}n.forEach((t=>{var r=t.conversationId,n=this.fieldVersion[r];if(void 0===n.unreadCount||e>n.unreadCount){n.unreadCount=e;var a=t.unreadCount,s=Object.assign(Object.assign({},t),{unreadCount:0});this.service.model.upsert(s),a>0&&i.push(s)}})),i.length>0&&this.service.triggerConversationChanged(i),this.service.unread.digestUnreadCountChange()}backfillLastMsg(e,t){var r=e=xi(e);(t||0!==(r=e.filter((e=>this.conversationIdsForBackFill[e]))).length)&&r.forEach((e=>{var t=this.service.model.getById(e),r=Ne(t,"lastMessage.messageRefer.messageClientId"),i=this.core.V2NIMMessageService.model.getLastMessageOfConversation(e);(i&&i.messageClientId)!==r&&(this.conversationIdsForBackFill[e]=!1,i?this.updateModelWithLastMessage(e,i,Pe.V2NIM_MESSAGE_STATUS_BACKFILL,i.sendingState):this.updateModelWithLastMessage(e,void 0,Pe.V2NIM_MESSAGE_STATUS_BACKFILL,We.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN))}))}}var Ll={"28_1":"v2ConversationCreate","28_2":"v2ConversationDelete","28_3":"v2ConversationUpdate","28_4":"v2ConversationSetTop","28_5":"v2ConversationUnreadClear","28_6":"v2ConversationGet","28_7":"v2ConversationGetByIds","28_8":"v2ConversationGetList","28_17":"v2ConversationsDelete","28_18":"v2ConversationsUnreadClear","28_19":"v2ConversationSync","28_20":"v2ConversationNotifySync","28_21":"v2ConversationNotifySyncOnline","28_23":"v2ConversationClearTotalUnread","28_24":"v2ConversationClearTypeUnread","28_25":"v2ConversationClearGroupUnread","4_14":"syncConversationReadTime","4_20":"syncSuperTeamReadTime","30_16":"v2MarkConversationReadTime","32_25":"v2MarkSuperTeamReadTime","7_116":"v2MultiDeviceConversationReadTime","21_125":"v2MultiDeviceSuperTeamReadTime"},Dl="V2NIMConversationService",Ul={conversationId:1,type:2,serverExtension:3,groupIds:4,lastMessage:5,lastMessageState:6,unreadCount:7,stickTop:8,sortOrder:9,version:10,deleteFlag:11,createTime:12,updateTime:13},ql={type:1,oneClickClearUnreadType:2,oneClickClearUnreadConversationType:3,oneClickClearUnreadGroupId:4,oneClickClearUnreadVersion:5,deleteConversationClearMessage:6},xl={v2ConversationCreate:{sid:28,cid:1,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:sn(Ul)}]},v2ConversationDelete:{sid:28,cid:2,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,clearMessage:2}}],response:[{type:"Property",name:"data",reflectMapper:sn(Ul)}]},v2ConversationUpdate:{sid:28,cid:3,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,serverExtension:2}}],response:[{type:"Property",name:"data",reflectMapper:sn(Ul)}]},v2ConversationSetTop:{sid:28,cid:4,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,stickTop:2}}],response:[{type:"Property",name:"data",reflectMapper:sn(Ul)}]},v2ConversationUnreadClear:{sid:28,cid:5,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:sn(Ul)}]},v2ConversationGet:{sid:28,cid:6,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:sn(Ul)}]},v2ConversationGetByIds:{sid:28,cid:7,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:sn(Ul)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGetList:{sid:28,cid:8,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{cursor:1,limit:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:sn(Ul)},{type:"Property",name:"info",reflectMapper:{1:"hasMore",2:"offset"}}]},v2ConversationsDelete:{sid:28,cid:17,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1,clearMessage:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:sn(Ul)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationsUnreadClear:{sid:28,cid:18,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:sn(Ul)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationSync:{sid:28,cid:19,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{cursor:1}}],response:[{type:"Property",name:"info",reflectMapper:{1:"nextCursor",2:"syncType"}}]},v2ConversationNotifySync:{sid:28,cid:20,service:Dl,response:[{type:"Property",name:"info",reflectMapper:{1:"nextCursor",2:"syncType"}},{type:"PropertyArray",name:"datas",reflectMapper:sn(Ul)}]},v2ConversationNotifySyncOnline:{sid:28,cid:21,service:Dl,response:[{type:"Property",name:"info",reflectMapper:sn(ql)},{type:"PropertyArray",name:"datas",reflectMapper:sn(Ul)}]},v2ConversationClearTotalUnread:{sid:28,cid:23,service:Dl,response:[{type:"Property",name:"info",reflectMapper:sn(ql)}]},v2ConversationClearTypeUnread:{sid:28,cid:24,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{conversationType:1}}],response:[{type:"Property",name:"info",reflectMapper:sn(ql)}]},v2ConversationClearGroupUnread:{sid:28,cid:25,service:Dl,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"info",reflectMapper:sn(ql)}]},syncConversationReadTime:{sid:4,cid:14,service:Dl,response:[{type:"StrLongMap",name:"p2p"},{type:"LongLongMap",name:"team"},{type:"Long",name:"timetag"}]},syncSuperTeamReadTime:{sid:4,cid:20,service:Dl,response:[{type:"LongLongMap",name:"superTeam"}]},v2MarkConversationReadTime:{sid:30,cid:16,service:Dl,params:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},v2MarkSuperTeamReadTime:{sid:32,cid:25,service:Dl,params:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]},v2MultiDeviceConversationReadTime:{sid:30,cid:116,service:Dl,response:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},v2MultiDeviceSuperTeamReadTime:{sid:21,cid:125,service:Dl,response:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]}};class V2NIMConversationUnreadImpl{constructor(e,t){this.totalUnreadCount=void 0,this.unreadCountByFilter={},this.core=e,this.service=t}reset(){this.totalUnreadCount=void 0,this.unreadCountByFilter={}}getTotalUnreadCount(){return this.totalUnreadCount}resetTotalAfterSyncDone(){var e=this.service.model.getAll().reduce(((e,t)=>e+(t.unreadCount||0)),0),t=this.totalUnreadCount;return void 0!==t&&t===e||(this.totalUnreadCount=e,this.service.emit("onTotalUnreadCountChanged",e)),e}digestUnreadCountChange(){this._digest()}_digest(){var e=this.totalUnreadCount,t=this.service.model.getAll().reduce(((e,t)=>e+(t.unreadCount||0)),0);this.core.logger.log(`V2NIMConversation::digestUnreadCountChange:oldUnreadCount ${e}, newUnreadCount ${t}`),e!==t&&(this.totalUnreadCount=t,this.service.emit("onTotalUnreadCountChanged",t)),Object.keys(this.unreadCountByFilter).forEach((e=>{var t=JSON.parse(e),r=this.getUnreadCountByFilter(t),i=this.unreadCountByFilter[e];this.unreadCountByFilter[e]=r,t.equals=equals.bind(t),i!==r&&this.service.emit("onUnreadCountChangedByFilter",t,r)}))}getUnreadCountByIds(e){return e.reduce(((e,t)=>{var r=this.service.model.getById(t);return e+(r&&r.unreadCount||0)}),0)}getUnreadCountByFilter(e){var t=this.service.model.count();return this.service.model.getByOption(0,t,{conversationTypes:e.conversationTypes,conversationGroupIds:e.conversationGroupId?[e.conversationGroupId]:void 0,ignoreMuted:e.ignoreMuted}).conversationList.reduce(((e,t)=>e+(t.unreadCount||0)),0)}addFilter(e){var t=generateFilterKey(e);if(void 0!==this.unreadCountByFilter[t])throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST});var r=JSON.parse(t),i=this.getUnreadCountByFilter(r);this.unreadCountByFilter[t]=i,this.service.emit("onUnreadCountChangedByFilter",r,i)}deleteFilter(e){var t=generateFilterKey(e);if(void 0===this.unreadCountByFilter[t])throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST});delete this.unreadCountByFilter[t]}}function generateFilterKey(e){var{conversationTypes:t}=e;return t&&(t=t.sort()),JSON.stringify({conversationGroupId:e.conversationGroupId,conversationTypes:t,ignoreMuted:e.ignoreMuted})}function equals(e){return JSON.stringify(this)===generateFilterKey(e)}var Bl={createTime:{type:"number"},updateTime:{type:"number"}};function formatConversationGroups(e){return e&&e.length>0?e.map((e=>formatConversationGroup(e))):[]}function formatConversationGroup(e){return format(Bl,e)}function formatFailedMap(e){var t=JSON.parse(e);return Object.keys(t).map((e=>({conversationId:e,error:new V2NIMErrorImpl({code:t[e]})})))}var Fl,Gl={type:{type:"number"},deleteVersion:{type:"number"},conversationIds:{type:"object"}};function formatConversationGroupNotify(e){return format(Gl,e)}!function(e){e[e.createConversationGroup=1]="createConversationGroup",e[e.deleteConversationGroup=2]="deleteConversationGroup",e[e.updateConversationGroup=3]="updateConversationGroup",e[e.addConversationToGroup=4]="addConversationToGroup",e[e.removeConversationFromGroup=5]="removeConversationFromGroup"}(Fl||(Fl={}));var jl={"28_9":"v2ConversationGroupCreate","28_10":"v2ConversationGroupDelete","28_11":"v2ConversationGroupUpdate","28_12":"v2ConversationGroupGet","28_13":"v2ConversationGroupsGet","28_14":"v2ConversationGroupListGet","28_15":"v2ConversationGroupAddTo","28_16":"v2ConversationGroupRemoveFrom","28_22":"v2ConversationGroupNotifySyncOnline"},Hl="V2NIMConversationGroupService",Yl={groupId:1,name:2,serverExtension:3,createTime:4,updateTime:5},$l={v2ConversationGroupCreate:{sid:28,cid:9,service:Hl,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1,name:2,serverExtension:3}}],response:[{type:"Property",name:"data",reflectMapper:sn(Yl)},{type:"PropertyArray",name:"conversations",reflectMapper:sn(Ul)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupDelete:{sid:28,cid:10,service:Hl,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"info",reflectMapper:{1:"type",2:"deleteVersion",3:"groupList"}}]},v2ConversationGroupUpdate:{sid:28,cid:11,service:Hl,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,name:2,serverExtension:3}}],response:[{type:"Property",name:"data",reflectMapper:sn(Yl)}]},v2ConversationGroupGet:{sid:28,cid:12,service:Hl,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"data",reflectMapper:sn(Yl)}]},v2ConversationGroupsGet:{sid:28,cid:13,service:Hl,params:[{type:"Property",name:"tag",reflectMapper:{groupIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:sn(Yl)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupListGet:{sid:28,cid:14,service:Hl,response:[{type:"PropertyArray",name:"datas",reflectMapper:sn(Yl)}]},v2ConversationGroupAddTo:{sid:28,cid:15,service:Hl,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,conversationIds:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:sn(Ul)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupRemoveFrom:{sid:28,cid:16,service:Hl,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,conversationIds:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:sn(Ul)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupNotifySyncOnline:{sid:28,cid:22,service:Hl,response:[{type:"Property",name:"info",reflectMapper:{1:"type",2:"deleteVersion",3:"conversationIds"}},{type:"Property",name:"data",reflectMapper:sn(Yl)}]}};class V2NIMMessageModel{constructor(){this.messages=new Map,this.maxSize=2e3}reset(){this.messages.clear()}getMessageById(e){if(e)return this.messages.get(e)}getMessagesByConversationId(e){var t=[];return this.messages.forEach((r=>{r.conversationId===e&&t.push(r)})),t}getLastMessageOfConversation(e){var t=this.getMessagesByConversationId(e);if(0!==t.length)return t.reduce(((e,t)=>t.createTime>e.createTime?t:e),t[0])}upsertMessages(e){e.forEach((e=>{this.messages.set(e.messageClientId,e)}));var t=this.messages.size;if(!(t<=this.maxSize))for(var r=Array.from(this.messages.values()).filter((e=>e.sendingState!==We.V2NIM_MESSAGE_SENDING_STATE_SENDING)).sort(((e,t)=>e.createTime-t.createTime)),i=t-this.maxSize>100?t-this.maxSize:100,n=0;n<i;n++){var a=r[n];a&&this.messages.delete(a.messageClientId)}}deleteMessage(e){this.messages.delete(e)}deleteMessages(e,t){this.messages.forEach((r=>{e===r.conversationId&&(!t||t&&r.createTime<t)&&this.messages.delete(r.messageClientId)}))}}var Wl={accountId:{type:"string",allowEmpty:!1},content:{type:"object",required:!1,rules:{msg:{type:"string",allowEmpty:!1},type:{type:"number",allowEmpty:!1}}},messages:{type:"array",required:!1,rules:{msg:{type:"string",allowEmpty:!1},type:{type:"number"},role:{type:"enum",values:[It.V2NIM_AI_MODEL_ROLE_TYPE_ASSISTANT,It.V2NIM_AI_MODEL_ROLE_TYPE_USER,It.V2NIM_AI_MODEL_ROLE_TYPE_SYSTEM]}}},promptVariables:{type:"jsonstr",required:!1},modelConfigParams:{type:"object",required:!1,rules:{prompt:{type:"string",required:!1},maxTokens:{type:"number",required:!1},topP:{type:"number",required:!1},temperature:{type:"number",required:!1}}}},zl=Object.assign({requestId:{type:"string",allowEmpty:!1}},Wl),Kl={messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:getEnumValues(Oe)},createTime:{type:"number"}},Jl={routeEnabled:{type:"boolean",required:!1},routeEnvironment:{type:"string",required:!1}},Ql={pushEnabled:{type:"boolean",required:!1},pushNickEnabled:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},forcePush:{type:"boolean",required:!1},forceContent:{type:"string",required:!1},forcePushAccountIds:{type:"array",required:!1,itemType:"string"}},Xl={antispamEnabled:{type:"boolean",required:!1},antispamBusinessId:{type:"string",required:!1},antispamCustomMessage:{type:"string",required:!1},antispamCheating:{type:"string",required:!1},antispamExtension:{type:"string",required:!1}},Zl={messageConfig:{type:"object",required:!1,rules:{readReceiptEnabled:{type:"boolean",required:!1},lastMessageUpdateEnabled:{type:"boolean",required:!1},historyEnabled:{type:"boolean",required:!1},roamingEnabled:{type:"boolean",required:!1},onlineSyncEnabled:{type:"boolean",required:!1},offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1}}},routeConfig:{type:"object",required:!1,rules:Jl},pushConfig:{type:"object",required:!1,rules:Ql},antiSpamConfig:{type:"object",required:!1,rules:Xl},robotConfig:{type:"object",required:!1,rules:{accountId:{type:"string",required:!1},topic:{type:"string",required:!1},function:{type:"string",required:!1},customContent:{type:"string",required:!1}}},aiConfig:{type:"object",required:!1,rules:Wl},targetConfig:{type:"object",required:!1,rules:{receiverIds:{type:"array",itemType:"string"},inclusive:{type:"boolean"},newMemberVisible:{type:"boolean",required:!1}}},clientAntispamEnabled:{type:"boolean",required:!1},clientAntispamReplace:{type:"string",required:!1}},em={message:{type:"object",rules:{text:{type:"string",required:!1},messageType:{type:"enum",values:getEnumValues(He)},messageClientId:{type:"string",allowEmpty:!1}}},params:{type:"object",rules:Zl,required:!1},replyMessage:{type:"object",rules:{conversationType:{type:"enum",values:getEnumValues(Oe)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},tm={conversationId:{type:"string",allowEmpty:!1},message:{type:"object",rules:{text:{type:"string",required:!1},messageType:{type:"enum",values:getEnumValues(He)},messageClientId:{type:"string",allowEmpty:!1},attachment:{type:"object",required:!1,rules:{file:{type:"file",required:!1}}}}},params:{type:"object",required:!1,rules:Zl}},rm={message:{type:"object",rules:Kl},params:{type:"object",rules:{postscript:{type:"string",required:!1},serverExtension:{type:"string",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},env:{type:"string",required:!1}},required:!1}},im={conversationId:{type:"string",allowEmpty:!1},messageTypes:{type:"array",required:!1,itemType:"enum",values:getEnumValues(He)},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",values:getEnumValues(ze),required:!1},anchorMessage:{type:"object",required:!1,rules:{messageServerId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},nm={conversationType:{type:"enum",values:getEnumValues(Oe)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1}},am={messageRefers:{type:"array",required:!0,rules:nm}},sm={conversationId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:getEnumValues(Oe)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},om={messages:{type:"array",rules:sm}},cm={conversationId:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1},onlineSync:{type:"boolean",required:!1},deleteRoam:{type:"boolean",required:!1}},dm={serverExtension:{type:"string",required:!1}},lm={messageClientId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[Oe.V2NIM_CONVERSATION_TYPE_P2P]},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},mm={messages:{type:"array",rules:{messageClientId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[Oe.V2NIM_CONVERSATION_TYPE_TEAM]},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},min:1}},pm={voiceUrl:{type:"string",required:!1,allowEmpty:!1},file:{type:"file",required:!1},voicePath:{type:"string",required:!1,allowEmpty:!1},mimeType:{type:"string",required:!1,allowEmpty:!1},sampleRate:{type:"string",required:!1,allowEmpty:!1},duration:{type:"number",required:!0,min:0},sceneName:{type:"string",required:!1}},um={message:{type:"object",rules:{conversationType:{type:"enum",values:getEnumValues(Oe)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}},index:{type:"number",min:1},serverExtension:{type:"string",required:!1},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},needBadge:{type:"boolean",required:!1},title:{type:"string",required:!1,allowEmpty:!1},content:{type:"string",required:!1,allowEmpty:!1},pushPayload:{type:"string",required:!1,allowEmpty:!1}}}},hm={messages:{type:"array",rules:{conversationType:{type:"enum",values:getEnumValues(Oe)},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},gm={params:{type:"object",rules:{collectionType:{type:"number",min:1},collectionData:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1},uniqueId:{type:"string",required:!1}}}},vm={collections:{type:"array",min:1,rules:{collectionId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},ym={serverExtension:{type:"string",required:!1},collection:{type:"object",rules:{collectionId:{type:"string",allowEmpty:!1},collectionType:{type:"number"},createTime:{type:"number"}}}},Im={beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",required:!1,values:getEnumValues(ze)},collectionType:{type:"number",required:!1},anchorCollection:{type:"object",required:!1,rules:{collectionId:{type:"string",allowEmpty:!1,required:!1},createTime:{type:"number",required:!1}}}},_m={keyword:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},sortOrder:{type:"enum",values:getEnumValues(Ze),required:!1},conversationLimit:{type:"number",min:0,required:!1},messageLimit:{type:"number",min:1,required:!1},p2pAccountIds:{type:"array",required:!1,itemType:"string"},teamIds:{type:"array",required:!1,itemType:"string"},senderAccountIds:{type:"array",required:!1,itemType:"string"},messageTypes:{type:"array",required:!1,itemType:"enum",values:getEnumValues(He)},messageSubtypes:{type:"array",required:!1,itemType:"number"}},Mm={message:{type:"object",rules:{receiverId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[Oe.V2NIM_CONVERSATION_TYPE_TEAM]}}}},fm={messages:{type:"array",rules:{receiverId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[Oe.V2NIM_CONVERSATION_TYPE_TEAM]}},min:1}},Tm={sceneName:{type:"string",required:!1},name:{type:"string",required:!1}},Em=Object.assign(Object.assign({},Tm),{duration:{type:"number",required:!1}}),Sm=Object.assign(Object.assign({},Em),{width:{type:"number",required:!1},height:{type:"number",required:!1}}),Cm=Object.assign(Object.assign({},Tm),{width:{type:"number",required:!1},height:{type:"number",required:!1}}),Nm={messageRefer:{type:"object",required:!0,rules:nm},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",values:getEnumValues(ze),required:!1},excludeMessageServerId:{type:"string",required:!1,allowEmpty:!1}},Am={senderId:{type:"string",allowEmpty:!1},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"},messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1}},bm={subType:{type:"number",min:0,required:!1},text:{type:"string",required:!1},attachment:{type:"object",required:!1},serverExtension:{type:"string",required:!1},routeConfig:{type:"object",required:!1,rules:Jl},pushConfig:{type:"object",required:!1,rules:Ql},antiSpamConfig:{type:"object",required:!1,rules:Xl},clientAntispamEnabled:{type:"boolean",required:!1},clientAntispamReplace:{type:"string",required:!1}};class ReceiptUtil{constructor(e,t){this.p2pMessageReceipts={},this.core=e,this.service=t}sendP2PMessageReceipt(e){return __awaiter(this,void 0,void 0,(function*(){if(validate(lm,e,"",!0),e.senderId===this.core.account)throw new ValidateErrorV2({detail:{reason:`sendP2PMessageReceipt. sender: ${e.senderId} is not allowed to send msg receipt`}});this.p2pMessageReceipts[e.conversationId]>e.createTime||(yield this.core.sendCmd("v2SendP2PMessageReceipt",{tag:{receiverId:e.senderId,messageClientId:e.messageClientId,createTime:e.createTime}}),this.p2pMessageReceipts[e.conversationId]=e.createTime)}))}isPeerRead(e){if(e.conversationType!==Oe.V2NIM_CONVERSATION_TYPE_P2P)return!1;if(e.senderId!==this.core.account)return!1;if(e.senderId===this.core.account&&e.receiverId===this.core.account)return!0;var t=this.core.V2NIMConversationIdUtil.messageConversationId(e),r=this.p2pMessageReceipts[t]||0;return e.createTime<=r}getP2PMessageReceipt(e){return __awaiter(this,void 0,void 0,(function*(){if(validateConversationId(this.core.account,e),this.core.V2NIMConversationIdUtil.parseConversationType(e)!==Oe.V2NIM_CONVERSATION_TYPE_P2P)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getP2PMessageReceipt: conversationId is not p2p conversationId"}});return{conversationId:e,timestamp:this.p2pMessageReceipts[e]||0}}))}getTeamMessageReceipts(e){return __awaiter(this,void 0,void 0,(function*(){if(validate(fm,{messages:e},"",!0),e.some((e=>e.senderId!==this.core.account)))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceipts: exist messages senderId is not current user"}});if(e.some((t=>t.receiverId!==e[0].receiverId)))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getTeamMessageReceipts: exist messages receiverId is not same"}});return(yield this.core.sendCmd("v2GetTeamMessageReceipts",{tag:e})).content.data.map((e=>Object.assign(Object.assign({},e),{conversationId:this.core.V2NIMConversationIdUtil.teamConversationId(e.receiverId)})))}))}getTeamMessageReceiptDetail(e){return __awaiter(this,void 0,void 0,(function*(){if(validate(Mm,{message:e},"",!0),e.senderId!==this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:`getTeamMessageReceiptDetail::senderId ${e.senderId} incorrect`}});var t=yield this.core.sendCmd("v2GetTeamMessageReceiptDetail",{tag:e});return{readReceipt:{conversationId:this.core.V2NIMConversationIdUtil.teamConversationId(e.receiverId),messageClientId:e.messageClientId,messageServerId:e.messageServerId,readCount:t.content.readAccountList.length,unreadCount:t.content.unreadAccountList.length},readAccountList:t.content.readAccountList,unreadAccountList:t.content.unreadAccountList}}))}sendTeamMessageReceipts(e){return __awaiter(this,void 0,void 0,(function*(){if(validate(mm,{messages:e},"",!0),e.some((e=>e.senderId===this.core.account)))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceipts: exist messages senderId is not current user"}});if(e.some((t=>t.receiverId!==e[0].receiverId)))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceipts: exist messages receiverId is not same"}});yield this.core.sendCmd("v2SendTeamMessageReceipts",{tag:e})}))}syncP2PMessagReceiptsHandler(e){var t=e.content.data.map((e=>{var t=this.core.V2NIMConversationIdUtil.p2pConversationId(e.senderId),r=e.createTime;return this.p2pMessageReceipts[t]=r,{conversationId:t,timestamp:r}}));this.service.emit("onReceiveP2PMessageReadReceipts",t)}onP2PMessageReceiptsHandler(e){var t=this.core.V2NIMConversationIdUtil.p2pConversationId(e.content.data.senderId),r=e.content.data.createTime;this.p2pMessageReceipts[t]=r,this.service.emit("onReceiveP2PMessageReadReceipts",[{conversationId:t,timestamp:r}])}onTeamMessageReceiptsHandler(e){var t=e.content.data.map((e=>({conversationId:this.core.V2NIMConversationIdUtil.teamConversationId(e.receiverId),messageServerId:e.messageServerId,messageClientId:e.messageClientId,readCount:e.readCount,unreadCount:e.unreadCount,latestReadAccount:e.latestReadAccount})));this.service.emit("onReceiveTeamMessageReadReceipts",t)}}class FileUtil{constructor(e,t){this.core=e,this.service=t}doSendFile(e,t){return __awaiter(this,void 0,void 0,(function*(){var r=e.attachment;try{var[i,n]=yield this.core.V2NIMStorageService._uploadFile({taskId:e.messageClientId,uploadParams:{fileObj:(null==r?void 0:r.file)||(null==r?void 0:r.path),sceneName:null==r?void 0:r.sceneName}},t,{fileType:e.messageType}),a=Object.assign(Object.assign({},r),{uploadState:$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS});void 0!==n.w&&(a.width=a.width||n.w),void 0!==n.h&&(a.height=a.height||n.h),void 0!==n.dur&&(a.duration=a.duration||n.dur),a.ext=a.ext&&-1===a.ext.indexOf(".")?`.${a.ext}`:a.ext;var s=["w","h","dur","ext","name"];for(var o in n)s.includes(o)||(a[o]=n[o]);var{raw:c,file:d,path:l}=a,m=__rest(a,["raw","file","path"]);e.attachment=JSON.parse(JSON.stringify(m)),e.attachment&&(e.attachment.raw=attachmentToRaw(e.messageType,e.attachment))}catch(t){throw e.attachment&&(e.attachment.uploadState=$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED),t}}))}cancelMessageAttachmentUpload(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({messageClientId:{type:"string",allowEmpty:!1}},e,"",!0),![He.V2NIM_MESSAGE_TYPE_AUDIO,He.V2NIM_MESSAGE_TYPE_FILE,He.V2NIM_MESSAGE_TYPE_IMAGE,He.V2NIM_MESSAGE_TYPE_VIDEO].includes(e.messageType))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:`cancelMessageAttachmentUpload: messageType ${e.messageType} incorrect`}});if(e.sendingState===We.V2NIM_MESSAGE_SENDING_STATE_FAILED||e.sendingState===We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST,detail:{reason:"cancelMessageAttachmentUpload: message is already failed or succeeded"}});yield this.core.V2NIMStorageService._cancelUploadFile(e.messageClientId)}))}}class SendUtil{constructor(e,t){this.uploadingMessageInfo={},this.core=e,this.service=t}prepareMessage(e,t,r,i){var n=this.checkIfResend(e),a=this.generateSendMessage({message:e,params:r,resend:n,conversationId:t,replyMessage:i}),s=Object.assign({},r.targetConfig?{targetConfig:r.targetConfig}:{}),{clientAntispamResult:o,text:c}=this.checkIfAntispam(r,a);return a.text=c,a.clientAntispamHit=!!o&&o.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD,{messageBeforeSend:a,clientAntispamResult:o,hiddenParams:s}}checkIfAntispam(e,t){var r,i=t.text;if(e.clientAntispamEnabled&&(t.messageType===He.V2NIM_MESSAGE_TYPE_TEXT||t.messageType===He.V2NIM_MESSAGE_TYPE_TIPS))if((r=this.core.V2NIMClientAntispamUtil.checkTextAntispam(t.text||"",e.clientAntispamReplace)).operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE)i=r.replacedText;else if(r.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD)throw this.service.emit("onSendMessage",Object.assign(Object.assign({},t),{sendingState:We.V2NIM_MESSAGE_SENDING_STATE_FAILED,messageStatus:{errorCode:Ct.V2NIM_ERROR_CODE_CLIENT_ANTISPAM}})),new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,detail:{reason:"sendMessage: text intercepted by client antispam"}});return{clientAntispamResult:r,text:i}}doMsgReceiveReport(e,t){if(e.senderId!==this.core.account){var r=Ne(e,"__clientExt.statistics.apiCallingTime")||0,i=Ne(e,"__clientExt.statistics.sendTime")||0,n=Ne(e,"__clientExt.statistics.attachUploadDuration")||0,a=this.core.timeOrigin.getNTPTime(),s=e.createTime,o=this.core.timeOrigin.checkNodeReliable(t.__receiveTimeNode)?this.core.timeOrigin.getNTPTime(t.__receiveTimeNode):a;this.core.reporter.report("msgReceive",{msgId:e.messageServerId,clientId:e.messageClientId,serverTime:e.createTime,receiveTime:o,fromAccid:e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P?e.senderId:"",toAccid:e.receiverId,type:conversationTypeV2ToV1(e.conversationType),tid:e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P?"":e.receiverId,apiCallingTime:r,sendTime:i,attachUploadDuration:n,callbackTime:a,preHandleTime:a,result:200,failReason:"",rt:a-s})}}checkIfResend(e){var t=this.service.model.getMessageById(e.messageClientId),r=!1;if(e.messageServerId||e.sendingState===We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message has already been sent"}});if((null==t?void 0:t.sendingState)===We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message has already been sent"}});return t&&(r=!0),r}doSendMessage(e){return __awaiter(this,void 0,void 0,(function*(){var t,r,{apiCallingTimeNode:i,messageBeforeSend:n,clientAntispamResult:a,hiddenParams:s,progress:o}=e,c={};if(n.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P)t="v2SendP2pMessage";else if(n.conversationType===Oe.V2NIM_CONVERSATION_TYPE_TEAM)t="v2SendTeamMessage";else{if(n.conversationType!==Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM)throw new ValidateErrorV2({detail:{reason:`conversationType: ${n.conversationType} is not supported`}});t="v2SendSuperTeamMessage"}if(this.service.sendMessageHandler(n),this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",n),!n.attachment||!("uploadState"in n.attachment)||n.attachment.url||n.attachment.uploadState!==$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN&&n.attachment.uploadState!==$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED)this.service.emit("onSendMessage",n);else{var d=Date.now();try{n.attachmentUploadState=$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING,n.attachment.uploadState=$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING,this.service.emit("onSendMessage",n),yield this.service.fileUtil.doSendFile(n,o),n.attachmentUploadState=$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS,n.attachment.uploadState=$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS,this.service.emit("onSendMessage",n)}catch(e){throw n.attachmentUploadState=$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED,n.attachment.uploadState=$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED,n.sendingState=We.V2NIM_MESSAGE_SENDING_STATE_FAILED,n.messageStatus={errorCode:e.code||Ct.V2NIM_ERROR_CODE_UNKNOWN},this.service.emit("onSendMessage",n),c.attachUploadDuration=Date.now()-d,this.doSendMessageFailed(i,c,n,e),e}c.attachUploadDuration=Date.now()-d}this.core.timeOrigin.checkNodeReliable(i)&&(c.apiCallingTime=this.core.timeOrigin.getNTPTime(i),c.sendTime=this.core.timeOrigin.getNTPTime(),n.__clientExt={statistics:c});try{r=yield this.core.sendCmd(t,{tag:Object.assign({},n,s)})}catch(e){throw this.doSendMessageFailed(i,c,n,e),n.sendingState=We.V2NIM_MESSAGE_SENDING_STATE_FAILED,n.messageStatus={errorCode:e.code||Ct.V2NIM_ERROR_CODE_UNKNOWN},this.service.emit("onSendMessage",n),e}var l=Ne(r,"content.data.errorCode"),m=Object.assign(Object.assign(Object.assign({},n),r.content.data),{sendingState:We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED,messageStatus:{errorCode:l&&200!==l?l:200}});this.service.sendMessageHandler(m),this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",m),this.doMsgSendReport(i,c,n);var p=m.antispamResult;return p&&(m.messageStatus.errorCode=Ct.V2NIM_ERROR_CODE_SERVER_ANTISPAM),delete m.antispamResult,this.service.emit("onSendMessage",m),Object.assign(Object.assign({message:m},p?{antispamResult:p}:{}),a?{clientAntispamResult:a}:{})}))}doSendMessageFailed(e,t,r,i){var n=Object.assign(Object.assign({},r),{sendingState:We.V2NIM_MESSAGE_SENDING_STATE_FAILED});this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",n),this.service.sendMessageHandler(n),this.doMsgSendReport(e,t,r,i)}doMsgSendReport(e,t,r,i){t.apiCallingTime=this.core.timeOrigin.getNTPTime(e),t.sendTime=this.core.timeOrigin.getNTPTime();var n=this.core.timeOrigin.getNTPTime(),a=Ne(i,"detail.reason");this.core.reporter.report("msgSend",{msgId:r.messageServerId,clientId:r.messageClientId,msgTime:r.createTime,fromAccid:r.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P?r.senderId:"",toAccid:r.receiverId,type:conversationTypeV2ToV1(r.conversationType),tid:r.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P?"":r.receiverId,result:i?i.code:200,failReason:a||(null==i?void 0:i.message)||"",rt:n-t.apiCallingTime,apiCallingTime:t.apiCallingTime,sendTime:t.sendTime,attachUploadDuration:t.attachUploadDuration,apiCallbackTime:n})}generateSendMessage(e){var{conversationId:t,replyMessage:r,resend:i,message:n,params:a}=e,s={};if(r){var o=r.threadRoot;s={threadReply:{senderId:r.senderId,receiverId:r.receiverId,messageServerId:r.messageServerId,createTime:r.createTime,messageClientId:r.messageClientId,conversationType:r.conversationType,conversationId:r.conversationId},threadRoot:{senderId:o?o.senderId:r.senderId,receiverId:o?o.receiverId:r.receiverId,messageServerId:o?o.messageServerId:r.messageServerId,createTime:o?o.createTime:r.createTime,messageClientId:o?o.messageClientId:r.messageClientId,conversationType:o?o.conversationType:r.conversationType,conversationId:o?o.conversationId:r.conversationId}}}var c=this.core.V2NIMConversationIdUtil.parseConversationType(t),d=this.core.V2NIMConversationIdUtil.parseConversationTargetId(t);a.pushConfig&&!0!==a.pushConfig.forcePush&&(delete a.pushConfig.forcePushContent,delete a.pushConfig.forcePushAccountIds);var l={},m={};if(a.aiConfig){var p=Ne(a,"aiConfig.content.msg"),u=Ne(a,"aiConfig.content.type")||0;p?m={msg:p,type:u}:void 0===p&&n.messageType===He.V2NIM_MESSAGE_TYPE_TEXT&&(m={msg:n.text||"",type:u}),(l=Object.assign({},a.aiConfig)).aiStatus=je.V2NIM_MESSAGE_AI_STATUS_AT,void 0!==m.msg&&(l.content=m)}var h=this.core.V2NIMUserService.model.getUser(this.core.account),g=(null==h?void 0:h.updateTime)||0;return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},n),s),{messageConfig:Object.assign(Object.assign({},n.messageConfig),a.messageConfig),routeConfig:Object.assign(Object.assign({},n.routeConfig),a.routeConfig),pushConfig:Object.assign(Object.assign({},n.pushConfig),a.pushConfig),antispamConfig:Object.assign(Object.assign({},n.antispamConfig),a.antispamConfig),robotConfig:Object.assign(Object.assign({},n.robotConfig),a.robotConfig)}),l&&l.accountId?{aiConfig:l}:{}),n.attachment?{attachment:Object.assign({},n.attachment)}:{}),{resend:i,senderId:this.core.account,conversationType:c,receiverId:d,conversationId:this.core.V2NIMConversationIdUtil.messageConversationId({conversationType:c,senderId:this.core.account,receiverId:d})}),g?{userUpdateTime:g}:{}),{sendingState:We.V2NIM_MESSAGE_SENDING_STATE_SENDING})}}class ModifyUtil{constructor(e,t){this.core=e,this.service=t}checkIfModify(e,t){if("0"===e.messageServerId)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: messageServerId cannot be empty"}});if(e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P&&e.senderId!==this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: senderId should be self"}});if(![He.V2NIM_MESSAGE_TYPE_TEXT,He.V2NIM_MESSAGE_TYPE_IMAGE,He.V2NIM_MESSAGE_TYPE_AUDIO,He.V2NIM_MESSAGE_TYPE_VIDEO,He.V2NIM_MESSAGE_TYPE_LOCATION,He.V2NIM_MESSAGE_TYPE_FILE,He.V2NIM_MESSAGE_TYPE_TIPS,He.V2NIM_MESSAGE_TYPE_CALL,He.V2NIM_MESSAGE_TYPE_CUSTOM].includes(e.messageType))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:`modifyMessage: messageType ${e.messageType} not correct`}});if([He.V2NIM_MESSAGE_TYPE_TEXT,He.V2NIM_MESSAGE_TYPE_IMAGE,He.V2NIM_MESSAGE_TYPE_AUDIO,He.V2NIM_MESSAGE_TYPE_VIDEO,He.V2NIM_MESSAGE_TYPE_FILE,He.V2NIM_MESSAGE_TYPE_TIPS,He.V2NIM_MESSAGE_TYPE_CALL].includes(e.messageType)&&t.attachment)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:`modifyMessage: messageType ${e.messageType} can not modify attachment`}});var r=["subType","text","serverExtension","attachment"];if(!r.some((e=>void 0!==Ne(t,e))))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: missing modified params"}});if(r.every((r=>"attachment"===r?e.attachment&&t.attachment?attachmentToRaw(e.messageType,e.attachment)===attachmentToRaw(e.messageType,t.attachment):!t.attachment:Ne(e,r)===Ne(t,r))))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: no change"}})}prepareMessage(e,t){var r=this.generateSendMessage(e,t),{clientAntispamResult:i,text:n}=this.checkIfAntispam(t,r);return r.text=n,r.clientAntispamHit=!!i&&i.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD,{messageBeforeSend:r,clientAntispamResult:i}}modifyMessage(e,t){return __awaiter(this,void 0,void 0,(function*(){var r;if(e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P)r="v2MessageP2pModify";else if(e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_TEAM)r="v2MessageTeamModify";else{if(e.conversationType!==Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM)throw new ValidateErrorV2({detail:{reason:`conversationType: ${e.conversationType} is not supported`}});r="v2MessageSuperTeamModify"}var i=yield this.core.sendCmd(r,{tag:e});if(t&&t.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD)return{errorCode:Ct.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,clientAntispamResult:t};var n=Object.assign(Object.assign({},e),i.content.data),a=n.antispamResult;if(a)return Object.assign({errorCode:Ct.V2NIM_ERROR_CODE_SERVER_ANTISPAM,antispamResult:a},t?{clientAntispamResult:t}:{});delete n.antispamResult;var s=completeMessage(this.core,n);return this.service.model.upsertMessages([s]),this.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",s),Object.assign(Object.assign({errorCode:200,message:s},a?{antispamResult:a}:{}),t?{clientAntispamResult:t}:{})}))}checkIfAntispam(e,t){var r,i=t.text;if(e.clientAntispamEnabled&&(t.messageType===He.V2NIM_MESSAGE_TYPE_TEXT||t.messageType===He.V2NIM_MESSAGE_TYPE_TIPS))if((r=this.core.V2NIMClientAntispamUtil.checkTextAntispam(t.text||"",e.clientAntispamReplace)).operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE)i=r.replacedText;else if(r.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,detail:{reason:"sendMessage: text intercepted by client antispam"}});return{clientAntispamResult:r,text:i}}generateSendMessage(e,t){var r;return Object.assign(Object.assign({messageConfig:{lastMessageUpdateEnabled:null===(r=e.messageConfig)||void 0===r?void 0:r.lastMessageUpdateEnabled},routeConfig:Object.assign({routeEnabled:!0},t.routeConfig),pushConfig:Object.assign({pushEnabled:!0,pushNickEnabled:!0,forcePush:!1},t.pushConfig),antispamConfig:Object.assign({antispamEnabled:!0},t.antispamConfig)},t.attachment?{attachment:t.attachment}:{}),{conversationType:e.conversationType,senderId:e.senderId,receiverId:e.receiverId,createTime:e.createTime,messageClientId:e.messageClientId,messageServerId:e.messageServerId,messageType:e.messageType,subType:t.subType,text:t.text,serverExtension:t.serverExtension})}}class V2NIMClientAntispamUtilImpl{constructor(e){this.core=e}reset(e){e===Aa.Destroy&&(this.vocabInfo=void 0)}downloadLocalAntiSpamVocabs(){return __awaiter(this,void 0,void 0,(function*(){if(!this.vocabInfo)try{var e=yield this.core.sendCmd("v2DownloadLocalAntiSpamVocabs",{tag:{version:0,md5:""}});this.vocabInfo=Object.assign(Object.assign({},e.content.data),{thesaurus:JSON.parse(e.content.data.thesaurus).thesaurus})}catch(e){this.core.logger.warn("V2NIMLocalAntispamUtil::downloadLocalAntiSpamVocabs error",e)}}))}checkTextAntispam(e,t="**"){if(validate({text:{type:"string",required:!0,allowEmpty:!1},replace:{type:"string"}},{text:e,replace:t},"",!0),!this.vocabInfo)return{operateType:Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE,replacedText:e};for(var r=e,i=0;i<this.vocabInfo.thesaurus.length;i++){var n=this.filterContent(r,this.vocabInfo.thesaurus[i],t);if(r=n.replacedText,n.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD||n.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD)return n}return{operateType:r===e?Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE:Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE,replacedText:r}}filterContent(e,t,r){for(var i=0;i<t.keys.length;i++){var n=t.keys[i],a=n.match||t.match,s=n.operate||t.operate,o=void 0;try{o=this.matchContent(e,n.key,a,s,r)}catch(e){}if(o&&(e=o.replacedText,o.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD||o.operateType===Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD))return o}return{operateType:Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE,replacedText:e}}matchContent(e,t,r,i,n){var a=!1,s="";if(1===r)e.indexOf(t)>=0&&(a=!0,s=t);else if(2===r){new RegExp(t,"g").test(e)&&(a=!0)}if(a&&""!==s)switch(i){case 1:return{operateType:Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE,replacedText:e.replace(s,n)};case 2:return{operateType:Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD,replacedText:e};case 3:return{operateType:Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD,replacedText:e}}return{operateType:Xe.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE,replacedText:e}}}function getFileOrPath(e){var t="object"==typeof e?e:void 0,r="string"==typeof e?e:void 0;if(!t&&!r)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getFileOrPath::incorrect file and path"}});if("string"==typeof r)if(0===r.indexOf("nim-external")){var i=document.getElementById(r);if(!(i&&i.files&&i.files[0]))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_FILE_NOT_FOUND,detail:{reason:`getFileOrPath::file not exist: ${r}`}});t=i.files[0]}else if("BROWSER"===Xr.platform)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:`getFileOrPath::incorrect path: ${r}`}});if("object"==typeof t&&void 0===t.size)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getFileOrPath::file no size"}});return{file:t,path:r}}class V2NIMMessageCreatorImpl extends V2Service{constructor(e){super("V2NIMMessageCreator",e),this.name="V2NIMMessageCreator",this.defaultNosSceneName="nim_default_im",this.core=e}createMessage(e,t){return Object.assign(Object.assign(Object.assign({messageClientId:Ii(),messageType:e,createTime:Date.now(),sendingState:We.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN,messageStatus:{errorCode:200},isSelf:!0},t),t.attachment?{attachment:Object.assign(Object.assign({},t.attachment),{raw:attachmentToRaw(e,t.attachment)})}:{}),{senderId:"",receiverId:"",conversationType:0,conversationId:"",messageServerId:"",messageConfig:Object.assign({unreadEnabled:!0,roamingEnabled:!0,readReceiptEnabled:!1,lastMessageUpdateEnabled:!0,historyEnabled:!0,onlineSyncEnabled:!0,offlineEnabled:!0},t.messageConfig),pushConfig:Object.assign({pushEnabled:!0,pushNickEnabled:!0,forcePush:!1},t.pushConfig),routeConfig:Object.assign({routeEnabled:!0},t.routeConfig),antispamConfig:Object.assign({antispamEnabled:!0},t.antispamConfig)})}createTextMessage(e){return this.checkV2(),validate({text:{type:"string",allowEmpty:!1}},{text:e},"",!0),this.createMessage(He.V2NIM_MESSAGE_TYPE_TEXT,{text:e})}createImageMessage(e,t,r,i,n){this.checkV2(),validate(Cm,{name:t,sceneName:r,width:i,height:n},"",!0);var a=this.createGenericFileMessageAttachment(e,t,r,void 0,i,n);return this.createMessage(He.V2NIM_MESSAGE_TYPE_IMAGE,{attachment:a,attachmentUploadState:$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN})}createAudioMessage(e,t,r,i){this.checkV2(),validate(Em,{name:t,sceneName:r,duration:i},"",!0);var n=this.createGenericFileMessageAttachment(e,t,r,i);return this.createMessage(He.V2NIM_MESSAGE_TYPE_AUDIO,{attachment:n,attachmentUploadState:$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN})}createVideoMessage(e,t,r,i,n,a){this.checkV2(),validate(Sm,{name:t,sceneName:r,duration:i,width:n,height:a},"",!0);var s=this.createGenericFileMessageAttachment(e,t,r,i,n,a);return this.createMessage(He.V2NIM_MESSAGE_TYPE_VIDEO,{attachment:s,attachmentUploadState:$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN})}createFileMessage(e,t,r){this.checkV2(),validate(Tm,{name:t,sceneName:r},"",!0);var i=this.createGenericFileMessageAttachment(e,t,r);return this.createMessage(He.V2NIM_MESSAGE_TYPE_FILE,{attachment:i,attachmentUploadState:$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN})}createGenericFileMessageAttachment(e,t,r,i,n,a){if(r=r||this.defaultNosSceneName,!this.core.V2NIMStorageService.hasStorageScene(r))throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sceneName: "+r+" has not been added"}});var{file:s,path:o}=getFileOrPath(e),c=Object.assign(Object.assign(Object.assign({name:t,uploadState:$e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN,sceneName:r||this.defaultNosSceneName},i?{duration:i}:{}),n?{width:n}:{}),a?{height:a}:{});if(s){var d=s.name.lastIndexOf("."),l=-1===d?s.name:s.name.substring(0,d);c.name=c.name||l,c.size=s.size,c.ext=getFileExtension(s.name)}else if(o){var m=o.lastIndexOf("/"),p=o.lastIndexOf("."),u=-1===p?o.substring(m+1):o.substring(m+1,p);c.name=c.name||u,c.ext=getFileExtension(o)}return c=JSON.parse(JSON.stringify(c)),o?c.path=o:s&&(c.file=s),c}createLocationMessage(e,t,r){return this.checkV2(),validate({latitude:{type:"number",allowEmpty:!1},longitude:{type:"number",allowEmpty:!1},address:{type:"string",allowEmpty:!1}},{latitude:e,longitude:t,address:r},"",!0),this.createMessage(He.V2NIM_MESSAGE_TYPE_LOCATION,{attachment:{latitude:e,longitude:t,address:r}})}createCustomMessage(e,t){return this.checkV2(),validate({text:{type:"string",allowEmpty:!1}},{text:e},"",!0),validate({rawAttachment:{type:"string"}},{rawAttachment:t},"",!0),this.createMessage(He.V2NIM_MESSAGE_TYPE_CUSTOM,{text:e,attachment:{raw:t}})}createCallMessage(e,t,r,i,n){return this.checkV2(),validate({type:{type:"number",allowEmpty:!1}},{type:e},"",!0),validate({channelId:{type:"string",allowEmpty:!1}},{channelId:t},"",!0),validate({status:{type:"number",allowEmpty:!1}},{status:r},"",!0),validate({durations:{type:"array",allowEmpty:!1}},{durations:i},"",!0),this.createMessage(He.V2NIM_MESSAGE_TYPE_CALL,{text:n||"",attachment:{type:e,channelId:t,durations:i,status:r}})}createForwardMessage(e){this.checkV2();var t=[He.V2NIM_MESSAGE_TYPE_ROBOT,He.V2NIM_MESSAGE_TYPE_NOTIFICATION,He.V2NIM_MESSAGE_TYPE_AVCHAT,He.V2NIM_MESSAGE_TYPE_TIPS];if(!e||t.includes(e.messageType))return null;var r={messageClientId:Ii(),messageType:e.messageType};return e.text&&(r.text=e.text),e.attachment&&(r.attachment=e.attachment),e.attachment&&"uploadState"in e.attachment&&(r.attachmentUploadState=e.attachment.uploadState),this.createMessage(e.messageType,r)}createTipsMessage(e){return this.checkV2(),validate({text:{type:"string",allowEmpty:!1}},{text:e},"",!0),this.createMessage(He.V2NIM_MESSAGE_TYPE_TIPS,{text:e})}}var Rm="V2NIMMessageLogUtil",Om={"30_6":"v2GetMessageList","33_2":"v2GetMessageListByRefers","30_18":"v2ClearHistoryMessage","7_118":"onClearHistoryMessage","4_24":"syncClearHistoryMessage","31_23":"v2GetTeamMessageList","32_14":"v2GetSuperTeamMessageList"},Pm={conversationType:{id:0,retType:"number"},receiverId:1,deleteRoam:{id:2,converter:boolToInt},teamId:3,onlineSync:{id:4,converter:boolToInt},deleteTime:{id:6,retType:"number"},serverExtension:7},Vm=[{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"direction"},{type:"LongArray",name:"msgTypes"}],km={v2GetMessageList:{sid:30,cid:6,service:Rm,params:[{type:"String",name:"to"},...Vm],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(Nl)}]},v2GetMessageListByRefers:{sid:33,cid:2,service:Rm,params:[{type:"PropertyArray",name:"tag",reflectMapper:Nl,select:["conversationType","senderId","receiverId","createTime","messageServerId"]}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(Nl)}]},v2ClearHistoryMessage:{sid:30,cid:18,service:Rm,params:[{type:"Property",name:"tag",reflectMapper:Pm}],response:[{type:"Long",name:"timetag"}]},v2GetTeamMessageList:{sid:31,cid:23,service:Rm,params:[{type:"Long",name:"to"},...Vm],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(Nl)}]},v2GetSuperTeamMessageList:{sid:32,cid:14,service:Rm,params:[{type:"Long",name:"to"},...Vm],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(Nl)}]},onClearHistoryMessage:{sid:7,cid:118,service:Rm,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Pm)}]},syncClearHistoryMessage:{sid:4,cid:24,service:Rm,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Pm)}]}};var wm="V2NIMMessageExtendUtil",Lm={"29_5":"v2VoiceToText","33_15":"v2PinMessage","33_16":"v2UpdatePinMessage","33_17":"v2UnpinMessage","23_18":"onPinMessage","23_19":"onUpdatePinMessage","23_20":"onUnpinMessage","23_115":"onPinMessage","23_116":"onUpdatePinMessage","23_117":"onUnpinMessage","33_21":"v2GetPinMessageList","33_3":"v2AddQuickComment","33_4":"v2RemoveQuickComment","33_7":"v2GetQuickComment","23_5":"onAddQuickComment","23_6":"onRemoveQuickComment","23_103":"onAddQuickComment","23_104":"onRemoveQuickComment","33_8":"v2AddCollection","33_9":"v2RemoveCollections","33_10":"v2UpdateCollectionExtension","33_11":"v2GetCollectionListByOption","30_26":"v2SearchCloudMessagesGroupByConversation","30_27":"v2SearchCloudMessages","33_1":"v2GetThreadMessageList"},Dm={conversationType:{id:1,converter:conversationTypeV2ToV1,retConverter:conversationTypeV1ToV2,access:"messageRefer.conversationType"},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},createTime:{id:4,retType:"number",access:"messageRefer.createTime"},messageServerId:{id:5,access:"messageRefer.messageServerId"},messageClientId:{id:6,access:"messageRefer.messageClientId"},detail:7,modify:{id:8,retType:"number"}},Um={conversationType:{id:1,access:"messageRefer.conversationType",retConverter:conversationTypeV1ToV2},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},time:{id:4,access:"messageRefer.createTime",converter:boolToInt,retType:"number"},messageServerId:{id:5,access:"messageRefer.messageServerId"},messageClientId:{id:6,access:"messageRefer.messageClientId"},operatorId:7,serverExtension:8,createTime:{id:9,converter:boolToInt,retType:"number"},updateTime:{id:10,converter:boolToInt,retType:"number"}},qm={operatorId:1,index:{id:2,retType:"number"},createTime:{id:3,retType:"number"},serverExtension:4,pushEnabled:{id:5,access:"pushConfig.pushEnabled",converter:boolToInt},needBadge:{id:6,access:"pushConfig.needBadge",converter:boolToInt},title:{id:7,access:"pushConfig.title"},pushContent:{id:8,access:"pushConfig.pushContent"},pushPayload:{id:9,access:"pushConfig.pushPayload"}},xm={accid:1,serverExtension:2,createTime:{id:3,retType:"number"},updateTime:{id:4,retType:"number"}},Bm={collectionId:1,collectionType:{id:2,retType:"number"},collectionData:3,serverExtension:4,uniqueId:5,createTime:{id:6,retType:"number"},updateTime:{id:7,retType:"number"}},Fm={keyword:1,beginTime:2,endTime:3,messageLimit:5,sortOrder:{id:6,converter:e=>0===e?2:1},p2pAccountIds:{id:7,converter:e=>e.join(",")},teamIds:{id:8,converter:e=>e.join(",")},senderAccountIds:{id:9,converter:e=>e.join(",")},messageTypes:{id:10,converter:e=>e.join(",")},messageSubtypes:{id:11,converter:e=>e.join(",")}},Gm=Object.assign(Object.assign({},Fm),{conversationLimit:4}),jm={v2PinMessage:{sid:33,cid:15,service:wm,params:[{type:"Property",name:"msg",reflectMapper:Nl,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:xm}],response:[{type:"Long",name:"timetag"}]},v2UnpinMessage:{sid:33,cid:17,service:wm,params:[{type:"Property",name:"msg",reflectMapper:Nl,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:xm}],response:[{type:"Long",name:"timetag"}]},v2UpdatePinMessage:{sid:33,cid:16,service:wm,params:[{type:"Property",name:"msg",reflectMapper:Nl,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:xm}],response:[{type:"Long",name:"timetag"}]},v2GetPinMessageList:{sid:33,cid:21,service:wm,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,timetag:2}}],response:[{type:"Long",name:"timetag"},{type:"Bool",name:"changed"},{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Um)}]},v2VoiceToText:{sid:29,cid:5,service:wm,params:[{type:"Property",name:"tag",reflectMapper:{mimeType:0,sampleRate:1,voiceUrl:2,duration:3}}],response:[{type:"String",name:"data"}]},v2AddQuickComment:{sid:33,cid:3,service:wm,params:[{type:"Property",name:"message",reflectMapper:Nl,select:["conversationType","senderId","receiverId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"quickComment",reflectMapper:qm}],response:[{type:"Long",name:"timetag"}]},v2RemoveQuickComment:{sid:33,cid:4,service:wm,params:[{type:"Property",name:"message",reflectMapper:Nl,select:["conversationType","senderId","receiverId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"quickComment",reflectMapper:qm}],response:[{type:"Long",name:"timetag"}]},onAddQuickComment:{sid:23,cid:5,service:wm,response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(Nl)},{type:"Property",name:"quickComment",reflectMapper:invertSerializeItem(qm)}]},onRemoveQuickComment:{sid:23,cid:6,service:wm,response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(Nl)},{type:"Property",name:"quickComment",reflectMapper:invertSerializeItem(qm)}]},v2GetQuickComment:{sid:33,cid:7,service:wm,params:[{type:"PropertyArray",name:"tag",reflectMapper:Dm}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Dm)}]},onPinMessage:{sid:23,cid:18,service:wm,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(Nl)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(xm)}]},onUpdatePinMessage:{sid:23,cid:19,service:wm,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(Nl)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(xm)}]},onUnpinMessage:{sid:23,cid:20,service:wm,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(Nl)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(xm)}]},v2AddCollection:{sid:33,cid:8,service:wm,params:[{type:"Property",name:"tag",reflectMapper:Bm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Bm)}]},v2RemoveCollections:{sid:33,cid:9,service:wm,params:[{type:"PropertyArray",name:"tag",reflectMapper:Bm,select:["collectionId","createTime"]}],response:[{type:"Int",name:"data"}]},v2UpdateCollectionExtension:{sid:33,cid:10,service:wm,params:[{type:"Property",name:"tag",reflectMapper:Bm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Bm)}]},v2GetCollectionListByOption:{sid:33,cid:11,service:wm,params:[{type:"Property",name:"tag",reflectMapper:{beginTime:1,endTime:2,excludeId:3,limit:4,direction:5,collectionType:6}}],response:[{type:"Long",name:"total"},{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Bm)}]},v2SearchCloudMessagesGroupByConversation:{sid:30,cid:26,service:wm,params:[{type:"Property",name:"tag",reflectMapper:Gm}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2SearchCloudMessages:{sid:30,cid:27,service:wm,params:[{type:"Property",name:"tag",reflectMapper:Fm}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Nl)}]},v2GetThreadMessageList:{sid:33,cid:1,service:wm,params:[{type:"Property",name:"messageRefer",reflectMapper:Nl},{type:"Property",name:"tag",reflectMapper:{beginTime:1,endTime:2,excludeMessageServerId:3,limit:4,reverse:5}}],response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(Nl)},{type:"Property",name:"replyResult",reflectMapper:invertSerializeItem({total:{id:1,retType:"number"},timestamp:{id:2,retType:"number"}})},{type:"PropertyArray",name:"replyList",reflectMapper:invertSerializeItem(Nl)}]}};var Hm="V2NIMNotificationService",Ym={"30_7":"v2SendCustomNotification","32_16":"v2SendCustomNotificationWithSuperTeam","7_3":"onSysNotification","21_19":"onSysNotification","101_3":"onSysNotification","4_6":"v2SyncOfflineSysNotifications","4_18":"v2SyncOfflineSysNotifications","4_101":"v2SyncOfflineSysNotifications","7_14":"v2NotificationRevoke","21_18":"v2NotificationRevoke","21_117":"v2NotificationRevoke","4_19":"v2NotificationSyncRevoke","7_15":"v2NotificationSyncRevoke","4_16":"syncBroadcastMsg","7_17":"onBroadcastMsg"},$m={timestamp:{id:0,retType:"number"},type:{id:1,retType:"number"},receiverId:2,senderId:3,postscript:4,content:5,idServer:6,offlineEnabled:{id:7,converter:boolToInt,retConverter:function(e,t){return"0"!==t[6]&&!!parseInt(e)},access:"notificationConfig.offlineEnabled"},pushContent:{id:8,access:"pushConfig.pushContent"},pushPayload:{id:9,access:"pushConfig.pushPayload"},deletedIdClient:10,deletedIdServer:11,antispamEnabled:{id:12,converter:boolToInt,retType:"boolean",access:"antispamConfig.antispamEnabled"},antispamCustomNotification:{id:13,access:"antispamConfig.antispamCustomNotification"},deletedMsgCreateTime:14,deletedMsgFromNick:15,opeAccount:16,forcePushAccountIds:{id:18,access:"pushConfig.forcePushAccountIds",def:e=>{if(101===e.type&&e["pushConfig.forcePush"])return"#%@all@%#"},converter:(e,t)=>{if(t["pushConfig.forcePush"])return e?JSON.stringify(e):"#%@all@%#"}},forcePushContent:{id:19,access:"pushConfig.forcePushContent"},forcePush:{id:20,converter:boolToInt,retType:"boolean",access:"pushConfig.forcePush"},routeEnvironment:{id:21,access:"routeConfig.routeEnvironment"},callbackExt:22,conversationOnlineSyncNotify:24,conversationOnlineSyncData:25,routeEnabled:{id:105,converter:boolToInt,retType:"boolean",access:"routeConfig.routeEnabled"},pushEnabled:{id:107,converter:boolToInt,retType:"boolean",access:"pushConfig.pushEnabled"},unreadEnabled:{id:109,converter:boolToInt,retType:"boolean",access:"notificationConfig.unreadEnabled"},pushNickEnabled:{id:110,converter:boolToInt,retType:"boolean",access:"pushConfig.pushNickEnabled"}},Wm={id:1,senderId:2,timestamp:{id:4,retType:"number"},content:5},zm={v2SendCustomNotification:{sid:30,cid:7,service:Hm,params:[{type:"Property",name:"tag",reflectMapper:$m}]},v2SendCustomNotificationWithSuperTeam:{sid:32,cid:16,service:Hm,params:[{type:"Property",name:"tag",reflectMapper:$m}]},onSysNotification:{sid:7,cid:3,service:Hm,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem($m)}]},syncBroadcastMsg:{sid:4,cid:16,service:Hm,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Wm)}]},onBroadcastMsg:{sid:7,cid:17,service:Hm,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Wm)}]},v2SyncOfflineSysNotifications:{sid:4,cid:9,service:Hm,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem($m)}]},v2NotificationRevoke:{sid:7,cid:14,service:Hm,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem($m)}]},v2NotificationSyncRevoke:{sid:7,cid:15,service:Hm,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem($m)},{type:"Long",name:"timetag"},{type:"Byte",name:"type"}]}},Km={content:{type:"string",allowEmpty:!1},params:{type:"object",required:!1,rules:{notificationConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushNickEnabled:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},forcePush:{type:"boolean",required:!1},forcePushContent:{type:"string",required:!1},forcePushAccounts:{type:"array",required:!1,itemType:"string"}}},antispamConfig:{type:"object",required:!1,rules:{antispamEnabled:{type:"boolean",required:!1},antispamCustomNotification:{type:"string",required:!1}}},routeConfig:{type:"object",required:!1,rules:{routeEnabled:{type:"boolean",required:!1},routeEnvironment:{type:"string",required:!1}}}}}};var Jm={joinMode:{type:"enum",values:getEnumValues(st),required:!1},agreeMode:{type:"enum",values:getEnumValues(ot),required:!1},inviteMode:{type:"enum",values:getEnumValues(ct),required:!1},updateInfoMode:{type:"enum",values:getEnumValues(dt),required:!1},updateExtensionMode:{type:"enum",values:getEnumValues(mt),required:!1},chatBannedMode:{type:"enum",values:[lt.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN,lt.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL],required:!1}},Qm={type:"object",required:!0,rules:Object.assign({name:{type:"string",allowEmpty:!1},teamType:{type:"enum",values:[at.V2NIM_TEAM_TYPE_ADVANCED,at.V2NIM_TEAM_TYPE_SUPER]},memberLimit:{type:"number",min:1,required:!1}},Jm)},Xm={type:"array",min:1,itemType:"string"},Zm={type:"boolean"},ep={type:"string"},tp={type:"string",allowEmpty:!1},rp={type:"object",rules:{antispamBusinessId:{type:"string",required:!1}},required:!1},ip={teamId:{type:"string",regExp:/^[1-9]\d*$/,allowEmpty:!1}},np={teamIds:{type:"array",itemType:"string",regExp:/^[1-9]\d*$/,min:1,allowEmpty:!1}},ap={teamType:{type:"enum",values:[at.V2NIM_TEAM_TYPE_ADVANCED,at.V2NIM_TEAM_TYPE_SUPER]}},sp={teamTypes:{type:"array",itemType:"enum",values:[at.V2NIM_TEAM_TYPE_ADVANCED,at.V2NIM_TEAM_TYPE_SUPER],required:!1}},op={updateTeamInfoParams:{type:"object",required:!0,rules:Object.assign({name:{type:"string",allowEmpty:!1,required:!1},memberLimit:{type:"number",min:1,required:!1}},Jm)}},cp={type:"enum",values:[ut.V2NIM_TEAM_MEMBER_ROLE_NORMAL,ut.V2NIM_TEAM_MEMBER_ROLE_MANAGER]},dp={memberInfoParams:{type:"object",rules:{teamNick:{type:"string",required:!1},serverExtension:{type:"string",required:!1}}}};getEnumValues(pt);var lp,mp={chatBannedMode:{type:"enum",values:[lt.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN,lt.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL]}},pp={queryOption:{type:"object",rules:{roleQueryType:{type:"enum",values:getEnumValues(nt)},onlyChatBanned:{type:"boolean",required:!1},direction:{type:"enum",values:getEnumValues(ze),required:!1},limit:{type:"number",min:1,required:!1},nextToken:{type:"string",required:!1}}}},up={teamId:ip.teamId,teamType:{type:"enum",values:[at.V2NIM_TEAM_TYPE_ADVANCED,at.V2NIM_TEAM_TYPE_SUPER]},operatorAccountId:{type:"string",allowEmpty:!1}},hp={actionType:{type:"enum",values:[ht.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION]}},gp={actionType:{type:"enum",values:[ht.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION]}},vp={types:{type:"array",itemType:"enum",values:getEnumValues(ht),required:!1},status:{type:"array",itemType:"enum",values:getEnumValues(gt),required:!1},offset:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}};class V2NIMTeamModelImpl{constructor(){this.teamMap=new Map,this.superTeamMap=new Map}set(e){e.forEach((e=>{this.chooseMap(e.teamType).set(e.teamId,e)}))}reset(){this.teamMap.clear(),this.superTeamMap.clear()}count(e,t=!0){var r=this.chooseMap(e),i=0;return r.forEach((e=>{t&&e.isValidTeam&&i++,t||i++})),i}chooseMap(e){return e===at.V2NIM_TEAM_TYPE_SUPER?this.superTeamMap:e===at.V2NIM_TEAM_TYPE_ADVANCED?this.teamMap:new Map}getById(e,t,r=!0){var i=this.chooseMap(t).get(e);if(i){if(r&&i.isValidTeam)return i;if(!r)return i}}getAll(e,t=!0){var r=this.chooseMap(e);return Array.from(r.values()).filter((e=>!(!t||!e.isValidTeam)||(!t||void 0))).sort(((e,t)=>t.updateTime-e.updateTime))}upsert(e){var t=e.teamId,r=e.teamType,i=this.chooseMap(r),n=i.get(t)||{},a=Object.assign({},n,e);return i.set(t,a),a}deleteById(e,t){var r=this.getById(e,t);if(r)return r.isValidTeam=!1,r}searchTeamByKeyword(e){var t=[];return this.teamMap.forEach((r=>{r.name.includes(e)&&t.push(r)})),this.superTeamMap.forEach((r=>{r.name.includes(e)&&t.push(r)})),t}}class V2NIMTeamMemberModelImpl{constructor(){this.teamMembers=[],this.superTeamMembers=[],this.maxSize=2e3}reset(){this.teamMembers=[],this.superTeamMembers=[]}setData(e){e.forEach((e=>{this.chooseList(e.teamType).push(e)}))}chooseList(e){return e===at.V2NIM_TEAM_TYPE_SUPER?this.superTeamMembers:e===at.V2NIM_TEAM_TYPE_ADVANCED?this.teamMembers:[]}getById(e,t,r){return this.chooseList(t).find((t=>t.teamId===e&&t.accountId===r))}upsert(e){var t=e.teamType,r=e.teamId,i=this.chooseList(t),n=i.findIndex((t=>t.teamId===r&&t.accountId===e.accountId));-1===n?i.push(e):i[n]=Object.assign(Object.assign({},i[n]),e),i.length>this.maxSize&&i.shift()}deleteByAccount(e,t,r){var i=this.chooseList(t),n=i.findIndex((t=>t.teamId===e&&t.accountId===r));if(-1!==n){var a=i[n];return a.inTeam=!1,i.splice(n,1),a}}deleteByTeamId(e,t){var r=this.chooseList(t).filter((t=>t.teamId!==e));t===at.V2NIM_TEAM_TYPE_SUPER?this.superTeamMembers=r:this.teamMembers=r}}class V2NIMTeamNotificationImpl{constructor(e,t){this.core=e,this.service=t}processNotification(e){var{attachment:t,senderId:r,receiverId:i}=e,{id:n,data:a}=t,s=n>400?at.V2NIM_TEAM_TYPE_SUPER:at.V2NIM_TEAM_TYPE_ADVANCED,{id:o,ids:c,tinfo:d,mute:l}=formatTeamNotificationAttachData(a,s),m=this.service.model.getById(i,s);switch(this.core.logger.log("v2Team::processNotification, notificationType:",n,a),n){case lp.SUPER_TEAM_INVITATION:case lp.TEAM_INVITATION:c.includes(this.core.account)&&this.onTeamJoined(d),this.onTeamMembersJoined(d,c.filter((e=>e!==this.core.account)));break;case lp.SUPER_TEAM_INVITE_ACCEPT:case lp.TEAM_INVITE_ACCEPT:r===this.core.account?this.onTeamJoined(d):this.onTeamMemberJoined(d,r);break;case lp.SUPER_TEAM_APPLY_ACCEPT:case lp.TEAM_APPLY_ACCEPT:o===this.core.account?this.onTeamJoined(d):this.onTeamMemberJoined(d,o);break;case lp.SUPER_TEAM_ADD_MANAGER:case lp.TEAM_ADD_MANAGER:this.updateTeamMemberRole(i,s,c,{memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_MANAGER});break;case lp.SUPER_TEAM_REMOVE_MANAGER:case lp.TEAM_REMOVE_MANAGER:this.updateTeamMemberRole(i,s,c,{memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_NORMAL});break;case lp.SUPER_TEAM_KICK:case lp.TEAM_KICK:this.onTeamInfoUpdated(d),c.forEach((e=>{e===this.core.account?this.onTeamLeft(i,s,!0):this.onTeamMemberKicked(r,d.teamId,d.teamType,e)}));break;case lp.SUPER_TEAM_LEAVE:case lp.TEAM_LEAVE:d?this.onTeamInfoUpdated(d):m&&r===this.core.account&&(m.isValidTeam=!1,this.onTeamInfoUpdated(m)),r===this.core.account?this.onTeamLeft(i,s,!1):this.onTeamMemberLeft(i,s,r);break;case lp.SUPER_TEAM_DISMISS:case lp.TEAM_DISMISS:this.onTeamDismissed(i,s);break;case lp.SUPER_TEAM_UPDATE:case lp.TEAM_UPDATED:this.onTeamInfoUpdated(d);break;case lp.SUPER_TEAM_TRANSFER_OWNER:case lp.TEAM_TRANSFER_OWNER:this.onTeamInfoUpdated(d),this.updateTeamMemberRole(i,s,[r,d.ownerAccountId],[{memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_NORMAL},{memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_OWNER}]);break;case lp.SUPER_TEAM_MEMBER_MUTE:case lp.TEAM_MEMBER_MUTE:this.service.model.upsert(d),this.updateTeamMemberRole(i,s,o?[o]:c,{chatBanned:l!==rt.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF})}}onTeamJoined(e){if(this.service.model.upsert(e),this.service.emit("onTeamJoined",e),!this.service.memberModel.getById(e.teamId,e.teamType,this.core.account)){var t=e.updateTime||e.createTime,r=generateMemberByTeamId(e.teamId,e.teamType,this.core.account,{joinTime:t,updateTime:t});this.service.memberModel.upsert(r)}}onTeamLeft(e,t,r){var i=this.service.model.deleteById(e,t)||generateTeamByTeamId(e,t,{isValidTeam:!1});this.service.memberModel.deleteByAccount(e,t,this.core.account),this.service.emit("onTeamLeft",i,r)}onTeamDismissed(e,t){var r=this.service.model.deleteById(e,t);r||(r=generateTeamByTeamId(e,t,{isValidTeam:!1})),this.service.memberModel.deleteByTeamId(e,t),this.service.emit("onTeamDismissed",r)}onTeamInfoUpdated(e){var t=this.service.model.upsert(e);this.service.emit("onTeamInfoUpdated",t)}onTeamMemberJoined(e,t){this.service.model.upsert(e),this.service.emit("onTeamInfoUpdated",e);var r=e.updateTime||e.createTime,i=generateMemberByTeamId(e.teamId,e.teamType,t,{joinTime:r,updateTime:r});this.service.memberModel.upsert(i),this.service.emit("onTeamMemberJoined",[i])}onTeamMembersJoined(e,t){var r=e.updateTime||e.createTime,i=t.map((t=>generateMemberByTeamId(e.teamId,e.teamType,t,{joinTime:r,updateTime:r})));0!==i.length&&(this.service.model.upsert(e),this.service.emit("onTeamInfoUpdated",e),i.forEach((e=>this.service.memberModel.upsert(e))),this.service.emit("onTeamMemberJoined",i))}onTeamMemberLeft(e,t,r){var i=this.service.memberModel.deleteByAccount(e,t,r);i||(i=generateMemberByTeamId(e,t,r,{inTeam:!1})),this.service.emit("onTeamMemberLeft",[i])}onTeamMemberKicked(e,t,r,i){var n=this.service.memberModel.deleteByAccount(t,r,i);n||(n=generateMemberByTeamId(t,r,i,{inTeam:!1})),this.service.emit("onTeamMemberKicked",e,[n])}onTeamMemberInfoUpdated(e){e.forEach((e=>{var t;if(e.accountId===this.core.account&&(null===(t=this.core.V2NIMSettingService)||void 0===t?void 0:t.name)){var r=e.teamType===at.V2NIM_TEAM_TYPE_ADVANCED?this.core.V2NIMConversationIdUtil.teamConversationId(e.teamId):this.core.V2NIMConversationIdUtil.superTeamConversationId(e.teamId),i=this.core.V2NIMSettingService.getConversationMuteStatus(r);this.core.eventBus.emit("V2NIMConversationService/setMute",r,i)}})),this.service.emit("onTeamMemberInfoUpdated",e)}updateTeamMemberRole(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){var n=r.filter(((r,n)=>{var a=this.service.memberModel.getById(e,t,r);return a&&this.service.memberModel.upsert(Object.assign(Object.assign({},a),Array.isArray(i)?i[n]:i)),!a}));if(n.length>0)try{(yield this.service.getTeamMemberListByIds(e,t,n)).forEach((e=>this.service.memberModel.upsert(e)))}catch(e){this.core.logger.warn("v2Team::processNotification, getTeamMemberListByIds failed",e)}var a=r.map((r=>this.service.memberModel.getById(e,t,r))).filter((e=>!!e));a.length>0&&this.onTeamMemberInfoUpdated(a)}))}processSysNotification(e){var{receiverId:t,postscript:r,senderId:i,timestamp:n,idServer:a}=e,s={actionType:{0:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION,1:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION,2:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION,3:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION,15:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION,16:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION,17:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION,18:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION}[e.type],teamId:t,teamType:e.type>=15?at.V2NIM_TEAM_TYPE_SUPER:at.V2NIM_TEAM_TYPE_ADVANCED,operatorAccountId:i,postscript:r,timestamp:n,actionStatus:gt.V2NIM_TEAM_JOIN_ACTION_STATUS_INIT};this.core.logger.log("v2Team::processSysNotification, type:",e.type,s),this.service.notificationModel.create(s),this.service.emit("onReceiveTeamJoinActionInfo",s)}updateTeamActionStatus(e,t){this.service.notificationModel.update({teamId:e.teamId,teamType:e.teamType,operatorAccountId:e.operatorAccountId,actionType:e.actionType,actionStatus:t})}checkIfExpired(e){return!!e&&(509===e||!(e>=500&&e<=599)&&!(e>=19e4))}}!function(e){e[e.TEAM_INVITATION=0]="TEAM_INVITATION",e[e.TEAM_KICK=1]="TEAM_KICK",e[e.TEAM_LEAVE=2]="TEAM_LEAVE",e[e.TEAM_UPDATED=3]="TEAM_UPDATED",e[e.TEAM_DISMISS=4]="TEAM_DISMISS",e[e.TEAM_APPLY_ACCEPT=5]="TEAM_APPLY_ACCEPT",e[e.TEAM_TRANSFER_OWNER=6]="TEAM_TRANSFER_OWNER",e[e.TEAM_ADD_MANAGER=7]="TEAM_ADD_MANAGER",e[e.TEAM_REMOVE_MANAGER=8]="TEAM_REMOVE_MANAGER",e[e.TEAM_INVITE_ACCEPT=9]="TEAM_INVITE_ACCEPT",e[e.TEAM_MEMBER_MUTE=10]="TEAM_MEMBER_MUTE",e[e.SUPER_TEAM_INVITATION=401]="SUPER_TEAM_INVITATION",e[e.SUPER_TEAM_KICK=402]="SUPER_TEAM_KICK",e[e.SUPER_TEAM_LEAVE=403]="SUPER_TEAM_LEAVE",e[e.SUPER_TEAM_UPDATE=404]="SUPER_TEAM_UPDATE",e[e.SUPER_TEAM_DISMISS=405]="SUPER_TEAM_DISMISS",e[e.SUPER_TEAM_TRANSFER_OWNER=406]="SUPER_TEAM_TRANSFER_OWNER",e[e.SUPER_TEAM_ADD_MANAGER=407]="SUPER_TEAM_ADD_MANAGER",e[e.SUPER_TEAM_REMOVE_MANAGER=408]="SUPER_TEAM_REMOVE_MANAGER",e[e.SUPER_TEAM_MEMBER_MUTE=409]="SUPER_TEAM_MEMBER_MUTE",e[e.SUPER_TEAM_APPLY_ACCEPT=410]="SUPER_TEAM_APPLY_ACCEPT",e[e.SUPER_TEAM_INVITE_ACCEPT=411]="SUPER_TEAM_INVITE_ACCEPT"}(lp||(lp={}));class V2NIMTeamNotificationModelImpl{constructor(){this.list=[],this.maxCount=1e3}reset(){this.list=[]}create(e){this.list.push(e),this.list.length>this.maxCount&&this.list.shift()}update(e){this.list.forEach((t=>{t.teamId===e.teamId&&t.teamType===e.teamType&&t.actionType===e.actionType&&t.operatorAccountId===e.operatorAccountId&&t.actionStatus===gt.V2NIM_TEAM_JOIN_ACTION_STATUS_INIT&&Object.assign(t,e)}))}getByOption(e){var{types:t,status:r,offset:i=0,limit:n=50}=e,a=[];this.list.forEach((e=>{t&&t.length>0&&!t.includes(e.actionType)||r&&r.length>0&&!r.includes(e.actionStatus)||a.push(e)})),a=a.sort(((e,t)=>t.timestamp-e.timestamp));var s=0;i>0&&(s=findIndexWithinTargetValue(a,"timestamp",i),a[s]&&a[s].timestamp===i&&(s+=1));var o=a.slice(s).length;return(a=a.slice(s,s+n)).length>0?{offset:o>n?a[a.length-1].timestamp:0,finished:!(o>n),infos:a}:{offset:0,finished:!0,infos:a}}}var yp="V2NIMUserService",Ip={"34_3":"v2UpdateBlockList","34_7":"v2GetUserList","34_10":"v2UpdateSelfUserProfile","3_109":"v2SyncSelfUserInfo","3_110":"onUpdateUserProfile","3_103":"onUpdateBlockList","3_8":"syncBlockAndMuteList","34_5":"v2SetP2PMessageMuteMode","3_105":"v2OnUpdateMuteList"},_p={accountId:1,name:3,avatar:4,sign:5,gender:{id:6,retType:"number"},email:7,birthday:8,mobile:9,serverExtension:10,createTime:{id:12,retType:"number"},updateTime:{id:13,retType:"number"}},Mp={v2UpdateBlockList:{sid:34,cid:3,service:yp,params:[{type:"String",name:"accountId"},{type:"Bool",name:"addToBlockList"}]},v2GetUserList:{sid:34,cid:7,service:yp,params:[{type:"StrArray",name:"accountIds"}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(_p)}]},v2UpdateSelfUserProfile:{sid:34,cid:10,service:yp,params:[{type:"Property",name:"tag",reflectMapper:_p}],response:[{type:"Long",name:"updateTime"}]},onUpdateUserProfile:{sid:3,cid:110,service:yp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(_p)}]},onUpdateBlockList:{sid:3,cid:103,service:yp,response:[{type:"String",name:"accountId"},{type:"Bool",name:"addToBlockList"}]},syncBlockAndMuteList:{sid:3,cid:8,service:yp,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem({accountId:0,isMute:{id:1,retType:"boolean"},isBlock:{id:2,retType:"boolean"}})},{type:"Long",name:"timetag"}]},v2SyncSelfUserInfo:{sid:3,cid:109,service:yp,response:[{type:"Property",name:"user",reflectMapper:invertSerializeItem(_p)}]},v2SetP2PMessageMuteMode:{sid:34,cid:5,service:yp,params:[{type:"String",name:"accountId"},{type:"Bool",name:"muteMode"}]},v2OnUpdateMuteList:{sid:3,cid:105,service:yp,response:[{type:"String",name:"accountId"},{type:"Bool",name:"mute"}]}};class V2NIMUserModelImpl{constructor(){this.muteList=new Set,this.userMap=new Map,this.blockList=[]}reset(){this.muteList.clear(),this.userMap.clear(),this.blockList=[]}setAccountMuteMode(e,t){t===it.V2NIM_P2P_MESSAGE_MUTE_MODE_ON?this.muteList.add(e):this.muteList.delete(e)}setUser(e){this.userMap.set(e.accountId,e)}getUser(e){return this.userMap.get(e)}getUserListBySearchOption(e){return Array.from(this.userMap.values()).filter((t=>!(void 0!==e.searchName&&!e.searchName||!t.name.includes(e.keyword))||(!(!e.searchAccountId||!t.accountId.includes(e.keyword))||!!(t.mobile&&e.searchMobile&&t.mobile.includes(e.keyword)))))}addToBlockList(e){e.forEach((e=>{this.blockList.includes(e)||this.blockList.push(e)}))}removeFromBlockList(e){e.forEach((e=>{var t=this.blockList.indexOf(e);-1!==t&&this.blockList.splice(t,1)}))}}var fp={type:"string",required:!0,allowEmpty:!1},Tp={type:"string",required:!1,allowEmpty:!0},Ep={name:{type:"string",required:!1,allowEmpty:!0},avatar:Tp,sign:Tp,email:Tp,birthday:Tp,mobile:Tp,gender:{type:"number",required:!1},serverExtension:Tp};var Sp="V2NIMFriendService",Cp={"35_1":"v2AddFriend","35_2":"v2DeleteFriend","35_3":"v2SetFriendInfo","35_4":"v2IncFriendInfo","12_101":"v2OnAddFriend","12_102":"v2OnDeleteFriend","12_103":"v2OnUpdateFriendInfo","12_5":"v2SyncFriendList","12_6":"v2SyncFriendUserList"},Np={accountId:4,source:{id:7,retType:"number"},alias:8,serverExtension:10,createTime:{id:11,retType:"number"},updateTime:{id:12,retType:"number"},customerExtension:13},Ap={v2AddFriend:{sid:35,cid:1,service:Sp,params:[{type:"String",name:"accountId"},{type:"Byte",name:"verifyType"},{type:"String",name:"postscript"}],response:[]},v2DeleteFriend:{sid:35,cid:2,service:Sp,params:[{type:"String",name:"accountId"},{type:"Property",name:"params",reflectMapper:{deleteAlias:{id:1,converter:boolToInt}}}]},v2SetFriendInfo:{sid:35,cid:3,service:Sp,params:[{type:"Property",name:"tag",reflectMapper:Np}]},v2OnAddFriend:{sid:12,cid:101,service:Sp,response:[{type:"String",name:"accountId"},{type:"Byte",name:"verifyType"},{type:"String",name:"postscript"},{type:"Property",name:"ext",reflectMapper:invertSerializeItem({serverExt:1})}]},v2OnDeleteFriend:{sid:12,cid:102,service:Sp,response:[{type:"String",name:"accountId"}]},v2OnUpdateFriendInfo:{sid:12,cid:103,service:Sp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Np)}]},v2SyncFriendList:{sid:12,cid:5,service:Sp,response:[{type:"PropertyArray",name:"friends",reflectMapper:invertSerializeItem(Np)},{type:"Long",name:"timetag"}]},v2SyncFriendUserList:{sid:12,cid:6,service:Sp,response:[{type:"PropertyArray",name:"users",reflectMapper:invertSerializeItem(_p)}]},v2IncFriendInfo:{sid:35,cid:4,service:Sp,params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"friends",reflectMapper:invertSerializeItem(Np)},{type:"Long",name:"timetag"}]}},bp={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!0,rules:{addMode:{type:"enum",required:!0,values:getEnumValues(Ve)},postscript:{type:"string",required:!1,allowEmpty:!0}}}},Rp={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!1,rules:{deleteAlias:{type:"boolean",required:!1}}}},Op={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!1,rules:{alias:{type:"string",required:!1,allowEmpty:!0},serverExtension:{type:"string",required:!1,allowEmpty:!0}}}},Pp={applicantAccountId:{type:"string",required:!0,allowEmpty:!1},recipientAccountId:{type:"string",required:!0,allowEmpty:!1},operatorAccountId:{type:"string",required:!0,allowEmpty:!1},postscript:{type:"string",required:!1,allowEmpty:!0},status:{type:"enum",required:!0,values:getEnumValues(we)},timestamp:{type:"number",required:!1}},Vp={offset:{type:"number",required:!1},limit:{type:"number",required:!1},status:{type:"array",itemType:"enum",required:!1,values:getEnumValues(we)}};class V2NIMFriendNotificationImpl{constructor(e,t){this.core=e,this.service=t}processSysNotification(e){if(6===e.type){var t=e.senderId;this.core.V2NIMFriendService.handleDeleteFriend(t,Le.V2NIM_FRIEND_DELETION_TYPE_BY_PEER)}else if(5===e.type)try{var r=JSON.parse(e.content);if((null==r?void 0:r.vt)===De.V2NIM_FRIEND_VERIFY_TYPE_ADD){this.core.V2NIMFriendService.handleAddFriend(e.senderId,e.timestamp);var i={applicantAccountId:e.senderId,recipientAccountId:e.receiverId,operatorAccountId:e.senderId,postscript:e.postscript,timestamp:e.timestamp,status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD,read:!0};this.service.model.appendFriendAddApplication(i),this.service.model.updateFriendAddApplicationStatus(i.applicantAccountId,we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD,i.applicantAccountId)}else if((null==r?void 0:r.vt)===De.V2NIM_FRIEND_VERIFY_TYPE_APPLY){var n={applicantAccountId:e.senderId,recipientAccountId:e.receiverId,operatorAccountId:e.senderId,postscript:e.postscript,timestamp:e.timestamp,status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT,read:!1};this.service.handleApplyFriend(n),this.core.V2NIMFriendService.model.appendFriendAddApplication(n)}else if((null==r?void 0:r.vt)===De.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT){this.core.V2NIMFriendService.handleAddFriend(e.senderId,e.timestamp);var a={applicantAccountId:e.receiverId,recipientAccountId:e.senderId,operatorAccountId:e.senderId,timestamp:e.timestamp,postscript:e.postscript,status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED,read:!0};this.core.V2NIMFriendService.model.appendFriendAddApplication(a)}else if((null==r?void 0:r.vt)===De.V2NIM_FRIEND_VERIFY_TYPE_REJECT){var s={applicantAccountId:e.receiverId,recipientAccountId:e.senderId,operatorAccountId:e.senderId,timestamp:e.timestamp,postscript:e.postscript,status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED,read:!0};this.core.V2NIMFriendService.model.appendFriendAddApplication(s),this.service.emit("onFriendAddRejected",s)}}catch(e){this.core.logger.warn("V2NIMFriendNotificationImpl::processSysNotification, parse content error:",e)}}}class V2NIMFriendModelImpl{constructor(){this.validFriendIds=new Set,this.friendMap=new Map,this.applicationInfoList=[],this.friendTimetag=0}getAddApplicationList(e){var t=void 0===e.offset||0===e.offset?Number.MAX_SAFE_INTEGER:e.offset,r=this.applicationInfoList.filter((r=>{if(r.timestamp>=t)return!1;var i=e.status||[];return 0===i.length||!!i.includes(r.status)})),i=e.limit||50,n=Math.min(i,r.length),a=r.reverse().slice(0,n),s=t;return a.length>0&&(s=a[a.length-1].timestamp),{infos:a,finished:n>=r.length,offset:n>=r.length?0:s}}reset(){this.friendMap.clear(),this.validFriendIds.clear(),this.applicationInfoList=[]}setAddApplicationRead(){for(var e of this.applicationInfoList)e.read=!0}getAddApplicationUnreadCount(){var e=new Set;for(var t of this.applicationInfoList)t.read||t.status!==we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT||e.add(t.applicantAccountId);return e.size}appendFriendAddApplication(e){this.applicationInfoList.push(e)}updateFriendAddApplicationStatus(e,t,r){if(t!==we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT)for(var i of this.applicationInfoList)i.applicantAccountId===e&&i.status===we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT&&(i.status=t,i.operatorAccountId=r,i.read=!0)}upsertFriend(e,t){var r=this.friendMap.get(e)||{},i=Object.assign({accountId:e},r,t);return this.friendMap.set(e,i),this.validFriendIds.add(e),i}addFriend(e){this.validFriendIds.add(e)}deleteFriend(e){this.validFriendIds.delete(e)}getFriend(e){return this.validFriendIds.has(e)?this.friendMap.get(e):void 0}getFriendList(){return Array.from(this.validFriendIds.values()).map((e=>this.getFriend(e))).filter((e=>!!e))}getFriendListBySearchOption(e){return Array.from(this.validFriendIds.values()).map((e=>this.getFriend(e))).filter((t=>{var r=void 0===e.searchAlias||e.searchAlias;return void 0!==t&&(!!(r&&t.alias&&t.alias.includes(e.keyword))||!(!e.searchAccountId||!t.accountId.includes(e.keyword)))}))}getFriendByIds(e){return e.map((e=>this.getFriend(e))).filter((e=>!!e))}setFriendTimetag(e){this.friendTimetag=e}getFriendTimetag(){return this.friendTimetag}}var kp={muteMode:{type:"enum",values:getEnumValues(rt)}},wp={accountId:{type:"string",required:!0,allowEmpty:!1},muteMode:{type:"enum",required:!0,values:getEnumValues(it)}},Lp={type:"object",required:!1,rules:{certificateName:{type:"string",required:!0,allowEmpty:!1},appId:{type:"string",required:!1,allowEmpty:!1},appKey:{type:"string",required:!1,allowEmpty:!1},secret:{type:"string",required:!1,allowEmpty:!1}}},Dp={config:{type:"object",required:!0,rules:{apns:Lp,hwPush:Lp,miPush:Lp,vivoPush:Lp,oppoPush:Lp,honorPush:Lp,fcmPush:Lp,mzPush:Lp}}},Up="V2NIMSettingService",qp={"34_1":"v2SetDeviceToken","34_2":"v2SetAppBackground","34_15":"v2SetPushMobileOnDesktopOnline"},xp={v2SetDeviceToken:{sid:34,cid:1,service:Up,params:[{type:"String",name:"certificateName"},{type:"String",name:"pushDeviceToken"},{type:"Int",name:"pushkit"}]},v2SetAppBackground:{sid:34,cid:2,service:Up,params:[{type:"Bool",name:"isBackground"},{type:"Int",name:"badge"}]},v2SetPushMobileOnDesktopOnline:{sid:34,cid:15,service:Up,params:[{type:"Property",name:"tag",reflectMapper:{need:{id:1,converter:e=>e?2:1}}}]}},Bp=Bp||function(e){var t;"undefined"!=typeof window&&window.crypto&&(t=window.crypto),"undefined"!=typeof self&&self.crypto&&(t=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(t=globalThis.crypto),!t&&"undefined"!=typeof window&&window.msCrypto&&(t=window.msCrypto),!t&&"undefined"!=typeof global&&global.crypto&&(t=global.crypto);var cryptoSecureRandomInt=function(){if(t){if("function"==typeof t.getRandomValues)try{return t.getRandomValues(new Uint32Array(1))[0]}catch(e){}if("function"==typeof t.randomBytes)try{return t.randomBytes(4).readInt32LE()}catch(e){}}throw new Error("Native crypto module could not be used to get secure random number.")},r=Object.create||function(){function F(){}return function(e){var t;return F.prototype=e,t=new F,F.prototype=null,t}}(),i={},n=i.lib={},a=n.Base={extend:function(e){var t=r(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},s=n.WordArray=a.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,r=e.words,i=this.sigBytes,n=e.sigBytes;if(this.clamp(),i%4)for(var a=0;a<n;a++){var s=r[a>>>2]>>>24-a%4*8&255;t[i+a>>>2]|=s<<24-(i+a)%4*8}else for(var o=0;o<n;o+=4)t[i+o>>>2]=r[o>>>2];return this.sigBytes+=n,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=a.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],r=0;r<e;r+=4)t.push(cryptoSecureRandomInt());return new s.init(t,e)}}),o=i.enc={},c=o.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],n=0;n<r;n++){var a=t[n>>>2]>>>24-n%4*8&255;i.push((a>>>4).toString(16)),i.push((15&a).toString(16))}return i.join("")},parse:function(e){for(var t=e.length,r=[],i=0;i<t;i+=2)r[i>>>3]|=parseInt(e.substr(i,2),16)<<24-i%8*4;return new s.init(r,t/2)}},d=o.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],n=0;n<r;n++){var a=t[n>>>2]>>>24-n%4*8&255;i.push(String.fromCharCode(a))}return i.join("")},parse:function(e){for(var t=e.length,r=[],i=0;i<t;i++)r[i>>>2]|=(255&e.charCodeAt(i))<<24-i%4*8;return new s.init(r,t)}},l=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},m=n.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r,i=this._data,n=i.words,a=i.sigBytes,o=this.blockSize,c=a/(4*o),d=(c=t?e.ceil(c):e.max((0|c)-this._minBufferSize,0))*o,l=e.min(4*d,a);if(d){for(var m=0;m<d;m+=o)this._doProcessBlock(n,m);r=n.splice(0,d),i.sigBytes-=l}return new s.init(r,l)},clone:function(){var e=a.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=m.extend({cfg:a.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){m.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new p.HMAC.init(e,r).finalize(t)}}});var p=i.algo={};return i}(Math),Fp=Bp.enc.Utf8,Gp=Bp,jp=Gp.lib,Hp=jp.WordArray,Yp=jp.Hasher,$p=Gp.algo,Wp=[],zp=$p.SHA1=Yp.extend({_doReset:function(){this._hash=new Hp.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=this._hash.words,i=r[0],n=r[1],a=r[2],s=r[3],o=r[4],c=0;c<80;c++){if(c<16)Wp[c]=0|e[t+c];else{var d=Wp[c-3]^Wp[c-8]^Wp[c-14]^Wp[c-16];Wp[c]=d<<1|d>>>31}var l=(i<<5|i>>>27)+o+Wp[c];l+=c<20?1518500249+(n&a|~n&s):c<40?1859775393+(n^a^s):c<60?(n&a|n&s|a&s)-1894007588:(n^a^s)-899497514,o=s,s=a,a=n<<30|n>>>2,n=i,i=l}r[0]=r[0]+i|0,r[1]=r[1]+n|0,r[2]=r[2]+a|0,r[3]=r[3]+s|0,r[4]=r[4]+o|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,i=8*e.sigBytes;return t[i>>>5]|=128<<24-i%32,t[14+(i+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(i+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=Yp.clone.call(this);return e._hash=this._hash.clone(),e}});Gp.SHA1=Yp._createHelper(zp),Gp.HmacSHA1=Yp._createHmacHelper(zp),Bp.SHA1,function(e){var t=e,r=t.lib.Base,i=t.enc.Utf8;t.algo.HMAC=r.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=i.parse(t));var r=e.blockSize,n=4*r;t.sigBytes>n&&(t=e.finalize(t)),t.clamp();for(var a=this._oKey=t.clone(),s=this._iKey=t.clone(),o=a.words,c=s.words,d=0;d<r;d++)o[d]^=1549556828,c[d]^=909522486;a.sigBytes=s.sigBytes=n,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})}(Bp);var Kp=Bp,Jp=Kp.lib,Qp=Jp.Base,Xp=Jp.WordArray,Zp=Kp.algo,eu=Zp.MD5,tu=Zp.EvpKDF=Qp.extend({cfg:Qp.extend({keySize:4,hasher:eu,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var r,i=this.cfg,n=i.hasher.create(),a=Xp.create(),s=a.words,o=i.keySize,c=i.iterations;s.length<o;){r&&n.update(r),r=n.update(e).finalize(t),n.reset();for(var d=1;d<c;d++)r=n.finalize(r),n.reset();a.concat(r)}return a.sigBytes=4*o,a}});Kp.EvpKDF=function(e,t,r){return tu.create(r).compute(e,t)},Bp.EvpKDF;var ru=Bp,iu=ru.lib.WordArray;ru.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,i=this._map;e.clamp();for(var n=[],a=0;a<r;a+=3)for(var s=(t[a>>>2]>>>24-a%4*8&255)<<16|(t[a+1>>>2]>>>24-(a+1)%4*8&255)<<8|t[a+2>>>2]>>>24-(a+2)%4*8&255,o=0;o<4&&a+.75*o<r;o++)n.push(i.charAt(s>>>6*(3-o)&63));var c=i.charAt(64);if(c)for(;n.length%4;)n.push(c);return n.join("")},parse:function(e){var t=e.length,r=this._map,i=this._reverseMap;if(!i){i=this._reverseMap=[];for(var n=0;n<r.length;n++)i[r.charCodeAt(n)]=n}var a=r.charAt(64);if(a){var s=e.indexOf(a);-1!==s&&(t=s)}return function parseLoop(e,t,r){for(var i=[],n=0,a=0;a<t;a++)if(a%4){var s=r[e.charCodeAt(a-1)]<<a%4*2|r[e.charCodeAt(a)]>>>6-a%4*2;i[n>>>2]|=s<<24-n%4*8,n++}return iu.create(i,n)}(e,t,i)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},Bp.enc.Base64;var nu=Bp,au=nu.lib,su=au.WordArray,ou=au.Hasher,cu=nu.algo,du=[];!function(){for(var e=0;e<64;e++)du[e]=4294967296*Math.abs(Math.sin(e+1))|0}();var lu=cu.MD5=ou.extend({_doReset:function(){this._hash=new su.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var i=t+r,n=e[i];e[i]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var a=this._hash.words,s=e[t+0],o=e[t+1],c=e[t+2],d=e[t+3],l=e[t+4],m=e[t+5],p=e[t+6],u=e[t+7],h=e[t+8],g=e[t+9],v=e[t+10],y=e[t+11],I=e[t+12],_=e[t+13],M=e[t+14],f=e[t+15],T=a[0],E=a[1],S=a[2],C=a[3];T=FF(T,E,S,C,s,7,du[0]),C=FF(C,T,E,S,o,12,du[1]),S=FF(S,C,T,E,c,17,du[2]),E=FF(E,S,C,T,d,22,du[3]),T=FF(T,E,S,C,l,7,du[4]),C=FF(C,T,E,S,m,12,du[5]),S=FF(S,C,T,E,p,17,du[6]),E=FF(E,S,C,T,u,22,du[7]),T=FF(T,E,S,C,h,7,du[8]),C=FF(C,T,E,S,g,12,du[9]),S=FF(S,C,T,E,v,17,du[10]),E=FF(E,S,C,T,y,22,du[11]),T=FF(T,E,S,C,I,7,du[12]),C=FF(C,T,E,S,_,12,du[13]),S=FF(S,C,T,E,M,17,du[14]),T=GG(T,E=FF(E,S,C,T,f,22,du[15]),S,C,o,5,du[16]),C=GG(C,T,E,S,p,9,du[17]),S=GG(S,C,T,E,y,14,du[18]),E=GG(E,S,C,T,s,20,du[19]),T=GG(T,E,S,C,m,5,du[20]),C=GG(C,T,E,S,v,9,du[21]),S=GG(S,C,T,E,f,14,du[22]),E=GG(E,S,C,T,l,20,du[23]),T=GG(T,E,S,C,g,5,du[24]),C=GG(C,T,E,S,M,9,du[25]),S=GG(S,C,T,E,d,14,du[26]),E=GG(E,S,C,T,h,20,du[27]),T=GG(T,E,S,C,_,5,du[28]),C=GG(C,T,E,S,c,9,du[29]),S=GG(S,C,T,E,u,14,du[30]),T=HH(T,E=GG(E,S,C,T,I,20,du[31]),S,C,m,4,du[32]),C=HH(C,T,E,S,h,11,du[33]),S=HH(S,C,T,E,y,16,du[34]),E=HH(E,S,C,T,M,23,du[35]),T=HH(T,E,S,C,o,4,du[36]),C=HH(C,T,E,S,l,11,du[37]),S=HH(S,C,T,E,u,16,du[38]),E=HH(E,S,C,T,v,23,du[39]),T=HH(T,E,S,C,_,4,du[40]),C=HH(C,T,E,S,s,11,du[41]),S=HH(S,C,T,E,d,16,du[42]),E=HH(E,S,C,T,p,23,du[43]),T=HH(T,E,S,C,g,4,du[44]),C=HH(C,T,E,S,I,11,du[45]),S=HH(S,C,T,E,f,16,du[46]),T=II(T,E=HH(E,S,C,T,c,23,du[47]),S,C,s,6,du[48]),C=II(C,T,E,S,u,10,du[49]),S=II(S,C,T,E,M,15,du[50]),E=II(E,S,C,T,m,21,du[51]),T=II(T,E,S,C,I,6,du[52]),C=II(C,T,E,S,d,10,du[53]),S=II(S,C,T,E,v,15,du[54]),E=II(E,S,C,T,o,21,du[55]),T=II(T,E,S,C,h,6,du[56]),C=II(C,T,E,S,f,10,du[57]),S=II(S,C,T,E,p,15,du[58]),E=II(E,S,C,T,_,21,du[59]),T=II(T,E,S,C,l,6,du[60]),C=II(C,T,E,S,y,10,du[61]),S=II(S,C,T,E,c,15,du[62]),E=II(E,S,C,T,g,21,du[63]),a[0]=a[0]+T|0,a[1]=a[1]+E|0,a[2]=a[2]+S|0,a[3]=a[3]+C|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,i=8*e.sigBytes;t[i>>>5]|=128<<24-i%32;var n=Math.floor(r/4294967296),a=r;t[15+(i+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),t[14+(i+64>>>9<<4)]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),e.sigBytes=4*(t.length+1),this._process();for(var s=this._hash,o=s.words,c=0;c<4;c++){var d=o[c];o[c]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8)}return s},clone:function(){var e=ou.clone.call(this);return e._hash=this._hash.clone(),e}});function FF(e,t,r,i,n,a,s){var o=e+(t&r|~t&i)+n+s;return(o<<a|o>>>32-a)+t}function GG(e,t,r,i,n,a,s){var o=e+(t&i|r&~i)+n+s;return(o<<a|o>>>32-a)+t}function HH(e,t,r,i,n,a,s){var o=e+(t^r^i)+n+s;return(o<<a|o>>>32-a)+t}function II(e,t,r,i,n,a,s){var o=e+(r^(t|~i))+n+s;return(o<<a|o>>>32-a)+t}nu.MD5=ou._createHelper(lu),nu.HmacMD5=ou._createHmacHelper(lu),Bp.MD5,function(e){e.lib.Cipher||function(){var t=e,r=t.lib,i=r.Base,n=r.WordArray,a=r.BufferedBlockAlgorithm,s=t.enc;s.Utf8;var o=s.Base64,c=t.algo.EvpKDF,d=r.Cipher=a.extend({cfg:i.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset()},reset:function(){a.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function selectCipherStrategy(e){return"string"==typeof e?I:v}return function(e){return{encrypt:function(t,r,i){return selectCipherStrategy(r).encrypt(e,t,r,i)},decrypt:function(t,r,i){return selectCipherStrategy(r).decrypt(e,t,r,i)}}}}()});r.StreamCipher=d.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var l=t.mode={},m=r.BlockCipherMode=i.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}}),p=l.CBC=function(){var e=m.extend();function xorBlock(e,t,r){var i,n=this._iv;n?(i=n,this._iv=void 0):i=this._prevBlock;for(var a=0;a<r;a++)e[t+a]^=i[a]}return e.Encryptor=e.extend({processBlock:function(e,t){var r=this._cipher,i=r.blockSize;xorBlock.call(this,e,t,i),r.encryptBlock(e,t),this._prevBlock=e.slice(t,t+i)}}),e.Decryptor=e.extend({processBlock:function(e,t){var r=this._cipher,i=r.blockSize,n=e.slice(t,t+i);r.decryptBlock(e,t),xorBlock.call(this,e,t,i),this._prevBlock=n}}),e}(),u=(t.pad={}).Pkcs7={pad:function(e,t){for(var r=4*t,i=r-e.sigBytes%r,a=i<<24|i<<16|i<<8|i,s=[],o=0;o<i;o+=4)s.push(a);var c=n.create(s,i);e.concat(c)},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}};r.BlockCipher=d.extend({cfg:d.cfg.extend({mode:p,padding:u}),reset:function(){var e;d.reset.call(this);var t=this.cfg,r=t.iv,i=t.mode;this._xformMode==this._ENC_XFORM_MODE?e=i.createEncryptor:(e=i.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==e?this._mode.init(this,r&&r.words):(this._mode=e.call(i,this,r&&r.words),this._mode.__creator=e)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e,t=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(t.pad(this._data,this.blockSize),e=this._process(!0)):(e=this._process(!0),t.unpad(e)),e},blockSize:4});var h=r.CipherParams=i.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),g=(t.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,r=e.salt;return(r?n.create([1398893684,1701076831]).concat(r).concat(t):t).toString(o)},parse:function(e){var t,r=o.parse(e),i=r.words;return 1398893684==i[0]&&1701076831==i[1]&&(t=n.create(i.slice(2,4)),i.splice(0,4),r.sigBytes-=16),h.create({ciphertext:r,salt:t})}},v=r.SerializableCipher=i.extend({cfg:i.extend({format:g}),encrypt:function(e,t,r,i){i=this.cfg.extend(i);var n=e.createEncryptor(r,i),a=n.finalize(t),s=n.cfg;return h.create({ciphertext:a,key:r,iv:s.iv,algorithm:e,mode:s.mode,padding:s.padding,blockSize:e.blockSize,formatter:i.format})},decrypt:function(e,t,r,i){return i=this.cfg.extend(i),t=this._parse(t,i.format),e.createDecryptor(r,i).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),y=(t.kdf={}).OpenSSL={execute:function(e,t,r,i){i||(i=n.random(8));var a=c.create({keySize:t+r}).compute(e,i),s=n.create(a.words.slice(t),4*r);return a.sigBytes=4*t,h.create({key:a,iv:s,salt:i})}},I=r.PasswordBasedCipher=v.extend({cfg:v.cfg.extend({kdf:y}),encrypt:function(e,t,r,i){var n=(i=this.cfg.extend(i)).kdf.execute(r,e.keySize,e.ivSize);i.iv=n.iv;var a=v.encrypt.call(this,e,t,n.key,i);return a.mixIn(n),a},decrypt:function(e,t,r,i){i=this.cfg.extend(i),t=this._parse(t,i.format);var n=i.kdf.execute(r,e.keySize,e.ivSize,t.salt);return i.iv=n.iv,v.decrypt.call(this,e,t,n.key,i)}})}()}(Bp);var mu=Bp,pu=mu.lib.StreamCipher,uu=mu.algo,hu=uu.RC4=pu.extend({_doReset:function(){for(var e=this._key,t=e.words,r=e.sigBytes,i=this._S=[],n=0;n<256;n++)i[n]=n;n=0;for(var a=0;n<256;n++){var s=n%r,o=t[s>>>2]>>>24-s%4*8&255;a=(a+i[n]+o)%256;var c=i[n];i[n]=i[a],i[a]=c}this._i=this._j=0},_doProcessBlock:function(e,t){e[t]^=generateKeystreamWord.call(this)},keySize:8,ivSize:0});function generateKeystreamWord(){for(var e=this._S,t=this._i,r=this._j,i=0,n=0;n<4;n++){r=(r+e[t=(t+1)%256])%256;var a=e[t];e[t]=e[r],e[r]=a,i|=e[(e[t]+e[r])%256]<<24-8*n}return this._i=t,this._j=r,i}mu.RC4=pu._createHelper(hu);var gu=uu.RC4Drop=hu.extend({cfg:hu.cfg.extend({drop:192}),_doReset:function(){hu._doReset.call(this);for(var e=this.cfg.drop;e>0;e--)generateKeystreamWord.call(this)}});mu.RC4Drop=pu._createHelper(gu);var vu=Bp.RC4;var yu={"27_1":"v2NIMSync","27_10":"v2QChatSync"},Iu={v2NIMSync:{sid:27,cid:1,service:"V2NIMSyncService",hasPacketTimer:!1,params:[{type:"Property",name:"tag",reflectMapper:{myInfo:1,offlineMsgs:2,teams:3,roamingMsgs:7,relations:9,friends:11,friendUsers:13,msgReceipts:14,myTeamMembers:15,donnop:16,recallMsg:17,sessionAck:18,broadcastMsgs:20,avSignal:21,superTeams:22,mySuperTeamMembers:23,superTeamRoamingMsgs:24,deleteSuperTeamMsg:25,superTeamSessionAck:26,deleteSelfMsgs:27,stickTopSessions:28,sessionHistoryMsgsDelete:29,p2pTeamModifyMessage:30,superTeamModifyMessage:31}}],response:[{type:"Long",name:"timetag"}]},v2QChatSync:{sid:27,cid:10,service:"V2NIMSyncService",hasPacketTimer:!1,params:[{type:"Property",name:"tag",reflectMapper:{systemNotification:1,pushConfig:2}}],response:[{type:"Long",name:"timetag"}]}};var _u=function castSlice(e,t,r){var i=e.length;return r=void 0===r?i:r,!t&&r>=i?e:ga(e,t,r)},Mu=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");var fu=function hasUnicode(e){return Mu.test(e)};var Tu=function asciiToArray(e){return e.split("")},Eu="[\\ud800-\\udfff]",Su="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",Cu="\\ud83c[\\udffb-\\udfff]",Nu="[^\\ud800-\\udfff]",Au="(?:\\ud83c[\\udde6-\\uddff]){2}",bu="[\\ud800-\\udbff][\\udc00-\\udfff]",Ru="(?:"+Su+"|"+Cu+")"+"?",Ou="[\\ufe0e\\ufe0f]?",Pu=Ou+Ru+("(?:\\u200d(?:"+[Nu,Au,bu].join("|")+")"+Ou+Ru+")*"),Vu="(?:"+[Nu+Su+"?",Su,Au,bu,Eu].join("|")+")",ku=RegExp(Cu+"(?="+Cu+")|"+Vu+Pu,"g");var wu=function unicodeToArray(e){return e.match(ku)||[]};var Lu=function stringToArray(e){return fu(e)?wu(e):Tu(e)};var Du=function createCaseFirst(e){return function(t){t=Te(t);var r=fu(t)?Lu(t):void 0,i=r?r[0]:t.charAt(0),n=r?_u(r,1).join(""):t.slice(1);return i[e]()+n}}("toUpperCase");var Uu=function capitalize(e){return Du(Te(e).toLowerCase())};var qu=function arrayReduce(e,t,r,i){var n=-1,a=null==e?0:e.length;for(i&&a&&(r=e[++n]);++n<a;)r=t(r,e[n],n,e);return r};var xu=function basePropertyOf(e){return function(t){return null==e?void 0:e[t]}}({"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss","Ā":"A","Ă":"A","Ą":"A","ā":"a","ă":"a","ą":"a","Ć":"C","Ĉ":"C","Ċ":"C","Č":"C","ć":"c","ĉ":"c","ċ":"c","č":"c","Ď":"D","Đ":"D","ď":"d","đ":"d","Ē":"E","Ĕ":"E","Ė":"E","Ę":"E","Ě":"E","ē":"e","ĕ":"e","ė":"e","ę":"e","ě":"e","Ĝ":"G","Ğ":"G","Ġ":"G","Ģ":"G","ĝ":"g","ğ":"g","ġ":"g","ģ":"g","Ĥ":"H","Ħ":"H","ĥ":"h","ħ":"h","Ĩ":"I","Ī":"I","Ĭ":"I","Į":"I","İ":"I","ĩ":"i","ī":"i","ĭ":"i","į":"i","ı":"i","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","ĸ":"k","Ĺ":"L","Ļ":"L","Ľ":"L","Ŀ":"L","Ł":"L","ĺ":"l","ļ":"l","ľ":"l","ŀ":"l","ł":"l","Ń":"N","Ņ":"N","Ň":"N","Ŋ":"N","ń":"n","ņ":"n","ň":"n","ŋ":"n","Ō":"O","Ŏ":"O","Ő":"O","ō":"o","ŏ":"o","ő":"o","Ŕ":"R","Ŗ":"R","Ř":"R","ŕ":"r","ŗ":"r","ř":"r","Ś":"S","Ŝ":"S","Ş":"S","Š":"S","ś":"s","ŝ":"s","ş":"s","š":"s","Ţ":"T","Ť":"T","Ŧ":"T","ţ":"t","ť":"t","ŧ":"t","Ũ":"U","Ū":"U","Ŭ":"U","Ů":"U","Ű":"U","Ų":"U","ũ":"u","ū":"u","ŭ":"u","ů":"u","ű":"u","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","Ż":"Z","Ž":"Z","ź":"z","ż":"z","ž":"z","Ĳ":"IJ","ĳ":"ij","Œ":"Oe","œ":"oe","ŉ":"'n","ſ":"s"}),Bu=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Fu=RegExp("[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]","g");var Gu=function deburr(e){return(e=Te(e))&&e.replace(Bu,xu).replace(Fu,"")},ju=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g;var Hu=function asciiWords(e){return e.match(ju)||[]},Yu=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/;var $u=function hasUnicodeWord(e){return Yu.test(e)},Wu="\\u2700-\\u27bf",zu="a-z\\xdf-\\xf6\\xf8-\\xff",Ku="A-Z\\xc0-\\xd6\\xd8-\\xde",Ju="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Qu="["+Ju+"]",Xu="\\d+",Zu="[\\u2700-\\u27bf]",eh="["+zu+"]",th="[^\\ud800-\\udfff"+Ju+Xu+Wu+zu+Ku+"]",rh="(?:\\ud83c[\\udde6-\\uddff]){2}",ih="[\\ud800-\\udbff][\\udc00-\\udfff]",nh="["+Ku+"]",ah="(?:"+eh+"|"+th+")",sh="(?:"+nh+"|"+th+")",oh="(?:['’](?:d|ll|m|re|s|t|ve))?",ch="(?:['’](?:D|LL|M|RE|S|T|VE))?",dh="(?:[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]|\\ud83c[\\udffb-\\udfff])?",lh="[\\ufe0e\\ufe0f]?",mh=lh+dh+("(?:\\u200d(?:"+["[^\\ud800-\\udfff]",rh,ih].join("|")+")"+lh+dh+")*"),ph="(?:"+[Zu,rh,ih].join("|")+")"+mh,uh=RegExp([nh+"?"+eh+"+"+oh+"(?="+[Qu,nh,"$"].join("|")+")",sh+"+"+ch+"(?="+[Qu,nh+ah,"$"].join("|")+")",nh+"?"+ah+"+"+oh,nh+"+"+ch,"\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",Xu,ph].join("|"),"g");var hh=function unicodeWords(e){return e.match(uh)||[]};var gh=function words(e,t,r){return e=Te(e),void 0===(t=r?void 0:t)?$u(e)?hh(e):Hu(e):e.match(t)||[]},vh=RegExp("['’]","g");var yh=function createCompounder(e){return function(t){return qu(gh(Gu(t).replace(vh,"")),e,"")}}((function(e,t,r){return t=t.toLowerCase(),e+(r?Uu(t):t)})),Ih="V2NIMAIService",_h={"4_26":"v2AIChatNotify","29_35":"v2AIProxyModelCall","29_36":"v2AIGetUserList"},Mh={accountId:1,messages:{id:2,converter:objectToJSONString,retConverter:stringToJSONObject},requestId:3,content:{id:4,converter:objectToJSONString,retConverter:stringToJSONObject},promptVariables:5,modelConfigParams:{id:6,converter:objectToJSONString,retConverter:stringToJSONObject},antispamBusinessId:7,antispamEnabled:{id:8,converter:boolToInt}},fh={accountId:1,name:3,avatar:4,sign:5,gender:{id:6,retType:"number"},email:7,birthday:8,mobile:9,serverExtension:10,modelType:{id:11,retType:"number"},modelConfig:{id:12,retConverter:e=>{if(e=stringToJSONObject(e)){var t=Object.keys(e).reduce(((t,r)=>(t[yh(r)]=e[r],t)),{});if("string"==typeof t.promptKeys)try{t.promptKeys=JSON.parse(t.promptKeys)}catch(e){}return t}}},yunxinConfig:{id:13,retConverter:e=>{if(e=stringToJSONObject(e))return e}},valid:{id:14,retType:"boolean"},createTime:{id:15,retType:"number"},updateTime:{id:16,retType:"number"}},Th={v2AIChatNotify:{sid:4,cid:26,service:Ih,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem({code:{id:1,retType:"number"},accountId:2,requestId:3,content:{id:4,retConverter:stringToJSONObject}})}]},v2AIProxyModelCall:{sid:29,cid:35,service:Ih,params:[{type:"Property",name:"tag",reflectMapper:Mh}]},v2AIGetUserList:{sid:29,cid:36,service:Ih,params:[{type:"Property",name:"tag",reflectMapper:{pageToken:1,limit:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(fh)},{type:"Property",name:"queryTag",reflectMapper:invertSerializeItem({hasMore:{id:16,retType:"boolean"},nextToken:2})}]}};var Eh,Sh,Ch,Nh,Ah,bh,Rh={"18_1":"v2SignallingCreateRoom","18_2":"v2SignallingDelayRoom","18_3":"v2SignallingCloseRoom","18_4":"v2SignallingJoinRoom","18_5":"v2SignallingLeaveRoom","18_6":"v2SignallingInvite","18_7":"v2SignallingCancelInvite","18_16":"v2SignallingCall","18_17":"v2SignallingCallSetup","18_8":"v2SignallingRejectInvite","18_9":"v2SignallingAcceptInvite","18_10":"v2SignallingSendControl","15_11":"v2SignallingOnlineEvent","15_12":"v2SignallingMultiClientEvent","15_13":"v2SignallingOfflineEvent","15_14":"v2SignallingSyncChannels","18_15":"v2SignallingGetRoomInfo"},Oh="V2NIMSignallingService",Ph={accountId:1,uid:{id:2,retType:"number"},joinTime:{id:3,retType:"number"},expireTime:{id:4,retType:"number"},deviceId:5},Vh={channelType:{id:1,retType:"number",retAccess:"channelInfo.channelType"},channelName:{id:2,retAccess:"channelInfo.channelName"},channelId:{id:3,retAccess:"channelInfo.channelId"},createTime:{id:4,retType:"number",retAccess:"channelInfo.createTime"},expireTime:{id:5,retType:"number",retAccess:"channelInfo.expireTime"},creatorAccountId:{id:6,retAccess:"channelInfo.creatorAccountId"},channelExtension:{id:7,retAccess:"channelInfo.channelExtension"},invalid:8,fromAccid:10,toAccid:11,requestId:12,pushEnabled:{id:13,access:"pushConfig.pushEnabled",converter:boolToInt,retType:"boolean"},pushTitle:{id:14,access:"pushConfig.pushTitle"},pushContent:{id:15,access:"pushConfig.pushContent"},pushPayload:{id:16,access:"pushConfig.pushPayload"},unreadEnabled:{id:17,access:"signallingConfig.unreadEnabled",converter:boolToInt,retType:"boolean",def:1},members:{id:18,retAccess:"members",retConverter:e=>{try{return JSON.parse(e).map((e=>deserialize(e,invertSerializeItem(Ph))))}catch(e){return}}},attach:{id:19,retConverter:stringToJSONObject},serverExtension:{id:20,retDef:""},offlineEnabled:{id:21,converter:boolToInt,retType:"boolean",def:1},msgId:22,selfUid:{id:23,retType:"number",access:"signallingConfig.selfUid"},time:{id:24,retType:"number"},rtcChannelName:{id:25,access:"rtcConfig.rtcChannelName"},rtcTokenTtl:{id:26,retType:"number",access:"rtcConfig.rtcTokenTtl",retAccess:"rtcInfo.rtcTokenTtl"},rtcToken:{id:27,retAccess:"rtcInfo.rtcToken"},rtcParams:{id:28,access:"rtcConfig.rtcParams",retAccess:"rtcInfo.rtcParams"},callStatus:{id:30,retType:"number"}},kh={v2SignallingCall:{sid:18,cid:16,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingCallSetup:{sid:18,cid:17,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingCreateRoom:{sid:18,cid:1,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingDelayRoom:{sid:18,cid:2,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingCloseRoom:{sid:18,cid:3,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingJoinRoom:{sid:18,cid:4,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingLeaveRoom:{sid:18,cid:5,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingInvite:{sid:18,cid:6,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingCancelInvite:{sid:18,cid:7,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingRejectInvite:{sid:18,cid:8,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}]},v2SignallingAcceptInvite:{sid:18,cid:9,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}]},v2SignallingSendControl:{sid:18,cid:10,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}]},v2SignallingOnlineEvent:{sid:15,cid:11,service:Oh,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingMultiClientEvent:{sid:15,cid:12,service:Oh,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingOfflineEvent:{sid:15,cid:13,service:Oh,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingSyncChannels:{sid:15,cid:14,service:Oh,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingGetRoomInfo:{sid:18,cid:15,service:Oh,params:[{type:"Property",name:"tag",reflectMapper:Vh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Vh)}]},v2SignallingBatchMarkRead:{sid:4,cid:5,hasPacketResponse:!1,service:Oh,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]}},wh={calleeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},channelType:{type:"enum",values:getEnumValues(Mt)},channelName:{type:"string",required:!1,allowEmpty:!0},channelExtension:{type:"string",required:!1,allowEmpty:!0},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushTitle:{type:"string",required:!1,allowEmpty:!0},pushContent:{type:"string",required:!1,allowEmpty:!0},pushPayload:{type:"string",required:!1,allowEmpty:!0}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},Lh={channelId:{type:"string",required:!0,allowEmpty:!1},callerAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},Dh={channelType:{type:"enum",values:getEnumValues(Mt)},channelName:{type:"string",required:!1,allowEmpty:!0},channelExtension:{type:"string",required:!1,allowEmpty:!0}},Uh={channelId:{type:"string",required:!0,allowEmpty:!1},offlineEnabled:{type:"boolean",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},qh={channelId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},xh={channelId:{type:"string",required:!0,allowEmpty:!1},offlineEnabled:{type:"boolean",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},Bh={channelId:{type:"string",required:!0,allowEmpty:!1},inviteeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushTitle:{type:"string",required:!1,allowEmpty:!0},pushContent:{type:"string",required:!1,allowEmpty:!0},pushPayload:{type:"string",required:!1,allowEmpty:!0}}}},Fh={channelId:{type:"string",required:!0,allowEmpty:!1},inviteeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},offlineEnabled:{type:"boolean",required:!1}},Gh={channelId:{type:"string",allowEmpty:!1},receiverAccountId:{type:"string",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},jh={channelId:{type:"string",allowEmpty:!1},inviterAccountId:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},offlineEnabled:{type:"boolean",required:!1}},Hh=jh;function formatSignalingEvent(e){var t,r=e.attach,i={eventType:r.type,channelInfo:e.channelInfo,operatorAccountId:e.fromAccid,time:e.time,serverExtension:e.serverExtension,requestId:e.requestId,pushConfig:e.pushConfig,unreadEnabled:null===(t=e.signallingConfig)||void 0===t?void 0:t.unreadEnabled},{fromAccid:n,toAccid:a}=e;switch(i.eventType){case _t.V2NIM_SIGNALLING_EVENT_TYPE_CLOSE:break;case _t.V2NIM_SIGNALLING_EVENT_TYPE_JOIN:i.member={accountId:r.member[1],uid:Number(r.member[2]),joinTime:Number(r.member[3]),expireTime:Number(r.member[4]),deviceId:r.member[5]};break;case _t.V2NIM_SIGNALLING_EVENT_TYPE_INVITE:case _t.V2NIM_SIGNALLING_EVENT_TYPE_CANCEL_INVITE:i.operatorAccountId=n,i.inviteeAccountId=a,i.inviterAccountId=n;break;case _t.V2NIM_SIGNALLING_EVENT_TYPE_REJECT:case _t.V2NIM_SIGNALLING_EVENT_TYPE_ACCEPT:i.operatorAccountId=n,i.inviterAccountId=a,i.inviteeAccountId=n;case _t.V2NIM_SIGNALLING_EVENT_TYPE_LEAVE:case _t.V2NIM_SIGNALLING_EVENT_TYPE_CONTROL:}return JSON.parse(JSON.stringify(i))}!function(e){e[e.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN=0]="V2NIM_MESSAGE_SENDING_STATE_UNKNOWN",e[e.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED=1]="V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED",e[e.V2NIM_MESSAGE_SENDING_STATE_FAILED=2]="V2NIM_MESSAGE_SENDING_STATE_FAILED",e[e.V2NIM_MESSAGE_SENDING_STATE_SENDING=3]="V2NIM_MESSAGE_SENDING_STATE_SENDING"}(Eh||(Eh={})),function(e){e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN=0]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS=1]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED=2]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING=3]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING"}(Sh||(Sh={})),function(e){e[e.V2NIM_MESSAGE_TYPE_INVALID=-1]="V2NIM_MESSAGE_TYPE_INVALID",e[e.V2NIM_MESSAGE_TYPE_TEXT=0]="V2NIM_MESSAGE_TYPE_TEXT",e[e.V2NIM_MESSAGE_TYPE_IMAGE=1]="V2NIM_MESSAGE_TYPE_IMAGE",e[e.V2NIM_MESSAGE_TYPE_AUDIO=2]="V2NIM_MESSAGE_TYPE_AUDIO",e[e.V2NIM_MESSAGE_TYPE_VIDEO=3]="V2NIM_MESSAGE_TYPE_VIDEO",e[e.V2NIM_MESSAGE_TYPE_LOCATION=4]="V2NIM_MESSAGE_TYPE_LOCATION",e[e.V2NIM_MESSAGE_TYPE_NOTIFICATION=5]="V2NIM_MESSAGE_TYPE_NOTIFICATION",e[e.V2NIM_MESSAGE_TYPE_FILE=6]="V2NIM_MESSAGE_TYPE_FILE",e[e.V2NIM_MESSAGE_TYPE_AVCHAT=7]="V2NIM_MESSAGE_TYPE_AVCHAT",e[e.V2NIM_MESSAGE_TYPE_TIPS=10]="V2NIM_MESSAGE_TYPE_TIPS",e[e.V2NIM_MESSAGE_TYPE_ROBOT=11]="V2NIM_MESSAGE_TYPE_ROBOT",e[e.V2NIM_MESSAGE_TYPE_CALL=12]="V2NIM_MESSAGE_TYPE_CALL",e[e.V2NIM_MESSAGE_TYPE_CUSTOM=100]="V2NIM_MESSAGE_TYPE_CUSTOM"}(Ch||(Ch={})),function(e){e[e.V2NIM_QUERY_DIRECTION_DESC=0]="V2NIM_QUERY_DIRECTION_DESC",e[e.V2NIM_QUERY_DIRECTION_ASC=1]="V2NIM_QUERY_DIRECTION_ASC"}(Nh||(Nh={})),function(e){e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_ENTER=0]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_ENTER",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_EXIT=1]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_EXIT",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_BLOCK_ADDED=2]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_BLOCK_ADDED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_BLOCK_REMOVED=3]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_BLOCK_REMOVED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_CHAT_BANNED_ADDED=4]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_CHAT_BANNED_ADDED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_CHAT_BANNED_REMOVED=5]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_CHAT_BANNED_REMOVED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_ROOM_INFO_UPDATED=6]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_ROOM_INFO_UPDATED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_KICKED=7]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_KICKED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_TEMP_CHAT_BANNED_ADDED=8]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_TEMP_CHAT_BANNED_ADDED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_TEMP_CHAT_BANNED_REMOVED=9]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_TEMP_CHAT_BANNED_REMOVED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_INFO_UPDATED=10]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MEMBER_INFO_UPDATED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_QUEUE_CHANGE=11]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_QUEUE_CHANGE",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_CHAT_BANNED=12]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_CHAT_BANNED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_CHAT_BANNED_REMOVED=13]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_CHAT_BANNED_REMOVED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAG_TEMP_CHAT_BANNED_ADDED=14]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAG_TEMP_CHAT_BANNED_ADDED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAG_TEMP_CHAT_BANNED_REMOVED=15]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAG_TEMP_CHAT_BANNED_REMOVED",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MESSAGE_REVOKE=16]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_MESSAGE_REVOKE",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAGS_UPDATE=17]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_TAGS_UPDATE",e[e.V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_ROLE_UPDATE=18]="V2NIM_CHATROOM_MESSAGE_NOTIFICATION_TYPE_ROLE_UPDATE"}(Ah||(Ah={})),function(e){e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE=0]="V2NIM_CLIENT_ANTISPAM_OPERATE_NONE",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE=1]="V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD=2]="V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD=3]="V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD"}(bh||(bh={}));var Yh={attachment:{type:"object",rules:{url:{type:"string",allowEmpty:!1}}},thumbSize:{type:"object",rules:{width:{type:"number",required:!1,min:0},height:{type:"number",required:!1,min:0}}}};var $h={"19_1":"v2PublishEvent","14_2":"v2OnUserStatusChange","19_3":"v2SubscribeUserStatus","19_4":"v2UnsubscribeUserStatus","19_5":"v2UnsubscribeAllUserStatus","19_6":"v2QuerySubscribeEvent","19_7":"v2QueryAllSubscribeEvent","14_9":"v2OnMultiUserStatusChange"},Wh="V2NIMSubscriptionService",zh={eventType:{id:1,retType:"number"},statusType:{id:2,retType:"number"},uniqueId:3,extension:4,duration:{id:5,retType:"number"},onlineOnly:{id:6,retType:"boolean",converter:e=>e?1:2},multiSync:{id:7,retType:"boolean",converter:boolToInt},publishTime:{id:10,retType:"number"},serverId:11,clientType:{id:12,retType:"number"},serverExtension:13,extensionReceived:14,accountId:103},Kh={eventType:{id:1,retType:"number"},duration:{id:2,retType:"number"},immediateSync:{id:3,retType:"number",converter:boolToInt},accountId:102,subscribeTime:{id:105,retType:"number"}},Jh={v2PublishEvent:{sid:19,cid:1,service:Wh,params:[{type:"Property",name:"tag",reflectMapper:zh}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(zh)}]},v2OnUserStatusChange:{sid:14,cid:2,service:Wh,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(zh)}]},v2SubscribeUserStatus:{sid:19,cid:3,service:Wh,params:[{type:"Property",name:"tag",reflectMapper:Kh},{type:"StrArray",name:"accountIds"}],response:[{type:"StrArray",name:"failedList"}]},v2UnsubscribeUserStatus:{sid:19,cid:4,service:Wh,params:[{type:"Property",name:"tag",reflectMapper:Kh},{type:"StrArray",name:"accountIds"}],response:[{type:"StrArray",name:"failedList"}]},v2UnsubscribeAllUserStatus:{sid:19,cid:5,service:Wh,params:[{type:"Property",name:"tag",reflectMapper:Kh}]},v2QuerySubscribeEvent:{sid:19,cid:6,service:Wh,params:[{type:"Property",name:"tag",reflectMapper:Kh},{type:"StrArray",name:"accountIds"}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Kh)}]},v2QueryAllSubscribeEvent:{sid:19,cid:7,service:Wh,params:[{type:"Property",name:"tag",reflectMapper:Kh}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Kh)}]},v2OnMultiUserStatusChange:{sid:14,cid:9,service:Wh,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(zh)}]}},Qh={accountIds:{type:"array",required:!0,itemType:"string",min:1,max:100},duration:{type:"number",required:!1,min:60,max:2592e3},immediateSync:{type:"boolean",required:!1}},Xh={accountIds:{type:"array",required:!1,itemType:"string",max:100}},Zh={statusType:{type:"number",required:!0,min:1e4,max:2147483647},duration:{type:"number",required:!1,min:60,max:604800},extension:{type:"jsonstr",required:!1},onlineOnly:{type:"boolean",required:!1},multiSync:{type:"boolean",required:!1}};!function setAdapters(e){Jr(Xr,e())}((()=>Wa[getMiniappEnv()]())),NIM.registerService(V1NIMLoginServiceImpl,"V1NIMLoginService"),NIM.registerService(class MsgService extends Service$1{constructor(e){super("msg",e),this.onV2SendMessage=e=>{var t=formatMsg$1(e,{account:this.core.account,featureValue:oi.default});t.status=e.status,this.core.eventBus.emit("session/updateForNewMsg",t)},this.onV2ModifyMessage=e=>{var t,r=`${ni[e.scene]}-${e.to===this.core.account?e.from:e.to}`,i=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:r}),n=formatMsg$1(e,i?{account:this.core.account,sessionAck:i.ack,msgReceiptTime:i.msgReceiptTime}:{account:this.core.account});this.core.eventBus.emit("session/updateForModifyMsg",n)},this.onV2RecallMsg=e=>{var t=formatDeletedMsgs([e],getSceneFromRecallSysMsg(+e.type));this.core.eventBus.emit("session/updateForDeletedMsg",t)},this.onV2DeleteSelfMsgs=e=>{var t=formatDeletedMsgs(e);this.core.eventBus.emit("session/updateForDeletedMsg",t)},this.service=new ModuleService$2(e),registerParser({cmdMap:As,cmdConfig:Ps}),this.registerListener()}registerListener(){this.core.eventBus.on("forwardReceive/msg/sendMsg",this.onV2SendMessage),this.core.eventBus.on("forwardReceive/msg/modifyMsg",this.onV2ModifyMessage),this.core.eventBus.on("forwardReceive/msg/recallMsg",this.onV2RecallMsg),this.core.eventBus.on("forwardReceive/msg/deleteSelfMsgs",this.onV2DeleteSelfMsgs)}sendTextMsg(e){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"text"}))}sendTipMsg(e){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"tip"}))}sendGeoLocationMsg(e){return validate({attach:{type:"object",rules:{title:{type:"string",allowEmpty:!1},lat:{type:"number"},lng:{type:"number"}}}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"geo",attach:JSON.stringify(e.attach)}))}sendCustomMsg(e){return validate({attach:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"custom"}))}sendMsg(e){var t;if(validate({scene:{type:"enum",values:getEnumKeys(ni)},type:{type:"enum",values:getEnumKeys(ii)},to:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1},setting:{type:"object",rules:{resendFlag:{type:"boolean",required:!1},needSaveHistory:{type:"boolean",required:!1},needRoaming:{type:"boolean",required:!1},needOffline:{type:"boolean",required:!1},needSelfSync:{type:"boolean",required:!1},needRouted:{type:"boolean",required:!1},needUpdateSession:{type:"boolean",required:!1}},required:!1},antiSpamInfo:{type:"object",required:!1,rules:{clientAntispamHitting:{type:"boolean",required:!1},antiSpamUsingYidun:{type:"boolean",required:!1}}},pushInfo:{type:"object",required:!1,rules:vs},robotInfo:{type:"object",required:!1,rules:ys},teamSpecializationInfo:{type:"object",required:!1,rules:{needACK:{type:"boolean",required:!1}}}},e),"team"===e.scene&&e.robotInfo&&!e.robotInfo.account)throw new ValidateError('When "scene" equals "team", account is required in robotInfo',{key:"account"},"required");var r,i="p2p"===e.scene?"sendMsg":"team"===e.scene?"sendTeamMsg":"sendSuperTeamMsg",n=generatorMsgForCmd$1(e,this.core.account,this.core.config.deviceId,null===(t=this.core.user)||void 0===t?void 0:t.myInfo),a=formatMsg$1(Object.assign(Object.assign({},n),{time:(new Date).getTime()}),{account:this.core.account,featureValue:oi.default,statusValue:si.sending});try{e.onSendBefore&&e.onSendBefore(a)}catch(e){this.logger.error("sendMsg: options.onSendBefore error",e)}return this.core.eventBus.emit("session/updateForNewMsg",a),this.core.eventBus.emit("forwardSend/msg/sendMsg",n),this.core.sendCmd(i,{msg:n}).then((t=>{var{content:i,error:s}=t;if(r=i.msg,s)throw s;var o=formatMsg$1(Object.assign(Object.assign({},n),i.msg),{account:this.core.account,featureValue:oi.default,statusValue:si.sent});return o.from===o.to&&this.markMsgsAck([o]),this.core.eventBus.emit("session/updateForNewMsg",o),this.core.eventBus.emit("forwardSend/msg/sendMsg",Object.assign(Object.assign({},generatorMsgForCmd$1(o,o.from,o.fromDeviceId)),{idClient:o.idClient,status:"sent"})),this.core.reporter.report("msgSend",{msgId:o.idServer,clientId:o.idClient,msgTime:o.time,fromAccid:"p2p"===e.scene?this.core.account:"",toAccid:o.to,type:ni[o.scene],roomId:"",tid:"p2p"===e.scene?"":o.to,result:200,failReason:"",rt:Date.now()-a.time}),o})).catch((t=>{var i=formatMsg$1(Object.assign(Object.assign(Object.assign({},n),{time:(new Date).getTime()}),r),{account:this.core.account,featureValue:oi.default,statusValue:7101===t.code?si.refused:si.sendFailed});throw t.msg=i,this.core.eventBus.emit("session/updateForNewMsg",i),this.core.eventBus.emit("forwardSend/msg/sendMsg",Object.assign(Object.assign({},generatorMsgForCmd$1(i,i.from,i.fromDeviceId)),{status:"sendFailed"})),this.core.reporter.report("msgSend",{msgId:i.idServer,clientId:i.idClient,msgTime:i.time,fromAccid:"p2p"===e.scene?this.core.account:"",toAccid:i.to,type:ni[i.scene],roomId:"",tid:"p2p"===e.scene?"":i.to,result:null==t?void 0:t.code,failReason:(null==t?void 0:t.message)||"",rt:Date.now()-a.time}),t}))}resendMsg(e){return __awaiter(this,void 0,void 0,(function*(){validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1}}}},e);var t=e.msg,r=Object.assign(Object.assign({},t),{attach:t.attach?JSON.stringify(t.attach):void 0,setting:{resendFlag:!0}});if(t.from!==this.core.account)throw new Error(`You can only resend messages that you sent: ${t.idClient}`);return this.sendMsg(r)}))}forwardMsg(e){return __awaiter(this,void 0,void 0,(function*(){validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1}}},scene:{type:"enum",values:getEnumKeys(ni)},to:{type:"string",allowEmpty:!1}},e);var t=e.msg,r=Object.assign(Object.assign({},t),{scene:e.scene,to:e.to,attach:t.attach?JSON.stringify(t.attach):void 0});return this.sendMsg(r)}))}sendImageMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"image"}))}sendFileMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"file"}))}sendAudioMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"audio"}))}sendVideoMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"video"}))}doSendFile(e){return __awaiter(this,void 0,void 0,(function*(){validate({scene:{type:"enum",values:getEnumKeys(ni)},to:{type:"string",allowEmpty:!1},type:{type:"string",allowEmpty:!1},attach:{type:"object",rules:{url:{type:"string",allowEmpty:!1}},required:!1},maxSize:{type:"number",min:1,required:!1}},e);var t=e.attach;if(!t){if(!this.core.cloudStorage||!this.core.cloudStorage.uploadFile)throw new Error('Service "cloudStorage" does not exist');try{t=yield this.core.cloudStorage.uploadFile(e)}catch(e){throw this.logger.error("sendFile:: upload File error or abort.",e),e}}return this.sendMsg(Object.assign(Object.assign({},e),{attach:JSON.stringify(t),type:e.type}))}))}recallMsg(e){return __awaiter(this,void 0,void 0,(function*(){validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},scene:{type:"enum",values:getEnumKeys(ni)},time:{type:"number"}}},pushInfo:{type:"object",required:!1,rules:Cs},ps:{type:"string",allowEmpty:!1,required:!1}},e);var t=e.msg,r=processPushInfoInMsg({time:t.time,type:{p2p:7,team:8,superTeam:12}[t.scene],to:t.to,from:t.from,ps:e.ps,attach:e.attach,deletedIdClient:t.idClient,deletedIdServer:t.idServer,opeAccount:t.from,env:e.env,pushInfo:e.pushInfo});yield this.core.sendCmd({p2p:"recallMsg",team:"recallMsg",superTeam:"recallSuperTeamMsg"}[t.scene],{recallMsgTag:r});var i=formatDeletedMsgs([Object.assign({},t,{deletedMsgCreateTime:t.time})]);return this.core.eventBus.emit("session/updateForDeletedMsg",i),this.core.eventBus.emit("forwardSend/msg/recallMsg",r),t}))}deleteSelfMsgs(e){return __awaiter(this,void 0,void 0,(function*(){validate({msgs:{type:"array",rules:{scene:{type:"enum",values:["p2p","team"]},from:{type:"string",allowEmpty:!1},to:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},time:{type:"number",allowEmpty:!1}}},ext:{type:"string",allowEmpty:!1,required:!1}},e);var t=e.msgs.map((t=>({scene:"p2p"===t.scene?1:2,from:t.from,to:t.to,idServer:t.idServer,idClient:t.idClient,deletedMsgCreateTime:t.time,ext:e.ext}))),r=yield this.core.sendCmd("deleteSelfMsgs",{deletedMsgs:t}),i=formatDeletedMsgs(t.map((e=>{var t;return Object.assign({},e,{time:null===(t=null==r?void 0:r.content)||void 0===t?void 0:t.timetag})})));return this.core.eventBus.emit("session/updateForDeletedMsg",i),this.core.eventBus.emit("forwardSend/msg/deleteSelfMsgs",t.map((e=>{var t;return Object.assign(Object.assign({},e),{time:null===(t=null==r?void 0:r.content)||void 0===t?void 0:t.timetag})}))),i}))}sendMsgReceipt(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1},target:{type:"string",allowEmpty:!1},time:{type:"number"}}}},e);var i=e.msg;if("p2p"===i.scene&&"in"===i.flow){var n={to:i.target,idClient:i.idClient,time:i.time},a=yield this.core.sendCmd("sendMsgReceipt",{msgReceiptTag:n}),s=parseInt(null===(r=null===(t=a.content)||void 0===t?void 0:t.msgReceiptTag)||void 0===r?void 0:r.time);return Object.assign(Object.assign({},n),{time:s?Math.min(s,n.time):n.time})}this.logger.warn(`Msg scene: ${i.scene}, flow: ${i.flow} is not allowed to send msg receipt`)}))}sendTeamMsgReceipt(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamMsgReceipts:{type:"array",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}},max:50}},e);var t=e.teamMsgReceipts;this.core.sendCmd("sendTeamMsgReceipt",{teamMsgReceipts:t})}))}getTeamMsgReads(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamMsgReceipts:{type:"array",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}}}},e);var r=e.teamMsgReceipts,i=yield this.core.sendCmd("getTeamMsgReads",{teamMsgReceipts:r}),n=null===(t=i.content)||void 0===t?void 0:t.teamMsgReceipts;return n=n?n.map((e=>Object.assign(Object.assign({},e),{read:parseInt(e.read),unread:parseInt(e.unread)}))):[]}))}getTeamMsgReadAccounts(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamMsgReceipt:{type:"object",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}}}},e);var t=e.teamMsgReceipt;return(yield this.core.sendCmd("getTeamMsgReadAccounts",{teamMsgReceiptTag:t})).content}))}markMsgsAck(e){if(e&&e.length>0){var t=[],r=[];e.forEach((e=>{"p2p"===e.scene&&"in"===e.flow?t.push(e):"team"===e.scene&&"in"===e.flow&&r.push(e)})),t.length>0&&this.core.sendCmd("batchMarkRead",{sid:7,cid:2,ids:t.map((e=>e.idServer))}),r.length>0&&this.core.sendCmd("batchMarkRead",{sid:8,cid:3,ids:r.map((e=>e.idServer))})}}onMsgHandler(e){var t;if(e.error)this.logger.error("msgHandler::recvError",e.error);else{var r="number"==typeof Ne(e,"raw.r[0]")?`${e.raw.r[0]}`:void 0,i=e.content.msg;i.idServer=i.idServer||r;var n=getSessionId(i,this.core.account),a=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:n}),s=formatMsg$1(i,a?{account:this.core.account,sessionAck:a.ack,msgReceiptTime:a.msgReceiptTime}:{account:this.core.account});"debug"===this.core.options.debugLevel?this.logger.debug("msgHandler::recvMsg",s.idClient,s.idServer,s):this.logger.log("msgHandler::recvMsg",s.idClient,s.idServer),this.markMsgsAck([s]),this.core.eventBus.emit("session/updateForNewMsg",s),"superTeam"===s.scene?this.core.eventBus.emit("sync/updateTimetag",{superTeamRoamingMsgs:s.time}):this.core.eventBus.emit("sync/updateTimetag",{roamingMsgs:s.time}),this.core.emit("msg",s),"notification"===s.type?this.core.eventBus.emit("team/onNotification",s):"out"!==s.flow&&this.doMsgReceiveReport(s,e),"notification"!==s.type&&this.core.user.checkUserUpdate(s)}}doMsgReceiveReport(e,t){if(e.from!==this.core.account){var r="p2p"===e.scene,i=Ne(e,"__clientExt.statistics.apiCallingTime")||0,n=Ne(e,"__clientExt.statistics.sendTime")||0,a=Ne(e,"__clientExt.statistics.attachUploadDuration")||0,s=this.core.timeOrigin.getNTPTime(),o=e.time,c=this.core.timeOrigin.checkNodeReliable(t.__receiveTimeNode)?this.core.timeOrigin.getNTPTime(t.__receiveTimeNode):s;this.core.reporter.report("msgReceive",{msgId:e.idServer,clientId:e.idClient,serverTime:o,receiveTime:c,fromAccid:r?e.from:"",toAccid:e.to,type:ni[e.scene],tid:r?"":e.to,apiCallingTime:i,sendTime:n,attachUploadDuration:a,callbackTime:s,preHandleTime:s,result:200,failReason:"",rt:s-o})}}nimOnTeamMsgsHandler(e){e.content.datas.forEach((t=>{this.onMsgHandler(Object.assign({},e,{content:{msg:t}}))}))}syncRoamingMsgsHandler(e){var t,r,i=e.content.msgs||[];if(0!==i.length){var n=getSessionId(i[0],this.core.account),a=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:n}),s=(i=formatMsgs$1(i,a?{account:this.core.account,featureValue:oi.roam,sessionAck:a.ack,msgReceiptTime:a.msgReceiptTime}:{account:this.core.account,featureValue:oi.roam}))[0].time,o={timetag:s,sessionId:n,msgs:fs(i)};(null===(r=this.core.sync)||void 0===r?void 0:r.getSyncDoneFlag())||this.core.eventBus.emit("session/syncMsgs",o),this.core.emit("syncRoamingMsgs",o),"superTeam"===i[0].scene?this.core.eventBus.emit("sync/updateTimetag",{superTeamRoamingMsgs:s}):this.core.eventBus.emit("sync/updateTimetag",{roamingMsgs:s})}}syncOfflineMsgsHandler(e){var t=e.content.msgs||[];if(0!==t.length){var r={},i=[];t.forEach((e=>{var t=getSessionId(e,this.core.account),n=this.core.session.getSessionWithUncomplete({id:t}),a=formatMsg$1(e,n?{account:this.core.account,featureValue:oi.leave,sessionAck:n.ack,msgReceiptTime:n.msgReceiptTime}:{account:this.core.account,featureValue:oi.leave});i.push(a),r[a.sessionId]?r[a.sessionId].push(a):r[a.sessionId]=[a]})),this.markMsgsAck(i);var n=0;Object.keys(r).forEach((e=>{var t=r[e].sort(((e,t)=>t.time-e.time));(t=removeDupMsgsByIdClient(t))[0].time>n&&(n=t[0].time);var i={timetag:t[0].time,sessionId:e,msgs:t};this.core.eventBus.emit("session/syncMsgs",i),this.core.emit("syncOfflineMsgs",i)})),this.core.eventBus.emit("sync/updateTimetag",{offlineMsgs:n})}}syncDeleteSelfMsgsHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.deletedMsgs;r&&r.length>0||this.logger.warn("syncDeleteSelfMsgs:: no msgs");var i=r[r.length-1].time;this.core.eventBus.emit("sync/updateTimetag",{deleteSelfMsgs:i})}onDeleteSelfMsgHandler(e){var t=formatDeletedMsgs([e.content.deletedMsg]);this.core.eventBus.emit("session/updateForDeletedMsg",t),this.core.emit("deleteSelfMsgs",t)}onDeleteSelfMsgsHandler(e){var t=formatDeletedMsgs(e.content.deletedMsgs);this.core.eventBus.emit("session/updateForDeletedMsg",t),this.core.emit("deleteSelfMsgs",t)}onBroadcastMsgHandler(e){var t=e.content.msg,r=this.service.processBroadcastMsg([t]);this.core.emit("broadcastMsgs",r)}syncBroadcastMsgHandler(e){var t=e.content.msgs,r=this.service.processBroadcastMsg(t);this.core.emit("broadcastMsgs",r)}},"msg"),NIM.registerService(class MiscService extends Service$1{constructor(e){super("misc",e),this.core=e,registerParser({cmdMap:ws,cmdConfig:Ds}),this.setListener()}setListener(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.core.timeOrigin.setOriginTimetick()})),this.core.eventBus.on("logined",(()=>{this.core.timeOrigin.setOriginTimetick()}))}getServerTime(){return __awaiter(this,void 0,void 0,(function*(){var e=yield this.core.clientSocket.sendCmd("getServerTime");return parseInt(e.content.time)}))}notifyDetectHandler(e){return __awaiter(this,void 0,void 0,(function*(){var t=function formatNotifyDetectTag(e){return format(Us,e)}(e.content.data);t.t3=e.__receiveTimeNode.time,t.t4=Date.now();try{yield this.core.clientSocket.sendCmd("uploadDetect",{data:t})}catch(e){this.core.logger.warn("misc::notifyDetectHandler:upload failed",e)}}))}},"misc"),NIM.registerService(class UserService extends Service$1{constructor(e){super("user",e),this.userInfoMap=new Map,this.myInfo=formatUser({}),registerParser({cmdMap:ps,cmdConfig:gs})}setBlack(e){return validate({account:{type:"string",allowEmpty:!1},isAdd:{type:"boolean"}},e),this.core.sendCmd("setBlack",e).then((()=>{this.core.eventBus.emit("forwardSend/user/updateBlackList",e.account,e.isAdd)}))}setMute(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},isAdd:{type:"boolean"}},e),yield this.core.sendCmd("setMute",e).then((()=>{})),this.core.eventBus.emit("forwardSend/user/setMute",e.account,e.isAdd)}))}getRelations(){return this.core.sendCmd("syncRelations",{timetag:0})}getBlackList(){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("syncRelations",{timetag:0})).blackList||[]}))}getMuteList(){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("syncRelations",{timetag:0})).muteList||[]}))}updatePushToken(){return __awaiter(this,void 0,void 0,(function*(){this.logger.error("This function is deprecated, please use nim.offlinePush.setOfflinePushConfig instead")}))}updateAppBackground(){return __awaiter(this,void 0,void 0,(function*(){this.logger.error("This function is deprecated, please use nim.offlinePush.setOfflinePushConfig instead")}))}getUsersNameCardFromServer(e){return validate({accounts:{type:"array",max:150,itemType:"string"}},e),this.core.sendCmd("getUsersNameCardFromServer",Ys(e,["accounts"])).then((t=>{var{content:r}=t;return this.logger.log("user:: getUsers done",e.accounts),r&&r.users?r.users.map((e=>formatUser(e))):[]}))}updateMyNameCard(e){if(validate({nick:{type:"string",required:!1},avatar:{type:"string",required:!1},signature:{type:"string",required:!1},gender:{type:"enum",values:getEnumKeys($a),required:!1},email:{type:"string",required:!1},birth:{type:"string",required:!1},tel:{type:"string",required:!1},ext:{type:"string",required:!1}},e),0===Object.keys(e).length)return Promise.resolve(this.myInfo);var t=Ys(e,["nick","avatar","signature","email","birth","tel","ext"]);return e.gender&&(t.gender=$a[e.gender]),this.core.sendCmd("updateMyNameCard",{user:t}).then((r=>{var{content:i}=r;return i&&i.timetag&&this.core.eventBus.emit("sync/updateTimetag",{myInfo:+i.timetag}),e.gender&&(t.gender=e.gender),this.myInfo=Object.assign({},this.myInfo,t),this.core.eventBus.emit("forwardSend/user/updateUserInfo",t),this.myInfo}))}checkUserUpdate(e){var t=e.from;if(t!==this.core.account){var r=this.userInfoMap.get(t);if(r){var i=r.updateTime,n=e.userUpdateTime;!isNaN(i)&&!isNaN(n)&&"number"==typeof i&&"number"==typeof n&&i<n&&this.refreshUserInfo(t)}else this.refreshUserInfo(t)}}refreshUserInfo(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.getUsersNameCardFromServer({accounts:[e]});for(var r of t)this.userInfoMap.set(r.account,r),this.core.emit("updateUserInfo",r)}))}onUpdateBlackListHandler(e){var{content:t}=e;t.account?this.core.emit("updateBlackList",t):this.logger.warn("onUpdateBlackListHandler: no account")}onUpdateMuteListHandler(e){var{content:t}=e;t.account?this.core.emit("updateMuteList",t):this.logger.warn("onUpdateBlackListHandler: no account")}syncRelationsHandler(e){var{content:t}=e,{list:r,timetag:i}=t,n={blackList:[],muteList:[]};return i&&this.core.eventBus.emit("sync/updateTimetag",{relations:i}),r&&r.length&&r.forEach((e=>{var t=function formatRelationMember(e){var t={account:e.account,updateTime:+e.updateTime,createTime:+e.createTime};return"1"===e.isMuted&&(t.isMuted=!0),"1"===e.isBlack&&(t.isBlack=!0),t}(e);t.isBlack&&n.blackList.push(t),t.isMuted&&n.muteList.push(t)})),this.core.emit("relations",n),Promise.resolve(n)}syncMyNameCardHandler(e){e.content.user&&(this.myInfo=formatUser(e.content.user),this.core.emit("syncMyNameCard",this.myInfo),this.core.eventBus.emit("sync/updateTimetag",{myInfo:e.content.timetag}))}onUpdateMyNameCardHandler(e){var t=e.content.user;t?(Object.assign(this.myInfo,formatUser(t)),this.core.emit("updateMyNameCard",this.myInfo)):this.logger.warn("onUpdateMyNameCardHandler no user info")}},"user"),NIM.registerService(class SessionService extends Service$1{constructor(e,t){super("session",e),this.list=new Map,this.unreadCountFilterFn=e=>!0,this.lastMessageFilterFn=e=>!0,this.initEventListeners(),registerParser({cmdMap:so,cmdConfig:lo}),this.stickTopService=new StickTopService(e),this.unreadModule=new UnreadModuleService(e),t&&this.setOptions(t)}setOptions(e){"function"==typeof(null==e?void 0:e.unreadCountFilterFn)&&(this.unreadCountFilterFn=e.unreadCountFilterFn),"function"==typeof(null==e?void 0:e.lastMessageFilterFn)&&(this.lastMessageFilterFn=e.lastMessageFilterFn)}reset(){this.list.forEach((e=>{e.unreadMsgs=[]})),this.list.clear()}initEventListeners(){this.core.eventBus.on("session/syncMsgs",this.onSyncMsgs.bind(this)),this.core.eventBus.on("session/updateForNewMsg",this.updateSessionWithMsg.bind(this)),this.core.eventBus.on("session/updateForModifyMsg",this.updateSessionByModifyMsg.bind(this)),this.core.eventBus.on("session/updateForClearMsg",((e,t=!0)=>{e&&e.length>0&&e.forEach((e=>{this.updateSession({id:e.sessionId,lastMsg:null,unread:0,unreadMsgs:[]},t)}))})),this.core.eventBus.on("session/updateForDeletedMsg",this.updateSessionForDeletedMsg.bind(this))}createSession(e,t){try{var{scene:r,accid:i}=getAccountFromSessionId(e);return{id:e,scene:r,to:i,lastMsg:t,updateTime:t?t.time:0,unread:0,unreadMsgs:[],ack:0}}catch(t){throw this.logger.error(`Failed to create session with ${e}`,t),new Error(`Failed to create session with ${e}`)}}getSession(e){validate({id:{type:"string",allowEmpty:!1}},e);var t=this.list.get(e.id);if(this.isSessionComplete(t))return t}getSessionWithUncomplete(e){return this.list.get(e.id)}getAllSessions(){var e=[];for(var[t,r]of this.list)this.isSessionComplete(r)&&e.push(r);return e}getSessions(e){validate({limit:{type:"number",required:!1},lastSessionId:{type:"string",allowEmpty:!1,required:!1},desc:{type:"boolean",required:!1}},e);var t=[],{limit:r=100,desc:i=!0}=e,{lastSessionId:n}=e,a=0;if(i){for(var[s,o]of this.list){if(n===s)break;this.isSessionComplete(o)&&t.push(o)}return t.slice(-r).reverse()}for(var[c,d]of this.list)if(n)c===n&&(n=void 0);else if(this.isSessionComplete(d)){if(++a>r)break;t.push(d)}return t}resetSessionUnreadCount(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1}},e),validate({id:{type:"string",allowEmpty:!1}},e);var r=e.id,i=this.list.get(r);if(!i)throw this.logger.warn("resetSessionUnreadCount: can not find session "+r),new Error("Session::canSessionResetUnreadCount: can not find session "+r);var n=!1;try{n=this.unreadModule.canSessionResetUnreadCount(i)}catch(e){this.logger.warn(e)}if(!1!==n){var{accid:a,scene:s}=getAccountFromSessionId(r),o={to:a,timetag:(null===(t=null==i?void 0:i.lastMsg)||void 0===t?void 0:t.time)||i.updateTime||0},c="markSuperTeamSessionAck";return"superTeam"!==s&&(o.scene="p2p"===s?0:1,c="markSessionAck"),this.core.sendCmd(c,o).then((()=>{var e=this.storeUnreadByAck(r,o.timetag);e&&this.core.emit("updateSession",e)}))}}))}resetMultiSessionUnreadCount(e){return __awaiter(this,void 0,void 0,(function*(){validate({ids:{type:"array",itemType:"string",min:1}},e);var t=e.ids.map((e=>this.list.get(e))).filter(((t,r)=>!!t||(this.logger.warn("Session::canSessionResetUnreadCount: can not find session "+e.ids[r]),!1))),{superTeam:r,p2pOrTeam:i}=this.unreadModule.filterSessionForResetUnreadCount(t),n=ho(r.params,50),a=ho(i.params,50);for(var s of n)yield this.core.sendCmd(r.cmd,{datas:s}),s.forEach((e=>{var t=this.storeUnreadByAck(e.sessionId,e.timetag);t&&this.core.emit("updateSession",t)}));for(var o of a)yield this.core.sendCmd(i.cmd,{datas:o}),o.forEach((e=>{var t=this.storeUnreadByAck(e.sessionId,e.timetag);t&&this.core.emit("updateSession",t)}))}))}resetAllSessionsUnreadCount(){var e=[];return this.list.forEach((t=>{e.push(t.id)})),this.resetMultiSessionUnreadCount({ids:e})}deleteSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1},isSyncToServer:{type:"boolean",required:!1}},e),this.list.delete(e.id),this.core.msgLog&&e.isSyncToServer&&(yield this.core.msgLog.deleteRoamingMsgs({ids:[e.id]}))}))}deleteAllSessionsFromLocal(){this.list.clear()}addStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.stickTopService.addStickTopSession(e);return this.list.set(t.id,t),t}))}deleteStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.stickTopService.deleteStickTopSession(e);return this.list.set(t.id,t),t}))}updateStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.stickTopService.updateStickTopSession(e);return this.list.set(t.id,t),t}))}nimMultiSyncAddStickTopSessionHandler(e){var t=this.stickTopService.stickTopSessionHandler(e.content.data);this.list.set(t.id,t),this.core.emit("updateSession",t)}nimMultiSyncDeleteStickTopSessionHandler(e){var t=this.stickTopService.stickTopSessionHandler({id:e.content.data.id,updateTime:e.content.timetag,ext:""},!1);this.list.set(t.id,t),this.core.emit("updateSession",t)}nimMultiSyncUpdateStickTopSessionHandler(e){var t=this.stickTopService.stickTopSessionHandler(e.content.data);this.list.set(t.id,t),this.core.emit("updateSession",t)}nimSyncStickTopSessionsHandler(e){if(this.core.eventBus.emit("sync/updateTimetag",{stickTopSessions:e.content.timetag}),e.content.isThereAnyChange){var t=e.content.datas,r=[];this.list.forEach((e=>{var t;e&&(null===(t=null==e?void 0:e.stickTopInfo)||void 0===t?void 0:t.isStickOnTop)&&r.push(e)})),r.forEach((e=>{var r=e.id,i=t.find((e=>{var{scene:t,accid:i}=getAccountFromSessionId(e.id,"|");return`${t}-${i}`===r}));if(!i){var n={},{scene:a,accid:s}=getAccountFromSessionId(r,"-");n.id=`${a}|${s}`,n.ext="",n.isTop=!1,t.push(n)}})),t.forEach((e=>{var t;!1===e.isTop?(delete e.isTop,t=this.stickTopService.stickTopSessionHandler(e,!1)):t=this.stickTopService.stickTopSessionHandler(e),this.list.set(t.id,t)}))}}updateSessionWithMsg(e){var t,r,i=!0,n=!0,a="boolean"!=typeof(null===(t=e.pushInfo)||void 0===t?void 0:t.needPushBadge)||(null===(r=e.pushInfo)||void 0===r?void 0:r.needPushBadge);try{i=!!this.unreadCountFilterFn(e)}catch(e){this.logger.error("session:updateSessionWithMsg, unreadCountFilterFn error",e)}try{n=!!this.lastMessageFilterFn(e)}catch(e){this.logger.error("session:updateSessionWithMsg, lastMessageFilterFn error",e)}var s=this.list.get(e.sessionId)||this.createSession(e.sessionId),o=!1;if(this.logger.log("session:updateSessionWithMsg, pending ",e.sessionId,e.idClient,e.idServer,n,i),n&&(!s.lastMsg||s.lastMsg.time<e.time||e.status===si[si.sending]||s.lastMsg.status===si[si.sending])&&(s.lastMsg=e,s.updateTime=e.time,o=!0),i&&a&&e.status===si[si.unread]&&e.time>(s.ack||0)){s.unread++;var c=s.unreadMsgs||[];c.unshift(e),c.sort(((e,t)=>t.time-e.time)),s.unreadMsgs=c,o=!0}o&&(this.logger.log("session:updateSessionWithMsg updating ",s.id,s.unread,s.lastMsg&&s.lastMsg.idClient),this.list.set(s.id,s),this.core.emit("updateSession",s))}updateSessionByModifyMsg(e){var t=this.list.get(e.sessionId)||this.createSession(e.sessionId),r=t.unreadMsgs||[],i=r.findIndex((t=>t.idClient===e.idClient));i>-1&&(r[i]=e),t.unreadMsgs=r,this.list.set(t.id,t);var n=!0;try{n=!!this.lastMessageFilterFn(e)}catch(e){this.logger.error("session:updateSessionByModifyMsg, lastMessageFilterFn error",e)}n&&(t.lastMsg&&t.lastMsg.idClient!==e.idClient||(t.lastMsg=e,t.updateTime=e.time,this.logger.log("session:updateSessionByModifyMsg updating ",t.id,t.unread,t.lastMsg&&t.lastMsg.idClient),this.list.set(t.id,t),this.core.emit("updateSession",t)))}storeUnreadByAck(e,t){var r=this.list.get(e)||this.createSession(e);if(!(r.ack&&t<r.ack)){var i=r.unreadMsgs||[],n=[],a=[],s=0;return r.unreadMsgs=[],i.length>0&&(i.forEach((e=>{a.includes(e.idClient)||e.time>t&&(s++,a.push(e.idClient),n.push(e))})),r.unreadMsgs=n.sort(((e,t)=>t.time-e.time))),r.ack=t,r.unread=s,r.lastMsg&&"unread"===r.lastMsg.status&&t>=r.lastMsg.time&&(r.lastMsg.status="read"),this.list.set(e,r),r}this.logger.warn("storeUnreadByAck: not need update ack",e,t,r.ack)}updateSession(e,t=!0){var r=e.id,i=this.list.get(r)||this.createSession(e.id),n=Object.assign(i,e);return this.list.set(r,n),this.logger.log("updateSession: update",t,Ys(e,["id","ack","unread"]),n.lastMsg&&n.lastMsg.idClient),t&&this.core.emit("updateSession",n),n}isSessionComplete(e){return!!e&&(!!(e.id&&e.scene&&e.to)&&void 0!==e.lastMsg)}syncSessionAckHandler(e){var t=e.content.p2p||{},r=e.content.team.m_map||{};this.logger.log("syncSessionAck::",t,r),Object.keys(t).forEach((e=>{this.updateSession({id:"p2p-"+e,ack:t[e]},!1)})),Object.keys(r).forEach((e=>{this.updateSession({id:"team-"+e,ack:r[e]},!1)}))}syncSuperTeamSessionAckHandler(e){var t=e.content.superTeam.m_map;this.logger.log("syncSuperTeamSessionAck::",t),Object.keys(t).forEach((e=>{this.updateSession({id:"superTeam-"+e,ack:t[e]},!1)}))}syncMarkSessionAckHandler(e){var t=e.content,r=`${0===t.scene?"p2p":1===t.scene?"team":"superTeam"}-${t.to}`,i=this.list.get(r);if(i&&i.ack&&t.timetag<i.ack)this.logger.warn(`syncMarkSessionAckHandler: ${r} do not need update ack`,i.ack,t.timetag);else{var n=this.storeUnreadByAck(r,t.timetag);n&&this.core.emit("updateSession",n)}}syncMarkSuperTeamSessionAckHandler(e){e.content.scene=5,this.syncMarkSessionAckHandler(e)}onSyncDone(){var e=[];this.list.forEach(((t,r)=>{e.push(this.storeUnreadByAck(r,t.ack||0))})),this.list.clear(),e.sort(((e,t)=>e.updateTime-t.updateTime)).forEach((e=>{this.list.set(e.id,e)})),(e=e.filter((e=>this.isSessionComplete(e))).sort(((e,t)=>t.updateTime-e.updateTime))).length>0&&this.core.emit("sessions",e)}onSyncMsgs(e){var t=this.list.get(e.sessionId),r=[];try{r=e.msgs.filter((e=>{var t,r,i="boolean"!=typeof(null===(t=e.pushInfo)||void 0===t?void 0:t.needPushBadge)||(null===(r=e.pushInfo)||void 0===r?void 0:r.needPushBadge);return this.unreadCountFilterFn(JSON.parse(JSON.stringify(e)))&&i}))}catch(e){this.logger.error("session:onSyncMsgs, unreadCountFilterFn error ",e)}var i,n=[];try{n=e.msgs.filter((e=>this.lastMessageFilterFn(JSON.parse(JSON.stringify(e)))))}catch(e){this.logger.error("session:onSyncMsgs, lastMessageFilterFn error ",e)}n&&n.length>0&&(i=n[n.length-1],i=n[0].time>i.time?n[0]:i);var a=i?i.time:0;t||(t=i?this.createSession(e.sessionId,i):this.createSession(e.sessionId)),t.unreadMsgs=t.unreadMsgs?r.concat(t.unreadMsgs).filter((e=>e.status===si[si.unread])):r.filter((e=>e.status===si[si.unread])),t.updateTime&&t.updateTime>=a||(t.updateTime=a),t.lastMsg&&t.lastMsg.time>=a||(t.lastMsg=i),this.list.set(t.id,t)}updateSessionForDeletedMsg(e){var t={};e.forEach((e=>{var r=e.to===this.core.account?e.from:e.to,i=`${e.scene}-${r}`,n=this.list.get(i);if(n){var a=n.unreadMsgs.some((t=>t.idClient===e.idClient)),s=!0;try{s=!!this.unreadCountFilterFn(e)}catch(e){this.logger.error("session:updateSessionForDeletedMsg, unreadCountFilterFn error",e)}var o=n.ack||0;if(s&&a&&o<e.time&&e.from!==this.core.account&&n.unread>0&&(n.unread=n.unread-1,n.unreadMsgs&&n.unreadMsgs.length>0)){var c=ao(n.unreadMsgs,{idClient:e.idClient});c>=0&&n.unreadMsgs.splice(c,1)}n.lastMsg&&n.lastMsg.idClient===e.idClient&&(n.lastMsg=null),t[n.id]=!0}})),Object.keys(t).forEach((e=>{var t=this.list.get(e);t&&this.core.emit("updateSession",t)}))}multiSyncMsgReceiptHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.msgReceiptTag;if(r){this.updateSessionMsgReceiptTime([r],!0),r.msgReceiptTime=r.time,r.sessionId=`p2p-${r.from}`;var i=__rest(r,["time","from"]);this.core.emit("msgReceipts",[i])}}syncMsgReceiptsHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.msgReceipts;r&&this.updateSessionMsgReceiptTime(r,!1)}updateSessionMsgReceiptTime(e,t=!0){e&&e.length>0&&e.forEach((e=>{var r=this.list.get(`p2p-${e.from}`);r||(r=this.createSession(`p2p-${e.from}`));var i=parseInt(e.time);r.msgReceiptTime&&r.msgReceiptTime>=i||(r.msgReceiptTime=i,r.lastMsg&&"sent"===r.lastMsg.status&&i>=r.lastMsg.time&&(r.lastMsg.status="receipt"),this.logger.log(`session: update session ${r.id} msgReceiptTime: ${r.msgReceiptTime}`),this.list.set(r.id,r),t&&this.core.emit("updateSession",r))}))}},"session"),NIM.registerService(class TeamService extends Service$1{constructor(e){super("team",e),this.myTeamMembersMap=new Map,this.service=new ModuleService$1(e),this.setListeners(),registerParser({cmdMap:cs,cmdConfig:ms})}setListeners(){this.core.eventBus.on("forwardReceive/team/updateMyMemberInfo",(e=>{this.emitMemberUpdate(e)})),this.core.eventBus.on("team/onNotification",(e=>this.notificationHandler(e)))}reset(){this.myTeamMembersMap.clear()}mergeMyTeamMembers(e){e.forEach((e=>{var t=e.teamId,r=this.myTeamMembersMap.get(t),i=Object.assign({},r,e);this.myTeamMembersMap.set(t,i)}))}getTeamInfo(e){return __awaiter(this,void 0,void 0,(function*(){return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),formatTeam((yield this.core.sendCmd("getTeamInfo",{teamId:e.teamId})).content.team)}))}getTeams(){return __awaiter(this,void 0,void 0,(function*(){return formatTeams((yield this.core.sendCmd("getTeams",{timetag:0})).content.teams)}))}getTeamsById(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamIds:{type:"array",itemType:"string"}},e);var t=yield this.core.sendCmd("getTeamsById",{teamIds:e.teamIds});return{teams:formatTeams(t.content.teams),tids:t.content.tids}}))}createTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"enum",values:["advanced","normal"]},name:{type:"string",allowEmpty:!1},level:{type:"number",required:!1},accounts:{type:"array",itemType:"string",required:!1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!0,required:!1},announcement:{type:"string",allowEmpty:!0,required:!1},avatar:{type:"string",allowEmpty:!0,required:!1},ext:{type:"string",allowEmpty:!0,required:!1}},e);var t=generateTeam(e),r=formatTeam((yield this.core.sendCmd("createTeam",{team:t,accounts:e.accounts||[],ps:e.ps||""})).content.team);return this.core.eventBus.emit("forwardSend/team/created",r),r}))}dismissTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),yield this.core.sendCmd("dismissTeam",{teamId:e.teamId})}))}leaveTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),yield this.core.sendCmd("leaveTeam",{teamId:e.teamId})}))}transferTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},leave:{type:"boolean"}},e),yield this.core.sendCmd("transferTeam",e)}))}updateTeamInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!0,required:!1},announcement:{type:"string",allowEmpty:!0,required:!1},avatar:{type:"string",allowEmpty:!0,required:!1},ext:{type:"string",allowEmpty:!0,required:!1}},e);var t=generateTeam(e);return yield this.core.sendCmd("updateTeamInfo",{team:t}),formatTeam(t)}))}getTeamMembers(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",required:!1}},e);var r=yield this.core.sendCmd("getTeamMembers",{teamId:e.teamId,timetag:0}),i=formatTeamMembers(null===(t=r.content)||void 0===t?void 0:t.teamMembers);return e.accounts&&e.accounts.length>0?i.filter((t=>{var r;return null===(r=e.accounts)||void 0===r?void 0:r.includes(t.account)})):i}))}getMutedTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),formatTeamMembers((yield this.core.sendCmd("getMutedTeamMembers",{teamId:e.teamId})).content.teamMembers)}))}addTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),yield this.core.sendCmd("addTeamMembers",{teamId:e.teamId,accounts:e.accounts,ps:e.ps||"",attach:e.ext||""})}))}removeTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1}},e),yield this.core.sendCmd("removeTeamMembers",{teamId:e.teamId,accounts:e.accounts})}))}applyTeam(e){return __awaiter(this,void 0,void 0,(function*(){return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),formatTeam((yield this.core.sendCmd("applyTeam",{teamId:e.teamId,ps:e.ps||""})).content.team)}))}addTeamManagers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),yield this.core.sendCmd("addTeamManagers",e)}))}removeTeamManagers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),yield this.core.sendCmd("removeTeamManagers",e)}))}updateMyMemberInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!0,required:!1},bitConfigMask:{type:"number",min:0,max:2,required:!1},ext:{type:"string",required:!1}},e);var t=generatorTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,bitConfigMask:e.bitConfigMask,ext:e.ext});yield this.core.sendCmd("updateMyMemberInfo",{teamMember:t});var r=formatTeamMember(Object.assign({updateTime:(new Date).getTime(),account:this.core.account},t)),i=this.emitMemberUpdate(r);return this.core.eventBus.emit("forwardSend/team/updateMyMemberInfo",i),r}))}emitMemberUpdate(e){e=formatTeamMember(e),this.mergeMyTeamMembers([e]),this.core.emit("updateTeamMember",e);var t=Go(this.myTeamMembersMap.get(e.teamId));return this.core.emit("myTeamMembers",[t]),t}updateMemberNick(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!0}},e);var t=generatorTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,account:e.account});return yield this.core.sendCmd("updateNickInTeam",{teamMember:t}),formatTeamMember(Object.assign({updateTime:(new Date).getTime()},t))}))}muteTeamMember(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},mute:{type:"boolean"}},e),yield this.core.sendCmd("muteTeamMember",{teamId:e.teamId,account:e.account,mute:e.mute?1:0})}))}getTeamMemberInvitorAccid(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",max:200}},e);var r={teamId:e.teamId};e.accounts&&e.accounts.length>0&&(r.accounts=e.accounts);var i=yield this.core.sendCmd("getTeamMemberInvitorAccid",r);return(null===(t=i.content)||void 0===t?void 0:t.accountsMap)||{}}))}muteTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},mute:{type:"boolean"}},e),yield this.core.sendCmd("muteTeam",{teamId:e.teamId,mute:e.mute?1:0})}))}passTeamApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e);try{yield this.core.sendCmd("passTeamApply",e),this.core.eventBus.emit("forwardSend/team/passTeamApply",e)}catch(r){var t=r;throw this.core.eventBus.emit("forwardSend/team/passTeamApply",e,null==t?void 0:t.code),r}}))}rejectTeamApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e);try{yield this.core.sendCmd("rejectTeamApply",{teamId:e.teamId,from:e.from,ps:e.ps||""}),this.core.eventBus.emit("forwardSend/team/rejectTeamApply",e)}catch(r){var t=r;throw this.core.eventBus.emit("forwardSend/team/rejectTeamApply",e,null==t?void 0:t.code),r}}))}acceptTeamInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e);try{yield this.core.sendCmd("acceptTeamInvite",e),this.core.eventBus.emit("forwardSend/team/acceptTeamInvite",e)}catch(r){var t=r;throw this.core.eventBus.emit("forwardSend/team/acceptTeamInvite",e,null==t?void 0:t.code),r}}))}rejectTeamInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e);try{yield this.core.sendCmd("rejectTeamInvite",{teamId:e.teamId,from:e.from,ps:e.ps||""}),this.core.eventBus.emit("forwardSend/team/rejectTeamInvite",e)}catch(r){var t=r;throw this.core.eventBus.emit("forwardSend/team/rejectTeamInvite",e,null==t?void 0:t.code),r}}))}notifyTeamMsgReceiptsHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.teamMsgReceipts;r&&r.length>0&&(this.core.emit("teamMsgReceipts",r),this.core.emit("msgReceipts",r))}syncTeamsHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{teams:parseInt(t.timetag)});var r=null==t?void 0:t.teams;if(r&&r.length){var i=formatTeams(r);this.core.emit("teams",i)}}syncCreateTeamHandler(e){var t=e.content,r=formatTeam(null==t?void 0:t.team),i=generatorMemberByTeam(r,r.owner,"owner");this.core.emit("createTeam",r,i)}syncUpdateTeamMemberHandler(e){var t=e.content,r=formatTeamMember(null==t?void 0:t.teamMember);r.updateTime||(r.updateTime=(new Date).getTime()),this.mergeMyTeamMembers([r]),this.core.emit("updateTeamMember",r);var i=Go(this.myTeamMembersMap.get(r.teamId));this.core.emit("myTeamMembers",[i])}syncMyTeamMembersHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{myTeamMembers:parseInt(t.timetag)});var r=null==t?void 0:t.teamMembers.map((e=>formatTeamMember(e)));this.mergeMyTeamMembers(r),this.core.emit("myTeamMembers",Go(r))}notificationHandler(e){var{attach:t,scene:r,from:i,to:n,time:a,idServer:s,idClient:o}=e,{team:c,account:d,accounts:l,type:m}=t;if("team"===r)switch("debug"===this.core.options.debugLevel?this.logger.debug("team::recvNotification",s,o,t):this.logger.log("team::recvNotification",s,o,n,m,d,l),m){case"updateTeam":c.updateTime=a,this.core.emit("updateTeam",c);break;case"addTeamMembers":this.service.notifyAddTeamMembers(c,l);break;case"acceptTeamInvite":this.service.notifyAddTeamMembers(c,[i]);break;case"passTeamApply":this.service.notifyAddTeamMembers(c,[d]);break;case"addTeamManagers":this.service.notifyUpdateTeamManagers(n,l,!0,a);break;case"removeTeamManagers":this.service.notifyUpdateTeamManagers(n,l,!1,a);break;case"removeTeamMembers":this.service.notifyRemoveTeamMembers(c,l);break;case"leaveTeam":this.service.notifyRemoveTeamMembers(c,[i]);break;case"dismissTeam":this.core.emit("dismissTeam",{teamId:n});break;case"transferTeam":this.service.notifyTransferTeam(c,i,d);break;case"updateTeamMemberMute":this.service.notifyUpdateTeamMembersMute(c,[d],t.mute)}}},"team"),NIM.registerService(class SystemMessageService extends Service$1{constructor(e){super("systemMessage",e),this.sysMsgUnread={total:0,friend:0,msg:0,team:0,superTeam:0},this.core.eventBus.on("logined",(()=>{this.initEventListeners()})),registerParser({cmdMap:jo,cmdConfig:$o})}initEventListeners(){this.core.eventBus.on("systemMessage/passFriendApply",(e=>{this.core.emit("updateSystemMessages",[{idServer:e.idServer,from:e.account,state:"pass",type:"friendRequest"}])})),this.core.eventBus.on("systemMessage/rejectFriendApply",(e=>{this.core.emit("updateSystemMessages",[{idServer:e.idServer,from:e.account,state:"decline",type:"friendRequest"}])}))}doMarkSysMsgAck(e){var t=[],r=[],i=["customSuperTeam"];e.forEach((e=>{e.idServer&&(i.includes(e.type)?r.push(e.idServer):t.push(e.idServer))})),t.length>0&&this.core.sendCmd("batchMarkRead",{sid:"7",cid:"3",ids:t}),r.length>0&&this.core.sendCmd("batchMarkRead",{sid:"21",cid:"19",ids:r})}sendCustomSysMsg(e){validate({to:{type:"string",allowEmpty:!1},type:{type:"enum",values:["customP2p","customTeam","customSuperTeam"]},attach:{type:"string",allowEmpty:!1},setting:{type:"object",rules:{needSaveOffline:{type:"boolean",required:!1},env:{type:"string",allowEmpty:!1,required:!1}},required:!1},pushInfo:{type:"object",required:!1,rules:Cs}},e);var t="customSuperTeam"===e.type?"sendSuperTeamCustomSysMsg":"sendCustomSysMsg";return this.core.sendCmd(t,{sysMsg:generatorSysMsgForCmd$1(e)}).then((()=>{this.logger.log("sendCustomSysMsg success")})).catch((e=>{throw this.logger.error("sendCustomSysMsg failed",e.message),e}))}onSysMsgHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.sysMsg;if(r){var i="number"==typeof Ne(e,"raw.r[0]")?`${e.raw.r[0]}`:void 0;r.idServer=r.idServer||i;var n=formatSystemMessage(r,this.logger,Es.default);this.core.emit("sysMsg",n),this.doMarkSysMsgAck([n])}else this.logger.warn("onSysMsg no content.sysMsg")}syncOfflineSysMsgsHandler(e){if(e.content.sysMsgs&&e.content.sysMsgs.length>0){var t=e.content.sysMsgs.map((e=>formatSystemMessage(e,this.logger,Es.leave)));this.core.emit("syncSysMsgs",t),this.doMarkSysMsgAck(t)}}onRecallMsgHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.sysMsg;if(r){var i="number"==typeof Ne(e,"raw.r[0]")?`${e.raw.r[0]}`:void 0;r.idServer=r.idServer||i;var n=formatDeletedMsgs([r],getSceneFromRecallSysMsg(+r.type));this.core.eventBus.emit("session/updateForDeletedMsg",n);var a=formatSystemMessage(r,this.logger,Es.default);this.core.emit("sysMsg",a),this.doMarkSysMsgAck([a])}else this.logger.warn("onSysMsg no content.sysMsg")}syncRecallMsgOfflineAndRoamingHandler(e){var{timetag:t,type:r,sysMsgs:i}=e.content,n=parseInt(r),a=1===n?Es.leave:Es.roam,s=i.map((e=>formatSystemMessage(e,this.logger,a)));1===n&&this.doMarkSysMsgAck(s),this.core.eventBus.emit("sync/updateTimetag",{recallMsg:t}),this.core.emit("syncSysMsgs",s)}},"systemMessage"),NIM.registerService(class FriendService extends Service$1{constructor(e){super("friend",e),registerParser({cmdMap:zo,cmdConfig:Qo})}getFriends(){var e;return __awaiter(this,void 0,void 0,(function*(){var t=yield this.core.sendCmd("getFriends",{timetag:0}),r=(null===(e=t.content)||void 0===e?void 0:e.friends)||[];return r=r.map((e=>reverseFriend(e)))}))}addFriend(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},ps:{type:"string",allowEmpty:!1,required:!1}},e),yield this.core.sendCmd("friendReuqest",{account:e.account,type:1,ps:e.ps||""});var t=(new Date).getTime();return this.core.eventBus.emit("forwardSend/friend/addFriend",e.account),{account:e.account,createTime:t,updateTime:t,valid:!0,source:0,passRelationShip:1,relationShip:1,bitsExtension:0}}))}applyFriend(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("friendReuqest",{account:e.account,type:2,ps:e.ps||""})}))}passFriendApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1}},e);try{yield this.core.sendCmd("friendReuqest",{account:e.account,type:3,ps:e.ps||""}).then((t=>(this.core.eventBus.emit("systemMessage/passFriendApply",e),t))),this.core.eventBus.emit("forwardSend/friend/passFriendApply",e.account)}catch(t){throw this.core.eventBus.emit("forwardSend/friend/passFriendApply",e.account,t),t}}))}rejectFriendApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1}},e);try{yield this.core.sendCmd("friendReuqest",{account:e.account,type:4,ps:e.ps||""}).then((t=>(this.core.eventBus.emit("systemMessage/rejectFriendApply",e),t))),this.core.eventBus.emit("forwardSend/friend/rejectFriendApply",e.account,e.ps)}catch(t){throw this.core.eventBus.emit("forwardSend/friend/rejectFriendApply",e.account,e.ps,t),t}}))}deleteFriend(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},delAlias:{type:"boolean"}},e),yield this.core.sendCmd("deleteFriend",{account:e.account,delFriendParams:{delAlias:!0===e.delAlias?1:0}}),this.core.eventBus.emit("forwardSend/friend/deleteFriend",e.account)}))}updateFriend(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},alias:{type:"string"},ext:{type:"string",required:!1}},e),yield this.core.sendCmd("updateFriend",{updateFriendTag:e}),this.core.eventBus.emit("forwardSend/friend/updateFriend",e)}))}syncFriendRequestHandler(e){var t=function formatFriendRequest(e){var t=Object.assign({},e);try{t.ps=t.ps&&JSON.parse(t.ps)}catch(e){}if(t.type=Wo[t.type],"addFriend"===t.type||"passFriendApply"===t.type){var r=(new Date).getTime();t.friend={account:e.account,alias:"",createTime:r,ext:"",updateTime:r,valid:!0}}return t}(e.content);this.core.emit("syncFriend",t)}syncDeleteFriendHandler(e){var t=e.content.account;this.logger.log(`friend::emit syncFriendAction: deleteFriend ${t}`),this.core.emit("syncFriend",{type:"deleteFriend",account:t})}syncUpdateFriendHandler(e){var t=reverseFriend(e.content.friend);this.logger.log("friend::emit syncFriendAction: updateFriend, ",null==t?void 0:t.account),this.core.emit("syncFriend",{type:"updateFriend",friend:t})}syncFriendsHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{friends:parseInt(t.timetag)});var r=null==t?void 0:t.friends;if(r&&r.length){var i=r.map((e=>reverseFriend(e)));this.core.emit("friends",i)}}syncFriendUsersHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{friendUsers:parseInt(t.timetag)});var r=null==t?void 0:t.users;if(r&&r.length){var i=r.map((e=>formatUser(e)));this.core.emit("users",i)}}},"friend"),NIM.registerService(class EventService extends Service$1{constructor(e){super("event",e),registerParser({cmdMap:Xo,cmdConfig:tc})}publishEvent(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},value:{type:"number"},ext:{type:"string",required:!1},validTime:{type:"number",min:60,max:2592e3,required:!1},broadcastType:{type:"number",required:!1},sync:{type:"boolean",required:!1}},e);var r=Object.assign(Object.assign({validTime:e.validTime||604800,broadcastType:e.broadcastType||2},e),{idClient:Ii(),sync:!0===e.sync?1:0}),i=yield this.core.sendCmd("publishEvent",{msgEvent:r});return formatEvent((null===(t=i.content)||void 0===t?void 0:t.msgEvent)||{})}))}subscribeEvent(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100},subscribeTime:{type:"number",min:60,max:2592e3,required:!1}},e);var r=Object.assign(Object.assign({subscribeTime:2592e3},e),{sync:!0===e.sync?1:0}),i=yield this.core.sendCmd("subscribeEvent",{msgEventSubscribe:r,accounts:e.accounts});return{failedAccounts:(null===(t=i.content)||void 0===t?void 0:t.accounts)||[]}}))}unSubscribeEvents(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100,required:!1}},e);var r,i={type:e.type};if(e.accounts&&e.accounts.length>0){var n=yield this.core.sendCmd("unSubscribeEventsByAccounts",{msgEventSubscribe:i,accounts:e.accounts});r=(null===(t=n.content)||void 0===t?void 0:t.accounts)||[]}else yield this.core.sendCmd("unSubscribeEventsByType",{msgEventSubscribe:i}),r=[];return{failedAccounts:r}}))}querySubscribeEvents(e){var t;return __awaiter(this,void 0,void 0,(function*(){var r;return validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100,required:!1}},e),r=e.accounts&&e.accounts.length>0?yield this.core.sendCmd("querySubscribeEventsByAccounts",{msgEventSubscribe:{type:e.type},accounts:e.accounts}):yield this.core.sendCmd("querySubscribeEventsByType",{msgEventSubscribe:{type:e.type}}),formatSubscribes(null===(t=r.content)||void 0===t?void 0:t.msgEventSubscribes)}))}pushEventHandler(e){var t,r=(null===(t=e.content)||void 0===t?void 0:t.msgEvent)||{};this.core.emit("pushEvents",[formatEvent(r)])}pushEventsHandler(e){var t,r=(null===(t=e.content)||void 0===t?void 0:t.msgEvents)||{};this.core.emit("pushEvents",function formatEvents(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatEvent(e))):[]}(r))}},"event"),NIM.registerService(class MsgExtendService extends Service$1{constructor(e){super("msgExtend",e),registerParser({cmdMap:ic,cmdConfig:sc})}getThreadMsgs(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({scene:{type:"enum",values:getEnumKeys(ni)},threadMsgFromAccount:{type:"string",allowEmpty:!1},threadMsgIdServer:{type:"string",allowEmpty:!1},threadMsgTime:{type:"number"},threadMsgToAccount:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},lastMsgId:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,max:100,required:!1},reverse:{type:"boolean",required:!1}},e);var r=yield this.core.sendCmd("getThreadMsgs",function generateThreadMsgsParams(e){var t={scene:ni[e.scene],from:e.threadMsgFromAccount,to:e.threadMsgToAccount,time:e.threadMsgTime,idServer:e.threadMsgIdServer},r={limit:e.limit<100?e.limit:100,beginTime:"number"==typeof e.beginTime?e.beginTime:0,reverse:!0===e.reverse?1:0};return e.lastMsgId&&(r.lastMsgId=e.lastMsgId),{msg:t,threadMsgReq:r}}(e)),{msgs:i,threadMsg:n}=r.content,{threadMsgsMeta:a}=r.content,s=getSessionId(n,this.core.account),o=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:s});return{msgs:i=formatMsgs$1(i,o?{account:this.core.account,sessionAck:o.ack,msgReceiptTime:o.msgReceiptTime}:{account:this.core.account}),threadMsg:n=formatMsg$1(n,o?{account:this.core.account,sessionAck:o.ack,msgReceiptTime:o.msgReceiptTime}:{account:this.core.account}),total:parseInt(a.total),timetag:parseInt(a.lastMsgTime)}}))}getMsgsByIdServer(e){return __awaiter(this,void 0,void 0,(function*(){return validate({reqMsgs:{type:"array",rules:{scene:{type:"enum",values:getEnumKeys(ni)},from:{type:"string",allowEmpty:!1},to:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},time:{type:"number"}},min:1,max:100}},e),(yield this.core.sendCmd("getMsgsByIdServer",{reqMsgs:e.reqMsgs.map((e=>Object.assign(Object.assign({},e),{scene:getEnumKeyByEnumValue(ni,e.scene)})))})).content.msgs.map((e=>{var t,r=getSessionId(e,this.core.account),i=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:r});return formatMsg$1(e,i?{account:this.core.account,sessionAck:i.ack,msgReceiptTime:i.msgReceiptTime}:{account:this.core.account})}))}))}},"msgExtend"),NIM.registerService(class MsgLogService extends Service$1{constructor(e){super("msgLog",e),this.onV2ClearHistoryMessage=e=>{var t=formatClearResult(e);this.core.eventBus.emit("session/updateForClearMsg",[t],!0)},registerParser({cmdMap:cc,cmdConfig:mc}),this.registerListener()}registerListener(){this.core.eventBus.on("forwardReceive/msgLog/clearHistoryMsgsFromServer",this.onV2ClearHistoryMessage)}deleteRoamingMsgs(e){return __awaiter(this,void 0,void 0,(function*(){validate({ids:{type:"array",itemType:"string"}},e);var t=[];try{t=e.ids.map((e=>{var{scene:t,accid:r}=getAccountFromSessionId(e);return`${t}|${r}`}))}catch(t){throw this.logger.error(`Failed to delete roaming msgs with ${e.ids}`,t),new Error(`Failed to create session with ${e.ids}`)}yield this.core.sendCmd("deleteRoamingMsgs",{ids:t})}))}getHistoryMsgs(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){(null===(t=this.core.sync)||void 0===t?void 0:t.getSyncDoneFlag())||this.logger.warn("Please call getHistoryMsgs after syncdone event"),validate({scene:{type:"enum",values:getEnumKeys(ni)},to:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,max:100,required:!1},reverse:{type:"boolean",required:!1},lastMsgId:{type:"string",required:!1,allowEmpty:!1},asc:{type:"boolean",required:!1},msgTypes:{type:"array",itemType:"string",required:!1}},e);var i="p2p"===e.scene?"getHistoryMsgs":"team"===e.scene?"getHistoryTeamMsgs":"getHistorySuperTeamMsgs",n=yield this.core.sendCmd(i,Object.assign(Object.assign({beginTime:0,endTime:0,lastMsgId:0,limit:100,reverse:!1},e),{msgTypes:e.msgTypes?e.msgTypes.map((e=>ii[e])):[]})),{content:a}=n;if(!(a.msgs&&a.msgs.length>0))return[];var s=getSessionId(a.msgs[0],this.core.account),o=null===(r=this.core.session)||void 0===r?void 0:r.getSessionWithUncomplete({id:s}),c=formatMsgs$1(a.msgs,o?{account:this.core.account,sessionAck:o.ack,msgReceiptTime:o.msgReceiptTime}:{account:this.core.account});return!0===e.asc?c.sort(((e,t)=>e.time-t.time)):c}))}clearHistoryMsgsFromServer(e){return __awaiter(this,void 0,void 0,(function*(){validate({scene:{type:"enum",values:["p2p","team"]},to:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1},isSyncSelf:{type:"boolean",required:!1}},e);var t=Object.assign(Object.assign({isDeleteRoam:1},e),{type:"team"===e.scene?2:1,isSyncSelf:!0===e.isSyncSelf?1:0});t[2===t.type?"toTid":"otherAccid"]=e.to;var r=(yield this.core.sendCmd("clearHistoryMsgsFromServer",{clearHistoryMsgsFromServerReqTag:t})).content;return this.core.eventBus.emit("session/updateForClearMsg",[{sessionId:`${e.scene}-${e.to}`}],!0),this.core.eventBus.emit("forwardSend/msgLog/clearHistoryMsgsFromServer",Object.assign(Object.assign({},t),{time:r.timetag})),r}))}multiSyncClearServerHistoryMsgsHandler(e){var t=formatClearResult(e.content.data);this.core.eventBus.emit("session/updateForClearMsg",[t],!0),this.core.emit("clearServerHistoryMsgs",[t])}ftsCloudMsgLogs(e){return __awaiter(this,void 0,void 0,(function*(){return this.baseFtsCloudMsgLogs(e,"nimFtsCloudMsgLogs")}))}ftsCloudMsgLogsAggWithSession(e){return __awaiter(this,void 0,void 0,(function*(){return this.baseFtsCloudMsgLogs(e,"nimFtsCloudMsgLogsAggWithSession")}))}baseFtsCloudMsgLogs(e,t){return __awaiter(this,void 0,void 0,(function*(){if(validate({keyword:{type:"string",allowEmpty:!1},fromTime:{type:"number",required:!1},toTime:{type:"number",required:!1},sessionLimit:{type:"number",required:!1},msglogsLimit:{type:"number",required:!1},orderRule:{type:"enum",values:getEnumKeys(rc),required:!1},p2pSessionList:{type:"array",itemType:"string",required:!1},teamSessionList:{type:"array",itemType:"string",required:!1},senderList:{type:"array",itemType:"string",required:!1},msgTypeList:{type:"array",itemType:"enum",values:getEnumKeys(ii),required:!1},msgSubTypeList:{type:"array",itemType:"number",required:!1}},e),e.fromTime&&e.toTime&&e.toTime<e.fromTime)throw new ValidateError("Request parameter error: toTime should be greater than fromTime",e,"");var r=function generateFtsTagForCmd(e){var t=format(uc,e);return Array.isArray(t.msgTypeList)&&(t.msgTypeList=t.msgTypeList.map((e=>ii[e])).join(",")),["p2pSessionList","teamSessionList","senderList","msgSubTypeList"].forEach((e=>{Array.isArray(t[e])&&(t[e]=t[e].join(","))})),t}(e);return(yield this.core.sendCmd(t,{tag:r})).content.datas.map((e=>{var t,r=getSessionId(e,this.core.account),i=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:r});return formatMsg$1(e,i?{account:this.core.account,sessionAck:i.ack,msgReceiptTime:i.msgReceiptTime}:{account:this.core.account})}))}))}syncClearServerHistoryMsgsHandler(e){var t=function formatClearResults(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatClearResult(e))):[]}(e.content.datas);this.core.emit("clearServerHistoryMsgs",t)}},"msgLog"),NIM.registerService(class PassThroughService extends Service$1{constructor(e){super("passThrough",e),this.core=e,registerParser({cmdMap:hc,cmdConfig:yc})}request(e){return validate({path:{type:"string",allowEmpty:!1}},e),this.core.sendCmd("requestProxy",{requestProxyTag:e}).then((e=>{var{content:t}=e;return t.requestProxyTag}))}onRequestProxyHandler(e){var{proxyMsg:t}=e.content;t&&t.time&&(t.time=+t.time),this.core.emit("proxyMsg",t)}},"passThrough"),NIM.registerService(class CloudStorageService{constructor(e,t={}){this.config={},this.uploadTaskMap={},this.name="cloudStorage",this.logger=e.logger,this.core=e,this.nos=new NOS(e,this),this.mixStorage=new MixStorage(e,this),this.aws=new AWS(e,this),registerParser({cmdMap:Sc,cmdConfig:Nc}),this.setOptions(t),this.setListeners()}setOptions(e={}){var t=e.storageKeyPrefix||"NIMClient";this.mixStorage.GRAYKEY=t+"-AllGrayscaleConfig",this.mixStorage.MIXSTOREKEY=t+"-AllMixStorePolicy";var{s3:r}=e,i=__rest(e,["s3"]),n=Object.assign({},Tc,this.config);if(i&&Object.prototype.hasOwnProperty.call(i,"cdn")){var a=Object.assign(Object.assign({},n.cdn),i.cdn);this.config=Object.assign({},n,i),this.config.cdn=a}else this.config=Object.assign({},n,i);r&&(this.aws.s3=r)}setListeners(){this.core.eventBus.on("kicked",this._clearUnCompleteTask.bind(this)),this.core.eventBus.on("disconnect",this._clearUnCompleteTask.bind(this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLogout",this._clearUnCompleteTask.bind(this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleKicked",this._clearUnCompleteTask.bind(this))}_clearUnCompleteTask(){Object.keys(this.uploadTaskMap).forEach((e=>{var t=this.uploadTaskMap[e];t&&t.abort&&t.abort()})),this.uploadTaskMap={}}init(){return __awaiter(this,void 0,void 0,(function*(){this.mixStorage.reset(),this.nos.reset(),this.config.isNeedToGetUploadPolicyFromServer&&(yield this.mixStorage.getGrayscaleConfig(this.core.options.appkey)),yield this.nos._getNosCdnHost()}))}processCallback(e,t){var r=e.onUploadProgress,i=e.onUploadDone,n=e.onUploadStart;return{onUploadStart:"function"==typeof n?e=>{this.uploadTaskMap[t]=e;try{n(e)}catch(e){this.logger.error("CloudStorage::uploadFile:options.onUploadStart execute error",e)}}:e=>{this.uploadTaskMap[t]=e},onUploadProgress:"function"==typeof r?e=>{this.core.reporterHookCloudStorage.update({transferred_size:e.loaded});try{r(e)}catch(e){this.logger.error("CloudStorage::uploadFile:options.onUploadProgress execute error",e)}}:e=>{this.core.reporterHookCloudStorage.update({transferred_size:e.loaded})},onUploadDone:"function"==typeof i?e=>{this.core.reporterHookCloudStorage.end(0);try{i(e)}catch(e){this.logger.error("CloudStorage::uploadFile:options.onUploadDone execute error",e)}}:()=>{this.core.reporterHookCloudStorage.end(0)},taskKey:t}}uploadFile(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({maxSize:{type:"number",required:!1},type:{type:"enum",values:["file","image","audio","video"]}},e),!e.fileInput&&!e.file&&!e.filePath)throw new Error("uploadFile needs target file object or a filePath");if(e.type&&"file"!==e.type){var t=Ne(e,"file.type");if(t&&"string"==typeof t&&-1===t.indexOf(e.type))throw new Error(`The meta type "${t}" does not match "${e.type}"`)}if(this.core.reporterHookCloudStorage.start(),e.file)this.core.reporterHookCloudStorage.update({full_size:e.file.size});else if("string"==typeof e.fileInput){var r=document.getElementById(e.fileInput);r&&r.files&&r.files[0]&&this.core.reporterHookCloudStorage.update({full_size:r.files[0].size})}else e.fileInput&&e.fileInput.files&&e.fileInput.files[0]&&this.core.reporterHookCloudStorage.update({full_size:e.fileInput.files[0].size});var i=Ii(),{onUploadStart:n,onUploadProgress:a,onUploadDone:s}=this.processCallback(e,i);e.onUploadStart=n,e.onUploadProgress=a,e.onUploadDone=s;var o=null;try{o=yield this._uploadFile(e),e.md5&&(o.md5=e.md5),delete this.uploadTaskMap[i]}catch(e){throw delete this.uploadTaskMap[i],this.core.reporterHookCloudStorage.end((e&&e.code)===Ct.V2NIM_ERROR_CODE_CANCELLED?3:1),e}return o&&(o.size=void 0===o.size?void 0:Number(o.size),o.w=void 0===o.w?void 0:Number(o.w),o.h=void 0===o.h?void 0:Number(o.h),o.dur=void 0===o.dur?void 0:Number(o.dur)),o.url=decodeURIComponent(o.url),e.onUploadDone({size:o.size,name:o.name,url:o.url,ext:o.name.split(".")[1]||"unknown"}),o}))}_uploadFile(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){if(!Ne(this.mixStorage,"grayConfig.mixStoreEnable")||!Ne(this.mixStorage,"mixStorePolicy.providers.length"))return this.logger.log("uploadFile:: uploadFile begin, use old nos"),this.nos.nosUpload(e);this.logger.log(`uploadFile::_uploadFile, grayConfig enable:${Ne(this.mixStorage,"grayConfig.mixStoreEnable")} curProvider:${Ne(this.mixStorage,"curProvider")}`);var i=this.core.adapters.getFileUploadInformation(e),n=!0;i?!1===i.complete&&this.mixStorage.curProvider===Ic.s3&&(n=!1):n=!1,this.aws.s3||(this.mixStorage.curProvider=Ic.nos);var a=fc;if(!n)try{a=(yield this.core.sendCmd("getMixStoreToken",{mixStoreTokenReqTag:{provider:this.mixStorage.curProvider,tokenCount:1,tag:"qchat",nosSurvivalTime:e.nosSurvivalTime,returnBody:getUploadResponseFormat(e.type)}})).content.mixStoreTokenResTag}catch(e){if(this.core.logger.error("uploadFile:: getMixStoreToken error",e),e instanceof V2NIMErrorImpl)throw e;throw new UploadError({code:"v2"===Ne(this.core,"options.apiVersion")?Ct.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"getMixStoreToken error",rawError:e,curProvider:this.mixStorage.curProvider,mixStorePolicy:this.mixStorage.mixStorePolicy}})}return n?this.nos.nosUpload(e,null===(r=null===(t=null==i?void 0:i.uploadInfo)||void 0===t?void 0:t.payload)||void 0===r?void 0:r.mixStoreToken):this.mixStorage.curProvider===Ic.s3?this.aws.s3Upload(e,a):this.nos.nosUpload(e,a)}))}getThumbUrl(e,t){var r,i,n,a,s;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(e))return this.logger.error("illegal file url:"+e),e;var[o,c,d,l,m,p,u,h]=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e);if(null===(r=this.grayConfig)||void 0===r?void 0:r.mixStoreEnable){var g=this._getUrlType(e);if(g===Ic.s3&&this.mixStorePolicy.s3Policy&&Ne(this.mixStorePolicy,"s3Policy.thumbPolicy.imagethumb"))return(null===(n=null===(i=this.mixStorePolicy.s3Policy)||void 0===i?void 0:i.thumbPolicy)||void 0===n?void 0:n.imagethumb).replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",p).replace("{x}",t.width.toString()).replace("{y}",t.height.toString());if(g===Ic.nos&&this.mixStorePolicy.nosPolicy&&Ne(this.mixStorePolicy,"nosPolicy.thumbPolicy.imagethumb"))return(null===(s=null===(a=this.mixStorePolicy.nosPolicy)||void 0===a?void 0:a.thumbPolicy)||void 0===s?void 0:s.imagethumb).replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",p).replace("{x}",t.width.toString()).replace("{y}",t.height.toString())}return e.includes("?")?e+`&imageView&thumbnail=${t.width}x${t.height}`:e+`?imageView&thumbnail=${t.width}x${t.height}`}getVideoCoverUrl(e,t){var r,i,n,a,s;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(e))return this.logger.error("illegal file url:"+e),e;var[o,c,d,l,m,p,u,h]=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e);if(null===(r=this.grayConfig)||void 0===r?void 0:r.mixStoreEnable){var g=this._getUrlType(e);if(g===Ic.s3&&this.mixStorePolicy.s3Policy&&Ne(this.mixStorePolicy,"s3Policy.thumbPolicy.vframe"))return(null===(n=null===(i=this.mixStorePolicy.s3Policy)||void 0===i?void 0:i.thumbPolicy)||void 0===n?void 0:n.vframe).replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",p).replace("{x}",t.width.toString()).replace("{y}",t.height.toString()).replace("{offset}","0").replace("{type}","png");if(g===Ic.nos&&this.mixStorePolicy.nosPolicy&&Ne(this.mixStorePolicy,"nosPolicy.thumbPolicy.vframe"))return(null===(s=null===(a=this.mixStorePolicy.nosPolicy)||void 0===a?void 0:a.thumbPolicy)||void 0===s?void 0:s.vframe).replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",p).replace("{x}",t.width.toString()).replace("{y}",t.height.toString()).replace("{offset}","0").replace("{type}","png")}return e.includes("?")?e+`&vframe&offset=0&resize=${t.width}x${t.height}&type=png`:e+`?vframe&offset=0&resize=${t.width}x${t.height}&type=png`}getPrivateUrl(e){var t;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(e))return this.logger.error("illegal file url:"+e),"";var[r,i,n,a,s,o,c,d]=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e);if(null===(t=this.grayConfig)||void 0===t?void 0:t.mixStoreEnable){var l=this._getUrlType(e);return l===Ic.s3&&this.mixStorePolicy.s3Policy&&(e=this.mixStorePolicy.s3Policy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",o)),l===Ic.nos&&this.mixStorePolicy.nosPolicy&&(e=this.mixStorePolicy.nosPolicy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",o)),e}var{downloadUrl:m,downloadHostList:p,nosCdnEnable:u}=this.config,h=this.config.cdn.cdnDomain,g=this.config.cdn.objectNamePrefix?decodeURIComponent(this.config.cdn.objectNamePrefix):"",v=decodeURIComponent(o),y=v.indexOf(g);if(h&&y>-1&&u)return`${i}${h}/${v.slice(y)}`;if(p.includes(a)&&o.includes("/")){var I=o.indexOf("/"),_=o.substring(0,I),M=o.substring(I+1);return m.replace("{bucket}",_).replace("{object}",M)}var f=p.filter((e=>"string"==typeof a&&a.includes(e)))[0],T=f?a.replace(f,"").replace(/\W/g,""):null;return T?m.replace("{bucket}",T).replace("{object}",o):e}getOriginUrl(e){return __awaiter(this,void 0,void 0,(function*(){return"string"==typeof e&&e.includes("_im_url=1")?(yield this.core.sendCmd("getOriginUrl",{nosSafeUrlTag:{safeUrl:e}})).content.nosSafeUrlTag.originUrl:e}))}getFileToken(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number",min:2,max:3},urls:{type:"array",required:!1,itemType:"string"}},e);var t=this.mixStorePolicy.nosPolicy?this.mixStorePolicy.nosPolicy.authPolicy.policyType:null,r=this.mixStorePolicy.s3Policy?this.mixStorePolicy.s3Policy.authPolicy.policyType:null;if(t===String(_c.dontNeed)&&r===String(_c.dontNeed))throw this.logger.error("don't need token"),new Error("don't need token");if(e.type===_c.time){if(t&&t.indexOf(String(_c.time))>=0||r&&r.indexOf(String(_c.time))>0)return this.mixStorage.getFileAuthToken(e);throw this.logger.error("don't support time token "),new Error("don't support type time token ")}if(!e.urls||!e.urls.length)throw this.logger.error("urls is required when urls token"),new Error("urls is required when urls token");var i=[],n=[];if(e.urls.forEach((e=>{var t=this._getUrlType(e);t===Ic.nos&&n.push(e),t===Ic.s3&&i.push(e)})),(!r||0!==i.length&&r.indexOf(String(_c.urls))<0)&&(this.logger.warn("s3 url don't support url token"),i=[]),(!t||0!==n.length&&t.indexOf(String(_c.urls))<0)&&(this.logger.warn("nos url don't support url token"),n=[]),0===i.length&&0===n.length)throw this.logger.error("not support urls"),new Error("not support urls");if(0===i.length||0===n.length)return e.urls=JSON.stringify(e.urls),this.mixStorage.getFileAuthToken(e)}))}_getUrlType(e){return this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.nosPolicy.dlcdns.some((t=>e.indexOf(t)>=0))?Ic.nos:this.mixStorePolicy.s3Policy&&this.mixStorePolicy.s3Policy.dlcdns.some((t=>e.indexOf(t)>=0))?Ic.s3:null}getNosAccessToken(e){return validate({url:{type:"string",allowEmpty:!1}},e),this.nos.getNosAccessToken(e)}deleteNosAccessToken(e){return validate({token:{type:"string",allowEmpty:!1}},e),this.nos.deleteNosAccessToken(e)}get grayConfig(){return this.mixStorage.grayConfig}get mixStorePolicy(){return this.mixStorage.mixStorePolicy}process(e){var t=Ne(e,"error.detail.ignore");return e.error&&!t?Promise.reject(e.error):Promise.resolve(e)}},"cloudStorage"),NIM.registerService(class SuperTeamService extends Service$1{constructor(e){super("superTeam",e),this.mySuperTeamMembersMap=new Map,this.service=new ModuleService(e),registerParser({cmdMap:Bc,cmdConfig:jc}),this.setListeners()}setListeners(){this.core.eventBus.on("forwardReceive/superTeam/updateMyMemberInfo",(e=>{this.emitMemberUpdate(e)})),this.core.eventBus.on("team/onNotification",(e=>this.notificationHandler(e)))}reset(){this.mySuperTeamMembersMap.clear()}mergeMySuperTeamMembers(e){e.forEach((e=>{var t=e.teamId,r=this.mySuperTeamMembersMap.get(t),i=Object.assign({},r,e);this.mySuperTeamMembersMap.set(t,i)}))}getSuperTeamInfo(e){return __awaiter(this,void 0,void 0,(function*(){return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),formatSuperTeam((yield this.core.sendCmd("getSuperTeamInfo",{teamId:e.teamId})).content.superTeam)}))}getSuperTeams(){return __awaiter(this,void 0,void 0,(function*(){return formatSuperTeams((yield this.core.sendCmd("getSuperTeams",{timetag:0})).content.superTeams)}))}updateSuperTeamInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},name:{type:"string",allowEmpty:!1,required:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!0,required:!1},announcement:{type:"string",allowEmpty:!0,required:!1},avatar:{type:"string",allowEmpty:!0,required:!1},ext:{type:"string",allowEmpty:!0,required:!1}},e);var t=function generateSuperTeam(e){var t=Object.assign({},e),r={joinMode:Oc,beInviteMode:Vc,inviteMode:wc,updateTeamMode:Dc,updateExtMode:qc};return["avatar","name","intro","announcement","ext"].forEach((e=>{void 0!==t[e]&&(t[e]=t[e].toString())})),Object.keys(r).forEach((e=>{void 0!==t[e]&&(t[e]=r[e][t[e]])})),t}(e);return yield this.core.sendCmd("updateSuperTeamInfo",{superTeam:t}),formatSuperTeam(t)}))}addSuperTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),yield this.core.sendCmd("addSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts,ps:e.ps||"",attach:e.ext||""})}))}removeSuperTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1}},e),yield this.core.sendCmd("removeSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts})}))}addSuperTeamManagers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),yield this.core.sendCmd("addSuperTeamManagers",e)}))}removeSuperTeamManagers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),yield this.core.sendCmd("removeSuperTeamManagers",e)}))}applySuperTeam(e){return __awaiter(this,void 0,void 0,(function*(){return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),formatSuperTeam((yield this.core.sendCmd("applySuperTeam",{teamId:e.teamId,ps:e.ps||""})).content.superTeam)}))}transferSuperTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},leave:{type:"boolean"}},e),yield this.core.sendCmd("transferSuperTeam",e)}))}muteSuperTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},mute:{type:"boolean"}},e),yield this.core.sendCmd("muteSuperTeam",{teamId:e.teamId,mute:e.mute?1:0})}))}muteSuperTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string"},mute:{type:"boolean"}},e),yield this.core.sendCmd("muteSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts,mute:e.mute?1:0})}))}updateMemberNick(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!0}},e);var t=generatorSuperTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,account:e.account});return yield this.core.sendCmd("updateSuperTeamMemberNick",{teamMember:t}),formatSuperTeamMember(Object.assign({updateTime:(new Date).getTime()},t))}))}updateMyMemberInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!0,required:!1},bitConfigMask:{type:"number",min:0,max:2,required:!1},ext:{type:"string",required:!1}},e);var t=generatorSuperTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,bitConfigMask:e.bitConfigMask,ext:e.ext});yield this.core.sendCmd("updateMySuperTeamMemberInfo",{teamMember:t});var r=formatSuperTeamMember(Object.assign({updateTime:(new Date).getTime(),account:this.core.account},t)),i=this.emitMemberUpdate(r);return this.core.eventBus.emit("forwardSend/superTeam/updateMyMemberInfo",i),r}))}getSuperTeamMembersByAccounts(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",max:20,min:1}},e);var r=e.accounts.map((t=>`${e.teamId}|${t}`)),i=yield this.core.sendCmd("getSuperTeamMembersByAccounts",{memberIds:r});return formatSuperTeamMembers(null===(t=i.content)||void 0===t?void 0:t.superTeamMembers)}))}getSuperTeamMembers(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinTime:{type:"number",min:0,required:!1},limit:{type:"number",min:1,max:1e3,required:!1},reverse:{type:"boolean",required:!1}},e);var r=yield this.core.sendCmd("getSuperTeamMembers",Object.assign({joinTime:0,limit:100,reverse:!1},e));return formatSuperTeamMembers(null===(t=r.content)||void 0===t?void 0:t.superTeamMembers)}))}queryMuteMembers(e){return __awaiter(this,void 0,void 0,(function*(){return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinTime:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1},reverse:{type:"boolean",required:!1}},e),formatSuperTeamMembers((yield this.core.sendCmd("queryMuteSuperTeamMembers",Object.assign({limit:100,joinTime:0,reverse:!1},e))).content.superTeamMembers)}))}leaveSuperTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),yield this.core.sendCmd("leaveSuperTeam",{teamId:e.teamId})}))}passSuperTeamApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e);try{yield this.core.sendCmd("passSuperTeamApply",e),this.core.eventBus.emit("forwardSend/superTeam/passTeamApply",e)}catch(r){var t=r;throw this.core.eventBus.emit("forwardSend/superTeam/passTeamApply",e,null==t?void 0:t.code),r}}))}rejectSuperTeamApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e);try{yield this.core.sendCmd("rejectSuperTeamApply",{teamId:e.teamId,from:e.from,ps:e.ps||""}),this.core.eventBus.emit("forwardSend/superTeam/rejectSuperTeamApply",e)}catch(r){var t=r;throw this.core.eventBus.emit("forwardSend/superTeam/rejectSuperTeamApply",e,null==t?void 0:t.code),r}}))}acceptSuperTeamInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e);try{yield this.core.sendCmd("acceptSuperTeamInvite",e),this.core.eventBus.emit("forwardSend/superTeam/acceptSuperTeamInvite",e)}catch(r){var t=r;throw this.core.eventBus.emit("forwardSend/superTeam/acceptSuperTeamInvite",e,null==t?void 0:t.code),r}}))}rejectSuperTeamInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e);try{yield this.core.sendCmd("rejectSuperTeamInvite",{teamId:e.teamId,from:e.from,ps:e.ps||""}),this.core.eventBus.emit("forwardSend/superTeam/rejectSuperTeamInvite",e)}catch(r){var t=r;throw this.core.eventBus.emit("forwardSend/superTeam/rejectSuperTeamInvite",e,null==t?void 0:t.code),r}}))}emitMemberUpdate(e){e=formatSuperTeamMember(e),this.mergeMyTeamMembers([e]),this.core.emit("updateTeamMember",e);var t=Go(this.mySuperTeamMembersMap.get(e.teamId));return this.core.emit("myTeamMembers",[t]),t}mergeMyTeamMembers(e){e.forEach((e=>{var t=e.teamId,r=this.mySuperTeamMembersMap.get(t),i=Object.assign({},r,e);this.mySuperTeamMembersMap.set(t,i)}))}syncSuperTeamsHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{superTeams:parseInt(t.timetag)});var r=null==t?void 0:t.teams;if(r&&r.length){var i=formatSuperTeams(r);this.core.emit("superTeams",i)}}syncCreateSuperTeamHandler(e){var t=e.content,r=formatSuperTeam(null==t?void 0:t.superTeam),i=generatorMemberBySuperTeam(r,r.owner,"owner");this.core.emit("createSuperTeam",r,i)}syncUpdateSuperTeamMemberHandler(e){var t=e.content,r=formatSuperTeamMember(null==t?void 0:t.teamMember);r.updateTime||(r.updateTime=(new Date).getTime()),this.mergeMySuperTeamMembers([r]),this.core.emit("updateSuperTeamMember",r);var i=Go(this.mySuperTeamMembersMap.get(r.teamId));this.core.emit("mySuperTeamMembers",[i])}syncMySuperTeamMembersHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{mySuperTeamMembers:parseInt(t.timetag)});var r=null==t?void 0:t.teamMembers.map((e=>formatSuperTeamMember(e)));this.mergeMySuperTeamMembers(r),this.core.emit("mySuperTeamMembers",Go(r))}notificationHandler(e){var{attach:t,scene:r,from:i,to:n,time:a,idServer:s,idClient:o}=e,{team:c,account:d,accounts:l,type:m}=t;if("superTeam"===r)switch("debug"===this.core.options.debugLevel?this.logger.debug("superTeam::recvNotification",s,o,t):this.logger.log("superTeam::recvNotification",s,o,n,m,d,l),m){case"updateSuperTeam":c.updateTime=a,this.core.emit("updateSuperTeam",c);break;case"addSuperTeamMembers":this.service.notifyAddSuperTeamMembers(c,l);break;case"acceptSuperTeamInvite":this.service.notifyAddSuperTeamMembers(c,[i]);break;case"passSuperTeamApply":this.service.notifyAddSuperTeamMembers(c,[d]);break;case"addSuperTeamManagers":this.service.notifyUpdateSuperTeamManagers(n,l,!0,a);break;case"removeSuperTeamManagers":this.service.notifyUpdateSuperTeamManagers(n,l,!1,a);break;case"removeSuperTeamMembers":this.service.notifyRemoveSuperTeamMembers(c,l);break;case"leaveSuperTeam":this.service.notifyRemoveSuperTeamMembers(c,[i]);break;case"dismissSuperTeam":this.core.emit("dismissSuperTeam",{teamId:n});break;case"transferSuperTeam":this.service.notifyTransferSuperTeam(c,i,d);break;case"updateSuperTeamMembersMute":this.service.notifyUpdateSuperTeamMembersMute(c,l,t.mute)}}},"superTeam"),NIM.registerService(SyncService,"sync"),NIM.registerService(class PluginService extends Service$1{constructor(e){super("plugin",e),this.core=e,registerParser({cmdMap:Hc,cmdConfig:Yc})}getChatroomAddress(e){return __awaiter(this,void 0,void 0,(function*(){return validate({chatroomId:{type:"string",allowEmpty:!1},ipType:{type:"number",required:!1}},e),(yield this.core.sendCmd("getChatroomAddress",{chatroomId:e.chatroomId,isWeixinApp:"WXAPP"===Xr.platform,ipType:e.ipType||0})).content.address}))}getQChatAddress(e){return __awaiter(this,void 0,void 0,(function*(){return validate({ipType:{type:"number",required:!1}},e),(yield this.core.sendCmd("getQChatAddress",{getQChatAddressTag:{ipType:(null==e?void 0:e.ipType)||0}})).content.address}))}},"plugin"),NIM.registerService(class CloudSessionService extends Service$1{constructor(e){super("cloudSession",e),registerParser({cmdMap:Kc,cmdConfig:Xc})}queryCloudSessionList(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({minTimestamp:{type:"number",min:0,required:!1},maxTimestamp:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1},includedLastMsg:{type:"boolean",required:!1}},e);var r=Object.assign({limit:100,includedLastMsg:!0},e);r.includedLastMsg=fi.boolean(e,"includedLastMsg");var i,n,a,s=yield this.core.sendCmd("nimQueryCloudSessionList",{tag:r}),o=(null===(t=s.content)||void 0===t?void 0:t.tag)||{},c=s.content.sessions;return{hasMore:+o.hasMore>0,sessionList:(i=c,n=this.core.account,a=this.logger,i&&i.length>0?i.map((e=>formatCloudSession(e,n,a))):[])}}))}queryCloudSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({sessionId:{type:"string",allowEmpty:!1}},e);var{accid:t,scene:r}=getAccountFromSessionId(e.sessionId,"-");return formatCloudSession((yield this.core.sendCmd("nimQueryCloudSession",{tag:{sessionId:"superTeam"===r?`super_team|${t}`:`${r}|${t}`}})).content.session,this.core.account,this.logger)}))}updateCloudSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({sessionId:{type:"string",allowEmpty:!1},ext:{type:"string",allowEmpty:!1,required:!1}},e);var{accid:t,scene:r}=getAccountFromSessionId(e.sessionId,"-");yield this.core.sendCmd("nimUpdateCloudSession",{tag:{sessionId:"superTeam"===r?`super_team|${t}`:`${r}|${t}`,ext:e.ext}})}))}deleteCloudSessionList(e){return __awaiter(this,void 0,void 0,(function*(){validate({sessionIdList:{type:"array",itemType:"string"}},e);var t=e.sessionIdList.map((e=>{var{accid:t,scene:r}=getAccountFromSessionId(e,"-");return{sessionId:"superTeam"===r?`super_team|${t}`:`${r}|${t}`}}));yield this.core.sendCmd("nimDeleteCloudSessionList",{tags:t})}))}nimMultiSyncUpdateCloudSessionHandler(e){var t=formatCloudSession(e.content.session,this.core.account,this.logger);this.core.emit("multiSyncUpdateCloudSession",t)}},"cloudSession"),NIM.registerService(SignalingService,"signaling"),NIM.registerService(V2NIMLoginServiceImpl,"V2NIMLoginService"),NIM.registerService(class V2NIMConversationServiceImpl extends V2Service{constructor(e,t={}){super("V2NIMConversationService",e),this.config={},this.core.V2NIMConversationIdUtil=new V2NIMConversationIdUtilImpl(this.core),this.model=new V2NIMConversationModelImpl,this.versionCache=new V2NIMConversationVersionCacheImpl(this.core,this),this.unread=new V2NIMConversationUnreadImpl(this.core,this),"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Ll,cmdConfig:xl}),this.setOptions(t),this.setListener())}setOptions(e){this.config=Object.assign(this.config,e)}setListener(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.versionCache.doSync()})),this.core.eventBus.on("V2NIMConversationService/conversationOnlineSyncNotify",((e,t)=>{var r;!1!==(null===(r=null==t?void 0:t.messageConfig)||void 0===r?void 0:r.lastMessageUpdateEnabled)&&(e.content.info=deserialize(e.content.info,sn(ql)),e.content.data=deserialize(e.content.data,sn(Ul)),t&&(e.content.data.lastMessage=formatLastMessageFromMessage(this.core,t,Pe.V2NIM_MESSAGE_STATUS_DEFAULT)),e.content.datas=[e.content.data],this.v2ConversationNotifySyncOnlineHandler.call(this,e))})),this.core.eventBus.on("V2NIMConversationService/sendMessage",((e,t)=>{var r,i;t===We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED&&!0===(null===(r=e.messageConfig)||void 0===r?void 0:r.historyEnabled)||!1!==(null===(i=null==e?void 0:e.messageConfig)||void 0===i?void 0:i.lastMessageUpdateEnabled)&&this.versionCache.updateModelWithLastMessage(e.conversationId,e,Pe.V2NIM_MESSAGE_STATUS_BACKFILL,t)})),this.core.eventBus.on("V2NIMConversationService/deleteMessages",(e=>{var t=e.map((e=>e.messageRefer.conversationId));this.versionCache.backfillLastMsg(t,!0)})),this.core.eventBus.on("V2NIMConversationService/revokeMessages",(e=>{this.versionCache.updateModelByRevoke(e)})),this.core.eventBus.on("V2NIMConversationService/checkBackFill",(e=>{this.versionCache.backfillLastMsg(e,!1)})),this.core.eventBus.on("V2NIMConversationService/setMute",((e,t)=>{var r=this.model.getById(e);r&&r.mute!==t&&(r.mute=t,this.model.upsert(r),this.emit("onConversationChanged",[r]))}))}reset(){this.versionCache.reset(),this.model.reset(),this.unread.reset()}getConversationList(e,t){this.checkV2(),validate({offset:{type:"number",min:0}},{offset:e},"",!0),validate({limit:{type:"number",min:1}},{limit:t},"",!0),this.core.V2NIMLoginService.checkIllegalState();var r=this.model.getByOption(e,t,{});return r.conversationList=this.computedFieldForConversations(r.conversationList),Promise.resolve(r)}getConversationListByOption(e,t,r){this.checkV2(),validate({offset:{type:"number",min:0}},{offset:e},"",!0),validate({limit:{type:"number",min:1}},{limit:t},"",!0),validate({option:{type:"object",required:!0,rules:{conversationTypes:{type:"array",itemType:"number",required:!1},onlyUnread:{type:"boolean",required:!1},conversationGroupIds:{type:"array",itemType:"string",required:!1}}}},{option:r},"",!0),this.core.V2NIMLoginService.checkIllegalState();var i=this.model.getByOption(e,t,r);return i.conversationList=this.computedFieldForConversations(i.conversationList),Promise.resolve(i)}getConversation(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,e),this.core.V2NIMLoginService.checkIllegalState();var t=this.model.getById(e);if(t)return this.computedFieldForConversation(t);throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST})}))}getConversationListByIds(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:e},"",!0),this.core.V2NIMLoginService.checkIllegalState();var t=e.map((e=>this.model.getById(e))).filter((e=>!!e));return t=this.computedFieldForConversations(t)}))}createConversation(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,e);var t=yield this.core.sendCmd("v2ConversationCreate",{tag:{conversationId:e}}),r=Ne(t,"content.data"),i=formatConversationField(this.core,r);this.versionCache.compareAndUpdateModel([i]);var n=this.model.getById(e);if(n)return this.computedFieldForConversation(n);throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST})}))}deleteConversation(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,e),validate({clearMessage:{type:"boolean",required:!1}},{clearMessage:t},"",!0);try{yield this.core.sendCmd("v2ConversationDelete",{tag:{conversationId:e,clearMessage:Number(t||!1)}})}catch(t){if(t.code!==Ct.V2NIM_ERROR_CODE_CONVERSATION_NOT_EXIST||!this.model.getById(e))throw t}t&&this.core.eventBus.emit("V2NIMConversationService/deleteConversation",[e]),this.versionCache.compareAndDeleteModel([e])}))}deleteConversationListByIds(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:e},"",!0),validate({clearMessage:{type:"boolean",required:!1}},{clearMessage:t},"",!0);var r=yield this.core.sendCmd("v2ConversationsDelete",{tag:{conversationIds:JSON.stringify(e),clearMessage:Number(t||!1)}}),i=formatFailedMap(Ne(r,"content.info.failedMap")).filter((e=>e.error.code!==Ct.V2NIM_ERROR_CODE_CONVERSATION_NOT_EXIST||!this.model.getById(e.conversationId)));return t&&this.core.eventBus.emit("V2NIMConversationService/deleteConversation",e),this.versionCache.compareAndDeleteModel(e),i}))}stickTopConversation(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,e),validate({stickTop:{type:"boolean"}},{stickTop:t},"",!0);var r=yield this.core.sendCmd("v2ConversationSetTop",{tag:{conversationId:e,stickTop:Number(t)}}),i=Ne(r,"content.data"),n=formatConversationField(this.core,i);this.versionCache.compareAndUpdateModel([n])}))}updateConversation(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,e),validate({updateInfo:{type:"object",required:!0,rules:{serverExtension:{type:"string"}}}},{updateInfo:t},"",!0);var r=yield this.core.sendCmd("v2ConversationUpdate",{tag:Object.assign({conversationId:e},t)}),i=Ne(r,"content.data"),n=formatConversationField(this.core,i);this.versionCache.compareAndUpdateModel([n])}))}updateConversationLocalExtension(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,e),validate({localExtension:{type:"string"}},{localExtension:t},"",!0);var r=this.model.getById(e);if(!r)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST});if(r.localExtension!==t){var i=Object.assign(Object.assign({},r),{localExtension:t});this.model.upsert(i),this.triggerConversationChanged([i])}}))}getTotalUnreadCount(){return this.checkV2(),this.unread.getTotalUnreadCount()||0}getUnreadCountByIds(e){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:e},"",!0);var t=this.unread.getUnreadCountByIds(e);return Promise.resolve(t)}getUnreadCountByFilter(e){this.checkV2(),this.valiteFilter(e);var t=this.unread.getUnreadCountByFilter(e);return Promise.resolve(t)}clearTotalUnreadCount(){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var e=yield this.core.sendCmd("v2ConversationClearTotalUnread"),t=formatConversationNotify(Ne(e,"content.info"));this.versionCache.compareAndClearUnreadInModel(t.oneClickClearUnreadVersion,t.oneClickClearUnreadType)}))}clearUnreadCountByIds(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:e},"",!0);var t=yield this.core.sendCmd("v2ConversationsUnreadClear",{tag:{conversationIds:JSON.stringify(e)}}),r=formatConversationFields(this.core,Ne(t,"content.datas")),i=formatFailedMap(Ne(t,"content.info.failedMap"));return this.versionCache.compareAndUpdateModel(r),i}))}clearUnreadCountByGroupId(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string"}},{groupId:e},"",!0),yield this.core.sendCmd("v2ConversationClearGroupUnread",{tag:{groupId:e}})}))}clearUnreadCountByTypes(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({types:{type:"array",itemType:"number",min:1}},{types:e},"",!0);var t=yield this.core.sendCmd("v2ConversationClearTypeUnread",{tag:{conversationType:JSON.stringify(e)}}),r=formatConversationNotify(Ne(t,"content.info"));this.versionCache.compareAndClearUnreadInModel(r.oneClickClearUnreadVersion,r.oneClickClearUnreadType,{conversationTypes:r.oneClickClearUnreadConversationType})}))}markConversationRead(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),this.checkLogin(),validateConversationId(this.core.account,e);var i=this.model.getById(e);if(!i)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Conversation not exist"}});var n,a=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e),s=this.core.V2NIMConversationIdUtil.parseConversationType(e),o=this.model.getReadTime(e);if(null===(r=null===(t=null==i?void 0:i.lastMessage)||void 0===t?void 0:t.messageRefer)||void 0===r?void 0:r.createTime)n=i.lastMessage.messageRefer.createTime;else{if(!this.core.timeOrigin.checkNodeReliable())return this.logger.log("markConversationRead","NTP time is not reliable",e),o||0;n=this.core.timeOrigin.getNTPTime()}return o>=n?(this.logger.log("markConversationRead","currentReadTime >= readTime",e,o,n),o):(s===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?yield this.core.sendCmd("v2MarkSuperTeamReadTime",{timetag:n,to:a}):yield this.core.sendCmd("v2MarkConversationReadTime",{scene:s===Oe.V2NIM_CONVERSATION_TYPE_P2P?0:s===Oe.V2NIM_CONVERSATION_TYPE_TEAM?1:2,timetag:n,to:a}),this.model.updateReadTime(e,n),n)}))}getConversationReadTime(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validateConversationId(this.core.account,e),this.model.getReadTime(e)}))}subscribeUnreadCountByFilter(e){var t;this.checkV2(),this.checkLogin(),this.valiteFilter(e),0===(null===(t=e.conversationTypes)||void 0===t?void 0:t.length)&&delete e.conversationTypes,this.unread.addFilter(e)}unsubscribeUnreadCountByFilter(e){var t;this.checkV2(),this.checkLogin(),this.valiteFilter(e),0===(null===(t=e.conversationTypes)||void 0===t?void 0:t.length)&&delete e.conversationTypes,this.unread.deleteFilter(e)}v2ConversationNotifySyncHandler(e){this.versionCache.recvConversationFromSyncAction(e)}v2ConversationNotifySyncOnlineHandler(e){this.versionCache.recvConversation(e)}syncConversationReadTimeHandler(e){var t,r,i;if(null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.p2p)for(var[n,a]of Object.entries(e.content.p2p))this.model.updateReadTime(this.core.V2NIMConversationIdUtil.p2pConversationId(n),a),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.p2pConversationId(n),a);if(null===(i=null===(r=null==e?void 0:e.content)||void 0===r?void 0:r.team)||void 0===i?void 0:i.m_map)for(var[s,o]of Object.entries(e.content.team.m_map))this.model.updateReadTime(this.core.V2NIMConversationIdUtil.teamConversationId(s),o),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.teamConversationId(s),o)}syncSuperTeamReadTimeHandler(e){var t,r;if(null===(r=null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.superTeam)||void 0===r?void 0:r.m_map)for(var[i,n]of Object.entries(e.content.superTeam.m_map))this.model.updateReadTime(this.core.V2NIMConversationIdUtil.superTeamConversationId(i),n),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.superTeamConversationId(i),n)}v2MultiDeviceConversationReadTimeHandler(e){var t;(null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.to)&&(0===e.content.scene?(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.p2pConversationId(e.content.to),e.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.p2pConversationId(e.content.to),e.content.timetag)):(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.teamConversationId(e.content.to),e.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.teamConversationId(e.content.to),e.content.timetag)))}v2MultiDeviceSuperTeamReadTimeHandler(e){var t;(null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.to)&&(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.superTeamConversationId(e.content.to),e.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.superTeamConversationId(e.content.to),e.content.timetag))}valiteFilter(e){if(validate({filter:{type:"object",required:!0,rules:{conversationTypes:{type:"array",itemType:"number",required:!1},conversationGroupId:{type:"string",allowEmpty:!1,required:!1},ignoreMuted:{type:"boolean",required:!1}}}},{filter:e},"",!0),void 0===e.conversationTypes&&void 0===e.conversationGroupId&&!0!==e.ignoreMuted)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Filter cannot be empty"}})}computedFieldForConversations(e){return e.map((e=>this.computedFieldForConversation(e)))}computedFieldForConversation(e){var t,r,i,n;if(e.type===Oe.V2NIM_CONVERSATION_TYPE_UNKNOWN)return e;var a=this.core.V2NIMConversationIdUtil.parseConversationType(e.conversationId),s=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e.conversationId),o={};if((null===(t=this.core.V2NIMSettingService)||void 0===t?void 0:t.name)&&(o.mute=this.core.V2NIMSettingService.getConversationMuteStatus(e.conversationId)),a===Oe.V2NIM_CONVERSATION_TYPE_P2P&&(null===(r=this.core.V2NIMUserService)||void 0===r?void 0:r.name)){var c=this.core.V2NIMUserService.model.getUser(s),d=this.core.V2NIMFriendService.model.getFriend(s);o.name=(null==d?void 0:d.alias)||(null==c?void 0:c.name)||s,o.avatar=(null==c?void 0:c.avatar)||""}else if(a===Oe.V2NIM_CONVERSATION_TYPE_TEAM&&(null===(i=this.core.V2NIMTeamService)||void 0===i?void 0:i.name)){var l=this.core.V2NIMTeamService.model.getById(s,at.V2NIM_TEAM_TYPE_ADVANCED);o.name=(null==l?void 0:l.name)||s,o.avatar=(null==l?void 0:l.avatar)||""}else if(a===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM&&(null===(n=this.core.V2NIMTeamService)||void 0===n?void 0:n.name)){var m=this.core.V2NIMTeamService.model.getById(s,at.V2NIM_TEAM_TYPE_SUPER);o.name=(null==m?void 0:m.name)||s,o.avatar=(null==m?void 0:m.avatar)||""}return Object.assign(e,o),e}triggerConversationChanged(e){e=this.computedFieldForConversations(e),(e=JSON.parse(JSON.stringify(e))).forEach((e=>{e.lastMessage||(e.lastMessage=void 0),delete e.lastMessageState})),this.emit("onConversationChanged",e)}triggerConversationCreated(e){e=this.computedFieldForConversation(e),delete(e=JSON.parse(JSON.stringify(e))).lastMessageState,this.emit("onConversationCreated",e)}},"V2NIMConversationService"),NIM.registerService(class V2NIMConversationGroupServiceImpl extends V2Service{constructor(e,t={}){super("V2NIMConversationGroupService",e),this.config={},"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:jl,cmdConfig:$l}),this.setOptions(t))}setOptions(e){this.config=Object.assign(this.config,e)}createConversationGroup(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({name:{type:"string",allowEmpty:!1}},{name:e},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:t},"",!0),validate({conversationIds:{type:"array",itemType:"string",required:!1}},{conversationIds:r},"",!0);var i=yield this.core.sendCmd("v2ConversationGroupCreate",{tag:{name:e,serverExtension:t||"",conversationIds:r&&JSON.stringify(r)}}),n=formatConversationGroup(Ne(i,"content.data")),a=formatConversationFields(this.core,Ne(i,"content.conversations")),s=formatFailedMap(Ne(i,"content.info.failedMap"));return this.emit("onConversationGroupCreated",n),a.length>0&&(this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(a),this.emit("onConversationsAddedToGroup",n.groupId,a.map((e=>this.core.V2NIMConversationService.model.getById(e.conversationId))).filter((e=>!!e)))),{group:n,failedList:s}}))}deleteConversationGroup(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0);var t=yield this.core.sendCmd("v2ConversationGroupDelete",{tag:{groupId:e}}),r=formatConversationGroupNotify(Ne(t,"content.info"));this.core.V2NIMConversationService.versionCache.compareAndDeleteGroupInModel(r.deleteVersion,e),this.emit("onConversationGroupDeleted",e)}))}updateConversationGroup(e,t,r){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0),validate({name:{type:"string",required:!1}},{name:t},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:r},"",!0),void 0===t&&void 0===r)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER});var i=yield this.core.sendCmd("v2ConversationGroupUpdate",{tag:{groupId:e,name:t,serverExtension:r}}),n=formatConversationGroup(Ne(i,"content.data"));this.emit("onConversationGroupChanged",n)}))}addConversationsToGroup(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0),validate({conversationIds:{type:"array",itemType:"string",min:1,allowEmpty:!1}},{conversationIds:t},"",!0);var r=yield this.core.sendCmd("v2ConversationGroupAddTo",{tag:{groupId:e,conversationIds:JSON.stringify(t)}}),i=Ne(r,"content.info.failedMap")||"",n=[];i&&(n=formatFailedMap(i));var a=formatConversationFields(this.core,Ne(r,"content.datas"));this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(a);var s=a.map((e=>this.core.V2NIMConversationService.model.getById(e.conversationId))).filter((e=>!!e));return s.length>0&&this.emit("onConversationsAddedToGroup",e,s),n}))}removeConversationsFromGroup(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0),validate({conversationIds:{type:"array",itemType:"string",min:1,allowEmpty:!1}},{conversationIds:t},"",!0);var r=yield this.core.sendCmd("v2ConversationGroupRemoveFrom",{tag:{groupId:e,conversationIds:JSON.stringify(t)}}),i=Ne(r,"content.info.failedMap")||"",n=[];i&&(n=formatFailedMap(i));var a=formatConversationFields(this.core,Ne(r,"content.datas"));return this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(a),this.emit("onConversationsRemovedFromGroup",e,a.map((e=>e.conversationId))),n}))}getConversationGroup(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0);var t=yield this.core.sendCmd("v2ConversationGroupGet",{tag:{groupId:e}});return formatConversationGroup(Ne(t,"content.data"))}))}getConversationGroupList(){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var e=yield this.core.sendCmd("v2ConversationGroupListGet");return formatConversationGroups(Ne(e,"content.datas"))}))}getConversationGroupListByIds(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({groupIds:{type:"array",itemType:"string",min:1}},{groupIds:e},"",!0);var t=yield this.core.sendCmd("v2ConversationGroupsGet",{tag:{groupIds:e&&JSON.stringify(e)}}),r=formatConversationGroups(Ne(t,"content.datas"));return e.map((e=>r.filter((t=>t.groupId===e))[0])).filter((e=>!!e))}))}v2ConversationGroupNotifySyncOnlineHandler(e){var t=formatConversationGroupNotify(Ne(e,"content.info")),{type:r,deleteVersion:i,conversationIds:n}=t,a=formatConversationGroup(Ne(e,"content.data"));if(this.core.logger.log("v2ConversationGroupNotifySyncOnlineHandler",t,a),r===Fl.createConversationGroup)this.emit("onConversationGroupCreated",a),n&&n.length>0&&this.emit("onConversationsAddedToGroup",a.groupId,n.map((e=>this.core.V2NIMConversationService.model.getById(e))).filter((e=>!!e)));else if(r===Fl.deleteConversationGroup)this.emit("onConversationGroupDeleted",a.groupId),this.core.V2NIMConversationService.versionCache.compareAndDeleteGroupInModel(i,a.groupId);else if(r===Fl.updateConversationGroup)this.emit("onConversationGroupChanged",a);else if(r===Fl.addConversationToGroup){var s=n.map((e=>this.core.V2NIMConversationService.model.getById(e))).filter((e=>!!e));this.emit("onConversationsAddedToGroup",a.groupId,s)}else r===Fl.removeConversationFromGroup&&this.emit("onConversationsRemovedFromGroup",a.groupId,n)}},"V2NIMConversationGroupService"),NIM.registerService(class V2NIMMessageServiceImpl extends V2Service{constructor(e,t={}){super("V2NIMMessageService",e),this.config={compatibleWithV1:!0},this.emitRevokeMessage=e=>{var t=e.map((e=>formatRevokeMessage(this.core,e)));t.forEach((e=>{this.model.deleteMessage(e.messageRefer.messageClientId)})),this.emit("onMessageRevokeNotifications",t),this.core.eventBus.emit("V2NIMConversationService/revokeMessages",t)},this.sendMessageHandler=e=>{if(e.msgAckSnapshot){var t=e.msgAckSnapshot,r={conversationId:e.conversationId,messageServerId:e.messageServerId,messageClientId:e.messageClientId,readCount:0,unreadCount:Number(t)};delete e.msgAckSnapshot,this.emit("onReceiveTeamMessageReadReceipts",[r])}e=formatMessageAttachment(e,this.core),this.model.upsertMessages([e]),this.core.eventBus.emit("V2NIMConversationService/sendMessage",e,e.sendingState)},this.revokeMessagesHandler=e=>{e.forEach((e=>{this.model.deleteMessage(e.messageRefer.messageClientId)})),this.emit("onMessageRevokeNotifications",e),this.core.eventBus.emit("V2NIMConversationService/revokeMessages",e)},this.deleteMessagesHandler=e=>{e.forEach((e=>{this.model.deleteMessage(e.messageRefer.messageClientId)})),this.emit("onMessageDeletedNotifications",e),this.core.eventBus.emit("V2NIMConversationService/deleteMessages",e)},this.core.V2NIMMessageCreator=new V2NIMMessageCreatorImpl(this.core),this.core.V2NIMClientAntispamUtil=new V2NIMClientAntispamUtilImpl(this.core),this.receiptUtil=new ReceiptUtil(this.core,this),this.fileUtil=new FileUtil(this.core,this),this.sendUtil=new SendUtil(this.core,this),this.modifyUtil=new ModifyUtil(this.core,this),this.model=new V2NIMMessageModel,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Cl,cmdConfig:Vl}),this.setOptions(t),this.setListener())}setOptions(e){var t;(null===(t=this.core.msg)||void 0===t?void 0:t.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Object.assign(this.config,e)}setListener(){this.core.eventBus.on("forwardReceive/V2NIMMessageService/sendMsg",this.sendMessageHandler),this.core.eventBus.on("forwardReceive/V2NIMMessageService/revokeMessages",this.emitRevokeMessage),this.core.eventBus.on("forwardReceive/V2NIMMessageService/deleteMessages",this.deleteMessagesHandler),this.core.eventBus.on("V2NIMConversationService/deleteConversation",(e=>{e.forEach((e=>this.model.deleteMessages(e)))}))}reset(){this.model.reset()}getMessageList(e){return this.checkV2(),this.core.V2NIMMessageLogUtil.getMessageList(e)}getMessageListByRefers(e){return this.checkV2(),this.core.V2NIMMessageLogUtil.getMessageListByRefers(e)}clearHistoryMessage(e){return this.checkV2(),this.core.V2NIMMessageLogUtil.clearHistoryMessage(e)}pinMessage(e,t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.pinMessage(e,t)}unpinMessage(e,t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.unpinMessage(e,t)}updatePinMessage(e,t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.updatePinMessage(e,t)}voiceToText(e){return this.checkV2(),this.core.V2NIMMessageExtendUtil.voiceToText(e)}getPinnedMessageList(e){return this.checkV2(),this.core.V2NIMMessageExtendUtil.getPinnedMessageList(e)}addQuickComment(e,t,r,i){return this.checkV2(),this.core.V2NIMMessageExtendUtil.addQuickComment(e,t,r,i)}removeQuickComment(e,t,r){return this.checkV2(),this.core.V2NIMMessageExtendUtil.removeQuickComment(e,t,r)}getQuickCommentList(e){return this.checkV2(),this.core.V2NIMMessageExtendUtil.getQuickCommentList(e)}addCollection(e){return this.checkV2(),this.core.V2NIMMessageExtendUtil.addCollection(e)}removeCollections(e){return this.checkV2(),this.core.V2NIMMessageExtendUtil.removeCollections(e)}updateCollectionExtension(e,t){return this.checkV2(),this.core.V2NIMMessageExtendUtil.updateCollectionExtension(e,t)}getCollectionListByOption(e){return this.checkV2(),this.core.V2NIMMessageExtendUtil.getCollectionListByOption(e)}searchCloudMessages(e){return this.checkV2(),this.core.V2NIMMessageExtendUtil.searchCloudMessages(e)}getThreadMessageList(e){return this.checkV2(),this.core.V2NIMMessageExtendUtil.getThreadMessageList(e)}sendP2PMessageReceipt(e){return this.checkV2(),this.receiptUtil.sendP2PMessageReceipt(e)}isPeerRead(e){return this.checkV2(),this.receiptUtil.isPeerRead(e)}getP2PMessageReceipt(e){return this.checkV2(),this.receiptUtil.getP2PMessageReceipt(e)}getTeamMessageReceipts(e){return this.checkV2(),this.receiptUtil.getTeamMessageReceipts(e)}getTeamMessageReceiptDetail(e){return this.checkV2(),this.receiptUtil.getTeamMessageReceiptDetail(e)}sendTeamMessageReceipts(e){return this.checkV2(),this.receiptUtil.sendTeamMessageReceipts(e)}revokeMessage(e,t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(rm,{message:e,params:t},"",!0),validateConversationId(this.core.account,e.conversationId),e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P&&e.senderId!==this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"revokeMessage: p2p message senderId is not current user"}});if(!e.messageServerId||"0"===e.messageServerId)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"revokeMessage: cannot revoke message with invalid messageServerId: "+e.messageServerId}});var r=e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?"v2RevokeSuperTeamMessage":"v2RevokeMessage",i={[Oe.V2NIM_CONVERSATION_TYPE_P2P]:et.P2P_DELETE_MSG,[Oe.V2NIM_CONVERSATION_TYPE_TEAM]:et.TEAM_DELETE_MSG,[Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM]:et.SUPERTEAM_DELETE_MSG},n=Object.assign(Object.assign(Object.assign({},e),t),{attach:t&&t.serverExtension,sysMsgType:i[e.conversationType],opeAccount:this.core.account});yield this.core.sendCmd(r,{tag:n});var a={[Oe.V2NIM_CONVERSATION_TYPE_P2P]:Ke.V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY,[Oe.V2NIM_CONVERSATION_TYPE_TEAM]:Ke.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY,[Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM]:Ke.V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY},s=[JSON.parse(JSON.stringify({postscript:t&&t.postscript,revokeType:a[e.conversationType],revokeAccountId:this.core.account,serverExtension:t&&t.serverExtension,messageRefer:formatMessageRefer(this.core,e)}))];this.revokeMessagesHandler(s),this.core.eventBus.emit("forwardSend/V2NIMMessageService/revokeMessage",n)}))}deleteMessage(e,t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(sm,e,"",!0),e.sendingState===We.V2NIM_MESSAGE_SENDING_STATE_SENDING)this.fileUtil.cancelMessageAttachmentUpload(e);else if(e.sendingState&&e.sendingState!==We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessage: cannot delete unsent message"}});var r={messageRefer:formatMessageRefer(this.core,e),serverExtension:t},i=Date.now();e.messageServerId&&"0"!==e.messageServerId&&(i=(yield this.core.sendCmd("v2DeleteMessage",{tag:r})).content.timetag);var n=[{serverExtension:t,messageRefer:formatMessageRefer(this.core,e),deleteTime:i}];this.core.eventBus.emit("forwardSend/V2NIMMessageService/deleteSelfMsgs",[Object.assign(Object.assign({},r),{deleteTime:i})]),this.deleteMessagesHandler(n)}))}deleteMessages(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(om,{messages:e},"",!0);var r=[],i=[];if(0===e.length)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessages: message array length is 0"}});for(var n=e[0].conversationId,a=0;a<e.length;a++){if(e[a].sendingState===We.V2NIM_MESSAGE_SENDING_STATE_SENDING)this.fileUtil.cancelMessageAttachmentUpload(e[a]);else if(e[a].sendingState&&e[a].sendingState!==We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:`deleteMessage: sendingState should be succeeded, please check message at index: ${a}`}});if(a>=1&&e[a].conversationId!==n)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessages: only allow to delete messages from same conversation"}});e[a].messageServerId&&"0"!==e[a].messageServerId?r.push(e[a]):i.push(e[a])}var s=Date.now(),o=[...i];try{if(r.length>0){var c=yield this.core.sendCmd("v2DeleteMessages",{tag:r.map((e=>({messageRefer:e,serverExtension:t})))});s=c.content.timetag,o=[...o,...r]}}catch(e){if(0===i.length)throw e;this.logger.warn("V2NIMMessageService:deleteMessages: delete messages with serverId failed")}var d=o.map((e=>({serverExtension:t,messageRefer:formatMessageRefer(this.core,e),deleteTime:s})));this.core.eventBus.emit("forwardSend/V2NIMMessageService/deleteSelfMsgs",o.map((e=>({messageRefer:e,serverExtension:t,deleteTime:s})))),this.deleteMessagesHandler(d)}))}cancelMessageAttachmentUpload(e){return this.checkV2(),this.fileUtil.cancelMessageAttachmentUpload(e)}markMsgsAck(e){if(e&&e.length>0){var t=[],r=[];e.forEach((e=>{e.senderId===this.core.account&&e.senderId!==e.receiverId||(e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_P2P?t.push(e):e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_TEAM&&r.push(e))})),t.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:7,cid:2,ids:t.map((e=>e.messageServerId))}),r.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:8,cid:3,ids:r.map((e=>e.messageServerId))})}}onMsgHandler(e){var t=e.content.msg,{_conversationOnlineSyncNotify:r,_conversationOnlineSyncData:i}=t,n=__rest(t,["_conversationOnlineSyncNotify","_conversationOnlineSyncData"]),a=completeMessage(this.core,n),s=formatMessageAttachment(a,this.core);s.messageType!==He.V2NIM_MESSAGE_TYPE_NOTIFICATION&&this.core.V2NIMUserService.checkUserUpdate(s,s.userUpdateTime),!this.config.compatibleWithV1&&this.sendUtil.doMsgReceiveReport(s,e),delete s.__clientExt,this.emit("onReceiveMessages",[s]),this.model.upsertMessages([s]),!this.config.compatibleWithV1&&this.markMsgsAck([s]),r&&this.core.eventBus.emit("V2NIMConversationService/conversationOnlineSyncNotify",{content:{info:JSON.parse(r),data:JSON.parse(i)}},s),s.messageType===He.V2NIM_MESSAGE_TYPE_NOTIFICATION&&this.core.eventBus.emit("V2NIMTeamService/notification",a)}syncOfflineMsgsHandler(e){var t=e.content.data,r=0;t=t.map((e=>(e.createTime>r&&(r=e.createTime),formatMessageAttachment(completeMessage(this.core,e),this.core)))),!this.config.compatibleWithV1&&this.markMsgsAck(t),this.emit("onReceiveMessages",t),this.model.upsertMessages(t),this.core.eventBus.emit("V2NIMConversationService/checkBackFill",t.map((e=>e.conversationId)))}syncRoamingMsgsHandler(e){var t=e.content.data;t=t.map((e=>formatMessageAttachment(completeMessage(this.core,e),this.core))),this.emit("onReceiveMessages",t),this.model.upsertMessages(t),this.core.eventBus.emit("V2NIMConversationService/checkBackFill",t.map((e=>e.conversationId)))}onP2PMessageReceiptsHandler(e){this.receiptUtil.onP2PMessageReceiptsHandler(e)}onTeamMessageReceiptsHandler(e){this.receiptUtil.onTeamMessageReceiptsHandler(e)}syncP2PMessagReceiptsHandler(e){this.receiptUtil.syncP2PMessagReceiptsHandler(e)}syncRevokeMessageHandler(e){this.emitRevokeMessage(e.content.datas)}onRevokeMessageHandler(e){this.emitRevokeMessage([e.content.data])}onDeleteMessageHandler(e){var t=e.content.data,r={serverExtension:t.serverExtension,deleteTime:t.deleteTime,messageRefer:completeMessageRefer(this.core,t.messageRefer)};this.deleteMessagesHandler([r])}onDeleteMessagesHandler(e){var t=e.content.data.map((e=>({serverExtension:e.serverExtension,deleteTime:e.deleteTime,messageRefer:completeMessageRefer(this.core,e.messageRefer)})));this.deleteMessagesHandler(t)}syncOnDeleteMessagesHandler(e){var t=e.content.datas.map((e=>({serverExtension:e.serverExtension,deleteTime:e.deleteTime,messageRefer:completeMessageRefer(this.core,e.messageRefer)})));this.emit("onMessageDeletedNotifications",t)}sendMessage(e,t,r={},i){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate({message:{type:"object"}},{message:e},"",!0),e.messageClientId=e.messageClientId||Ii(),e.conversationId&&e.conversationId!==t)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message.conversationId is not equal to conversationId"}});validate(tm,{conversationId:t,message:e,params:r},"",!0),validateConversationId(this.core.account,t);var n=this.core.V2NIMConversationIdUtil.parseConversationType(t);if((n===Oe.V2NIM_CONVERSATION_TYPE_TEAM||n===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM)&&r.robotConfig&&!r.robotConfig.accountId)throw new ValidateErrorV2({detail:{reason:"When conversationType is team or superTeam, account is required in robotInfo account is required"}});if(n!==Oe.V2NIM_CONVERSATION_TYPE_TEAM&&n!==Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM||!r.targetConfig)r.targetConfig=void 0;else{var a=r.targetConfig.receiverIds;if(n===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM&&!1===r.targetConfig.inclusive)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"setting inclusive to false for super teams is not allowed"}});if(0===(a=a.filter((e=>e&&e!==this.core.account))).length)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"receiverIds cannot be empty or only contain yourself"}});r.targetConfig.receiverIds=a}var s=this.core.timeOrigin.getTimeNode(),{messageBeforeSend:o,clientAntispamResult:c,hiddenParams:d}=this.sendUtil.prepareMessage(e,t,r),l=yield this.sendUtil.doSendMessage({apiCallingTimeNode:s,messageBeforeSend:o,clientAntispamResult:c,hiddenParams:d,progress:i});return l.message.senderId===l.message.receiverId&&this.markMsgsAck([l.message]),l}))}replyMessage(e,t,r={},i){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate({message:{type:"object"}},{message:e},"",!0),e.messageClientId=e.messageClientId||Ii(),validate(em,{message:e,replyMessage:t,params:r},"",!0),validateConversationId(this.core.account,t.conversationId),(e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_TEAM||e.conversationType===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM)&&r.robotConfig&&!r.robotConfig.accountId)throw new ValidateErrorV2({detail:{reason:"When conversationType is team or superTeam, account is required in robotInfo account is required"}});var n=this.core.timeOrigin.getTimeNode(),{messageBeforeSend:a,clientAntispamResult:s,hiddenParams:o}=this.sendUtil.prepareMessage(e,t.conversationId,r,t),c=yield this.sendUtil.doSendMessage({apiCallingTimeNode:n,messageBeforeSend:a,clientAntispamResult:s,hiddenParams:o,progress:i});return c.message.senderId===c.message.receiverId&&this.markMsgsAck([c.message]),c}))}modifyMessage(e,t){this.checkV2(),this.checkLogin(),validate(Am,e,"message",!0),validate(bm,t,"params",!0),this.modifyUtil.checkIfModify(e,t);var{messageBeforeSend:r,clientAntispamResult:i}=this.modifyUtil.prepareMessage(e,t);return this.modifyUtil.modifyMessage(r,i)}v2MessageOnModifiedHandler(e){var t=completeMessage(this.core,e.content.data);this.model.upsertMessages([t]),this.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",t),this.emit("onReceiveMessagesModified",[t])}v2MessageSyncModifiedHandler(e){var t=e.content.datas.map((e=>completeMessage(this.core,e))).filter((e=>{var t,r=(null===(t=this.model.getMessageById(e.messageClientId))||void 0===t?void 0:t.modifyTime)||0;return(e.modifyTime||0)>r}));t.length>0&&(this.model.upsertMessages(t),t.forEach((e=>this.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",e))),this.emit("onReceiveMessagesModified",t))}v2MessageSyncSuperTeamModifiedHandler(e){this.v2MessageSyncModifiedHandler(e)}},"V2NIMMessageService"),NIM.registerService(class V2NIMNotificationServiceImpl extends V2Service{constructor(e,t){super("V2NIMNotificationService",e),this.config={compatibleWithV1:!0},"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Ym,cmdConfig:zm}),this.setOptions(t))}setOptions(e){var t;(null===(t=this.core.systemMessage)||void 0===t?void 0:t.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Object.assign(this.config,e)}sendCustomNotification(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validateConversationId(this.core.account,e),validate(Km,{content:t,params:r},"",!0);var i=this.core.V2NIMConversationIdUtil.parseConversationType(e),n=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e),a={[Oe.V2NIM_CONVERSATION_TYPE_P2P]:100,[Oe.V2NIM_CONVERSATION_TYPE_TEAM]:101,[Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM]:103},s=Date.now(),o=i===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?"v2SendCustomNotificationWithSuperTeam":"v2SendCustomNotification";yield this.core.sendCmd(o,{tag:Object.assign(Object.assign({},r),{notificationConfig:Object.assign({unreadEnabled:!0,offlineEnabled:!0},null==r?void 0:r.notificationConfig),pushConfig:Object.assign({pushEnabled:!0,pushNickEnabled:!0},null==r?void 0:r.pushConfig),antispamConfig:Object.assign({antispamEnabled:!0},null==r?void 0:r.antispamConfig),routeConfig:Object.assign({routeEnabled:!0},null==r?void 0:r.routeConfig),timestamp:s,type:a[i],receiverId:n,content:t})})}))}processSystemNotification(e){var t=e.type;if(![0,1,2,3,4,15,16,17,18].includes(t)){[5,6].includes(t)&&this.core.eventBus.emit("V2NIMFriendService/sysNotification",e);var r={100:Oe.V2NIM_CONVERSATION_TYPE_P2P,101:Oe.V2NIM_CONVERSATION_TYPE_TEAM,102:Oe.V2NIM_CONVERSATION_TYPE_P2P,103:Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM},i=Object.assign(Object.assign({},e),{conversationType:r[t]});return delete i.type,i}this.core.eventBus.emit("V2NIMTeamService/sysNotification",e)}markBroadcastMsgAck(e){this.config.compatibleWithV1||this.core.sendCmd("v2BatchMarkRead",{sid:7,cid:17,ids:e.map((e=>e.id))})}syncBroadcastMsgHandler(e){var t=e.content.datas;this.markBroadcastMsgAck(t),this.emit("onReceiveBroadcastNotifications",t)}onBroadcastMsgHandler(e){var t=e.content.data;this.markBroadcastMsgAck([t]),this.emit("onReceiveBroadcastNotifications",[t])}onSysNotificationHandler(e){this.markSysNotificationAck([e.content.data]);var t=this.processSystemNotification(e.content.data);t&&this.emit("onReceiveCustomNotifications",[t])}v2SyncOfflineSysNotificationsHandler(e){this.markSysNotificationAck([e.content.datas]);var t=e.content.datas.sort(((e,t)=>e.timestamp-t.timestamp)).map((e=>this.processSystemNotification(e))).filter((e=>e));t&&this.emit("onReceiveCustomNotifications",t)}v2NotificationRevokeHandler(e){this.markSysNotificationAck([e.content.data])}v2NotificationSyncRevokeHandler(e){var{type:t}=e.content;1===parseInt(t)&&this.markSysNotificationAck(e.content.datas)}markSysNotificationAck(e){if(!this.config.compatibleWithV1){var t=[],r=[],i=[15,16,17,18,103];e.forEach((e=>{e.idServer&&(i.includes(e.type)?r.push(e.idServer):t.push(e.idServer))})),t.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:"7",cid:"3",ids:t}),r.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:"21",cid:"19",ids:r})}}},"V2NIMNotificationService"),NIM.registerService(class V2NIMStorageServiceImpl extends V2Service{constructor(e){super("V2NIMStorageService",e),this.sceneMap={nim_default_profile_icon:{sceneName:"nim_default_profile_icon",expireTime:0},nim_default_im:{sceneName:"nim_default_im",expireTime:0},nim_system_nos_scene:{sceneName:"nim_system_nos_scene",expireTime:0},nim_security:{sceneName:"nim_security",expireTime:0}},this.uploadingMessageInfo={},this.core=e}addCustomStorageScene(e,t){return this.checkV2(),validate({sceneName:{type:"string",allowEmpty:!1},expireTime:{type:"number",min:0}},{sceneName:e,expireTime:t},"",!0),this.sceneMap[e]={sceneName:e,expireTime:t},{sceneName:e,expireTime:t}}getStorageSceneList(){return this.checkV2(),Object.values(this.sceneMap)}getStorageScene(e){return e&&this.sceneMap[e]||this.sceneMap.nim_default_im}hasStorageScene(e){return void 0!==this.sceneMap[e]}createUploadFileTask(e){if(this.checkV2(),"string"==typeof e.fileObj&&0===e.fileObj.indexOf("nim-external")){var t=document.getElementById(e.fileObj);t&&t.files&&t.files[0]&&(e.fileObj=t.files[0])}return{taskId:Ii(),uploadParams:e}}uploadFile(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate({taskId:{type:"string",allowEmpty:!1}},e,"fileTask",!0),(yield this._uploadFile(e,t))[0]}))}_uploadFile(e,t,r){var i;return __awaiter(this,void 0,void 0,(function*(){if(!this.core.cloudStorage||!this.core.cloudStorage.uploadFile)throw new Error('Service "cloudStorage" does not exist');var{uploadParams:n,taskId:a}=e,{file:s,path:o}=getFileOrPath(n.fileObj),{fileType:c}=r||{};if(this.uploadingMessageInfo[a])throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST,detail:{reason:"V2NIMStorageService.uploadFile: repeat upload"}});try{var d={};s?d.file=s:o&&(0===(null==o?void 0:o.indexOf("nim-external"))?d.fileInput=o:d.filePath=o);var l=this.getStorageScene(n.sceneName);if(d.nosScenes=l.sceneName,d.nosSurvivalTime=l.expireTime,c===He.V2NIM_MESSAGE_TYPE_IMAGE?d.type="image":c===He.V2NIM_MESSAGE_TYPE_AUDIO?d.type="audio":c===He.V2NIM_MESSAGE_TYPE_VIDEO?d.type="video":d.type="file",d.file&&this.core.pluginMap["browser-md5-file"]){var m=yield this.getFileMd5(this.core.pluginMap["browser-md5-file"],a,d.file);d.md5=m}d.onUploadProgress=e=>{"function"==typeof t&&t(100*e.percentage)},d.onUploadStart=e=>{var t;if(null===(t=this.uploadingMessageInfo[a])||void 0===t?void 0:t.abort)return e.abort(),void delete this.uploadingMessageInfo[a];this.uploadingMessageInfo[a]={abort:!1,task:e}},this.uploadingMessageInfo[a]={abort:!1};var p=yield this.core.cloudStorage.uploadFile(d);if(null===(i=this.uploadingMessageInfo[a])||void 0===i?void 0:i.abort)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"upload file aborted"}});return delete this.uploadingMessageInfo[a],[p.url,p]}catch(e){throw delete this.uploadingMessageInfo[a],this.core.logger.error("sendFile:: upload File error or abort.",e),e}}))}cancelUploadFile(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),yield this._cancelUploadFile(e.taskId)}))}_cancelUploadFile(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var t=this.uploadingMessageInfo[e];if(null==t?void 0:t.task)try{this.logger.log("V2NIMStorageService.cancelUploadFile: uploadInfo task exist"),yield t.task.abort(),delete this.uploadingMessageInfo[e]}catch(t){delete this.uploadingMessageInfo[e],this.core.logger.error("cancelMessageAttachmentUpload::abort error.",t)}else{if(!t)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST,detail:{reason:"V2NIMStorageService.cancelUploadFile: uploadInfo not exist"}});this.logger.log("V2NIMStorageService.cancelUploadFile: uploadInfo task not exist"),t.abort=!0}}))}getFileMd5(e,t,r){return __awaiter(this,void 0,void 0,(function*(){return new Promise(((i,n)=>{var a,s=new e;(null===(a=this.uploadingMessageInfo[t])||void 0===a?void 0:a.abort)?n(new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"upload file aborted"}})):this.uploadingMessageInfo[t]={abort:!1,task:s};try{s.md5(r,((e,t)=>{"aborted"===e?n(new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:e}})):e?n(new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"md5 calculate error in callback",rawError:e}})):i(t)}))}catch(e){n(new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"md5 calculate error",rawError:e}}))}}))}))}shortUrlToLong(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.cloudStorage.getOriginUrl(e)}))}getImageThumbUrl(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.core.V2NIMStorageUtil.getImageThumbUrl(e,t)}))}getVideoCoverUrl(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.core.V2NIMStorageUtil.getVideoCoverUrl(e,t)}))}},"V2NIMStorageService"),NIM.registerService(class V2NIMStorageUtil extends V2Service{constructor(e){super("V2NIMStorageUtil",e),this.core=e}imageThumbUrl(e,t){return e+`?imageView&thumbnail=${t}z${t}`}videoCoverUrl(e,t){return e+`?vframe&offset=${t}`}getImageThumbUrl(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var r=e;validate(Yh,{attachment:r,thumbSize:t},"",!0),t.width=t.width||0,t.height=t.height||0,0===t.width&&0===t.height&&(t.width=150);var i=r.url;try{i=yield this.core.V2NIMStorageService.shortUrlToLong(r.url)}catch(e){this.core.logger.warn("shortUrlToLong error:",e)}return{url:this.core.cloudStorage.getThumbUrl(i,t)}}))}getVideoCoverUrl(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var r=e;validate(Yh,{attachment:r,thumbSize:t},"",!0),t.width=t.width||0,t.height=t.height||0,0===t.width&&0===t.height&&(t.width=150);var i=r.url;try{i=yield this.core.V2NIMStorageService.shortUrlToLong(r.url)}catch(e){this.core.logger.warn("shortUrlToLong error:",e)}return{url:this.core.cloudStorage.getVideoCoverUrl(i,t)}}))}},"V2NIMStorageUtil"),NIM.registerService(class V2NIMTeamServiceImpl extends V2Service{constructor(e){super("V2NIMTeamService",e),this.notification=new V2NIMTeamNotificationImpl(e,this),this.model=new V2NIMTeamModelImpl,this.memberModel=new V2NIMTeamMemberModelImpl,this.notificationModel=new V2NIMTeamNotificationModelImpl,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:vl,cmdConfig:El}),this.setListener())}setListener(){this.core.eventBus.on("forwardReceive/V2NIMTeamService/created",(e=>{this.model.upsert(e);var t=generateMemberByTeamId(e.teamId,e.teamType,this.core.account,{memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_OWNER});this.memberModel.upsert(t),this.emit("onTeamCreated",e)})),this.core.eventBus.on("forwardReceive/V2NIMTeamService/updateSelfTeamMemberInfo",(e=>{this.memberModel.upsert(e),this.emit("onTeamInfoUpdated",[e])})),this.core.eventBus.on("forwardReceive/V2NIMTeamService/updateTeamActionStatus",this.notification.updateTeamActionStatus.bind(this.notification)),this.core.eventBus.on("V2NIMTeamService/sysNotification",this.notification.processSysNotification.bind(this.notification)),this.core.eventBus.on("V2NIMTeamService/notification",this.notification.processNotification.bind(this.notification)),this.core.eventBus.on("V2NIMTeamService/onSyncStarted",(()=>{this.emit("onSyncStarted")})),this.core.eventBus.on("V2NIMTeamService/onSyncFinished",(()=>{this.emit("onSyncFinished")})),this.core.eventBus.on("V2NIMTeamService/onSyncFailed",(e=>{this.emit("onSyncFailed",e)}))}reset(){this.model.reset(),this.memberModel.reset(),this.notificationModel.reset()}createTeam(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({createTeamParams:Qm},{createTeamParams:e},"",!0),validate({inviteeAccountIds:Object.assign(Object.assign({},Xm),{min:0,required:!1})},{inviteeAccountIds:t},"",!0),validate({antispamConfig:rp},{antispamConfig:i},"",!0);var n=e.teamType===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamCreate":"v2TeamCreate",a=yield this.core.sendCmd(n,{team:e,inviteeAccountIds:t||[],postscript:r||"",antispamConfig:i}),s=a.content.team;this.model.upsert(s);var o=generateMemberByTeamId(s.teamId,s.teamType,this.core.account,{memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_OWNER});return this.memberModel.upsert(o),this.emit("onTeamCreated",s),{team:s,failedList:a.content.failedList}}))}updateTeamInfo(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate(op,{updateTeamInfoParams:r},"",!0),validate({antispamConfig:rp},{antispamConfig:i},"",!0);var n=Object.assign({teamId:e,teamType:t},r),a=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamUpdateInfo":"v2TeamUpdateInfo";yield this.core.sendCmd(a,{team:n,antispamConfig:i}),this.model.upsert(n)}))}leaveTeam(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0);var r=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamLeave":"v2TeamLeave";yield this.core.sendCmd(r,{teamId:e}),this.model.deleteById(e,t)}))}getTeamInfo(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0);var r=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamGetInfo":"v2TeamGetInfo",i=this.model.getById(e,t,!1);if(i)return i;var n=(yield this.core.sendCmd(r,{teamId:e})).content.team;return this.model.upsert(n),n}))}getJoinedTeamList(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(sp,{teamTypes:e},"",!0),this.core.V2NIMLoginService.checkIllegalState(),e&&0!==e.length||(e=[at.V2NIM_TEAM_TYPE_ADVANCED,at.V2NIM_TEAM_TYPE_SUPER]);var t=[];return e.forEach((e=>{t=t.concat(this.model.getAll(e))})),t.sort(((e,t)=>e.createTime-t.createTime))}))}getJoinedTeamCount(e){this.checkV2(),validate(sp,{teamTypes:e},"",!0),this.core.V2NIMLoginService.checkIllegalState(),e&&0!==e.length||(e=[at.V2NIM_TEAM_TYPE_ADVANCED,at.V2NIM_TEAM_TYPE_SUPER]);var t=0;return e.forEach((e=>{t+=this.model.count(e)})),t}getTeamInfoByIds(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(np,{teamIds:e},"",!0),validate(ap,{teamType:t},"",!0);var r=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamGetByIds":"v2TeamGetByIds",i=e.map((e=>this.model.getById(e,t,!1))),n=e.filter(((e,t)=>!i[t]));if(0===n.length)return i;var a=(yield this.core.sendCmd(r,{teamIds:n})).content.teams;return i.map(((t,r)=>{if(t)return t;var i=e[r],n=a.find((e=>e.teamId===i));return n&&this.model.upsert(n),n})).filter((e=>!!e))}))}dismissTeam(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0);var r=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamDismiss":"v2TeamDismiss";yield this.core.sendCmd(r,{teamId:e})}))}inviteMember(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate({inviteeAccountIds:Xm},{inviteeAccountIds:r},"",!0),validate({postscript:Object.assign(Object.assign({},ep),{required:!1})},{postscript:i},"",!0);var n=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamInviteMembers":"v2TeamInviteMembers";return(yield this.core.sendCmd(n,{teamId:e,accounts:r,ps:i||""})).content.abortedAccidList}))}acceptInvitation(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(up,e,"invitationInfo",!0),validate(hp,e,"invitationInfo",!0);var{teamType:t,teamId:r,operatorAccountId:i}=e,n=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamAcceptInvitation":"v2TeamAcceptInvitation";try{var a=yield this.core.sendCmd(n,{teamId:r,from:i});return this.notification.updateTeamActionStatus(e,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED),a.content.team}catch(t){var s=t;throw this.notification.checkIfExpired(s.code)&&this.notification.updateTeamActionStatus(e,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED),t}}))}rejectInvitation(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(up,e,"invitationInfo",!0),validate(hp,e,"invitationInfo",!0),validate({postscript:Object.assign(Object.assign({},ep),{required:!1})},{postscript:t},"",!0);var{teamType:r,teamId:i,operatorAccountId:n}=e,a=r===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamRejectInvite":"v2TeamRejectInvite";try{yield this.core.sendCmd(a,{teamId:i,from:n,ps:t||""}),this.notification.updateTeamActionStatus(e,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED)}catch(t){var s=t;throw this.notification.checkIfExpired(s.code)&&this.notification.updateTeamActionStatus(e,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED),t}}))}kickMember(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate({memberAccountIds:Xm},{memberAccountIds:r},"",!0);var i=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamKickMembers":"v2TeamKickMembers";yield this.core.sendCmd(i,{teamId:e,accounts:r})}))}applyJoinTeam(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0);var i=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamApplyToJoin":"v2TeamApplyToJoin";return(yield this.core.sendCmd(i,{teamId:e,ps:r||""})).content.team}))}acceptJoinApplication(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(up,e,"applicationInfo",!0),validate(gp,e,"applicationInfo",!0);var{teamType:t,teamId:r,operatorAccountId:i}=e,n=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamAcceptJoinApplication":"v2TeamAcceptJoinApplication";try{yield this.core.sendCmd(n,{teamId:r,from:i}),this.notification.updateTeamActionStatus(e,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED)}catch(t){var a=t;throw this.notification.checkIfExpired(a.code)&&this.notification.updateTeamActionStatus(e,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED),t}}))}rejectJoinApplication(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(up,e,"applicationInfo",!0),validate(gp,e,"applicationInfo",!0),validate({postscript:Object.assign(Object.assign({},ep),{required:!1})},{postscript:t},"",!0);var{teamType:r,teamId:i,operatorAccountId:n}=e,a=r===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamRejectJoinApplication":"v2TeamRejectJoinApplication";try{yield this.core.sendCmd(a,{teamId:i,from:n,ps:t||""}),this.notification.updateTeamActionStatus(e,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED)}catch(t){var s=t;throw this.notification.checkIfExpired(s.code)&&this.notification.updateTeamActionStatus(e,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED),t}}))}updateTeamMemberRole(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate({memberAccountIds:Xm},{memberAccountIds:r},"",!0),validate({memberRole:cp},{memberRole:i},"",!0);var n=i===ut.V2NIM_TEAM_MEMBER_ROLE_MANAGER?"AddManagers":"RemoveManagers";n=t===at.V2NIM_TEAM_TYPE_SUPER?`v2SuperTeam${n}`:`v2Team${n}`,yield this.core.sendCmd(n,{teamId:e,accounts:r})}))}transferTeamOwner(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate({accountId:tp},{accountId:r},"",!0),validate({leave:{type:"boolean",required:!1}},{leave:i},"",!0);var n=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamTransferOwner":"v2TeamTransferOwner";yield this.core.sendCmd(n,{teamId:e,account:r,leave:i||!1})}))}updateSelfTeamMemberInfo(e,t,r){var i;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate(dp,{memberInfoParams:r},"",!0),void 0===r.teamNick&&void 0===r.serverExtension)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER});var n=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamUpdateSelfMemberInfo":"v2TeamUpdateSelfMemberInfo",a=Object.assign(Object.assign({},r),{teamId:e,accountId:this.core.account});yield this.core.sendCmd(n,{teamMember:a}),yield this.notification.updateTeamMemberRole(e,t,[this.core.account],a);var s=this.memberModel.getById(e,t,this.core.account);if(null===(i=this.core.V2NIMSettingService)||void 0===i?void 0:i.name){var o=t===at.V2NIM_TEAM_TYPE_ADVANCED?this.core.V2NIMConversationIdUtil.teamConversationId(e):this.core.V2NIMConversationIdUtil.superTeamConversationId(e),c=this.core.V2NIMSettingService.getConversationMuteStatus(o);this.core.eventBus.emit("V2NIMConversationService/setMute",o,c)}this.core.eventBus.emit("forwardSend/V2NIMTeamService/updateSelfTeamMemberInfo",s)}))}updateTeamMemberNick(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate({accountId:tp},{accountId:r},"",!0),validate({nick:ep},{nick:i},"",!0),r===this.core.account)return this.updateSelfTeamMemberInfo(e,t,{teamNick:i});var n=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamUpdateMember":"v2TeamUpdateMember";yield this.core.sendCmd(n,{teamMember:{teamNick:i,teamId:e,accountId:r}})}))}setTeamChatBannedMode(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate(mp,{chatBannedMode:r},"",!0);var i=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamSetChatBannedMode":"v2TeamSetChatBannedMode";yield this.core.sendCmd(i,{teamId:e,chatBannedMode:r}),this.model.upsert({teamId:e,teamType:t,chatBannedMode:r})}))}setTeamMemberChatBannedStatus(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate({accountId:tp},{accountId:r},"",!0),validate({chatBanned:Zm},{chatBanned:i},"",!0);var n=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamMemberSetChatBannedStatus":"v2TeamMemberSetChatBannedStatus";yield this.core.sendCmd(n,{teamId:e,accountId:t===at.V2NIM_TEAM_TYPE_SUPER?[r]:r,chatBanned:i?1:0})}))}getTeamMemberList(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate(pp,{queryOption:r},"",!0);var i=void 0===r.direction?ze.V2NIM_QUERY_DIRECTION_DESC:r.direction;i=i===ze.V2NIM_QUERY_DIRECTION_DESC?1:0;var n=yield this.core.sendCmd("v2TeamMemberGetList",{tag:Object.assign(Object.assign({teamId:e,teamType:t,onlyChatBanned:!1,nextToken:"",limit:100},r),{direction:i})});return{nextToken:n.content.pageInfo.nextToken||"",finished:!+n.content.pageInfo.hasMore,memberList:processTeamMembers(n.content.datas,t)}}))}getTeamMemberListByIds(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate({accountIds:Xm},{accountIds:r},"",!0);for(var i=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamMemberGetListByIds":"v2TeamMemberGetListByIds",n=r.filter((r=>!this.memberModel.getById(e,t,r))).map((t=>`${e}|${t}`)),a=0;a<n.length;a+=20){processTeamMembers((yield this.core.sendCmd(i,{tag:n.slice(a,a+20)})).content.datas,t).forEach((e=>this.memberModel.upsert(e)))}return r.map((r=>this.memberModel.getById(e,t,r))).filter((e=>!!e))}))}getTeamMemberInvitor(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate({accountIds:Xm},{accountIds:r},"",!0);var i=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamGetMemberInvitor":"v2TeamGetMemberInvitor";return(yield this.core.sendCmd(i,{teamId:e,accounts:r})).content.accountsMap}))}searchTeamByKeyword(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.checkLogin(),validate({keyword:tp},{keyword:e},"",!0),this.model.searchTeamByKeyword(e)}))}getTeamJoinActionInfoList(e){return this.checkV2(),validate(vp,e,"option",!0),this.core.V2NIMLoginService.checkIllegalState(),Promise.resolve(this.notificationModel.getByOption(e))}v2TeamSyncHandler(e){this.model.set(e.content.datas)}v2SuperTeamSyncHandler(e){this.model.set(e.content.datas)}v2TeamCreateMultiSyncHandler(e){var t=e.content.data;this.model.upsert(t);var r=generateMemberByTeamId(t.teamId,t.teamType,this.core.account,{memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_OWNER});this.memberModel.upsert(r),this.emit("onTeamCreated",t)}v2SuperTeamCreateMultiSyncHandler(e){var t=e.content.data;this.model.upsert(t);var r=generateMemberByTeamId(t.teamId,t.teamType,this.core.account,{memberRole:ut.V2NIM_TEAM_MEMBER_ROLE_OWNER});this.memberModel.upsert(r),this.emit("onTeamCreated",t)}v2TeamMemberUpdateMultiSyncHandler(e){var t=e.content.data;t.teamType=at.V2NIM_TEAM_TYPE_ADVANCED;var r=this.memberModel.getById(t.teamId,t.teamType,t.accountId);this.notification.updateTeamMemberRole(t.teamId,t.teamType,[t.accountId],t),t.accountId===this.core.account&&r&&r.bits!==t.bits&&this.core.eventBus.emit("V2NIMSettingService/updateBits",t.teamId,t.teamType,t.bits)}v2SuperTeamMemberUpdateMultiSyncHandler(e){var t=e.content.data;t.teamType=at.V2NIM_TEAM_TYPE_SUPER;var r=this.memberModel.getById(t.teamId,t.teamType,t.accountId);this.notification.updateTeamMemberRole(t.teamId,t.teamType,[t.accountId],t),t.accountId===this.core.account&&r&&r.bits!==t.bits&&this.core.eventBus.emit("V2NIMSettingService/updateBits",t.teamId,t.teamType,t.bits)}v2TeamMembersOfSelfInSyncHandler(e){var t=e.content.datas;t.forEach((e=>{e.teamType=at.V2NIM_TEAM_TYPE_ADVANCED})),this.memberModel.setData(t)}v2SuperTeamMembersOfSelfInSyncHandler(e){var t=e.content.datas;t.forEach((e=>{e.teamType=at.V2NIM_TEAM_TYPE_SUPER})),this.memberModel.setData(t)}},"V2NIMTeamService"),NIM.registerService(class V2NIMUserServiceImpl extends V2Service{constructor(e){super("V2NIMUserService",e),registerParser({cmdMap:Ip,cmdConfig:Mp}),this.model=new V2NIMUserModelImpl,"v2"===this.core.options.apiVersion&&this.setListener()}reset(){this.model.reset()}setListener(){this.core.eventBus.on("forwardReceive/V2NIMUserService/updateBlockList",((e,t)=>{t?this.model.addToBlockList([e]):this.model.removeFromBlockList([e]),t?this.emitBlockListAdded(e):this.emit("onBlockListRemoved",e)})),this.core.eventBus.on("forwardReceive/V2NIMUserService/updateUserProfile",(e=>{this.updateUserProfileInMemory(e)}))}getUserList(e){var t;return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({accountIds:Xm},{accountIds:e},"",!0);var r=[];e.forEach((e=>{this.model.getUser(e)||r.push(e)}));var i=null;r.length>0&&(i=yield this.core.sendCmd("v2GetUserList",{accountIds:r})),((null===(t=null==i?void 0:i.content)||void 0===t?void 0:t.data)||[]).forEach((e=>{this.model.setUser(e)}));var n=[];return e.forEach((e=>{var t=this.model.getUser(e);t&&n.push(t)})),n}))}getUserListFromCloud(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({accountIds:{type:"array",min:1,max:500,itemType:"string"}},{accountIds:e},"",!0);var t=(yield this.core.sendCmd("v2GetUserList",{accountIds:e})).content.data||[],r=[];t.forEach((e=>{var t=this.model.getUser(e.accountId);this.compareUserForUpdate(t,e)&&r.push(e),this.model.setUser(e)}));var i=e.reduce(((e,t)=>{var r=this.model.getUser(t);return r&&e.push(r),e}),[]);return r.length>0&&this.emit("onUserProfileChanged",r),i}))}compareUserForUpdate(e,t){return!e||!("number"==typeof e.updateTime&&"number"==typeof t.updateTime&&e.updateTime>=t.updateTime)}updateSelfUserProfile(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Ep,e,"",!0);var t=yield this.core.sendCmd("v2UpdateSelfUserProfile",{tag:Object.assign(Object.assign({},e),{accountId:this.core.account})});yield this.updateUserProfileInMemory(Object.assign({updateTime:t.content.updateTime},e))}))}addUserToBlockList(e){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),e===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot block yourself"}});validate({accountId:fp},{accountId:e},"",!0),yield this.core.sendCmd("v2UpdateBlockList",{accountId:e,addToBlockList:!0}),this.model.addToBlockList([e]),this.emitBlockListAdded(e)}))}removeUserFromBlockList(e){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),e===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot unblock yourself"}});validate({accountId:fp},{accountId:e},"",!0),yield this.core.sendCmd("v2UpdateBlockList",{accountId:e,addToBlockList:!1}),this.model.removeFromBlockList([e]),this.emit("onBlockListRemoved",e)}))}searchUserByOption(e){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({keyword:{type:"string",allowEmpty:!1},searchName:{type:"boolean",required:!1},searchAccountId:{type:"boolean",required:!1},searchMobile:{type:"boolean",required:!1}},e,"",!0),!1===(void 0===e.searchName||e.searchName)&&!e.searchAccountId&&!e.searchMobile)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"one of searchName, searchAccountId, searchMobile must be true"}});return this.model.getUserListBySearchOption(e)}))}getBlockList(){return this.checkV2(),Promise.resolve(this.model.blockList)}updateUserProfileInMemory(e){return __awaiter(this,void 0,void 0,(function*(){var t=this.model.getUser(this.core.account);t?(Object.assign(t,e),this.model.setUser(t)):t=(yield this.getUserList([this.core.account]))[0];t&&this.emit("onUserProfileChanged",[t])}))}onUpdateUserProfileHandler(e){return __awaiter(this,void 0,void 0,(function*(){var t=e.content.data;yield this.updateUserProfileInMemory(t)}))}onUpdateBlockListHandler(e){var t=e.content.accountId;e.content.addToBlockList?(this.model.addToBlockList([t]),this.emitBlockListAdded(t)):(this.model.removeFromBlockList([t]),this.emit("onBlockListRemoved",t))}syncBlockAndMuteListHandler(e){e.content.data.forEach((e=>{e.isBlock?this.model.addToBlockList([e.accountId]):this.model.setAccountMuteMode(e.accountId,e.isMute?it.V2NIM_P2P_MESSAGE_MUTE_MODE_ON:it.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF)}))}v2SyncSelfUserInfoHandler(e){var t=e.content.user;this.model.setUser(t)}checkUserUpdate(e,t){var r=e.senderId;if(r!==this.core.account){var i=this.model.getUser(r);if(i){var n=i.updateTime;"number"==typeof n&&"number"==typeof t&&!isNaN(n)&&!isNaN(t)&&n<t&&this.refreshUserInfo(r)}else this.refreshUserInfo(r)}}refreshUserInfo(e){var t;return __awaiter(this,void 0,void 0,(function*(){var r=yield this.core.sendCmd("v2GetUserList",{accountIds:[e]}),i=(null===(t=null==r?void 0:r.content)||void 0===t?void 0:t.data)||[];for(var n of i)this.model.setUser(n),this.emit("onUserProfileChanged",[n])}))}emitBlockListAdded(e){return __awaiter(this,void 0,void 0,(function*(){var t=yield this.getUserList([e]);1===t.length&&this.emit("onBlockListAdded",t[0])}))}v2OnUpdateMuteListHandler(e){return __awaiter(this,void 0,void 0,(function*(){var{accountId:t,mute:r}=e.content,i=r?it.V2NIM_P2P_MESSAGE_MUTE_MODE_ON:it.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF;this.core.eventBus.emit("v2NIMUserService/updateMuteList",t,i)}))}},"V2NIMUserService"),NIM.registerService(class V2NIMUFriendServiceImpl extends V2Service{constructor(e){super("V2NIMFriendService",e),this.notification=new V2NIMFriendNotificationImpl(this.core,this),this.model=new V2NIMFriendModelImpl,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Cp,cmdConfig:Ap}),this.setListener())}reset(){this.model.reset()}setListener(){this.core.eventBus.on("V2NIMFriendService/sysNotification",this.notification.processSysNotification.bind(this.notification)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/addFriend",this.handleAddFriend.bind(this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/deleteFriend",this.handleDeleteFriend.bind(this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/setFriendInfo",this.handleSetFriendInfo.bind(this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/acceptAddApplication",this.handlePassFriendApply.bind(this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/rejectAddApplication",this.handleRejectFriendApply.bind(this))}addFriend(e,t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),e===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot add yourself"}});validate(bp,{accountId:e,params:t},"",!0),yield this.core.sendCmd("v2AddFriend",{accountId:e,verifyType:t.addMode,postscript:t.postscript||""}),t.addMode===Ve.V2NIM_FRIEND_MODE_TYPE_ADD&&(yield this.handleAddFriend(e))}))}deleteFriend(e,t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),e===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot delete yourself"}});validate(Rp,{accountId:e,params:t},"",!0),yield this.core.sendCmd("v2DeleteFriend",{accountId:e,params:t}),t.deleteAlias&&this.model.upsertFriend(e,{alias:""}),this.handleDeleteFriend(e)}))}acceptAddApplication(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Pp,e,"",!0);try{yield this.core.sendCmd("v2AddFriend",{accountId:e.applicantAccountId,verifyType:De.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT,postscript:""}),this.handlePassFriendApply(e.applicantAccountId)}catch(t){throw this.handlePassFriendApply(e.applicantAccountId,t),t}}))}rejectAddApplication(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Pp,e,"",!0);try{yield this.core.sendCmd("v2AddFriend",{accountId:e.applicantAccountId,verifyType:De.V2NIM_FRIEND_VERIFY_TYPE_REJECT,postscript:t||""}),this.handleRejectFriendApply({applicantAccountId:e.applicantAccountId,recipientAccountId:e.recipientAccountId,operatorAccountId:this.core.account,postscript:t||"",timestamp:this.core.timeOrigin.getNTPTime(),read:!0,status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED})}catch(r){throw this.handleRejectFriendApply({applicantAccountId:e.applicantAccountId,recipientAccountId:e.recipientAccountId,operatorAccountId:this.core.account,postscript:t||"",timestamp:this.core.timeOrigin.getNTPTime(),read:!0,status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED},r),r}}))}setFriendInfo(e,t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Op,{accountId:e,params:t},"",!0),e===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot set yourself"}});yield this.core.sendCmd("v2SetFriendInfo",{tag:Object.assign({accountId:e},t)}),this.handleSetFriendInfo(e,t)}))}getFriendList(){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),Promise.resolve(this.computedFields(this.model.getFriendList()))}))}getFriendByIds(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({accountIds:{type:"array",itemType:"string",required:!0,min:1}},{accountIds:e},"",!0),Promise.resolve(this.computedFields(this.model.getFriendByIds(e)))}))}checkFriend(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({accountIds:{type:"array",itemType:"string",required:!0,min:1}},{accountIds:e},"",!0);var t={};return e.forEach((e=>{t[e]=!!this.model.getFriend(e)})),Promise.resolve(t)}))}getAddApplicationList(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate(Vp,e,"",!0),Promise.resolve(this.model.getAddApplicationList(e))}))}setAddApplicationRead(){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),this.model.setAddApplicationRead()}))}getAddApplicationUnreadCount(){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),Promise.resolve(this.model.getAddApplicationUnreadCount())}))}searchFriendByOption(e){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({keyword:{type:"string",allowEmpty:!1},searchAccountId:{type:"boolean",required:!1}},e,"",!0),!(void 0===e.searchAlias||e.searchAlias)&&!e.searchAccountId)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"searchAlias and searchAccountId cannot be false at the same time"}});return this.computedFields(this.model.getFriendListBySearchOption(e))}))}v2OnAddFriendHandler(e){var{accountId:t,verifyType:r,postscript:i}=e.content;if(r===De.V2NIM_FRIEND_VERIFY_TYPE_ADD)this.handleAddFriend(t);else if(r===De.V2NIM_FRIEND_VERIFY_TYPE_APPLY){var n={applicantAccountId:this.core.account,recipientAccountId:t,operatorAccountId:this.core.account,postscript:i,timestamp:this.core.timeOrigin.getNTPTime(),status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT,read:!1};this.handleApplyFriend(n)}else if(r===De.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT)this.handlePassFriendApply(t);else if(r===De.V2NIM_FRIEND_VERIFY_TYPE_REJECT){var a={applicantAccountId:t,recipientAccountId:this.core.account,operatorAccountId:this.core.account,postscript:i,timestamp:this.core.timeOrigin.getNTPTime(),status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED,read:!0};this.handleRejectFriendApply(a)}}v2OnDeleteFriendHandler(e){var{accountId:t}=e.content;this.handleDeleteFriend(t)}v2OnUpdateFriendInfoHandler(e){var{data:t}=e.content,r=this.model.upsertFriend(t.accountId,t);this.emit("onFriendInfoChanged",r)}v2SyncFriendListHandler(e){var{friends:t,timetag:r}=e.content;this.model.setFriendTimetag(r),t.forEach((e=>{e.serverExtension||(e.serverExtension=""),e.customerExtension||(e.customerExtension=""),this.model.upsertFriend(e.accountId,e)}))}v2SyncFriendUserListHandler(e){var{users:t}=e.content;this.core.V2NIMUserService.model&&t.forEach((e=>{this.core.V2NIMUserService.model.setUser(e)}))}handleApplyFriend(e){this.emit("onFriendAddApplication",e)}handleAddFriend(e,t){return __awaiter(this,void 0,void 0,(function*(){this.model.addFriend(e),yield this.incrementSyncFriend();var t=this.model.getFriend(e);t&&this.emit("onFriendAdded",this.computedField(t))}))}handleDeleteFriend(e,t){t=void 0===t?Le.V2NIM_FRIEND_DELETION_TYPE_BY_SELF:t,this.emit("onFriendDeleted",e,t),this.model.deleteFriend(e)}handleSetFriendInfo(e,t){var r=this.model.upsertFriend(e,t);this.emit("onFriendInfoChanged",this.computedField(r))}handlePassFriendApply(e,t){var r=t?null==t?void 0:t.code:200;if(!(r>=19e4||r===Ct.V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT))if(200===r||r===Ct.V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST)this.model.updateFriendAddApplicationStatus(e,we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED,this.core.account),this.handleAddFriend(e);else{if(r>=500&&r<=599&&509!==r)return;this.model.updateFriendAddApplicationStatus(e,we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED,this.core.account)}}handleRejectFriendApply(e,t){var r=t?null==t?void 0:t.code:200;if(!(r>=19e4||r===Ct.V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT))if(200===r)this.emit("onFriendAddRejected",e),this.model.updateFriendAddApplicationStatus(e.applicantAccountId,we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED,this.core.account);else if(r===Ct.V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST)this.model.updateFriendAddApplicationStatus(e.applicantAccountId,we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED,this.core.account);else{if(r>=500&&r<=599&&509!==r)return;this.model.updateFriendAddApplicationStatus(e.applicantAccountId,we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED,this.core.account)}}incrementSyncFriend(){return __awaiter(this,void 0,void 0,(function*(){var e=yield this.core.sendCmd("v2IncFriendInfo",{timetag:this.model.getFriendTimetag()}),{friends:t,timetag:r}=e.content;this.model.setFriendTimetag(r),t.forEach((e=>{this.model.upsertFriend(e.accountId,e)}))}))}computedFields(e){return e.map((e=>this.computedField(e)))}computedField(e){var t,r,i=null===(r=null===(t=this.core.V2NIMUserService)||void 0===t?void 0:t.model)||void 0===r?void 0:r.getUser(e.accountId);return i?Object.assign({},e,{userProfile:i}):e}},"V2NIMFriendService"),NIM.registerService(class V2NIMSettingServiceImpl extends V2Service{constructor(e){super("V2NIMSettingService",e),this.offlinePushPlugin=void 0,this.offlinePushConfig=void 0,this.appBackgroundOptions={badge:0,isBackground:!1},this.p2pMessageMuteModeChangeHandler=(e,t)=>{this.emit("onP2PMessageMuteModeChanged",e,t),this.core.V2NIMUserService.model.setAccountMuteMode(e,t);var r=this.core.V2NIMConversationIdUtil.p2pConversationId(e),i=t===it.V2NIM_P2P_MESSAGE_MUTE_MODE_ON;this.core.eventBus.emit("V2NIMConversationService/setMute",r,i)},this.setTokenAndBackgroundStateAfterLogin=e=>{this.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin"),this.offlinePushPlugin&&(this.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin plugin is provided"),this.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin pushType is: ",e&&e.pushType),this.regToken(e),this.core.sendCmd("v2SetAppBackground",{isBackground:this.appBackgroundOptions.isBackground,badge:this.appBackgroundOptions.badge||0}))},"v2"===this.core.options.apiVersion&&(this.setListener(),registerParser({cmdMap:qp,cmdConfig:xp}))}setListener(){this.core.eventBus.on("V2NIMSettingService/updateBits",((e,t,r)=>{this.emit("onTeamMessageMuteModeChanged",e,t,r)})),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",this.setTokenAndBackgroundStateAfterLogin),this.core.eventBus.on("v2NIMUserService/updateMuteList",this.p2pMessageMuteModeChangeHandler),this.core.eventBus.on("forwardReceive/v2NIMSettingService/setP2PMessageMuteMode",this.p2pMessageMuteModeChangeHandler)}getConversationMuteStatus(e){if("string"!=typeof e)return!1;var t=this.core.V2NIMConversationIdUtil.parseConversationType(e),r=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e);return t===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM?this.getTeamMessageMuteMode(r,at.V2NIM_TEAM_TYPE_SUPER)!==rt.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF:t===Oe.V2NIM_CONVERSATION_TYPE_TEAM?this.getTeamMessageMuteMode(r,at.V2NIM_TEAM_TYPE_ADVANCED)!==rt.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF:t===Oe.V2NIM_CONVERSATION_TYPE_P2P&&!!this.core.V2NIMUserService.model.muteList.has(r)}setTeamMessageMuteMode(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(ip,{teamId:e},"",!0),validate(ap,{teamType:t},"",!0),validate(kp,{muteMode:r},"",!0);var i=t===at.V2NIM_TEAM_TYPE_SUPER?"v2SuperTeamUpdateSelfMemberInfo":"v2TeamUpdateSelfMemberInfo",n={teamId:e,teamType:t,accountId:this.core.account,bits:r};yield this.core.sendCmd(i,{teamMember:n}),this.core.V2NIMTeamService.memberModel.upsert(n),this.emit("onTeamMessageMuteModeChanged",e,t,r);var a=t===at.V2NIM_TEAM_TYPE_ADVANCED?this.core.V2NIMConversationIdUtil.teamConversationId(e):this.core.V2NIMConversationIdUtil.superTeamConversationId(e),s=this.core.V2NIMSettingService.getConversationMuteStatus(a);this.core.eventBus.emit("V2NIMConversationService/setMute",a,s)}))}getTeamMessageMuteMode(e,t){var r;return"string"!=typeof e||"number"!=typeof t?0:3&((null===(r=this.core.V2NIMTeamService.memberModel.getById(e,t,this.core.account))||void 0===r?void 0:r.bits)||0)}setP2PMessageMuteMode(e,t){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(wp,{accountId:e,muteMode:t},"",!0),e===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"can not set mute mode for self"}});yield this.core.sendCmd("v2SetP2PMessageMuteMode",{accountId:e,muteMode:t===it.V2NIM_P2P_MESSAGE_MUTE_MODE_ON}),this.p2pMessageMuteModeChangeHandler(e,t)}))}getP2PMessageMuteMode(e){return validate({accountId:{type:"string",required:!0,allowEmpty:!1}},{accountId:e},"",!0),this.core.V2NIMUserService.model.muteList.has(e)?it.V2NIM_P2P_MESSAGE_MUTE_MODE_ON:it.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF}getP2PMessageMuteList(){return __awaiter(this,void 0,void 0,(function*(){return Promise.resolve(Array.from(this.core.V2NIMUserService.model.muteList))}))}setAppBackground(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({isBackground:{type:"boolean"},badge:{type:"number",required:!1}},{isBackground:e,badge:t},"",!0),this.appBackgroundOptions={isBackground:e,badge:t||0},yield this.core.sendCmd("v2SetAppBackground",{isBackground:e,badge:t||0})}))}setPushMobileOnDesktopOnline(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate({need:{type:"boolean",required:!1}},{need:e},"",!0),e=void 0===e||e,yield this.core.sendCmd("v2SetPushMobileOnDesktopOnline",{tag:{need:e}})}))}setOfflinePushConfig(e,t){validate(Dp,{config:t},"",!0),this.offlinePushPlugin=e,this.offlinePushConfig=t}regToken(e){var t,r,i,n,a,s,o,c,d,l,m,p,u,h,g,v,y,I,_,M,f,T,E,S,C,N,A,b,R,O,P,V,k,w,L,D,U=Xr.getSystemInfo()||{},q=U.os?U.os.toLowerCase():"";if(this.logger.log("OfflinePushService: os",q),"ios"===q||"android"===q)if(this.offlinePushPlugin&&"function"==typeof this.offlinePushPlugin.getDeviceToken){var x="";e&&e.pushType?x=e.pushType:"ios"===q?x="":"android"===q&&(x="8"),this.logger.log("OfflinePushService:: prepare to get device token. suggestPushType: "+x);var B={xmAppId:null===(r=null===(t=this.offlinePushConfig)||void 0===t?void 0:t.miPush)||void 0===r?void 0:r.appId,xmAppKey:null===(n=null===(i=this.offlinePushConfig)||void 0===i?void 0:i.miPush)||void 0===n?void 0:n.appKey,xmCertificateName:null===(s=null===(a=this.offlinePushConfig)||void 0===a?void 0:a.miPush)||void 0===s?void 0:s.certificateName,hwAppId:null===(c=null===(o=this.offlinePushConfig)||void 0===o?void 0:o.hwPush)||void 0===c?void 0:c.appId,hwCertificateName:null===(l=null===(d=this.offlinePushConfig)||void 0===d?void 0:d.hwPush)||void 0===l?void 0:l.certificateName,oppoAppId:null===(p=null===(m=this.offlinePushConfig)||void 0===m?void 0:m.oppoPush)||void 0===p?void 0:p.appId,oppoAppKey:null===(h=null===(u=this.offlinePushConfig)||void 0===u?void 0:u.oppoPush)||void 0===h?void 0:h.appKey,oppoAppSecret:null===(v=null===(g=this.offlinePushConfig)||void 0===g?void 0:g.oppoPush)||void 0===v?void 0:v.secret,oppoCertificateName:null===(I=null===(y=this.offlinePushConfig)||void 0===y?void 0:y.oppoPush)||void 0===I?void 0:I.certificateName,vivoAppId:null===(M=null===(_=this.offlinePushConfig)||void 0===_?void 0:_.vivoPush)||void 0===M?void 0:M.appId,vivoAppKey:null===(T=null===(f=this.offlinePushConfig)||void 0===f?void 0:f.vivoPush)||void 0===T?void 0:T.appKey,vivoCertificateName:null===(S=null===(E=this.offlinePushConfig)||void 0===E?void 0:E.vivoPush)||void 0===S?void 0:S.certificateName,fcmCertificateName:null===(N=null===(C=this.offlinePushConfig)||void 0===C?void 0:C.fcmPush)||void 0===N?void 0:N.certificateName,mzAppId:null===(b=null===(A=this.offlinePushConfig)||void 0===A?void 0:A.mzPush)||void 0===b?void 0:b.appId,mzAppKey:null===(O=null===(R=this.offlinePushConfig)||void 0===R?void 0:R.mzPush)||void 0===O?void 0:O.appKey,mzCertificateName:null===(V=null===(P=this.offlinePushConfig)||void 0===P?void 0:P.mzPush)||void 0===V?void 0:V.certificateName,apnsCertificateName:null===(w=null===(k=this.offlinePushConfig)||void 0===k?void 0:k.apns)||void 0===w?void 0:w.certificateName,honorCertificateName:null===(D=null===(L=this.offlinePushConfig)||void 0===L?void 0:L.honorPush)||void 0===D?void 0:D.certificateName};this.logger.log("OfflinePushService push config",JSON.stringify(B,null,2)),this.offlinePushPlugin.getDeviceToken({suggestPushType:x,config:B},(e=>{e?(this.logger.log("OfflinePushService:: token is :"+e),this.pushTokenToServer(x,e)):this.logger.warn("OfflinePushService:: token is empty. Please check your parameters")}))}else this.logger.warn("OfflinePushService: plugin.getDeviceToken is not a function");else this.logger.warn("OfflinePushService: only Android or IOS support offline push")}pushTokenToServer(e,t){var r,i,n,a,s,o,c,d,l="",m=this.offlinePushConfig;switch(e){case"5":l=null===(r=null==m?void 0:m.miPush)||void 0===r?void 0:r.certificateName;break;case"6":l=null===(i=null==m?void 0:m.hwPush)||void 0===i?void 0:i.certificateName;break;case"7":l=null===(n=null==m?void 0:m.mzPush)||void 0===n?void 0:n.certificateName;break;case"8":l=null===(a=null==m?void 0:m.fcmPush)||void 0===a?void 0:a.certificateName;break;case"9":l=null===(s=null==m?void 0:m.vivoPush)||void 0===s?void 0:s.certificateName;break;case"10":l=null===(o=null==m?void 0:m.oppoPush)||void 0===o?void 0:o.certificateName;break;case"11":l=null===(c=null==m?void 0:m.honorPush)||void 0===c?void 0:c.certificateName;break;default:l=null===(d=null==m?void 0:m.apns)||void 0===d?void 0:d.certificateName}if(""===l||void 0===l)this.logger.warn("OfflinePushService:: certificate name is empty for push type: ",e);else try{var p=Fp.parse("557d1e3cafa43e2589a588270c53d56f"),u=Fp.stringify(vu.decrypt(t,p));this.logger.log("OfflinePushService:: token",u),this.core.sendCmd("v2SetDeviceToken",{certificateName:l,pushDeviceToken:u,pushkit:0})}catch(e){return this.logger.log("OfflinePushService:: decrypt error",e),void this.logger.warn("OfflinePushService:: token before decrypt",t)}}},"V2NIMSettingService"),NIM.registerService(class V2NIMSyncServiceImpl extends V2Service{constructor(e){super("V2NIMSyncService",e),this.teamKey=["teams","superTeams","myTeamMembers","mySuperTeamMembers"],this.config={},this.timetags={},"v2"===this.core.options.apiVersion&&(this.initEventListeners(),registerParser({cmdMap:yu,cmdConfig:Iu}))}reset(){this.timetags={}}setOptions(e){var t=this.core;return this.config=Object.assign({myInfo:!0,offlineMsgs:!!t.V2NIMMessageService.name,roamingMsgs:!!t.V2NIMMessageService.name,relations:!0,friends:!0,friendUsers:!0,msgReceipts:!!t.V2NIMMessageService.name,broadcastMsgs:!!t.V2NIMMessageService.name,recallMsg:!!t.V2NIMMessageService.name,sessionAck:!0,superTeamSessionAck:!!t.V2NIMConversationService.name,superTeamRoamingMsgs:!!t.V2NIMTeamService.name,deleteSuperTeamMsg:!!t.V2NIMTeamService.name,deleteSelfMsgs:!!t.V2NIMMessageService.name,sessionHistoryMsgsDelete:!!t.V2NIMMessageService.name,avSignal:!!t.signaling.name,teams:!!t.V2NIMTeamService.name,superTeams:!!t.V2NIMTeamService.name,myTeamMembers:!!t.V2NIMTeamService.name,mySuperTeamMembers:!!t.V2NIMTeamService.name,p2pTeamModifyMessage:!!t.V2NIMMessageService.name,superTeamModifyMessage:!!t.V2NIMMessageService.name},e),this.config}doBasicSync(){return __awaiter(this,void 0,void 0,(function*(){var e=Object.keys(this.config).filter((e=>!this.teamKey.includes(e)&&this.config[e])),t=this.genSyncParams(e),r=(yield this.core.clientSocket.sendCmd("v2NIMSync",{tag:t})).content.timetag;this.setTimetags(r,e),yield this.delaySyncDone(),yield this.handleImmediate(),this.core.logger.log("sync::basic sync complete in",r)}))}doTeamSync(){return __awaiter(this,void 0,void 0,(function*(){var e=this.teamKey.filter((e=>this.config[e])),t=this.genSyncParams(e);this.core.eventBus.emit("V2NIMTeamService/onSyncStarted");var r=null;try{r=yield this.core.clientSocket.sendCmd("v2NIMSync",{tag:t})}catch(e){throw this.core.eventBus.emit("V2NIMTeamService/onSyncFailed",e),e}this.core.eventBus.emit("V2NIMTeamService/onSyncFinished");var i=r.content.timetag;this.setTimetags(i,this.teamKey),this.core.logger.log("sync::team sync complete in",i)}))}doQchatSync(){return __awaiter(this,void 0,void 0,(function*(){var e=yield this.core.clientSocket.sendCmd("v2QChatSync",{tag:{systemNotification:0}});this.core.logger.log("sync::qchat sync complete in",e.content.timetag)}))}doSync(){return __awaiter(this,void 0,void 0,(function*(){var e=Ne(this.core,"V2NIMLoginService.authenticator.loginClientOfThisConnection.loginType");if(void 0!==e){if(this.logger.log(`sync::doSync:type ${e}`),this.core.V2NIMLoginService.dataSync.switchDataSync({type:be.V2NIM_DATA_SYNC_TYPE_MAIN,state:Re.V2NIM_DATA_SYNC_STATE_SYNCING}),1===e)try{yield this.doBasicSync(),yield this.doTeamSync()}catch(e){return void this.doSyncComplete(e)}else if(2===e)try{yield this.doQchatSync()}catch(e){return void this.doSyncComplete(e)}else{if(3!==e)return;try{yield this.doBasicSync(),yield this.doTeamSync(),yield this.doQchatSync()}catch(e){return void this.doSyncComplete(e)}}this.doSyncComplete()}else this.logger.warn("sync::doSync: no loginType, stop sync")}))}doSyncComplete(e){e&&this.core.logger.log("sync::doSync complete but got error",e),this.core.V2NIMLoginService.dataSync.switchDataSync({type:be.V2NIM_DATA_SYNC_TYPE_MAIN,state:Re.V2NIM_DATA_SYNC_STATE_COMPLETED,error:e,subType:"mainSync"})}initEventListeners(){this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(()=>{this.doSync()}))}genSyncParams(e){return e.reduce(((e,t)=>{var r=t;return e[r]=this.timetags[r]||0,e}),{})}setTimetags(e,t){t.forEach((t=>{this.timetags[t]=e}))}handleImmediate(){return this.core.session&&this.core.session.onSyncDone&&this.core.session.onSyncDone(),Promise.resolve()}delaySyncDone(){return"ALI"===getMiniappEnv()?(this.core.logger.log("sync: emit ALIAPP sycnHandler, handle later"),new Promise((e=>{setTimeout((()=>{e()}),100)}))):Promise.resolve()}},"V2NIMSyncService"),NIM.registerService(class V2NIMAIServiceImpl extends V2Service{constructor(e){super("V2NIMAIService",e),registerParser({cmdMap:_h,cmdConfig:Th})}getAIUserList(){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),(yield this.core.sendCmd("v2AIGetUserList",{tag:{}})).content.datas}))}proxyAIModelCall(e){return __awaiter(this,void 0,void 0,(function*(){validate(zl,e,"",!0),yield this.core.sendCmd("v2AIProxyModelCall",{tag:e})}))}v2AIChatNotifyHandler(e){var t=e.content.data;t&&t.requestId?this.emit("onProxyAIModelCall",{code:t.code||200,accountId:t.accountId,requestId:t.requestId,content:t.content}):this.logger.warn("v2AIChatNotifyHandler: invalid data",t)}},"V2NIMAIService"),NIM.registerService(class DataStructureConverterImpl{constructor(e){this.core=e}messageConvertToV1(e){var t,r=deserialize(serialize(e,Nl),sn(bs)),i=getSessionId(r,this.core.account),n=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:i});return formatMsg$1(r,n?{account:this.core.account,sessionAck:n.ack,msgReceiptTime:n.msgReceiptTime}:{account:this.core.account})}messageConvertToV2(e){var t=deserialize(serialize(generatorMsgForCmd$1(e,e.from,e.fromDeviceId),bs),Al);return(t=completeMessage(this.core,t)).sendingState="sending"===e.status?Eh.V2NIM_MESSAGE_SENDING_STATE_SENDING:"sendFailed"===e.status?Eh.V2NIM_MESSAGE_SENDING_STATE_FAILED:Eh.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED,t}},"DataStructureConverter"),NIM.registerService(class V2NIMMessageConverterImpl{constructor(e){this.core=e}messageSerialization(e){if(!e)return null;var t=serialize(e,Nl);return JSON.stringify(t)}messageDeserialization(e){var t,r,i,n,a,s,o,c,d,l,m,p,u,h,g,v,y,I,_,M,f,T,E;if(!e)return null;try{var S=deserialize(JSON.parse(e),Al);return S.sendingState=Eh.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN,S.conversationType!==Oe.V2NIM_CONVERSATION_TYPE_P2P||S.senderId!==this.core.account&&S.receiverId!==this.core.account?S.conversationType===Oe.V2NIM_CONVERSATION_TYPE_TEAM?S.conversationId=this.core.V2NIMConversationIdUtil.teamConversationId(S.receiverId):S.conversationType===Oe.V2NIM_CONVERSATION_TYPE_SUPER_TEAM&&(S.conversationId=this.core.V2NIMConversationIdUtil.superTeamConversationId(S.receiverId)):S.conversationId=this.core.V2NIMConversationIdUtil.p2pConversationId(S.senderId===this.core.account?S.receiverId:S.senderId),S.threadReply&&(S.threadReply.conversationType=S.conversationType,S.threadReply=completeMessageRefer(this.core,S.threadReply)),S.threadRoot&&(S.threadRoot.conversationType=S.conversationType,S.threadRoot=completeMessageRefer(this.core,S.threadRoot)),Object.values(Oe).includes(S.conversationType)||this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): ${S.conversationType}`),S.senderId&&"string"!=typeof S.senderId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): ${S.senderId}`),S.receiverId&&"string"!=typeof S.receiverId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): ${S.receiverId}`),"createTime"in S&&isNaN(S.createTime)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): ${S.createTime}`),Object.values(He).includes(S.messageType)||this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageType(enum): ${S.messageType}`),"subType"in S&&isNaN(S.subType)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid subType(number): ${S.subType}`),S.messageClientId&&"string"!=typeof S.messageClientId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): ${S.messageClientId}`),S.messageServerId&&"string"!=typeof S.messageServerId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): ${S.messageServerId}`),S.attachment&&"object"!=typeof S.attachment&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid attachment(object): ${S.attachment}`),S.text&&"string"!=typeof S.text&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid text(string): ${S.text}`),S.serverExtension&&"string"!=typeof S.serverExtension&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid serverExtension(string): ${S.serverExtension}`),S.callbackExtension&&"string"!=typeof S.callbackExtension&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid callbackExtension(string): ${S.callbackExtension}`),(null===(t=S.pushConfig)||void 0===t?void 0:t.pushContent)&&"string"!=typeof S.pushConfig.pushContent&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid pushContent(string): ${S.pushConfig.pushContent}`),(null===(r=S.pushConfig)||void 0===r?void 0:r.pushPayload)&&"string"!=typeof S.pushConfig.pushPayload&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid pushPayload(string): ${S.pushConfig.pushPayload}`),(null===(i=S.pushConfig)||void 0===i?void 0:i.forcePushContent)&&"string"!=typeof S.pushConfig.forcePushContent&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid forcePushContent(string): ${S.pushConfig.forcePushContent}`),(null===(n=S.pushConfig)||void 0===n?void 0:n.forcePushAccountIds)&&!Array.isArray(S.pushConfig.forcePushAccountIds)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid forcePushAccountIds(array): ${S.pushConfig.forcePushAccountIds}`),(null===(a=S.routeConfig)||void 0===a?void 0:a.routeEnvironment)&&"string"!=typeof S.routeConfig.routeEnvironment&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid routeEnvironment(string): ${S.routeConfig.routeEnvironment}`),(null===(s=S.antispamConfig)||void 0===s?void 0:s.antispamBusinessId)&&"string"!=typeof S.antispamConfig.antispamBusinessId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid antispamBusinessId(string): ${S.antispamConfig.antispamBusinessId}`),(null===(o=S.antispamConfig)||void 0===o?void 0:o.antispamCustomMessage)&&"string"!=typeof S.antispamConfig.antispamCustomMessage&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid antispamCustomMessage(string): ${S.antispamConfig.antispamCustomMessage}`),(null===(c=S.antispamConfig)||void 0===c?void 0:c.antispamCheating)&&"string"!=typeof S.antispamConfig.antispamCheating&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid antispamCheating(string): ${S.antispamConfig.antispamCheating}`),(null===(d=S.antispamConfig)||void 0===d?void 0:d.antispamExtension)&&"string"!=typeof S.antispamConfig.antispamExtension&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid antispamExtension(string): ${S.antispamConfig.antispamExtension}`),(null===(l=S.robotConfig)||void 0===l?void 0:l.accountId)&&"string"!=typeof S.robotConfig.accountId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid accountId(string): ${S.robotConfig.accountId}`),(null===(m=S.robotConfig)||void 0===m?void 0:m.topic)&&"string"!=typeof S.robotConfig.topic&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid topic(string): ${S.robotConfig.topic}`),(null===(p=S.robotConfig)||void 0===p?void 0:p.function)&&"string"!=typeof S.robotConfig.function&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid function(string): ${S.robotConfig.function}`),(null===(u=S.robotConfig)||void 0===u?void 0:u.customContent)&&"string"!=typeof S.robotConfig.customContent&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid customContent(string): ${S.robotConfig.customContent}`),(null===(h=S.threadRoot)||void 0===h?void 0:h.senderId)&&"string"!=typeof S.threadRoot.senderId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): ${S.threadRoot.senderId}`),(null===(g=S.threadRoot)||void 0===g?void 0:g.receiverId)&&"string"!=typeof S.threadRoot.receiverId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): ${S.threadRoot.receiverId}`),(null===(v=S.threadRoot)||void 0===v?void 0:v.messageClientId)&&"string"!=typeof S.threadRoot.messageClientId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): ${S.threadRoot.messageClientId}`),(null===(y=S.threadRoot)||void 0===y?void 0:y.messageServerId)&&"string"!=typeof S.threadRoot.messageServerId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): ${S.threadRoot.messageServerId}`),S.threadRoot&&"createTime"in S.threadRoot&&isNaN(S.threadRoot.createTime)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): ${S.threadRoot.createTime}`),S.threadRoot&&!Object.values(Oe).includes(S.threadRoot.conversationType)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): ${S.threadRoot.conversationType}`),(null===(I=S.threadRoot)||void 0===I?void 0:I.conversationId)&&"string"!=typeof S.threadRoot.conversationId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationId(string): ${S.threadRoot.conversationId}`),(null===(_=S.threadReply)||void 0===_?void 0:_.senderId)&&"string"!=typeof S.threadReply.senderId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): ${S.threadReply.senderId}`),(null===(M=S.threadReply)||void 0===M?void 0:M.receiverId)&&"string"!=typeof S.threadReply.receiverId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): ${S.threadReply.receiverId}`),(null===(f=S.threadReply)||void 0===f?void 0:f.messageClientId)&&"string"!=typeof S.threadReply.messageClientId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): ${S.threadReply.messageClientId}`),(null===(T=S.threadReply)||void 0===T?void 0:T.messageServerId)&&"string"!=typeof S.threadReply.messageServerId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): ${S.threadReply.messageServerId}`),S.threadReply&&"createTime"in S.threadReply&&isNaN(S.threadReply.createTime)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): ${S.threadReply.createTime}`),S.threadReply&&!Object.values(Oe).includes(S.threadReply.conversationType)&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): ${S.threadReply.conversationType}`),(null===(E=S.threadReply)||void 0===E?void 0:E.conversationId)&&"string"!=typeof S.threadReply.conversationId&&this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid conversationId(string): ${S.threadReply.conversationId}`),delete S.__clientExt,delete S.userUpdateTime,S}catch(t){return this.core.logger.error(`V2NIMMessageConverterImpl.messageDeserialization: invalid message string: ${e}`),null}}},"V2NIMMessageConverter"),NIM.registerService(class V2NIMMessageLogUtil extends V2Service{constructor(e){super("V2NIMMessageLogUtil",e),this.clearHistoryMessageHandler=e=>{var t=formatClearHistoryNotification(this.core,e);this.emitClearHistoryMessage([t])},this.core=e,this.service=this.core.V2NIMMessageService,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Om,cmdConfig:km}),this.setListener())}setListener(){this.core.eventBus.on("forwardReceive/V2NIMMessageLogService/clearHistoryMessage",this.clearHistoryMessageHandler)}getMessageListByRefers(e){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(am,{messageRefers:e},"",!0),0===e.length)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageListByRefers: messageRefers cannot be an empty array"}});var t=[],r=e.map((e=>{var r=this.service.model.getMessageById(e.messageClientId);return!r&&e.messageServerId&&"0"!==e.messageServerId&&t.push(e),r})),i=[];if(t.length>0){var n=yield this.core.sendCmd("v2GetMessageListByRefers",{tag:t});i=n.content.msgs}return r.map(((t,r)=>{if(t)return t;var n=e[r],a=i.find((e=>e.messageServerId===n.messageServerId));return a?completeMessage(this.core,a):void 0})).filter((e=>void 0!==e)).map((e=>formatMessageAttachment(e,this.core)))}))}getMessageList(e){var t;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),!this.core.V2NIMConversationIdUtil||!this.core.V2NIMConversationIdUtil.parseConversationType)throw new Error('Service "V2NIMConversationService" does not exist');validate(im,e,"",!0),validateConversationId(this.core.account,e.conversationId);var r=this.core.V2NIMConversationIdUtil.parseConversationType(e.conversationId),i=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e.conversationId),n=r===Oe.V2NIM_CONVERSATION_TYPE_P2P?"v2GetMessageList":r===Oe.V2NIM_CONVERSATION_TYPE_TEAM?"v2GetTeamMessageList":"v2GetSuperTeamMessageList",a=e.beginTime||0,s=e.endTime||0;if(0!==a&&0!==s&&a>s)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: beginTime cannot be greater than endTime"}});var o=void 0===e.direction?ze.V2NIM_QUERY_DIRECTION_DESC:e.direction;if(e.anchorMessage)if(e.direction===ze.V2NIM_QUERY_DIRECTION_DESC){if(0===s)s=e.anchorMessage.createTime;else if(s!==e.anchorMessage.createTime)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: When providing anchorMessage, when sorting in descending order, endTime does not need to be provided, or endTime should be equal to anchorMessage.createTime"}})}else if(0===a)a=e.anchorMessage.createTime;else if(a!==e.anchorMessage.createTime)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: When providing anchorMessage, when sorting in ascending order, there is no need to provide beginTime, or beginTime should be equal to anchorMessage.createTime"}});var c=null===(t=e.anchorMessage)||void 0===t?void 0:t.messageServerId,d=yield this.core.sendCmd(n,{beginTime:a,endTime:s,lastMsgId:c||0,limit:e.limit||50,direction:o,msgTypes:e.messageTypes?e.messageTypes.slice():[],to:i}),{content:l}=d,m=[];return m=l.msgs.map((e=>completeMessage(this.core,e))),c&&(m=m.filter((e=>e.messageServerId!==c))),this.getMessageListMonkeyPatch(m,e).map((e=>formatMessageAttachment(e,this.core)))}))}getMessageListMonkeyPatch(e,t){var r=t.conversationId,i=e,n=i.reduce(((e,t)=>(e[t.messageClientId]=!0,e)),{}),a=this.core.V2NIMMessageService.model.getMessagesByConversationId(r);a=a.sort(((e,r)=>t.direction===ze.V2NIM_QUERY_DIRECTION_ASC?e.createTime-r.createTime:r.createTime-e.createTime));var s=0,o=t.beginTime||0,c=t.endTime||0;t.anchorMessage&&(t.direction===ze.V2NIM_QUERY_DIRECTION_DESC?c=t.anchorMessage.createTime:o=t.anchorMessage.createTime,s=a.findIndex((e=>{var r;return e.messageClientId===(null===(r=t.anchorMessage)||void 0===r?void 0:r.messageClientId)})),s+=1);for(var d=s;d<a.length;d++){var l=a[d],m=!n[l.messageClientId],p=void 0===l.sendingState||l.sendingState===We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED,u=l.conversationId===r,h=l.createTime>o&&(l.createTime<c||0===c),g=!t.messageTypes||t.messageTypes.includes(l.messageType);m&&p&&u&&h&&g&&i.push(a[d])}return(i=i.sort(((e,r)=>t.direction===ze.V2NIM_QUERY_DIRECTION_ASC?e.createTime-r.createTime:r.createTime-e.createTime))).slice(0,t.limit||50)}clearHistoryMessage(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(cm,e,"",!0),validateConversationId(this.core.account,e.conversationId);var{conversationId:t,deleteRoam:r,onlineSync:i,serverExtension:n}=e,a=this.core.V2NIMConversationIdUtil.parseConversationType(t),s=this.core.V2NIMConversationIdUtil.parseConversationTargetId(t),o={deleteRoam:r,onlineSync:i,serverExtension:n,conversationType:a};a===Oe.V2NIM_CONVERSATION_TYPE_P2P?o.receiverId=s:o.teamId=s;var c=yield this.core.sendCmd("v2ClearHistoryMessage",{tag:o});this.core.eventBus.emit("forwardSend/V2NIMMessageLogService/clearHistoryMessage",Object.assign(Object.assign({},o),{deleteTime:c.content.timetag})),this.emitClearHistoryMessage([{deleteTime:c.content.timetag,serverExtension:n,conversationId:t}])}))}syncClearHistoryMessageHandler(e){var t=e.content.data.map((e=>formatClearHistoryNotification(this.core,e)));this.emitClearHistoryMessage(t)}onClearHistoryMessageHandler(e){var t=formatClearHistoryNotification(this.core,e.content.data);this.emitClearHistoryMessage([t])}emitClearHistoryMessage(e){e.forEach((e=>{this.core.V2NIMMessageService.model.deleteMessages(e.conversationId,e.deleteTime)})),this.core.V2NIMMessageService.emit("onClearHistoryNotifications",e)}},"V2NIMMessageLogUtil"),NIM.registerService(class V2NIMMessageExtendUtil extends V2Service{constructor(e){super("V2NIMMessageExtendService",e),this.core=e,"v2"===this.core.options.apiVersion&&registerParser({cmdMap:Lm,cmdConfig:jm})}pinMessage(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(nm,e,"message",!0),validate(dm,{serverExtension:t},"",!0);var r=yield this.core.sendCmd("v2PinMessage",{msg:e,msgPin:{serverExtension:t}});this.emitPinNotification({pinState:Je.V2NIM_MESSAGE_PIN_STATE_PINNED,message:e,serverExtension:t,createTime:r.content.timetag,updateTime:r.content.timetag,operatorId:this.core.account})}))}unpinMessage(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(nm,e,"messageRefer",!0),validate(dm,{serverExtension:t},"",!0);var r=yield this.core.sendCmd("v2UnpinMessage",{msg:e,msgPin:{serverExtension:t}});this.emitPinNotification({pinState:Je.V2NIM_MESSAGE_PIN_STATE_NOT_PINNED,message:e,serverExtension:t,updateTime:r.content.timetag,operatorId:this.core.account})}))}updatePinMessage(e,t){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(nm,e,"message",!0),validate(dm,{serverExtension:t},"",!0);var r=yield this.core.sendCmd("v2UpdatePinMessage",{msg:e,msgPin:{serverExtension:t}});this.emitPinNotification({pinState:Je.V2NIM_MESSAGE_PIN_STATE_UPDATED,message:e,serverExtension:t,updateTime:r.content.timetag,operatorId:this.core.account})}))}getPinnedMessageList(e){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),!this.core.V2NIMConversationIdUtil||!this.core.V2NIMConversationIdUtil.parseConversationType)throw new Error('Service "V2NIMConversationService" does not exist');validateConversationId(this.core.account,e);var t=this.core.V2NIMConversationIdUtil.convertToV1ConversationId(e);return t=t.replace("superTeam","super_team"),(yield this.core.sendCmd("v2GetPinMessageList",{tag:{conversationId:t,timetag:0}})).content.data.map((e=>Object.assign(Object.assign({},e),{messageRefer:Object.assign(Object.assign({},e.messageRefer),{conversationId:this.core.V2NIMConversationIdUtil.messageConversationId(e.messageRefer)})}))).sort(((e,t)=>t.updateTime-e.updateTime))}))}addQuickComment(e,t,r,i){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(um,{message:e,index:t,serverExtension:r,pushConfig:i},"",!0);var n=yield this.core.sendCmd("v2AddQuickComment",{message:e,quickComment:{index:t,serverExtension:r,pushConfig:i}}),a={operationType:Qe.V2NIM_QUICK_COMMENT_STATE_ADD,quickComment:{messageRefer:formatMessageRefer(this.core,e),createTime:n.content.timetag,index:t,serverExtension:r||"",operatorId:this.core.account}};this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",a)}))}removeQuickComment(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(nm,e,"messageRefer",!0),validate({index:{type:"number",min:1}},{index:t},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:r},"",!0);var i=yield this.core.sendCmd("v2RemoveQuickComment",{message:e,quickComment:{index:t,serverExtension:r}}),n={operationType:Qe.V2NIM_QUICK_COMMENT_STATE_REMOVE,quickComment:{messageRefer:formatMessageRefer(this.core,e),createTime:i.content.timetag,index:t,serverExtension:r||"",operatorId:this.core.account}};this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",n)}))}getQuickCommentList(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(hm,{messages:e},"",!0);var t={};return(yield this.core.sendCmd("v2GetQuickComment",{tag:e.map((e=>({messageRefer:e})))})).content.data.forEach((e=>{var r,i;try{if(!e.detail)return void(t[r=e.messageRefer.messageClientId]||(t[r]=[]));var n=JSON.parse(e.detail);t[i=e.messageRefer.messageClientId]||(t[i]=[]),n.forEach((r=>{t[e.messageRefer.messageClientId].push({messageRefer:Object.assign(Object.assign({},e.messageRefer),{conversationId:this.core.V2NIMConversationIdUtil.messageConversationId(e.messageRefer)}),operatorId:r[1],index:parseInt(r[2]),createTime:parseInt(r[3]),serverExtension:r[4]})}))}catch(t){this.logger.error("getQuickCommentList JSON Parse Error",e.detail,t)}})),t}))}voiceToText(e){return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(pm,e,"",!0),!e.voicePath&&!e.voiceUrl&&!e.file)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"voiceToText: voicePath、voiceUrl、file cannot be empty at the same time"}});var{voicePath:t,file:r,mimeType:i,sampleRate:n,duration:a,sceneName:s}=e,o=s?this.core.V2NIMStorageService.getStorageScene(s):null,c=e.voiceUrl;if(!c){var d={};r?d.file=r:0===(null==t?void 0:t.indexOf("nim-external"))?d.fileInput=t:d.filePath=t,c=(yield this.core.cloudStorage.uploadFile(Object.assign({type:"audio",nosScenes:o?o.sceneName:void 0,nosSurvivalTime:o?o.expireTime:void 0},d))).url}return(yield this.core.sendCmd("v2VoiceToText",{tag:{voiceUrl:c,mimeType:i,sampleRate:n,duration:a}})).content.data}))}onPinMessageHandler(e){return this.pinMessageChangeHandler(e,Je.V2NIM_MESSAGE_PIN_STATE_PINNED)}onUnpinMessageHandler(e){return this.pinMessageChangeHandler(e,Je.V2NIM_MESSAGE_PIN_STATE_NOT_PINNED)}onUpdatePinMessageHandler(e){return this.pinMessageChangeHandler(e,Je.V2NIM_MESSAGE_PIN_STATE_UPDATED)}pinMessageChangeHandler(e,t){var r=e.content.msg,i=e.content.pinInfo;r.conversationId=this.core.V2NIMConversationIdUtil.messageConversationId(r),this.emitPinNotification({pinState:t,message:r,serverExtension:i.serverExtension,createTime:i.createTime,updateTime:i.updateTime,operatorId:i.accid})}emitPinNotification(e){var t={pinState:e.pinState,pin:Object.assign(Object.assign({serverExtension:e.serverExtension||"",operatorId:e.operatorId},e.createTime?{createTime:e.createTime}:{}),{updateTime:e.updateTime,messageRefer:formatMessageRefer(this.core,e.message)})};this.core.V2NIMMessageService.emit("onMessagePinNotification",t)}onAddQuickCommentHandler(e){return this.onQuickCommentNotificationHandler(e,Qe.V2NIM_QUICK_COMMENT_STATE_ADD)}onRemoveQuickCommentHandler(e){return this.onQuickCommentNotificationHandler(e,Qe.V2NIM_QUICK_COMMENT_STATE_REMOVE)}onQuickCommentNotificationHandler(e,t){var r={operationType:t,quickComment:Object.assign({messageRefer:Object.assign(Object.assign({},e.content.message),{conversationId:this.core.V2NIMConversationIdUtil.messageConversationId(e.content.message)})},e.content.quickComment)};this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",r)}addCollection(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(gm,{params:e},"",!0),(yield this.core.sendCmd("v2AddCollection",{tag:e})).content.data}))}removeCollections(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(vm,{collections:e},"",!0),(yield this.core.sendCmd("v2RemoveCollections",{tag:e})).content.data}))}updateCollectionExtension(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(ym,{collection:e,serverExtension:t},"",!0),(yield this.core.sendCmd("v2UpdateCollectionExtension",{tag:Object.assign(Object.assign({},e),{serverExtension:t})})).content.data}))}getCollectionListByOption(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Im,e,"",!0);var i=e.beginTime||0,n=e.endTime||0;if(0!==i&&0!==n&&i>n)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListByOption: beginTime cannot be greater than endTime"}});var a=void 0===e.direction?ze.V2NIM_QUERY_DIRECTION_DESC:e.direction;if(void 0!==(null===(t=e.anchorCollection)||void 0===t?void 0:t.collectionId))if(e.direction===ze.V2NIM_QUERY_DIRECTION_DESC){if(0===n)n=e.anchorCollection.createTime;else if(n!==e.anchorCollection.createTime)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListByOption: When providing anchorCollection, when sorting in descending order, endTime does not need to be provided, or endTime should be equal to anchorCollection.createTime"}})}else if(0===i)i=e.anchorCollection.createTime;else if(i!==e.anchorCollection.createTime)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListByOption: When providing anchorCollection, when sorting in ascending order, there is no need to provide beginTime, or beginTime should be equal to anchorCollection.createTime"}});var s={beginTime:i,endTime:n,direction:a,limit:e.limit,collectionType:e.collectionType,excludeId:(null===(r=e.anchorCollection)||void 0===r?void 0:r.collectionId)?e.anchorCollection.collectionId:0};return s.collectionType||delete s.collectionType,(yield this.core.sendCmd("v2GetCollectionListByOption",{tag:s})).content.data}))}searchCloudMessages(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(_m,e,"",!0);var t=e.beginTime||0,r=e.endTime||0;if(0!==t&&0!==r&&t>r)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"searchCloudMessages: beginTime cannot be greater than endTime"}});var i=void 0===e.sortOrder?Ze.V2NIM_SORT_ORDER_DESC:e.sortOrder,n=e.conversationLimit||0,a=e.messageLimit||10,s=n>0?"v2SearchCloudMessagesGroupByConversation":"v2SearchCloudMessages";return(yield this.core.sendCmd(s,{tag:Object.assign(Object.assign({},e),{beginTime:t,endTime:r,sortOrder:i,conversationLimit:n,messageLimit:a})})).content.data.map((e=>completeMessage(this.core,e)))}))}getThreadMessageList(e){return __awaiter(this,void 0,void 0,(function*(){if(validate(Nm,e,"getThreadMessageList",!0),e.beginTime=e.beginTime||0,e.endTime&&e.beginTime>e.endTime)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getThreadMessageList: beginTime cannot be greater than endTime"}});var t=yield this.core.sendCmd("v2GetThreadMessageList",{messageRefer:e.messageRefer,tag:{beginTime:e.beginTime,endTime:e.endTime,limit:e.limit,reverse:e.direction===ze.V2NIM_QUERY_DIRECTION_ASC?1:0,excludeMessageServerId:e.excludeMessageServerId}}),{message:r,replyResult:i,replyList:n}=t.content;return{message:completeMessage(this.core,r),timestamp:i.timestamp,replyCount:i.total,replyList:n.map((e=>completeMessage(this.core,e)))}}))}},"V2NIMMessageExtendUtil"),NIM.registerService(class V2NIMSignallingServiceImpl extends V2Service{constructor(e,t={}){super("V2NIMSignallingService",e),this.config={compatibleWithV1:!0},this.channels={},this.timer=0,this.pollingInterval=12e4,"v2"===this.core.options.apiVersion&&(registerParser({cmdMap:Rh,cmdConfig:kh}),this.setOptions(t))}reset(){this.timer=0,this.channels={}}setOptions(e){var t;(null===(t=this.core.signaling)||void 0===t?void 0:t.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Object.assign(this.config,e)}call(e){var t;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(wh,e,"",!0),e.calleeAccountId===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"You cannot call yourself"}});var r=void 0!==e.pushConfig&&(void 0!==e.pushConfig.pushEnabled&&e.pushConfig.pushEnabled),i=(yield this.core.sendCmd("v2SignallingCall",{tag:Object.assign(Object.assign({},e),{toAccid:e.calleeAccountId,offlineEnabled:void 0===(null===(t=e.signallingConfig)||void 0===t?void 0:t.offlineEnabled)||e.signallingConfig.offlineEnabled,pushConfig:Object.assign(Object.assign({},e.pushConfig||{}),{pushEnabled:r})})})).content.data;return this.channels[i.channelInfo.channelId]=Go(i.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),{callStatus:i.callStatus,rtcInfo:i.rtcInfo,roomInfo:{channelInfo:i.channelInfo,members:i.members}}}))}callSetup(e){var t;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Lh,e,"",!0),e.callerAccountId===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"callSetup: cannot be yourself"}});var r=(yield this.core.sendCmd("v2SignallingCallSetup",{tag:Object.assign(Object.assign({},e),{toAccid:e.callerAccountId,offlineEnabled:void 0===(null===(t=e.signallingConfig)||void 0===t?void 0:t.offlineEnabled)||e.signallingConfig.offlineEnabled})})).content.data;return this.channels[r.channelInfo.channelId]=Go(r.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),{callStatus:r.callStatus,rtcInfo:r.rtcInfo,roomInfo:{channelInfo:r.channelInfo,members:r.members}}}))}createRoom(e,t,r){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(Dh,{channelType:e,channelName:t,channelExtension:r},"",!0),(yield this.core.sendCmd("v2SignallingCreateRoom",{tag:{channelType:e,channelName:t,channelExtension:r}})).content.data.channelInfo}))}delayRoom(e){return __awaiter(this,void 0,void 0,(function*(){this.checkV2();var t=yield this.core.sendCmd("v2SignallingDelayRoom",{tag:{channelId:e}});return{channelInfo:t.content.data.channelInfo,members:t.content.data.members}}))}closeRoom(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(Uh,{channelId:e,offlineEnabled:t,serverExtension:r},"",!0),yield this.core.sendCmd("v2SignallingCloseRoom",{tag:{channelId:e,offlineEnabled:void 0!==t&&t,serverExtension:r}})}))}joinRoom(e){var t;return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(qh,e,"",!0);var r=yield this.core.sendCmd("v2SignallingJoinRoom",{tag:Object.assign(Object.assign({},e),{offlineEnabled:void 0===(null===(t=e.signallingConfig)||void 0===t?void 0:t.offlineEnabled)||e.signallingConfig.offlineEnabled})}),i=r.content.data;return this.channels[i.channelInfo.channelId]=Go(i.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),{channelInfo:r.content.data.channelInfo,members:r.content.data.members}}))}leaveRoom(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.checkV2(),validate(xh,{channelId:e,offlineEnabled:t,serverExtension:r},"",!0),yield this.core.sendCmd("v2SignallingLeaveRoom",{tag:{channelId:e,offlineEnabled:void 0!==t&&t,serverExtension:r}}),delete this.channels[e]}))}invite(e){var t;return __awaiter(this,void 0,void 0,(function*(){if(this.checkV2(),validate(Bh,e,"",!0),e.inviteeAccountId===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"invite: cannot be yourself"}});var r=void 0!==e.pushConfig&&(void 0!==e.pushConfig.pushEnabled&&e.pushConfig.pushEnabled);return(yield this.core.sendCmd("v2SignallingInvite",{tag:Object.assign(Object.assign({},e),{toAccid:e.inviteeAccountId,offlineEnabled:void 0===(null===(t=e.signallingConfig)||void 0===t?void 0:t.offlineEnabled)||e.signallingConfig.offlineEnabled,pushConfig:Object.assign(Object.assign({},e.pushConfig||{}),{pushEnabled:r})})})).content.data}))}cancelInvite(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkV2(),validate(Fh,e,"",!0),(yield this.core.sendCmd("v2SignallingCancelInvite",{tag:Object.assign(Object.assign({},e),{toAccid:e.inviteeAccountId})})).content.data}))}rejectInvite(e){return __awaiter(this,void 0,void 0,(function*(){if(validate(jh,e,"",!0),e.inviterAccountId===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"rejectInvite: cannot be yourself"}});yield this.core.sendCmd("v2SignallingRejectInvite",{tag:Object.assign(Object.assign({},e),{toAccid:e.inviterAccountId})})}))}acceptInvite(e){return __awaiter(this,void 0,void 0,(function*(){if(validate(Hh,e,"",!0),e.inviterAccountId===this.core.account)throw new V2NIMErrorImpl({code:Ct.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"acceptInvite: cannot be yourself"}});yield this.core.sendCmd("v2SignallingAcceptInvite",{tag:Object.assign(Object.assign({},e),{toAccid:e.inviterAccountId})})}))}sendControl(e,t,r){return __awaiter(this,void 0,void 0,(function*(){validate(Gh,{channelId:e,receiverAccountId:t,serverExtension:r},"",!0),yield this.core.sendCmd("v2SignallingSendControl",{tag:{channelId:e,toAccid:t,serverExtension:r}})}))}getRoomInfoByChannelName(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelName:{type:"string",allowEmpty:!1}},{channelName:e},"",!0);var t=yield this.core.sendCmd("v2SignallingGetRoomInfo",{tag:{channelName:e}}),{members:r,channelInfo:i}=t.content.data;return{channelInfo:i,members:r||[]}}))}aotoDelay(){return __awaiter(this,void 0,void 0,(function*(){var e=Object.keys(this.channels);if(0===e.length)return this.timer&&this.core.timerManager.deleteTimer(this.timer),void(this.timer=0);this.logger.log("v2Signlling:autoDelay",e);for(var t=0;t<e.length;t++){var r=e[t];try{var i=yield this.core.sendCmd("v2SignallingDelayRoom",{tag:{channelId:r}});this.channels[r]=i.content.data.channelInfo}catch(e){this.logger.warn(`signling:autoDelay ${r} failed`,e),delete this.channels[r]}}}))}v2SignallingOnlineEventHandler(e){var t=e.content.data,r="number"==typeof Ne(e,"raw.r[0]")?`${e.raw.r[0]}`:"0";!this.config.compatibleWithV1&&r&&parseInt(r)&&this.core.sendCmd("v2SignallingBatchMarkRead",{sid:15,cid:11,ids:[r]}),this.emit("onOnlineEvent",formatSignalingEvent(t))}v2SignallingMultiClientEventHandler(e){this.emit("onMultiClientEvent",formatSignalingEvent(e.content.data))}v2SignallingOfflineEventHandler(e){if(e.content.datas&&e.content.datas.length>0){if(!this.config.compatibleWithV1){var t=e.content.datas.map((e=>e.msgId));t.length>0&&this.core.sendCmd("v2SignallingBatchMarkRead",{sid:15,cid:11,ids:t})}var r=e.content.datas.map((e=>formatSignalingEvent(e)));this.emit("onOfflineEvent",r)}}v2SignallingSyncChannelsHandler(e){if(this.timer=0,this.channels={},e.content.datas&&e.content.datas.length>0){var t=e.content.datas;t.forEach((e=>{var t=e.channelInfo.channelId;this.channels[t]=Go(e.channelInfo)})),this.timer||(this.timer=this.core.timerManager.addTimer(this.aotoDelay.bind(this),this.pollingInterval,-1)),this.emit("onSyncRoomInfoList",t)}}},"V2NIMSignallingService"),NIM.registerService(class V2NIMSubscriptionServiceImpl extends V2Service{constructor(e){super("V2NIMSubscriptionService",e),"v2"===this.core.options.apiVersion&&registerParser({cmdMap:$h,cmdConfig:Jh})}subscribeUserStatus(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkLogin(),this.checkV2(),validate(Qh,e,"",!0),(yield this.core.sendCmd("v2SubscribeUserStatus",{tag:{eventType:1,duration:e.duration||60,immediateSync:void 0!==e.immediateSync&&e.immediateSync},accountIds:e.accountIds})).content.failedList}))}unsubscribeUserStatus(e){return __awaiter(this,void 0,void 0,(function*(){this.checkLogin(),this.checkV2(),validate(Xh,e,"",!0);var t=[];e.accountIds.length>0?t=(yield this.core.sendCmd("v2UnsubscribeUserStatus",{tag:{eventType:1},accountIds:e.accountIds})).content.failedList:(yield this.core.sendCmd("v2UnsubscribeAllUserStatus",{tag:{eventType:1}}),t=[]);return t}))}publishCustomUserStatus(e){return __awaiter(this,void 0,void 0,(function*(){return this.checkLogin(),this.checkV2(),validate(Zh,e,"",!0),(yield this.core.sendCmd("v2PublishEvent",{tag:Object.assign(Object.assign({},e),{eventType:1,uniqueId:Ii(),duration:e.duration||60,onlineOnly:void 0===e.onlineOnly||e.onlineOnly,multiSync:void 0!==e.multiSync&&e.multiSync})})).content.data}))}queryUserStatusSubscriptions(e){return __awaiter(this,void 0,void 0,(function*(){this.checkLogin(),this.checkV2(),validate({accountIds:{type:"array",required:!0,itemType:"string",max:3e3}},{accountIds:e},"",!0);var t=[];if(e.length>0)for(var r=0;r<e.length;r+=100){var i=yield this.core.sendCmd("v2QuerySubscribeEvent",{tag:{eventType:1},accountIds:e.slice(r,r+100)});t=t.concat(i.content.data.map((e=>({accountId:e.accountId,subscribeTime:e.subscribeTime,duration:e.duration}))))}else{var n=yield this.core.sendCmd("v2QueryAllSubscribeEvent",{tag:{eventType:1}});t=t.concat(n.content.data.map((e=>({accountId:e.accountId,subscribeTime:e.subscribeTime,duration:e.duration}))))}return t}))}v2OnUserStatusChangeHandler(e){var t=e.content.data,{eventType:r,extensionReceived:i}=t,n=__rest(t,["eventType","extensionReceived"]);1===r?this.emit("onUserStatusChanged",[Object.assign(Object.assign({},n),{extension:i})]):this.logger.log("v2OnUserStatusChangeHandler eventType = ",r,"msgEvent = ",t)}v2OnMultiUserStatusChangeHandler(e){var t=e.content.data.filter((e=>1===e.eventType)).map((e=>{var{eventType:t,extensionReceived:r}=e,i=__rest(e,["eventType","extensionReceived"]);return Object.assign(Object.assign({},i),{extension:r})}));t.length>0&&this.emit("onUserStatusChanged",t)}},"V2NIMSubscriptionService"),NIM.registerService(class V2NIMMessageAttachmentCreatorImpl{constructor(){this.name="V2NIMMessageAttachmentCreator"}createLocationMessageAttachment(e,t,r){return{latitude:"number"==typeof e?e:0,longitude:"number"==typeof t?t:0,address:"string"==typeof r?r:""}}createCustomMessageAttachment(e){return{raw:"string"==typeof e?e:""}}},"V2NIMMessageAttachmentCreator"),NIM.registerService(class QChatChannelService extends Service{constructor(e,t){super("qchatChannel",e),this.config={autoSubscribe:!1},this.core=e,registerParser({cmdMap:ud,cmdConfig:getCmdConfig$4()}),t&&this.setOptions(t),this.subscribeModuleService=new UnreadInfoModuleService(e),this.subscribeForVisitorService=new SubscribeForVisitorService(e),this.setListener()}setOptions(e){e&&(this.config=Object.assign(this.config,e))}setListener(){this.core.eventBus.on("logined",(e=>{this.subscribeModuleService.resumeSubscribe(e.isAutoReconnect),this.subscribeForVisitorService.resumeSubscribe(e.isAutoReconnect),this.config.autoSubscribe&&(this.subscribeModuleService.autoSubscribeServerMap={},this.subscribeModuleService.autoSubscribeUnreadMap={},this.subscribeModuleService.autoSubscribe())})),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(e=>{this.subscribeModuleService.resumeSubscribe(e.isReconnect),this.subscribeForVisitorService.resumeSubscribe(e.isReconnect),this.config.autoSubscribe&&(this.subscribeModuleService.autoSubscribeServerMap={},this.subscribeModuleService.autoSubscribeUnreadMap={},this.subscribeModuleService.autoSubscribe())})),this.core.eventBus.on("qchatChannel/changeUnread",this.subscribeModuleService.changeUnread.bind(this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/updateUnreads",this.subscribeModuleService.updateUnreads.bind(this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/cacheSubscribe",this.subscribeModuleService.cacheSubscribe.bind(this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/clearUnreadCountByServers",this.subscribeModuleService.clearUnreadCountByServers.bind(this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/getRoleIdsByServerId",this.subscribeModuleService.getRoleIdsByServerId.bind(this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/autoUnSubscribe",(e=>{if(this.logger.log("QChatChannel::enter autoUnSubscribe sysMsg is",e),e.type===Ud[Ud.channelVisibilityUpdate])this.logger.log("QChatChannel::begin autoUnSubscribe channel key is",`${e.serverId}_${e.channelId}`),this.subscribeModuleService._unSubscribeChannel(e.serverId,e.channelId),this.logger.log("QChatChannel::autoUnSubscribe channel done key is",`${e.serverId}_${e.channelId}`);else if(e.type===Ud[Ud.serverEnterLeave]){(this.subscribeModuleService.manualSubscribeServerMap[e.serverId]||this.subscribeModuleService.autoSubscribeServerMap[e.serverId])&&(this.logger.log("QChatChannel::begin autoUnSubscribe server key is",e.serverId),this.subscribeModuleService._unSubscribeServer(e.serverId),this.logger.log("QChatChannel::autoUnSubscribe server done key is",e.serverId));var t=this.subscribeModuleService.unreadServerCount[e.serverId];if(!t)return;this.logger.log("QChatChannel::begin autoUnSubscribe channels key is",Object.keys(t)),Object.keys(t).forEach((t=>{this.subscribeModuleService._unSubscribeChannel(e.serverId,t)})),this.logger.log("QChatChannel::autoUnSubscribe channels done key is",Object.keys(t))}})),this.core.eventBus.on("qchatChannel/serverIdentifyChange",(e=>{this.subscribeModuleService.changeCacheServerRoleIds(e)}))}createChannel(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(dd)},name:{type:"string",required:!1},topic:{type:"string",required:!1},ext:{type:"string",required:!1},visitorMode:{type:"number",required:!1}},e),formatChannel((yield this.core.sendCmd("qchatCreateChannel",{channelInfo:Object.assign(Object.assign({},e),{type:dd[e.type]}),antispamTag:generateAntispamTag(e)})).content.channelInfo)}))}deleteChannel(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("qchatDeleteChannel",e)}))}updateChannel(e){return __awaiter(this,void 0,void 0,(function*(){validate({channelId:{type:"string",min:1},serverId:{type:"string",required:!1},type:{type:"enum",values:getEnumKeys(dd),required:!1},name:{type:"string",required:!1},topic:{type:"string",required:!1},ext:{type:"string",required:!1},visitorMode:{type:"number",required:!1}},e);var t=e;return e.type&&(t.type=dd[e.type]),formatChannel((yield this.core.sendCmd("qchatUpdateChannel",{channelInfo:t,antispamTag:generateAntispamTag(e)})).content.channelInfo)}))}getChannels(e){return __awaiter(this,void 0,void 0,(function*(){return validate({channelIds:{type:"array",itemType:"string",min:1}},e),formatChannels((yield this.core.sendCmd("qchatGetChannels",e)).content.channelList)}))}getChannelsByPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetChannelsByPage",{qchatGetChannelListPageTag:Object.assign({limit:100},e)}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatChannels(r)}}))}getMembersByPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetMembersByPage",{qchatGetMembersByPageTag:e}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatMembers$1(r)}}))}updateWhiteBlackRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},roleId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(od)},opeType:{type:"enum",values:getEnumKeys(cd)}},e),yield this.core.sendCmd("qchatUpdateWhiteBlackRole",{qchatUpdateWhiteBlackRoleTag:Object.assign(Object.assign({},e),{type:od[e.type],opeType:cd[e.opeType]})})}))}getWhiteBlackRolesPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(od)},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetWhiteBlackRolesPage",{qchatGetWhiteBlackRolesPageTag:Object.assign(Object.assign({},e),{type:od[e.type]})}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatRoles(r)}}))}updateWhiteBlackMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(od)},opeType:{type:"enum",values:getEnumKeys(cd)},toAccids:{type:"array",itemType:"string",min:1}},e),yield this.core.sendCmd("qchatUpdateWhiteBlackMembers",{qchatUpdateWhiteBlackMembersTag:Object.assign(Object.assign({},e),{type:od[e.type],opeType:cd[e.opeType],toAccids:JSON.stringify(e.toAccids)})})}))}getWhiteBlackMembersPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(od)},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetWhiteBlackMembersPage",{qchatGetWhiteBlackMembersPageTag:Object.assign(Object.assign({limit:100},e),{type:od[e.type]})}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatMembers$1(r)}}))}getExistingWhiteBlackRoles(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(od)},roleIds:{type:"array",itemType:"string",min:1}},e);var t=yield this.core.sendCmd("qchatGetExistingWhiteBlackRoles",{qchatGetExistingWhiteBlackRolesTag:Object.assign(Object.assign({},e),{type:od[e.type],roleIds:JSON.stringify(e.roleIds)})}),{datas:r}=t.content;return{datas:formatRoles(r)}}))}getExistingWhiteBlackMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(od)},accids:{type:"array",itemType:"string",min:1}},e);var t=yield this.core.sendCmd("qchatGetExistingWhiteBlackMembers",{qchatGetExistingWhiteBlackMembersTag:Object.assign(Object.assign({},e),{type:od[e.type],accids:JSON.stringify(e.accids)})}),{datas:r}=t.content;return{datas:formatMembers$1(r)}}))}updateCategoryInfoOfChannel(e){return __awaiter(this,void 0,void 0,(function*(){return validate({channelId:{type:"string",min:1},categoryId:{type:"string",allowEmpty:!1,required:!1},syncMode:{type:"number",min:0,max:1,required:!1}},e),formatChannel((yield this.core.sendCmd("qchatUpdateCategoryInfoOfChannel",{qchatUpdateCategoryInfoOfChannelTag:e})).content.channelInfo)}))}createChannelCategory(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},name:{type:"string",allowEmpty:!1,required:!1},ext:{type:"string",required:!1},viewMode:{type:"number",min:0,max:1,required:!1}},e),formatChannelCategory((yield this.core.sendCmd("qchatCreateChannelCategory",{qchatCreateChannelCategoryTag:e})).content.QChatChannelCategoryInfo)}))}removeChannelCategory(e){return __awaiter(this,void 0,void 0,(function*(){validate({categoryId:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("qchatRemoveChannelCategory",e)}))}updateChannelCategory(e){return __awaiter(this,void 0,void 0,(function*(){return validate({categoryId:{type:"string",allowEmpty:!1},name:{type:"string",allowEmpty:!1,required:!1},ext:{type:"string",required:!1},viewMode:{type:"number",min:0,max:1,required:!1}},e),formatChannelCategory((yield this.core.sendCmd("qchatUpdateChannelCategory",{qchatUpdateChannelCategoryTag:e})).content.QChatChannelCategoryInfo)}))}getChannelCategoriesByID(e){return __awaiter(this,void 0,void 0,(function*(){return validate({categoryIds:{type:"array",itemType:"string",min:1}},e),formatChannelCategorys((yield this.core.sendCmd("qchatGetChannelCategoriesByID",e)).content.channelCategoryList)}))}updateChannelCategoryWhiteBlackRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(od)},opeType:{type:"enum",values:getEnumKeys(cd)},roleId:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("qchatUpdateChannelCategoryWhiteBlackRole",{qchatUpdateChannelCategoryWhiteBlackRoleTag:Object.assign(Object.assign({},e),{type:od[e.type],opeType:cd[e.opeType]})})}))}getChannelCategoryWhiteBlackRolesPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(od)},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetChannelCategoryWhiteBlackRolesPage",{qchatGetChannelCategoryWhiteBlackRolesPageTag:Object.assign(Object.assign({},e),{type:od[e.type]})}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatRoles(r)}}))}updateChannelCategoryWhiteBlackMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(od)},opeType:{type:"enum",values:getEnumKeys(cd)},toAccids:{type:"array",itemType:"string",min:1}},e),yield this.core.sendCmd("qchatUpdateChannelCategoryWhiteBlackMembers",{qchatUpdateChannelCategoryWhiteBlackMembersTag:Object.assign(Object.assign({},e),{type:od[e.type],opeType:cd[e.opeType],toAccids:JSON.stringify(e.toAccids)})})}))}getChannelCategoryWhiteBlackMembersPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(od)},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetChannelCategoryWhiteBlackMembersPage",{qchatGetChannelCategoryWhiteBlackMembersPageTag:Object.assign(Object.assign({},e),{type:od[e.type]})}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatMembers$1(r)}}))}getChannelCategoryWhiteBlackRoles(e){return __awaiter(this,void 0,void 0,(function*(){validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(od)},roleIds:{type:"array",itemType:"string",min:1}},e);var t=yield this.core.sendCmd("qchatGetChannelCategoryWhiteBlackRoles",{qchatGetChannelCategoryWhiteBlackRolesTag:Object.assign(Object.assign({},e),{type:od[e.type],roleIds:JSON.stringify(e.roleIds)})}),{datas:r}=t.content;return formatRoles(r)}))}getChannelCategoryWhiteBlackMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(od)},accids:{type:"array",itemType:"string",min:1}},e);var t=yield this.core.sendCmd("qchatGetChannelCategoryWhiteBlackMembers",{qchatGetChannelCategoryWhiteBlackMembersTag:Object.assign(Object.assign({},e),{type:od[e.type],accids:JSON.stringify(e.accids)})}),{datas:r}=t.content;return formatMembers$1(r)}))}getChannelCategoriesPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetChannelCategoriesPage",{qchatGetChannelCategoriesPageTag:e}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatChannelCategorys(r)}}))}getChannelCategoryChannelsPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetChannelCategoryChannelsPage",{qchatGetChannelCategoryChannelsPageTag:e}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatChannels(r)}}))}subscribeChannel(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({type:{type:"number",min:1,max:5},opeType:{type:"number",min:1,max:2}},e),this.config.autoSubscribe&&!e.isInternalTrigger&&5!==e.type)throw new CustomError("subscribe server failed, manual subscribe is not allowed in auto subscribe mode",{},403);var t=yield this.subscribeModuleService.subscribe(e);if(t.unreadInfos=formatUnreadInfos(t.unreadInfos),5!==e.type)return 1===e.opeType&&(e.channels=t.unreadInfos.map((e=>({serverId:e.serverId,channelId:e.channelId})))),this.logger.debug("QChatChannel::subscribeChannel:: cacheSubscribe ",e),this.config.autoSubscribe?this.subscribeModuleService.cacheAutoSubscribe(e):this.subscribeModuleService.cacheSubscribe(e),this.subscribeModuleService.updateUnreads(t.unreadInfos),t;this.subscribeModuleService.cacheSubscribe(e)}))}getChannelUnreadInfos(e){return __awaiter(this,void 0,void 0,(function*(){var t=formatUnreadInfos((yield this.core.sendCmd("qchatGetUnreadInfo",e)).content.unreadInfos);return this.subscribeModuleService.updateUnreads(t),t}))}getChannelSearchByPage(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({keyword:{type:"string",allowEmpty:!1},startTime:{type:"number",min:0,required:!1},endTime:{type:"number",min:1,required:!1},order:{type:"enum",values:getEnumKeys(ld),required:!1},limit:{type:"number",min:1,required:!1},serverId:{type:"string",required:!1},sort:{type:"enum",values:getEnumKeys(sd),required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),e.startTime&&e.endTime&&e.startTime>=e.endTime)throw new ValidateError("startTime more than endTime",e,"timeRule");var t=yield this.core.sendCmd("qchatGetChannelSearchByPage",{qchatGetChannelSearchByPageTag:Object.assign(Object.assign({},e),{order:e.order&&ld[e.order],sort:e.sort&&sd[e.sort]})}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag),cursor:i.cursor},datas:formatChannels(r)}}))}channelMemberSearch(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},keyword:{type:"string",allowEmpty:!1},limit:{type:"number",min:1,required:!1}},e),formatChannelMembers((yield this.core.sendCmd("qchatChannelMemberSearch",{qchatChannelMemberSearchTag:e})).content.datas)}))}subscribeAsVisitor(e){return __awaiter(this,void 0,void 0,(function*(){return validate({opeType:{type:"number",min:1,max:2},type:{type:"number",required:!1},channels:{type:"array",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1}},min:1}},e),yield this.subscribeForVisitorService.subscribeChannelAsVisitor(e)}))}qchatAutoSubscribeNotificationHandler(e){var t=formatUnreadInfos(e.content.unreadInfos),r=e.content.serverIds;this.subscribeModuleService.updateUnreads(t);var i=[];if(r.length){var n={opeType:1};n.channels=r.map((e=>({serverId:e.serverId,channelId:""}))),n.type=4,i.push(n)}if(t.length){var a={opeType:1};a.channels=t.map((e=>({serverId:e.serverId,channelId:e.channelId}))),a.type=1,i.push(a)}if(i.length)for(var s of i)this.subscribeModuleService.cacheAutoSubscribe(s)}},"qchatChannel"),NIM.registerService(class QChatMediaService extends Service{constructor(e,t){super("qchatMedia",e),this.config={},this.tokenExpireTime=24e4,this.getTokenState=!1,this.core=e,registerParser({cmdMap:Kd,cmdConfig:getCmdConfig$3()}),t&&this.setOptions(t),this.setListener(),this.tokenExpireTime=24e4,this.channelId="",this.serverId=""}setOptions(e){e&&(this.config=Object.assign(this.config,e),(null==e?void 0:e.neroom)&&this.setNeroom(e.neroom))}setNeroom(e){this.neroom=new e}setListener(){this.core.eventBus.on("disconnect",this._existRomm.bind(this)),this.core.eventBus.on("kicked",this._existRomm.bind(this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLogout",this._existRomm.bind(this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleKicked",this._existRomm.bind(this)),this.core.eventBus.on("qchatMedia/serverOrChannelLeave",(e=>__awaiter(this,void 0,void 0,(function*(){(e.type===Ud[Ud.channelVisibilityUpdate]&&e.channelId===this.channelId||e.type===Ud[Ud.serverEnterLeave]&&e.serverId===this.serverId)&&this.roomContext&&this.roomContext.roomUuid&&(yield this.disconnectChannel())}))))}_existRomm(){return __awaiter(this,void 0,void 0,(function*(){this.roomContext&&(yield this.disconnectChannel()),this.tokenTimer&&(this.core.timerManager.deleteTimer(this.tokenTimer),this.tokenTimer=void 0)}))}_checkPermission(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.core.qchatRole.checkPermission(e)}))}_checkConnectState(){if("connect"!==this.state)throw new CustomError("QChatMedia::you should connect first")}kickMemberOut(e){var t;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e);try{yield null===(t=this.roomContext)||void 0===t?void 0:t.kickMemberOut(e.accid)}catch(t){throw this.logger.error("QChatMedia::kickMemberOut error params is "+JSON.stringify(e),t),new CustomError("QChatMedia::kickMemberOut error",t)}}))}disconnectChannel(){var e;return __awaiter(this,void 0,void 0,(function*(){this.logger.debug("QChatMedia::disconnect begin disconnect");try{yield null===(e=this.roomContext)||void 0===e?void 0:e.leaveRoom()}catch(e){this.logger.error("QChatMedia::disconnect error",e)}this.authService&&(yield this.authService.logout()),this._setStateInit(),this.core.emit("qchatMediaDisconnect"),this.core.qchatMedia.emit("qchatMediaDisconnect")}))}_setStateInit(){this.logger.debug("QChatMedia::disconnect end"),this.roomContext=void 0,this.rtcController=void 0,this.state="init",this.tokenTimer&&(this.core.timerManager.deleteTimer(this.tokenTimer),this.tokenTimer=void 0),this.channelId="",this.serverId=""}muteAudio(e){var t,r,i,n,a;return __awaiter(this,void 0,void 0,(function*(){if(this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),(null===(t=this.roomContext)||void 0===t?void 0:t.localMember.uuid)===e.accid)try{yield null===(r=this.rtcController)||void 0===r?void 0:r.muteMyAudio()}catch(e){throw this.logger.error("QChatMedia::muteAudio error",e),new CustomError("QChatMedia::muteAudio error",e)}else try{var s=null===(i=this.roomContext)||void 0===i?void 0:i.roomProperties.audioOff;if(s&&(null===(n=s.value)||void 0===n?void 0:n.split("_")[0])===$d.offNotAllowSelfOn)if(!(yield this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneMicrophone"})))return void this.logger.error("QChatMedia::unMuteAudio not allow open auido");yield null===(a=this.rtcController)||void 0===a?void 0:a.muteMemberAudio(e.accid)}catch(t){throw this.logger.error("QChatMedia::muteAudio error params is "+JSON.stringify(e),t),new CustomError("QChatMedia::muteAudio error",t)}}))}unMuteAudio(e){var t,r,i,n,a;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e);var s=null===(t=this.roomContext)||void 0===t?void 0:t.roomProperties.audioOff;if(s&&(null===(r=s.value)||void 0===r?void 0:r.split("_")[0])===$d.offNotAllowSelfOn&&!(yield this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneMicrophone"})))return void this.logger.error("QChatMedia::unMuteAudio not allow open auido");if((null===(i=this.roomContext)||void 0===i?void 0:i.localMember.uuid)===e.accid)try{yield null===(n=this.rtcController)||void 0===n?void 0:n.unmuteMyAudio()}catch(e){throw this.logger.error("QChatMedia::unMuteAudio error",e),new CustomError("QChatMedia::unMuteAudio error",e)}else try{yield null===(a=this.rtcController)||void 0===a?void 0:a.unmuteMemberAudio(e.accid)}catch(t){throw this.logger.error("QChatMedia::unMuteAudio error params is "+JSON.stringify(e),t),new CustomError("QChatMedia::unMuteAudio error",t)}}))}muteVideo(e){var t,r,i,n,a;return __awaiter(this,void 0,void 0,(function*(){if(this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),(null===(t=this.roomContext)||void 0===t?void 0:t.localMember.uuid)===e.accid)try{yield null===(r=this.rtcController)||void 0===r?void 0:r.muteMyVideo()}catch(e){throw this.logger.error("QChatMedia::muteVideo error",e),new CustomError("QChatMedia::muteVideo error",e)}else try{var s=null===(i=this.roomContext)||void 0===i?void 0:i.roomProperties.videoOff;if(s&&(null===(n=s.value)||void 0===n?void 0:n.split("_")[0])===$d.offNotAllowSelfOn)if(!(yield this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneCamera"})))return void this.logger.error("QChatMedia::unMuteVideo not allow open video");yield null===(a=this.rtcController)||void 0===a?void 0:a.muteMemberVideo(e.accid)}catch(t){throw this.logger.error("QChatMedia::muteVideo error params is "+JSON.stringify(e),t),new CustomError("QChatMedia::muteVideo error",t)}}))}unMuteVideo(e){var t,r,i,n,a;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e);var s=null===(t=this.roomContext)||void 0===t?void 0:t.roomProperties.videoOff;if(s&&(null===(r=s.value)||void 0===r?void 0:r.split("_")[0])===$d.offNotAllowSelfOn&&!(yield this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneCamera"})))return void this.logger.error("QChatMedia::unMuteVideo not allow open video");if((null===(i=this.roomContext)||void 0===i?void 0:i.localMember.uuid)===e.accid)try{yield null===(n=this.rtcController)||void 0===n?void 0:n.unmuteMyVideo()}catch(e){throw this.logger.error("QChatMedia::unMuteVideo error",e),new CustomError("QChatMedia::unMuteVideo error",e)}else try{null===(a=this.rtcController)||void 0===a||a.unmuteMemberVideo(e.accid)}catch(e){throw this.logger.error("QChatMedia::unMuteVideo error",e),new CustomError("QChatMedia::unMuteVideo error",e)}}))}startScreenShare(){var e;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState();try{null===(e=this.rtcController)||void 0===e||e.startScreenShare()}catch(e){throw this.logger.error("QChatMedia::startScreenShare error",e),new CustomError("QChatMedia::startScreenShare error",e)}}))}stopScreenShare(){var e;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState();try{null===(e=this.rtcController)||void 0===e||e.stopScreenShare()}catch(e){throw this.logger.error("QChatMedia::stopScreenShare error",e),new CustomError("QChatMedia::stopScreenShare error",e)}}))}stopMemberScreenShare(e){var t;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e);try{null===(t=this.rtcController)||void 0===t||t.stopMemberScreenShare(e.accid)}catch(e){throw this.logger.error("QChatMedia::stopMemberScreenShare error",e),new CustomError("QChatMedia::stopMemberScreenShare error",e)}}))}subscribeRemoteVideoStream(e){var t;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1},streamType:{type:"number",allowEmpty:!1,min:0,max:1}},e);try{null===(t=this.rtcController)||void 0===t||t.subscribeRemoteVideoStream(e.accid,e.streamType)}catch(e){throw this.logger.error("QChatMedia::subscribeRemoteVideoStream error",e),new CustomError("QChatMedia::subscribeRemoteVideoStream error",e)}}))}unSubscribeRemoteVideoStream(e){var t;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1},streamType:{type:"number",allowEmpty:!1,min:0,max:1}},e);try{null===(t=this.rtcController)||void 0===t||t.unsubscribeRemoteVideoStream(e.accid,e.streamType)}catch(e){throw this.logger.error("QChatMedia::unSubscribeRemoteVideoStream error",e),new CustomError("QChatMedia::unSubscribeRemoteVideoStream error",e)}}))}setupVideoCanvas(e){var t;if(this._checkConnectState(),(null===(t=this.roomContext)||void 0===t?void 0:t.localMember.uuid)===e.accid)try{return this.rtcController.setupLocalVideoCanvas(e.videoView)}catch(e){throw this.logger.error("QChatMedia::setupVideoCanvas error",e),new CustomError("QChatMedia::setupVideoCanvas error",e)}else try{return this.rtcController.setupRemoteVideoCanvas(e.videoView,e.accid)}catch(e){throw this.logger.error("QChatMedia::setupVideoCanvas error",e),new CustomError("QChatMedia::setupVideoCanvas error",e)}}setupRemoteVideoSubStreamCanvas(e){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e);try{return this.rtcController.setupRemoteVideoSubStreamCanvas(e.videoView,e.accid)}catch(e){throw this.logger.error("QChatMedia::setupRemoteVideoSubStreamCanvas error",e),new CustomError("QChatMedia::setupRemoteVideoSubStreamCanvas error",e)}}getScreenSharingUserUuid(){this._checkConnectState();try{return this.rtcController.getScreenSharingUserUuid()}catch(e){throw this.logger.error("QChatMedia::getScreenSharingUserUuid error",e),new CustomError("QChatMedia::getScreenSharingUserUuid error",e)}}initQChatMedia(e){return __awaiter(this,void 0,void 0,(function*(){if(this.neroom)if(void 0===this.state){try{this.neroom.initialize({appKey:this.core.options.appkey,serverConfig:e.serverConfig})}catch(e){throw this.logger.error("QChatMedia::initQChatMedia error",e),new CustomError("QChatMedia::initQChatMedia error",e)}this.authService=this.neroom.authService,this.roomService=this.neroom.roomService,this.messageChannelService=this.neroom.messageChannelService,this.state="init"}else this.logger.error("QChatMedia::init::you already init QChatMedia");else this.logger.warn("QChatMedia::init::you should import neroom SDK")}))}loginByIM(){var e;return __awaiter(this,void 0,void 0,(function*(){if("init"===this.state){var t=yield this._getToken(),r=Ne(this.core,"options.token")||Ne(this.core,"V2NIMLoginService.token");try{yield null===(e=this.authService)||void 0===e?void 0:e.loginByIM(this.core.account,t,r)}catch(e){throw this.logger.error("QChatMedia::loginByIM error",e),new CustomError("QChatMedia::loginByIM error",e)}this.state="login"}else this.logger.error("QChatMedia::connect::you should init before login")}))}_getToken(){var e;return __awaiter(this,void 0,void 0,(function*(){this.logger.log("QChatMedia::getToken begin getToken");var t=yield this.core.sendCmd("qchatGetNeroomToken",{qchatGetNeroomTokenTag:{neroomDeviceId:null===(e=this.neroom)||void 0===e?void 0:e.deviceId}}),{token:r,expire:i}=t.content.neroomToken;return this.logger.log(`QChatMedia::getToken success token is ${r},expire is ${i} `),this.tokenTimer||(this.logger.debug(`QChatMedia::getToken set token timer,expire is ${1e3*i-this.tokenExpireTime} `),this.tokenTimer=this.core.timerManager.addTimer((()=>__awaiter(this,void 0,void 0,(function*(){this.tokenTimer&&this.core.timerManager.deleteTimer(this.tokenTimer),this.tokenTimer=void 0;var e=yield this._getToken();this.authService&&this.authService.renewToken(e)}))),1e3*i-this.tokenExpireTime)),r}))}connectChannel(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){if(void 0!==this.state){"init"===this.state&&(yield this.loginByIM()),this.serverId=e.serverId,this.channelId=e.channelId;try{yield null===(t=this.roomService)||void 0===t?void 0:t.joinRoom({roomUuid:e.channelId,role:"qchatAudience",userName:this.core.account,initialProperties:{}},{})}catch(e){throw this.logger.error("QChatMedia::connectChannel error",e),new CustomError("QChatMedia::connectChannel error",e)}var i=null===(r=this.roomService)||void 0===r?void 0:r.getRoomContext(e.channelId);i?(this.roomContext=i,this.rtcController=this.roomContext.rtcController,this.state="connect",yield this.rtcController.joinRtcChannel(),this.core.emit("connectChannel"),this.core.qchatMedia.emit("connectChannel")):this.logger.error("QChatMedia::connect room not exited")}else this.logger.error("QChatMedia::connect::you should init before login")}))}updateRTCChannelInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},limit:{type:"number",allowEmpty:!1}},e),yield this.core.sendCmd("qchatUpdateRTCChannelConfig",{RTCChannelConfig:Object.assign(Object.assign({},e),{audio:JSON.stringify(e.audio),video:JSON.stringify(e.video)})})}))}getRTCChannelInfo(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1}},e),function formatRTCChannelConfig(e){try{e.audio&&(e.audio=JSON.parse(e.audio))}catch(e){throw new ValidateError('result "audio" JSON parse error',{key:"audio"},"JSON parse error")}try{e.video&&(e.video=JSON.parse(e.video))}catch(e){throw new ValidateError('result "video" JSON parse error',{key:"video"},"JSON parse error")}return format(zd,e)}((yield this.core.sendCmd("qchatGetRTCChannelConfig",{qchatGetRTCChannelConfigTag:e})).content.RTCChannelConfig)}))}getRTCChannelOnlineMembers(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1}},e),formatMembers((yield this.core.sendCmd("qchatGetRTCChannelMembers",{qchatGetRTCChannelMembersTag:e})).content.memberList)}))}addRTCChannelListener(){var e,t;this._checkConnectState();try{null===(e=this.authService)||void 0===e||e.addAuthListener({onAuthEvent:e=>__awaiter(this,void 0,void 0,(function*(){if(1026===e&&!this.getTokenState){this.logger.log("QChatMedia::loginByIM token expire,begin get new token "),this.getTokenState=!0;var t=yield this._getToken();this.authService&&(yield this.authService.renewToken(t)),this.getTokenState=!1}}))})}catch(e){throw this.getTokenState=!1,this.logger.error("QChatMedia::loginByIM addAuthListener error",e),new CustomError("QChatMedia::loginByIM addAuthListener error",e)}null===(t=this.roomContext)||void 0===t||t.addRoomListener({onRoomPropertiesChanged:e=>{var t,r,i,n,a,s;if(this.logger.log("QChatMedia::addRTCChannelListener::onRoomPropertiesChanged",e),e.audioOff){var o=null===(t=e.audioOff.value)||void 0===t?void 0:t.split("_")[0];o!==$d.offNotAllowSelfOn&&o!==$d.offAllowSelfOn||(null===(r=this.roomContext)||void 0===r?void 0:r.localMember.isAudioOn)&&(null===(i=this.rtcController)||void 0===i||i.muteMyAudio())}else if(e.videoOff){var c=null===(n=e.videoOff.value)||void 0===n?void 0:n.split("_")[0];c!==$d.offNotAllowSelfOn&&c!==$d.offAllowSelfOn||(null===(a=this.roomContext)||void 0===a?void 0:a.localMember.isVideoOn)&&(null===(s=this.rtcController)||void 0===s||s.muteMyVideo())}},onRoomPropertiesDeleted:e=>{this.logger.log("QChatMedia::addRTCChannelListener::onRoomPropertiesDeleted",e)},onMemberJoinRtcChannel:e=>{this.logger.log("QChatMedia::addRTCChannelListener::onMemberJoinRTCChannel",e);var t=e.map((e=>e.uuid));this.core.emit("memberJoinRTCChannel",t),this.core.qchatMedia.emit("memberJoinRTCChannel",t)},onMemberLeaveRoom:e=>{this.logger.log("QChatMedia::addRTCChannelListener::onMemberLeaveRoom",e);var t=e.map((e=>e.uuid));this.core.emit("memberLeaveRTCChannel",t),this.core.qchatMedia.emit("memberLeaveRTCChannel",t)},onRoomEnded:e=>{this.authService&&this.authService.logout(),this._setStateInit(),this.logger.log("QChatMedia::addRTCChannelListener::onRoomEnded",e),this.core.emit("RTCChannelEnded",e),this.core.qchatMedia.emit("RTCChannelEnded",e)},onRtcChannelError:e=>{this.logger.log("QChatMedia::addRTCChannelListener::onRtcChannelError",e),"SOCKET_ERROR"===e&&this.disconnectChannel(),this.core.emit("RTCChannelError",e),this.core.qchatMedia.emit("RTCChannelError",e)},onRtcAudioVolumeIndication:e=>{this.logger.log("QChatMedia::addRTCChannelListener::onRtcAudioVolumeIndication",e),this.core.emit("onRtcAudioVolumeIndication",e),this.core.qchatMedia.emit("onRtcAudioVolumeIndication",e)},onMemberAudioMuteChanged:(e,t,r)=>{this.logger.log("QChatMedia::addRTCChannelListener::onMemberAudioMuteChanged",e,t),this.core.emit("memberAudioMuteChanged",{memberAccId:e.uuid,mute:t,operateByAccId:r.uuid}),this.core.qchatMedia.emit("memberAudioMuteChanged",{memberAccId:e.uuid,mute:t,operateByAccId:r.uuid})},onMemberScreenShareStateChanged:(e,t,r)=>{this.logger.log("QChatMedia::addRTCChannelListener::onMemberScreenShareStateChanged",e,t),this.core.emit("memberScreenShareStateChanged",{memberAccId:e.uuid,isSharing:t,operateByAccId:r.uuid}),this.core.qchatMedia.emit("memberScreenShareStateChanged",{memberAccId:e.uuid,isSharing:t,operateByAccId:r.uuid})},onMemberVideoMuteChanged:(e,t,r)=>{this.logger.log("QChatMedia::addRTCChannelListener::onMemberVideoMuteChanged",e,t),this.core.emit("memberVideoMuteChanged",{memberAccId:e.uuid,mute:t,operateByAccId:r.uuid}),this.core.qchatMedia.emit("memberVideoMuteChanged",{memberAccId:e.uuid,mute:t,operateByAccId:r.uuid})}})}enumCameraDevices(){return this._checkConnectState(),this.rtcController.enumCameraDevices().then((e=>e.data),(e=>{throw this.logger.error("QChatMedia::enumCameraDevices error",e),new CustomError("QChatMedia::enumCameraDevices error",e)}))}enumPlayoutDevices(){return this._checkConnectState(),this.rtcController.enumPlayoutDevices().then((e=>e.data),(e=>{throw this.logger.error("QChatMedia::enumPlayoutDevices error",e),new CustomError("QChatMedia::enumPlayoutDevices error",e)}))}enumRecordDevices(){return this._checkConnectState(),this.rtcController.enumRecordDevices().then((e=>e.data),(e=>{throw this.logger.error("QChatMedia::enumRecordDevices error",e),new CustomError("QChatMedia::enumRecordDevices error",e)}))}removeRTCChannelListener(){var e,t;this._checkConnectState(),null===(e=this.roomContext)||void 0===e||e.removeRoomListener({}),null===(t=this.authService)||void 0===t||t.removeAuthListener({})}setSelectedCameraDevice(e){return this._checkConnectState(),validate({deviceId:{type:"string",allowEmpty:!1}},e),this.rtcController.setSelectedCameraDevice(e.deviceId).then((e=>e.data),(e=>{throw this.logger.error("QChatMedia::setSelectedCameraDevice error",e),new CustomError("QChatMedia::setSelectedCameraDevice error",e)}))}setSelectedPlayoutDevice(e){return this._checkConnectState(),validate({deviceId:{type:"string",allowEmpty:!1}},e),this.rtcController.setSelectedPlayoutDevice(e.deviceId).then((e=>e.data),(e=>{throw this.logger.error("QChatMedia::setSelectedPlayoutDevice error",e),new CustomError("QChatMedia::setSelectedPlayoutDevice error",e)}))}setSelectedRecordDevice(e){return this._checkConnectState(),validate({deviceId:{type:"string",allowEmpty:!1}},e),this.rtcController.setSelectedRecordDevice(e.deviceId).then((e=>e.data),(e=>{throw this.logger.error("QChatMedia::setSelectedRecordDevice error",e),new CustomError("QChatMedia::setSelectedRecordDevice error",e)}))}getRTCMembers(){return this._checkConnectState(),this.roomContext.remoteMembers.filter((e=>e.isInRtcChannel)).map((e=>({accid:e.uuid,isAudioOn:!!e.isAudioOn,isVideoOn:!!e.isVideoOn,isSharingScreen:!!e.isSharingScreen,properties:e.properties})))}subscribeRemoteVideoSubStream(e){var t;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e);try{null===(t=this.rtcController)||void 0===t||t.subscribeRemoteVideoSubStream(e.accid)}catch(e){throw this.logger.error("QChatMedia::subscribeRemoteVideoSubStream error",e),new CustomError("QChatMedia::subscribeRemoteVideoSubStream error",e)}}))}unsubscribeRemoteVideoSubStream(e){var t;return __awaiter(this,void 0,void 0,(function*(){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e);try{null===(t=this.rtcController)||void 0===t||t.unsubscribeRemoteVideoSubStream(e.accid)}catch(e){throw this.logger.error("QChatMedia::unsubscribeRemoteVideoSubStream error",e),new CustomError("QChatMedia::unsubscribeRemoteVideoSubStream error",e)}}))}muteAllAudio(){var e;return __awaiter(this,void 0,void 0,(function*(){if(this._checkConnectState(),yield this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneMicrophone"}))try{null===(e=this.roomContext)||void 0===e||e.updateRoomProperty("audioOff",JSON.stringify({value:$d.offNotAllowSelfOn+`_${(new Date).getTime()}`}))}catch(e){throw this.logger.error("QChatMedia::muteAllAudio error",e),new CustomError("QChatMedia::muteAllAudio error",e)}else this.logger.error("QChatMedia::connect::auth your have not RTCChannelOpenCloseEveryoneMicrophone auth")}))}muteAllVideo(){var e;return __awaiter(this,void 0,void 0,(function*(){if(this._checkConnectState(),yield this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneCamera"}))try{null===(e=this.roomContext)||void 0===e||e.updateRoomProperty("videoOff",JSON.stringify({value:$d.offNotAllowSelfOn+`_${(new Date).getTime()}`}))}catch(e){throw this.logger.error("QChatMedia::muteAllVideo error",e),new CustomError("QChatMedia::muteAllVideo error",e)}else this.logger.error("QChatMedia::connect::auth your have not RTCChannelOpenCloseEveryoneCamera auth")}))}unMuteAllAudio(){var e;return __awaiter(this,void 0,void 0,(function*(){if(this._checkConnectState(),yield this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneMicrophone"}))try{null===(e=this.roomContext)||void 0===e||e.updateRoomProperty("audioOff",JSON.stringify({value:$d.disable+`_${(new Date).getTime()}`}))}catch(e){throw this.logger.error("QChatMedia::unMuteAllAudio error",e),new CustomError("QChatMedia::unMuteAllAudio error",e)}else this.logger.error("QChatMedia::connect::auth your have not RTCChannelOpenCloseEveryoneMicrophone auth")}))}unMuteAllVideo(){var e;return __awaiter(this,void 0,void 0,(function*(){if(this._checkConnectState(),yield this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneCamera"}))try{null===(e=this.roomContext)||void 0===e||e.updateRoomProperty("videoOff",JSON.stringify({value:$d.disable+`_${(new Date).getTime()}`}))}catch(e){throw this.logger.error("QChatMedia::unMuteAllVideo error",e),new CustomError("QChatMedia::unMuteAllVideo error",e)}else this.logger.error("QChatMedia::connect::auth your have not RTCChannelOpenCloseEveryoneCamera auth")}))}},"qchatMedia"),NIM.registerService(class QChatMsgService extends Service{constructor(e){super("qchatMsg",e),this.core=e,this.lastChannelIdInMark="",registerParser({cmdMap:Xd,cmdConfig:getCmdConfig$2()}),this.notificationModuleService=new NotificationModuleService(e),this.messageModuleService=new MessageModuleService(e),this.extendModuleService=new ExtendModuleService(e)}sendMessage(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(kd)},ext:{type:"string",required:!1},mentionAll:{type:"boolean",required:!1},mentionAccids:{type:"array",itemType:"string",required:!1},mentionRoleIds:{type:"array",itemType:"string",required:!1,min:1},historyEnable:{type:"boolean",required:!1},pushEnable:{type:"boolean",required:!1}},e),yield this.messageModuleService.sendMessage(e)}))}updateMessage(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({message:{type:"object",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number",min:0},body:{type:"string",required:!1},ext:{type:"string",required:!1}}}},e),"number"==typeof e.message.status&&e.message.status<1e4)throw new CustomError("Status should be greater than or equal to 10000");return yield this.messageModuleService.doUpdateMessage(e)}))}resendMessage(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdClient:{type:"string",allowEmpty:!1}},e),yield this.messageModuleService.resendMessage(e)}))}deleteMessage(e){return __awaiter(this,void 0,void 0,(function*(){validate({message:{type:"object",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number",min:0}}}},e);var t=JSON.parse(JSON.stringify(e));return t.message.status=2,yield this.messageModuleService.doUpdateMessage(t)}))}revokeMessage(e){return __awaiter(this,void 0,void 0,(function*(){validate({message:{type:"object",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number",min:0}}}},e);var t=JSON.parse(JSON.stringify(e));return t.message=Ys(t.message,["serverId","channelId","msgIdServer","time"]),t.message.status=1,yield this.messageModuleService.doUpdateMessage(t)}))}markMessageRead(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string"},channelId:{type:"string"},time:{type:"number",min:0}},e),e.channelId!==this.lastChannelIdInMark&&this.messageModuleService.markMessageRead.flush(),this.lastChannelIdInMark=e.channelId,this.messageModuleService.markMessageRead(e)}))}replyMessage(e){validate({replyMessage:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1}}}},e);var t=e.replyMessage;if(e.serverId!==t.serverId||e.channelId!==t.channelId)throw new CustomError("Forbid replying to message from other server, channel");return this.sendMessage(e)}getMessageHistoryByIds(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},messageReferList:{type:"array",rules:{msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number"}}}},e),yield this.extendModuleService.getMessageHistoryByIds(e)}))}getReferMessages(e){return __awaiter(this,void 0,void 0,(function*(){return validate({message:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number"}}},referType:{type:"enum",values:getEnumKeys(qd),required:!1}},e),yield this.extendModuleService.getReferMessages(e)}))}getThreadMessages(e){return __awaiter(this,void 0,void 0,(function*(){return validate({message:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number"}}},messageQueryOption:{type:"object",rules:{beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},excludeMsgId:{type:"string",required:!1},limit:{type:"number",required:!1},reverse:{type:"boolean",required:!1}}}},e),yield this.extendModuleService.getThreadMessages(e)}))}getThreadRootMessagesMeta(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},threadRootMessages:{type:"array",rules:{msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number"}}}},e),yield this.extendModuleService.getThreadRootMessagesMeta(e)}))}sendSystemNotification(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1,required:!1},attach:{type:"object",required:!1}},e),yield this.notificationModuleService.sendSystemNotification(e)}))}updateSystemNotification(e){return __awaiter(this,void 0,void 0,(function*(){return validate({systemNotification:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(Ud)},body:{type:"string",required:!1},ext:{type:"string",required:!1},status:{type:"number",required:!1}}}},e),yield this.notificationModuleService.updateSystemNotification(e)}))}markSystemNotificationsRead(e){return __awaiter(this,void 0,void 0,(function*(){validate({systemNotifications:{type:"array",rules:{msgIdServer:{type:"string",allowEmpty:!1},type:{type:"string",allowEmpty:!1}},min:1}},e),yield this.notificationModuleService.markSystemNotificationsRead(e)}))}getHistoryMessage(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},beginTime:{type:"number",min:0,required:!1},endTime:{type:"number",min:0,required:!1},excludeMsgId:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,required:!1},reverse:{type:"boolean",required:!1}},e),yield this.messageModuleService.getHistoryMessage(e)}))}getMentionedMeMessages(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},timestamp:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}},e),yield this.messageModuleService.getMentionedMeMessages(e)}))}areMentionedMeMessages(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({messages:{type:"array",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdServer:{type:"string",allowEmpty:!1}},min:1}},e),!e.messages.every((t=>e.messages[0].serverId===t.serverId)))throw new CustomError("Different serverId",e,10414);if(this.core.qchatChannel.subscribeForVisitorService.isInAutoServers(e.messages[0].serverId))throw new CustomError("Not allowed for visitor",e,10403);return yield this.messageModuleService.areMentionedMeMessages(e.messages)}))}addQuickComment(e){return __awaiter(this,void 0,void 0,(function*(){yield this.extendModuleService.updateQuickComment(e,1)}))}removeQuickComment(e){return __awaiter(this,void 0,void 0,(function*(){yield this.extendModuleService.updateQuickComment(e,2)}))}getQuickComments(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgList:{type:"array",rules:{msgIdServer:{type:"string",allowEmpty:!1}},min:1}},e),yield this.extendModuleService.getQuickComments(e)}))}sendTypingEvent(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),yield this.extendModuleService.sendTypingEvent(e)}))}getLastMessageOfChannels(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelIdList:{type:"array",itemType:"string"}},e),yield this.messageModuleService.getLastMessageOfChannels(e)}))}qchatOnMsgHandler(e){return __awaiter(this,void 0,void 0,(function*(){this.messageModuleService.onMsg(e)}))}qchatOnRecvUnreadInfoHandler(e){return __awaiter(this,void 0,void 0,(function*(){this.messageModuleService.onRecvUnreadInfo(e)}))}qchatOnSysMsgHandler(e){this.notificationModuleService.onSysMsg(e)}qchatMultiSyncMessageReadHandler(e){this.messageModuleService.onMultiSyncRead(e)}qchatMultiSyncSystemNotificationUpdateHandler(e){this.notificationModuleService.onMultiSysMsg(e)}qchatSyncSystemNotificationHandler(e){this.notificationModuleService.onSyncSysMsg(e)}qchatRecvMessageUpdateHandler(e){return __awaiter(this,void 0,void 0,(function*(){this.messageModuleService.onRecvMsgUpdate(e)}))}searchMsgByPage(e){return __awaiter(this,void 0,void 0,(function*(){return validate({keyword:{type:"string",allowEmpty:!1,required:!1},serverId:{type:"string",allowEmpty:!1,required:!0},channelId:{type:"string",allowEmpty:!1,required:!1},fromAccid:{type:"string",allowEmpty:!1,required:!1},fromTime:{type:"number",allowEmpty:!1,required:!1},toTime:{type:"number",allowEmpty:!1,required:!1},msgTypes:{type:"array",itemType:"string",allowEmpty:!1,required:!0},subTypes:{type:"array",itemType:"string",allowEmpty:!1,required:!1},includeSelf:{type:"boolean",allowEmpty:!1,required:!1},order:{type:"enum",values:getEnumKeys(ld),required:!1},limit:{type:"number",min:0,required:!1},sort:{type:"enum",values:getEnumKeys(Vd),required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),yield this.messageModuleService.messageSearchByPage(e)}))}qchatMultiSyncServersMessageReadHandler(e){this.messageModuleService.onMultiSyncServersRead(e)}},"qchatMsg"),NIM.registerService(class QChatRoleService extends Service{constructor(e){super("qchatRole",e),this.core=e,registerParser({cmdMap:rl,cmdConfig:getCmdConfig()}),this.category=new CategoryModuleService(e)}createServerRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},name:{type:"string",allowEmpty:!1},priority:{type:"number",min:1},icon:{type:"string",required:!1},ext:{type:"string",required:!1}},e),formatRole((yield this.core.sendCmd("qchatCreateServerRole",{serverRole:Object.assign(Object.assign({},generatorRoleForCmd(e)),{type:Nd.custom}),antispamTag:generateAntispamTag(e)})).content.serverRole)}))}updateServerRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},name:{type:"string",required:!1},icon:{type:"string",required:!1},ext:{type:"string",required:!1},priority:{type:"number",required:!1},auths:{type:"object",required:!1}},e),formatRole((yield this.core.sendCmd("qchatUpdateServerRole",{updateServerRoleTag:generatorRoleForCmd(e),antispamTag:generateAntispamTag(e)})).content.serverRole)}))}deleteServerRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("qchatDeleteServerRole",e)}))}getServerRoles(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1,required:!1},categoryId:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,required:!1},priority:{type:"number",required:!1}},e);var t=yield this.core.sendCmd("qchatGetServerRoles",{getServerRolesTag:generatorRoleForCmd(e)}),r=t.content.serverRoles.filter((e=>1===parseInt(e.isMember)));return r=r.map((e=>e.roleId)),{roles:formatRoles(t.content.serverRoles),isMemberRoles:r}}))}addChannelRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},parentRoleId:{type:"string",allowEmpty:!1}},e),formatRole((yield this.core.sendCmd("qchatAddChannelRole",{channelRole:generatorRoleForCmd(e)})).content.channelRole)}))}getChannelRoles(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},timetag:{type:"number",required:!1},limit:{type:"number",min:1,required:!1}},e),formatRoles((yield this.core.sendCmd("qchatGetChannelRoles",{getChannelRolesTag:e})).content.channelRoles)}))}removeChannelRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("qchatRemoveChannelRole",e)}))}updateChannelRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},auths:{type:"object",required:!1}},e);var t=yield this.core.sendCmd("qchatUpdateChannelRole",{updateChannelRoleTag:generatorRoleForCmd(e)});if(406===t.raw.code)throw new CustomError("No update required",{},406);return formatRole(t.content.channelRole)}))}addMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1}},e),formatRole((yield this.core.sendCmd("qchatAddMemberRole",{memberRole:e})).content.memberRole)}))}getMemberRoles(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},timetag:{type:"number",required:!1},limit:{type:"number",min:1,required:!1}},e),formatRoles((yield this.core.sendCmd("qchatGetMemberRoles",{getMemberRolesTag:e})).content.memberRoles)}))}removeMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("qchatRemoveMemberRole",{memberRole:e})}))}updateMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},auths:{type:"object",required:!1}},e);var t=yield this.core.sendCmd("qchatUpdateMemberRole",{updateMemberRoleTag:generatorRoleForCmd(e)});if(406===t.raw.code)throw new CustomError("No update required",{},406);return formatRole(t.content.memberRole)}))}addMembersToServerRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string",min:1}},e);var t=yield this.core.sendCmd("qchatAddMembersToServerRole",Object.assign(Object.assign({},e),{accids:JSON.stringify(e.accids)})),r=Ne(t,"content.accids.successAccids"),i=Ne(t,"content.accids.failedAccids");return{successAccids:r?JSON.parse(r):[],failedAccids:i?JSON.parse(i):[]}}))}removeMembersFromServerRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string",min:1}},e);var t=yield this.core.sendCmd("qchatRemoveMembersFromServerRole",Object.assign(Object.assign({},e),{accids:JSON.stringify(e.accids)})),r=Ne(t,"content.accids.successAccids"),i=Ne(t,"content.accids.failedAccids");return{successAccids:r?JSON.parse(r):[],failedAccids:i?JSON.parse(i):[]}}))}getMembersFromServerRole(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},timetag:{type:"number",required:!1},accid:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,required:!1}},e),formatRoles((yield this.core.sendCmd("qchatGetMembersFromServerRole",{getMembersFromServerRoleTag:e})).content.members)}))}getServerRolesByAccid(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},timetag:{type:"number",required:!1},limit:{type:"number",min:1,required:!1}},e),formatRoles((yield this.core.sendCmd("qchatGetServerRolesByAccid",{getServerRolesByAccidTag:e})).content.serverRoles)}))}getExistingServerRolesByAccids(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string"}},e);var t=yield this.core.sendCmd("qchatGetExistingServerRolesByAccids",{serverId:e.serverId,accids:JSON.stringify(e.accids)});try{var r=JSON.parse(t.content.serverRoles);return Object.keys(r).forEach((e=>{r[e].forEach(((t,i)=>{r[e][i]=deserialize(t,getDeserializeTag().serverRole)})),r[e]=formatRoles(r[e])})),r}catch(r){throw this.logger.error(`can not parse serverRolesGroupByAccid from ${e.serverId} and ${e.accids}`,t.content.serverRoles),r}}))}getExistingChannelRolesByServerRoleIds(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},roleIds:{type:"array",itemType:"string"}},e),formatRoles((yield this.core.sendCmd("qchatGetExistingChannelRolesByServerRoleIds",{serverId:e.serverId,channelId:e.channelId,roleIds:JSON.stringify(e.roleIds)})).content.channelRoles)}))}getExistingAccidsOfMemberRoles(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string"}},e);var t=(yield this.core.sendCmd("qchatGetExistingAccidsOfMemberRoles",{serverId:e.serverId,channelId:e.channelId,accids:JSON.stringify(e.accids)})).content.memberRoles;return t&&t.length>0?t.map((e=>e.accid)):[]}))}getExistingAccidsInServerRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string"}},e);var t=(yield this.core.sendCmd("qchatGetExistingAccidsInServerRole",{serverId:e.serverId,roleId:e.roleId,accids:JSON.stringify(e.accids)})).content.members;return t&&t.length>0?t.map((e=>e.accid)):[]}))}updateServerRolePriorities(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},serverRoles:{type:"array"}},e),formatRoles((yield this.core.sendCmd("qchatUpdateServerRolePriorities",{serverId:e.serverId,serverRoles:e.serverRoles.map((e=>({serverId:e.serverId,roleId:e.roleId,priority:e.priority})))})).content.serverRoles)}))}checkPermission(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1,required:!1},auth:{type:"string"}},e),(yield this.core.sendCmd("qchatCheckPermission",{checkPermissionTag:Object.assign(Object.assign({},e),{auth:Rd[e.auth]||e.auth})})).content.checked}))}addChannelCategoryRole(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.category.addChannelCategoryRole(e)}))}removeChannelCategoryRole(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.category.removeChannelCategoryRole(e)}))}updateChannelCategoryRole(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.category.updateChannelCategoryRole(e)}))}getChannelCategoryRole(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.category.getChannelCategoryRole(e)}))}addChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.category.addChannelCategoryMemberRole(e)}))}removeChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.category.removeChannelCategoryMemberRole(e)}))}updateChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.category.updateChannelCategoryMemberRole(e)}))}getChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.category.getChannelCategoryMemberRole(e)}))}checkPermissions(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1,required:!1},auths:{type:"array",itemType:"string"}},e),this.core.logger.log("qchatRole::checkPermission options is",e);var t=yield this.core.sendCmd("qchatCheckPermissions",{checkPermissionsTag:Object.assign(Object.assign({},e),{auths:JSON.stringify(e.auths.map((e=>Rd[e]||e)))})});this.core.logger.log("qchatRole::checkPermission result is",t.content);var r={};return t.content.checkPermissionsResult.forEach((e=>{r[e.auth]=e.isAllow})),this.core.logger.log("qchatRole::checkPermission auths is",r),formatRoleAuths(r)}))}},"qchatRole"),NIM.registerService(class QChatServerService extends Service{constructor(e){super("qchatServer",e),this.core=e,registerParser({cmdMap:el,cmdConfig:getCmdConfig$1()})}createServer(e){return __awaiter(this,void 0,void 0,(function*(){return validate({icon:{type:"string",required:!1},name:{type:"string",required:!1},ext:{type:"string",required:!1},searchType:{type:"number",required:!1,min:0},searchEnable:{type:"boolean",required:!1},inviteMode:{type:"number",min:0,max:1,required:!1},applyMode:{type:"number",min:0,max:1,required:!1}},e),formatServer((yield this.core.sendCmd("qchatCreateServer",{serverInfo:Object.assign(Object.assign({},e),{searchEnable:!1===e.searchEnable?0:1}),antispamTag:generateAntispamTag(e)})).content.serverInfo)}))}deleteServer(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1}},e),yield this.core.sendCmd("qchatDeleteServer",e)}))}updateServer(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",min:1},icon:{type:"string",required:!1},name:{type:"string",required:!1},ext:{type:"string",required:!1},searchType:{type:"number",required:!1,min:0},searchEnable:{type:"boolean",required:!1},inviteMode:{type:"number",min:0,max:1,required:!1},applyMode:{type:"number",min:0,max:1,required:!1}},e),formatServer((yield this.core.sendCmd("qchatUpdateServer",{serverInfo:Object.assign(Object.assign({},e),{searchEnable:!1===e.searchEnable?0:1}),antispamTag:generateAntispamTag(e)})).content.serverInfo)}))}getServers(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverIds:{type:"array",itemType:"string",min:1}},e),formatServers((yield this.core.sendCmd("qchatGetServers",e)).content.serverList)}))}getServersByPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({timestamp:{type:"number"},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetServersByPage",{tag:e}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatServers(r)}}))}inviteServerMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},accids:{type:"array",itemType:"string",min:1},ps:{type:"string"},params:{type:"object",rules:{ttl:{type:"number"}},required:!1}},e);var t=yield this.core.sendCmd("qchatInviteServerMembers",e),r=t.content.record||{};return{failByOverAccids:t.content.failByOverAccids,failByBanAccids:t.content.failByBanAccids,recordInfo:formatInviteApplyRecord(r)}}))}acceptServerInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},recordInfo:{type:"object",rules:{requestId:{type:"string",allowEmpty:!1}}}},e),yield this.core.sendCmd("qchatAcceptServerInvite",e)}))}rejectInviteServer(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},accid:{type:"string",min:1},ps:{type:"string"},recordInfo:{type:"object",rules:{requestId:{type:"string",allowEmpty:!1}}}},e),yield this.core.sendCmd("qchatRejectInviteServer",e)}))}applyServerJoin(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",min:1},ps:{type:"string"},params:{type:"object",rules:{ttl:{type:"number"}},required:!1}},e),formatInviteApplyRecord((yield this.core.sendCmd("qchatApplyServerJoin",e)).content.data)}))}acceptServerApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},accid:{type:"string",min:1},recordInfo:{type:"object",rules:{requestId:{type:"string",allowEmpty:!1}}}},e),yield this.core.sendCmd("qchatAcceptServerApply",e)}))}rejectServerApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},accid:{type:"string",min:1},ps:{type:"string"},recordInfo:{type:"object",rules:{requestId:{type:"string",allowEmpty:!1}}}},e),yield this.core.sendCmd("qchatRejectServerApply",e)}))}kickServerMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},accids:{type:"array",itemType:"string",min:1}},e),yield this.core.sendCmd("qchatKickServerMembers",e)}))}leaveServer(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1}},e),yield this.core.sendCmd("qchatLeaveServer",e)}))}updateMyMemberInfo(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",min:1},accid:{type:"string",required:!1},nick:{type:"string",allowEmpty:!0,required:!1},avatar:{type:"string",required:!1},ext:{type:"string",required:!1}},e),formatMember$1((yield this.core.sendCmd("qchatUpdateMyMemberInfo",{memberInfo:e,antispamTag:generateAntispamTag(e)})).content.memberInfo)}))}updateServerMemberInfo(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",min:1},accid:{type:"string",min:1},nick:{type:"string",required:!1},avatar:{type:"string",required:!1}},e),formatMember$1((yield this.core.sendCmd("qchatUpdateServerMemberInfo",{memberInfo:e,antispamTag:generateAntispamTag(e)})).content.memberInfo)}))}getServerMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({accids:{type:"array"}},e);var t=[];if(e.accids.length)for(var r of e.accids)t.push(`${r.serverId}|${r.accid}`);return formatMembers$1((yield this.core.sendCmd("qchatGetServerMembers",{accids:t})).content.accidList)}))}getServerMembersByPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",min:1},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetServerMembersByPage",{tag:e}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatMembers$1(r)}}))}subscribeServer(e){var t,r,i,n;return __awaiter(this,void 0,void 0,(function*(){if(validate({type:{type:"number",min:4,max:4,required:!1},opeType:{type:"number",min:1,max:2}},e),(null===(r=null===(t=this.core.qchatChannel)||void 0===t?void 0:t.config)||void 0===r?void 0:r.autoSubscribe)&&!e.isInternalTrigger)throw new CustomError("subscribe server failed, manual subscribe is not allowed in auto subscribe mode",{},403);if(e.type||(e.type=4),e.servers.length){var a=Object.assign(Object.assign({},e),{channels:e.servers.map((e=>({serverId:e.serverId,channelId:""})))}),{failedChannels:s}=yield this.core.qchatChannel.subscribeModuleService.subscribe(a);return(null===(n=null===(i=this.core.qchatChannel)||void 0===i?void 0:i.config)||void 0===n?void 0:n.autoSubscribe)?this.core.qchatChannel.subscribeModuleService.cacheAutoSubscribe(a):this.core.qchatChannel.subscribeModuleService.cacheSubscribe(a),{failedServers:s}}}))}banServerMember(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),yield this.core.sendCmd("qchatUpdateServerMemberBan",{tag:Object.assign(Object.assign({},e),{opeType:1})})}))}unbanServerMember(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),yield this.core.sendCmd("qchatUpdateServerMemberBan",{tag:Object.assign(Object.assign({},e),{opeType:2})})}))}getBannedMembersByPage(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e);var t=yield this.core.sendCmd("qchatGetBannedMembersByPage",{tag:e}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag)},datas:formatServerMemberBanInfos(r)}}))}serverSearchByPage(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({keyword:{type:"string",allowEmpty:!1},startTime:{type:"number",min:0,required:!1},endTime:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1},serverType:{type:"array",itemType:"number",min:0,required:!1},order:{type:"enum",values:getEnumKeys(ld),required:!1},searchType:{type:"enum",values:getEnumKeys(pd)},sort:{type:"enum",values:getEnumKeys(md),required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),e.startTime&&e.endTime&&e.startTime>=e.endTime)throw new ValidateError("startTime more than endTime",e,"timeRule");var t=yield this.core.sendCmd("qchatServerSearchByPage",{tag:Object.assign(Object.assign({},e),{order:e.order&&ld[e.order],searchType:pd[e.searchType],sort:e.sort&&md[e.sort],serverType:JSON.stringify(e.serverType)})}),{datas:r,listQueryTag:i}=t.content;return{listQueryTag:{hasMore:1==+i.hasMore,nextTimetag:parseInt(i.nextTimetag),cursor:i.cursor},datas:formatServers(r)}}))}serverMemberSearchByPage(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},keyword:{type:"string",allowEmpty:!1},limit:{type:"number",min:1,required:!1}},e),formatMembers$1((yield this.core.sendCmd("qchatServerMemberSearchByPage",{tag:e})).content.members)}))}generateInviteCode(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},ttl:{type:"number",min:0,required:!1}},e),function formatExpireTime(e){return format({expireTime:{type:"number"}},e)}((yield this.core.sendCmd("qchatGenerateInviteCode",{tag:e})).content.data)}))}joinByInviteCode(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverId:{type:"string",allowEmpty:!1},inviteCode:{type:"string",allowEmpty:!1},ps:{type:"string",required:!1}},e),yield this.core.sendCmd("qchatJoinByInviteCode",{tag:e})}))}getInviteApplyRecordOfServer(e){return __awaiter(this,void 0,void 0,(function*(){return validate({serverId:{type:"string",allowEmpty:!1},fromTime:{type:"number",min:0},toTime:{type:"number",min:0},reverse:{type:"boolean",required:!1},limit:{type:"number",min:1,required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),formatInviteApplyRecords((yield this.core.sendCmd("qchatGetInviteApplyRecordOfServer",{tag:Object.assign(Object.assign({},e),{reverse:e.reverse?1:0})})).content.data)}))}getInviteApplyRecordOfSelf(e){return __awaiter(this,void 0,void 0,(function*(){return validate({fromTime:{type:"number",min:0},toTime:{type:"number",min:0},reverse:{type:"boolean",required:!1},limit:{type:"number",min:1,required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),formatInviteApplyRecords((yield this.core.sendCmd("qchatGetInviteApplyRecordOfSelf",{tag:Object.assign(Object.assign({},e),{reverse:e.reverse?1:0})})).content.data)}))}markRead(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverIds:{type:"array",itemType:"string",required:!0}},e);var t=formatClearServersUnread((yield this.core.sendCmd("qchatClearServersUnread",e)).content.clearServersUnreadTag),{successServerIds:r,ackTimestamp:i}=t;return this.logger.log("qchatServer::clearServersUnread:: begin auto clear servers unreadInfo"),this.core.eventBus.emit("qchatChannel/clearUnreadCountByServers",r,i),t}))}subscribeAllChannel(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){if(validate({type:{type:"number",required:!0},serverIds:{type:"array",itemType:"string",required:!0,max:10}},e),null===(r=null===(t=this.core.qchatChannel)||void 0===t?void 0:t.config)||void 0===r?void 0:r.autoSubscribe)throw new CustomError("subscribe channel failed, manual subscribe is not allowed in auto subscribe mode.",{},403);var i=yield this.core.sendCmd("qchatSubscribeChannelsByServers",e,{timeout:3e4});i.content.unreadInfos=formatUnreadInfos(i.content.unreadInfos),i.content.failServerIds=formatFailServerIds(i.content.failServerIds);var n={type:e.type,opeType:1,channels:i.content.unreadInfos.map((e=>({serverId:e.serverId,channelId:e.channelId})))};return this.core.eventBus.emit("qchatChannel/cacheSubscribe",n),this.core.eventBus.emit("qchatChannel/getRoleIdsByServerId",e.serverIds),this.core.eventBus.emit("qchatChannel/updateUnreads",i.content.unreadInfos),i.content}))}enterAsVisitor(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverIds:{type:"array",itemType:"string",min:1}},e);var t=formatFailServerIds((yield this.core.sendCmd("qchatEnterAsVisitor",{tag:{serverIds:JSON.stringify(e.serverIds)}})).content.failServerIds),r=hl(e.serverIds,t);return this.core.qchatChannel.subscribeForVisitorService.cacheServer(r),{failedServers:t}}))}leaveAsVisitor(e){return __awaiter(this,void 0,void 0,(function*(){validate({serverIds:{type:"array",itemType:"string",min:1}},e);var t=formatFailServerIds((yield this.core.sendCmd("qchatLeaveAsVisitor",{tag:{serverIds:JSON.stringify(e.serverIds)}})).content.failServerIds);return hl(e.serverIds,t).forEach((e=>{this.core.qchatChannel.subscribeForVisitorService.deleteServer(e)})),{failedServers:t}}))}subscribeAsVisitor(e){return __awaiter(this,void 0,void 0,(function*(){return validate({opeType:{type:"number",min:1,max:2},type:{type:"number",required:!1},serverIds:{type:"array",itemType:"string",min:1}},e),e.serverIds.length?yield this.core.qchatChannel.subscribeForVisitorService.subscribeServerAsVisitor(e):{failedServers:[]}}))}},"qchatServer"),NIM.registerPrivateService(class EventForwardCenter{constructor(e){this.bindEvents=()=>{this.core.eventBus.on("forwardSend/msg/sendMsg",this.onV1SendMsg),this.core.eventBus.on("forwardSend/msg/recallMsg",this.onV1RecallMsg),this.core.eventBus.on("forwardSend/msg/deleteSelfMsgs",this.onV1DeleteSelfMsgs),this.core.eventBus.on("forwardSend/msgLog/clearHistoryMsgsFromServer",this.onV1ClearHistoryMessage),this.core.eventBus.on("forwardSend/V2NIMMessageService/sendMsg",this.onV2SendMsg),this.core.eventBus.on("forwardSend/V2NIMMessageService/modifyMsg",this.onV2ModifyMsg),this.core.eventBus.on("forwardSend/V2NIMMessageService/revokeMessage",this.onV2RevokeMessage),this.core.eventBus.on("forwardSend/V2NIMMessageService/deleteSelfMsgs",this.onV2DeleteSelfMsgs),this.core.eventBus.on("forwardSend/V2NIMMessageLogService/clearHistoryMessage",this.onV2ClearHistoryMessage),this.core.eventBus.on("forwardSend/team/created",this.onV1TeamCreated),this.core.eventBus.on("forwardSend/team/updateMyMemberInfo",this.onV1TeamMemberUpdate),this.core.eventBus.on("forwardSend/superTeam/updateMyMemberInfo",this.onV1SuperTeamMemberUpdate),this.core.eventBus.on("forwardSend/V2NIMTeamService/updateSelfTeamMemberInfo",this.onV2TeamMemberUpdate),this.core.eventBus.on("forwardSend/team/passTeamApply",((e,t)=>this.onV1TeamApply(e,at.V2NIM_TEAM_TYPE_ADVANCED,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED,t))),this.core.eventBus.on("forwardSend/superTeam/passSuperTeamApply",((e,t)=>{this.onV1TeamApply(e,at.V2NIM_TEAM_TYPE_SUPER,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED,t)})),this.core.eventBus.on("forwardSend/team/rejectTeamApply",((e,t)=>{this.onV1TeamApply(e,at.V2NIM_TEAM_TYPE_ADVANCED,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED,t)})),this.core.eventBus.on("forwardSend/superTeam/rejectSuperTeamApply",((e,t)=>{this.onV1TeamApply(e,at.V2NIM_TEAM_TYPE_SUPER,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED,t)})),this.core.eventBus.on("forwardSend/team/acceptTeamInvite",((e,t)=>{this.onV1TeamInvite(e,at.V2NIM_TEAM_TYPE_ADVANCED,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED,t)})),this.core.eventBus.on("forwardSend/superTeam/acceptSuperTeamInvite",((e,t)=>{this.onV1TeamInvite(e,at.V2NIM_TEAM_TYPE_SUPER,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED,t)})),this.core.eventBus.on("forwardSend/team/rejectTeamInvite",((e,t)=>{this.onV1TeamInvite(e,at.V2NIM_TEAM_TYPE_ADVANCED,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED,t)})),this.core.eventBus.on("forwardSend/superTeam/rejectSuperTeamInvite",((e,t)=>{this.onV1TeamInvite(e,at.V2NIM_TEAM_TYPE_SUPER,gt.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED,t)})),this.core.eventBus.on("forwardSend/user/updateBlackList",this.onV1UpdateBlackList),this.core.eventBus.on("forwardSend/user/updateUserInfo",this.onV1UpdateUserInfo),this.core.eventBus.on("forwardSend/user/setMute",this.onV1SetMute),this.core.eventBus.on("forwardSend/friend/addFriend",this.onV1AddFriend),this.core.eventBus.on("forwardSend/friend/deleteFriend",this.onV1DeleteFriend),this.core.eventBus.on("forwardSend/friend/updateFriend",this.onV1UpdateFriend),this.core.eventBus.on("forwardSend/friend/passFriendApply",this.onV1PassFriendApply),this.core.eventBus.on("forwardSend/friend/rejectFriendApply",this.onV1RejectFriendApply)},this.onV1TeamApply=(e,t,r,i)=>{if(i){if(!this.core.V2NIMTeamService.notification.checkIfExpired(i))return;r=gt.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED}this.core.eventBus.emit("forwardReceive/V2NIMTeamService/updateTeamActionStatus",{teamId:e.teamId,teamType:t,operatorAccountId:e.from,actionType:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION},r)},this.onV1TeamInvite=(e,t,r,i)=>{if(i){if(!this.core.V2NIMTeamService.notification.checkIfExpired(i.code))return;r=gt.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED}this.core.eventBus.emit("forwardReceive/V2NIMTeamService/updateTeamActionStatus",{teamId:e.teamId,teamType:t,operatorAccountId:e.from,actionType:ht.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION},r)},this.onV1PassFriendApply=(e,t)=>{this.core.eventBus.emit("forwardReceive/V2NIMFriendService/acceptAddApplication",e,t)},this.onV1RejectFriendApply=(e,t,r)=>{this.core.eventBus.emit("forwardReceive/V2NIMFriendService/rejectAddApplication",{applicantAccountId:e,recipientAccountId:this.core.account,operatorAccountId:this.core.account,postscript:t||"",timestamp:this.core.timeOrigin.getNTPTime(),read:!0,status:we.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED},r)},this.onV1SetMute=(e,t)=>{this.core.eventBus.emit("forwardReceive/v2NIMSettingService/setP2PMessageMuteMode",e,t?it.V2NIM_P2P_MESSAGE_MUTE_MODE_ON:it.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF)},this.onV1UpdateFriend=e=>{this.core.eventBus.emit("forwardReceive/V2NIMFriendService/setFriendInfo",e.account,Object.assign(Object.assign({},"alias"in e?{alias:e.alias}:{}),"ext"in e?{serverExtension:e.ext}:{}))},this.onV1AddFriend=e=>{this.core.eventBus.emit("forwardReceive/V2NIMFriendService/addFriend",e)},this.onV1DeleteFriend=e=>{this.core.eventBus.emit("forwardReceive/V2NIMFriendService/deleteFriend",e)},this.onV1UpdateUserInfo=e=>{var t=deserialize(serialize(e,us.user),invertSerializeItem(_p));this.core.eventBus.emit("forwardReceive/V2NIMUserService/updateUserProfile",t)},this.onV1UpdateBlackList=(e,t)=>{this.core.eventBus.emit("forwardReceive/V2NIMUserService/updateBlockList",e,t)},this.onV1TeamCreated=e=>{var t=deserialize(serialize(generateTeam(e),ds.team),invertSerializeItem(_l));this.core.eventBus.emit("forwardReceive/V2NIMTeamService/created",t)},this.onV1TeamMemberUpdate=e=>{(e=Object.assign({},e)).type&&(e.type={normal:0,owner:1,manager:2}[e.type]);var t=deserialize(serialize(e,ds.teamMember),invertSerializeItem(Ml));t.teamType=at.V2NIM_TEAM_TYPE_ADVANCED,this.core.eventBus.emit("forwardReceive/V2NIMTeamService/updateSelfTeamMemberInfo",t)},this.onV1SuperTeamMemberUpdate=e=>{(e=Object.assign({},e)).type&&(e.type={normal:0,owner:1,manager:2}[e.type]);var t=deserialize(serialize(e,Fc.superTeamMember),invertSerializeItem(fl));t.teamType=at.V2NIM_TEAM_TYPE_SUPER,this.core.eventBus.emit("forwardReceive/V2NIMTeamService/updateSelfTeamMemberInfo",t)},this.onV2TeamMemberUpdate=e=>{var t=e.teamType,r=serialize(e,Ml);if(t===at.V2NIM_TEAM_TYPE_SUPER){var i=deserialize(r,invertSerializeItem(Fc.superTeamMember));this.core.eventBus.emit("forwardReceive/superTeam/updateMyMemberInfo",i)}else{var n=deserialize(r,invertSerializeItem(ds.teamMember));this.core.eventBus.emit("forwardReceive/team/updateMyMemberInfo",n)}},this.onV1SendMsg=e=>{var t=deserialize(serialize(e,bs),Al);(t=completeMessage(this.core,t)).sendingState="sending"===e.status?We.V2NIM_MESSAGE_SENDING_STATE_SENDING:"sent"===e.status?We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED:We.V2NIM_MESSAGE_SENDING_STATE_FAILED,this.core.eventBus.emit("forwardReceive/V2NIMMessageService/sendMsg",t)},this.onV2SendMsg=e=>{var t=deserialize(serialize(e,Nl),sn(bs));t.status=e.sendingState===We.V2NIM_MESSAGE_SENDING_STATE_SENDING?"sending":e.sendingState===We.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED?"sent":"sendFailed",this.core.eventBus.emit("forwardReceive/msg/sendMsg",t)},this.onV2ModifyMsg=e=>{var t=deserialize(serialize(e,Nl),sn(bs));this.core.eventBus.emit("forwardReceive/msg/modifyMsg",t)},this.onV1RecallMsg=e=>{e.deleteMsgCreatetime=e.time;var t=deserialize(serialize(e,Rs.recallMsgTag),invertSerializeItem(Ol));this.core.eventBus.emit("forwardReceive/V2NIMMessageService/revokeMessages",[t])},this.onV2RevokeMessage=e=>{var t=deserialize(serialize(e,Ol),Os.recallMsgTag);this.core.eventBus.emit("forwardReceive/msg/recallMsg",t)},this.onV1DeleteSelfMsgs=e=>{var t=e.map((e=>deserialize(serialize(e,Rs.deleteSelfMsgTag),invertSerializeItem(bl))));t.forEach((e=>{e.messageRefer=formatMessageRefer(this.core,e.messageRefer)})),this.core.eventBus.emit("forwardReceive/V2NIMMessageService/deleteMessages",t)},this.onV2DeleteSelfMsgs=e=>{var t=e.map((e=>deserialize(serialize(e,bl),Os.deleteSelfMsgTag)));this.core.eventBus.emit("forwardReceive/msg/deleteSelfMsgs",t)},this.onV1ClearHistoryMessage=e=>{var t=deserialize(serialize(e,dc.clearHistoryMsgsFromServerReqTag),invertSerializeItem(Pm));this.core.eventBus.emit("forwardReceive/V2NIMMessageLogService/clearHistoryMessage",t)},this.onV2ClearHistoryMessage=e=>{var t=deserialize(serialize(e,Pm),lc.clearHistoryMsgsFromServerReqTag);this.core.eventBus.emit("forwardReceive/msgLog/clearHistoryMsgsFromServer",t)},this.core=e,this.bindEvents()}},"eventForwardCenter"),e.V2NIMConst=At,e.default=NIM,Object.defineProperty(e,"__esModule",{value:!0})}));
